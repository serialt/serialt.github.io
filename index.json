[{"categories":["Go"],"content":"Go Kratosæµ‹è¯• 1ã€æµ‹è¯•repoå±‚æ–¹æ³• glogger \"gorm.io/gorm/logger\" var ( ctx = context.Background() db *gorm.DB p = NewSugarRepo(log.DefaultLogger) bc conf.Bootstrap ) func init() { bcInit() var err error var dns = bc.Data.Database.Source db, err = gorm.Open(postgres.Open(dns), \u0026gorm.Config{ Logger: glogger.Default.LogMode(glogger.Info), }) if err != nil { panic(err) } } func bcInit() { c := config.New( config.WithSource( file.NewSource(\"../../../../configs\"), ), ) defer c.Close() if err := c.Load(); err != nil { panic(err) } if err := c.Scan(\u0026bc); err != nil { panic(err) } } 2ã€æµ‹è¯•bizå±‚ var ( ctx = context.Background() db *gorm.DB bc conf.Bootstrap us *SugarUsecase ) func init() { bcInit() var err error var dns = bc.Data.Database.Source db, err = gorm.Open(postgres.Open(dns), \u0026gorm.Config{ Logger: glogger.Default.LogMode(glogger.Info), }) if err != nil { panic(err) } // ä¸å¤Ÿçš„å‚æ•°å¯ä»¥ç”¨nil us = NewSugarUsecase(logger, dataData, SugarRepo, nil) } func bcInit() { c := config.New( config.WithSource( file.NewSource(\"../../../../configs\"), ), ) defer c.Close() if err := c.Load(); err != nil { panic(err) } if err := c.Scan(\u0026bc); err != nil { panic(err) } } 3ã€æµ‹è¯•serviceså±‚ const ( address = \"localhost:9000\" defaultName = \"world\" ) var ( md = map[string]string{\"TOKEN\": \"HELLO\"} p pb.SugarClient ctx context.Context ) func NewGrpcConn(endpoint string, mdData map[string]string) (ctx context.Context, conn *grpc.ClientConn, err error) { ctx = metadata.NewIncomingContext(context.Background(), metadata.New(mdData)) conn, err = kgrpc.DialInsecure( ctx, kgrpc.WithEndpoint(endpoint), kgrpc.WithMiddleware( recovery.Recovery(), tracing.Client(), ), kgrpc.WithTimeout(time.Second*10), ) return ctx, conn, err } func init() { ctx2, conn, err := NewGrpcConn(address, md) if err != nil { slog.Info(\"init failed\", \"err\", err) os.Exit(5) } p = pb.NewSugarClient(conn) ctx = ctx2 } ","date":"2025-11-22","objectID":"/posts/2025-11-22-kratos/:0:0","tags":["kratos","test"],"title":"kratos","uri":"/posts/2025-11-22-kratos/"},{"categories":["Go"],"content":"Gock: â€‹ å¼€å‘é¡¹ç›®çš„è¿‡ç¨‹ä¸­æ€»ä¼šé‡åˆ°è¦è°ƒç”¨ä¾èµ–æ–¹æ¥å£çš„æƒ…å†µï¼Œå¦‚æœä¾èµ–æ–¹çš„APIæ¥å£è¿˜æ²¡æœ‰å¼€å‘å¥½ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šå…ˆçº¦å®šå¥½APIæ¥å£çš„è¯·æ±‚å‚æ•°ã€å“åº”ç»“æ„å’Œå„ç±»é”™è¯¯å¯¹åº”çš„å“åº”ç ï¼Œå†æŒ‰ç…§çº¦å®šå¥½è¯·æ±‚å’Œå“åº”è¿›è¡Œå¼€å‘ã€‚æœ‰äº›æƒ…å†µåœ¨å¼€å‘é˜¶æ®µä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œå› æ­¤å°±éœ€è¦è¿›è¡Œå¯¹ä¾èµ–çš„apiè¿›è¡Œmock gock æ˜¯ Go ç”Ÿæ€ä¸‹ä¸€ä¸ªæä¾›æ— ä¾µå…¥ HTTP Mock çš„å·¥å…·ï¼Œç”¨æ¥åœ¨å•å…ƒæµ‹è¯•ä¸­Mock API çš„è°ƒç”¨ï¼Œå³ä¸å¯¹è¦è¯·æ±‚çš„APIå‘èµ·çœŸæ­£çš„è°ƒç”¨ï¼Œè€Œæ˜¯ç”±gockæ‹¦æˆªåˆ°è¯·æ±‚åè¿”å›æˆ‘ä»¬æŒ‡å®šçš„Mockå“åº”ã€‚ å®ƒæ˜¯å¦‚ä½•æ¨¡æ‹Ÿçš„ ç”¨ http.DefaultTransportæˆ–è‡ªå®šä¹‰http.Transportæ‹¦æˆªçš„ä»»ä½• HTTP è¯·æ±‚æµé‡ å°†ä¼ å‡ºçš„ HTTP è¯·æ±‚ä¸æŒ‰ FIFO å£°æ˜é¡ºåºå®šä¹‰çš„ HTTP æ¨¡æ‹ŸæœŸæœ›æ± åŒ¹é…ã€‚ å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªæ¨¡æ‹ŸåŒ¹é…ï¼Œå®ƒå°†è¢«ç”¨æ¥ç»„æˆæ¨¡æ‹Ÿ HTTP å“åº”ã€‚ å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°çš„mockï¼Œåˆ™è§£æè¯·æ±‚æŠ¥é”™ï¼Œé™¤éå¯ç”¨äº†çœŸå®ç½‘ç»œæ¨¡å¼ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†æ‰§è¡ŒçœŸå®çš„HTTPè¯·æ±‚ã€‚ go get -u github.com/h2non/gock ç¤ºä¾‹ func TestHttpc(t *testing.T) { defer gock.Off() domain := \"https://github.com\" apiPath := \"/get\" apiURL := fmt.Sprintf(\"%v%v\", domain, apiPath) // Mock å¯¹ https://httpbin.rs/get çš„ GET è¯·æ±‚ gock.New(domain). Get(apiPath). Reply(200). JSON(map[string]interface{}{ \"mocked\": true, \"headers\": map[string]string{ \"User-Agent\": \"gock\", }, \"url\": \"https://github.com/get\", }) resp, err := http.Get(apiURL) if err != nil { return } dataB, _ := io.ReadAll(resp.Body) fmt.Println(string(dataB)) } å¦‚æœä½¿ç”¨é‡Œè‡ªå®šä¹‰çš„http.Clientï¼Œåˆ™éœ€è¦æ›¿æ¢Transportä¸ºgock.NewTransport() func main() { // å¯ç”¨ gock æ‹¦æˆªå™¨ defer gock.Off() // æµ‹è¯•ç»“æŸåå…³é—­æ‹¦æˆª // Mock å¯¹ https://httpbin.rs/get çš„ GET è¯·æ±‚ gock.New(\"https://httpbin.rs\"). Get(\"/get\"). Reply(200). JSON(map[string]interface{}{ \"mocked\": true, \"headers\": map[string]string{ \"User-Agent\": \"gock\", }, \"url\": \"https://httpbin.rs/get\", }) req.Client().Transport = gock.NewTransport() // å‘èµ·è¯·æ±‚ï¼ˆä¼šè¢« gock æ‹¦æˆªï¼‰ resp, err := req.Get(\"https://httpbin.rs/get\") if err != nil { fmt.Printf(\"Error: %v\\n\", err) return } fmt.Printf(\"resp: %s\\n\", resp.String()) } resty mock func TestResty(t *testing.T) { defer gock.Off() domain := \"https://github.com\" apiPath := \"/get\" apiURL := fmt.Sprintf(\"%v%v\", domain, apiPath) // Mock å¯¹ https://httpbin.rs/get çš„ GET è¯·æ±‚ gock.New(domain). Get(apiPath). Reply(200). JSON(map[string]interface{}{ \"mocked\": true, \"headers\": map[string]string{ \"User-Agent\": \"gock\", }, \"url\": \"https://github.com/get\", }) req := resty.New().SetTransport(gock.NewTransport()).R() resp, err := req.Get(apiURL) if err != nil { return } fmt.Println(resp.String()) } ","date":"2025-11-02","objectID":"/posts/2025-11-2-go-mock/:0:0","tags":["gock","mock"],"title":"Gock","uri":"/posts/2025-11-2-go-mock/"},{"categories":["VPN"],"content":"å¸è½½forticlient /bin/ls -dleO@ /Applications/FortiClient.app sudo /usr/bin/chflags -R noschg /Applications/FortiClient.app ç„¶åå°±å¯ä»¥åˆ é™¤ ","date":"2025-10-12","objectID":"/posts/2025-10-12-fuck-forticlient/:0:0","tags":["forticlient"],"title":"un-forticlient","uri":"/posts/2025-10-12-fuck-forticlient/"},{"categories":["DevOps"],"content":"ArgoCD ArgoCD æ˜¯ä¸€ä¸ªåŸºäº GitOps çš„æŒç»­äº¤ä»˜ï¼ˆCDï¼‰å·¥å…·ï¼Œä¸“é—¨ç”¨äº Kubernetes ç¯å¢ƒã€‚å®ƒé€šè¿‡ä½¿ç”¨ Git ä»“åº“ä½œä¸ºåº”ç”¨ç¨‹åºçš„ â€œæºä»£ç çœŸç›¸â€ï¼Œè‡ªåŠ¨åŒ–åº”ç”¨çš„éƒ¨ç½²å’Œç®¡ç†ã€‚ ä»¥ä¸‹æ˜¯ ArgoCD çš„ä¸€äº›å…³é”®ç‰¹æ€§ï¼š GitOps æ¨¡å‹ï¼šArgoCD éµå¾ª GitOps åŸåˆ™ï¼Œå°†åŸºç¡€è®¾æ–½å’Œåº”ç”¨ç¨‹åºçš„æœŸæœ›çŠ¶æ€å­˜å‚¨åœ¨ Git ä»“åº“ä¸­ã€‚ä»»ä½•å¯¹ Git ä»“åº“çš„å˜æ›´éƒ½ä¼šè‡ªåŠ¨è§¦å‘éƒ¨ç½²ã€‚ å£°æ˜å¼é…ç½®ï¼šArgoCD æ”¯æŒé€šè¿‡ Helm Chartsã€Kustomize æ–‡ä»¶æˆ–ç›´æ¥çš„ YAML æ¸…å•å®šä¹‰ Kubernetes åº”ç”¨ç¨‹åºã€‚å®ƒä¼šæŒç»­ç›‘æ§ Git ä»“åº“å’Œ Kubernetes é›†ç¾¤ä¸­çš„è¿è¡Œåº”ç”¨ï¼Œç¡®ä¿ä¸¤è€…çŠ¶æ€ä¸€è‡´ã€‚ åŒæ­¥ä¸å›æ»šï¼šArgoCD ä¼šåŒæ­¥ Kubernetes é›†ç¾¤ä¸­çš„åº”ç”¨çŠ¶æ€ä¸ Git ä»“åº“ä¸­çš„æœŸæœ›çŠ¶æ€ã€‚å¦‚æœå‘ç”Ÿä¸ä¸€è‡´ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨æˆ–æ‰‹åŠ¨è¿›è¡Œä¿®å¤ï¼Œå¹¶æ”¯æŒå¿«é€Ÿå›æ»šåˆ°ä»¥å‰çš„ç‰ˆæœ¬ã€‚ å¤šé›†ç¾¤ç®¡ç†ï¼šå¯ä»¥åŒæ—¶ç®¡ç†å¤šä¸ª Kubernetes é›†ç¾¤çš„åº”ç”¨éƒ¨ç½²ï¼Œä½¿å¾—è·¨é›†ç¾¤çš„åº”ç”¨ç®¡ç†æ›´åŠ ç®€ä¾¿ã€‚ è‡ªå®šä¹‰å¥åº·æ£€æŸ¥ä¸è‡ªåŠ¨éƒ¨ç½²ï¼šæ ¹æ®å®šä¹‰çš„å¥åº·æ£€æŸ¥æ ‡å‡†è‡ªåŠ¨æ£€æµ‹åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œå¹¶è¿›è¡Œè‡ªåŠ¨éƒ¨ç½²å’Œæ›´æ–°ã€‚ ArgoCD æ˜¯ GitOps å’Œ Kubernetes ç¯å¢ƒä¸­å¸¸ç”¨çš„è‡ªåŠ¨åŒ–å·¥å…·ï¼Œé€‚åˆç”¨äº DevOps å›¢é˜Ÿæ¥æé«˜äº¤ä»˜æ•ˆç‡ã€‚ åŸºäºDocker Desktop å®‰è£… helm upgrade --install argocd argo/argo-cd --namespace argocd --create-namespace helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx --namespace ingress-nginx --create-namespace ingress cat \u003c\u003cEOF | kubectl apply -f - apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: argocd-server-ingress namespace: argocd annotations: nginx.ingress.kubernetes.io/ssl-redirect: \"true\" nginx.ingress.kubernetes.io/backend-protocol: \"HTTPS\" spec: ingressClassName: nginx rules: - host: argocd.local http: paths: - path: / pathType: Prefix backend: service: name: argocd-server port: number: 443 tls: - hosts: - argocd.local secretName: argocd-secret EOF æ”¹æœ¬åœ°çš„hosts 127.0.0.1 argocd.local kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath=\"{.data.password}\" | base64 -d ","date":"2025-10-12","objectID":"/posts/2025-10-12-argocd/:0:0","tags":["argocd"],"title":"ArgoCD","uri":"/posts/2025-10-12-argocd/"},{"categories":["Dev"],"content":"TypeScript 1ã€åŸºç¡€è¯­æ³• // å®šä¹‰å˜é‡ let age: number = 25 let username: string = \"Alice\" let isAdmin: boolean = true // æ•°ç»„ä¸å¯¹è±¡ let numbers: number[] = [1, 2, 3] let user: { id: number; name: string } = { id: 1, name: \"Tom\" } //æ¥å£ interface User { id: number name: string age?: number // å¯é€‰å±æ€§ } const u: User = { id: 1, name: \"Lucy\" } // ç±» class Person { constructor(public name: string, private age: number) {} greet() { console.log(`Hi, I'm ${this.name}`) } } const p = new Person(\"Jack\", 20) p.greet() // èŒƒå‹ function identity\u003cT\u003e(arg: T): T { return arg } let output = identity\u003cstring\u003e(\"Hello\") ","date":"2025-09-19","objectID":"/posts/2025-09-19-ts/:0:0","tags":["ts"],"title":"TS","uri":"/posts/2025-09-19-ts/"},{"categories":["DevOps"],"content":"Dev terraform provider åŸºäºæ–°æ¡†æ¶tpfå¼€å‘ å¼€å‘ç¤ºä¾‹ï¼š https://github.com/hashicorp/terraform-provider-scaffolding-framework https://github.com/serialt/terraform-provider-demo å‚è€ƒç¤ºä¾‹ï¼š https://github.com/hashicorp/terraform-provider-hashicups ","date":"2025-09-03","objectID":"/posts/2025-09-03-dev-terraform-provider/:0:0","tags":["terraform-dev","tf-dev"],"title":"TF-dev","uri":"/posts/2025-09-03-dev-terraform-provider/"},{"categories":["DevOps"],"content":"ä¸€ã€è°ƒè¯• provider 1ã€debug terraform # makefile default: install build: go build -v ./... install: go install -v ./... vscode è°ƒè¯• terraform provider 1ï¼‰vscode launch cat .vscode/launch.json { \"version\": \"0.2.0\", \"configurations\": [ { \"name\": \"Debug Terraform Provider\", \"type\": \"go\", \"request\": \"launch\", \"mode\": \"debug\", // this assumes your workspace is the root of the repo \"program\": \"${workspaceFolder}\", \"env\": {}, \"args\": [ \"-debug\", ] }, { \"name\": \"Launch test function\", \"type\": \"go\", \"request\": \"launch\", \"mode\": \"test\", \"program\": \"${fileDirname}\", \"showLog\": true, \"args\": [ \"-test.v\", \"-test.run\", \"TestDatasource_RepositoryDockerHosted\" ] } ] } run debug 2ï¼‰ready terraform code 3ï¼‰run terraform TF_REATTACH_PROVIDERS='{\"registry.terraform.io/serialt/message\":{\"Protocol\":\"grpc\",\"ProtocolVersion\":5,\"Pid\":50972,\"Test\":true,\"Addr\":{\"Network\":\"unix\",\"String\":\"/var/folders/vm/zlhwbdyj2031f088_w9q3f8w0000gn/T/plugin3117659601\"}}}' terraform apply devæ¨¡å¼è¦†ç›– provider cat ~/.terraformrc provider_installation { dev_overrides { \"serialt/message\" = \"/Users/serialt/go/bin\" } direct {} } # TF_LOG=TRACE terraform apply terraform apply ","date":"2025-09-03","objectID":"/posts/2025-09-03-dev-terraform-provider/:0:1","tags":["terraform-dev","tf-dev"],"title":"TF-dev","uri":"/posts/2025-09-03-dev-terraform-provider/"},{"categories":["DevOps"],"content":"äºŒã€TPFæ¡†æ¶ ç›®å‰å®˜æ–¹åœ¨ç»´æŠ¤çš„å¼€å‘ provider sdk æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼š terraform-plugin-sdk/v2 terraform-plugin-framework å¦‚æœè¦æ”¯æŒè€ç‰ˆæœ¬çš„terraformï¼Œå»ºè®®æ˜¯ä½¿ç”¨ terraform-plugin-sdk/v2 å¼€å‘ï¼Œå¦åˆ™è¿˜æ˜¯å»ºè®®ä½¿ç”¨terraform-plugin-frameworkå¼€å‘ã€‚ TPFå¼€å‘ç¤ºä¾‹ï¼šhttps://github.com/hashicorp/terraform-provider-hashicups è§£é‡Šè¯´æ˜ æ’ä»¶å¼€å‘ä¸»è¦æ¶‰åŠçš„æ–‡ä»¶åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼š provider datasource resource provider æ–‡ä»¶ä¸­ä¸»è¦æ˜¯ä¸€äº› é…ç½®æ–‡ä»¶çš„è¯»å–å’Œå¯¹ç¬¬ä¸‰åˆ† api å®¢æˆ·ç«¯çš„åˆå§‹åŒ–ï¼Œä¸»è¦ç”±äº”ä¸ªæ–¹æ³•ç»„æˆï¼š Metadataï¼šproviderçš„åå­— Schemaï¼šproviderçš„é…ç½®å‚æ•° Configureï¼šè¯»å–é…ç½®providerä¸­çš„å€¼å’Œç¯å¢ƒå˜é‡çš„å€¼ï¼Œåˆå§‹åŒ–è°ƒç”¨ç¬¬ä¸‰æ–¹apiçš„client Resourcesï¼šå®šä¹‰çš„resourceèµ„æº DataSourcesï¼šå®šä¹‰çš„datasourceèµ„æº datasource é€šè¿‡ç¬¬ä¸‰æ–¹apiçš„clientè°ƒç”¨ï¼ŒæŸ¥è¯¢å·²å­˜åœ¨çš„èµ„æºä¿¡æ¯ï¼š Metadataï¼šå®šä¹‰datasourceçš„åå­— Schemaï¼šdatasourceé…ç½®çš„å‚æ•° Readï¼šclientè°ƒç”¨apiï¼Œè¯»å–å…·ä½“çš„æ•°æ®ï¼Œç”Ÿæˆstate Configureï¼šä»providerä¸­è·å–ä¼ å…¥çš„è°ƒç”¨apiçš„client resource é€šè¿‡ç¬¬ä¸‰æ–¹apiçš„clientè°ƒç”¨ï¼Œå¯¹èµ„æºè¿›è¡Œå¢åˆ æ”¹æŸ¥å’Œå¯¼å…¥èµ„æºå¯¹è±¡ Metadataï¼šå®šä¹‰resourceçš„åå­— Schemaï¼šresourceé…ç½®çš„å‚æ•° Configureï¼šä»providerä¸­è·å–ä¼ å…¥çš„è°ƒç”¨apiçš„client Createï¼šåˆ›å»ºèµ„æº Readï¼šæŸ¥è¯¢èµ„æº Updateï¼šæ›´æ–°èµ„æº Deleteï¼šåˆ é™¤èµ„æºï¼Œç”¨äºåœ¨é”€æ¯æ—¶åˆ é™¤èµ„æº ImportStateï¼šå¯¼å…¥èµ„æºï¼Œç”¨terraformç®¡ç†å­˜é‡çš„èµ„æºå¯¹è±¡ã€‚ main.go package main import ( \"context\" \"flag\" \"log\" \"github.com/hashicorp/terraform-plugin-framework/providerserver\" \"github.com/serialt/terraform-provider-harbor/internal/provider\" ) //go:generate go run github.com/hashicorp/terraform-plugin-docs/cmd/tfplugindocs func main() { var debug bool flag.BoolVar(\u0026debug, \"debug\", false, \"set to true to run the provider with support for debuggers like delve\") flag.Parse() err := providerserver.Serve(context.Background(), provider.New, providerserver.ServeOpts{ Address: \"registry.terraform.io/serialt/harbor\", Debug: debug, }) if err != nil { log.Fatal(err) } } provider.go // Copyright (c) HashiCorp, Inc. // SPDX-License-Identifier: MPL-2.0 package provider import ( \"context\" \"os\" \"strings\" \"github.com/goharbor/go-client/pkg/harbor\" \"github.com/hashicorp/terraform-plugin-framework/datasource\" \"github.com/hashicorp/terraform-plugin-framework/path\" \"github.com/hashicorp/terraform-plugin-framework/provider\" \"github.com/hashicorp/terraform-plugin-framework/provider/schema\" \"github.com/hashicorp/terraform-plugin-framework/resource\" \"github.com/hashicorp/terraform-plugin-framework/types\" \"github.com/hashicorp/terraform-plugin-log/tflog\" ) var _ provider.Provider = \u0026HarborProvider{} func New() provider.Provider { return \u0026HarborProvider{} } type HarborProvider struct { } type HarborProviderModel struct { URL types.String `tfsdk:\"url\"` Username types.String `tfsdk:\"username\"` Password types.String `tfsdk:\"password\"` BearerToken types.String `tfsdk:\"bearer_token\"` Insecure types.Bool `tfsdk:\"insecure\"` } func (p *HarborProvider) Metadata(ctx context.Context, req provider.MetadataRequest, resp *provider.MetadataResponse) { resp.TypeName = \"harbor\" } func (p *HarborProvider) Schema(_ context.Context, _ provider.SchemaRequest, resp *provider.SchemaResponse) { resp.Schema = schema.Schema{ Description: \"Harbor config\", Attributes: map[string]schema.Attribute{ \"url\": schema.StringAttribute{ Description: \"Harbor url.\", Optional: true, }, \"username\": schema.StringAttribute{ Description: \"Harbor username.\", Optional: true, }, \"password\": schema.StringAttribute{ Description: \"Harbor.\", Optional: true, Sensitive: true, }, \"bearer_token\": schema.StringAttribute{ Description: \"Harbor.\", Optional: true, }, \"insecure\": schema.BoolAttribute{ Description: \"Harbor.\", Optional: true, }, }, } } func (p *HarborProvider) Configure(ctx context.Context, req provider.ConfigureRequest, resp *provider.ConfigureResponse) { tflog.Info(ctx, \"Configuring harbor client\") // Retrieve provider data from configuration var config HarborProviderModel diags := req.Config.Get(ctx, \u0026config) resp.Diagnostics.Append(diags...) if resp.Diagnostics.HasError() { return } if config.URL.IsUnknown() { resp.Diagnostics.AddAttributeError( path.Root(\"url\"), \"Unknown url\", \"\", ) } if resp.Diagnostics.HasError() { return } url := os.Getenv(\"HARBOR_URL\") username := os.Getenv(\"HARBOR_USERNAME\") password := os.Getenv(\"HARBOR_PASSWORD\") insecure := false if strings.HasSuffix(url, \"/\") { url = strings.Trim(url, \"/\") } if !config.URL.IsNull() { url = config.URL.ValueString() } if !config.Use","date":"2025-09-03","objectID":"/posts/2025-09-03-dev-terraform-provider/:0:2","tags":["terraform-dev","tf-dev"],"title":"TF-dev","uri":"/posts/2025-09-03-dev-terraform-provider/"},{"categories":["DevOps"],"content":"ä¸‰ã€Terraform applyè¯´æ˜ 1ã€applyï¼Œå¦‚æœstateæ–‡ä»¶ä¸­æ²¡æœ‰å¯¹åº”çš„èµ„æºåˆ™ä¼šè§¦å‘createï¼Œcreateåä¼šå†™å…¥stateæ–‡ä»¶ 2ã€åˆ é™¤èµ„æºä¼šå…ˆè§¦å‘readï¼Œyesåè§¦å‘åˆ é™¤æ“ä½œ 3ã€resourceä¸­å®šä¹‰çš„æœ‰æ”¹åŠ¨å¯¼è‡´èµ„æºæŸäº›é…ç½®ä¼šè¢«replaceï¼Œå…ˆè§¦å‘readï¼Œyes åä¼šè§¦å‘æ›´æ–° 4ã€createã€updateã€read æœ€åéƒ½ä¼šè·å–èµ„æºçŠ¶æ€æ•°æ®å¹¶æ›´æ–°åˆ°stateæ–‡ä»¶ä¸­ ","date":"2025-09-03","objectID":"/posts/2025-09-03-dev-terraform-provider/:0:3","tags":["terraform-dev","tf-dev"],"title":"TF-dev","uri":"/posts/2025-09-03-dev-terraform-provider/"},{"categories":["DevOps"],"content":"å››ã€ä»£ç ç‰‡æ®µ // schema DataSourceID = schema.StringAttribute{ Description: \"Used to identify data source at nexus\", MarkdownDescription: \"Used to identify data source at nexus\", Computed: true, } // å®šä¹‰ // block resp.Schema = schema.Schema{ Description: \"Use this data source .\", MarkdownDescription: \"Use this data source .\", Blocks: map[string]schema.Block{ \"group\": tschema.DSGroup, }, Attributes: map[string]schema.Attribute{ \"id\": tschema.DataSourceID, \"name\": tschema.DataSourceName, }, } DSGroup = schema.SingleNestedBlock{ Description: \"The group configuration of the repository\", MarkdownDescription: \"The group configuration of the repository\", Attributes: map[string]schema.Attribute{ \"member_names\": schema.ListAttribute{ Description: \"Member repositories names\", MarkdownDescription: \"Member repositories names\", ElementType: types.StringType, Required: true, Validators: []validator.List{listvalidator.SizeAtLeast(1)}, }, }, } // å®šä¹‰list // model é‡Œé¢ type CleanupModel struct { PolicyNames types.List `tfsdk:\"policy_names\"` } // schema DSCleanUp = schema.SingleNestedBlock{ MarkdownDescription: \"Cleanup policies\", Description: \"Cleanup policies\", Attributes: map[string]schema.Attribute{ \"policy_names\": schema.ListAttribute{ Description: \"List of policy names\", MarkdownDescription: \"List of policy names\", Computed: true, ElementType: types.StringType, }, }, } // List è½¬ types.List if repo.Cleanup != nil { policyNames := []attr.Value{} for _, item := range repo.Cleanup.PolicyNames { policyNames = append(policyNames, types.StringValue(item)) } policyNamesTfsdk, _ := types.ListValue(types.StringType, policyNames) data.Cleanup = \u0026model.CleanupModel{ PolicyNames: policyNamesTfsdk, } } // model è½¬ types.List actions := []string{} _ = plan.Actions.ElementsAs(ctx, actions, true) // resource è®¾ç½®äº†é»˜è®¤å€¼åéœ€è¦è®¾ç½® Computed ä¸º true \"v1_enabled\": schema.BoolAttribute{ Description: \"Whether to allow clients to use\", MarkdownDescription: \"Whether to allow clients to use\", Computed: true, Default: booldefault.StaticBool(false), }, æµ‹è¯•ä»£ç  package nexus import ( \"testing\" \"github.com/hashicorp/terraform-plugin-testing/helper/resource\" // \"github.com/hashicorp/terraform-plugin-testing/knownvalue\" // \"github.com/hashicorp/terraform-plugin-testing/statecheck\" // \"github.com/hashicorp/terraform-plugin-testing/tfjsonpath\" ) func TestDatasource_RepositoryDockerHosted(t *testing.T) { resource.Test(t, resource.TestCase{ PreCheck: func() { testAccPreCheck(t) }, ProtoV6ProviderFactories: TestNexusProtoV6ProviderFactories, Steps: []resource.TestStep{ { Config: testDatasourceDockerHostConfig, Check: resource.ComposeTestCheckFunc( resource.TestCheckResourceAttr(\"data.nexus_repository_docker_hosted.docker-local\", \"name\", \"docker-local\"), ), }, }, }) } const testDatasourceDockerHostConfig = ` data \"nexus_repository_docker_hosted\" \"docker-local\" { name = \"docker-local\" } ` ","date":"2025-09-03","objectID":"/posts/2025-09-03-dev-terraform-provider/:0:4","tags":["terraform-dev","tf-dev"],"title":"TF-dev","uri":"/posts/2025-09-03-dev-terraform-provider/"},{"categories":["VSCode Extension Pack"],"content":"VSCode Extension Pack vscodeæ‰©å±•åŒ… åœ¨ä½¿ç”¨vscodeçš„æ—¶å€™ï¼Œéœ€è¦å®‰è£…å„ç§å„ç±»çš„æ’ä»¶æ¥æ»¡è¶³ä¸åŒçš„åŠŸèƒ½ï¼Œåœ¨æ–°å®‰è£…vscodeæˆ–è€…åˆ‡æ¢å…¶ä»–æœºå™¨çš„æ—¶å€™ï¼Œä¼šå› ä¸ºæ’ä»¶è¿‡å¤šä¸æ–¹ä¾¿ç®¡ç†ï¼Œvscodeæä¾›ä¸€ä¸ªåŠŸèƒ½ï¼Œé€šè¿‡ä¸€ä¸ªExtension Packæ¥å®ç°ä¸€é”®å®‰è£…å¤šä¸ªæ’ä»¶ã€‚ é¡¹ç›®ç»“æ„ [root@Krab sugar-extension-pack]ğŸ³ tree . . â”œâ”€â”€ CHANGELOG.md â”œâ”€â”€ LICENSE â”œâ”€â”€ Makefile â”œâ”€â”€ README.md â”œâ”€â”€ images â”‚ â””â”€â”€ icon.png â”œâ”€â”€ package-lock.json â””â”€â”€ package.json 2 directories, 7 files æ–‡ä»¶å†…å®¹ # package.json { \"name\": \"sugar-extension-pack\", \"displayName\": \"Sugar's Extension Pack\", \"description\": \"A custom VS Code Extension Pack\", \"version\": \"1.0.2\", \"publisher\": \"serialt\", \"engines\": { \"vscode\": \"^1.70.0\" }, \"categories\": [ \"Extension Packs\" ], \"extensionPack\": [ \"alefragnani.project-manager\", \"arjun.swagger-viewer\", \"aykutsarac.jsoncrack-vscode\", \"christian-kohler.path-intellisense\", \"codezombiech.gitignore\", \"cweijan.vscode-office\", \"cweijan.vscode-typora\", \"donjayamanne.githistory\", \"donjayamanne.python-environment-manager\", \"eamodio.gitlens\", \"felipecaputo.git-project-manager\", \"gerrnperl.outline-map\", \"golang.go\", \"gruntfuggly.todo-tree\", \"hashicorp.hcl\", \"hashicorp.terraform\", \"howardzuo.vscode-git-tags\", \"inferrinizzard.prettier-sql-vscode\", \"ionutvmi.path-autocomplete\", \"jeff-hykin.better-dockerfile-syntax\", \"jkillian.custom-local-formatters\", \"kevinrose.vsc-python-indent\", \"letmaik.git-tree-compare\", \"lkqm.gitblame-annotations\", \"lunuan.kubernetes-templates\", \"mads-hartmann.bash-ide-vscode\", \"meezilla.json\", \"mhutchie.git-graph\", \"moshfeu.diff-merge\", \"ms-kubernetes-tools.vscode-kubernetes-tools\", \"ms-python.autopep8\", \"ms-python.debugpy\", \"ms-python.python\", \"ms-python.vscode-pylance\", \"ms-vscode-remote.remote-ssh\", \"ms-vscode-remote.remote-ssh-edit\", \"ms-vscode.remote-explorer\", \"neonxp.gotools\", \"pascalreitermann93.vscode-yaml-sort\", \"premparihar.gotestexplorer\", \"quicktype.quicktype\", \"quzhen.tasks-button\", \"r3inbowari.gomodexplorer\", \"redhat.vscode-xml\", \"redhat.vscode-yaml\", \"redis.redis-for-vscode\", \"rogalmic.bash-debug\", \"shaharkazaz.git-merger\", \"technosophos.vscode-helm\", \"tim-koehler.helm-intellisense\", \"tomoki1207.pdf\", \"visualstudioexptteam.intellicode-api-usage-examples\", \"visualstudioexptteam.vscodeintellicode\", \"vscode-icons-team.vscode-icons\", \"waderyan.gitblame\", \"wholroyd.jinja\", \"xaver.clang-format\", \"xmtt.go-mod-grapher\", \"yzhang.markdown-all-in-one\", \"ziyasal.vscode-open-in-github\", \"zxh404.vscode-proto3\" ], \"icon\": \"images/icon.png\", \"bugs\": { \"url\": \"https://github.com/serialt/sugar-extension-pack/issues\" }, \"repository\": { \"type\": \"git\", \"url\": \"https://github.com/serialt/sugar-extension-pack\" } } # å®‰è£… vsce npm install -g vsce # æ‰“åŒ…ï¼ˆæ‰“åŒ…ä¸æ˜¯å¿…é¡»çš„ï¼‰ vsce package # å‘å¸ƒ vsce publish å‘å¸ƒçš„æ—¶å€™éœ€è¦å…ˆç™»é™† VSCode Marketplaceï¼Œåˆ›å»ºä¸€ä¸ªpublisherï¼Œä¿®æ”¹é¡¹ç›®package.jsoné‡Œçš„publisheråŒåˆ›å»ºçš„ç›¸åŒï¼Œåˆ‡æ¢åˆ°Azureåˆ›å»ºä¸€ä¸ªtoken # å…ˆç™»é™† vsce login your-new-publisher-id # ç„¶åå‘å¸ƒ vsce publish ","date":"2025-08-17","objectID":"/posts/2025-08-17-vscode-extension-pack/:0:0","tags":["vscode","Extension-Pack"],"title":"VSCode Extension Pack","uri":"/posts/2025-08-17-vscode-extension-pack/"},{"categories":["Go Plugin"],"content":"go plugin [serialt@Krab plugin]ğŸ³ tree . . â”œâ”€â”€ go.mod â”œâ”€â”€ kk â”‚ â”œâ”€â”€ kk.go â”‚ â””â”€â”€ kk.so â”œâ”€â”€ ks â””â”€â”€ main.go // kk.go package main import \"fmt\" func Greet(name string) { fmt.Println(\"Hello\", name) } func main() {} // main.go package main import ( \"log\" \"plugin\" ) func main() { p, err := plugin.Open(\"./kk/kk.so\") if err != nil { log.Fatal(err) } greet, err := p.Lookup(\"Greet\") if err != nil { log.Fatal(err) } greet.(func(string))(\"Go\") } ç¼–è¯‘æ’ä»¶ cd kk \u0026\u0026 go build -buildmode=plugin ç¼–è¯‘ä¸»æœåŠ¡è°ƒç”¨æ’ä»¶ [root@Krab plugin]ğŸ³ go build [root@Krab plugin]ğŸ³ ./ks Hello Go ","date":"2025-08-17","objectID":"/posts/2025-08-17-go-plugin/:0:0","tags":["Go","plugin"],"title":"Go Plugin","uri":"/posts/2025-08-17-go-plugin/"},{"categories":["Go gin"],"content":"Simple Gin package main import ( \"fmt\" \"log/slog\" \"net/http\" \"time\" \"github.com/gin-gonic/gin\" \"github.com/prometheus/client_golang/prometheus\" \"github.com/prometheus/client_golang/prometheus/promhttp\" ) type msg struct { Count int64 `json:\"count\"` } var pingCounter = prometheus.NewCounter( prometheus.CounterOpts{ Name: \"ping_request_count\", Help: \"No of request handled by Ping handler\", }, ) var httpReqs = prometheus.NewCounterVec( prometheus.CounterOpts{ Name: \"http_requests_total\", Help: \"How many HTTP requests processed, partitioned by status code and HTTP method.\", }, []string{\"code\", \"method\"}, ) func PromHandler(handler http.Handler) gin.HandlerFunc { return func(c *gin.Context) { handler.ServeHTTP(c.Writer, c.Request) } } func main() { prometheus.MustRegister(pingCounter) prometheus.MustRegister(httpReqs) gin.SetMode(gin.ReleaseMode) // router := gin.New() router := gin.Default() router.GET(\"/ping\", func(c *gin.Context) { httpReqs.WithLabelValues(\"404\", \"POST\").Add(42) c.JSON(200, gin.H{ \"message\": \"pong\", }) }) router.GET(\"/metrics\", PromHandler(promhttp.Handler())) router.POST(\"/msg\", func(c *gin.Context) { d := \u0026msg{} pingCounter.Inc() httpReqs.WithLabelValues(\"200\", \"GET\").Add(55) err := c.ShouldBind(d) if err != nil { c.JSON(200, gin.H{ \"message\": \"err\", }) } else { ch := make(chan int, 3) go func() { for i := 0; i \u003c int(d.Count); i++ { time.Sleep(time.Millisecond * 300) ch \u003c- i fmt.Println(len(ch)) } close(ch) }() for v := range ch { slog.Info(\"ch\", \"data\", v) time.Sleep(time.Millisecond * 300) } c.JSON(200, gin.H{ \"message\": \"dddd\", }) // panic(\"ssss\") } }) router.Run() // ç›‘å¬å¹¶åœ¨ 0.0.0.0:8080 ä¸Šå¯åŠ¨æœåŠ¡ } ","date":"2025-07-13","objectID":"/posts/2025-07-13-gin/:0:0","tags":["Go","gin"],"title":"Simple-Gin","uri":"/posts/2025-07-13-gin/"},{"categories":["Go exporter"],"content":"Exporter å¼€å‘ Prometheus Exporteræ˜¯ä¸€ä¸ªç”¨æ¥æ”¶é›†å’Œæš´éœ²æŒ‡æ ‡æ•°æ®çš„å·¥å…·ï¼Œé€šè¿‡ä¸Prometheusç›‘æ§ç³»ç»Ÿä¸€èµ·ä½¿ç”¨ã€‚å®ƒçš„ç»“æ„åŒ…æ‹¬ä¸¤ä¸ªç»„ä»¶ï¼šCollectorå’ŒExporterï¼š Collectorï¼šç”¨äºä»ç›®æ ‡åº”ç”¨ç¨‹åºæˆ–ç³»ç»Ÿæ”¶é›†æŒ‡æ ‡å¹¶å°†å…¶è½¬åŒ–ä¸ºPrometheuså¯è¯†åˆ«çš„æ ¼å¼ã€‚æ”¶é›†å™¨å¯ä»¥ä½¿ç”¨Prometheuså®¢æˆ·ç«¯åº“æ¥ç”ŸæˆæŒ‡æ ‡ï¼Œå¹¶å…¬å¼€HTTP/metricsä»¥ä¾¿Prometheus Serverè¿›è¡Œå®šæœŸè°ƒç”¨å’Œæ‹‰å–æŒ‡æ ‡ã€‚ Exporterï¼šå®ƒä¼šä»Collectorè·å–æŒ‡æ ‡æ•°æ®ï¼Œå¹¶å°†å…¶è½¬æˆä¸ºPrometheuså¯è¯»æ ¼å¼ã€‚ metricsçš„ç»„æˆ æŒ‡æ ‡åç§° (Metric Name): æè¿°æŒ‡æ ‡çš„åç§°ã€‚ æ ‡ç­¾ (Labels): å¯é€‰ï¼Œä¸€ç»„é”®å€¼å¯¹ï¼Œç”¨äºæ ‡è¯†åŒä¸€æŒ‡æ ‡çš„ä¸åŒå®ä¾‹ã€‚ æ—¶é—´æˆ³ (Timestamp): å¯é€‰çš„ Unix æ—¶é—´æˆ³ï¼Œè¡¨ç¤ºæŒ‡æ ‡è®°å½•çš„æ—¶é—´ç‚¹ã€‚ å€¼ (Value): æŒ‡æ ‡çš„æ•°å€¼ã€‚ Prometheuså®šä¹‰äº†å››ç§ä¸»è¦çš„æŒ‡æ ‡ç±»å‹ï¼š Counterï¼ˆè®¡æ•°å™¨ï¼‰ï¼šç”¨äºè¡¨ç¤ºå•è°ƒé€’å¢çš„æŒ‡æ ‡ï¼Œä¾‹å¦‚è¯·æ±‚æ•°ç­‰ã€‚Counteråœ¨æ¯æ¬¡è§‚æµ‹æ—¶ä¼šå¢åŠ å®ƒæ‰€ä»£è¡¨çš„å€¼ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªæ•´æ•°ï¼‰ï¼Œä½†ä¸ä¼šå‡å°‘æˆ–è€…é‡ç½®ã€‚ Gaugeï¼ˆä»ªè¡¨ç›˜ï¼‰ï¼šç”¨äºè¡¨ç¤ºå¯å˜åŒ–çš„åº¦é‡å€¼ï¼Œä¾‹å¦‚CPUåˆ©ç”¨ç‡ã€å†…å­˜ç”¨é‡ç­‰ã€‚Gaugeå¯ä»¥å¢åŠ ã€å‡å°‘æˆ–é‡ç½®ï¼Œä»£è¡¨ç€å½“å‰çš„çŠ¶æ€ã€‚ Histogramï¼ˆç›´æ–¹å›¾ï¼‰ï¼šç”¨äºè¡¨ç¤ºæ•°æ®æ ·æœ¬çš„åˆ†å¸ƒæƒ…å†µï¼Œä¾‹å¦‚è¯·æ±‚å»¶è¿Ÿç­‰ã€‚Histogramå°†æ•°æ®æŒ‰ç…§æ¡¶ï¼ˆbucketï¼‰è¿›è¡Œåˆ’åˆ†ï¼Œå¹¶å¯¹æ¯ä¸ªæ¡¶å†…çš„æ ·æœ¬è®¡ç®—å‡ºä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚æ ·æœ¬æ•°é‡ã€æ€»å’Œã€å¹³å‡å€¼ç­‰ã€‚ Summaryï¼ˆæ‘˜è¦ï¼‰ï¼šç±»ä¼¼äºHistogramï¼Œä¹Ÿç”¨äºè¡¨ç¤ºæ•°æ®æ ·æœ¬çš„åˆ†å¸ƒæƒ…å†µï¼Œä½†åŒæ—¶å±•ç¤ºæ›´å¤šçš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚æ ·æœ¬æ•°é‡ã€æ€»å’Œã€å¹³å‡å€¼ã€ä¸Šåˆ†ä½æ•°ã€ä¸‹åˆ†ä½æ•°ç­‰ã€‚ å¼€å‘ç¤ºä¾‹ package main import ( \"net/http\" \"github.com/prometheus/client_golang/prometheus\" \"github.com/prometheus/client_golang/prometheus/promhttp\" ) var counterMetric prometheus.Counter func helloHandler(w http.ResponseWriter, r *http.Request) { counterMetric.Add(1) w.Write([]byte(\"Hello from Prometheus Exporter!\")) } func main() { // åˆ›å»ºä¸€ä¸ªCounteræŒ‡æ ‡ counterMetric = prometheus.NewCounter(prometheus.CounterOpts{ Name: \"ep1_counter\", // æŒ‡æ ‡åç§° Help: \"ep1 hello counter metric.\", // æŒ‡æ ‡å¸®åŠ©ä¿¡æ¯ }) // ç»™æŒ‡æ ‡èµ‹å€¼ã€‚æ¨¡æ‹Ÿè¯·æ±‚ï¼Œæ¯ç§’é€’å¢è®¡æ•°å™¨ go func() { for { counter.Inc(5) time.Sleep(time.Second) } }() // æ³¨å†ŒæŒ‡æ ‡ prometheus.MustRegister(counterMetric) // åˆ›å»ºä¸€ä¸ªHTTPå¤„ç†å™¨æ¥æš´éœ²æŒ‡æ ‡ http.Handle(\"/metrics\", promhttp.Handler()) http.HandleFunc(\"/hello\", helloHandler) // å¯åŠ¨WebæœåŠ¡å™¨ http.ListenAndServe(\":8080\", nil) } curl 127.0.0.1:8080/hello ## curl 127.0.0.1:8080/metrics # HELP ep1_counter ep1 hello counter metric. # TYPE ep1_counter counter ep1_counter 12 # HELP go_gc_duration_seconds A summary of the wall-time pause (stop-the-world) duration in garbage collection cycles. # HELP ep1_counter ep1 hello counter metric. # TYPE ep1_counter counter ep1_counter 12 # HELP go_gc_duration_seconds A summary of the wall-time pause (stop-the-world) duration in garbage collection cycles. ä¸€ç»„counteræŒ‡æ ‡ // CounterVecæ˜¯ä¸€ç»„counterï¼Œè¿™äº›è®¡æ•°å™¨å…·æœ‰ç›¸åŒçš„æè¿°ï¼Œä½†å®ƒä»¬çš„å˜é‡æ ‡ç­¾å…·æœ‰ä¸åŒçš„å€¼ã€‚ //step1:åˆå§‹åŒ–ä¸€ä¸ªå®¹å™¨ httpReqs := prometheus.NewCounterVec( prometheus.CounterOpts{ Name: \"http_requests_total\", Help: \"How many HTTP requests processed, partitioned by status code and HTTP method.\", }, []string{\"code\", \"method\"}, ) //step2:æ³¨å†Œå®¹å™¨ prometheus.MustRegister(httpReqs) httpReqs.WithLabelValues(\"404\", \"POST\").Add(42) // If you have to access the same set of labels very frequently, it // might be good to retrieve the metric only once and keep a handle to // it. But beware of deletion of that metric, see below! //step3:å‘å®¹å™¨ä¸­å†™å…¥å€¼ï¼Œä¸»è¦è°ƒç”¨å®¹å™¨çš„æ–¹æ³•å¦‚Inc()æˆ–è€…Add()æ–¹æ³• m := httpReqs.WithLabelValues(\"200\", \"GET\") for i := 0; i \u003c 1000000; i++ { m.Inc() } // Delete a metric from the vector. If you have previously kept a handle // to that metric (as above), future updates via that handle will go // unseen (even if you re-create a metric with the same label set // later). httpReqs.DeleteLabelValues(\"200\", \"GET\") // Same thing with the more verbose Labels syntax. httpReqs.Delete(prometheus.Labels{\"method\": \"GET\", \"code\": \"200\"}) guage ç¤ºä¾‹ // CounterVecæ˜¯ä¸€ç»„counterï¼Œè¿™äº›è®¡æ•°å™¨å…·æœ‰ç›¸åŒçš„æè¿°ï¼Œä½†å®ƒä»¬çš„å˜é‡æ ‡ç­¾å…·æœ‰ä¸åŒçš„å€¼ã€‚ //step1:åˆå§‹åŒ–ä¸€ä¸ªå®¹å™¨ httpReqs := prometheus.NewCounterVec( prometheus.CounterOpts{ Name: \"http_requests_total\", Help: \"How many HTTP requests processed, partitioned by status code and HTTP method.\", }, []string{\"code\", \"method\"}, ) //step2:æ³¨å†Œå®¹å™¨ prometheus.MustRegister(httpReqs) httpReqs.WithLabelValues(\"404\", \"POST\").Add(42) // If you have to access the same set of labels very frequently, it // might be good to retrieve the metric only once and keep a handle to // it. But beware of deletion of that metric, see below! //step3:å‘å®¹å™¨ä¸­å†™å…¥å€¼ï¼Œä¸»è¦è°ƒç”¨å®¹å™¨çš„æ–¹æ³•å¦‚Inc()æˆ–è€…Add()æ–¹æ³• m := httpReqs.WithLabelValues(\"200\", \"GET\") for i := 0; i \u003c 1000000; i++ { m.Inc() } // Delete a metric from the vector. If you have previously kept a handle // to that metric (as above), future updates via that handle will go // unseen (even if you re-create a metric with the same label set // lat","date":"2025-07-13","objectID":"/posts/2025-07-13-exporter/:0:1","tags":["Go","exporter"],"title":"Go exporter","uri":"/posts/2025-07-13-exporter/"},{"categories":["Go Wire"],"content":"Go Wire wireæ˜¯ Google å¼€æºçš„ä¸€ä¸ªä¾èµ–æ³¨å…¥å·¥å…·ã€‚å®ƒæ˜¯ä¸€ä¸ªä»£ç ç”Ÿæˆå™¨ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªæ¡†æ¶ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨ä¸€ä¸ªç‰¹æ®Šçš„goæ–‡ä»¶ä¸­å‘Šè¯‰wireç±»å‹ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå®ƒä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆä»£ç ï¼Œå¸®åŠ©æˆ‘ä»¬åˆ›å»ºæŒ‡å®šç±»å‹çš„å¯¹è±¡ï¼Œå¹¶ç»„è£…å®ƒçš„ä¾èµ–ã€‚ ä½¿ç”¨ï¼š go get github.com/google/wire/cmd/wire wire ç¤ºä¾‹ï¼š å®šä¹‰ç»“æ„ä½“å’Œæ–¹æ³•ä¸€èˆ¬ç»“æ„ package handler import ( \"fmt\" \"wire-example/config\" \"wire-example/service\" ) type UserHandler struct { Service *service.UserService Cfg *config.Cfg } func NewUserHandler(s *service.UserService, cfg *config.Cfg) *UserHandler { return \u0026UserHandler{Service: s, Cfg: cfg} } func (h *UserHandler) HandleRequest(id int) { fmt.Println(\"Handling user:\", h.Service.GetUser(id)) fmt.Println(h.Cfg.Name) } func InitializeHandler(cfg *config.Cfg) *handler.UserHandler { wire.Build( repo.NewUserRepository, service.NewUserService, handler.NewUserHandler, ) return nil } ","date":"2025-06-28","objectID":"/posts/2025-06-28.go-wire/:1:0","tags":["Go","Wire"],"title":"Go Wire","uri":"/posts/2025-06-28.go-wire/"},{"categories":["Jellyfin"],"content":"Jellyfin å®¶åº­å½±é™¢ docker å®‰è£… docker pull jellyfin/jellyfin docker run -d --name=Jellyfin -p 8096:8096 \\ # --name=Jellyfin å°†å®¹å™¨åå®šä¹‰ä¸º Jellyfin -p 8920:8920 -p 7359:7359/udp -p 1900:1900/udp #è¿™ä¸‰ä¸ªç«¯å£ä¸ºå¯é€‰é¡¹ \\ -v `pwd`/config:/config -v `pwd`/cache:/cache -v /media:/media \\ -e TZ=Asia/Shanghai -e PUID=0 -e PGID=0 --device=/dev/dri:/dev/dri --add-host=api.themoviedb.org:13.224.161.90 \\ #ä¸ºå®¹å™¨å¢åŠ  host æŒ‡å‘ï¼ŒåŠ é€Ÿæµ·æŠ¥ä¸å½±è§†å…ƒæ•°æ®çš„æœåˆ® --add-host=api.themoviedb.org:13.35.8.65 \\ --add-host=api.themoviedb.org:13.35.8.93 \\ --add-host=api.themoviedb.org:13.35.8.6 \\ --add-host=api.themoviedb.org:13.35.8.54 \\ --add-host=image.tmdb.org:138.199.37.230 \\ --add-host=image.tmdb.org:108.138.246.49 \\ --add-host=api.thetvdb.org:13.225.89.239 \\ --add-host=api.thetvdb.org:192.241.234.54 \\ --restart unless-stopped \\ jellyfin/jellyfin:latest ","date":"2025-05-18","objectID":"/posts/2025-05-18.jellyfin/:0:0","tags":["Jellyfin"],"title":"Jellyfin","uri":"/posts/2025-05-18.jellyfin/"},{"categories":["Go ä»£ç ç‰‡æ®µ"],"content":"Go ä»£ç ç‰‡æ®µ go goroutines pool package main import ( \"fmt\" \"github.com/sourcegraph/conc/pool\" ) func main() { p := pool.New().WithMaxGoroutines(3) for i := 1; i \u003c= 5; i++ { p.Go(func() { fmt.Println(i) }) } p.Wait() } å¸¦ctx çš„go goroutines pool package main import ( \"context\" \"errors\" \"fmt\" \"github.com/sourcegraph/conc/pool\" ) func main() { p := pool.New(). WithMaxGoroutines(4). WithContext(context.Background()). WithCancelOnError() for i := 0; i \u003c 3; i++ { i := i p.Go(func(ctx context.Context) error { if i == 2 { return errors.New(\"I will cancel all other tasks!\") } \u003c-ctx.Done() return nil }) } err := p.Wait() fmt.Println(err) // Output: // I will cancel all other tasks! } channel package main import ( \"fmt\" ) func main() { ch := make(chan int, 3) // wg := conc.NewWaitGroup() go func() { for i := 0; i \u003c 1000; i++ { ch \u003c- i } close(ch) }() // wg.Wait() for v := range ch { fmt.Println(v) } } package main import ( \"fmt\" \"github.com/sourcegraph/conc\" ) func main() { ch := make(chan int) // ch2 := make(chan bool) wg := conc.NewWaitGroup() wg.Go(func() { for i := 0; i \u003c 100; i++ { ch \u003c- i } close(ch) }) for sub := range ch { fmt.Println(sub) } } å¤æ‚ç»“æ„ä½“sliceæ’åº type Person struct { Name string Age int Book int } people := []Person{ {\"Alice\", 30, 5}, {\"Bob\", 25, 2}, {\"Charlie\", 30, 55}, {\"David\", 25, 33}, } // ä½¿ç”¨ sort.Slice è¿›è¡Œæ’åºï¼ŒæŒ‰å¹´é¾„å‡åºæ’åˆ—,å¹´é¾„ç›¸åŒåˆ™æŒ‰bookæ’åº sort.Slice(people, func(i, j int) bool { if people[i].Age == people[j].Age { return people[i].Book \u003c people[j].Book } return people[i].Age \u003c people[j].Age }) errorgroup package main import ( \"errors\" \"fmt\" \"golang.org/x/sync/errgroup\" ) func main() { eg := errgroup.Group{} eg.Go(func() error { fmt.Println(\"go1\") return nil }) eg.Go(func() error { fmt.Println(\"go2\") err := errors.New(\"go2 err\") return err }) err := eg.Wait() if err != nil { fmt.Println(\"err =\", err) } } // å¸¦ctx func main1() { eg, ctx := errgroup.WithContext(context.Background()) eg.Go(func() error { time.Sleep(1 * time.Second) select { case \u003c-ctx.Done(): fmt.Println(\"go1 cancel, err = \", ctx.Err()) default: fmt.Println(\"go1 run\") } return nil }) eg.Go(func() error { err := errors.New(\"go2 err\") return err }) err := eg.Wait() if err != nil { fmt.Println(\"err =\", err) } } // é™åˆ¶å¹¶å‘æ•° func main2() { eg := errgroup.Group{} eg.SetLimit(2) eg.TryGo(func() error { fmt.Println(\"go1 run\") return nil }) eg.TryGo(func() error { err := errors.New(\"go2 err\") return err }) eg.TryGo(func() error { fmt.Println(\"go3 run\") return nil }) err := eg.Wait() if err != nil { fmt.Println(\"err =\", err) } } gorm clause err = pa.WithContext(ctx).Clauses( clause.OnConflict{ Columns: []clause.Column{ {Name: user.Code.ColumnName().String()}, }, TargetWhere: clause.Where{ Exprs: []clause.Expression{ clause.Expr{ SQL: \"deleted_at = 0\", }, }, }, DoUpdates: clause.AssignmentColumns(cols), }, ). CreateInBatches(items, 30) // è¡¨è®¾è®¡ä¼˜åŒ–ï¼Œè¿™æ ·åªæœ‰å½“deleted_atä¸ºnullçš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘codeçš„å”¯ä¸€æ€§æ ¡éªŒ // create unique index pa_code // on pa (code) where deleted_at is null; recover ä½¿ç”¨ func main3() { defer func() { if err2 := recover(); err2 != nil { fmt.Printf(\"Run panic error: %v\", err2) } }() fmt.Println(\"xxx\") } func ä½œä¸ºä¼ å‚ package main import \"fmt\" func apply(x int, y int, f func(int, int) int) int { return f(x, y) } func sum(a int, b int) int { return a + b } func main() { asum := apply(5, 10, sum) fmt.Println(asum) } // func sayHello(name string) func() string { return func() string { return \"Hello, \" + name } } func main2() { hello := sayHello(\"Go\") fmt.Println(hello()) // è¾“å‡º: Hello, Go } å•å…ƒæµ‹è¯• package main import ( \"testing\" ) func TestInit(t *testing.T) { t.Log(\"heh\") helper := PersonHelper{} helper.init(\"pleuvoir\") t.Log(helper.Name) } å‡½æ•°è¿è¡Œæ—¶é—´ func TimeSince(f func()) string { start := time.Now() // è·å–å½“å‰æ—¶é—´ f() // æ‰§è¡Œä¼ å…¥çš„å‡½æ•° // è·å–ç»“æŸçš„æ—¶é—´ elapsed := time.Since(start) str := fmt.Sprintf(\"è¯¥å‡½æ•°æ‰§è¡Œå®Œæˆè€—æ—¶ï¼š%v\", elapsed) return str } func main() { result := TimeSince(timeTest) fmt.Println(result) } func timeTest() { // è¿è¡Œçš„å‡½æ•° sum := 0 for i := 0; i \u003c 1111111111; i++ { sum++ } } éšæœºæ•° //start 10ï¼Œend 20ï¼Œå°†è·å¾—è¿™ä¹‹é—´çš„éšæœºæ•° func","date":"2025-04-27","objectID":"/posts/2025-04-27.go-code/:0:0","tags":["Go","code"],"title":"Go code","uri":"/posts/2025-04-27.go-code/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go lo ä½¿ç”¨ go get github.com/samber/lo ä½¿ç”¨ // å°†åˆ‡ç‰‡ä¸­çš„é‡å¤å…ƒç´ å»æ‰ï¼Œåªä¿ç•™ç¬¬ä¸€ä¸ªå‡ºç°çš„å…ƒç´ ã€‚ names := lo.Uniq([]string{\"Samuel\", \"John\", \"Samuel\"}) // []string{\"Samuel\", \"John\"} // ç”Ÿæˆmap // å°†åˆ‡ç‰‡æˆ–æ•°ç»„è½¬æ¢ä¸ºmapï¼Œkeyæ˜¯callbackå‡½æ•°çš„è¿”å›å€¼ï¼Œvalueæ˜¯å¯¹åº”çš„å…ƒç´ ã€‚ å½“keyç›¸åŒæ—¶ï¼Œåé¢çš„å…ƒç´ ä¼šè¦†ç›–å‰é¢çš„å…ƒç´ ã€‚ type abc struct { A string } aa := []*abc{} lo.KeyBy(aa, func(item *abc) string { return item.A }) // ç”Ÿæˆ map map[string][]*abc{} lo.GroupBy(aa, func(item *abc) string { return item.A }) // æ ¹æ®æ¡ä»¶è¿‡æ»¤åˆ‡ç‰‡é‡Œçš„å…ƒç´  even := lo.Filter([]int{1, 2, 3, 4}, func(x int, index int) bool { return x%2 == 0 }) // []int{2, 4} // for å¾ªç¯ lo.ForEach([]string{\"hello\", \"world\"}, func(x string, _ int) { println(x) }) // Associate (alias: SliceToMap) // å¯¹åˆ‡ç‰‡éå†ç”Ÿæˆä¸€ä¸ªMapï¼Œkeyå’Œvalueç”±callbackå‡½æ•°ç”Ÿæˆã€‚keyæ˜¯ç¬¬ä¸€ä¸ªè¿”å›å€¼ï¼Œvalueæ˜¯ç¬¬äºŒä¸ªè¿”å›å€¼ã€‚å¦‚æœkeyç›¸åŒï¼Œåé¢çš„å…ƒç´ ä¼šè¦†ç›–å‰é¢çš„å…ƒç´ ã€‚ in := []*foo{{baz: \"apple\", bar: 1}, {baz: \"banana\", bar: 2}} aMap := lo.Associate(in, func (f *foo) (string, int) { return f.baz, f.bar }) // map[string][int]{ \"apple\":1, \"banana\":2 } // Drop // å»æ‰åˆ‡ç‰‡çš„å‰nä¸ªå…ƒç´ ã€‚ l := lo.Drop([]int{0, 1, 2, 3, 4, 5}, 2) // []int{2, 3, 4, 5} // DropRight // å»æ‰åˆ‡ç‰‡çš„ånä¸ªå…ƒç´ ã€‚ l := lo.DropRight([]int{0, 1, 2, 3, 4, 5}, 2) // []int{0, 1, 2, 3} // DropWhile // DropWhile ä¼šä¸€ç›´åˆ é™¤å…ƒç´ ï¼Œç›´åˆ°predicateè¿”å›falseã€‚ l := lo.DropWhile([]string{\"a\", \"aa\", \"aaa\", \"aa\", \"aa\"}, func(val string) bool { return len(val) \u003c= 2 }) // []string{\"aaa\", \"aa\", \"aa\"} // è®¡ç®—åˆ‡ç‰‡ä¸­å’Œvalueç›¸ç­‰çš„å…ƒç´ çš„ä¸ªæ•°ã€‚ count := lo.Count([]int{1, 5, 1}, 1) // 2 // è®¡ç®—åˆ‡ç‰‡ä¸­æ»¡è¶³predicateå‡½æ•°çš„å…ƒç´ çš„ä¸ªæ•°ã€‚ count := lo.CountBy([]int{1, 5, 1}, func(i int) bool { return i \u003c 4 }) // 2 // CountValues // è®¡ç®—åˆ‡ç‰‡ä¸­æ¯ä¸ªå…ƒç´ çš„ä¸ªæ•°ã€‚å…¶ä¸­keyæ˜¯å…ƒç´ ï¼Œvalueæ˜¯ä¸ªæ•°ã€‚ lo.CountValues([]int{}) // map[int]int{} lo.CountValues([]int{1, 2}) // map[int]int{1: 1, 2: 1} lo.CountValues([]int{1, 2, 2}) // map[int]int{1: 1, 2: 2} // Subset // è¿”å›åˆ‡ç‰‡ä¸­ä»offsetå¼€å§‹çš„lengthä¸ªå…ƒç´ ã€‚ä½†æ˜¯ä¸ä¼šå› ä¸ºè¶Šç•Œè€Œpanicã€‚ in := []int{0, 1, 2, 3, 4} sub := lo.Subset(in, 2, 3) // []int{2, 3, 4} // Slice // è¿”å›ä¸€ä¸ªåˆ‡ç‰‡çš„å‰¯æœ¬ï¼Œä»startåˆ°endï¼Œä½†æ˜¯ä¸åŒ…æ‹¬endã€‚ä¸ä¼šå› ä¸ºè¶Šç•Œè€Œpanicã€‚ in := []int{0, 1, 2, 3, 4} slice := lo.Slice(in, 0, 5) // []int{0, 1, 2, 3, 4} slice := lo.Slice(in, 2, 3) // []int{2} // Compact // å»æ‰æ‰€æœ‰é›¶å€¼ in := []string{\"\", \"foo\", \"\", \"bar\", \"\"} slice := lo.Compact[string](in) // []string{\"foo\", \"bar\"} // åˆ‡ç‰‡ç±»å‹è½¬æ¢ lo.Map([]int64{1, 2, 3, 4}, func(x int64, index int) string { return strconv.FormatInt(x, 10) }) // []string{\"1\", \"2\", \"3\", \"4\"} // å¯¹æŸä¸€ä¸ªå‡½æ•°è°ƒç”¨næ¬¡ï¼Œè¿”å›ç»“æœçš„åˆ‡ç‰‡ã€‚iä¸ºç´¢å¼•ï¼Œ ä»0å¼€å§‹ã€‚ lo.Times(3, func(i int) string { return strconv.FormatInt(int64(i), 10) }) // []string{\"0\", \"1\", \"2\"} // chunk åˆ†ç‰‡ lo.Chunk([]int{0, 1, 2, 3, 4, 5}, 2) // å±•å¼€äºŒç»´åˆ‡ç‰‡ flat := lo.Flatten([][]int{{0, 1}, {2, 3, 4, 5}}) // []int{0, 1, 2, 3, 4, 5} // æ´—ç‰Œ // è¿”å›ä¸€ä¸ªæ‰“ä¹±é¡ºåºçš„åˆ‡ç‰‡ï¼Œ ä½¿ç”¨Fisher-Yates shuffle Fisher-Yates shuffle randomOrder := lo.Shuffle([]int{0, 1, 2, 3, 4, 5}) // []int{1, 4, 0, 3, 5, 2} // åè½¬ // åè½¬åˆ‡ç‰‡ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ å˜æˆæœ€åä¸€ä¸ªï¼Œç¬¬äºŒä¸ªå…ƒç´ å˜æˆå€’æ•°ç¬¬äºŒä¸ªï¼Œä»¥æ­¤ç±»æ¨ã€‚ reverseOrder := lo.Reverse([]int{0, 1, 2, 3, 4, 5}) // Repeat // ç”Ÿæˆä¸€ä¸ªåˆ‡ç‰‡ï¼ŒåŒ…å«Nä¸ªç›¸åŒçš„å…ƒç´ ã€‚ slice := lo.Repeat(2, foo{\"a\"}) // []foo{foo{\"a\"}, foo{\"a\"}} // Splice æŒ‡å®šç´¢å¼•æ’å…¥åˆ‡ç‰‡ result := lo.Splice([]string{\"a\", \"b\"}, 1, \"1\", \"2\") // []string{\"a\", \"1\", \"2\", \"b\"} // è·å–mapçš„key keys := lo.Keys(map[string]int{\"foo\": 1, \"bar\": 2}) // []string{\"foo\", \"bar\"} // è·å–å¤šä¸ªmapçš„keyçš„å”¯ä¸€å€¼ï¼Œç»„æˆå”¯ä¸€çš„slice keys := lo.UniqKeys(map[string]int{\"foo\": 1, \"bar\": 2}, map[string]int{\"baz\": 3}) // []string{\"foo\", \"bar\", \"baz\"} // åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨ exists := lo.HasKey(map[string]int{\"foo\": 1, \"bar\": 2}, \"foo\") // true // è·å–mapçš„å€¼ values := lo.Values(map[string]int{\"foo\": 1, \"bar\": 2}) // []int{1, 2} // è·å–mapçš„å€¼å¹¶å»é‡ values := lo.UniqValues(map[string]int{\"foo\": 1, \"bar\": 2}) // []int{1, 2} // æ±‚å’Œ list := []int{1, 2, 3, 4, 5} sum := lo.Sum(list) // 15 // è®¡ç®—å¹³å‡å€¼ mean := lo.Mean([]int{2, 3, 4, 5}) // 3 // éšæœºå­—ç¬¦ä¸² str := lo.RandomString(5, lo.LettersCharset) // example: \"eIGbt\" // è·å–å­ä¸² sub := lo.Substring(\"hello\", 2, 3) // \"llo\" // é©¼å³° str := lo.PascalCase(\"hello_world\") // HelloWorld str := lo.CamelCase(\"hello_world\") // helloWorld str := lo.KebabCase(\"helloWorld\") // hello-world // è›‡å‹ str := lo.SnakeCase(\"HelloWorld\") // hello_world // ä¾æ®å¤§å†™æ‹†åˆ†å•è¯ str := lo.Words(\"helloWorld\") // []string{\"hello\", \"world\"} // é¦–å­—æ¯å¤§å†™ str := lo.Capitalize(\"heLLO\") // Hello //","date":"2025-01-04","objectID":"/posts/2025-01-04-lo/:0:0","tags":["Go","lo"],"title":"Go lo","uri":"/posts/2025-01-04-lo/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go Set é›†åˆ Githubåœ°å€ï¼šhttps://github.com/deckarep/golang-set ä½¿ç”¨ï¼š go get github.com/deckarep/golang-set/v2 é›†åˆé‡Œçš„å…ƒç´ ä¸ä¼šé‡å¤ ç¤ºä¾‹ï¼š package main import ( \"fmt\" mapset \"github.com/deckarep/golang-set/v2\" ) func main() { ac := mapset.NewSet[string]() ac.Add(\"a1\") ac.Add(\"a2\") ac.Add(\"a3\") ac.Add(\"a1\") ac.Add(\"a2\") fmt.Println(ac.ToSlice()) } æ‰§è¡Œç»“æœ [a1 a2 a3] ","date":"2025-01-04","objectID":"/posts/2025-01-04-goset/:0:0","tags":["Go","set"],"title":"Go set","uri":"/posts/2025-01-04-goset/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Goose æ•°æ®åº“ç‰ˆæœ¬ç®¡ç† Goose æ˜¯ä¸€ä¸ªç”¨äºç®¡ç†æ•°æ®åº“è¿ç§»çš„å·¥å…·ï¼Œç±»ä¼¼äº Flyway å’Œ Liquibaseã€‚å®ƒå¯ä»¥æ–¹ä¾¿åœ°ç®¡ç†æ•°æ®åº“æ¨¡å¼çš„ç‰ˆæœ¬ï¼Œå¹¶åº”ç”¨ç›¸åº”çš„ SQL è„šæœ¬ã€‚ä½ æåˆ°åœ¨ db/migrations/ ç›®å½•ä¸‹æœ‰å¤šä¸ª SQL æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶é€šå¸¸æ˜¯ç”¨æ¥ç®¡ç†æ•°æ®åº“è¿ç§»çš„ã€‚ ","date":"2024-11-25","objectID":"/posts/2024-11-25-goose/:0:0","tags":["Go","goose"],"title":"Go goose","uri":"/posts/2024-11-25-goose/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"ä¸€ã€åŸºæœ¬ä½¿ç”¨ 1ã€å®‰è£… go install github.com/pressly/goose/v3/cmd/goose@latest å¯¹äºä¸å¸Œæœ›å®‰è£…ä¸æ•°æ®åº“è¿æ¥ç›¸å…³å‘½ä»¤çš„è½»é‡ç‰ˆï¼Œå¯ä»¥ä½¿ç”¨ç‹¬æœ‰çš„æ„å»ºæ ‡ç­¾ï¼š go build -tags='no_postgres no_mysql no_sqlite3 no_ydb' -o goose ./cmd/goose 2ã€ä½¿ç”¨æ–¹æ³• ä»¥ä¸‹è¡¨æ ¼è¯´æ˜äº† Goose å·¥å…·çš„åŸºæœ¬ç”¨æ³•ï¼š å‘½ä»¤ æè¿° up å°†æ•°æ®åº“è¿ç§»åˆ°æœ€æ–°çš„ç‰ˆæœ¬ up-to è¿ç§»åˆ°ç‰¹å®šç‰ˆæœ¬ up-by-one ä»å½“å‰ç‰ˆæœ¬å‘ä¸Šè¿ç§»ä¸€ä¸ªç‰ˆæœ¬ down å›æ»šå½“å‰ç‰ˆæœ¬çš„å‰ä¸€ä¸ªç‰ˆæœ¬ down-to å›æ»šåˆ°ç‰¹å®šç‰ˆæœ¬ redo å›æ»šæœ€æ–°åº”ç”¨çš„è¿ç§»ç„¶åé‡æ–°åº”ç”¨ status è¾“å‡ºå½“å‰æ•°æ®åº“çš„è¿ç§»çŠ¶æ€ version è¾“å‡ºæ•°æ®åº“å½“å‰çš„ç‰ˆæœ¬ create åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶ï¼Œå¯ä»¥é€‰æ‹© sql æˆ– go æ ¼å¼ fix åº”ç”¨åºåˆ—ç¼–å·åˆ°è¿ç§» validate æ£€æŸ¥è¿ç§»æ–‡ä»¶ï¼Œè€Œä¸å®é™…è¿è¡Œ ä½ å¯ä»¥è®¾ç½®ç¯å¢ƒå˜é‡ GOOSE_DRIVER, GOOSE_DBSTRING, å’Œ GOOSE_MIGRATION_DIR æ¥å®šåˆ¶ Goose çš„è¡Œä¸ºã€‚ Gooseæ”¯æŒçš„æ•°æ®åº“ç±»å‹ mssql,sqlserver,mysql,tidb,sqlite3,clickhouseç­‰ å…·ä½“çœ‹ goose.OpenDBWithDriver() æ–¹æ³• äºŒã€é›†æˆ package main import ( \"context\" \"flag\" \"log\" \"os\" \"github.com/pressly/goose/v3\" _ \"modernc.org/sqlite\" ) var ( flags = flag.NewFlagSet(\"goose\", flag.ExitOnError) dir = flags.String(\"dir\", \".\", \"directory with migration files\") ) func main() { flags.Parse(os.Args[1:]) args := flags.Args() if len(args) \u003c 3 { flags.Usage() return } dbstring, command := args[1], args[2] db, err := goose.OpenDBWithDriver(\"sqlite\", dbstring) if err != nil { log.Fatalf(\"goose: failed to open DB: %v\\n\", err) } defer func() { if err := db.Close(); err != nil { log.Fatalf(\"goose: failed to close DB: %v\\n\", err) } }() arguments := []string{} if len(args) \u003e 3 { arguments = append(arguments, args[3:]...) } if err := goose.RunContext(context.Background(), command, db, *dir, arguments...); err != nil { log.Fatalf(\"goose %v: %v\", command, err) } } ä½¿ç”¨ [root@Sugar goose]ğŸ³ ./cccs sqlite3 ./foo.db status 2024/11/24 15:28:17 goose status: failed to collect migrations: no migration files found [root@Sugar goose]ğŸ³ ./cccs sqlite3 ./foo.db status -dir dbFile 2024/11/24 15:28:32 goose status: failed to collect migrations: no migration files found [root@Sugar goose]ğŸ³ ./cccs -dir dbFile sqlite3 ./foo.db status 2024/11/24 15:28:51 Applied At Migration 2024/11/24 15:28:51 ======================================= 2024/11/24 15:28:51 Pending -- 20241124142616_v24_2_1_add_some_column.sql [root@Sugar goose]ğŸ³ ./cccs -dir dbFile sqlite3 ./foo.db up 2024/11/24 15:29:05 OK 202411xxxx2616_v24_2_1_add_some_column.sql (2.57ms) 2024/11/24 15:29:05 goose: successfully migrated database to version: 20241124142616 [root@Sugar goose]ğŸ³ ./cccs -dir dbFile sqlite3 ./foo.db down 2024/11/24 15:31:04 OK 20241124142616_v24_2_1_add_some_column.sql (2.96ms) [root@Sugar goose]ğŸ³ ./cccs -dir dbFile sqlite3 ./foo.db up 2024/11/24 15:32:08 OK 20241124142616_v24_2_1_add_some_column.sql (2.77ms) 2024/11/24 15:32:08 goose: successfully migrated database to version: 20241124142616 [root@Sugar goose]ğŸ³ sql æ–‡ä»¶æ‰“åŒ…åˆ°äºŒè¿›åˆ¶ä¸­ //go:embed docs/sql/*.sql var Migrations embed.FS func GenTable(migrations embed.FS, gooseArgs []string, dir string) { goose.SetBaseFS(migrations) command := gooseArgs[0] gooseDB, err := goose.OpenDBWithDriver(config.Cfg.Database.Type, config.Cfg.Database.DBname) if err != nil { slog.Error(\"goose: failed to open DB\", \"err\", err) } defer func() { if err := gooseDB.Close(); err != nil { slog.Error(\"goose: failed to close DB\", \"err\", err) } }() arguments := []string{} if len(gooseArgs) \u003e 1 { arguments = append(arguments, gooseArgs[1:]...) } if err := goose.RunContext(context.Background(), command, gooseDB, dir, arguments...); err != nil { slog.Error(\"goose: failed to run cmd\", \"cmd\", command, \"err\", err) } } ","date":"2024-11-25","objectID":"/posts/2024-11-25-goose/:0:1","tags":["Go","goose"],"title":"Go goose","uri":"/posts/2024-11-25-goose/"},{"categories":["Java åŸºç¡€"],"content":"Java é…ç½®settings é»˜è®¤è¯»å–ä½ç½® ~/.m2 curl -O https://repo1.maven.org/maven2/archetype-catalog.xml \u003csettings xmlns=\"http://maven.apache.org/SETTINGS/1.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd\"\u003e \u003clocalRepository\u003e/home/sugar/.m2/repository\u003c/localRepository\u003e \u003cmirrors\u003e \u003cmirror\u003e \u003cid\u003ealimaven\u003c/id\u003e \u003cmirrorOf\u003ecentral\u003c/mirrorOf\u003e \u003cname\u003ealiyun maven\u003c/name\u003e \u003curl\u003ehttps://maven.aliyun.com/nexus/content/groups/public/\u003c/url\u003e \u003c/mirror\u003e \u003c/mirrors\u003e \u003cprofiles\u003e \u003cprofile\u003e \u003cid\u003earchetype-catalog\u003c/id\u003e \u003cactivation\u003e \u003cactiveByDefault\u003etrue\u003c/activeByDefault\u003e \u003c/activation\u003e \u003cproperties\u003e \u003carchetypeCatalog\u003efile:///Users/sugar/.m2/archetype-catalog.xml\u003c/archetypeCatalog\u003e \u003c/properties\u003e \u003c/profile\u003e \u003c/profiles\u003e \u003c/settings\u003e # æ‰‹åŠ¨ä¸‹è½½ä¾èµ– mvn -B -f pom.xml -s /usr/share/maven/ref/settings.xml dependency:resolve # æ‰“åŒ… mvn package ","date":"2024-10-26","objectID":"/posts/2024-10-26-java/:1:0","tags":["Java"],"title":"Java Basic","uri":"/posts/2024-10-26-java/"},{"categories":["Java åŸºç¡€"],"content":"ä¸€ã€åŸºç¡€ 1ã€helloworld java çš„åŒ…åéœ€è¦å’Œç›®å½•ä¸€è‡´ï¼Œç±»åéœ€è¦ä¸æ–‡ä»¶åä¸€è‡´ [sugar@Sugar java]ğŸ³ tree . . â””â”€â”€ Hello â””â”€â”€ Hello.java 1 directory, 1 file public class Hello { public static void main(String[] args) { System.out.println(\"Hello, world!\"); } } [root@Sugar j1]ğŸ³ java Hello.java Hello, world! 2ã€å˜é‡å®šä¹‰ int n = 100; n = 200; // å˜é‡nèµ‹å€¼ä¸º200 int i2 = -2147483648; int i3 = 2_000_000_000; // åŠ ä¸‹åˆ’çº¿æ›´å®¹æ˜“è¯†åˆ« int i4 = 0xff0000; // åå…­è¿›åˆ¶è¡¨ç¤ºçš„16711680 int i5 = 0b1000000000; // äºŒè¿›åˆ¶è¡¨ç¤ºçš„512 long n1 = 9000000000000000000L; // longå‹çš„ç»“å°¾éœ€è¦åŠ L long n2 = 900; // æ²¡æœ‰åŠ Lï¼Œæ­¤å¤„900ä¸ºintï¼Œä½†intç±»å‹å¯ä»¥èµ‹å€¼ç»™long int i6 = 900L; // é”™è¯¯ï¼šä¸èƒ½æŠŠlongå‹èµ‹å€¼ç»™int float f1 = 3.14f; float f2 = 3.14e38f; // ç§‘å­¦è®¡æ•°æ³•è¡¨ç¤ºçš„3.14x10^38 float f3 = 1.0; // é”™è¯¯ï¼šä¸å¸¦fç»“å°¾çš„æ˜¯doubleç±»å‹ï¼Œä¸èƒ½èµ‹å€¼ç»™float double d = 1.79e308; double d2 = -1.79e308; double d3 = 4.9e-324; // ç§‘å­¦è®¡æ•°æ³•è¡¨ç¤ºçš„4.9x10^-324 boolean b1 = true; boolean b2 = false; boolean isGreater = 5 \u003e 3; // è®¡ç®—ç»“æœä¸ºtrue int age = 12; boolean isAdult = age \u003e= 18; // è®¡ç®—ç»“æœä¸ºfalse final double PI = 3.14; // PIæ˜¯ä¸€ä¸ªå¸¸é‡ double r = 5.0; double area = PI * r * r; var sb = new StringBuilder(); String s = \"hello\"; final double PI = 3.14; // PIæ˜¯ä¸€ä¸ªå¸¸é‡ // åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡ Pet dog = new Pet(); // åˆå§‹åŒ–ä¸€ä¸ªæ•°ç»„ int[] arr = new int[10]; String wepublic = \"github\"; String wepublic = new String(); String wepublic = new String(\"github\"); public class RunoobTest { // æˆå‘˜å˜é‡ private int instanceVar; // é™æ€å˜é‡ private static int staticVar; public void method(int paramVar) { // å±€éƒ¨å˜é‡ int localVar = 10; // ä½¿ç”¨å˜é‡ instanceVar = localVar; staticVar = paramVar; System.out.println(\"æˆå‘˜å˜é‡: \" + instanceVar); System.out.println(\"é™æ€å˜é‡: \" + staticVar); System.out.println(\"å‚æ•°å˜é‡: \" + paramVar); System.out.println(\"å±€éƒ¨å˜é‡: \" + localVar); } public static void main(String[] args) { RunoobTest v = new RunoobTest(); v.method(20); } } ä¸‰å…ƒè¿ç®— public class Main { public static void main(String[] args) { int n = -100; int x = n \u003e= 0 ? n : -n; System.out.println(x); } } æ•°ç»„ public class Main { public static void main(String[] args) { // 5ä½åŒå­¦çš„æˆç»©: int[] ns; ns = new int[] { 68, 79, 91, 85, 62 }; System.out.println(ns.length); // 5 ns = new int[] { 1, 2, 3 }; System.out.println(ns.length); // 3 } } æµç¨‹æ§åˆ¶ public class Main { public static void main(String[] args) { System.out.print(\"A,\"); System.out.print(\"B,\"); System.out.println(\"END\"); } } // æ ¼å¼åŒ–è¾“å‡º public class Main { public static void main(String[] args) { double d = 3.1415926; System.out.printf(\"%.2f\\n\", d); // æ˜¾ç¤ºä¸¤ä½å°æ•°3.14 System.out.printf(\"%.4f\\n\", d); // æ˜¾ç¤º4ä½å°æ•°3.1416 } } // è¾“å…¥ import java.util.Scanner; public class Main { public static void main(String[] args) { Scanner scanner = new Scanner(System.in); // åˆ›å»ºScannerå¯¹è±¡ System.out.print(\"Input your name: \"); // æ‰“å°æç¤º String name = scanner.nextLine(); // è¯»å–ä¸€è¡Œè¾“å…¥å¹¶è·å–å­—ç¬¦ä¸² System.out.print(\"Input your age: \"); // æ‰“å°æç¤º int age = scanner.nextInt(); // è¯»å–ä¸€è¡Œè¾“å…¥å¹¶è·å–æ•´æ•° System.out.printf(\"Hi, %s, you are %d\\n\", name, age); // æ ¼å¼åŒ–è¾“å‡º } } // if public class Main { public static void main(String[] args) { int n = 70; if (n \u003e= 60) { System.out.println(\"åŠæ ¼äº†\"); } else { System.out.println(\"æŒ‚ç§‘äº†\"); } System.out.println(\"END\"); } } // switch // switch public class Main { public static void main(String[] args) { int option = 1; switch (option) { case 1: System.out.println(\"Selected 1\"); break; case 2: System.out.println(\"Selected 2\"); break; case 3: System.out.println(\"Selected 3\"); break; } switch (grade / 10) { case 10,9 -\u003e System.out.println(\"è¯¥å­¦ç”Ÿæˆç»©ä¼˜ç§€\"); case 8 -\u003e System.out.println(\"è¯¥å­¦ç”Ÿæˆç»©è‰¯å¥½\"); case 7 -\u003e System.out.println(\"è¯¥å­¦ç”Ÿæˆç»©ä¸­ç­‰\"); case 6 -\u003e System.out.println(\"è¯¥å­¦ç”Ÿæˆç»©åŸºæœ¬åˆæ ¼\"); default -\u003e System.out.println(\"è¯¥å­¦ç”Ÿæˆç»©ä¸åˆæ ¼\"); } } // while public class Main { public static void main(String[] args) { int sum = 0; int m = 20; int n = 100; // ä½¿ç”¨whileè®¡ç®—M+...+N: while (false) { } System.out.println(sum); } } // do-while public class Main { public static void main(String[] args) { int sum = 0; int n = 1; do { sum = sum + n; n ++; } while (n \u003c= 100); System.out.println(sum); } } // for public class Main { public static void main(String[] args) { int sum = 0; for (int i=1; i\u003c=100; i++) { sum = sum + i; } System.out.print","date":"2024-10-26","objectID":"/posts/2024-10-26-java/:2:0","tags":["Java"],"title":"Java Basic","uri":"/posts/2024-10-26-java/"},{"categories":["Ubuntu è‡ªåŠ¨å®‰è£…"],"content":"cloud-init https://hmli.ustc.edu.cn/doc/linux/ubuntu-autoinstall/ubuntu-autoinstall.html ubuntu å®‰è£…åè·å–å½“å‰çš„user-data: /var/log/installer/autoinstall-user-data ç¤ºä¾‹ï¼š #cloud-config autoinstall: version: 1 apt: disable_components: [] fallback: offline-install geoip: true mirror-selection: primary: - uri: http://mirrors.ustc.edu.cn/ubuntu-ports - country-mirror - arches: \u0026id001 - amd64 - i386 uri: http://mirrors.ustc.edu.cn/ubuntu/ - arches: \u0026id002 - s390x - arm64 - armhf - powerpc - ppc64el - riscv64 uri: http://mirrors.ustc.edu.cn/ubuntu-ports preserve_sources_list: false security: - arches: *id001 uri: http://mirrors.ustc.edu.cn/ubuntu/ - arches: *id002 uri: http://mirrors.ustc.edu.cn/ubuntu-ports codecs: install: false drivers: install: false identity: hostname: localhost password: $6$4DsNTlBjlChIXq/O$AgJbtZDu4g50qcDjx5NUjgkSen2nNsOVo/aeo7U5On8NpqHEquCVFCjlmjlVBCVCs6prGev8TYlZG/FDUjKd.. realname: sugar username: sugar kernel: package: linux-generic keyboard: layout: us toggle: null variant: '' locale: en_US.UTF-8 user-data: timezone: Asia/Shanghai # disable_root: false network: version: 2 ethernets: eth: match: name: \"en*\" dhcp4: yes packages: - net-tools - vim oem: install: auto source: id: ubuntu-server-minimal search_drivers: false ssh: allow-pw: true authorized-keys: [] install-server: true storage: layout: name: lvm updates: security late-commands: - echo 'sugar ALL=(ALL) NOPASSWD:ALL' \u003e /target/etc/sudoers.d/sugar ","date":"2024-10-26","objectID":"/posts/2024-10-26-ubuntu-cloud-init/:0:0","tags":["vm","ubuntu"],"title":"Ubuntu cloud-init","uri":"/posts/2024-10-26-ubuntu-cloud-init/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go conc å‚è€ƒé“¾æ¥ https://www.liwenzhou.com/posts/Go/conc/ go package main import ( \"fmt\" \"time\" ) func main() { for i := 0; i \u003c 5; i++ { go func(num int) { fmt.Println(num) }(i) } time.Sleep(5 * time.Second) } sync.WaitGroup æ§åˆ¶å¹¶å‘ package main import ( \"fmt\" \"sync\" ) var wg sync.WaitGroup func hello(i int) { defer wg.Done() fmt.Println(\"Hello Goroutine!\", i) } func main() { for i := 0; i \u003c 10; i++ { wg.Add(1) go hello(i) } wg.Wait() } conc å¹¶å‘åº“ ä¼˜ç‚¹ï¼š å°è£…äº†å®˜æ–¹åº“çš„wg.Addå’Œwg.Doneï¼Œç®€åŒ–äº†ä»£ç  å®˜æ–¹åº“éœ€è¦æ‰‹åŠ¨å®ç°recoverï¼Œconc å†…éƒ¨å°è£…å¥½äº† package main import ( \"fmt\" \"github.com/sourcegraph/conc\" ) func main() { wg := conc.NewWaitGroup() for i := 0; i \u003c 10; i++ { wg.Go(doSomething) } wg.Wait() } func doSomething() { fmt.Println(\"test\") } å¹¶å‘æ± é™åˆ¶ package main import ( \"fmt\" \"github.com/sourcegraph/conc/pool\" ) func main() { p := pool.New().WithMaxGoroutines(3) for i := 1; i \u003c= 5; i++ { p.Go(func() { fmt.Println(i) }) } p.Wait() } package main import ( \"context\" \"errors\" \"fmt\" \"github.com/sourcegraph/conc/pool\" ) func main() { p := pool.New(). WithMaxGoroutines(4). WithContext(context.Background()). WithCancelOnError() for i := 0; i \u003c 3; i++ { i := i p.Go(func(ctx context.Context) error { if i == 2 { return errors.New(\"I will cancel all other tasks!\") } \u003c-ctx.Done() return nil }) } err := p.Wait() fmt.Println(err) // Output: // I will cancel all other tasks! } ","date":"2024-10-20","objectID":"/posts/2024-10-20-go-conc/:0:0","tags":["Go","conc"],"title":"Go conc","uri":"/posts/2024-10-20-go-conc/"},{"categories":["DevOps"],"content":"CloudBeaver web ç‰ˆ DBeaver docker-compose å®‰è£… version: \"3\" services: cloudbeaver: image: dbeaver/cloudbeaver:24 container_name: cloudbeaver restart: always ports: - \"8978:8978\" volumes: - \"/data/cloudbeaver:/opt/cloudbeaver/workspace\" networks: - app networks: app: # ä½¿ç”¨å¤–éƒ¨å…±äº«ç­‰ç½‘å¡ external: true terraform kubernetes https://github.com/serialt/terraform-module-cloudbeaver ","date":"2024-10-11","objectID":"/posts/2024-10-11-cloudbeaver/:1:0","tags":["redis"],"title":"CloudBeaver","uri":"/posts/2024-10-11-cloudbeaver/"},{"categories":["Dev"],"content":"ä¸€ã€Helloworld sanic å®‰è£… python3 -m venv venv . venv/bin/activate pip3 install sanic helloworld from sanic import Sanic from sanic import text app = Sanic(\"Myapp\") @app.route(\"/\") async def test(request): return response.text('Hello World') if __name__ == '__main__': app.run(host=\"0.0.0.0\", port=7777) vscode debug { \"version\": \"0.2.0\", \"configurations\": [ { \"name\": \"Python Debugger: Current File\", \"type\": \"debugpy\", \"request\": \"launch\", \"python\": \"${workspaceFolder}/venv/bin/python3\", \"program\": \"main.py\", // \"args\": [ // \"-nu\" // \"-ro\" // ], // \"console\": \"integratedTerminal\", \"console\": \"internalConsole\", } ] } [root@Krab sanic]ğŸ³ curl 127.0.0.1:7777 Hello World Sanic æ„å»ºä¸€ä¸ªSanicæœåŠ¡çš„å®ä¾‹ name=None æœåŠ¡åã€‚é€šå¸¸å¯ä»¥ç”¨__name__é¢„ç½®å˜é‡ï¼Œå¦‚æœnameä¸ºNoneï¼Œåˆ™ä»ä¹‹å‰æ ˆä¸­è·å¾—module nameã€‚ route() è·¯ç”±è£…é¥°å™¨ï¼Œæ³¨å†Œä¸€ä¸ªè·¯ç”± uri URLè·¯å¾„ ","date":"2024-09-17","objectID":"/posts/2024-09-17-sanic/:0:1","tags":["Sanic"],"title":"sanic","uri":"/posts/2024-09-17-sanic/"},{"categories":["Dev"],"content":"äºŒã€Dev 1ã€è·¯ç”± ç”¨æˆ·å¯ä»¥é€šè¿‡è·¯ç”±æ¥è®¾ç½®URLä¸handlerä¹‹é—´çš„å…³è”ã€‚ä¸€ä¸ªåŸºæœ¬çš„è·¯ç”±å½¢å¼å¦‚ä¸‹ï¼š from sanic import response @app.route(\"/\") async def test(request): return response.text('Hello World') sanicçš„handleræ–¹æ³•å¿…é¡»ç”¨asyncå…³é”®å­—å®šä¹‰ä¸ºå¼‚æ­¥æ–¹æ³•ã€‚ Requestå‚æ•° from sanic.response import text # ï¿½å‚æ•°å: tagï¼Œå¯ä»¥æ˜¯ä»»æ„å­—ç¬¦ @app.route('/tag/\u003ctag\u003e') async def tag_handler(request, tag): return text('Tag - {}'.format(tag)) # å‚æ•°å: integer_argï¼Œintç±»å‹ @app.route('/number/\u003cinteger_arg:int\u003e') async def integer_handler(request, integer_arg): return text('Integer - {}'.format(integer_arg)) @app.route('/number/\u003cnumber_arg:number\u003e') async def number_handler(request, number_arg): return text('Number - {}'.format(number_arg)) # å‚æ•°å: nameï¼Œè‹±æ–‡å­—æ¯ @app.route('/person/\u003cname:[A-z]+\u003e') async def person_handler(request, name): return text('Person - {}'.format(name)) # å‚æ•°å: folder_idï¼Œè‹±æ–‡å­—æ¯+æ•°å­—ï¼Œ0~4ä¸ªå­—ç¬¦é•¿åº¦ @app.route('/folder/\u003cfolder_id:[A-z0-9]{0,4}\u003e') async def folder_handler(request, folder_id): return text('Folder - {}'.format(folder_id)) HTTP è¯·æ±‚ç±»å‹ é»˜è®¤è¯·æ±‚ç±»å‹æ˜¯GETï¼Œå¦‚æœç”¨å…¶å®ƒæ–¹æ³•ï¼Œéœ€è¦å•ç‹¬æŒ‡å®šã€‚ from sanic.response import text # postæ–¹æ³• @app.route('/post', methods=['POST']) async def post_handler(request): return text('POST request - {}'.format(request.json)) # getæ–¹æ³• @app.route('/get') async def get_handler(request): return text('GET request - {}'.format(request.args)) @app.route('/get', methods=['GET']) async def get_handler(request): return text('GET request - {}'.format(request.args)) Request å½“æœåŠ¡ç«¯æ”¶åˆ°HTTPè¯·æ±‚æ—¶ï¼Œè·¯ç”±æ–¹æ³•ä¼šä¼ è¿‡æ¥Requestå¯¹è±¡ã€‚Requestå¯¹è±¡åŒ…å«ä»¥ä¸‹å±æ€§ï¼š json JSONæ­£æ–‡ã€‚ from sanic.response import json @app.route(\"/json\") def post_json(request): return json({ \"received\": True, \"message\": request.json }) args dictï¼Œä¾‹å¦‚è¯·æ±‚å‚æ•°ä¸º?key1=value1\u0026key2=value2ï¼Œè¿”å›{'key1': ['value1'], 'key2': ['value2']} raw_args dictï¼Œæ›´å°‘å°è£…çš„dictï¼Œå¾ˆå¤šæ—¶å€™æ¯”argsè¿˜å®ç”¨ã€‚ä¾‹å¦‚è¯·æ±‚å‚æ•°ä¸º?key1=value1\u0026key2=value2ï¼Œè¿”å›{'key1': 'value1', 'key2': 'value2'} headers dictï¼Œä¸€ä¸ªå¤§å°å†™æ— å…³ï¼ˆä¸€èˆ¬éƒ½æ˜¯å°å†™ï¼‰çš„dictï¼ŒåŒ…å«request headerã€‚ å…¶å®ƒå¸¸ç”¨å±æ€§è¿˜åŒ…æ‹¬ï¼šip, port, url, host, path, quary_string Response ä½¿ç”¨sanic.responseæ¨¡å—åˆ›å»ºresponseã€‚ json from sanic import response @app.route('/json') def handle_request(request): return response.json({ 'message': 'Hello world!', # header headers={'X-Served-By': 'sanic'}, # status status=200}) redirect from sanic import response @app.route('/redirect') def handle_request(request): return response.redirect('/json') ","date":"2024-09-17","objectID":"/posts/2024-09-17-sanic/:0:2","tags":["Sanic"],"title":"sanic","uri":"/posts/2024-09-17-sanic/"},{"categories":["Gorm","DevOps"],"content":"Gorm Gen å‚è€ƒé“¾æ¥ï¼šhttps://www.liwenzhou.com/posts/Go/gen/ Genæ˜¯ä¸€ä¸ªåŸºäºGORMçš„å®‰å…¨ORMæ¡†æ¶ï¼Œå…¶ä¸»è¦é€šè¿‡ä»£ç ç”Ÿæˆæ–¹å¼å®ç°GORMä»£ç å°è£…ã€‚ä½¿ç”¨Genæ¡†æ¶èƒ½å¤Ÿè‡ªåŠ¨ç”ŸæˆModelç»“æ„ä½“å’Œç±»å‹å®‰å…¨çš„CRUDä»£ç ï¼Œæå¤§æå‡CRUDæ•ˆç‡ã€‚ ","date":"2024-09-09","objectID":"/posts/2024-09-09-gorm-gen/:1:0","tags":["gorm"],"title":"Gorm Gen","uri":"/posts/2024-09-09-gorm-gen/"},{"categories":["Gorm","DevOps"],"content":"ä»‹ç» Genæ˜¯ç”±å­—èŠ‚è·³åŠ¨æ— æ’å®éªŒå®¤ä¸GORMä½œè€…è”åˆç ”å‘çš„ä¸€ä¸ªåŸºäºGORMçš„å®‰å…¨ORMæ¡†æ¶ï¼Œä¸»è¦é€šè¿‡ä»£ç ç”Ÿæˆæ–¹å¼å®ç°GORMä»£ç å°è£…ã€‚ Genæ¡†æ¶åœ¨GORMæ¡†æ¶çš„åŸºç¡€ä¸Šæä¾›äº†ä»¥ä¸‹èƒ½åŠ›ï¼š åŸºäºåŸå§‹SQLè¯­å¥ç”Ÿæˆå¯é‡ç”¨çš„CRUD API ç”Ÿæˆä¸ä½¿ç”¨interface{}çš„100%å®‰å…¨çš„DAO API ä¾æ®æ•°æ®åº“ç”Ÿæˆéµå¾ªGORMçº¦å®šçš„ç»“æ„ä½“Model æ”¯æŒGORMçš„æ‰€æœ‰ç‰¹æ€§ ç®€å•æ¥è¯´ï¼Œä½¿ç”¨Genæ¡†æ¶åæˆ‘ä»¬æ— éœ€æ‰‹åŠ¨å®šä¹‰ç»“æ„ä½“Modelï¼ŒåŒæ—¶Genæ¡†æ¶ä¹Ÿèƒ½å¸®æˆ‘ä»¬ç”Ÿæˆç±»å‹å®‰å…¨çš„CRUDä»£ç ã€‚ æ›´å¤šè¯¦ç»†ä»‹ç»è¯·æŸ¥çœ‹Genå®˜æ–¹æ–‡æ¡£ã€‚ æ­¤å¤–ï¼ŒFacebookå¼€æºçš„entä¹Ÿæ˜¯ç¤¾åŒºä¸­å¸¸ç”¨çš„ç±»ä¼¼æ¡†æ¶ï¼Œå¤§å®¶å¯æŒ‰éœ€é€‰æ‹©ä½¿ç”¨ã€‚ ","date":"2024-09-09","objectID":"/posts/2024-09-09-gorm-gen/:1:1","tags":["gorm"],"title":"Gorm Gen","uri":"/posts/2024-09-09-gorm-gen/"},{"categories":["Gorm","DevOps"],"content":"ä½¿ç”¨ go get grom.io/gen const DSN = \"postgres://user:password@127.0.0.1:5432/hello?sslmode=disable\u0026TimeZone=Asia/Shanghai\u0026search_path=public\" func connectDB(dsn string) *gorm.DB { db, err := gorm.Open(postgres.Open(dsn)) if err != nil { panic(fmt.Errorf(\"connect db fail: %w\", err)) } return db } func main() { // æŒ‡å®šç”Ÿæˆä»£ç çš„å…·ä½“ç›¸å¯¹ç›®å½•(ç›¸å¯¹å½“å‰æ–‡ä»¶)ï¼Œé»˜è®¤ä¸ºï¼š./query // é»˜è®¤ç”Ÿæˆéœ€è¦ä½¿ç”¨WithContextä¹‹åæ‰å¯ä»¥æŸ¥è¯¢çš„ä»£ç ï¼Œä½†å¯ä»¥é€šè¿‡è®¾ç½®gen.WithoutContextç¦ç”¨è¯¥æ¨¡å¼ g := gen.NewGenerator(gen.Config{ // é»˜è®¤ä¼šåœ¨ OutPath ç›®å½•ç”ŸæˆCRUDä»£ç ï¼Œå¹¶ä¸”åŒç›®å½•ä¸‹ç”Ÿæˆ model åŒ… // æ‰€ä»¥OutPathæœ€ç»ˆpackageä¸èƒ½è®¾ç½®ä¸ºmodelï¼Œåœ¨æœ‰æ•°æ®åº“è¡¨åŒæ­¥çš„æƒ…å†µä¸‹ä¼šäº§ç”Ÿå†²çª // è‹¥ä¸€å®šè¦ä½¿ç”¨å¯ä»¥é€šè¿‡ModelPkgPathå•ç‹¬æŒ‡å®šmodel packageçš„åç§° OutPath: \"data/query\", ModelPkgPath: \"data/model\", // ç”Ÿæˆ gorm æ ‡ç­¾çš„å­—æ®µç±»å‹å±æ€§ FieldWithTypeTag: true, // è¡¨å­—æ®µå¯ä¸º null å€¼æ—¶, å¯¹åº”ç»“ä½“å­—æ®µä½¿ç”¨æŒ‡é’ˆç±»å‹ FieldNullable: true, // gen.WithoutContextï¼šç¦ç”¨WithContextæ¨¡å¼ // gen.WithDefaultQueryï¼šç”Ÿæˆä¸€ä¸ªå…¨å±€Queryå¯¹è±¡Q // gen.WithQueryInterfaceï¼šç”ŸæˆQueryæ¥å£ Mode: gen.WithDefaultQuery, }) // é€šå¸¸å¤ç”¨é¡¹ç›®ä¸­å·²æœ‰çš„SQLè¿æ¥é…ç½®db(*gorm.DB) // éå¿…éœ€ï¼Œä½†å¦‚æœéœ€è¦å¤ç”¨è¿æ¥æ—¶çš„gorm.Configæˆ–éœ€è¦è¿æ¥æ•°æ®åº“åŒæ­¥è¡¨ä¿¡æ¯åˆ™å¿…é¡»è®¾ç½® g.UseDB(connectDB(DSN)) // ä»è¿æ¥çš„æ•°æ®åº“ä¸ºæ‰€æœ‰è¡¨ç”ŸæˆModelç»“æ„ä½“å’ŒCRUDä»£ç  // ä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šéœ€è¦ç”Ÿæˆä»£ç çš„æ•°æ®è¡¨ dataTypeMap := map[string]func(gorm.ColumnType) (dataType string){ \"numeric\": func(columnType gorm.ColumnType) string { return \"decimal.Decimal\" }, \"int4\": func(columnType gorm.ColumnType) string { return \"int64\" }, \"int2\": func(columnType gorm.ColumnType) string { return \"int64\" }, \"serial4\": func(columnType gorm.ColumnType) string { return \"int64\" }, } g.WithDataTypeMap(dataTypeMap) g.ApplyBasic(g.GenerateAllTable()...) // æ‰§è¡Œå¹¶ç”Ÿæˆä»£ç  g.Execute() è¡¨å…³è” // foreignKey: action è¡¨ä¸­çš„å­—æ®µ,actionè¡¨ä¸­çš„id // references: userè¡¨ä¸­çš„å­—æ®µï¼Œuserè¡¨ä¸­çš„ action_id action := g.GenerateModel(\"action\") user := g.GenerateModel(\"user\", gen.FieldRelate(field.HasMany, \"actions\", action, \u0026field.RelateConfig{ RelateSlicePointer: true, GORMTag: field.GormTag{ \"references\": []string{ \"ActionID\", }, \"foreignKey\": []string{ \"ID\", }, }, }, ), ) people := g.GenerateModel(\"people\", gen.FieldRelate(field.HasOne, \"Type\", peopleType, \u0026field.RelateConfig{ RelatePointer: true, GORMTag: \"references:TypeID;foreignKey:ID\", }, )) åŸºäºç´¢å¼•çš„æƒ…å†µä¸‹æ‰¹é‡æ›´æ–°æˆ–è€…æ–°å¢ err = user.WithContext(ctx).Clauses( clause.OnConflict{ Columns: []clause.Column{ {Name: user.Code.ColumnName().String()}, }, TargetWhere: clause.Where{ Exprs: []clause.Expression{ clause.Expr{ SQL: \"deleted_at is null\", }, }, }, DoUpdates: clause.AssignmentColumns(cols), }, ). CreateInBatches(items, 30) è¡¨è®¾è®¡ä¼˜åŒ–ï¼Œè¿™æ ·åªæœ‰å½“deleted_atä¸ºnullçš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘codeçš„å”¯ä¸€æ€§æ ¡éªŒ create unique index pa_code on pa (code) where deleted_at is null; åˆ†é¡µ if cond.Page == 0 { cond.Page = 1 } if cond.Size == 0 { cond.Size = 20 } items, count, err = do.FindByPage(int((cond.Page-1)*cond.Size), int(cond.Size)) æ ¹æ®ä¼ å…¥çš„å­—æ®µæŸ¥è¯¢ func (u *UserRepo) GetUserListOption(ctx context.Context, db *gorm.DB, items []field.Expr) (data []*model.User, err error) { mm := query.Use(db).User data, err = mm.WithContext(ctx).Debug().Distinct().Select(items...).Find() return } or æ¡ä»¶æ‹¼æ¥ func (u *UserRepo) GetRoleOptionV2(ctx context.Context, db *gorm.DB) (items []*model.Role, err error) { mm := query.Use(db).Role bb := mm.WithContext(ctx) cc := bb.Where(mm.ID.Eq(0)) items, err = cc.Where(mm.Name.Eq(\"aaa\")).Where(bb.Where(mm.Code.Eq(\"aaa\")).Or(mm.Status.Eq(1))).Debug().Find() return } SELECT * FROM \"role\" WHERE \"role\".\"id\" = 0 AND \"role\".\"name\" = 'aaa' AND (\"role\".\"code\" = 'aaa' OR \"role\".\"status\" = 1) AND \"role\".\"deleted_at\" IS NULL pgæ•°ç»„å­—æ®µæŸ¥è¯¢ import \"github.com/lib/pq\" type Product struct { ID uint Name string TagIDs pq.Int64Array `gorm:\"type:bigint[]\"` } var products []*Product // æŸ¥è¯¢ db.UnderlyingDB(\"tag_ids @\u003e ?\", pq.Int64Array{1001}).Find(\u0026products) tx.UnderlyingDB().Where(\"name @\u003e ?\", fmt.Sprintf(`[\"%s\"]`, \"aaaa\")) do.UnderlyingDB().Where(fmt.Sprintf(\"shortname ILIKE ANY (ARRAY[%s])\", keyword)) ","date":"2024-09-09","objectID":"/posts/2024-09-09-gorm-gen/:1:2","tags":["gorm"],"title":"Gorm Gen","uri":"/posts/2024-09-09-gorm-gen/"},{"categories":["vscode","DevOps"],"content":"Debug In VSCode ","date":"2024-09-08","objectID":"/posts/2024-09-08-vscode-debug/:0:0","tags":["debug"],"title":"Debug in VSCode","uri":"/posts/2024-09-08-vscode-debug/"},{"categories":["vscode","DevOps"],"content":"ä¸€ã€GO ","date":"2024-09-08","objectID":"/posts/2024-09-08-vscode-debug/:1:0","tags":["debug"],"title":"Debug in VSCode","uri":"/posts/2024-09-08-vscode-debug/"},{"categories":["vscode","DevOps"],"content":"1ã€å®‰è£…æ’ä»¶ï¼š golang.go r3inbowari.gomodexplorer å®‰è£…go debugç›¸å…³ç»„ä»¶ command + shift + p â€“\u003e go install â€“\u003e å‹¾é€‰æ‰€æœ‰è¿›è¡Œå®‰è£… ","date":"2024-09-08","objectID":"/posts/2024-09-08-vscode-debug/:1:1","tags":["debug"],"title":"Debug in VSCode","uri":"/posts/2024-09-08-vscode-debug/"},{"categories":["vscode","DevOps"],"content":"2ã€lanuch.json { // ä½¿ç”¨ IntelliSense äº†è§£ç›¸å…³å±æ€§ã€‚ // æ‚¬åœä»¥æŸ¥çœ‹ç°æœ‰å±æ€§çš„æè¿°ã€‚ // æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®: https://go.microsoft.com/fwlink/?linkid=830387 \"version\": \"0.2.0\", \"configurations\": [ { \"name\": \"Launch Package\", \"type\": \"go\", \"request\": \"launch\", \"mode\": \"auto\", \"program\": \"${workspaceFolder}/\", \"cwd\": \"${workspaceFolder}\", \"env\": { \"http_proxy\": \"http://127.0.0.1:8888\", \"DEST_HUB_USERNAME\": \"github\", \"DEST_HUB_PASSWORD\": \"github\", }, \"args\": [ \"-c\", \"config.yaml\" ] }, { \"name\": \"Launch test function\", \"type\": \"go\", \"request\": \"launch\", \"mode\": \"test\", \"program\": \"${fileDirname}\", \"showLog\": true, \"args\": [ \"-test.v\", \"-test.run\", \"Test_f1\" ], \"dlvFlags\": [ \"--check-go-version=false\" ], \"dlvLoadConfig\": { \"followPointers\": true, \"maxVariableRecurse\": 1, \"maxStringLen\": 512, \"maxArrayValues\": 64, \"maxStructFields\": -1 } }, ] } ","date":"2024-09-08","objectID":"/posts/2024-09-08-vscode-debug/:1:2","tags":["debug"],"title":"Debug in VSCode","uri":"/posts/2024-09-08-vscode-debug/"},{"categories":["vscode","DevOps"],"content":"äºŒã€python æ’ä»¶ï¼š ms-python.python ms-python.debugpy donjayamanne.python-environment-manager mgesbert.python-path wolfieshorizon.python-auto-venv ms-python.autopep8 launch.json { \"version\": \"0.2.0\", \"configurations\": [ { \"name\": \"Python\", \"type\": \"debugpy\", \"request\": \"launch\", \"python\": \"${workspaceFolder}/venv/bin/python3\", \"program\": \"${file}\", \"cwd\": \"${workspaceRoot}\", \"env\": {}, \"envFile\": \"${workspaceRoot}/.env\", \"console\": \"internalConsole\", \"debugOptions\": [ \"WaitOnAbnormalExit\", \"WaitOnNormalExit\", \"RedirectOutput\" ] } ] } ","date":"2024-09-08","objectID":"/posts/2024-09-08-vscode-debug/:2:0","tags":["debug"],"title":"Debug in VSCode","uri":"/posts/2024-09-08-vscode-debug/"},{"categories":["vscode","DevOps"],"content":"ä¸‰ã€Java æ’ä»¶ï¼š vscjava.vscode-java-pack vscjava.vscode-java-debug vscjava.vscode-maven vscjava.vscode-java-dependency vscjava.vscode-spring-initializr redhat.java launch.json { \"version\": \"0.2.0\", \"configurations\": [ { \"type\": \"java\", \"name\": \"DemoApplication\", \"request\": \"launch\", \"mainClass\": \"io.local.demo.DemoApplication\", \"projectName\": \"demo\", \"console\": \"internalConsole\" } ] } ","date":"2024-09-08","objectID":"/posts/2024-09-08-vscode-debug/:3:0","tags":["debug"],"title":"Debug in VSCode","uri":"/posts/2024-09-08-vscode-debug/"},{"categories":["vscode","DevOps"],"content":"å››ã€bash 1ã€å®‰è£…æ’ä»¶ å®‰è£…bashdbæ’ä»¶ rogalmic.bash-debug 2ã€å¢åŠ ä¸€ä¸ªvscode launch.jsoné…ç½®æ–‡ä»¶ Select Debug -\u003e Add Configuration to add custom debug configuration ç¤ºä¾‹ï¼š { \"configurations\": [ { \"type\": \"bashdb\", \"request\": \"launch\", \"name\": \"Bash-Debug\", \"cwd\": \"${workspaceFolder}\", \"program\": \"${workspaceFolder}/ccc.sh\", \"args\": [] }, ] } å°±å¯ä»¥åƒdebugå…¶ä»–è¯­è¨€ä¸€æ ·è¿›è¡Œè°ƒè¯•shellè„šæœ¬ äº”ã€ç¯å¢ƒå˜é‡ ${userHome} ${workspaceFolder} ${file} å…­ã€task æ˜¾ç¤ºåœ¨çŠ¶æ€æ  æ’ä»¶ï¼šquzhen.tasks-button é…ç½®æ–‡ä»¶ï¼š.vscode/tasks.json { \"version\": \"2.0.0\", \"tasks\": [ { \"label\": \"ã€Œmvn installã€\", \"type\": \"shell\", \"icon\": { \"id\": \"debug-console\", \"tooltip\": \"Run mvn install\" }, \"command\": \"mvn install\", \"args\": [] } ] } 7ã€é…ç½®idea é£æ ¼çš„blame å®‰è£…æ’ä»¶ï¼šlkqm.gitblame-annotations settings.jsoné…ç½® { \"gitlens.blame.format\": \"${date} ${author|11-}\", \"gitlens.blame.dateFormat\": \"YYYY/MM/DD\", \"gitlens.blame.compact\": false, } ","date":"2024-09-08","objectID":"/posts/2024-09-08-vscode-debug/:4:0","tags":["debug"],"title":"Debug in VSCode","uri":"/posts/2024-09-08-vscode-debug/"},{"categories":["å®‰å…¨ä¿¡æ¯"],"content":"æ¼æ´ä¿¡æ¯ äº‘æœåŠ¡å•†å®‰å…¨æœåŠ¡å…¬å‘Š äº‘æœåŠ¡å•† é“¾æ¥ cveå®˜ç½‘ https://cve.mitre.org/ é˜¿é‡Œäº‘ https://help.aliyun.com/noticelist/9213612.html?spm=a2c4g.789004748.n2.3.cddb4c07NBt9Rl åä¸ºäº‘ https://www.huaweicloud.com/notice.securecenter.html è…¾è®¯äº‘ https://cloud.tencent.com/announce?categorys=21\u0026page=1 é˜¿é‡Œäº‘æ¼æ´æ•°æ®åº“ https://avd.aliyun.com/ å›½å®¶ä¿¡æ¯æ¼æ´åº“ http://www.cnnvd.org.cn/ å¸¸ç”¨è½¯ä»¶å®˜æ–¹å®‰å…¨å…¬å‘Šé“¾æ¥ åç§° é“¾æ¥ redis https://github.com/redis/redis/security nginx http://nginx.org/en/security_advisories.html httpd https://httpd.apache.org/security ","date":"2024-08-29","objectID":"/posts/2023-11-12-security-info/:1:0","tags":["security","cve"],"title":"security-info","uri":"/posts/2023-11-12-security-info/"},{"categories":["å®‰å…¨ä¿¡æ¯"],"content":"å®‰å…¨æœåŠ¡æ¨é€ github: https://github.com/zema1/watchvuln version: \"3\" services: watchvuln: image: zemal/watchvuln container_name: watchvuln hostname: watchvuln restart: always environment: DINGDING_ACCESS_TOKEN: cd316d9dxxxxxxxxxxxxxxxxxxxxxxx DINGDING_SECRET: SECa87a39xxxxxxxxxxxxxxxxxxxxxxxxxxxx LARK_ACCESS_TOKEN: 1ddfb805-xxxxxxxxxxxxxxxxxxxxxxxxxxxx LARK_SECRET: GUUKIrxxxxxxxxxxxxxxxxxxxxxxxxxxxx INTERVAL: 30m volumes: - \"/etc/localtime:/etc/localtime:ro\" ","date":"2024-08-29","objectID":"/posts/2023-11-12-security-info/:2:0","tags":["security","cve"],"title":"security-info","uri":"/posts/2023-11-12-security-info/"},{"categories":["DevOps"],"content":"KVM ","date":"2024-08-29","objectID":"/posts/2024-08-29-kvm.md/:1:0","tags":["kvm"],"title":"kvm","uri":"/posts/2024-08-29-kvm.md/"},{"categories":["DevOps"],"content":"virt-install å®‰è£…è™šæ‹Ÿæœº virt-install ç¤ºä¾‹ virt-install \\ --name=pc01 \\ --graphics vnc,listen=0.0.0.0,port=5901,keymap=en_us \\ --ram=1024 \\ --vcpus=1 \\ --disk path=/var/lib/libvirt/images/pc01.img,size=9,format=qcow2 \\ --bridge=virbr0 \\ --location=ftp://172.16.8.100/rhel6.6 \\ --extra-args=\"ks=ftp://172.16.8.100/rhel6.4.ks\" virt-install \\ --name=pc02 \\ --graphics vnc,listten=0.0.0.0,port=5920,keymap=en_us \\ --noautoconsole \\ --ram=1024 \\ --vcpus=1 \\ --disk path=/var/lib/libvirt/images/pc02.img,size=9,format=qcow2 \\ --bridge=virbr0 \\ --location=ftp://172.16.8.100/rhel6.4 \\ --extra-args=\"ks=ftp://172.16.8.100/rhel6.4.ks\" virt-install \\ --name=pc03 \\ --nographics \\ --ram=1024 \\ --vcpus=1 \\ --disk path=/var/lib/libvirt/images/pc03.img,size=9,format=qcow2 \\ --bridg=virbr0 --location=ftp://172.16.8.100/rhel6.4 \\ --extra-args=\"ks=ftp://172.16.8.100/rhel6.4.ks console=tty0 console=ttyS0\" # æŒ‰ ctrl + ] é€€å‡ºconsoleè¿æ¥ virt-install \\ --name=pc04_w2k8 \\ --graphics vnc,listen=0.0.0.0,port=5940,keymap=en_us \\ --ram=1024 \\ --vcpus=1 \\ --disk path=/imge/pc04.img,size=20 \\ --bridge=virbr0 \\ --cdrom=/var/ftp/linux/upload/iso/cn_windows_server_20008_r2.iso virt-install \\ --name=pc05_win2k8 \\ --memory 1024,maxmemory=2048 \\ --vcpus 1,maxvcpus=2 \\ --cdrom=/var/ftp/linux/upload/iso/cn_windows_server_2008_r2.iso \\ --network bridge=virbr0,model=virtio --disk path=/var/ftp/linux/software/kvm/virtio-win_amd64.vfd,device=floppy \\ --vnc \\ --vnclisten=0.0.0.0 \\ --vncport=5950 virt-install \\ --name=pc06 \\ --memory 512,maxmemory=1024 \\ --vcpus 1,maxvcpus=2 --cdrom=/var/ftp/linux/upload/iso/CentoS-7-x86_64-Everything-1511.iso \\ --network=virbr0 \\ --disk path=/var/lib/libvirt/images/pc06.img,size=9,format=qcow2 \\ --vnc \\ --vnclisten=0.0.0.0 \\ --vncport=5960 \\ --audostart virt-install \\ --connect qemu:///system \\ --virt-type kvm \\ --name=ubuntu \\ --memory 8192,maxmemory=16384 \\ --vcpus 1,maxvcpus=5 \\ --graphics vnc,listen=0.0.0.0,port=5901,keymap=en_us \\ --cdrom=/var/ftp/iso/ubuntu-18.04.4-server-amd64.iso \\ --disk path=/var/lib/libvirt/images/ubuntu.qcow2,size=15,format=qcow2 \\ --bridge=virbr0 \\ --os-type=linux \\ --audostart virt-install \\ --connect qemu:///system \\ --virt-type kvm --name=rocky86 \\ --memory 16300,maxmemory=16384 \\ --vcpus 8,maxvcpus=16 \\ --graphics vnc,listen=0.0.0.0,port=-1,keymap=en_us \\ --cdrom=/data/iso/Rocky-8.6-x86_64-minimal.iso \\ --disk path=/data/qemu/rocky86.qcow2,size=100,format=qcow2 \\ --bridge=br0 \\ --os-type=linux \\ --audostart ","date":"2024-08-29","objectID":"/posts/2024-08-29-kvm.md/:1:1","tags":["kvm"],"title":"kvm","uri":"/posts/2024-08-29-kvm.md/"},{"categories":["DevOps"],"content":"virt-installå‘½ä»¤è¯¦è§£ å‚è€ƒé“¾æ¥ï¼šhttps://www.cnblogs.com/saryli/p/11827903.html virt-installå‘½ä»¤ 1ï¼‰ä¸€èˆ¬é€‰é¡¹ï¼šæŒ‡å®šè™šæ‹Ÿæœºçš„åç§°ã€å†…å­˜å¤§å°ã€VCPUä¸ªæ•°åŠç‰¹æ€§ç­‰ -n NAME, --name=NAMEï¼šè™šæ‹Ÿæœºåç§°ï¼Œéœ€å…¨å±€æƒŸä¸€ï¼› -r MEMORY, --ram=MEMORYï¼šè™šæ‹Ÿæœºå†…åœ¨å¤§å°ï¼Œå•ä½ä¸ºMBï¼› --vcpus=VCPUS[,maxvcpus=MAX][,sockets=#][,cores=#][,threads=#]ï¼šVCPUä¸ªæ•°åŠç›¸å…³é…ç½®ï¼› --cpu=CPUï¼šCPUæ¨¡å¼åŠç‰¹æ€§ï¼Œå¦‚coreduoç­‰ï¼›å¯ä»¥ä½¿ç”¨qemu-kvm -cpu ?æ¥è·å–æ”¯æŒçš„CPUæ¨¡å¼ï¼› 2ï¼‰å®‰è£…æ–¹æ³•ï¼šæŒ‡å®šå®‰è£…æ–¹æ³•ã€GuestOSç±»å‹ç­‰ -c CDROM, --cdrom=CDROMï¼šå…‰ç›˜å®‰è£…ä»‹è´¨ï¼› -l LOCATION, --location=LOCATIONï¼šå®‰è£…æºURLï¼Œæ”¯æŒFTPã€HTTPåŠNFSç­‰ï¼Œå¦‚ftp://172.16.0.1/pubï¼› --pxeï¼šåŸºäºPXEå®Œæˆå®‰è£…ï¼› --livecdï¼šæŠŠå…‰ç›˜å½“ä½œLiveCDï¼› --os-type=DISTRO_TYPEï¼šæ“ä½œç³»ç»Ÿç±»å‹ï¼Œå¦‚linuxã€unixæˆ–windowsç­‰ï¼› --os-variant=DISTRO_VARIANTï¼šæŸç±»å‹æ“ä½œç³»ç»Ÿçš„å˜ä½“ï¼Œå¦‚rhel5ã€fedora8ã€debian10ç­‰ï¼› -x EXTRA, --extra-args=EXTRAï¼šæ ¹æ®--locationæŒ‡å®šçš„æ–¹å¼å®‰è£…GuestOSæ—¶ï¼Œç”¨äºä¼ é€’ç»™å†…æ ¸çš„é¢å¤–é€‰é¡¹ï¼Œä¾‹å¦‚æŒ‡å®škickstartæ–‡ä»¶çš„ä½ç½®ï¼Œ--extra-args \"ks=http://172.16.0.1/class.cfg\" --boot=BOOTOPTSï¼šæŒ‡å®šå®‰è£…è¿‡ç¨‹å®Œæˆåçš„é…ç½®é€‰é¡¹ï¼Œå¦‚æŒ‡å®šå¼•å¯¼è®¾å¤‡æ¬¡åºã€ä½¿ç”¨æŒ‡å®šçš„è€Œéå®‰è£…çš„kernel/initrdæ¥å¼•å¯¼ç³»ç»Ÿå¯åŠ¨ç­‰ ï¼› ä¾‹å¦‚ï¼š --boot cdrom,hd,networkï¼šæŒ‡å®šå¼•å¯¼æ¬¡åºï¼› --boot kernel=KERNEL,initrd=INITRD,kernel_args=â€console=/dev/ttyS0â€ï¼šæŒ‡å®šå¯åŠ¨ç³»ç»Ÿçš„å†…æ ¸åŠinitrdæ–‡ä»¶ï¼› 3ï¼‰å­˜å‚¨é…ç½®ï¼šæŒ‡å®šå­˜å‚¨ç±»å‹ã€ä½ç½®åŠå±æ€§ç­‰ -w NETWORK, --network=NETWORK,opt1=val1,opt2=val2ï¼šå°†è™šæ‹Ÿæœºè¿å…¥å®¿ä¸»æœºçš„ç½‘ç»œä¸­ï¼Œå…¶ä¸­NETWORKå¯ä»¥ä¸ºï¼š bridge=BRIDGEï¼šè¿æ¥è‡³åä¸ºâ€œBRIDEGâ€çš„æ¡¥è®¾å¤‡ï¼› network=NAMEï¼šè¿æ¥è‡³åä¸ºâ€œNAMEâ€çš„ç½‘ç»œï¼› 4ï¼‰å…¶å®ƒå¸¸ç”¨çš„é€‰é¡¹è¿˜æœ‰ï¼š modelï¼šGuestOSä¸­çœ‹åˆ°çš„ç½‘ç»œè®¾å¤‡å‹å·ï¼Œå¦‚e1000ã€rtl8139æˆ–virtioç­‰ï¼› `` ``macï¼šå›ºå®šçš„MACåœ°å€ï¼›çœç•¥æ­¤é€‰é¡¹æ—¶å°†ä½¿ç”¨éšæœºåœ°å€ï¼Œä½†æ— è®ºä½•ç§æ–¹å¼ï¼Œå¯¹äºKVMæ¥è¯´ï¼Œå…¶å‰ä¸‰æ®µå¿…é¡»ä¸º``52``:``54``:``00``ï¼› ``-``-``nonetworksï¼šè™šæ‹Ÿæœºä¸ä½¿ç”¨ç½‘ç»œåŠŸèƒ½ï¼› 5ï¼‰å›¾å½¢é…ç½®ï¼šå®šä¹‰è™šæ‹Ÿæœºæ˜¾ç¤ºåŠŸèƒ½ç›¸å…³çš„é…ç½®ï¼Œå¦‚VNCç›¸å…³é…ç½®ï¼› --graphics TYPE,opt1=val1,opt2=val2ï¼šæŒ‡å®šå›¾å½¢æ˜¾ç¤ºç›¸å…³çš„é…ç½®ï¼Œæ­¤é€‰é¡¹ä¸ä¼šé…ç½®ä»»ä½•æ˜¾ç¤ºç¡¬ä»¶ï¼ˆå¦‚æ˜¾å¡ï¼‰ï¼Œè€Œæ˜¯ä»…æŒ‡å®šè™šæ‹Ÿæœºå¯åŠ¨åå¯¹å…¶è¿›è¡Œè®¿é—®çš„æ¥å£ï¼› TYPEï¼šæŒ‡å®šæ˜¾ç¤ºç±»å‹ï¼Œå¯ä»¥ä¸ºvncã€sdlã€spiceæˆ–noneç­‰ï¼Œé»˜è®¤ä¸ºvncï¼› portï¼šTYPEä¸ºvncæˆ–spiceæ—¶å…¶ç›‘å¬çš„ç«¯å£ï¼› listenï¼šTYPEä¸ºvncæˆ–spiceæ—¶æ‰€ç›‘å¬çš„IPåœ°å€ï¼Œé»˜è®¤ä¸º127.0.0.1ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹/etc/libvirt/qemu.confå®šä¹‰æ–°çš„é»˜è®¤å€¼ï¼› passwordï¼šTYPEä¸ºvncæˆ–spiceæ—¶ï¼Œä¸ºè¿œç¨‹è®¿é—®ç›‘å¬çš„æœåŠ¡è¿›æŒ‡å®šè®¤è¯å¯†ç ï¼› --noautoconsoleï¼šç¦æ­¢è‡ªåŠ¨è¿æ¥è‡³è™šæ‹Ÿæœºçš„æ§åˆ¶å°ï¼› 6ï¼‰è®¾å¤‡é€‰é¡¹ï¼šæŒ‡å®šæ–‡æœ¬æ§åˆ¶å°ã€å£°éŸ³è®¾å¤‡ã€ä¸²è¡Œæ¥å£ã€å¹¶è¡Œæ¥å£ã€æ˜¾ç¤ºæ¥å£ç­‰ï¼› --serial=CHAROPTSï¼šé™„åŠ ä¸€ä¸ªä¸²è¡Œè®¾å¤‡è‡³å½“å‰è™šæ‹Ÿæœºï¼Œæ ¹æ®è®¾å¤‡ç±»å‹çš„ä¸åŒï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„é€‰é¡¹ï¼Œæ ¼å¼ä¸ºâ€œ--serial type,opt1=val1,opt2=val2,...â€ï¼Œä¾‹å¦‚ï¼š --serial ptyï¼šåˆ›å»ºä¼ªç»ˆç«¯ï¼› --serial dev,path=HOSTPATHï¼šé™„åŠ ä¸»æœºè®¾å¤‡è‡³æ­¤è™šæ‹Ÿæœºï¼› --video=VIDEOï¼šæŒ‡å®šæ˜¾å¡è®¾å¤‡æ¨¡å‹ï¼Œå¯ç”¨å–å€¼ä¸ºcirrusã€vgaã€qxlæˆ–vmvgaï¼› 7ï¼‰è™šæ‹ŸåŒ–å¹³å°ï¼šè™šæ‹ŸåŒ–æ¨¡å‹ï¼ˆhvmæˆ–paravirtï¼‰ã€æ¨¡æ‹Ÿçš„CPUå¹³å°ç±»å‹ã€æ¨¡æ‹Ÿçš„ä¸»æœºç±»å‹ã€hypervisorç±»å‹ï¼ˆå¦‚kvmã€xenæˆ–qemuç­‰ï¼‰ä»¥åŠå½“å‰è™šæ‹Ÿæœºçš„UUIDç­‰ï¼› 8ï¼‰å…¶å®ƒï¼š --autostartï¼šæŒ‡å®šè™šæ‹Ÿæœºæ˜¯å¦åœ¨ç‰©ç†å¯åŠ¨åè‡ªåŠ¨å¯åŠ¨ï¼› --print-xmlï¼šå¦‚æœè™šæ‹Ÿæœºä¸éœ€è¦å®‰è£…è¿‡ç¨‹(--importã€--boot)ï¼Œåˆ™æ˜¾ç¤ºç”Ÿæˆçš„XMLè€Œä¸æ˜¯åˆ›å»ºæ­¤è™šæ‹Ÿæœºï¼›é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤é€‰é¡¹ä»ä¼šåˆ›å»ºç£ç›˜æ˜ åƒï¼› --forceï¼šç¦æ­¢å‘½ä»¤è¿›å…¥äº¤äº’å¼æ¨¡å¼ï¼Œå¦‚æœæœ‰éœ€è¦å›ç­”yesæˆ–noé€‰é¡¹ï¼Œåˆ™è‡ªåŠ¨å›ç­”ä¸ºyesï¼› --dry-runï¼šæ‰§è¡Œåˆ›å»ºè™šæ‹Ÿæœºçš„æ•´ä¸ªè¿‡ç¨‹ï¼Œä½†ä¸çœŸæ­£åˆ›å»ºè™šæ‹Ÿæœºã€æ”¹å˜ä¸»æœºä¸Šçš„è®¾å¤‡é…ç½®ä¿¡æ¯åŠå°†å…¶åˆ›å»ºçš„éœ€æ±‚é€šçŸ¥ç»™libvirtï¼› -d, --debugï¼šæ˜¾ç¤ºdebugä¿¡æ¯ï¼› å°½ç®¡virt-installå‘½ä»¤æœ‰ç€ç±»ä¼¼ä¸Šè¿°çš„ä¼—å¤šé€‰é¡¹ï¼Œä½†å®é™…ä½¿ç”¨ä¸­ï¼Œå…¶å¿…é¡»æä¾›çš„é€‰é¡¹ä»…åŒ…æ‹¬â€“nameã€â€“ramã€â€“diskï¼ˆä¹Ÿå¯æ˜¯â€“nodisksï¼‰åŠå®‰è£…è¿‡ç¨‹ç›¸å…³çš„é€‰é¡¹ã€‚æ­¤å¤–ï¼Œæœ‰æ—¶è¿˜éœ€è¦ä½¿ç”¨æ‹¬â€“connect=CONNCTé€‰é¡¹æ¥æŒ‡å®šè¿æ¥è‡³ä¸€ä¸ªéé»˜è®¤çš„hypervisor ","date":"2024-08-29","objectID":"/posts/2024-08-29-kvm.md/:1:2","tags":["kvm"],"title":"kvm","uri":"/posts/2024-08-29-kvm.md/"},{"categories":["DevOps"],"content":"VM-CPUçƒ­æ·»åŠ  # æŸ¥çœ‹è™šæ‹Ÿæœºå½“å‰VCPU [root@ops-master ~]# virsh list Id Name State ---------------------------------------------------- 10 ops-test-1 running 14 jenkins-2 running 15 k8s-1 running [root@ops-master ~]# virsh dominfo jenkins-2 Id: 14 Name: jenkins-2 UUID: d96df8e5-9255-4d5a-9a5a-512ee07f71be OS Type: hvm State: running CPU(s): 1 CPU time: 116632.4s Max memory: 16777216 KiB Used memory: 8388608 KiB Persistent: yes Autostart: disable Managed save: no Security model: none Security DOI: 0 # --live ç«‹å³ç”Ÿæ•ˆï¼Œä¸ä¼šä¿å­˜åˆ°é…ç½®æ–‡ä»¶ [root@ops-master ~]# virsh setvcpus jenkins-2 4 --live [root@ops-master ~]# virsh dominfo jenkins-2 Id: 14 Name: jenkins-2 UUID: d96df8e5-9255-4d5a-9a5a-512ee07f71be OS Type: hvm State: running CPU(s): 4 CPU time: 116658.3s Max memory: 16777216 KiB Used memory: 8388608 KiB Persistent: yes Autostart: disable Managed save: no Security model: none Security DOI: 0 ","date":"2024-08-29","objectID":"/posts/2024-08-29-kvm.md/:1:3","tags":["kvm"],"title":"kvm","uri":"/posts/2024-08-29-kvm.md/"},{"categories":["DevOps"],"content":"ç¡¬ä»¶æ·»åŠ  [root@ops-master ~]# qemu-img create -f qcow2 /tmp/disk1.img 2G Formatting '/tmp/disk1.img', fmt=qcow2 size=2147483648 encryption=off cluster_size=65536 lazy_refcounts=off [root@ops-master ~]# [root@ops-master ~]# virsh attach-disk jenkins-2 --source /tmp/disk1.img --target vdb --cache writeback --subdriver qcow2 --persistent Disk attached successfully [root@ops-master ~]# virsh domblklist jenkins-2 Target Source ------------------------------------------------ hda /home/qemu/jenkins-2.qcow2 hdb - vdb /tmp/disk1.img ç£ç›˜è¯»å†™ç¼“å­˜æ¨¡å¼ï¼š writethrough é€šå†™ writeback å›å†™ # æ·»åŠ åˆ é™¤ç½‘å¡ virsh attach-interface robin-1 --type bridge --source virbr0 --persistent virsh detach-interface robin-1 --type bridge --mac 52:54:00:24:5b:73 --persistent ","date":"2024-08-29","objectID":"/posts/2024-08-29-kvm.md/:1:4","tags":["kvm"],"title":"kvm","uri":"/posts/2024-08-29-kvm.md/"},{"categories":["DevOps"],"content":"virsh ç®¡ç†è™šæ‹Ÿæœº Managing guest virtual machines with virsh éäº¤äº’æ¨¡å¼ äº¤äº’æ¨¡å¼ è¿æ¥å…¶å®ƒä¸»æœºçš„KVM [root@sugar ~]# virsh -c qemu:///system list [jack@sugar ~]$ virsh -c qemu+ssh://root@172.16.8.100/system å¯åŠ¨/åœæ­¢/å¼ºåˆ¶åœæ­¢/é‡å¯ [root@sugar ~]# virsh start node1 [root@sugar ~]# virsh shutdown node1 [root@sugar ~]# virsh destroy node1 [root@sugar ~]# virsh reboot node1 [root@sugar ~]# virsh domstate node1 Deleting guest vitual machine [root@sugar ~]# virsh destroy node1 [root@sugar ~]# virsh undefine node1 [root@sugar ~]# rm -rf /var/lib/libvirt/images/node1.img virsh start|net-start|pool-start sugar|mynet|mypool virsh autostart|net-autostart|pool-autostart sugar|mynet|mypool virsh edit|net-edit|pool-edit sugar|mynet|mypool virsh define|net-define|pool-define sugar.xml|mynet.xml|mypool.xml virsh undefine|net-undefine|pool-undefine sugar|mynet|mypool [root@sugar ~]# virsh --help |grep destroy destroy destroy (stop) a domain iface-destroy destroy a physical host interface (disable it / \"if-down\") net-destroy destroy (stop) a network nodedev-destroy destroy (stop) a device on the node pool-destroy destroy (stop) a pool ","date":"2024-08-29","objectID":"/posts/2024-08-29-kvm.md/:1:5","tags":["kvm"],"title":"kvm","uri":"/posts/2024-08-29-kvm.md/"},{"categories":["DevOps"],"content":"åµŒå¥—è™šæ‹ŸåŒ– ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ˜¯æ— æ³•åœ¨KVMè™šæ‹Ÿæœºé‡Œé¢å†å»åˆ›å»ºè™šæ‹Ÿæœºçš„ï¼Œå› ä¸ºKVMè™šæ‹Ÿæœºçš„CPUé»˜è®¤æƒ…å†µä¸‹å¹¶ä¸æ”¯æŒè™šæ‹ŸåŒ–åŠŸèƒ½ï¼Œå¯¹äºInterçš„CPUæ¥è¯´ï¼Œå¦‚æœè¦æ”¯æŒè™šæ‹ŸåŒ–åŠŸèƒ½ï¼Œå¿…é¡»è¦æœ‰ä¸€ä¸ªå«vmxçš„ç‰¹æ€§ã€‚åœ¨CPUç‰¹æ€§(flags)ä¸­åŒ…å«äº†vmxè¿™ä¸ªç‰¹æ€§ï¼Œè¯´æ˜è¿™å°æœåŠ¡å™¨æ˜¯æ”¯æŒè™šæ‹ŸåŒ–åŠŸèƒ½çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥åœ¨è¿™å°æœåŠ¡å™¨ä¸Šåˆ›å»ºè™šæ‹Ÿæœºã€‚ æ£€æŸ¥å®¿ä¸»æœºæœºæ˜¯å¦å¼€å¯äº†åµŒå¥—è™šæ‹ŸåŒ–åŠŸèƒ½ï¼š cat /sys/module/kvm_intel/parameters/nested ç»“æœä¸ºYæ—¶è¡¨ç¤ºå®¿ä¸»æœºæ”¯æŒåµŒå¥—è™šæ‹ŸåŒ–ï¼Œä¸ºNä¸ºä¸æ”¯æŒã€‚CentOS8ä¸Š 1/0 å¦‚ä½•å¼€å¯å®¿ä¸»æœºçš„åµŒå¥—è™šæ‹ŸåŒ–åŠŸèƒ½å¯å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼šhttp://www.cnblogs.com/jython/p/4458807.html åˆ›å»ºæ”¯æŒè™šæ‹ŸåŒ–åŠŸèƒ½çš„è™šæ‹Ÿæœº [CentOS 7ä¸‹KVMæ”¯æŒè™šæ‹ŸåŒ–/åµŒå¥—è™šæ‹ŸåŒ–é…ç½®](https://www.cnblogs.com/EasonJim/p/9752137.html) å¼€å¯è™šæ‹ŸåŒ–ï¼š cat \u003c\u003c EOF \u003e /etc/modprobe.d/kvm-nested.conf options kvm-intel nested=1 options kvm-intel enable_shadow_vmcs=1 options kvm-intel enable_apicv=1 options kvm-intel ept=1 EOF é‡æ–°åŠ è½½KVMå†…æ ¸ï¼Œæ³¨æ„å…ˆå…³é—­æ‰€æœ‰è™šæ‹Ÿæœºï¼š modprobe -r kvm_intel modprobe -a kvm_intel å¦‚æœä¸æƒ³çƒ­åŠ è½½å¯ä»¥ç›´æ¥é‡å¯å®¿ä¸»æœºã€‚ éªŒè¯æ˜¯å¦å·²ç»å¼€å¯æˆåŠŸï¼ŒæˆåŠŸåä¼šè¾“å‡ºYï¼š cat /sys/module/kvm_intel/parameters/nested ä¿®æ”¹KVMçš„XMLæ–‡ä»¶CPUæ¨¡å¼ä¸ºâ€œhost-modleâ€ æˆ– â€œhost-passthroughï¼š ","date":"2024-08-29","objectID":"/posts/2024-08-29-kvm.md/:1:6","tags":["kvm"],"title":"kvm","uri":"/posts/2024-08-29-kvm.md/"},{"categories":["DevOps"],"content":"ä¸€ã€flutter å®‰è£… https://flutter.cn/docs/get-started/install å®‰è£…æºå›½å†…åœ°å€ï¼š export PUB_HOSTED_URL=https://pub.flutter-io.cn export FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn ","date":"2024-08-29","objectID":"/posts/2024-08-29-flutter/:1:0","tags":["flutter"],"title":"flutter","uri":"/posts/2024-08-29-flutter/"},{"categories":["DevOps"],"content":"flutter dockeré•œåƒæ‰“åŒ… ","date":"2024-08-29","objectID":"/posts/2024-08-29-flutter/:2:0","tags":["flutter"],"title":"flutter","uri":"/posts/2024-08-29-flutter/"},{"categories":["DevOps"],"content":"1ã€flutter FROM --platform=linux/amd64 debian:bullseye ARG FLUTTER_VERSION=2.2.3 ENV LANG=C.UTF-8 ENV PUB_HOSTED_URL=https://pub.flutter-io.cn ENV FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn ENV TZ=Asia/Shanghai ENV DEBIAN_FRONTEND=noninteractive RUN sed -i 's/\\w*.debian.org/mirrors.ustc.edu.cn/g' /etc/apt/sources.list RUN apt-get update \u0026\u0026 apt-get upgrade -y \u0026\u0026 apt-get install -y apt-transport-https ca-certificates gnupg-agent tzdata curl git vim unzip \u0026\u0026 \\ ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \u0026\u0026 \\ echo $TZ \u003e /etc/timezone \u0026\u0026 dpkg-reconfigure --frontend noninteractive tzdata WORKDIR /opt RUN wget https://storage.flutter-io.cn/flutter_infra_release/releases/stable/linux/flutter_linux_${FLUTTER_VERSION}-stable.tar.xz \u0026\u0026 \\ tar -xf flutter_linux_${FLUTTER_VERSION}-stable.tar.xz \u0026\u0026 \\ ln -s /opt/flutter/bin/flutter /usr/bin/flutter \u0026\u0026 \\ rm -rf flutter_linux_${FLUTTER_VERSION}-stable.tar.xz \u0026\u0026 \\ git config --global --add safe.directory /opt/flutter \u0026\u0026 \\ flutter --version WORKDIR /root RUN mkdir -p /root/.ssh COPY id_rsa /root/.ssh RUN sed -i 's/^#\\s*StrictHostKeyChecking.*/StrictHostKeyChecking no/g' /etc/ssh/ssh_config ","date":"2024-08-29","objectID":"/posts/2024-08-29-flutter/:2:1","tags":["flutter"],"title":"flutter","uri":"/posts/2024-08-29-flutter/"},{"categories":["DevOps"],"content":"2ã€flutter android sdk å› ä¸ºgradleçš„åŸå› ï¼Œä¸€æ¬¡æ€§æ‰“åŒ…é€Ÿåº¦ä¼šå¾ˆæ…¢ï¼Œå®¹æ˜“å¤±è´¥ï¼Œå¯ä»¥åˆ†æ®µæ‰“åŒ…é•œåƒ Dockerfile.flutter-example2-b é‡Œä½¿ç”¨é‡Œ Dockerfile.flutter-example2-a æ„å»ºçš„é•œåƒä½œä¸ºåŸºç¡€ï¼›ä¹Ÿå¯ä»¥ä½¿ç”¨ Dockerfile.flutter-example1 è¿›è¡Œä¸€æ¬¡æ€§æ‰“åŒ… Dockerfile.flutter-example1 FROM --platform=linux/amd64 androidsdk/android-28:latest ARG FLUTTER_VERSION=2.2.3 ENV LANG=C.UTF-8 ENV PUB_HOSTED_URL=https://pub.flutter-io.cn ENV FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn ENV TZ=Asia/Shanghai ENV DEBIAN_FRONTEND=noninteractive # change apt source RUN sed -e \"s@http://.*archive.ubuntu.com@http://mirrors.aliyun.com@g\" \\ -e \"s@http://.*security.ubuntu.com@http://mirrors.aliyun.com@g\" \\ -i.bak \\ -i /etc/apt/sources.list WORKDIR /opt RUN wget https://storage.flutter-io.cn/flutter_infra_release/releases/stable/linux/flutter_linux_${FLUTTER_VERSION}-stable.tar.xz \u0026\u0026 \\ tar -xf flutter_linux_${FLUTTER_VERSION}-stable.tar.xz \u0026\u0026 \\ ln -s /opt/flutter/bin/flutter /usr/bin/flutter \u0026\u0026 \\ rm -rf flutter_linux_${FLUTTER_VERSION}-stable.tar.xz \u0026\u0026 \\ git config --global --add safe.directory /opt/flutter \u0026\u0026 \\ flutter --version COPY ./xxxx_pad /build WORKDIR /build RUN flutter pub get RUN flutter build apk --no-tree-shake-icons -t lib/main_xxxxxxxx.dart --flavor xxxxxxxxx --verbose RUN rm -rf /build WORKDIR /root åˆ†æ®µæ‰“åŒ… # Dockerfile.flutter-example2-a FROM --platform=linux/amd64 runmymind/docker-android-sdk:ubuntu-standalone ARG FLUTTER_VERSION=2.2.3 ENV LANG=C.UTF-8 ENV PUB_HOSTED_URL=https://pub.flutter-io.cn ENV FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn ENV TZ=Asia/Shanghai ENV DEBIAN_FRONTEND=noninteractive # change apt source RUN sed -e \"s@http://.*archive.ubuntu.com@http://mirrors.aliyun.com@g\" \\ -e \"s@http://.*security.ubuntu.com@http://mirrors.aliyun.com@g\" \\ -i.bak \\ -i /etc/apt/sources.list WORKDIR /opt RUN wget https://storage.flutter-io.cn/flutter_infra_release/releases/stable/linux/flutter_linux_${FLUTTER_VERSION}-stable.tar.xz \u0026\u0026 \\ tar -xf flutter_linux_${FLUTTER_VERSION}-stable.tar.xz \u0026\u0026 \\ ln -s /opt/flutter/bin/flutter /usr/bin/flutter \u0026\u0026 \\ rm -rf flutter_linux_${FLUTTER_VERSION}-stable.tar.xz \u0026\u0026 \\ git config --global --add safe.directory /opt/flutter \u0026\u0026 \\ flutter --version # Dockerfile.flutter-example2-b FROM flutter-android-sdk:flutter-example2-a COPY ./xxxxxx_pad /build WORKDIR /build RUN flutter pub get RUN flutter build apk --no-tree-shake-icons -t lib/main_xxxxxxxx.dart --flavor xxxxxxxx --verbose RUN rm -rf /build WORKDIR /root ","date":"2024-08-29","objectID":"/posts/2024-08-29-flutter/:2:2","tags":["flutter"],"title":"flutter","uri":"/posts/2024-08-29-flutter/"},{"categories":["DevOps"],"content":"é•œåƒåŒæ­¥ å‚è€ƒé“¾æ¥ï¼š https://lework.github.io/2020/04/13/skopeo/ https://blog.k8s.li/skopeo.html æ—¥å¸¸å·¥ä½œä¸­ï¼Œéœ€è¦å°†å„ç§é•œåƒæ¬åˆ°å¯¹åº”çš„ä»“åº“ä¸­ï¼Œdocker é€‚åˆäºæ„å»ºé•œåƒï¼Œå°†é•œåƒæ¨é€äºä»“åº“ä¸­ã€‚é•œåƒè¢«æ¨é€åˆ°ä»“åº“ä¸­åï¼Œå¦‚æœéœ€è¦å¯¹é•œåƒè¿›è¡Œæ¬è¿ï¼Œåœ¨ä»“åº“ä¸æä¾›è¿™ä¸ªåŠŸèƒ½çš„æƒ…å†µä¸‹ï¼ŒåŒæ­¥é•œåƒæ˜¯æ¯”è¾ƒå›°éš¾çš„ã€‚ skopeo æ˜¯çº¢å¸½å¼€æºçš„å®¹å™¨é•œåƒç®¡ç†å·¥å…·ã€‚ç›¸æ¯”äºdockerï¼Œå®ƒæœ‰ä¸€ä¸‹çš„ä¼˜ç‚¹ï¼š æ”¯æŒå¤šä¸ªå¹³å°ï¼šskopeo æ”¯æŒ Linuxï¼ŒMac å’Œ Windowsã€‚ æ— éœ€ docker æˆ–è€… podmanï¼šskopeo å¯ä»¥æ„å»ºä¸ºå•ä¸€çš„ cliï¼Œä¸ä¾èµ–äº docker æœåŠ¡æˆ–è€… podmanã€‚ æ”¯æŒå¤šä¸ª OCI é•œåƒä»“åº“é—´åŒæ­¥ï¼šæ”¯æŒ OCI çš„é•œåƒæ‰˜ç®¡æœåŠ¡ï¼Œéƒ½å¯ä»¥ç›¸äº’åŒæ­¥ã€‚ æ”¯æŒå¤šæ¶æ„é•œåƒåŒæ­¥ï¼šå¯ä»¥åŒæ­¥å¤šç§æ¶æ„çš„é•œåƒã€‚ é•œåƒéªŒç­¾ï¼šskopeo æ”¯æŒé•œåƒç­¾åï¼Œå¯ç¡®ä¿é•œåƒçš„å®Œæ•´æ€§å’Œå¯é æ€§ã€‚ ","date":"2024-08-19","objectID":"/posts/skopeo/:0:0","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"ä¸€ã€ç¼–è¯‘skopeo skopeo å®˜æ–¹å¹¶ä¸æä¾›ç¼–è¯‘å¥½çš„é™æ€äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¸¸è§çš„ç³»ç»Ÿæºä¸­å·²ç»åŒ…å«äº† skopeoï¼Œä½†ç”±äº skopeo çš„ç‰ˆæœ¬è¿­ä»£æ¯”è¾ƒå¿«ï¼Œæ–°çš„åŠŸèƒ½ä¹Ÿéšä¹‹å¢åŠ ï¼Œéƒ¨åˆ†æ“ä½œç³»ç»Ÿé‡Œæä¾›çš„å®‰è£…åŒ…ç‰ˆæœ¬å¯èƒ½æ¯”è¾ƒä½ï¼Œæ— æ³•é€‚ç”¨ï¼Œä¸” skopeo å¤§å¤šéƒ½æ˜¯é“¾æ¥äº†åŠ¨æ€åº“ï¼Œæ— æ³•é€šç”¨äºå¤šä¸ª linux å‘è¡Œç‰ˆï¼Œå› æ­¤å¯ä»¥å€ŸåŠ©dockerå®ç°skopeoçš„é™æ€ç¼–è¯‘ã€‚ åŸºäºgithub actionæ„å»ºskopeo: skopeo ","date":"2024-08-19","objectID":"/posts/skopeo/:1:0","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"ä¸‹è½½ skopeo æºç  # download source code git clone --depth=1 https://github.com/containers/skopeo.git ","date":"2024-08-19","objectID":"/posts/skopeo/:1:1","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"æ„å»ºbuildé•œåƒçš„Dockerfile å›½å†…æ„å»ºåˆ™éœ€è¦ä¿®æ”¹ alpine å’Œ go é•œåƒåœ°å€ï¼Œå¯ç›´è¿ github çš„å¯ä»¥å¿½ç•¥æ­¤æ­¥ FROM golang:1.19-alpine3.16 AS builder ENV LANG=C.UTF-8 ENV TZ=Asia/Shanghai ENV CGO_ENABLED=0 ENV GOPROXY=https://goproxy.cn,direct RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories RUN apk update --no-cache \u0026\u0026 apk add --no-cache ca-certificates ","date":"2024-08-19","objectID":"/posts/skopeo/:1:2","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"æ„å»º build é•œåƒ docker build -t skopeo-build . ","date":"2024-08-19","objectID":"/posts/skopeo/:1:3","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"æ„å»º skopeo é™æ€äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ cd skopeo/ # æ„å»º linux amd64 æ¶æ„ docker run --rm -t -v $PWD:/build skopeo-build sh -c \"apk update \u0026\u0026 apk add gpgme btrfs-progs-dev llvm13-dev gcc musl-dev \u0026\u0026 cd /build \u0026\u0026 CGO_ENABLE=0 GO111MODULE=on GOOS=linux GOARCH=amd64 go build -mod=vendor '-buildmode=pie' -ldflags '-extldflags -static' -gcflags '' -tags 'exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp' -o ./bin/skopeo-linux-amd64 ./cmd/skopeo \" # æ„å»º linux arm64 æ¶æ„ docker run --rm -t -v $PWD:/build skopeo-build sh -c \"apk update \u0026\u0026 apk add gpgme btrfs-progs-dev llvm13-dev gcc musl-dev \u0026\u0026 cd /build \u0026\u0026 CGO_ENABLE=0 GO111MODULE=on GOOS=linux GOARCH=arm64 go build -mod=vendor '-buildmode=pie' -ldflags '-extldflags -static' -gcflags '' -tags 'exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp' -o ./bin/skopeo-linux-arm64 ./cmd/skopeo \" ","date":"2024-08-19","objectID":"/posts/skopeo/:1:4","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"äºŒã€skopeo å‘½ä»¤ä½¿ç”¨ [root@tc ~]# skopeo -v skopeo version 1.11.1-dev [root@tc ~]# skopeo --help Various operations with container images and container image registries Usage: skopeo [flags] skopeo [command] Available Commands: copy Copy an IMAGE-NAME from one location to another delete Delete image IMAGE-NAME generate-sigstore-key Generate a sigstore public/private key pair help Help about any command inspect Inspect image IMAGE-NAME list-tags List tags in the transport/repository specified by the SOURCE-IMAGE login Login to a container registry logout Logout of a container registry manifest-digest Compute a manifest digest of a file standalone-sign Create a signature using local files standalone-verify Verify a signature using local files sync Synchronize one or more images from one location to another Flags: --command-timeout duration timeout for the command execution --debug enable debug output -h, --help help for skopeo --insecure-policy run the tool without any policy check --override-arch ARCH use ARCH instead of the architecture of the machine for choosing images --override-os OS use OS instead of the running OS for choosing images --override-variant VARIANT use VARIANT instead of the running architecture variant for choosing images --policy string Path to a trust policy file --registries.d DIR use registry configuration files in DIR (e.g. for container signature storage) --tmpdir string directory used to store temporary files -v, --version Version for Skopeo Use \"skopeo [command] --help\" for more information about a command. # ç™»å½•ä¸ç™»å‡º oci skopeo login -u username docker.io skopeo logout docker.io ä¸ä¸‹è½½é•œåƒæƒ…å†µä¸‹è·å–é•œåƒä¿¡æ¯ [root@tc ~]# skopeo inspect docker://docker.io/alpine { \"Name\": \"docker.io/library/alpine\", \"Digest\": \"sha256:eece025e432126ce23f223450a0326fbebde39cdf496a85d8c016293fc851978\", \"RepoTags\": [ \"20220316\", \"20220328\", \"20220715\", \"20221110\", \"20230208\", \"20230329\", \"20230901\", \"3\", \"3.17\", \"3.17.0\", \"3.17.0_rc1\", \"3.17.1\", \"3.17.2\", \"3.17.3\", \"3.17.4\", \"3.17.5\", \"3.18\", \"3.18.0\", \"3.18.2\", \"3.18.3\", \"3.18.4\", \"edge\", \"latest\" ], \"Created\": \"2023-09-28T21:19:27.801479409Z\", \"DockerVersion\": \"20.10.23\", \"Labels\": null, \"Architecture\": \"amd64\", \"Os\": \"linux\", \"Layers\": [ \"sha256:96526aa774ef0126ad0fe9e9a95764c5fc37f409ab9e97021e7b4775d82bf6fa\" ], \"LayersData\": [ { \"MIMEType\": \"application/vnd.docker.image.rootfs.diff.tar.gzip\", \"Digest\": \"sha256:96526aa774ef0126ad0fe9e9a95764c5fc37f409ab9e97021e7b4775d82bf6fa\", \"Size\": 3401967, \"Annotations\": null } ], \"Env\": [ \"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\" ] } docker://: æ˜¯ä½¿ç”¨ Docker Registry HTTP API V2 è¿›è¡Œè¿æ¥è¿œç«¯ docker.io: è¿œç¨‹ä»“åº“ alpine: é•œåƒåç§° è·å–æœ¬åœ°é•œåƒä¿¡æ¯ [root@tc ~]# skopeo inspect docker-daemon:alpine:3 { \"Name\": \"docker.io/library/alpine\", \"Digest\": \"sha256:844bc35fdf7a96e5b6bf5e76e20989a797cc75976fad73275061a36f448b92b9\", \"RepoTags\": [], \"Created\": \"2023-09-28T21:19:27.801479409Z\", \"DockerVersion\": \"20.10.23\", \"Labels\": null, \"Architecture\": \"amd64\", \"Os\": \"linux\", \"Layers\": [ \"sha256:cc2447e1835a40530975ab80bb1f872fbab0f2a0faecf2ab16fbbb89b3589438\" ], \"LayersData\": [ { \"MIMEType\": \"application/vnd.docker.image.rootfs.diff.tar.gzip\", \"Digest\": \"sha256:cc2447e1835a40530975ab80bb1f872fbab0f2a0faecf2ab16fbbb89b3589438\", \"Size\": 7625728, \"Annotations\": null } ], \"Env\": [ \"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\" ] } docker-daemon: dockerå®ˆæŠ¤é•œåƒçš„é•œåƒ alpine:3: æœ¬åœ°é•œåƒçš„åç§° ","date":"2024-08-19","objectID":"/posts/skopeo/:2:0","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"copyé•œåƒ # skopeo --insecure-policy copy docker://nginx:1.17.6 docker-archive:/tmp/nginx.tar Getting image source signatures Copying blob 8ec398bc0356 done Copying blob 465560073b6f done Copying blob f473f9fd0a8c done Copying config f7bb5701a3 done Writing manifest to image destination Storing signatures # ls -alh /tmp/nginx.tar -rw-r--r-- 1 root root 125M 4æœˆ 13 15:22 /tmp/nginx.tar --insecure-policy: ç”¨äºå¿½ç•¥å®‰å…¨ç­–ç•¥é…ç½®æ–‡ä»¶ docker://nginx:1.17.6: è¯¥å‘½ä»¤å°†ä¼šç›´æ¥é€šè¿‡ http ä¸‹è½½ç›®æ ‡é•œåƒ docker-archive: å­˜å‚¨ä¸º /tmp/nginx.tarï¼Œæ­¤æ–‡ä»¶å¯ä»¥ç›´æ¥é€šè¿‡ docker load å‘½ä»¤å¯¼å…¥ ç›¸åº”çš„ï¼Œå¯ä»¥å°†ä¸‹è½½çš„æ–‡ä»¶å¯¼å…¥åˆ°æœ¬åœ° # skopeo copy docker-archive:/tmp/nginx.tar docker-daemon:nginx:latest Getting image source signatures Copying blob 556c5fb0d91b done Copying blob 49434cc20e95 done Copying blob 75248c0d5438 done Copying config f7bb5701a3 done Writing manifest to image destination Storing signatures # docker images nginx REPOSITORY TAG IMAGE ID CREATED SIZE nginx latest f7bb5701a33c 3 months ago 126MB COPY # ä¹Ÿå¯ä»¥å°†é•œåƒä¸‹è½½åˆ°æŒ‡å®šç›®å½• # skopeo copy docker://busybox:latest dir:/tmp/busybox Getting image source signatures Copying blob 0669b0daf1fb done Copying config 83aa35aa1c done Writing manifest to image destination Storing signatures # ls -alh /tmp/busybox/ æ€»ç”¨é‡ 760K drwxr-xr-x 2 root root 186 4æœˆ 13 15:26 . drwxrwxrwt. 12 root root 4.0K 4æœˆ 13 15:25 .. -rw-r--r-- 1 root root 743K 4æœˆ 13 15:26 0669b0daf1fba90642d105f3bc2c94365c5282155a33cc65ac946347a90d90d1 -rw-r--r-- 1 root root 1.5K 4æœˆ 13 15:26 83aa35aa1c79e4b6957e018da6e322bfca92bf3b4696a211b42502543c242d6f -rw-r--r-- 1 root root 527 4æœˆ 13 15:26 manifest.json -rw-r--r-- 1 root root 33 4æœˆ 13 15:25 version #æˆ–è€…ä»æŒ‡å®šç›®å½•å¯¼å…¥åˆ°æœ¬åœ° # skopeo copy dir:/tmp/busybox docker-daemon:busybox:latest Getting image source signatures Copying blob 0669b0daf1fb done Copying config 83aa35aa1c done Writing manifest to image destination Storing signatures # docker images busybox REPOSITORY TAG IMAGE ID CREATED SIZE busybox latest 83aa35aa1c79 4 weeks ago 1.22MB ","date":"2024-08-19","objectID":"/posts/skopeo/:2:1","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"åˆ é™¤é•œåƒ skopeo delete docker://localhost:5000/nginx:latest ","date":"2024-08-19","objectID":"/posts/skopeo/:2:2","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"è®¤è¯æ–‡ä»¶ è®¤è¯æ–‡ä»¶é»˜è®¤å­˜æ”¾åœ¨ $HOME/.docker/config.json æ–‡ä»¶å†…å®¹ { \"auths\": { \"myregistrydomain.com:5000\": { \"auth\": \"dGVzdHVzZXI6dGVzdHxxxxxxxx\", \"email\": \"cc@local.com\" } } } ","date":"2024-08-19","objectID":"/posts/skopeo/:2:3","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"sync åœ¨ OCI é—´åŒæ­¥é•œåƒ ä½¿ç”¨ docke råœ¨ OCI é—´åŒæ­¥é•œåƒçš„æ—¶å€™ï¼Œéœ€è¦å…ˆæŠŠé•œåƒæ‹‰ä¸‹æ¥ï¼Œæ‰“ä¸Š tag ï¼Œç„¶ååœ¨æ¨é€åˆ°ç›®çš„ OCI ä¸Šã€‚åœ¨è¿™ä¸ªæ“ä½œçš„è¿‡ç¨‹ä¸­ï¼Œå³å ç”¨äº†å­˜å‚¨ï¼Œåˆå ç”¨äº†å¸¦å®½ï¼Œåœ¨åŒæ­¥å¤§çš„é•œåƒæˆ–è€…å¤§é‡çš„é•œåƒçš„æ—¶å€™ï¼Œå­˜å‚¨ä¼šä¸¥é‡å½±å“é•œåƒåœ¨ OCI é—´åŒæ­¥çš„æ•ˆç‡ã€‚skopeo æ­£å¥½å¯ä»¥è§£å†³è¿™ä¸ªç¼ºç‚¹ï¼Œskopeo åœ¨åŒæ­¥ OCI é•œåƒçš„è¿‡ç¨‹ä¸­ï¼Œåªå ç”¨å¸¦å®½ï¼Œä¸ä¼šæŠŠé•œåƒä¸‹è½½åˆ°æœ¬åœ°ã€‚ åŸºäº yaml æ–‡ä»¶çš„åŒæ­¥ # sync.yaml ghcr.io: images: kube-vip/kube-vip: - 'v0.6.0' - 'v0.4.4' k3d-io/k3d-tools: - '5.5.2' åŒæ­¥é•œåƒ skopeo --insecure-policy sync -a --src yaml --dest docker sync.yaml repo.local.com/serialt skopeo --insecure-policy copy docker://docker.io/library/nginx:latest docker://registry.cn-hangzhou.aliyuncs.com/serialt/nginx:latest ","date":"2024-08-19","objectID":"/posts/skopeo/:2:4","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"æŸ¥çœ‹é•œåƒæ‰€æœ‰tag [root@tc ~]# skopeo list-tags docker://registry.cn-hangzhou.aliyuncs.com/serialt/go ","date":"2024-08-19","objectID":"/posts/skopeo/:2:5","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"ä¸‰ã€åŒæ­¥é•œåƒ ç›®å‰ï¼Œå¸¸ç”¨çš„ OCI ä»“åº“æœ‰ï¼šdocker.ioï¼Œquay.ioï¼Œgcr.ioï¼Œregistry.k8s.ioï¼Œghcr.io ç­‰ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œå› ä¸ºæŸäº›åŸå› ï¼Œè¿™äº› OCI ä»“åº“åœ¨å›½å†…æ— æ³•è®¿é—®ï¼Œè€Œä¸€äº›é¡¹ç›®åˆä¸¥é‡ä¾èµ–äºå­˜å‚¨åœ¨è¿™äº› OCI ä»“åº“çš„é•œåƒï¼Œè™½ç„¶æœ‰çƒ­å¿ƒçš„å¤§ä½¬ä»¬ä¼šæŠŠ gcr å’Œ ghcr ä¸Šå­˜å‚¨çš„é•œåƒåŒæ­¥åˆ° docker hub ä¸­ï¼Œä½†å› ä¸ºè¿™äº›è¢«æ¨é€åˆ° docker hub ä¸­çš„é•œåƒä¸æ˜¯å®˜æ–¹ç»´æŠ¤çš„ï¼Œå¯èƒ½ä¼šå­˜åœ¨æ¯”è¾ƒå¤§çš„é•œåƒçš„åŒæ­¥æ—¶é—´å·®ï¼ŒæŸäº›éœ€è¦çš„é•œåƒæ— æ³•åœ¨ docker hub ä¸Šæ‰¾åˆ°ï¼ŒåŒæ—¶ä¹Ÿå®¹æ˜“å¼•èµ·å®¹å™¨é•œåƒçš„ä¾›åº”é“¾å®‰å…¨é—®é¢˜ã€‚å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨ github action ä½¿ç”¨ skopeo è¿›è¡ŒåŒæ­¥é•œåƒã€‚ é¡¹ç›®åœ°å€ï¼šsync-image ","date":"2024-08-19","objectID":"/posts/skopeo/:3:0","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"1ã€å®‰è£…sync-image å’Œ skopeo wget https://github.com/serialt/skopeo/releases/download/v1.13.3/skopeo-linux-amd64 go install github.com/serialt/sync-image@latest ","date":"2024-08-19","objectID":"/posts/skopeo/:3:1","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"2ã€é…ç½®sync-image yaml é…ç½®æ–‡ä»¶ # config.yaml # é•œåƒåŒæ­¥çš„ä¸ªæ•° last: 10 # mcråŒæ­¥çš„ä¸ªæ•°ï¼Œmcrä¸­åŒ…å«å¤šä¸ª vscode å®¹å™¨å¼€å‘çš„é•œåƒ mcrLast: 50 autoSyncfile: sync.yaml # ä¸åŒæ­¥å¸¦æœ‰ä»¥ä¸‹å…³é”®å­—çš„é•œåƒçš„tag exclude: - 'alpha' - 'beta' - 'rc' - 'amd64' - 'ppc64le' - 'arm64' - 'arm' - 's390x' - 'SNAPSHOT' - 'snapshot' - 'debug' - 'master' - 'latest' - 'main' - 'sig' - 'sha' - 'mips' # éœ€è¦åŒæ­¥çš„é•œåƒ images: docker.elastic.co: - elasticsearch/elasticsearch - kibana/kibana - logstash/logstash - beats/filebeat - beats/heartbeat - beats/packetbeat - beats/auditbeat - beats/journalbeat - beats/metricbeat - apm/apm-server - app-search/app-search quay.io: - coreos/flannel - ceph/ceph - cephcsi/cephcsi - csiaddons/k8s-sidecar - csiaddons/volumereplication-operator - prometheus/prometheus - prometheus/alertmanager - prometheus/pushgateway - prometheus/blackbox-exporter - prometheus/node-exporter - prometheus-operator/prometheus-config-reloader - prometheus-operator/prometheus-operator - brancz/kube-rbac-proxy - jetstack/cert-manager-webhook - jetstack/cert-manager-controller - jetstack/cert-manager-cainjector k8s.gcr.io: - conformance - dns/k8s-dns-node-cache - metrics-server/metrics-server - kube-state-metrics/kube-state-metrics - prometheus-adapter/prometheus-adapter registry.k8s.io: - sig-storage/local-volume-provisioner - metrics-server/metrics-server - defaultbackend - ingress-nginx/controller - ingress-nginx/kube-webhook-certgen - sig-storage/nfs-subdir-external-provisioner - sig-storage/csi-node-driver-registrar - sig-storage/csi-provisioner - sig-storage/csi-resizer - sig-storage/csi-snapshotter - sig-storage/snapshot-controller - sig-storage/snapshot-validation-webhook - sig-storage/nfsplugin - sig-storage/csi-attacher - sig-storage/livenessprobe - defaultbackend-amd64 - defaultbackend-arm64 - pause - etcd - kube-proxy - kube-apiserver - kube-scheduler - kube-controller-manager - coredns/coredns - build-image/kube-cross gcr.io: - kaniko-project/executor ghcr.io: - k3d-io/k3d-tools - k3d-io/k3d-proxy - kube-vip/kube-vip mcr.microsoft.com: - devcontainers/base - devcontainers/go docker.io: - flannel/flannel - flannel/flannel-cni-plugin - calico/kube-controllers - serialt/rocky - serialt/alma - calico/cni - calico/pod2daemon-flexvol - calico/kube-controllers - calico/node - rancher/mirrored-flannelcni-flannel-cni-plugin - rancher/mirrored-flannelcni-flanne ","date":"2024-08-19","objectID":"/posts/skopeo/:3:2","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"3ã€ç”ŸæˆåŠ¨æ€åŒæ­¥çš„ yaml æ–‡ä»¶ sync-image -c config.yaml ","date":"2024-08-19","objectID":"/posts/skopeo/:3:3","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"4ã€åŒæ­¥é•œåƒ ä¾èµ–çš„ç¯å¢ƒå˜é‡ DEST_HUB_USERNAME DEST_HUB_PASSWORD MY_GITHUB_TOKEN åŒæ­¥çš„shellè„šæœ¬ hub=\"docker.io\" repo=\"$hub/${DEST_HUB_USERNAME}\" hub2=\"registry.cn-hangzhou.aliyuncs.com\" repo2=\"$hub2/${DEST_HUB_USERNAME}\" if [ -f sync.yaml ]; then echo \"[Start] sync.......\" sudo skopeo login -u ${DEST_HUB_USERNAME} -p ${DEST_HUB_PASSWORD} ${hub} \\ \u0026\u0026 sudo skopeo --insecure-policy sync -a --src yaml --dest docker sync.yaml ${repo} \\ \u0026\u0026 sudo skopeo --insecure-policy sync -a --src yaml --dest docker custom_sync.yaml ${repo} sleep 3 sudo skopeo login -u ${DEST_HUB_USERNAME} -p ${DEST_HUB_PASSWORD} ${hub2} \\ \u0026\u0026 sudo skopeo --insecure-policy sync -a --src yaml --dest docker sync.yaml ${repo2} \\ \u0026\u0026 sudo skopeo --insecure-policy sync -a --src yaml --dest docker custom_sync.yaml ${repo2} echo \"[End] done.\" else echo \"[Error]not found sync.yaml!\" fi ","date":"2024-08-19","objectID":"/posts/skopeo/:3:4","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"5ã€github action é…ç½®æ–‡ä»¶ name: sync on: push: branches: - master - main schedule: - cron: \"0 2 * * *\" # Allows you to run this workflow manually from the Actions tab workflow_dispatch: jobs: sync: runs-on: ubuntu-latest steps: - uses: actions/checkout@v4 - name: Set up Go uses: actions/setup-go@v4 with: go-version: '\u003e=1.21.0' - name: Install dependencies run: | export version=v1.10.0 \u0026\u0026 export arch=amd64 \u0026\u0026 sudo wget https://github.com/lework/skopeo-binary/releases/download/${version}/skopeo-linux-${arch} -O /usr/bin/skopeo \u0026\u0026 sudo chmod +x /usr/bin/skopeo skopeo --version go install github.com/serialt/sync-image@latest - name: generate_sync_yaml env: SRC_HUB_USERNAME: ${{ secrets.SRC_HUB_USERNAME }} DEST_HUB_USERNAME: ${{ secrets.DEST_HUB_USERNAME }} DEST_HUB_PASSWORD: ${{ secrets.DEST_HUB_PASSWORD }} MY_GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }} timeout-minutes: 10 run: | sync-image - name: sync image env: SRC_HUB_USERNAME: ${{ secrets.SRC_HUB_USERNAME }} DEST_HUB_USERNAME: ${{ secrets.DEST_HUB_USERNAME }} DEST_HUB_PASSWORD: ${{ secrets.DEST_HUB_PASSWORD }} run: | bash sync.sh ","date":"2024-08-19","objectID":"/posts/skopeo/:3:5","tags":["skopeo","image","oci-image-sync"],"title":"Skopeo","uri":"/posts/skopeo/"},{"categories":["DevOps"],"content":"Redis ","date":"2024-08-11","objectID":"/posts/2024-08-31-redis/:1:0","tags":["redis"],"title":"redis","uri":"/posts/2024-08-31-redis/"},{"categories":["DevOps"],"content":"Redis ç‰¹ç‚¹ å¼€æºæ•°æ®åº“ é…ç½®ç®€å• æ”¯æŒå†…å­˜å­˜å‚¨æ•°æ® æ”¯æŒæŒä¹…åŒ–å­˜å‚¨æ•°æ® datafile æ•°æ®æ–‡ä»¶ *.rdb aof(append only file)æ–‡ä»¶ï¼Œæ—¥å¿—æ–‡ä»¶ æ”¯æŒå¤šå®ä¾‹éƒ¨ç½² æ”¯æŒä¸»ä»å¤åˆ¶ã€é›†ç¾¤ æ”¯æŒäº‹åŠ¡transaction ä»¥key-valueé”®å€¼å¯¹çš„æ–¹å¼å­˜å‚¨ valueç±»å‹ï¼šstringå­—ç¬¦ä¸²ã€liståˆ—è¡¨ã€seté›†åˆã€sorted_setæœ‰åºé›†åˆã€hashå€¼ ","date":"2024-08-11","objectID":"/posts/2024-08-31-redis/:1:1","tags":["redis"],"title":"redis","uri":"/posts/2024-08-31-redis/"},{"categories":["DevOps"],"content":"å®‰è£… docker ä½¿ç”¨ bitnamié•œåƒ https://hub.docker.com/r/bitnami/redis services: redis: image: bitnami/redis:6.2 container_name: redis restart: always ports: - \"6379:6379\" volumes: - /data/redis:/data environment: - REDIS_PASSWORD=Password123 redis å‘½ä»¤è§£é‡Š redis-serverï¼šå¯åŠ¨redisæœåŠ¡ redis-cliï¼šrediså®¢æˆ·ç«¯å·¥å…· redis-benchmarkï¼šredisæ€§èƒ½æµ‹è¯• redis-check-rdbï¼šæ£€æµ‹rdbæ–‡ä»¶ redis-check-aofï¼šæ£€æµ‹aofæ—¥å¿—æ–‡ä»¶ ","date":"2024-08-11","objectID":"/posts/2024-08-31-redis/:1:2","tags":["redis"],"title":"redis","uri":"/posts/2024-08-31-redis/"},{"categories":["DevOps"],"content":"Redis æ“ä½œ [root@redis01 ~]# redis-cli 127.0.0.1:6379\u003e set age 16 OK 127.0.0.1:6379\u003e get age \"16\" 127.0.0.1:6379\u003e set name martin OK 127.0.0.1:6379\u003e get name \"martin\" 127.0.0.1:6379\u003e 127.0.0.1:6379\u003e keys * 1) \"age\" 2) \"name\" 127.0.0.1:6379\u003e del age (integer) 1 127.0.0.1:6379\u003e get age (nil) 127.0.0.1:6379\u003e 127.0.0.1:6379\u003e set name martin OK 127.0.0.1:6379\u003e get name \"martin\" 127.0.0.1:6379\u003e mset name tom age 15 sex male OK 127.0.0.1:6379\u003e mget name age sex 1) \"tom\" 2) \"15\" 3) \"male\" 127.0.0.1:6379\u003e 127.0.0.1:6379\u003e strlen name (integer) 3 127.0.0.1:6379\u003e 127.0.0.1:6379\u003e set count 1 OK 127.0.0.1:6379\u003e incr count (integer) 2 127.0.0.1:6379\u003e incr count (integer) 3 127.0.0.1:6379\u003e incr count (integer) 4 127.0.0.1:6379\u003e get count \"4\" 127.0.0.1:6379\u003e decr count (integer) 3 127.0.0.1:6379\u003e get count \"3\" 127.0.0.1:6379\u003e 127.0.0.1:6379\u003e set count 1 OK 127.0.0.1:6379\u003e incrby count 3 (integer) 4 127.0.0.1:6379\u003e get count \"4\" 127.0.0.1:6379\u003e decrby count 2 (integer) 2 127.0.0.1:6379\u003e get count \"2\" 127.0.0.1:6379\u003e å¯†ç è¿æ¥redis # æ–¹æ³•1 [root@redis01 ~]# redis-cli 127.0.0.1:6379\u003e 127.0.0.1:6379\u003e AUTH redhat OK # æ–¹æ³•2 [root@redis01 ~]# redis-cli -a redhat 127.0.0.1:6379\u003e set age 10 OK ","date":"2024-08-11","objectID":"/posts/2024-08-31-redis/:1:3","tags":["redis"],"title":"redis","uri":"/posts/2024-08-31-redis/"},{"categories":["DevOps"],"content":"Redis äº‹ç‰© 192.168.122.102:6379\u003e set count 1 OK 192.168.122.102:6379\u003e multi OK 192.168.122.102:6379\u003e incr count QUEUED 192.168.122.102:6379\u003e incr count QUEUED 192.168.122.102:6379\u003e exec 1) (integer) 2 2) (integer) 3 192.168.122.102:6379\u003e 192.168.122.102:6379\u003e get count \"3\" 192.168.122.102:6379\u003e 192.168.122.102:6379\u003e set number 1 OK 192.168.122.102:6379\u003e MULTI OK 192.168.122.102:6379\u003e incr number QUEUED 192.168.122.102:6379\u003e exec (error) EXECABORT Transaction discarded because of previous errors. 192.168.122.102:6379\u003e 192.168.122.102:6379\u003e 192.168.122.102:6379\u003e 192.168.122.102:6379\u003e get number \"1\" 192.168.122.102:6379\u003e ","date":"2024-08-11","objectID":"/posts/2024-08-31-redis/:1:4","tags":["redis"],"title":"redis","uri":"/posts/2024-08-31-redis/"},{"categories":["DevOps"],"content":"Redis åˆ«å [root@redis01 ~]# grep \"^rename\" /usr/local/redis/conf/redis.conf rename-command set uplooking [root@redis01 ~]# [root@redis01 ~]# redis-cli -a redhat 127.0.0.1:6379\u003e 127.0.0.1:6379\u003e 127.0.0.1:6379\u003e set age 10 (error) ERR unknown command 'set' 127.0.0.1:6379\u003e 127.0.0.1:6379\u003e uplooking age 10 OK 127.0.0.1:6379\u003e get age \"10\" 127.0.0.1:6379\u003e åˆ«åå¯ä»¥ç”¨äºè§„é¿å±é™©å‘½ä»¤ rename-command FLUSHALL \"\" rename-command FLUSHDB \"\" rename-command CONFIG \"\" rename-command KEYS \"\" å¦‚æœæƒ³è¦ä¿ç•™å‘½ä»¤ï¼Œä½†æ˜¯ä¸èƒ½è½»æ˜“ä½¿ç”¨ï¼Œå¯ä»¥é‡å‘½åå‘½ä»¤æ¥è®¾å®šï¼Œè®¾ç½®éšæœºå­—ç¬¦ä»£æ›¿ï¼š rename-command FLUSHALL joYAPNXRPmcarcR4ZDgC81TbdkSmLAzRPmcarcR rename-command FLUSHDB qf69aZbLAX3cf3ednHM3SOlbpH71yEXLAX3cf3e rename-command CONFIG FRaqbC8wSA1XvpFVjCRGryWtIIZS2TRvpFVjCRG rename-command KEYS eIiGXix4A2DreBBsQwY6YHkidcDjoYA2DreBBsQ ","date":"2024-08-11","objectID":"/posts/2024-08-31-redis/:1:5","tags":["redis"],"title":"redis","uri":"/posts/2024-08-31-redis/"},{"categories":["DevOps"],"content":"RedisæŒä¹…åŒ–å­˜å‚¨ä¸å¤‡ä»½ RDBæŒä¹…åŒ– å°†Redisåœ¨å†…å­˜ä¸­çš„æ•°æ®å®šæ—¶dumpåˆ°ç£ç›˜ä¸Šï¼Œå®é™…æ“ä½œè¿‡ç¨‹æ˜¯forkä¸€ä¸ªå­è¿›ç¨‹ï¼Œå…ˆå°†æ•°æ®å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œå†™å…¥æˆåŠŸåï¼Œå†æ›¿æ¢ä¹‹å‰çš„æ–‡ä»¶ï¼Œç”¨äºŒè¿›åˆ¶å‹ç¼©å­˜å‚¨ AOFæŒä¹…åŒ– AOFæŒä¹…åŒ–ï¼šå°†Redisçš„æ“ä½œæ—¥å¿—ä»¥æ–‡ä»¶è¿½åŠ çš„æ–¹å¼å†™å…¥æ–‡ä»¶ï¼Œåªè®°å½•å†™ã€åˆ é™¤æ“ä½œï¼ŒæŸ¥è¯¢æ“ä½œä¸ä¼šè®°å½•ï¼ˆç±»ä¼¼äºMySQLçš„Binlogæ—¥å¿—ï¼‰ ","date":"2024-08-11","objectID":"/posts/2024-08-31-redis/:1:6","tags":["redis"],"title":"redis","uri":"/posts/2024-08-31-redis/"},{"categories":["DevOps"],"content":"è‡ªåŠ¨é—´éš”æ€§ä¿å­˜ å› ä¸ºBGSAVEå‘½ä»¤å¯ä»¥åœ¨ä¸é˜»å¡æœåŠ¡å™¨è¿›ç¨‹çš„æƒ…å†µä¸‹æ‰§è¡Œï¼Œæ‰€ä»¥Rediså…è®¸ç”¨æˆ·é€šè¿‡è®¾ç½®æœåŠ¡å™¨é…ç½®çš„saveé€‰é¡¹ï¼Œè®©æœåŠ¡å™¨æ¯éš”ä¸€æ®µæ—¶é—´è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡BGSAVEå‘½ä»¤ ç”¨æˆ·å¯ä»¥é€šè¿‡saveé€‰é¡¹è®¾ç½®å¤šä¸ªä¿å­˜æ¡ä»¶ï¼Œä½†åªè¦å…¶ä¸­ä»»æ„ä¸€ä¸ªæ¡ä»¶è¢«æ»¡è¶³ï¼ŒæœåŠ¡å™¨å°±ä¼šæ‰§è¡ŒBGSAVEå‘½ä»¤ ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬å‘æœåŠ¡å™¨æä¾›ä»¥ä¸‹é…ç½® # redis save 900 1 save 300 10 save 60 10000 é‚£ä¹ˆåªè¦æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªï¼ŒBGSAVEå‘½ä»¤å°±ä¼šè¢«æ‰§è¡Œ æœåŠ¡å™¨åœ¨900ç§’ä¹‹å†…ï¼Œå¯¹æ•°æ®åº“è¿›è¡Œäº†è‡³å°‘1æ¬¡ä¿®æ”¹ æœåŠ¡å™¨åœ¨300ç§’ä¹‹å†…ï¼Œå¯¹æ•°æ®åº“è¿›è¡Œäº†è‡³å°‘10æ¬¡ä¿®æ”¹ æœåŠ¡å™¨åœ¨60ç§’ä¹‹å†…ï¼Œå¯¹æ•°æ®åº“è¿›è¡Œäº†è‡³å°‘10000æ¬¡ä¿®æ”¹ã€‚ RDBæŒä¹…åŒ–å®ç° # redis.conf # é»˜è®¤redisä¼šå¼€å¯RDBæŒä¹…åŒ– å¤‡ä»½æ–‡ä»¶çš„åç§° dbfilename dump.rdb å¤‡ä»½æ–‡ä»¶å­˜æ”¾è·¯å¾„ dir /var/lib/redis Redisçš„SAVEå‘½ä»¤å’ŒBGSAVEå‘½ä»¤ç”¨äºå°†å½“å‰æ•°æ®åº“å¤‡ä»½ 127.0.0.1:6379\u003e save #æ•°æ®é‡å¤§çš„è¯cpuä¼šçˆ†ç‚¸ OK 127.0.0.1:6379\u003e bgsave #å»ºè®®ä½¿ç”¨è¿™ä¸ª Background saving started SAVEå’ŒBGSAVEå‘½ä»¤çš„åŒºåˆ«åœ¨äºï¼šSAVEå‘½ä»¤æ˜¯é˜»å¡ä¸»è¿›ç¨‹ï¼Œsaveæ“ä½œå®Œæˆä¹‹åï¼Œä¸»è¿›ç¨‹æ‰å¼€å§‹å·¥ä½œï¼Œå®¢æˆ·ç«¯å¯ä»¥è¿æ¥ï¼›BGSAVEå‘½ä»¤æ˜¯forkä¸€ä¸ªä¸“é—¨saveçš„å­è¿›ç¨‹ï¼Œæ­¤æ“ä½œä¸ä¼šå½±å“ä¸»è¿›ç¨‹ æ³¨ï¼šSAVEåªæ˜¯å°†å½“å‰çš„æ•°æ®åº“å¤‡ä»½ï¼Œå¤‡ä»½æ–‡ä»¶åé»˜è®¤ä¸ºdump.rdb,å¯é€šè¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹å¤‡ä»½æ–‡ä»¶å dbfilename xxx.rdbï¼ˆå‘ç°ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœè¦å¯¹å¤šä¸ªæ•°æ®åº“è¿›è¡Œå¤‡ä»½ï¼Œé‚£ä¹ˆæœ€ç»ˆåªèƒ½å¤‡ä»½æœ€åä¸€ä¸ªæ•°æ®åº“ï¼Œå› ä¸ºdump.rdbæ–‡ä»¶ä¼šç›¸äº’è¦†ç›–ï¼‰ æ¢å¤ å°†å¤‡ä»½çš„RDBæ–‡ä»¶ï¼Œcpåˆ°è¦æ¢å¤çš„redisæŒ‡å®šç›®å½•ï¼Œé‡å¯Rediså³å¯è‡ªåŠ¨è¯»å–æŒä¹…åŒ–æ–‡ä»¶ï¼Œè‡ªåŠ¨æ¢å¤æ•°æ® å¤‡ä»½çš„RDBæ–‡ä»¶ï¼š é€šè¿‡å‘½ä»¤redis 127.0.0.1:6379\u003e CONFIG GET diræŸ¥çœ‹æ‰§è¡ŒSAVEå‘½ä»¤ä¹‹åï¼Œredisé»˜è®¤å­˜æ”¾å¤‡ä»½æ–‡ä»¶çš„ç›®å½•ï¼›é€šè¿‡å‘½ä»¤redis 127.0.0.1:6379\u003e CONFIG GET dbfilenameæŸ¥çœ‹å¤‡ä»½RDBæ–‡ä»¶çš„æ–‡ä»¶åç§°ï¼› root@pa6:~# redis-cli 127.0.0.1:6379\u003e CONFIG GET dir 1) \"dir\" 2) \"/var/lib/redis\" 127.0.0.1:6379\u003e CONFIG GET dbfilename 1) \"dbfilename\" 2) \"dump.rdb\" AOFæŒä¹…åŒ–å®ç° å¤‡ä»½è¿‡ç¨‹åˆ†ä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µ å‘½ä»¤ä¼ æ’­ï¼š Rediså°†æ‰§è¡Œå®Œçš„å‘½ä»¤ã€å‘½ä»¤å‚æ•°ç­‰ä¿¡æ¯å‘é€åˆ°AOFç¨‹åº ç¼“å­˜è¿½åŠ ï¼š AOFç¨‹åºå°†æ¥æ”¶åˆ°çš„å‘½ä»¤å†…å®¹è¿½åŠ åˆ°æœåŠ¡å™¨çš„AOFç¼“å­˜ä¸­ æ–‡ä»¶å†™å…¥å’Œä¿å­˜ï¼š AOFç¼“å­˜ä¸­çš„å†…å®¹è¢«å†™å…¥åˆ°AOFæ–‡ä»¶æœ«å°¾ï¼Œå¦‚æœæ»¡è¶³AOFä¿å­˜æ¡ä»¶ï¼Œå†™å…¥çš„å†…å®¹ä¼šçœŸæ­£ä¿å­˜åˆ°ç£ç›˜ä¸­ è¿›è¡ŒAOFå¤‡ä»½ é¦–å…ˆå¼€å¯AOFåŠŸèƒ½ #æ­¤é€‰é¡¹ä¸ºaofåŠŸèƒ½çš„å¼€å…³ï¼Œé»˜è®¤ä¸ºâ€œnoâ€ï¼Œé€šè¿‡â€œyesâ€æ¥å¼€å¯aofåŠŸèƒ½ appendonly yes #æŒ‡å®šaofæ–‡ä»¶åç§° appendfilename appendonly.aof #å¤‡ä»½æ–‡ä»¶å­˜æ”¾è·¯å¾„ï¼ˆæ­¤å‚æ•°åŒæ ·é€‚ç”¨äºæŒ‡å®šRDBå¤‡ä»½æ–‡ä»¶å­˜æ”¾è·¯å¾„ï¼‰ dir /var/lib/redis ","date":"2024-08-11","objectID":"/posts/2024-08-31-redis/:1:7","tags":["redis"],"title":"redis","uri":"/posts/2024-08-31-redis/"},{"categories":["DevOps"],"content":"äºŒè€…ä¼˜ç¼ºç‚¹ RDBæŒä¹…åŒ– ä¼˜ç‚¹ï¼š RDBæ–¹å¼å¤‡ä»½ï¼Œæ•´ä¸ªRedisæ•°æ®åº“æœ€ç»ˆå¤‡ä»½æˆä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™å¯¹äºæ–‡ä»¶å¤‡ä»½è€Œè¨€æ˜¯å®Œç¾çš„ï¼ˆæ–¹ä¾¿ç®¡ç†ã€è¿˜åŸã€å‹ç¼©ã€è½¬å‚¨ï¼‰ å¯¹æœåŠ¡è¿›ç¨‹å½±å“æœ€å°ï¼Œå”¯ä¸€éœ€è¦åšçš„æ˜¯forkå‡ºå­è¿›ç¨‹ï¼Œä¹‹åæ‰€æœ‰çš„æŒä¹…åŒ–å·¥ä½œäº¤ç”±å­è¿›ç¨‹å¤„ç† ç›¸æ¯”äºAOFæœºåˆ¶ï¼Œå¦‚æœæ•°æ®é‡æ¯”è¾ƒå¤§ï¼ŒRDBçš„å¯åŠ¨æ•ˆç‡ä¼šæ›´é«˜ï¼ˆè®°å½•çš„æ˜¯æºæ•°æ®ï¼Œè€Œéæ•°æ®æ“ä½œï¼‰ ç¼ºç‚¹ï¼š æ•°æ®çš„å¯ç”¨æ€§å¾—ä¸åˆ°å¤ªå¤§çš„ä¿éšœï¼Œå¦‚æœåœ¨å®šæ—¶æŒä¹…åŒ–ä¹‹å‰å‡ºç°å®•æœºç°è±¡ï¼Œæ­¤å‰æ²¡æ¥å¾—åŠå†™å…¥ç£ç›˜çš„æ•°æ®éƒ½å°†ä¸¢å¤± å¦‚æœæ•°æ®é‡è¾ƒå¤§ï¼Œforkå­è¿›ç¨‹çš„æ“ä½œå¯èƒ½ä¼šä½¿æœåŠ¡çŸ­æš‚åœæ­¢ï¼ˆé€šå¸¸æ˜¯å‡ ç™¾æ¯«ç§’ï¼‰ AOFæŒä¹…åŒ– ä¼˜ç‚¹ï¼š æ‹¥æœ‰æ›´é«˜çš„æ•°æ®å¯ç”¨æ€§ï¼Œæ•°æ®æŒä¹…åŒ–æœ€å®Œæ•´ æ—¥å¿—æ–‡ä»¶é‡‡ç”¨appendæ¨¡å¼ï¼Œå³ä½¿åœ¨å†™å…¥è¿‡ç¨‹ä¸­å‡ºç°å®•æœºç°è±¡ï¼Œä¹Ÿä¸ä¼šç ´åæ—¥å¿—æ–‡ä»¶ä¹‹å‰å·²ç»å­˜åœ¨çš„å†…å®¹ æä¾›rewriteæœºåˆ¶ï¼Œå½“æ—¥å¿—è¿‡å¤§æ—¶ï¼ŒRedisä»¥appendæ¨¡å¼ä¸æ–­å°†ä¿®æ”¹çš„æ—¥å¿—å†™å…¥è€çš„ç£ç›˜æ–‡ä»¶ï¼ŒåŒæ—¶Redisè¿˜ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ç”¨äºè®°å½•æ­¤æœŸé—´æœ‰å“ªäº›å‘½ä»¤è¢«æ‰§è¡Œ ç¼ºç‚¹ï¼š å¯¹äºç›¸åŒæ•°é‡çš„æ•°æ®ï¼ŒAOFæ–‡ä»¶é€šå¸¸å¤§äºRDBæ–‡ä»¶ï¼ŒRDBæ–‡ä»¶åœ¨æ¢å¤å¤§æ•°æ®é›†çš„é€Ÿåº¦æ¯”AOFæ¢å¤çš„æ›´å¿«ï¼ˆRDBçœå»äº†æ‰§è¡Œçš„æ­¥éª¤ï¼Œç›´æ¥å¯¼å…¥æºæ•°æ®ï¼‰ æ€»ç»“ RDBæŒä¹…åŒ–ï¼Œæ€§èƒ½æ›´å¥½ï¼ˆæ‰€æœ‰æ“ä½œå‡ç”±å­è¿›ç¨‹å¤„ç†ï¼Œä¸»è¿›ç¨‹ä¸è¿›è¡Œä»»ä½•IOæ“ä½œï¼‰ï¼Œæ•°æ®ä¸€è‡´æ€§ä¸€èˆ¬ã€‚ AOFæŒä¹…åŒ–ï¼Œæ•°æ®ä¸€è‡´æ€§æ›´å¥½ï¼Œæ€§èƒ½ä¸€èˆ¬ï¼ˆè®°å½•æ“ä½œæ—¥å¿—ï¼Œå†™å…¥æ—¥å¿—å’Œæ‰§è¡Œæ—¥å¿—æ¢å¤æ•°æ®çš„æ—¶é—´éƒ½æ¯”RDBæ›´é•¿ï¼‰ã€‚ Redis æ¢å¤çš„æœºåˆ¶ å¦‚æœåªé…ç½® AOF ï¼Œé‡å¯æ—¶åŠ è½½ AOF æ–‡ä»¶æ¢å¤æ•°æ®ï¼› å¦‚æœåŒæ—¶é…ç½®äº† RDB å’Œ AOF ï¼Œå¯åŠ¨æ˜¯åªåŠ è½½ AOF æ–‡ä»¶æ¢å¤æ•°æ®ï¼› å¦‚æœåªé…ç½® RDBï¼Œå¯åŠ¨æ˜¯å°†åŠ è½½ dump æ–‡ä»¶æ¢å¤æ•°æ®ã€‚ #!/bin/bash # é¿å…é€ æˆé›ªå´© set -e # bak ç›®å½• BACKUPDIR=/data/redis/backup #PASSWD='rediså¯†ç ' #DATADIR=`/usr/local/bin/redis-cli -p ç«¯å£ -a \"$PASSWD\" config get dir|grep -Ev 'dir|grep'` # è·å–redis-cli äºŒè¿›åˆ¶æ–‡ä»¶ REDIS_CMD=$(which redis-cli) DATADIR=`$REDIS_CMD config get dir|grep -Ev 'dir|grep'` DATE=`date +'%Y-%m-%d-%H-%M'` BACKUPDIR_DATE=$BACKUPDIR_$DATE if [ ! -d $BACKUPDIR ];then mkdir -p $BACKUPDIR \\ || echo \"can't make dir !!!\" \\ \u0026\u0026 exit 1 fi #ä»¥æ—¥æœŸåˆ†ç±» mkdir -p $BACKUPDIR/$BACKUPDIR_DATE $REDIS_CMD bgsave sleep 3 cp -rf $DATADIR/* $BACKUPDIR/$BACKUPDIR_DATE ","date":"2024-08-11","objectID":"/posts/2024-08-31-redis/:1:8","tags":["redis"],"title":"redis","uri":"/posts/2024-08-31-redis/"},{"categories":["DevOps"],"content":"redis é›†ç¾¤ é«˜å¯ç”¨æ€§ï¼šRedisé›†ç¾¤å¯ä»¥åœ¨æŸä¸ªèŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œè‡ªåŠ¨è¿›è¡Œæ•…éšœè½¬ç§»ï¼Œä¿è¯æœåŠ¡çš„æŒç»­å¯ç”¨ã€‚ è´Ÿè½½å‡è¡¡ï¼šRedisé›†ç¾¤å¯ä»¥å°†å®¢æˆ·ç«¯è¯·æ±‚åˆ†å‘åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œæœ‰æ•ˆåœ°åˆ†æ‘ŠèŠ‚ç‚¹çš„å‹åŠ›ï¼Œæé«˜ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚ å®¹ç¾æ¢å¤ï¼šé€šè¿‡ä¸»ä»å¤åˆ¶æˆ–å“¨å…µæ¨¡å¼ï¼ŒRedisé›†ç¾¤å¯ä»¥åœ¨ä¸»èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œå¿«é€Ÿåˆ‡æ¢åˆ°ä»èŠ‚ç‚¹ï¼Œå®ç°ä¸šåŠ¡çš„æ— ç¼åˆ‡æ¢ã€‚ æ•°æ®åˆ†ç‰‡ï¼šåœ¨Clusteræ¨¡å¼ä¸‹ï¼ŒRedisé›†ç¾¤å¯ä»¥å°†æ•°æ®åˆ†æ•£åœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œä»è€Œçªç ´å•èŠ‚ç‚¹å†…å­˜é™åˆ¶ï¼Œå®ç°æ›´å¤§è§„æ¨¡çš„æ•°æ®å­˜å‚¨ã€‚ æ˜“äºæ‰©å±•ï¼šRedisé›†ç¾¤å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚å’Œç³»ç»Ÿè´Ÿè½½ï¼ŒåŠ¨æ€åœ°æ·»åŠ æˆ–ç§»é™¤èŠ‚ç‚¹ï¼Œå®ç°æ°´å¹³æ‰©å±•ã€‚ æ¨¡å¼ï¼š ä¸»ä» å“¨å…µ cluster ","date":"2024-08-11","objectID":"/posts/2024-08-31-redis/:2:0","tags":["redis"],"title":"redis","uri":"/posts/2024-08-31-redis/"},{"categories":["DevOps"],"content":"ä¸»ä»å¤åˆ¶ ä¸»ä»å¤åˆ¶æ˜¯Redisçš„ä¸€ç§åŸºæœ¬é›†ç¾¤æ¨¡å¼ï¼Œå®ƒé€šè¿‡å°†ä¸€ä¸ªRedisèŠ‚ç‚¹ï¼ˆä¸»èŠ‚ç‚¹ï¼‰çš„æ•°æ®å¤åˆ¶åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªå…¶ä»–RedisèŠ‚ç‚¹ï¼ˆä»èŠ‚ç‚¹ï¼‰æ¥å®ç°æ•°æ®çš„å†—ä½™å’Œå¤‡ä»½ã€‚ ä¸»èŠ‚ç‚¹è´Ÿè´£å¤„ç†å®¢æˆ·ç«¯çš„å†™æ“ä½œï¼ŒåŒæ—¶ä»èŠ‚ç‚¹ä¼šå®æ—¶åŒæ­¥ä¸»èŠ‚ç‚¹çš„æ•°æ®ã€‚å®¢æˆ·ç«¯å¯ä»¥ä»ä»èŠ‚ç‚¹è¯»å–æ•°æ®ï¼Œå®ç°è¯»å†™åˆ†ç¦»ï¼Œæé«˜ç³»ç»Ÿæ€§èƒ½ã€‚ ä¸€ä¸ªä¸»èŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªä»èŠ‚ç‚¹ï¼Œä¸€ä¸ªrediså¯ä»¥å³æ˜¯ä¸»åˆæ˜¯ä»ï¼Œç±»ä¼¼æ ‘çŠ¶ç»“æ„ é…ç½®ï¼š 1ï¼‰é…ç½®ä¸»èŠ‚ç‚¹ï¼šåœ¨ä¸»èŠ‚ç‚¹çš„redis.confé…ç½®æ–‡ä»¶ä¸­ï¼Œæ— éœ€è¿›è¡Œç‰¹æ®Šé…ç½®ï¼Œä¸»èŠ‚ç‚¹é»˜è®¤ç›‘å¬æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚ã€‚ # ä¸»èŠ‚ç‚¹é»˜è®¤ç«¯å£å·6379 port 6379 2ï¼‰é…ç½®ä»èŠ‚ç‚¹ï¼šåœ¨ä»èŠ‚ç‚¹çš„redis.confé…ç½®æ–‡ä»¶ä¸­ï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®ï¼ŒæŒ‡å®šä¸»èŠ‚ç‚¹çš„åœ°å€å’Œç«¯å£ï¼š # ä»èŠ‚ç‚¹è®¾ç½®ç«¯å£å·6380 port 6380 # replicaof ä¸»èŠ‚ç‚¹IP ä¸»èŠ‚ç‚¹ç«¯å£ replicaof 127.0.0.1 6379 æˆ–è€…ï¼Œé€šè¿‡Rediså‘½ä»¤è¡Œåœ¨ä»èŠ‚ç‚¹ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š redis\u003e replicaof 127.0.0.1 6379 3ï¼‰éªŒè¯ä¸»ä»å¤åˆ¶ï¼šåœ¨ä¸»èŠ‚ç‚¹ä¸Šæ‰§è¡Œå†™æ“ä½œï¼Œç„¶ååœ¨ä»èŠ‚ç‚¹ä¸Šè¿›è¡Œè¯»æ“ä½œï¼Œæ£€æŸ¥æ•°æ®æ˜¯å¦ä¸€è‡´ã€‚ ä¸»ä»å¤åˆ¶çš„ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š é…ç½®ç®€å•ï¼Œæ˜“äºå®ç°ã€‚ å®ç°æ•°æ®å†—ä½™ï¼Œæé«˜æ•°æ®å¯é æ€§ã€‚ è¯»å†™åˆ†ç¦»ï¼Œæé«˜ç³»ç»Ÿæ€§èƒ½ã€‚ ç¼ºç‚¹ï¼š ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œéœ€è¦æ‰‹åŠ¨åˆ‡æ¢åˆ°ä»èŠ‚ç‚¹ï¼Œæ•…éšœæ¢å¤æ—¶é—´è¾ƒé•¿ã€‚ ä¸»èŠ‚ç‚¹æ‰¿æ‹…æ‰€æœ‰å†™æ“ä½œï¼Œå¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚ æ— æ³•å®ç°æ•°æ®åˆ†ç‰‡ï¼Œå—å•èŠ‚ç‚¹å†…å­˜é™åˆ¶ã€‚ ä¸»ä»å¤åˆ¶åœºæ™¯åº”ç”¨ ä¸»ä»å¤åˆ¶æ¨¡å¼é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š æ•°æ®å¤‡ä»½å’Œå®¹ç¾æ¢å¤ï¼šé€šè¿‡ä»èŠ‚ç‚¹å¤‡ä»½ä¸»èŠ‚ç‚¹çš„æ•°æ®ï¼Œå®ç°æ•°æ®å†—ä½™ã€‚ è¯»å†™åˆ†ç¦»ï¼šå°†è¯»æ“ä½œåˆ†å‘åˆ°ä»èŠ‚ç‚¹ï¼Œå‡è½»ä¸»èŠ‚ç‚¹å‹åŠ›ï¼Œæé«˜ç³»ç»Ÿæ€§èƒ½ã€‚ åœ¨çº¿å‡çº§å’Œæ‰©å±•ï¼šåœ¨ä¸å½±å“ä¸»èŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡å¢åŠ ä»èŠ‚ç‚¹æ¥æ‰©å±•ç³»ç»Ÿçš„è¯»å–èƒ½åŠ›ã€‚ æ€»ç»“ï¼šä¸»ä»å¤åˆ¶æ¨¡å¼é€‚åˆæ•°æ®å¤‡ä»½ã€è¯»å†™åˆ†ç¦»å’Œåœ¨çº¿å‡çº§ç­‰åœºæ™¯ï¼Œä½†åœ¨ä¸»èŠ‚ç‚¹æ•…éšœæ—¶éœ€è¦æ‰‹åŠ¨åˆ‡æ¢ï¼Œä¸èƒ½è‡ªåŠ¨å®ç°æ•…éšœè½¬ç§»ã€‚å¦‚æœå¯¹é«˜å¯ç”¨æ€§è¦æ±‚è¾ƒé«˜ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å“¨å…µæ¨¡å¼æˆ–Clusteræ¨¡å¼ã€‚ ","date":"2024-08-11","objectID":"/posts/2024-08-31-redis/:2:1","tags":["redis"],"title":"redis","uri":"/posts/2024-08-31-redis/"},{"categories":["DevOps"],"content":"å“¨å…µæ¨¡å¼ Sentinel å“¨å…µæ¨¡å¼æ˜¯åœ¨ä¸»ä»å¤åˆ¶åŸºç¡€ä¸ŠåŠ å…¥äº†å“¨å…µèŠ‚ç‚¹ï¼Œå®ç°äº†è‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚å“¨å…µèŠ‚ç‚¹æ˜¯ä¸€ç§ç‰¹æ®Šçš„RedisèŠ‚ç‚¹ï¼Œå®ƒä¼šç›‘æ§ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹çš„è¿è¡ŒçŠ¶æ€ã€‚å½“ä¸»èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œå“¨å…µèŠ‚ç‚¹ä¼šè‡ªåŠ¨ä»ä»èŠ‚ç‚¹ä¸­é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¹¶é€šçŸ¥å…¶ä»–ä»èŠ‚ç‚¹å’Œå®¢æˆ·ç«¯ï¼Œå®ç°æ•…éšœè½¬ç§»ã€‚ å“¨å…µæ¨¡å¼é…ç½®å’Œå®ç° é…ç½®ä¸»ä»å¤åˆ¶ï¼šé¦–å…ˆæŒ‰ç…§ä¸»ä»å¤åˆ¶æ¨¡å¼çš„é…ç½®æ–¹æ³•ï¼Œæ­å»ºä¸€ä¸ªä¸»ä»å¤åˆ¶é›†ç¾¤ï¼ˆä¸Šé¢å·²ç»è®²è¿‡ï¼‰ã€‚ é…ç½®å“¨å…µèŠ‚ç‚¹ï¼šåœ¨å“¨å…µèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„å“¨å…µé…ç½®æ–‡ä»¶ï¼ˆå¦‚ï¼šsentinel.confï¼‰ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š # sentinelèŠ‚ç‚¹ç«¯å£å· port 26379 # sentinel monitor è¢«ç›‘æ§ä¸»èŠ‚ç‚¹åç§° ä¸»èŠ‚ç‚¹IP ä¸»èŠ‚ç‚¹ç«¯å£ quorum sentinel monitor mymaster 127.0.0.1 6379 2 # sentinel down-after-milliseconds è¢«ç›‘æ§ä¸»èŠ‚ç‚¹åç§° æ¯«ç§’æ•° sentinel down-after-milliseconds mymaster 60000 # sentinel failover-timeout è¢«ç›‘æ§ä¸»èŠ‚ç‚¹åç§° æ¯«ç§’æ•° sentinel failover-timeout mymaster 180000 å…¶ä¸­ï¼Œquorumæ˜¯æŒ‡è§¦å‘æ•…éšœè½¬ç§»æ‰€éœ€çš„æœ€å°å“¨å…µèŠ‚ç‚¹æ•°ã€‚down-after-millisecondsè¡¨ç¤ºä¸»èŠ‚ç‚¹è¢«åˆ¤æ–­ä¸ºå¤±æ•ˆçš„æ—¶é—´ã€‚failover-timeoutæ˜¯æ•…éšœè½¬ç§»è¶…æ—¶æ—¶é—´ã€‚ ä¸ºä»€ä¹ˆåªé…ç½®äº†sentinelç›‘æ§ä¸»èŠ‚ç‚¹ï¼Œæ²¡æœ‰é…ç½®ç›‘æ§ä»èŠ‚ç‚¹ï¼Ÿ å› ä¸ºé€šè¿‡ä¸»èŠ‚ç‚¹ï¼Œå°±å¯ä»¥æ‰¾åˆ°ä»èŠ‚ç‚¹ã€‚ å¯åŠ¨å“¨å…µèŠ‚ç‚¹ï¼šä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨å“¨å…µèŠ‚ç‚¹ï¼š redis\u003e redis-sentinel /path/to/sentinel.conf éªŒè¯å“¨å…µæ¨¡å¼ï¼šæ‰‹åŠ¨åœæ­¢ä¸»èŠ‚ç‚¹ï¼Œè§‚å¯Ÿå“¨å…µèŠ‚ç‚¹æ˜¯å¦è‡ªåŠ¨é€‰ä¸¾å‡ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¹¶é€šçŸ¥å…¶ä»–ä»èŠ‚ç‚¹å’Œå®¢æˆ·ç«¯ã€‚ å“¨å…µæ¨¡å¼çš„ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œæé«˜ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ã€‚ å…·æœ‰ä¸»ä»å¤åˆ¶æ¨¡å¼çš„æ‰€æœ‰ä¼˜ç‚¹ï¼Œå¦‚æ•°æ®å†—ä½™å’Œè¯»å†™åˆ†ç¦»ã€‚ ç¼ºç‚¹ï¼š é…ç½®å’Œç®¡ç†ç›¸å¯¹å¤æ‚ã€‚ ä¾ç„¶æ— æ³•å®ç°æ•°æ®åˆ†ç‰‡ï¼Œå—å•èŠ‚ç‚¹å†…å­˜é™åˆ¶ã€‚ å“¨å…µæ¨¡å¼åœºæ™¯åº”ç”¨ å“¨å…µæ¨¡å¼é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š é«˜å¯ç”¨æ€§è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ï¼šé€šè¿‡è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œç¡®ä¿æœåŠ¡çš„æŒç»­å¯ç”¨ã€‚ æ•°æ®å¤‡ä»½å’Œå®¹ç¾æ¢å¤ï¼šåœ¨ä¸»ä»å¤åˆ¶çš„åŸºç¡€ä¸Šï¼Œæä¾›è‡ªåŠ¨æ•…éšœè½¬ç§»åŠŸèƒ½ã€‚ æ€»ç»“ï¼šå“¨å…µæ¨¡å¼åœ¨ä¸»ä»å¤åˆ¶æ¨¡å¼çš„åŸºç¡€ä¸Šå®ç°äº†è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œæé«˜äº†ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ã€‚ç„¶è€Œï¼Œå®ƒä»ç„¶æ— æ³•å®ç°æ•°æ®åˆ†ç‰‡ã€‚å¦‚æœéœ€è¦å®ç°æ•°æ®åˆ†ç‰‡å’Œè´Ÿè½½å‡è¡¡ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨Clusteræ¨¡å¼ã€‚ ","date":"2024-08-11","objectID":"/posts/2024-08-31-redis/:2:2","tags":["redis"],"title":"redis","uri":"/posts/2024-08-31-redis/"},{"categories":["DevOps"],"content":"Clusteræ¨¡å¼ Clusteræ¨¡å¼åŸç† Clusteræ¨¡å¼æ˜¯Redisçš„ä¸€ç§é«˜çº§é›†ç¾¤æ¨¡å¼ï¼Œå®ƒé€šè¿‡æ•°æ®åˆ†ç‰‡å’Œåˆ†å¸ƒå¼å­˜å‚¨å®ç°äº†è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨æ€§ã€‚åœ¨Clusteræ¨¡å¼ä¸‹ï¼ŒRediså°†æ‰€æœ‰çš„é”®å€¼å¯¹æ•°æ®åˆ†æ•£åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šã€‚æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†æ•°æ®ï¼Œç§°ä¸ºæ§½ä½ã€‚é€šè¿‡å¯¹æ•°æ®çš„åˆ†ç‰‡ï¼ŒClusteræ¨¡å¼å¯ä»¥çªç ´å•èŠ‚ç‚¹çš„å†…å­˜é™åˆ¶ï¼Œå®ç°æ›´å¤§è§„æ¨¡çš„æ•°æ®å­˜å‚¨ã€‚ æ•°æ®åˆ†ç‰‡ä¸æ§½ä½ Redis Clusterå°†æ•°æ®åˆ†ä¸º16384ä¸ªæ§½ä½ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ç®¡ç†ä¸€éƒ¨åˆ†æ§½ä½ã€‚å½“å®¢æˆ·ç«¯å‘Redis Clusterå‘é€è¯·æ±‚æ—¶ï¼ŒClusterä¼šæ ¹æ®é”®çš„å“ˆå¸Œå€¼å°†è¯·æ±‚è·¯ç”±åˆ°ç›¸åº”çš„èŠ‚ç‚¹ã€‚å…·ä½“æ¥è¯´ï¼ŒRedis Clusterä½¿ç”¨CRC16ç®—æ³•è®¡ç®—é”®çš„å“ˆå¸Œå€¼ï¼Œç„¶åå¯¹16384å–æ¨¡ï¼Œå¾—åˆ°æ§½ä½ç¼–å·ã€‚ Clusteræ¨¡å¼é…ç½®å’Œå®ç° é…ç½®RedisèŠ‚ç‚¹ï¼šä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªredis.confé…ç½®æ–‡ä»¶ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š # clusterèŠ‚ç‚¹ç«¯å£å· port 7001 # å¼€å¯é›†ç¾¤æ¨¡å¼ cluster-enabled yes # èŠ‚ç‚¹è¶…æ—¶æ—¶é—´ cluster-node-timeout 15000 åƒè¿™æ ·çš„é…ç½®ï¼Œä¸€å…±éœ€è¦åˆ›å»º6ä¸ªï¼Œæˆ‘ä»¬åšä¸€ä¸ªä¸‰ä¸»ä¸‰ä»çš„é›†ç¾¤ã€‚ å¯åŠ¨RedisèŠ‚ç‚¹ï¼šä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨6ä¸ªèŠ‚ç‚¹ï¼š redis\u003e redis-server redis_7001.conf åˆ›å»ºRedis Clusterï¼šä½¿ç”¨Rediså‘½ä»¤è¡Œå·¥å…·æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤åˆ›å»ºClusterï¼š redis\u003e redis-cli --cluster create 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 127.0.0.1:7006 --cluster-replicas 1 cluster-replicas è¡¨ç¤ºä»èŠ‚ç‚¹çš„æ•°é‡ï¼Œ1ä»£è¡¨æ¯ä¸ªä¸»èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªä»èŠ‚ç‚¹ã€‚ éªŒè¯Clusteræ¨¡å¼ï¼šå‘Clusterå‘é€è¯·æ±‚ï¼Œè§‚å¯Ÿè¯·æ±‚æ˜¯å¦æ­£ç¡®è·¯ç”±åˆ°ç›¸åº”çš„èŠ‚ç‚¹ã€‚ Clusteræ¨¡å¼çš„ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š æ•°æ®åˆ†ç‰‡ï¼Œå®ç°å¤§è§„æ¨¡æ•°æ®å­˜å‚¨ã€‚ è´Ÿè½½å‡è¡¡ï¼Œæé«˜ç³»ç»Ÿæ€§èƒ½ã€‚ è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œæé«˜é«˜å¯ç”¨æ€§ã€‚ ç¼ºç‚¹ï¼š é…ç½®å’Œç®¡ç†è¾ƒå¤æ‚ã€‚ ä¸€äº›å¤æ‚çš„å¤šé”®æ“ä½œå¯èƒ½å—åˆ°é™åˆ¶ã€‚ Clusteræ¨¡å¼åœºæ™¯åº”ç”¨ Clusteræ¨¡å¼é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š å¤§è§„æ¨¡æ•°æ®å­˜å‚¨ï¼šé€šè¿‡æ•°æ®åˆ†ç‰‡ï¼Œçªç ´å•èŠ‚ç‚¹å†…å­˜é™åˆ¶ã€‚ é«˜æ€§èƒ½è¦æ±‚åœºæ™¯ï¼šé€šè¿‡è´Ÿè½½å‡è¡¡ï¼Œæé«˜ç³»ç»Ÿæ€§èƒ½ã€‚ é«˜å¯ç”¨æ€§è¦æ±‚åœºæ™¯ï¼šé€šè¿‡è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œç¡®ä¿æœåŠ¡çš„æŒç»­å¯ç”¨ã€‚ æ€»ç»“ï¼šClusteræ¨¡å¼åœ¨æä¾›é«˜å¯ç”¨æ€§çš„åŒæ—¶ï¼Œå®ç°äº†æ•°æ®åˆ†ç‰‡å’Œè´Ÿè½½å‡è¡¡ï¼Œé€‚ç”¨äºå¤§è§„æ¨¡æ•°æ®å­˜å‚¨å’Œé«˜æ€§èƒ½è¦æ±‚çš„åœºæ™¯ã€‚ç„¶è€Œï¼Œå®ƒçš„é…ç½®å’Œç®¡ç†ç›¸å¯¹å¤æ‚ï¼Œä¸”æŸäº›å¤æ‚çš„å¤šé”®æ“ä½œå¯èƒ½å—åˆ°é™åˆ¶ã€‚ ","date":"2024-08-11","objectID":"/posts/2024-08-31-redis/:2:3","tags":["redis"],"title":"redis","uri":"/posts/2024-08-31-redis/"},{"categories":["DevOps"],"content":"æ¨¡å¼é€‰æ‹© ä¸»ä»å¤åˆ¶æ¨¡å¼ï¼šé€‚ç”¨äºæ•°æ®å¤‡ä»½å’Œè¯»å†™åˆ†ç¦»åœºæ™¯ï¼Œé…ç½®ç®€å•ï¼Œä½†åœ¨ä¸»èŠ‚ç‚¹æ•…éšœæ—¶éœ€è¦æ‰‹åŠ¨åˆ‡æ¢ã€‚ å“¨å…µæ¨¡å¼ï¼šåœ¨ä¸»ä»å¤åˆ¶çš„åŸºç¡€ä¸Šå®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œæé«˜é«˜å¯ç”¨æ€§ï¼Œé€‚ç”¨äºé«˜å¯ç”¨æ€§è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ã€‚ Clusteræ¨¡å¼ï¼šé€šè¿‡æ•°æ®åˆ†ç‰‡å’Œè´Ÿè½½å‡è¡¡å®ç°å¤§è§„æ¨¡æ•°æ®å­˜å‚¨å’Œé«˜æ€§èƒ½ï¼Œé€‚ç”¨äºå¤§è§„æ¨¡æ•°æ®å­˜å‚¨å’Œé«˜æ€§èƒ½è¦æ±‚åœºæ™¯ã€‚ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯ä»¥æ ¹æ®ç³»ç»Ÿçš„éœ€æ±‚å’Œç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„Redisé›†ç¾¤æ¨¡å¼ï¼Œä»¥å®ç°é«˜å¯ç”¨æ€§ã€é«˜æ€§èƒ½å’Œå¤§è§„æ¨¡æ•°æ®å­˜å‚¨ ","date":"2024-08-11","objectID":"/posts/2024-08-31-redis/:2:4","tags":["redis"],"title":"redis","uri":"/posts/2024-08-31-redis/"},{"categories":["DevOps"],"content":"è…¾è®¯äº‘è½»é‡ä¼˜åŒ– #!/bin/bash #fuck tx process rm -rf /usr/local/sa rm -rf /usr/local/agenttools rm -rf /usr/local/qcloud process=(sap100 secu-tcs-agent sgagent64 barad_agent agent agentPlugInD pvdriver ) for i in ${process[@]} do for A in $(ps aux |grep $i |grep -v grep |awk '{print $2}') do kill -9 $A done done chkconfig --level 35 postfix off service postfix stop echo ''\u003e/var/spool/cron/root echo '#!/bin/bash' \u003e/etc/rc.local ","date":"2024-08-11","objectID":"/posts/2024-08-29-other/:1:0","tags":["handbook"],"title":"æ‰‹å†Œ","uri":"/posts/2024-08-29-other/"},{"categories":["DevOps"],"content":"git-code https://github.com/4x99/code6 ","date":"2024-08-11","objectID":"/posts/2024-08-29-other/:2:0","tags":["handbook"],"title":"æ‰‹å†Œ","uri":"/posts/2024-08-29-other/"},{"categories":["DevOps"],"content":"RHELç³»åˆ—å®‰è£…ä¸­æ–‡è¾“å…¥æ³• # å®‰è£…ä¸­æ–‡è¾“å…¥æ³•,å®‰è£…åéœ€è¦é‡å¯ï¼Œç„¶åå†è®¾ç½®è¾“å…¥æ³• yum install ibus-libpinyin ","date":"2024-08-11","objectID":"/posts/2024-08-29-other/:3:0","tags":["handbook"],"title":"æ‰‹å†Œ","uri":"/posts/2024-08-29-other/"},{"categories":["DevOps"],"content":"bitnami chartä½¿ç”¨ # é•œåƒ image: registry: docker.io repository: cmd/search-order tag: v0.0.4 pullSecrets: [\"hub\"] ","date":"2024-08-11","objectID":"/posts/2024-08-29-other/:4:0","tags":["handbook"],"title":"æ‰‹å†Œ","uri":"/posts/2024-08-29-other/"},{"categories":["DevOps"],"content":"Flatpakä½¿ç”¨ # æŸ¥çœ‹å½“å‰çš„remote [root@sugar ~]# flatpak remotes # æœ€æ–¹ä¾¿çš„æ–¹å¼æ·»åŠ è¿œç¨‹ä»“åº“æ˜¯ä½¿ç”¨ .flatpakrepo æ–‡ä»¶ï¼Œå®ƒåŒ…å«è¿œç¨‹ä»“åº“çš„ä¿¡æ¯å’ŒGPGç§˜é’¥ï¼š [root@sugar ~]# flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo # ç§»é™¤è¿œç¨‹ä»“åº“ [root@sugar ~]# flatpak remote-delete flathub # æŸ¥è¯¢è½¯ä»¶ flatpak search gimp # å®‰è£…è½¯ä»¶ flatpak install flathub org.gimp.GIMP $ flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo $ flatpak remote-modify flathub --url=https://mirror.sjtu.edu.cn/flathub # æˆ–è€… $ flatpak remote-add --if-not-exists sjtu https://mirror.sjtu.edu.cn/flathub/flathub.flatpakrepo # å¦‚æœä¸­æ–­äº†æŸæ¬¡å®‰è£…ï¼Œé‡æ–°ä¸‹è½½å¯èƒ½ä¼šå‡ºç°æ‰¾ä¸åˆ°æ–‡ä»¶çš„é—®é¢˜ã€‚å¯ä»¥ä½¿ç”¨ flatpak repair è§£å†³ç›¸å…³çš„é—®é¢˜ã€‚ ","date":"2024-08-11","objectID":"/posts/2024-08-29-other/:5:0","tags":["handbook"],"title":"æ‰‹å†Œ","uri":"/posts/2024-08-29-other/"},{"categories":["DevOps","k8s"],"content":"MetalLB è‡ªå»ºk8sçš„ loadbalancer https://www.lixueduan.com/posts/cloudnative/01-metallb/ https://www.bboy.app/2021/01/11/metallb%E9%83%A8%E7%BD%B2%E4%BD%BF%E7%94%A8/ https://ieevee.com/tech/2019/06/30/metallb.html https://cloud.tencent.com/developer/article/2146391#:~:text=%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85,Metallb%E6%94%AF%E6%8C%81%E9%80%9A%E8%BF%87Kuberntes%E6%B8%85%E5%8D%95%E3%80%81Helm%E5%92%8CKustomize%E6%96%B9%E5%BC%8F%E8%BF%9B%E8%A1%8C%E9%83%A8%E7%BD%B2%EF%BC%8C%E6%9C%AC%E6%96%87%E6%88%91%E4%BB%AC%E5%B0%86%E4%BB%A5Kuberntes%E6%B8%85%E5%8D%95%E4%B8%BA%E4%BE%8B%E4%BB%8B%E7%BB%8D%E4%BA%A7%E5%93%81%E7%9A%84%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85%EF%BC%8C%E9%83%A8%E7%BD%B2%E7%9A%84%E7%89%88%E6%9C%AC%E4%B8%BA%E6%9C%80%E6%96%B0%E7%9A%84v0.13.4%E3%80%82 ç®€ä»‹ åœ¨Kuberneteséƒ¨ç½²å®ŒæˆæœåŠ¡åï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å°†æœåŠ¡å¼€æ”¾ç»™åˆ°å¤–éƒ¨ç”¨æˆ·è®¿é—® ã€‚å¦‚æœæ˜¯ä½¿ç”¨äº‘å¹³å°ï¼ˆé˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€AWSç­‰ï¼‰çš„è¯ï¼Œè¿™ä¸ªéœ€æ±‚å¤„ç†èµ·æ¥éå¸¸ç®€å•ï¼Œå¯ä»¥é€šè¿‡äº‘å¹³å°çš„LoadBalanceræ¥å®ç°ã€‚ ä½†å¦‚æœæ˜¯è‡ªå»ºçš„kubernetesè£¸æœºé›†ç¾¤ï¼Œé‚£åˆ™è¦éº»çƒ¦å¾—å¤šã€‚ç¥¼æœºé›†ç¾¤é»˜è®¤ä¸æ”¯æŒè´Ÿè½½å‡è¡¡çš„æ–¹å¼ï¼Œå¯ç”¨çš„æ–¹æ¡ˆä¸å¤–ä¹Ingressã€NodePortã€ExternalIPsç­‰æ–¹å¼æ¥å®ç°å¤–éƒ¨è®¿é—®ã€‚å¯æƒœè¿™äº›æ–¹æ¡ˆæœ¬èº«å¹¶ä¸å®Œç¾ï¼Œä»–ä»¬æˆ–å¤šæˆ–å°‘éƒ½å­˜åœ¨ç€ä¸€äº›ç¼ºç‚¹ï¼Œè¿™ä½¿å¾—è£¸é‡‘å±é›†ç¾¤æˆä¸ºKubernetesç”Ÿæ€ç³»ç»Ÿä¸­çš„äºŒç­‰å…¬æ°‘ã€‚ è€ŒMetalLB æ—¨åœ¨é€šè¿‡æä¾›ä¸æ ‡å‡†ç½‘ç»œè®¾å¤‡é›†æˆçš„LoadBalanceræ¥è§£å†³è¿™ä¸ªç—›ç‚¹ï¼Œä»è€Œä½¿è£¸æœºç¾¤é›†ä¸Šçš„å¤–éƒ¨æœåŠ¡ä¹Ÿå°½å¯èƒ½â€œæ­£å¸¸è¿è¡Œâ€ï¼Œå‡å°‘è¿ç»´ä¸Šçš„ç®¡ç†æˆæœ¬ã€‚ metallbæ”¯æŒä¸¤ç§å·¥ä½œæ¨¡å¼,ä¸€ç§æ˜¯layer 2 mode,ä¹Ÿå°±æ˜¯å·¥ä½œåœ¨2å±‚æ¥è´Ÿè´£ç›¸åº”arpè¯·æ±‚ï¼Œå¯¹äºå±€åŸŸç½‘ä¸­çš„äººæ¥è¯´ä»¿ä½›å°±æ˜¯ç»™æœåŠ¡åˆ†é…äº†ä¸€ä¸ªipï¼Œä½†æ˜¯2å±‚æ¨¡å¼ä¸æ˜¯çœŸæ­£çš„è´Ÿè½½å‡è¡¡ï¼Œå› ä¸ºæ‰€æœ‰çš„æµé‡ä¼šç»è¿‡é›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå½“è¿™ä¸ªèŠ‚ç‚¹æŒ‚äº†çš„è¯ï¼Œmetallbä¼šè¿ç§»ipåˆ°å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¦å¤–ä¸€ç§æ˜¯bgpæ¨¡å¼ï¼Œåœ¨bgpæ¨¡å¼ä¸‹ï¼Œé›†ç¾¤ä¸­æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¼šå’Œè·¯ç”±å™¨å»ºç«‹bgpä¼šè¯ï¼Œæ‰€ä»¥bgpæ¨¡å¼æ˜¯é«˜å¯ç”¨çš„ï¼Œä½†æ˜¯éœ€è¦ä½ çš„è·¯ç”±å™¨æ”¯æŒbgpã€‚è¿™è¾¹æˆ‘çš„è·¯ç”±å™¨æ˜¯ä¸æ”¯æŒbgpçš„ï¼Œæ‰€ä»¥å°±é‡‡ç”¨äºŒå±‚æ¨¡å¼ Layer 2 æ¨¡å¼ Layer 2æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªserviceä¼šæœ‰é›†ç¾¤ä¸­çš„ä¸€ä¸ªnodeæ¥è´Ÿè´£ã€‚å½“æœåŠ¡å®¢æˆ·ç«¯å‘èµ·ARPè§£æçš„æ—¶å€™ï¼Œå¯¹åº”çš„nodeä¼šå“åº”è¯¥ARPè¯·æ±‚ï¼Œä¹‹åï¼Œè¯¥serviceçš„æµé‡éƒ½ä¼šæŒ‡å‘è¯¥nodeï¼ˆçœ‹ä¸Šå»è¯¥nodeä¸Šæœ‰å¤šä¸ªåœ°å€ï¼‰ã€‚ Layer 2æ¨¡å¼å¹¶ä¸æ˜¯çœŸæ­£çš„è´Ÿè½½å‡è¡¡ï¼Œå› ä¸ºæµé‡éƒ½ä¼šå…ˆç»è¿‡1ä¸ªnodeåï¼Œå†é€šè¿‡kube-proxyè½¬ç»™å¤šä¸ªend pointsã€‚å¦‚æœè¯¥nodeæ•…éšœï¼ŒMetalLBä¼šè¿ç§» IPåˆ°å¦ä¸€ä¸ªnodeï¼Œå¹¶é‡æ–°å‘é€å…è´¹ARPå‘ŠçŸ¥å®¢æˆ·ç«¯è¿ç§»ã€‚ç°ä»£æ“ä½œç³»ç»ŸåŸºæœ¬éƒ½èƒ½æ­£ç¡®å¤„ç†å…è´¹ARPï¼Œå› æ­¤failoverä¸ä¼šäº§ç”Ÿå¤ªå¤§é—®é¢˜ã€‚ Layer 2æ¨¡å¼æ›´ä¸ºé€šç”¨ï¼Œä¸éœ€è¦ç”¨æˆ·æœ‰é¢å¤–çš„è®¾å¤‡ï¼›ä½†ç”±äºLayer 2æ¨¡å¼ä½¿ç”¨ARP/NDï¼Œåœ°å€æ± åˆ†é…éœ€è¦è·Ÿå®¢æˆ·ç«¯åœ¨åŒä¸€å­ç½‘ï¼Œåœ°å€åˆ†é…ç•¥ä¸ºç¹çã€‚ BGPæ¨¡å¼ BGPæ¨¡å¼ä¸‹ï¼Œé›†ç¾¤ä¸­æ‰€æœ‰nodeéƒ½ä¼šè·Ÿä¸Šè”è·¯ç”±å™¨å»ºç«‹BGPè¿æ¥ï¼Œå¹¶ä¸”ä¼šå‘ŠçŸ¥è·¯ç”±å™¨åº”è¯¥å¦‚ä½•è½¬å‘serviceçš„æµé‡ã€‚ BGPæ¨¡å¼æ˜¯çœŸæ­£çš„LoadBalancerã€‚ éƒ¨ç½²è¦æ±‚ MetalLBéƒ¨ç½²éœ€è¦ä»¥ä¸‹ç¯å¢ƒæ‰èƒ½è¿è¡Œï¼š è¿è¡ŒKubernetes 1.13.0æˆ–æ›´é«˜ç‰ˆæœ¬çš„ç¾¤é›†ï¼Œå°šä¸å…·æœ‰ç½‘ç»œè´Ÿè½½å¹³è¡¡åŠŸèƒ½ï¼› ä¸€äº›ç”¨äºMetalLBåˆ†é…çš„IPv4åœ°å€ï¼› å¦‚æœä½¿ç”¨BGPæ¨¡å¼ï¼Œéœ€è¦å‡†å¤‡ä¸€å°æˆ–å¤šå°æ”¯æŒBGPçš„è·¯ç”±å™¨ï¼› å¦‚æœä½¿ç”¨layer 2æ¨¡å¼æ—¶ï¼Œé›†ç¾¤èŠ‚ç‚¹é—´å¿…é¡»å…è®¸7946ç«¯å£çš„è®¿é—® ï¼Œç”¨æˆ·ä»£ç†ä¹‹é—´çš„é€šä¿¡ï¼› é›†ç¾¤çš„ç½‘ç»œç±»å‹éœ€è¦æ”¯æŒMetalLBï¼Œè¯¦è§ä¸‹å›¾ ç½‘ç»œç±»å‹ å…¼å®¹æ€§ Antrea Yes Calico Mostly Canal Yes Cilium Yes Flannel Yes Kube-ovn Yes Kube-router Mostly Weave Net Mostly å·¥ä½œåŸç†ï¼š MetallbåŒ…å«ä¸¤ä¸ªç»„ä»¶ï¼ŒControllerå’ŒSpeakerï¼ŒControllerä¸ºDeploymentéƒ¨ç½²æ–¹å¼ï¼Œè€ŒSpeakeråˆ™é‡‡ç”¨Daemonsetæ–¹å¼éƒ¨ç½²åˆ°é›†ç¾¤å†…éƒ¨å„ä¸ªNodeèŠ‚ç‚¹ã€‚ å…·ä½“çš„å·¥ä½œåŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒControllerè´Ÿè´£ç›‘å¬Serviceå˜åŒ–ï¼Œå½“Serviceé…ç½®ä¸ºLoadBalanceræ¨¡å¼æ—¶ï¼Œä»IPæ± åˆ†é…ç»™åˆ°ç›¸åº”çš„IPåœ°å€å¹¶å¯¹è¯¥IPçš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç®¡ç†ã€‚Speakeråˆ™ä¼šä¾æ®é€‰æ‹©çš„åè®®è¿›è¡Œç›¸åº”çš„å¹¿æ’­æˆ–åº”ç­”ï¼Œå®ç°IPåœ°å€çš„é€šä¿¡å“åº”ã€‚å½“ä¸šåŠ¡æµé‡é€šè¿‡TCP/UDPåè®®åˆ°è¾¾æŒ‡å®šçš„Nodeæ—¶ï¼Œç”±Nodeä¸Šé¢è¿è¡Œçš„Kube-Proxyç»„ä»¶å¯¹æµé‡è¿›è¡Œå¤„ç†ï¼Œå¹¶åˆ†å‘åˆ°å¯¹åº”æœåŠ¡çš„Podä¸Šé¢ã€‚ MetalLBæ”¯æŒä¸¤ç§æ¨¡å¼ï¼Œä¸€ç§æ˜¯Layer2æ¨¡å¼ï¼Œä¸€ç§æ˜¯BGPæ¨¡å¼ã€‚ Layer2æ¨¡å¼ åœ¨2å±‚æ¨¡å¼ä¸‹ï¼ŒMetallbä¼šåœ¨NodeèŠ‚ç‚¹ä¸­é€‰å‡ºä¸€å°ä½œä¸ºLeaderï¼Œä¸æœåŠ¡IPç›¸å…³çš„æ‰€æœ‰æµé‡éƒ½ä¼šæµå‘è¯¥èŠ‚ç‚¹ã€‚åœ¨è¯¥èŠ‚ç‚¹ä¸Šï¼Œ kube-proxyå°†æ¥æ”¶åˆ°çš„æµé‡ä¼ æ’­åˆ°å¯¹åº”æœåŠ¡çš„Podã€‚å½“leaderèŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œä¼šç”±å¦ä¸€ä¸ªèŠ‚ç‚¹æ¥ç®¡ã€‚ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œ2å±‚æ¨¡å¼æ›´åƒæ˜¯é«˜å¯ç”¨ï¼Œè€Œä¸æ˜¯è´Ÿè½½å‡è¡¡ï¼Œå› ä¸ºåŒæ—¶åªèƒ½åœ¨ä¸€ä¸ªèŠ‚ç‚¹è´Ÿè´£æ¥æ”¶æ•°æ®ã€‚ åœ¨äºŒå±‚æ¨¡å¼ä¸­ä¼šå­˜åœ¨ä»¥ä¸‹ä¸¤ç§å±€é™æ€§ï¼šå•èŠ‚ç‚¹ç“¶é¢ˆå’Œæ•…éšœè½¬ç§»æ…¢çš„æƒ…å†µã€‚ ç”±äºLayer 2 æ¨¡å¼ä¼šä½¿ç”¨å•ä¸ªé€‰ä¸¾å‡ºæ¥çš„Leaderæ¥æ¥æ”¶æœåŠ¡IPçš„æ‰€æœ‰æµé‡ï¼Œè¿™å°±æ„å‘³ç€æœåŠ¡çš„å…¥å£å¸¦å®½è¢«é™åˆ¶ä¸ºå•ä¸ªèŠ‚ç‚¹çš„å¸¦å®½ï¼Œå•èŠ‚ç‚¹çš„æµé‡å¤„ç†èƒ½åŠ›å°†æˆä¸ºæ•´ä¸ªé›†ç¾¤çš„æ¥æ”¶å¤–éƒ¨æµé‡çš„ç“¶é¢ˆã€‚ åœ¨æ•…éšœè½¬ç§»æ–¹é¢ï¼Œç›®å‰çš„æœºåˆ¶æ˜¯MetalLBé€šè¿‡å‘é€2å±‚æ•°æ®åŒ…æ¥é€šçŸ¥å„ä¸ªèŠ‚ç‚¹ï¼Œå¹¶é‡æ–°é€‰ä¸¾Leaderï¼Œè¿™é€šå¸¸èƒ½åœ¨å‡ ç§’å†…å®Œæˆã€‚ä½†å¦‚æœæ˜¯è®¡åˆ’å¤–çš„äº‹æ•…å¯¼è‡´çš„ï¼Œæ­¤æ—¶åœ¨æœ‰æ•…éšœçš„å®¢æˆ·ç«¯åˆ·æ–°å…¶ç¼“å­˜æ¡ç›®ä¹‹å‰ï¼Œå°†æ— æ³•è®¿é—®æœåŠ¡IPã€‚ BGPæ¨¡å¼ BGPæ¨¡å¼æ˜¯çœŸæ­£çš„è´Ÿè½½å‡è¡¡ï¼Œè¯¥æ¨¡å¼éœ€è¦è·¯ç”±å™¨æ”¯æŒBGPåè®® ï¼Œç¾¤é›†ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ä¼šä¸ç½‘ç»œè·¯ç”±å™¨å»ºè®®åŸºäºBGPçš„å¯¹ç­‰ä¼šè¯ï¼Œå¹¶ä½¿ç”¨è¯¥ä¼šè¯æ¥é€šå‘Šè´Ÿè½½å‡è¡¡çš„IPã€‚MetalLBå‘å¸ƒçš„è·¯ç”±å½¼æ­¤ç­‰æ•ˆï¼Œè¿™æ„å‘³ç€è·¯ç”±å™¨å°†ä½¿ç”¨æ‰€æœ‰çš„ç›®æ ‡èŠ‚ç‚¹ï¼Œå¹¶åœ¨å®ƒä»¬ä¹‹é—´è¿›è¡Œè´Ÿè½½å¹³è¡¡ã€‚æ•°æ®åŒ…åˆ°è¾¾èŠ‚ç‚¹åï¼Œkube-proxyè´Ÿè´£æµé‡è·¯ç”±çš„æœ€åä¸€è·³ï¼Œå°†æ•°æ®åŒ…å‘é€åˆ°å¯¹åº”æœåŠ¡çš„Podã€‚ è´Ÿè½½å¹³è¡¡çš„æ–¹å¼å–å†³äºæ‚¨ç‰¹å®šçš„è·¯ç”±å™¨å‹å·å’Œé…ç½®ï¼Œå¸¸è§çš„æœ‰åŸºäºæ•°æ®åŒ…å“ˆå¸Œå¯¹æ¯ä¸ªè¿æ¥è¿›è¡Œå‡è¡¡ï¼Œè¿™æ„å‘³ç€å•ä¸ªTCPæˆ–UDPä¼šè¯çš„æ‰€æœ‰æ•°æ®åŒ…éƒ½å°†å®šå‘åˆ°ç¾¤é›†ä¸­çš„å•ä¸ªè®¡ç®—æœºã€‚ BGPæ¨¡å¼ä¹Ÿå­˜åœ¨ç€è‡ªèº«çš„å±€é™æ€§ï¼Œè¯¥æ¨¡å¼é€šè¿‡å¯¹æ•°æ®åŒ…å¤´ä¸­çš„æŸäº›å­—æ®µè¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œå¹¶å°†è¯¥å“ˆå¸Œå€¼ç”¨ä½œåç«¯æ•°ç»„çš„ç´¢å¼•ï¼Œå°†ç»™å®šçš„æ•°æ®åŒ…åˆ†é…ç»™ç‰¹å®šçš„ä¸‹ä¸€è·³ã€‚ä½†è·¯ç”±å™¨ä¸­ä½¿ç”¨çš„å“ˆå¸Œé€šå¸¸ä¸ç¨³å®šï¼Œå› æ­¤åªè¦åç«¯èŠ‚ç‚¹æ•°é‡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œç°æœ‰è¿æ¥å°±ä¼šè¢«éšæœºåœ°é‡æ–°å“ˆå¸Œï¼Œè¿™æ„å‘³ç€å¤§å¤šæ•°ç°æœ‰è¿æ¥å°†è¢«è½¬å‘åˆ°å¦ä¸€åç«¯ï¼Œè€Œè¯¥åç«¯å¹¶ä¸æ¸…æ¥šåŸæœ‰çš„è¿æ¥çŠ¶æ€ã€‚ä¸ºäº†å‡å°‘è¿™ç§éº»çƒ¦ï¼Œå»ºè®®ä½¿ç”¨æ›´åŠ ç¨³å®šçš„BGPç®—æ³•ï¼Œå¦‚ï¼šECMPæ•£åˆ—ç®—æ³•ã€‚ ","date":"2024-08-11","objectID":"/posts/2024-08-11-metallb/:0:1","tags":["metallb"],"title":"metallb","uri":"/posts/2024-08-11-metallb/"},{"categories":["DevOps","k8s"],"content":"å®‰è£…ä½¿ç”¨ Metallbæ”¯æŒé€šè¿‡Kuberntesæ¸…å•ã€Helmå’ŒKustomizeæ–¹å¼è¿›è¡Œéƒ¨ç½²ï¼Œæœ¬æ–‡æˆ‘ä»¬å°†ä»¥Kuberntesæ¸…å•ä¸ºä¾‹ä»‹ç»äº§å“çš„éƒ¨ç½²å®‰è£…ï¼Œéƒ¨ç½²çš„ç‰ˆæœ¬ä¸ºæœ€æ–°çš„v0.13.7ã€‚ æ³¨ï¼šç”±äºMetallbä»v0.13.0ç‰ˆæœ¬å¼€å§‹ä¸å†ä½¿ç”¨configmapè€Œæ”¹ç”¨è‡ªå®šä¹‰èµ„æºæ–¹å¼é…ç½®ï¼Œå› æ­¤æœ¬ç¤ºä¾‹ä¸æ—§ç‰ˆæœ¬çš„é…ç½®æ–¹å¼ä¼šæœ‰æ‰€ä¸åŒ 1ï¼‰ç¡®å®šipvsé›†ç¾¤å¼€å¯strictARP kubectl edit configmap -n kube-system kube-proxy #è®¾ç½®strictARPå€¼ä¸ºtrue apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration mode: \"ipvs\" ipvs: strictARP: true 2ï¼‰å®‰è£…metallb wget https://raw.githubusercontent.com/metallb/metallb/v0.13.4/config/manifests/metallb-native.yaml kubectl apply -f metallb-native.yaml # helm helm repo add metallb https://metallb.github.io/metallb helm fetch metallb/metallb --version=0.13.7 helm install metallb metallb/metallb --version=0.13.7 3ï¼‰é…ç½®æ¨¡å¼ Layer2 æ¨¡å¼ åˆ›å»ºIPAddressPoolï¼Œå¹¶æŒ‡å®šç”¨äºåˆ†é…çš„IPæ± ã€‚ [root@sugar metallb]# cat \u003c\u003cEOF \u003e IPAdressPool.yaml apiVersion: metallb.io/v1beta1 kind: IPAddressPool metadata: name: ip-pool namespace: metallb-system spec: addresses: - 192.168.214.50-192.168.214.80 #åˆ†é…ç»™LBçš„IPæ± ,æ³¨æ„è¿™é‡Œçš„addresseséœ€è¦å’Œk8sçš„èŠ‚ç‚¹å¤„äºåŒä¸€ä¸ªç½‘æ®µ EOF åˆ›å»ºå¹¿æ’­å£°æ˜ï¼Œæ­¤å¤„æœªæŒ‡å®šIPæ± ï¼Œåˆ™é»˜è®¤ä¼šä½¿ç”¨æ‰€æœ‰IPæ± åœ°å€ã€‚ cat \u003c\u003cEOF \u003e L2Advertisement.yaml apiVersion: metallb.io/v1beta1 kind: L2Advertisement metadata: name: l2adver namespace: metallb-system EOF # ä¹Ÿå¯ä»¥æŒ‡å®šipåœ°å€æ±  cat \u003c\u003cEOF \u003e L2Advertisement.yaml apiVersion: metallb.io/v1beta1 kind: L2Advertisement metadata: name: example namespace: metallb-system spec: ipAddressPools: - ip-pool #ä¸Šä¸€æ­¥åˆ›å»ºçš„ ip åœ°å€æ± ï¼Œé€šè¿‡åå­—è¿›è¡Œå…³è” EOF BGPæ¨¡å¼é…ç½® å¯¹äºå…·æœ‰ä¸€ä¸ªBGPè·¯ç”±å™¨å’Œä¸€ä¸ªIPåœ°å€èŒƒå›´çš„åŸºæœ¬é…ç½®ï¼Œæ‚¨éœ€è¦4æ¡ä¿¡æ¯ï¼š MetalLBåº”è¯¥è¿æ¥çš„è·¯ç”±å™¨IPåœ°å€ï¼Œ è·¯ç”±å™¨çš„ASå·ï¼Œ MetalLBåº”è¯¥ä½¿ç”¨çš„ASå·ï¼Œ ä»¥CIDRå‰ç¼€è¡¨ç¤ºçš„IPåœ°å€èŒƒå›´ã€‚(åˆ†é…çš„LB ip) ç¤ºä¾‹ï¼šç°åœ¨åˆ†é…ç»™MetalLBçš„ASç¼–å·ä¸º64500å’Œ192.168.10.0/24çš„IPåœ°å€æ± ï¼Œå¹¶å°†å…¶è¿æ¥åˆ°ASç¼–å·ä¸º64501çš„åœ°å€ä¸º10.0.0.1çš„è·¯ç”±å™¨ï¼Œåˆ™é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š åˆ›å»ºBGPPeer apiVersion: metallb.io/v1beta2 kind: BGPPeer metadata: name: sample namespace: metallb-system spec: myASN: 64500 peerASN: 64501 peerAddress: 10.0.0.1 é…ç½®IPåœ°å€æ±  apiVersion: metallb.io/v1beta1 kind: IPAddressPool metadata: name: first-pool namespace: metallb-system spec: addresses: - 192.168.10.0/24 - 172.16.78.141/32 # - 192.168.214.50-192.168.214.80 åˆ›å»ºå¹¿æ’­å£°æ˜ apiVersion: metallb.io/v1beta1 kind: BGPAdvertisement metadata: name: bgpadver namespace: metallb-system ","date":"2024-08-11","objectID":"/posts/2024-08-11-metallb/:0:2","tags":["metallb"],"title":"metallb","uri":"/posts/2024-08-11-metallb/"},{"categories":["DevOps","k8s"],"content":"æµ‹è¯• ç®€å•æµ‹è¯•ï¼š 1ï¼‰åˆ›å»ºç¤ºä¾‹yamlæ–‡ä»¶å¹¶æ‰§è¡Œï¼ŒåŒ…æ‹¬svcä¸deploymentã€‚ apiVersion: v1 kind: Service metadata: name: myapp spec: selector: app: myapp ports: - protocol: TCP port: 80 targetPort: 80 type: LoadBalancer #ç±»å‹é€‰æ‹©LoadBalancer --- apiVersion: apps/v1 kind: Deployment metadata: name: myapp labels: app: myapp spec: replicas: 2 selector: matchLabels: app: myapp template: metadata: labels: app: myapp spec: containers: - name: nginx image: nginx ports: - containerPort: 80 2ï¼‰æŸ¥çœ‹åˆ›å»ºçš„SVCçŠ¶æ€ï¼Œå·²è·å–åˆ°IP [root@master-01 metalLB]# kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 \u003cnone\u003e 443/TCP 3h47m myapp-svc LoadBalancer 10.99.108.212 172.16.78.141 80:31542/TCP 17m 3ï¼‰è®¿é—®æµ‹è¯• helm æµ‹è¯•ï¼š https://artifacthub.io/packages/helm/bitnami/nginx $ helm repo add bitnami https://charts.bitnami.com/bitnami $ helm install my-release bitnami/nginx [root@sugar metallb]# kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 \u003cnone\u003e 443/TCP 36m my-release-nginx LoadBalancer 10.110.219.132 172.16.5.48 80:32026/TCP 27m mysql ClusterIP 10.109.126.5 \u003cnone\u003e 3306/TCP 14m mysql-headless ClusterIP None \u003cnone\u003e 3306/TCP 14m nginx-svc LoadBalancer 10.103.199.38 172.16.5.47 80:32559/TCP 31m [root@ftp ~]# curl 172.16.5.48 \u003c!DOCTYPE html\u003e \u003chtml\u003e \u003chead\u003e \u003ctitle\u003eWelcome to nginx!\u003c/title\u003e \u003cstyle\u003e html { color-scheme: light dark; } body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } \u003c/style\u003e \u003c/head\u003e \u003cbody\u003e \u003ch1\u003eWelcome to nginx!\u003c/h1\u003e \u003cp\u003eIf you see this page, the nginx web server is successfully installed and working. Further configuration is required.\u003c/p\u003e \u003cp\u003eFor online documentation and support please refer to \u003ca href=\"http://nginx.org/\"\u003enginx.org\u003c/a\u003e.\u003cbr/\u003e Commercial support is available at \u003ca href=\"http://nginx.com/\"\u003enginx.com\u003c/a\u003e.\u003c/p\u003e \u003cp\u003e\u003cem\u003eThank you for using nginx.\u003c/em\u003e\u003c/p\u003e \u003c/body\u003e \u003c/html\u003e ","date":"2024-08-11","objectID":"/posts/2024-08-11-metallb/:0:3","tags":["metallb"],"title":"metallb","uri":"/posts/2024-08-11-metallb/"},{"categories":["DevOps","k8s"],"content":"å·¥ä½œæµç¨‹ MetalLB åšçš„å·¥ä½œå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š 1ï¼‰åœ°å€åˆ†é…ï¼šå½“åˆ›å»º LoadBalancer Service æ—¶ï¼ŒMetalLB ä¼šä¸ºå…¶åˆ†é… IP åœ°å€ã€‚è¿™ä¸ª IP åœ°å€æ˜¯ä»é¢„å…ˆé…ç½®çš„ IP åœ°å€åº“è·å–çš„ã€‚åŒæ ·ï¼Œå½“ Service åˆ é™¤åï¼Œå·²åˆ†é…çš„ IP åœ°å€ä¼šé‡æ–°å›åˆ°åœ°å€åº“ã€‚ 2ï¼‰å¯¹å¤–å¹¿æ’­ï¼šåˆ†é…äº† IP åœ°å€ä¹‹åï¼Œéœ€è¦è®©é›†ç¾¤å¤–çš„ç½‘ç»œçŸ¥é“è¿™ä¸ªåœ°å€çš„å­˜åœ¨ã€‚MetalLB ä½¿ç”¨äº†æ ‡å‡†è·¯ç”±åè®®å®ç°ï¼šARPã€NDP æˆ–è€… BGPã€‚ åœ¨ Layer 2 æ¨¡å¼ï¼Œä½¿ç”¨ ARPï¼ˆipv4ï¼‰/NDPï¼ˆipv6ï¼‰ åè®®ï¼› åœ¨ BPG æ¨¡å¼ï¼Œè‡ªç„¶æ˜¯ä½¿ç”¨ BGP åè®®ã€‚ ARPï¼ˆAddress Resolution Protocolï¼‰ï¼šæ˜¯æ ¹æ®IPåœ°å€è·å–ç‰©ç†åœ°å€çš„ä¸€ä¸ªTCP/IPåè®®ã€‚ NDPï¼ˆneighbor Discovery protocolï¼‰ï¼šæ˜¯ICMPv6çš„å­åè®®æ˜¯IPV6åè®®ä½“ç³»ä¸­ä¸€ä¸ªé‡è¦çš„åŸºç¡€åè®®ï¼Œé‚»å±…å‘ç°åè®®æ›¿ä»£äº†IPV4çš„ARPï¼ŒICMPè·¯ç”±å™¨å‘ç°ã€‚å®ƒå®šä¹‰äº†ä½¿ç”¨ICMPv6æŠ¥æ–‡å®ç°åœ°å€è§£æï¼Œè·Ÿè¸ªé‚»å±…çŠ¶æ€ï¼Œé‡å¤åœ°å€æ£€æµ‹ï¼Œè·¯ç”±å™¨å‘ç°ï¼Œä»¥åŠé‡å®šå‘ç­‰åŠŸèƒ½ã€‚ åŒæ—¶ MetalLB åˆ†åˆ«ä½¿ç”¨ä¸¤ä¸ªç»„ä»¶æ¥å®ç°äº†ä¸Šè¿°ä¸¤ä¸ªåŠŸèƒ½ï¼š Controllerï¼šå®ç°åœ°å€åˆ†é…ï¼Œä»¥ Deployment æ–¹å¼è¿è¡Œï¼Œç”¨äºç›‘å¬ Service çš„å˜æ›´ï¼Œåˆ†é…/å›æ”¶ IP åœ°å€ã€‚ Speakerï¼šå®ç°åœ°å€å¯¹å¤–å¹¿æ’­ï¼Œä»¥ DaemonSet æ–¹å¼è¿è¡Œï¼Œå¯¹å¤–å¹¿æ’­ Service çš„ IP åœ°å€ã€‚ å…·ä½“çš„å·¥ä½œæµå¦‚ä¸‹ï¼š Controller è´Ÿè´£ç›‘å¬ Service å˜åŒ–å¹¶åˆ†é…æˆ–å›æ”¶ IP ï¼Œå½“ Service é…ç½®ä¸º LoadBalancer æ¨¡å¼æ—¶ï¼Œä» IP æ± åˆ†é…ç»™åˆ°ç›¸åº”çš„ IP åœ°å€å¹¶å¯¹è¯¥ IP çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç®¡ç†ã€‚ åˆ›å»º Service æ—¶ï¼ˆæˆ–è€…ä»é LoadBalancer ç±»å‹ä¿®æ”¹ä¸º LoadBalancer ç±»å‹ï¼‰æ—¶ä» IP æ± é€‰æ‹©ä¸€ä¸ª IP å¹¶åˆ†é…ï¼Œ åˆ é™¤ Service ï¼ˆæˆ–è€…ä» LoadBalancer ç±»å‹ä¿®æ”¹ä¸ºé LoadBalancer ç±»å‹ï¼‰æ—¶å›æ”¶è¯¥ IP åˆ° IP æ±  Speaker åˆ™ä¼šä¾æ®é€‰æ‹©çš„åè®®è¿›è¡Œç›¸åº”çš„å¹¿æ’­æˆ–åº”ç­”ï¼Œå®ç° IP åœ°å€çš„é€šä¿¡å“åº” ã€‚å½“ä¸šåŠ¡æµé‡é€šè¿‡ TCP/UDP åè®®åˆ°è¾¾æŒ‡å®šçš„ Node æ—¶ï¼Œç”± Node ä¸Šé¢è¿è¡Œçš„ Kube-Proxy ç»„ä»¶å¯¹æµé‡è¿›è¡Œå¤„ç†ï¼Œå¹¶åˆ†å‘åˆ°å¯¹åº”æœåŠ¡çš„ Pod ä¸Šé¢ã€‚ å¦‚æœæ˜¯ Layer2 æ¨¡å¼ Speaker å°±ä¼šå“åº” ARPï¼ˆipv4ï¼‰/NDPï¼ˆipv6ï¼‰è¯·æ±‚ å¦‚æœæ˜¯ BGP æ¨¡å¼ Speaker åˆ™å‘é€ BGP å¹¿æ’­ï¼Œå°†è·¯ç”±è§„åˆ™åŒæ­¥ç»™ peerã€‚ ","date":"2024-08-11","objectID":"/posts/2024-08-11-metallb/:0:4","tags":["metallb"],"title":"metallb","uri":"/posts/2024-08-11-metallb/"},{"categories":["DevOps","k8s"],"content":"Layer2 æ¨¡å¼å·¥ä½œåŸç† METALLB IN LAYER 2 MODE å¤§è‡´åŸç† Layer 2 ä¸­çš„ Speaker å·¥ä½œè´Ÿè½½æ˜¯ DeamonSet ç±»å‹ï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½è°ƒåº¦ä¸€ä¸ª Podï¼Œé¦–å…ˆï¼Œå‡ ä¸ª Pod ä¼šå…ˆè¿›è¡Œé€‰ä¸¾ï¼Œé€‰ä¸¾å‡º Leaderã€‚ ç”± Leader Pod è·å–æ‰€æœ‰ LoadBalancer ç±»å‹çš„ Serviceï¼Œå¹¶å°†å·²åˆ†é…çš„ IP åœ°å€ç»‘å®šåˆ°å½“å‰ä¸»æœºåˆ°ç½‘å¡ä¸Šã€‚åŒæ—¶è¯¥ Leader ä¼šå“åº”å¯¹ ExternalIP çš„ ARPï¼ˆipv4ï¼‰/NDPï¼ˆipv6ï¼‰ è¯·æ±‚ï¼Œå› æ­¤ä»å±€åŸŸç½‘å±‚é¢æ¥çœ‹ï¼Œspeaker æ‰€åœ¨çš„æœºå™¨æ˜¯æœ‰å¤šä¸ª IP åœ°å€çš„ï¼Œå½“å‰å…¶ä¸­ä¹ŸåŒ…å« ExternalIPã€‚ ä»ç½‘ç»œçš„è§’åº¦æ¥çœ‹ï¼Œè®¡ç®—æœºçš„ç½‘ç»œæ¥å£åˆ†é…äº†å¤šä¸ªIPåœ°å€,å› ä¸ºå¯¹ä¸åŒ ip åœ°å€çš„ arp è¯·æ±‚è¿”å›çš„éƒ½æ˜¯è¿™ä¸ªèŠ‚ç‚¹çš„ mac åœ°å€ã€‚ å› æ­¤ä¸ ExternalIP ç›¸å…³çš„æ‰€æœ‰æµé‡éƒ½ä¼šæµå‘è¯¥èŠ‚ç‚¹ã€‚åœ¨è¯¥èŠ‚ç‚¹ä¸Šï¼Œ kube-proxy å°†æ¥æ”¶åˆ°çš„æµé‡ä¼ æ’­åˆ°å¯¹åº” Service çš„åç«¯ Podã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰ LoadBalancer ç±»å‹çš„ Service çš„ IP åŒä¸€æ—¶é—´éƒ½æ˜¯ç»‘å®šåœ¨åŒä¸€å°èŠ‚ç‚¹çš„ç½‘å¡ä¸Šã€‚ å±€é™æ€§ åœ¨ Layer2 æ¨¡å¼ä¸­ä¼šå­˜åœ¨ä»¥ä¸‹ä¸¤ç§å±€é™æ€§ï¼šå•èŠ‚ç‚¹ç“¶é¢ˆå’Œæ•…éšœè½¬ç§»æ…¢ã€‚ å•èŠ‚ç‚¹ç“¶é¢ˆ ç”±äº Layer 2 æ¨¡å¼ä¼šä½¿ç”¨å•ä¸ªé€‰ä¸¾å‡ºæ¥çš„ Leader æ¥æ¥æ”¶ ExternalIP çš„æ‰€æœ‰æµé‡ï¼Œè¿™å°±æ„å‘³ç€æœåŠ¡çš„å…¥å£å¸¦å®½è¢«é™åˆ¶ä¸ºå•ä¸ªèŠ‚ç‚¹çš„å¸¦å®½ï¼Œå•èŠ‚ç‚¹çš„æµé‡å¤„ç†èƒ½åŠ›å°†æˆä¸ºæ•´ä¸ªé›†ç¾¤çš„æ¥æ”¶å¤–éƒ¨æµé‡çš„ç“¶é¢ˆã€‚ ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼ŒLayer2 æ¨¡å¼æ›´åƒæ˜¯å®ç°äº†æ•…éšœè½¬ç§»ï¼Œè€Œä¸æ˜¯è´Ÿè½½å‡è¡¡ï¼Œå› ä¸ºåŒæ—¶åªèƒ½åœ¨ä¸€ä¸ªèŠ‚ç‚¹è´Ÿè´£æ¥æ”¶æ•°æ®ã€‚ æ•…éšœè½¬ç§»æ…¢ åœ¨æ•…éšœè½¬ç§»æ–¹é¢ï¼ŒMetalLB ä¹Ÿå®ç°äº†è‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚ç›®å‰çš„æœºåˆ¶æ˜¯é€šè¿‡ memberlist è¿™ä¸ªåŸºäº gossip åè®®çš„æˆå‘˜å’Œæ•…éšœæ£€æµ‹çš„åº“ï¼Œå…¶ä»–èŠ‚ç‚¹æ£€æµ‹åˆ° Leader æ•…éšœåè‡ªåŠ¨é‡æ–°é€‰ä¸¾å‡ºæ–° Leaderï¼Œæ–°çš„ Leader è‡ªåŠ¨æ¥ç®¡æ‰€æœ‰ ExternalIP å¹¶å‘é€å¤§é‡ äºŒå±‚æ•°æ®åŒ…æ¥é€šçŸ¥å®¢æˆ·ç«¯(ä¹Ÿå°±æ˜¯åŒºåŸŸç½‘ä¸­çš„å…¶ä»–èŠ‚ç‚¹) ExternalIP çš„ MAC åœ°å€å˜åŒ–ã€‚ å¤§éƒ¨åˆ†æ“ä½œç³»ç»Ÿéƒ½èƒ½å¤„ç†è¿™éƒ¨åˆ† äºŒå±‚æ•°æ®åŒ…å¹¶æ›´æ–° neighbor cachesï¼Œä½†æ˜¯ä¹Ÿæœ‰æå°‘éƒ¨åˆ†ç³»ç»Ÿä¸èƒ½æ­£ç¡®å¤„ç†è¿™ä¸ªæ•°æ®åŒ…ï¼Œä»è€Œæ— æ³•åŠæ—¶æ›´æ–°ç¼“å­˜ï¼Œè¿˜ä¼šç»§ç»­è¯·æ±‚æ—§çš„ Leader èŠ‚ç‚¹ï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥è®©æ—§ Leader å¤šå­˜æ´»å‡ åˆ†é’Ÿï¼Œç”¨äºå¤„ç†è¿™éƒ¨åˆ†å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚ æ ¹æ®å®˜ç½‘æ–‡æ¡£æè¿°æ•…éšœè½¬ç§»æ­£å¸¸æƒ…å†µä¸‹ä¼šåœ¨å‡ ç§’å†…å®Œæˆï¼Œä¸€èˆ¬ä¸ä¼šè¶…è¿‡ 10 ç§’ã€‚ä½†æ˜¯åœ¨æ›´æ–°å®Œæˆå‰ ExternalIP ä¼šæ— æ³•è®¿é—®ã€‚ å³ï¼šä¼šå‡ºç°å‡ ç§’é’Ÿçš„æœåŠ¡ä¸­æ–­ è¿™ä¸ª 10s åªæ˜¯å®˜æ–¹è¯´çš„ï¼Œå¯èƒ½ç»å¸¸æµ‹è¯•æˆ–è€…æ˜¯ä¸€ä¸ªå¤§æ¦‚å€¼ï¼Œå’Œè¿™æ®µ ä»£ç #announcer.go#L51 é‡Œçš„10s çš„å¾ªç¯ä¸æ˜¯ä¸€å›äº‹ ","date":"2024-08-11","objectID":"/posts/2024-08-11-metallb/:0:5","tags":["metallb"],"title":"metallb","uri":"/posts/2024-08-11-metallb/"},{"categories":["DevOps","k8s"],"content":"BGP æ¨¡å¼å·¥ä½œåŸç† METALLB IN BGP MODE å¤§è‡´åŸç† åœ¨ BGP æ¨¡å¼ä¸‹æ¯ä¸ªèŠ‚ç‚¹ï¼ˆ ä¸Šçš„ Speaker Podï¼‰éƒ½ä¼šå’Œè·¯ç”±å™¨å»ºç«‹ä¸€ä¸ª BGP peer sessionï¼Œå¹¶ä¸”é€šè¿‡è¿™äº› peer session æ¥å‘ŠçŸ¥å¤–éƒ¨ç½‘ç»œ ExternalIPs çš„å­˜åœ¨ã€‚ BGPæ¨¡å¼æ˜¯ä»¥é›†ç¾¤ä¸­çš„ä¸»æœºä¸å¯¹ç­‰ä½“è¿›è¡Œå…±äº«è·¯ç”±ä¿¡æ¯ï¼Œä»è€Œå®ç°é›†ç¾¤å¤–éƒ¨çš„æœåŠ¡èƒ½å¤Ÿè®¿é—®åˆ°é›†ç¾¤å†…éƒ¨çš„æœåŠ¡ã€‚ å’Œ Layer2 æ¨¡å¼ä¸åŒï¼ŒBGPæ¨¡å¼çœŸæ­£çš„å®ç°äº†è´Ÿè½½å‡è¡¡ï¼Œä¸è¿‡å…·ä½“çš„è´Ÿè½½å‡è¡¡è¡Œä¸ºå’Œè·¯ç”±å™¨ä»¥åŠé…ç½®æœ‰å…³ç³»ã€‚ä¸€èˆ¬é»˜è®¤çš„è¡Œä¸ºæ˜¯æ ¹æ®æ•°æ®åŒ…ä¸­çš„æŸäº›å…³é”®å­—æ®µè¿›è¡Œ hashï¼Œå¹¶æ›´æ–° hash å€¼åˆ†é…ç»™å…¶ä¸­æŸä¸€ä¸ªè¿æ¥ã€‚ åŸæ–‡ï¼šbut the common behavior is to balance per-connection, based on a packet hash. å…³é”®å­—æ®µå¸¸è§é€‰æ‹©ä¸º ä¸‰å…ƒç»„ï¼ˆåè®®ã€æºIPã€ç›®çš„IPï¼‰ æˆ–è€…äº”å…ƒç»„ï¼ˆåè®®ã€æºIPã€ç›®çš„IPã€æºç«¯å£ã€ç›®çš„ç«¯å£ï¼‰ ä¹Ÿå°±æ˜¯è¯´é»˜è®¤æƒ…å†µä¸‹ä¸€ä¸ªè¿æ¥é‡Œçš„æ‰€æœ‰æ•°æ®åŒ…éƒ½ä¼šå‘é€åˆ°å›ºå®šçš„èŠ‚ç‚¹ï¼Œè¿™æ ·èƒ½æ‹¥æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚ å±€é™æ€§ BGP æ¨¡å¼æœ€å¤§çš„å¼Šç«¯å°±æ˜¯ä¸èƒ½ä¼˜é›…çš„å¤„ç†èŠ‚ç‚¹ä¸‹çº¿ã€‚å½“é›†ç¾¤ä¸­æŸä¸ªèŠ‚ç‚¹ä¸‹çº¿æ—¶ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯å¯¹è¿™ä¸ªèŠ‚ç‚¹çš„è¿æ¥éƒ½ä¼šè¢«ä¸»åŠ¨æ–­å¼€ã€‚ å®¢æˆ·ç«¯ä¸€èˆ¬ä¼šå‡ºç°ä¸€ä¸ª Connection reset by peer é”™è¯¯ åŒæ—¶ç”±äºæ˜¯å¯¹æ¯ä¸ªæ•°æ®åŒ…åŸºäº hash å€¼è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œå› æ­¤å¯¹åç«¯èŠ‚ç‚¹æ•°æ˜¯éå¸¸æ•æ„Ÿçš„ï¼Œè¿™ä¹Ÿæ˜¯ BGP çš„ä¸€ä¸ªä¼˜ç‚¹ï¼Œæ•…éšœè½¬ç§»éå¸¸å¿«ã€‚ æ­£å› ä¸º BGP æ•…éšœè½¬ç§»å¾ˆå¿«ï¼Œåè€Œå¼•å‘äº†ä¸€ä¸ª BGP æ¨¡å¼çš„æœ€å¤§ç¼ºç‚¹ï¼šç”±äº BGP ä¼šå¯¹æ¯ä¸ªæ•°æ®åŒ…åšè´Ÿè½½å‡è¡¡ï¼Œåœ¨ä¸»æœºå‘ç”Ÿæ•…éšœæ—¶ä¼šå¿«é€Ÿåˆ‡æ¢åˆ°æ–°çš„ä¸»æœºä¸Šï¼Œä»è€Œå¼•å‘èŠ‚ç‚¹å˜åŠ¨æ—¶åŒä¸€è¿æ¥çš„ä¸åŒæ•°æ®åŒ…å¯èƒ½ä¼šå‘é€åˆ°ä¸åŒä¸»æœºä¸Šå¯¼è‡´ç½‘ç»œå¯¼è‡´çš„ç½‘ç»œé‡æ’é—®é¢˜ã€‚ æ¯”å¦‚ç¬¬ä¸€ä¸ªåŒ…è½¬å‘åˆ°èŠ‚ç‚¹ Aï¼Œç„¶åå¤„ç†ç¬¬äºŒä¸ªåŒ…æ—¶æ·»åŠ æˆ–æ•…éšœäº†ä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŒ‰ç…§æ–°çš„èŠ‚ç‚¹æ•°è¿›è¡Œè´Ÿè½½å‡è¡¡è®¡ç®—ï¼Œå¯èƒ½ç¬¬äºŒä¸ªæ•°æ®åŒ…å°±è¢«åˆ†åˆ°èŠ‚ç‚¹ B äº†ï¼ŒèŠ‚ç‚¹ B å¾ˆæ˜æ˜¾æ˜¯ä¸èƒ½æ­£ç¡®å¤„ç†è¿™ä¸ªæ•°æ®åŒ…çš„ã€‚ å¯¹å®¢æˆ·ç«¯æ¥è¯´å°±æ˜¯è¿™æ¬¡è¯·æ±‚ç›´æ¥å¤±è´¥äº†ã€‚ è§£å†³è¯¥å¼Šç«¯çš„æ–¹æ³•æ²¡æœ‰å¤ªç†æƒ³çš„è§£å†³åŠæ³•ï¼Œåªèƒ½å°½é‡é‡‡å–ä¸€äº›ä¼˜åŒ–æ‰‹æ®µï¼š 1ï¼‰è·¯ç”±å™¨é…ç½®æ›´åŠ ç¨³å®šçš„ hash ç®—æ³•ï¼Œæ¯”å¦‚ â€œresilient ECMPâ€ æˆ–è€… â€œresilient LAGâ€ã€‚ä½¿ç”¨è¿™æ ·çš„ç®—æ³•æå¤§åœ°å‡å°‘äº† åç«¯èŠ‚ç‚¹æ›´æ”¹æ—¶å—å½±å“çš„è¿æ¥ã€‚ 2ï¼‰å°½é‡å°‘çš„å¢åˆ èŠ‚ç‚¹ 3ï¼‰åœ¨æµé‡å°‘æ—¶å˜æ›´èŠ‚ç‚¹ï¼Œä»¥é™ä½å½±å“ 4ï¼‰ä½¿ç”¨ ingress æ¥å¯¹å¤–æš´éœ²æœåŠ¡ç­‰ç­‰ äºŒè€…å®ç°åŸç† MetalLB åŒ…æ‹¬ Layer2 æ¨¡å¼å’Œ BGP æ¨¡å¼ï¼Œä¸»è¦åŒºåˆ«åœ¨äº IP é€šå‘Šéƒ¨åˆ†çš„å®ç°ä¸ä¸€æ ·ï¼š Layer2 æ¨¡å¼é€šè¿‡å“åº”å¯¹ ExternalIP çš„ ARPï¼ˆipv4ï¼‰/NDPï¼ˆipv6ï¼‰ è¯·æ±‚æ¥å‘ŠçŸ¥å…¶ä»–èŠ‚ç‚¹æŸä¸ª IP åœ¨è¿™å°æœºå™¨ä¸Š arp è¯·æ±‚æ˜¯åœ¨ äºŒå±‚çš„ï¼Œè¿™å¯èƒ½å°±æ˜¯è¯¥æ¨¡å¼ä¸ºä»€ä¹ˆå«åš Layer2 BGP æ¨¡å¼åˆ™é€šè¿‡äºè·¯ç”±å™¨å»ºç«‹ BGP peer sessionï¼Œä»è€Œè¿›è¡Œæ•°æ®åŒæ­¥ï¼Œè®©è·¯ç”±å™¨çŸ¥é“æŸä¸ª IP åœ¨è¿™å°æœºå™¨ä¸Š äºŒè€…ä¼˜ç¼ºç‚¹ Layer2 æ¨¡å¼ ä¼˜ç‚¹ï¼šé€šç”¨æ€§å¥½ï¼Œé€‚ç”¨äºä»»ä½•ç½‘ç»œç¯å¢ƒï¼Œä¸éœ€è¦ç‰¹æ®Šçš„ç¡¬ä»¶ï¼Œç”šè‡³ä¸éœ€è¦èŠ±å“¨çš„è·¯ç”±å™¨ã€‚ ç¼ºç‚¹ï¼šå•èŠ‚ç‚¹ç“¶é¢ˆå’Œæ•…éšœè½¬ç§»æ…¢ Layer2 æ¨¡å¼æ˜¯ä¸€ç§åŸºç¡€ã€é€šç”¨çš„å®ç°ï¼Œèƒ½ç”¨ï¼Œè€Œä¸”æ˜“äºä½¿ç”¨ï¼Œæ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œä½†æ˜¯å±€é™æ€§æ¯”è¾ƒå¤§ã€‚ BGP æ¨¡å¼ï¼š ä¼˜ç‚¹ï¼šä½¿ç”¨ BGP å¯ä»¥åœ¨å¤šèŠ‚ç‚¹é—´è´Ÿè½½å‡è¡¡ï¼Œæ²¡æœ‰å•èŠ‚ç‚¹ç“¶é¢ˆï¼ŒåŒæ—¶æ•…éšœè½¬ç§»å¾ˆå¿«ã€‚ ç¼ºç‚¹ï¼š éœ€è¦æ”¯æŒ BGP è·¯ç”±åè®®çš„è½¯è·¯ç”±æˆ–è€…ç¡¬ä»¶è·¯ç”±å™¨è®¾å¤‡ã€‚ å…¶å®ä¸èƒ½ç®—ç¼ºç‚¹äº†ï¼Œæƒ³è¦åŠŸèƒ½æ€»å¾—ä»˜å‡ºä»£ä»·ã€‚ ä½¿ç”¨å»ºè®® BGP æ¨¡å¼åˆ™æ˜¯æ¯”è¾ƒç†æƒ³çš„å®ç°ï¼Œé™¤äº†ä¾èµ–æ”¯æŒ BGP çš„è·¯ç”±ä¹‹å¤–ï¼Œå…¶ä»–æ–¹é¢åˆ™æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œå¹¶ä¸”æ²¡æœ‰å¯ç”¨æ€§çš„é—®é¢˜ ä¸€å¥è¯æ€»ç»“ï¼šå¦‚æœè¯´ Layer2 æ¨¡å¼ä¸ºåŸºç¡€å®ç°ï¼Œé‚£ä¹ˆ BGP æ¨¡å¼åˆ™æ˜¯ LoadBalance çš„ç»ˆæå®ç°ï¼Œèƒ½ç”¨ BGP æ¨¡å¼å°±å°½é‡ç”¨ BGP æ¨¡å¼ï¼Œå¦åˆ™çš„è¯å°±åªèƒ½ç”¨ Layer2 æ¨¡å¼äº†ï¼Œå¦‚æœä¸çŸ¥é“ç”¨ä»€ä¹ˆæ¨¡å¼çš„è¯ç›´æ¥ç”¨ Layer2 æ¨¡å¼å³å¯ã€‚ ","date":"2024-08-11","objectID":"/posts/2024-08-11-metallb/:0:6","tags":["metallb"],"title":"metallb","uri":"/posts/2024-08-11-metallb/"},{"categories":["DevOps","k8s"],"content":"Istio + MetalLB åŸºäºhelm å‚è€ƒé“¾æ¥ï¼šhttps://www.jianshu.com/p/fe6e0911b71c ","date":"2024-08-11","objectID":"/posts/2024-08-11-metallb/:1:0","tags":["metallb"],"title":"metallb","uri":"/posts/2024-08-11-metallb/"},{"categories":["DevOps","k8s"],"content":"ä¸€ã€MetaLB Kubernetes ä¸ä¸ºè£¸æœºé›†ç¾¤æä¾›ç½‘ç»œè´Ÿè½½å‡è¡¡å™¨çš„å®ç°ï¼ˆLoadBalancer ç±»å‹çš„æœåŠ¡)ã€‚ Kubernetes é™„å¸¦çš„ Network LB çš„å®ç°éƒ½æ˜¯è°ƒç”¨å„ç§ IaaS å¹³å°ï¼ˆGCPï¼ŒAWSï¼ŒAzure ç­‰ï¼‰çš„ç²˜åˆä»£ç ã€‚ å¦‚æœä½ æœªåœ¨å—æ”¯æŒçš„ IaaS å¹³å°ï¼ˆGCPï¼ŒAWSï¼ŒAzure ç­‰ï¼‰ä¸Šè¿è¡Œï¼Œåˆ™ LoadBalancers åœ¨åˆ›å»ºåå°†æ— é™æœŸä¿æŒ â€œpendingâ€ çŠ¶æ€ã€‚ MetalLB å¯ä»¥è§£å†³ istio ingress gateway EXTERNAL-IP â€œpendingâ€ çš„é—®é¢˜. å®‰è£…ï¼š 1ï¼‰ç¡®å®šipvsé›†ç¾¤å¼€å¯strictARP kubectl edit configmap -n kube-system kube-proxy #è®¾ç½®strictARPå€¼ä¸ºtrue apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration mode: \"ipvs\" ipvs: strictARP: true 2ï¼‰å®‰è£…metallb [root@master-01 ~]# kubectl create ns metallb-system [root@master-01 ~]# helm repo add metallb https://metallb.github.io/metallb # æœ‰éœ€è¦å¯ä»¥ä¸‹è½½chart [root@master-01 ~]# helm fetch metallb/metallb --version=0.13.7 [root@master-01 ~]# helm install metallb metallb/metallb --version=0.13.7 -n metallb-system 3ï¼‰é…ç½®æ¨¡å¼ Layer2 æ¨¡å¼ åˆ›å»ºIPAddressPoolï¼Œå¹¶æŒ‡å®šç”¨äºåˆ†é…çš„IPæ± ã€‚ [root@master-01 ~]# cat ip-pool.yaml apiVersion: metallb.io/v1beta1 kind: IPAddressPool metadata: name: ip-pool namespace: metallb-system spec: addresses: - 192.168.214.50-192.168.214.80 #åˆ†é…ç»™LBçš„IPæ± ,æ³¨æ„è¿™é‡Œçš„addresseséœ€è¦å’Œk8sçš„èŠ‚ç‚¹å¤„äºåŒä¸€ä¸ªç½‘æ®µ autoAssign: false # ä¸è‡ªåŠ¨åˆ†é…ipï¼Œé»˜è®¤ä¸ºtureï¼Œè‹¥éƒ¨ç½²æœåŠ¡çš„LoadBalancerè¦æŒ‡å®šipçš„è¯éœ€è¦è®¾ç½®ä¸ºfalse åˆ›å»ºå¹¿æ’­å£°æ˜ï¼Œæ­¤å¤„æœªæŒ‡å®šIPæ± ï¼Œåˆ™é»˜è®¤ä¼šä½¿ç”¨æ‰€æœ‰IPæ± åœ°å€ã€‚ apiVersion: metallb.io/v1beta1 kind: L2Advertisement metadata: name: l2adver namespace: metallb-system ä½¿ç”¨helmé…ç½®layer2 helm repo add serialt https://serialt.github.io/helm-charts helm install metallb-config serialt/metallb-config --set \"ipPoolRange=172.16.1.40-172.16.1.49\" -n metallb-system --version 0.0.1 BGPæ¨¡å¼é…ç½® å¯¹äºå…·æœ‰ä¸€ä¸ªBGPè·¯ç”±å™¨å’Œä¸€ä¸ªIPåœ°å€èŒƒå›´çš„åŸºæœ¬é…ç½®ï¼Œæ‚¨éœ€è¦4æ¡ä¿¡æ¯ï¼š MetalLBåº”è¯¥è¿æ¥çš„è·¯ç”±å™¨IPåœ°å€ï¼Œ è·¯ç”±å™¨çš„ASå·ï¼Œ MetalLBåº”è¯¥ä½¿ç”¨çš„ASå·ï¼Œ ä»¥CIDRå‰ç¼€è¡¨ç¤ºçš„IPåœ°å€èŒƒå›´ã€‚(åˆ†é…çš„LB ip) ç¤ºä¾‹ï¼šç°åœ¨åˆ†é…ç»™MetalLBçš„ASç¼–å·ä¸º64500å’Œ192.168.10.0/24çš„IPåœ°å€æ± ï¼Œå¹¶å°†å…¶è¿æ¥åˆ°ASç¼–å·ä¸º64501çš„åœ°å€ä¸º10.0.0.1çš„è·¯ç”±å™¨ï¼Œåˆ™é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š åˆ›å»ºBGPPeer apiVersion: metallb.io/v1beta2 kind: BGPPeer metadata: name: sample namespace: metallb-system spec: myASN: 64500 peerASN: 64501 peerAddress: 10.0.0.1 é…ç½®IPåœ°å€æ±  apiVersion: metallb.io/v1beta1 kind: IPAddressPool metadata: name: first-pool namespace: metallb-system spec: addresses: - 192.168.10.0/24 - 172.16.78.141/32 # - 192.168.214.50-192.168.214.80 åˆ›å»ºå¹¿æ’­å£°æ˜ apiVersion: metallb.io/v1beta1 kind: BGPAdvertisement metadata: name: bgpadver namespace: metallb-system ","date":"2024-08-11","objectID":"/posts/2024-08-11-metallb/:1:1","tags":["metallb"],"title":"metallb","uri":"/posts/2024-08-11-metallb/"},{"categories":["DevOps","k8s"],"content":"ä¸€ã€Istio 1ï¼‰å¢åŠ helm repo [root@master-01 ~]# helm repo add istio https://istio-release.storage.googleapis.com/charts # æœ‰éœ€æ±‚å¯ä»¥ä¸‹è½½chart [root@master-01 ~]# helm fetch istio/base --version 1.13.6 [root@master-01 ~]# helm fetch istio/istiod --version 1.13.6 [root@master-01 ~]# helm fetch istio/gateway --version 1.13.6 2ï¼‰éƒ¨ç½²istioç»„ä»¶ [root@master-01 ~]# kubectl create namespace istio-system [root@master-01 ~]# helm install istio-base istio/base -n istio-system --version 1.13.6 [root@master-01 ~]# helm install istiod istio/istiod -n istio-system --wait --version 1.13.6 è‹¥å…³é—­äº†è‡ªåŠ¨åˆ†é…ipï¼Œè¿™éœ€è¦é…ç½®ä¸€ä¸‹ gateway çš„ annotations å‚è€ƒé“¾æ¥ï¼š å¼ƒç”¨Service.Spec.LoadBalancerIP metallb åˆ†é…https://metallb.universe.tf/usage/ annotationsé‡ŒæŒ‡å®šIP # istio-values.yaml service: annotations: metallb.universe.tf/loadBalancerIPs: 172.16.78.143 autoscaling: enabled: true minReplicas: 3 [root@master-01 ~]# helm install istio-ingressgateway istio/gateway -n istio-system --version 1.13.6 --set replicaCount=3 --set autoscaling.enabled=false ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç¡®è®¤æ‰€æœ‰ Pod éƒ½åœ¨è¿è¡Œã€‚ $ kubectl get pod -n istio-system -w NAME READY STATUS RESTARTS AGE istio-ingressgateway-7cc49dcd99-c4mtf 1/1 Running 0 94s istiod-687f965684-n8rkv 1/1 Running 0 3m26s 3ï¼‰å®‰è£…å¤šä¸ªistio gateway [root@master-01 ~]# helm install istio-ingressgateway-mgt istio/gateway -n istio-system --version 1.13.6 --set replicaCount=3 --set autoscaling.enabled=false apiVersion: networking.istio.io/v1beta1 kind: Gateway metadata: name: local-gateway-mgt spec: selector: istio: ingressgateway-mgt # use istio ingressgateway-mgt servers: - port: number: 80 name: http protocol: HTTP hosts: - \"*.local.local.com\" - hosts: - '*.local.imau.cc' port: name: https number: 443 protocol: HTTPS tls: mode: PASSTHROUGH ","date":"2024-08-11","objectID":"/posts/2024-08-11-metallb/:1:2","tags":["metallb"],"title":"metallb","uri":"/posts/2024-08-11-metallb/"},{"categories":["DevOps","k8s"],"content":"æµ‹è¯• apiVersion: v1 kind: Service metadata: name: myapp-svc spec: type: ClusterIP selector: app: myapp ports: - protocol: TCP port: 80 targetPort: 80 --- apiVersion: apps/v1 kind: Deployment metadata: name: myapp-deployment labels: app: myapp spec: replicas: 2 selector: matchLabels: app: myapp template: metadata: labels: app: myapp spec: containers: - name: nginx image: nginx ports: - containerPort: 80 resources: requests: cpu: 100m memory: 100Mi limits: cpu: 100m memory: 100Mi --- apiVersion: networking.istio.io/v1beta1 kind: VirtualService metadata: name: myapp-vs spec: gateways: - local-gateway hosts: - myapp.local.com http: - route: - destination: host: myapp-svc port: number: 80 --- apiVersion: networking.istio.io/v1beta1 kind: Gateway metadata: name: local-gateway spec: selector: istio: ingressgateway # use istio default controller servers: - port: number: 80 name: http protocol: HTTP hosts: - \"*.local.com\" # tls: # httpsRedirect: true # sends 301 redirect for http requests - port: number: 443 name: https protocol: HTTPS tls: mode: SIMPLE credentialName: local-credential # must be the same as secret hosts: - \"*.local.com\" ","date":"2024-08-11","objectID":"/posts/2024-08-11-metallb/:1:3","tags":["metallb"],"title":"metallb","uri":"/posts/2024-08-11-metallb/"},{"categories":["DevOps","k8s"],"content":"Kubeadm æ­å»º é›†ç¾¤ Version: 1.26 kubeadmæ˜¯Kuberneteså®˜æ–¹æä¾›çš„ç”¨äºå¿«é€Ÿå®‰éƒ¨ç½²Kubernetesé›†ç¾¤çš„å·¥å…·ï¼Œä¼´éšKubernetesæ¯ä¸ªç‰ˆæœ¬çš„å‘å¸ƒéƒ½ä¼šåŒæ­¥æ›´æ–°ï¼Œkubeadmä¼šå¯¹é›†ç¾¤é…ç½®æ–¹é¢çš„ä¸€äº›å®è·µåšè°ƒæ•´ï¼Œé€šè¿‡å®éªŒkubeadmå¯ä»¥å­¦ä¹ åˆ°Kuberneteså®˜æ–¹åœ¨é›†ç¾¤é…ç½®ä¸Šä¸€äº›æ–°çš„æœ€ä½³å®è·µã€‚ ","date":"2024-08-11","objectID":"/posts/2024-08-11-kubeadm/:1:0","tags":["kubeadm"],"title":"kubeadm","uri":"/posts/2024-08-11-kubeadm/"},{"categories":["DevOps","k8s"],"content":"1ã€ä¸»æœºåä¸åŸŸåè§£æ èŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶é»˜è®¤ä»¥èŠ‚ç‚¹çš„ä¸»æœºåä¸ºèŠ‚ç‚¹åï¼Œå†…éƒ¨è®¿é—®çš„æ—¶å€™é»˜è®¤ä½¿ç”¨èŠ‚ç‚¹åï¼Œå¦‚æœä¸æƒ³é…ç½®ä¸»æœºåï¼Œå¯ä»¥è®¾ç½®åŠ å…¥é›†ç¾¤æ—¶èŠ‚ç‚¹åä¸ºè¯¥èŠ‚ç‚¹çš„ip [root@k8s-m1 ~]# cat \u003c\u003cEOF \u003e\u003e /etc/hosts 192.168.8.173 m1 192.168.8.174 m2 192.168.8.175 m3 192.168.8.176 n1 EOF ","date":"2024-08-11","objectID":"/posts/2024-08-11-kubeadm/:1:1","tags":["kubeadm"],"title":"kubeadm","uri":"/posts/2024-08-11-kubeadm/"},{"categories":["DevOps","k8s"],"content":"2ã€å…³é—­selinuxä¸é˜²ç«å¢™ [root@k8s-m1 ~]# systemctl stop firewalld [root@k8s-m1 ~]# systemctl disable firewalld [root@k8s-m1 ~]# sed -i \"s/SELINUX=enforcing/SELINUX=disabled/\" /etc/selinux/config [root@k8s-m1 ~]# setenforce 0 å¦‚æœå„ä¸ªä¸»æœºå¯ç”¨äº†é˜²ç«å¢™ç­–ç•¥ï¼Œéœ€è¦å¼€æ”¾Kuberneteså„ä¸ªç»„ä»¶æ‰€éœ€è¦çš„ç«¯å£ï¼Œå¯ä»¥æŸ¥çœ‹Ports and Protocolsä¸­çš„å†…å®¹, å¼€æ”¾ç›¸å…³ç«¯å£æˆ–è€…å…³é—­ä¸»æœºçš„é˜²ç«å¢™ã€‚ ","date":"2024-08-11","objectID":"/posts/2024-08-11-kubeadm/:1:2","tags":["kubeadm"],"title":"kubeadm","uri":"/posts/2024-08-11-kubeadm/"},{"categories":["DevOps","k8s"],"content":"3ã€åŒæ­¥æ—¶é—´ [root@k8s-m1 ~]# yum -y install chrony [root@k8s-m1 ~]# systemctl restart chronyd [root@k8s-m1 ~]# systemctl enable chronyd [root@k8s-m1 ~]# timedatectl set-timezone Asia/Shanghai [root@k8s-m1 ~]# timedatectl set-local-rtc 0 ","date":"2024-08-11","objectID":"/posts/2024-08-11-kubeadm/:1:3","tags":["kubeadm"],"title":"kubeadm","uri":"/posts/2024-08-11-kubeadm/"},{"categories":["DevOps","k8s"],"content":"4ã€å‡çº§ç³»ç»Ÿå†…æ ¸å’Œä¿®æ”¹å†…æ ¸æ¨¡å—å‚æ•° centos7 éœ€è¦å‡çº§å†…æ ¸ [root@k8s-m1 ~]# rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org [root@k8s-m1 ~]# rpm -Uvh https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm [root@k8s-m1 ~]# yum --enablerepo=elrepo-kernel install kernel-lt -y [root@k8s-m1 ~]# grub2-set-default 0 # æŸ¥çœ‹ç³»ç»Ÿå¯ç”¨å†…æ ¸ [root@k8s-m1 ~]# awk -F\\' '$1==\"menuentry \" {print i++ \" : \" $2}' /etc/grub2.cfg [root@k8s-m1 ~]# reboot [root@k8s-m1 ~]# cat \u003c\u003cEOF \u003e /etc/sysctl.d/k8s.conf # https://github.com/moby/moby/issues/31208 # ipvsadm -l --timout # ä¿®å¤ipvsæ¨¡å¼ä¸‹é•¿è¿æ¥timeouté—®é¢˜ å°äº900å³å¯ net.ipv4.tcp_keepalive_time = 600 net.ipv4.tcp_keepalive_intvl = 30 net.ipv4.tcp_keepalive_probes = 10 net.ipv6.conf.all.disable_ipv6 = 1 net.ipv6.conf.default.disable_ipv6 = 1 net.ipv6.conf.lo.disable_ipv6 = 1 net.ipv4.neigh.default.gc_stale_time = 120 net.ipv4.conf.all.rp_filter = 0 net.ipv4.conf.default.rp_filter = 0 net.ipv4.conf.default.arp_announce = 2 net.ipv4.conf.lo.arp_announce = 2 net.ipv4.conf.all.arp_announce = 2 net.ipv4.ip_forward = 1 net.ipv4.tcp_max_tw_buckets = 5000 net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_max_syn_backlog = 1024 net.ipv4.tcp_synack_retries = 2 # è¦æ±‚iptablesä¸å¯¹bridgeçš„æ•°æ®è¿›è¡Œå¤„ç† net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 net.bridge.bridge-nf-call-arptables = 1 net.netfilter.nf_conntrack_max = 2310720 fs.inotify.max_user_watches=89100 fs.may_detach_mounts = 1 fs.file-max = 52706963 fs.nr_open = 52706963 vm.swappiness = 0 vm.overcommit_memory=1 vm.panic_on_oom=0 EOF åŠ è½½å†…æ ¸å‚æ•° [root@k8s-m1 ~]# sysctl -p å‡çº§è½¯ä»¶ [root@k8s-m1 ~]# yum -y upgrade ","date":"2024-08-11","objectID":"/posts/2024-08-11-kubeadm/:1:4","tags":["kubeadm"],"title":"kubeadm","uri":"/posts/2024-08-11-kubeadm/"},{"categories":["DevOps","k8s"],"content":"5ã€ipvsé…ç½® [root@k8s-m1 ~]# yum -y install ipvsadm ipset å‚è€ƒé“¾æ¥ï¼šhttps://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/ipvs/README.md Notes: use nf_conntrack instead of nf_conntrack_ipv4 for Linux kernel 4.19 and later [root@k8s-m1 ~]# yum install ipset ipvsadm -y [root@k8s-m1 ~]# cat \u003e/etc/modules-load.d/ipvs.conf\u003c\u003cEOF ip_vs # è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•-æœ€å°‘è¿æ¥ ip_vs_lc # è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•-åŠ æƒæœ€å°‘è¿æ¥ ip_vs_wlc # è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•-è½®è¯¢ ip_vs_rr # è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•-åŠ æƒè½®è¯¢ ip_vs_wrr # æºåœ°å€æ•£åˆ—è°ƒåº¦ç®—æ³• ip_vs_sh nf_conntrack br_netfilter # containerd overlay EOF [root@k8s-m1 ~]# systemctl restart systemd-modules-load.service æŸ¥çœ‹åŠ è½½æƒ…å†µ [root@k8s-m1 ~]# lsmod | grep -e ip_vs -e nf_conntrack -e br_netfilter ","date":"2024-08-11","objectID":"/posts/2024-08-11-kubeadm/:1:5","tags":["kubeadm"],"title":"kubeadm","uri":"/posts/2024-08-11-kubeadm/"},{"categories":["DevOps","k8s"],"content":"6ã€é…ç½®yumæº epel-release [root@k8s-m1 ~]# yum -y install epel-release [root@k8s-m1 ~]# sed -e 's|^metalink=|#metalink=|g' \\ -e 's|^#baseurl=https\\?://download.fedoraproject.org/pub/epel/|baseurl=https://mirrors.ustc.edu.cn/epel/|g' \\ -e 's|^#baseurl=https\\?://download.example/pub/epel/|baseurl=https://mirrors.ustc.edu.cn/epel/|g' \\ -i.bak \\ /etc/yum.repos.d/epel.repo kubernetes æ–°ç‰ˆå®‰è£…åŒ…ç›®å½•ç»“æ„å·²ç»æ›´æ”¹ # amd64 [root@k8s-m1 ~]# cat \u003c\u003cEOF \u003e /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/ enabled=1 gpgcheck=1 repo_gpgcheck=1 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF # arm64 [root@k8s-m1 ~]# cat \u003c\u003cEOF \u003e /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-aarch64/ enabled=1 gpgcheck=1 repo_gpgcheck=1 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF ","date":"2024-08-11","objectID":"/posts/2024-08-11-kubeadm/:1:6","tags":["kubeadm"],"title":"kubeadm","uri":"/posts/2024-08-11-kubeadm/"},{"categories":["DevOps","k8s"],"content":"7ã€å®‰è£… containerdå®‰è£…æ–¹å¼æœ‰ä¸¤ç§ï¼Œå¯ä»¥ä½¿ç”¨dockerå®‰è£…æºé‡Œçš„containerdï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨äºŒè¿›åˆ¶åŒ…å®‰è£… ä½¿ç”¨dockeræºå®‰è£…containerd [root@k8s-m1 ~]# curl -sL https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo -o /etc/yum.repos.d/docker-ce.repo [root@k8s-m1 ~]# sed -i 's+download.docker.com+mirrors.ustc.edu.cn/docker-ce+' /etc/yum.repos.d/docker-ce.repo [root@k8s-m1 ~]# yum -y install containerd é…ç½®é•œåƒåŠ é€Ÿ https://github.com/containerd/containerd/blob/main/docs/cri/registry.md https://github.com/containerd/containerd/blob/main/docs/cri/config.md#registry-configuration https://www.cnblogs.com/liy36/p/16590745.html cp /etc/containerd/config.toml{,.bak} containerd config default \u003e /etc/containerd/config.toml ä½¿ç”¨äºŒè¿›åˆ¶å®‰è£…containerd å‹ç¼©åŒ…ä¸­å·²ç»æŒ‰ç…§å®˜æ–¹äºŒè¿›åˆ¶éƒ¨ç½²æ¨èçš„ç›®å½•ç»“æ„å¸ƒå±€å¥½ã€‚ é‡Œé¢åŒ…å«äº†systemdé…ç½®æ–‡ä»¶ï¼Œcontainerdä»¥åŠcniçš„éƒ¨ç½²æ–‡ä»¶ã€‚ å°†è§£å‹ç¼©åˆ°ç³»ç»Ÿçš„æ ¹ç›®å½•/ä¸­: [root@k8s-m1 ~]# curl -sL https://github.com/containerd/containerd/releases/download/v1.6.21/cri-containerd-cni-1.6.21-linux-amd64.tar.gz -o cri-containerd-cni-1.6.21-linux-amd64.tar.gz [root@k8s-m1 ~]# tar -xf cri-containerd-cni-1.6.21-linux-amd64.tar.gz -C / etc/ etc/cni/ etc/cni/net.d/ etc/cni/net.d/10-containerd-net.conflist etc/systemd/ etc/systemd/system/ etc/systemd/system/containerd.service etc/crictl.yaml usr/ usr/local/ usr/local/sbin/ usr/local/sbin/runc usr/local/bin/ usr/local/bin/containerd-stress usr/local/bin/containerd-shim usr/local/bin/containerd-shim-runc-v1 usr/local/bin/crictl usr/local/bin/critest usr/local/bin/containerd-shim-runc-v2 usr/local/bin/ctd-decoder usr/local/bin/containerd usr/local/bin/ctr opt/ opt/cni/ opt/cni/bin/ opt/cni/bin/ptp opt/cni/bin/bandwidth opt/cni/bin/static opt/cni/bin/dhcp ... opt/containerd/ opt/containerd/cluster/ ... ç”Ÿæˆcontainerdçš„é…ç½®æ–‡ä»¶ mkdir -p /etc/containerd containerd config default \u003e /etc/containerd/config.toml æ ¹æ®æ–‡æ¡£Container runtimes ä¸­çš„å†…å®¹ï¼Œå¯¹äºä½¿ç”¨systemdä½œä¸ºinit systemçš„Linuxçš„å‘è¡Œç‰ˆï¼Œä½¿ç”¨systemdä½œä¸ºå®¹å™¨çš„cgroup driverå¯ä»¥ç¡®ä¿æœåŠ¡å™¨èŠ‚ç‚¹åœ¨èµ„æºç´§å¼ çš„æƒ…å†µæ›´åŠ ç¨³å®šï¼Œå› æ­¤è¿™é‡Œé…ç½®å„ä¸ªèŠ‚ç‚¹ä¸Šcontainerdçš„cgroup driverä¸ºsystemdã€‚ ä¿®æ”¹å‰é¢ç”Ÿæˆçš„é…ç½®æ–‡ä»¶/etc/containerd/config.tomlï¼š é…ç½®é•œåƒåŠ é€Ÿ sjtu é•œåƒå·²ä¸å¯ç”¨ # ä½¿ç”¨SystemdCgroup sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml # ä¿®æ”¹é…ç½®ç›®å½• sed -i 's+config_path = \"\"+config_path = \"/etc/containerd/certs.d\"+' /etc/containerd/config.toml mkdir /etc/containerd/certs.d/docker.io -pv # é…ç½®åŠ é€Ÿ sed -i 's+registry.k8s.io+registry.cn-hangzhou.aliyuncs.com/serialt+' /etc/containerd/config.toml cat \u003e /etc/containerd/certs.d/docker.io/hosts.toml \u003c\u003c EOF server = \"https://docker.io\" [host.\"https://docker.mirrors.sjtug.sjtu.edu.cn\"] capabilities = [\"pull\", \"resolve\", \"push\"] # skip_verify = true # ca = \"/path/to/ca.crt\" EOF systemctl restart containerd systemctl enable containerd ä½¿ç”¨crictlå·¥å…·ç®¡ç†containerdå®¹å™¨ tee /etc/crictl.yaml \u003c\u003cEOF runtime-endpoint: unix:///run/containerd/containerd.sock image-endpoint: unix:///run/containerd/containerd.sock timeout: 10 debug: false EOF å…³é—­äº¤æ¢åˆ†åŒº # ä¸´æ—¶æ–¹æ³• [root@k8s-m1 ~]# swapoff -a [root@k8s-m1 ~]# free -h total used free shared buff/cache available Mem: 972M 344M 67M 8.1M 559M 456M Swap: 0B 0B 0B # æ°¸ä¹…æ–¹æ³• [root@k8s-m1 ~]# sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab å®‰è£…kubernetes [root@k8s-m1 ~]# yum -y install kubeadm-1.26.5 kubectl-1.26.5 kubelet-1.26.5 kubectl åœ¨nodeèŠ‚ç‚¹ä¸Šå¯ä»¥ä¸å®‰è£… ","date":"2024-08-11","objectID":"/posts/2024-08-11-kubeadm/:1:7","tags":["kubeadm"],"title":"kubeadm","uri":"/posts/2024-08-11-kubeadm/"},{"categories":["DevOps","k8s"],"content":"8ã€è·å–k8sçš„é•œåƒ [root@k8s-m1 ~]# kubeadm config images list --kubernetes-version=v1.26.5 äºk8sæ˜¯è°·æ­Œå¼€å‘çš„ï¼Œå¦‚æœèƒ½ç§‘å­¦ä¸Šç½‘ï¼Œå°±ç›´æ¥è·å–k8sé•œåƒï¼Œä¸ç„¶éœ€è¦å›½å†…é•œåƒåŠ é€Ÿï¼‰ æ³¨æ„ï¼šk8så¯¹é•œåƒç‰ˆæœ¬è¦æ±‚æ¯”è¾ƒé«˜ï¼Œä»¥ä¸‹æ“ä½œå»ºè®®ä½¿ç”¨è„šæœ¬è¿›è¡Œ [root@k8s9 ~]# cat pull-k8s.sh #!/bin/bash version=v1.26.5 K8S_URL=registry.k8s.io # MIRROR_URL=docker.io/serialt MIRROR_URL=registry.cn-hangzhou.aliyuncs.com/serialt images=`kubeadm config images list --kubernetes-version=${version} |awk -F '/' '{print $NF}'` for imageName in ${images[@]} do ctr images pull ${MIRROR_URL}/${imageName} echo ${imageName} | grep coredns if [[ $? == 0 ]];then ctr images tag ${MIRROR_URL}/${imageName} ${K8S_URL}/coredns/${imageName} else ctr images tag ${MIRROR_URL}/${imageName} ${K8S_URL}/${imageName} fi ctr images rm ${MIRROR_URL}/$imageName done [root@k8s9 ~]# cat pull-k8s.sh #!/bin/bash version=v1.26.4 K8S_URL=registry.k8s.io # MIRROR_URL=docker.io/serialt MIRROR_URL=registry.cn-hangzhou.aliyuncs.com/serialt images=`kubeadm config images list --kubernetes-version=${version} |awk -F '/' '{print $NF}'` for imageName in ${images[@]} do ctr -n k8s.io images pull ${MIRROR_URL}/${imageName} echo ${imageName} | grep coredns if [[ $? == 0 ]];then ctr -n k8s.io images tag ${MIRROR_URL}/${imageName} ${K8S_URL}/coredns/${imageName} else ctr -n k8s.io images tag ${MIRROR_URL}/${imageName} ${K8S_URL}/${imageName} fi ctr -n k8s.io images rm ${MIRROR_URL}/$imageName done ","date":"2024-08-11","objectID":"/posts/2024-08-11-kubeadm/:1:8","tags":["kubeadm"],"title":"kubeadm","uri":"/posts/2024-08-11-kubeadm/"},{"categories":["DevOps","k8s"],"content":"9ã€åˆå§‹åŒ–é›†ç¾¤ æ–¹æ³•ä¸€ï¼šé€‚ç”¨äºå•masterèŠ‚ç‚¹ è®¾ç½®kubeletå¼€æœºè‡ªå¯ [root@k8s-m1 ~]# systemctl enable kubelet åˆå§‹åŒ–èŠ‚ç‚¹ [root@k8s-m1 ~]# kubeadm init --kubernetes-version=v1.26.4 --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=SystemVerification è‹¥æƒ³å¿½ç•¥æŸäº›ä¿¡æ¯ï¼ŒåŠ ä¸Šâ€“ignore-preflight-errors=[æç¤ºä¿¡æ¯çš„å] ä¾‹å¦‚ â€“ignore-preflight-errors=SystemVerification kubeadmåˆå§‹åŒ–æ•´ä¸ªé›†ç¾¤çš„è¿‡ç¨‹ï¼Œç”Ÿæˆç›¸å…³çš„å„ç§è¯ä¹¦ã€kubeconfigæ–‡ä»¶ã€bootstraptokenç­‰ç­‰ï¼Œåè¾¹æ˜¯ä½¿ç”¨kubeadm joinå¾€é›†ç¾¤ä¸­æ·»åŠ èŠ‚ç‚¹æ—¶ç”¨åˆ°çš„å‘½ä»¤ï¼Œä¸‹é¢çš„å‘½ä»¤æ˜¯é…ç½®å¦‚ä½•ä½¿ç”¨kubectlè®¿é—®é›†ç¾¤çš„æ–¹å¼ï¼š [root@k8s-m1 ~]# mkdir -p $HOME/.kube [root@k8s-m1 ~]# cp -i /etc/kubernetes/admin.conf $HOME/.kube/config [root@k8s-m1 ~]# chown $(id -u):$(id -g) $HOME/.kube/config ä½¿ç”¨é…ç½®æ–‡ä»¶è¿›è¡Œåˆå§‹åŒ–èŠ‚ç‚¹ å®˜ç½‘é“¾æ¥ï¼šhttps://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-config/ æ–¹æ³•äºŒï¼šä½¿ç”¨é…ç½®æ–‡ä»¶åˆå§‹åŒ–èŠ‚ç‚¹ ç”Ÿæˆæ–‡ä»¶ [root@k8s-m1 ~]# kubeadm config print init-defaults --component-configs KubeProxyConfiguration,KubeletConfiguration \u003e kubeadm-init.yml åˆå§‹åŒ–k8sé›†ç¾¤ è‡ªå®šä¹‰kubeletå‚æ•°ï¼š https://kubernetes.io/zh-cn/docs/reference/config-api/kubelet-config.v1beta1/ https://blog.dianduidian.com/post/%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96kubelet%E5%BD%93%E5%89%8D%E9%85%8D%E7%BD%AE/ https://www.cnblogs.com/shenyuanhaojie/p/16407553.html https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/node-pressure-eviction/ imageMinimumGCAge: 20m #æ˜¯å¯¹æœªä½¿ç”¨é•œåƒè¿›è¡Œåƒåœ¾æœé›†ä¹‹å‰å…è®¸å…¶å­˜åœ¨çš„æ—¶é•¿ã€‚ imageGCHighThresholdPercent: 80 imageGCLowThresholdPercent: 70 maxPods: 200 ç¤ºä¾‹æ–‡ä»¶ apiVersion: kubeadm.k8s.io/v1beta3 bootstrapTokens: - groups: - system:bootstrappers:kubeadm:default-node-token token: abcdef.0123456789abcdef ttl: 24h0m0s usages: - signing - authentication kind: InitConfiguration localAPIEndpoint: advertiseAddress: 172.16.1.136 # éœ€è¦ä¿®æ”¹ä¸ºæœ¬æœºip bindPort: 6443 nodeRegistration: criSocket: unix:///var/run/containerd/containerd.sock imagePullPolicy: IfNotPresent name: r1 taints: null --- apiServer: timeoutForControlPlane: 4m0s apiVersion: kubeadm.k8s.io/v1beta3 certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controlPlaneEndpoint: \"172.16.1.200:6443\" # æ§åˆ¶å¹³é¢ip controllerManager: {} dns: {} etcd: local: dataDir: /var/lib/etcd imageRepository: registry.k8s.io kind: ClusterConfiguration kubernetesVersion: 1.26.0 networking: dnsDomain: cluster.local podSubnet: \"10.244.0.0/16\" # æŒ‡å®špodç½‘æ®µ serviceSubnet: 10.96.0.0/12 scheduler: {} --- apiVersion: kubeproxy.config.k8s.io/v1alpha1 bindAddress: 0.0.0.0 bindAddressHardFail: false clientConnection: acceptContentTypes: \"\" burst: 0 contentType: \"\" kubeconfig: /var/lib/kube-proxy/kubeconfig.conf qps: 0 clusterCIDR: \"\" configSyncPeriod: 0s conntrack: maxPerCore: null min: null tcpCloseWaitTimeout: null tcpEstablishedTimeout: null detectLocal: bridgeInterface: \"\" interfaceNamePrefix: \"\" detectLocalMode: \"\" enableProfiling: false healthzBindAddress: \"\" hostnameOverride: \"\" iptables: localhostNodePorts: null masqueradeAll: false masqueradeBit: null minSyncPeriod: 0s syncPeriod: 0s ipvs: excludeCIDRs: null minSyncPeriod: 0s scheduler: \"wrr\" # è®¾ç½®è½®è¯¢ç®—æ³• strictARP: true # æ–¹ä¾¿ä½¿ç”¨metallb syncPeriod: 0s tcpFinTimeout: 0s tcpTimeout: 0s udpTimeout: 0s kind: KubeProxyConfiguration metricsBindAddress: \"\" mode: \"ipvs\" # ä½¿ç”¨ipvs nodePortAddresses: null oomScoreAdj: null portRange: \"\" showHiddenMetricsForVersion: \"\" winkernel: enableDSR: false forwardHealthCheckVip: false networkName: \"\" rootHnsEndpointName: \"\" sourceVip: \"\" --- apiVersion: kubelet.config.k8s.io/v1beta1 authentication: anonymous: enabled: false webhook: cacheTTL: 0s enabled: true x509: clientCAFile: /etc/kubernetes/pki/ca.crt authorization: mode: Webhook webhook: cacheAuthorizedTTL: 0s cacheUnauthorizedTTL: 0s cgroupDriver: systemd clusterDNS: - 10.96.0.10 clusterDomain: cluster.local cpuManagerReconcilePeriod: 0s evictionPressureTransitionPeriod: 0s fileCheckFrequency: 0s healthzBindAddress: 127.0.0.1 healthzPort: 10248 httpCheckFrequency: 0s imageMinimumGCAge: 20m # é•œåƒå›æ”¶æ—¶é—´ imageGCHighThresholdPercent: 80 # è§¦å‘é•œåƒå›æ”¶çš„ç™¾åˆ†æ¯” imageGCLowThresholdPercent: 70 maxPods: 200 # è®¾ç½®node èŠ‚ç‚¹æœ€å¤§podæ•° kind: KubeletConfiguration logging: flushFrequency: 0 options: json: infoBufferSize: \"0\" verbosity: 0 memorySwap: {} n","date":"2024-08-11","objectID":"/posts/2024-08-11-kubeadm/:1:9","tags":["kubeadm"],"title":"kubeadm","uri":"/posts/2024-08-11-kubeadm/"},{"categories":["DevOps","k8s"],"content":"10ã€å®‰è£…ç½‘å¡ å®‰è£…flannel # Needs manual creation of namespace to avoid helm error kubectl create ns kube-flannel kubectl label --overwrite ns kube-flannel pod-security.kubernetes.io/enforce=privileged helm repo add flannel https://flannel-io.github.io/flannel/ helm install flannel --set podCidr=\"10.244.0.0/16\" --namespace kube-flannel flannel/flannel ä¸‹è½½flannelé•œåƒ #!/bin/bash SRC_URL=docker.io/rancher #MIRROR_URL=docker.io/serialt MIRROR_URL=registry.cn-hangzhou.aliyuncs.com/serialt imageListFlannel=( ${SRC_URL}/mirrored-flannelcni-flannel-cni-plugin:v1.1.0 ${SRC_URL}/mirrored-flannelcni-flannel:v0.19.2 ) for imageNameFlannel in ${imageListFlannel[@]} do imageNameFlannel=`echo ${imageNameFlannel} |awk -F '/' '{print $NF}'` docker pull ${MIRROR_URL}/${imageNameFlannel} docker tag ${MIRROR_URL}/${imageNameFlannel} ${SRC_URL}/${imageNameFlannel} docker rmi ${MIRROR_URL}/${imageNameFlannel} done åˆ é™¤nodeèŠ‚ç‚¹ä¸Šæ®‹ç•™çš„ç½‘ç»œ # åˆ é™¤cni0 ifconfig cni0 down ip link delete cni0 rm -rf /var/lib/cni/ # åˆ é™¤flannelç½‘ç»œ ifconfig flannel.1 down ip link delete flannel.1 rm -f /etc/cni/net.d/* # é‡å¯kubelet systemctl restart kubelet å®‰è£…calicoç½‘å¡ [root@k8s-m1 ~]# helm repo add projectcalico https://projectcalico.docs.tigera.io/charts [root@k8s-m1 ~]# helm repo update [root@k8s-m1 ~]# helm install calico projectcalico/tigera-operator --version v3.25.1 --namespace tigera-operator --create-namespace #!/bin/bash SRC_URL=docker.io/calico #MIRROR_URL=docker.io/serialt MIRROR_URL=registry.cn-hangzhou.aliyuncs.com/serialt imageListCalico=( ${MIRROR_URL}/cni:v3.22.5 ${MIRROR_URL}/pod2daemon-flexvol:v3.22.5 ${MIRROR_URL}/node:v3.22.5 ${MIRROR_URL}/kube-controllers:v3.22.5 ) for imageNameCalico in ${imageListCalico[@]} do imageNameCalico=`echo ${imageNameCalico} |awk -F '/' '{print $NF}'` docker pull ${MIRROR_URL}/${imageNameCalico} docker tag ${MIRROR_URL}/${imageNameCalico} ${SRC_URL}/${imageNameCalico} docker rmi ${MIRROR_URL}/${imageNameCalico} done 11ã€èŠ‚ç‚¹åŠ å…¥ nodeèŠ‚ç‚¹åŠ å…¥ [root@k8s-n1 ~]# kubeadm join 192.168.122.100:6443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:174be9ec793b09d1b5a17da472bdb33c25463c65b0a42c8c09c4248783103b8b masterèŠ‚ç‚¹æŸ¥çœ‹ [root@k8s-m1 ~]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-m1.com Ready master 60m v1.18.15 k8s-n1.com Ready \u003cnone\u003e 113s v1.18.15 å¦‚æœé•¿æ—¶é—´æ˜¯NotReadyï¼Œåˆ™æ£€æµ‹æ˜¯å¦æœ‰flannelé•œåƒï¼Œæˆ–æŸ¥çœ‹æ—¥å¿—/var/log/messages æ£€æŸ¥é›†ç¾¤çŠ¶æ€ [root@k8s-m1 ~]# kubectl get pod --all-namespaces NAMESPACE NAME READY STATUS RESTARTS AGE kube-system coredns-66bff467f8-fp948 1/1 Running 0 109s kube-system coredns-66bff467f8-vmhwq 1/1 Running 0 109s kube-system etcd-k8s-m1.com 1/1 Running 0 2m4s kube-system kube-apiserver-k8s-m1.com 1/1 Running 0 2m4s kube-system kube-controller-manager-k8s-m1.com 1/1 Running 0 2m4s kube-system kube-flannel-ds-8wpjv 1/1 Running 0 22s kube-system kube-flannel-ds-dhwtr 1/1 Running 0 38s kube-system kube-proxy-dd8l9 1/1 Running 0 22s kube-system kube-proxy-wh9bc 1/1 Running 0 109s kube-system kube-scheduler-k8s-m1.com 1/1 Running 0 2m4s [root@k8s-m1 ~]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-m1.com Ready master 2m16s v1.18.15 k8s-n1.com Ready \u003cnone\u003e 30s v1.18.15 tokençš„åˆ›å»ºåŠä½¿ç”¨ tokenç”¨äºæœºå™¨åŠ å…¥kubernetesé›†ç¾¤æ—¶ç”¨åˆ°ï¼Œé»˜è®¤token 24å°æ—¶å°±ä¼šè¿‡æœŸï¼Œåç»­çš„æœºå™¨è¦åŠ å…¥é›†ç¾¤éœ€è¦é‡æ–°ç”Ÿæˆtoken [root@k8s-m1 ~]# kubeadm token list TOKEN TTL EXPIRES USAGES DESCRIPTION EXTRA GROUPS f2b012.1416e09e3d1fff4d 23h 2018-06-24T21:26:17+08:00 authentication,signing The default bootstrap token generated by 'kubeadm init'. system:bootstrappers:kubeadm:default-node-token 24å°æ—¶åéœ€è¦é‡æ–°åˆ›å»ºtoken åŠ å…¥nodeèŠ‚ç‚¹ # 24 å°æ—¶æœ‰æ•ˆ [root@k8s-m1 ~]# kubeadm token create --print-join-command kubeadm join --token 48a5ec.6297ad9983652bc6 192.168.191.175:6443 --discovery-token-ca-cert-hash sha256:25e52920789d850d1b04b032e0da4a814fa0efd9ee85542500769b86f3f9b6dc [root@k8s-m1 ~]# kubeadm token create --ttl 0 --print-join-commandå¯ä»¥åˆ›å»ºä¸€ä¸ªæ°¸ä¸è¿‡æœŸçš„token. # nodeèŠ‚ç‚¹æ‰§è¡Œä»¥ä¸Šå‘½ä»¤ åŠ å…¥masterèŠ‚ç‚¹ # æ–°ç‰ˆæœ¬ [root@k8s-m1 ~]# kubeadm init phase upload-certs --upload-certs [upload-certs] Storing the certificates in ConfigMap \"kubeadm-certs\" in the \"kube-system\" Namespace ","date":"2024-08-11","objectID":"/posts/2024-08-11-kubeadm/:1:10","tags":["kubeadm"],"title":"kubeadm","uri":"/posts/2024-08-11-kubeadm/"},{"categories":["DevOps","k8s"],"content":"12ã€firewalldå¼€æ”¾kubernetesç«¯å£ https://www.cnblogs.com/Dev0ps/p/11401530.html k8s masteréœ€è¦å¼€å¯ä»¥ä¸‹ç«¯å£ firewall-cmd --permanent --add-port=6443/tcp \\ --add-port=2379-2380/tcp \\ --add-port=10250/tcp \\ --add-port=10251/tcp \\ --add-port=10252/tcp \\ --add-port=10255/tcp \\ --add-port=8472/udp \\ --add-port=443/udp \\ --add-port=53/udp \\ --add-port=53/tcp \\ --add-port=9153/tcp firewall-cmd --add-masquerade --permanent firewall-cmd --reload # only if you want NodePorts exposed on control plane IP as well firewall-cmd --permanent --add-port=30000-32767/tcp systemctl restart firewalld k8s nodeéœ€è¦å¼€å¯ä»¥ä¸‹ç«¯å£ firewall-cmd --permanent --add-port=10250/tcp \\ --add-port=10255/tcp \\ --add-port=8472/udp \\ --add-port=443/udp \\ --add-port=30000-32767/tcp \\ --add-port=53/udp \\ --add-port=53/tcp \\ --add-port=9153/tcp firewall-cmd --add-masquerade --permanent firewall-cmd --reload ä»¥ä¸‹å‡ ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼š 8472/udpä¸ºflannelçš„é€šä¿¡ç«¯å£ 443/tcp ä¸ºKubernetes serverç«¯å£ æ³¨æ„ä¸€ç‚¹ï¼šä¸€å®šè¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ‰“å¼€NATï¼Œé»˜è®¤æ˜¯å…³é—­çŠ¶æ€ firewall-cmd --add-masquerade --permanent # æ£€æŸ¥æ˜¯å¦å…è®¸NATè½¬å‘ firewall-cmd --query-masquerade # å…³é—­NATè½¬å‘ firewall-cmd --remove-masquerade å¦‚æœä½ ä½¿ç”¨äº†istioè¿˜æœ‰æŠŠistio-pilotçš„ç«¯å£åŠ åˆ°é˜²ç«å¢™é‡Œï¼š firewall-cmd --permanent --add-port=15010-15014/tcp å¦åˆ™ä¼šå‡ºç°ä»¥ä¸‹æŠ¥é”™ï¼š Envoy proxy is NOT ready ","date":"2024-08-11","objectID":"/posts/2024-08-11-kubeadm/:1:11","tags":["kubeadm"],"title":"kubeadm","uri":"/posts/2024-08-11-kubeadm/"},{"categories":["DevOps","k8s"],"content":"kubeadm-cert å®˜æ–¹çš„ kubeadm éƒ¨ç½²çš„é›†ç¾¤ CA æœ‰æ•ˆæœŸé»˜è®¤æ˜¯10å¹´ï¼Œå…¶ä»–è¯ä¹¦æœ‰æ•ˆæœŸé»˜è®¤æ˜¯1å¹´ï¼Œ1å¹´æœ‰æ•ˆæœŸåœ¨çœŸå®ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå¾€å¾€ä¸å¤Ÿï¼Œå› æ­¤éœ€è¦è‡ªè¡Œä¿®æ”¹ CA çš„æœ‰æ•ˆæœŸç„¶åç¼–è¯‘ï¼›å¯¹äºå·²ç»å­˜åœ¨çš„é›†ç¾¤ï¼Œåˆ™å¯ä»¥ä¿®æ”¹ renew çš„æ—¶é—´åœ¨è®©è¯ä¹¦æœ‰æ•ˆæœŸè¾¾åˆ°10å¹´ã€‚ ","date":"2024-08-11","objectID":"/posts/2024-08-11-kubeadm-cert/:1:0","tags":["kubeadm-cert"],"title":"kubeadm-cert","uri":"/posts/2024-08-11-kubeadm-cert/"},{"categories":["DevOps","k8s"],"content":"ä¸€ã€æ›´æ–°è¯ä¹¦ 1ã€æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ kubeadm certs check-expiration [check-expiration] Reading configuration from the cluster... [check-expiration] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml' CERTIFICATE EXPIRES RESIDUAL TIME CERTIFICATE AUTHORITY EXTERNALLY MANAGED admin.conf Aug 06, 2022 19:03 UTC 344d no apiserver Aug 06, 2022 19:03 UTC 344d ca no apiserver-etcd-client Aug 06, 2022 19:03 UTC 344d etcd-ca no apiserver-kubelet-client Aug 06, 2022 19:03 UTC 344d ca no controller-manager.conf Aug 06, 2022 19:03 UTC 344d no etcd-healthcheck-client Aug 06, 2022 19:03 UTC 344d etcd-ca no etcd-peer Aug 06, 2022 19:03 UTC 344d etcd-ca no etcd-server Aug 06, 2022 19:03 UTC 344d etcd-ca no front-proxy-client Aug 06, 2022 19:03 UTC 344d front-proxy-ca no scheduler.conf Aug 06, 2022 19:03 UTC 344d no CERTIFICATE AUTHORITY EXPIRES RESIDUAL TIME EXTERNALLY MANAGED ca Aug 04, 2031 19:03 UTC 9y no etcd-ca Aug 04, 2031 19:03 UTC 9y no front-proxy-ca Aug 04, 2031 19:03 UTC 9y no è¯¥å‘½ä»¤æ˜¾ç¤º /etc/kubernetes/pki æ–‡ä»¶å¤¹ä¸­çš„å®¢æˆ·ç«¯è¯ä¹¦ä»¥åŠ kubeadmï¼ˆadmin.conf,controller-manager.conf å’Œ scheduler.confï¼‰ä½¿ç”¨çš„ KUBECONFIG æ–‡ä»¶ä¸­åµŒå…¥çš„å®¢æˆ·ç«¯è¯ä¹¦çš„åˆ°æœŸæ—¶é—´ / å‰©ä½™æ—¶é—´ã€‚ å¦å¤–ï¼Œkubeadm ä¼šæ˜¾ç¤ºç”¨æˆ·è¯ä¹¦æ˜¯å¦ç”±å¤–éƒ¨ç®¡ç†ï¼ˆEXTERNALLY MANAGEDï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·åº”è¯¥å°å¿ƒçš„æ‰‹åŠ¨ / ä½¿ç”¨å…¶ä»–å·¥å…·æ¥ç®¡ç†è¯ä¹¦æ›´æ–°ã€‚ **è¯´æ˜ï¼š**ä¸Šé¢çš„åˆ—è¡¨ä¸­æ²¡æœ‰åŒ…å« kubelet.confï¼Œå› ä¸º kubeadm å°† kubelet é…ç½®ä¸ºè‡ªåŠ¨æ›´æ–°è¯ä¹¦ã€‚è½®æ¢çš„è¯ä¹¦ä½äºç›®å½• /var/lib/kubelet/pkiã€‚è¦ä¿®å¤è¿‡æœŸçš„ kubelet å®¢æˆ·ç«¯è¯ä¹¦ï¼Œè¯·å‚é˜… kubelet å®¢æˆ·ç«¯è¯ä¹¦è½®æ¢å¤±è´¥ã€‚ 2ã€æ›´æ–°è¯ä¹¦ 1ï¼‰å¤‡ä»½é›†ç¾¤è¯ä¹¦ **è¯´æ˜ï¼š**å¦‚æœä½ è¿è¡Œäº†ä¸€ä¸ª HA é›†ç¾¤ï¼Œä»¥ä¸‹å‘½ä»¤éœ€è¦åœ¨æ‰€æœ‰ Master èŠ‚ç‚¹ä¸Šæ‰§è¡Œã€‚ cp -a /etc/kubernetes/ /etc/kubernetes-`date +%Y%m%d` kubectl get cm kubeadm-config -n kube-system -o yaml \u003e /root/kubeadm-config.yaml 2ï¼‰æ›´æ–°è¯ä¹¦ æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ›´æ–°æ‰€æœ‰è¯ä¹¦ **è¯´æ˜ï¼š**å¦‚æœä½ è¿è¡Œäº†ä¸€ä¸ª HA é›†ç¾¤ï¼Œè¿™ä¸ªå‘½ä»¤éœ€è¦åœ¨æ‰€æœ‰ Master èŠ‚ç‚¹ä¸Šæ‰§è¡Œã€‚ kubeadm certs renew all å‡ºç°ç±»ä¼¼ä»¥ä¸‹è¾“å‡ºè¯´æ˜è¯ä¹¦æ›´æ–°å®Œæˆï¼Œå¹¶ä¸”æœ€åä¸€è¡Œ Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates. æç¤ºè¦æ±‚è¦é‡å¯ kube-apiserverã€kube-controller-managerã€kube-scheduler å’Œ etcd ä½¿å…¶ä½¿ç”¨æ–°è¯ä¹¦ã€‚ [renew] Reading configuration from the cluster... [renew] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml' certificate embedded in the kubeconfig file for the admin to use and for kubeadm itself renewed certificate for serving the Kubernetes API renewed certificate the apiserver uses to access etcd renewed certificate for the API server to connect to kubelet renewed certificate embedded in the kubeconfig file for the controller manager to use renewed certificate for liveness probes to healthcheck etcd renewed certificate for etcd nodes to communicate with each other renewed certificate for serving etcd renewed certificate for the front proxy client renewed certificate embedded in the kubeconfig file for the scheduler manager to use renewed Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates. ç¡®è®¤è¯ä¹¦æ˜¯å¦ç»­æœŸæˆåŠŸ # kubeadm certs check-expiration [check-expiration] Reading configuration from the cluster... [check-expiration] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml' CERTIFICATE EXPIRES RESIDUAL TIME CERTIFICATE AUTHORITY EXTERNALLY MANAGED admin.conf Aug 29, 2022 04:20 UTC 364d no apiserver Aug 29, 2022 04:20 UTC 364d ca no apiserver-etcd-client Aug 29, 2022 04:20 UTC 364d etcd-ca no apiserver-kubelet-client Aug 29, 2022 04:20 UTC 364d ca no controller-manager.conf Aug 29, 2022 04:20 UTC 364d no etcd-healthcheck-client Aug 29, 2022 04:20 UTC 364d etcd-ca no etcd-peer Aug 29, 2022 04:20 UTC 364d etcd-ca no etcd-server Aug 29, 2022 04:20 UTC 364d etcd-ca no front-proxy-client Aug 29, 2022 04:20 UTC 364d front-proxy-ca no scheduler.conf Aug 29, 2022 04:20 UTC 364d no CERTIFICATE AUTHORITY EXPIRES RESIDUAL TIME EXTERNALLY MANAGED ca Aug 04, 2031 19:03 UTC 9y no etcd-ca Aug 04, 2031 19:03 UTC 9y no front-proxy-ca Aug 04, 2031 19:03 UTC 9y no **è¯´æ˜ï¼š**ä»å‘½ä»¤è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯è¯ä¹¦çš„åˆ°æœŸæ—¶é—´å‡å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸è¿‡ä¸æ˜¯é¡ºå»¶ä¸€å¹´ï¼Œ è€Œæ˜¯ä»æ‰§è¡Œ renew æˆåŠŸçš„æ—¶é—´å¼€å§‹ç»­ç­¾ä¸€å¹´ã€‚ 3ï¼‰ä¿®æ”¹kube-controller-manager ç»­ç­¾kubeletè¯ä¹¦æ—¶é—´ kubelet","date":"2024-08-11","objectID":"/posts/2024-08-11-kubeadm-cert/:1:1","tags":["kubeadm-cert"],"title":"kubeadm-cert","uri":"/posts/2024-08-11-kubeadm-cert/"},{"categories":["DevOps","k8s"],"content":"äºŒã€ç¼–è¯‘kubeadm kubeadm é»˜è®¤è¯ä¹¦ä¸ºä¸€å¹´ï¼Œä¸€å¹´è¿‡æœŸåï¼Œä¼šå¯¼è‡´ api service ä¸å¯ç”¨ï¼Œä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šå‡ºç°ï¼šx509: certificate has expired or is not yet validï¼ŒGoogle å»ºè®®é€šè¿‡ä¸åœæ›´æ–°ç‰ˆæœ¬æ¥è‡ªåŠ¨æ›´æ–°è¯ä¹¦ï¼Œè‹¥éœ€è¦é•¿æœŸæœ‰æ•ˆï¼Œå»ºè®®è‡ªå·±ç¼–è¯‘kubeadm å‚è€ƒæ–‡æ¡£ï¼šhttps://zhuanlan.zhihu.com/p/444057661 ä»¥ä¸‹å…¼å®¹ç‰ˆæœ¬ï¼š 1.17.0 1.18.0 1.19.0 1.20.0 1.21.0 1.22.0 1.23.0 1ã€ä¸‹è½½æºç  [sugar@imau github]$ wget https://github.com/kubernetes/kubernetes/archive/v1.21.14.tar.gz [sugar@imau github]$ tar -xf v1.21.14.tar.gz [sugar@imau kubernetes-1.21.14]$ 2ã€ä¿®æ”¹caæœ‰æ•ˆæœŸ # caè¯ä¹¦é»˜è®¤10å¹´ [sugar@imau kubernetes-1.21.14]$ vim staging/src/k8s.io/client-go/util/cert/cert.go // è¿™ä¸ªæ–¹æ³•é‡Œé¢ NotAfter: now.Add(duration365d * 10).UTC() // é»˜è®¤æœ‰æ•ˆæœŸå°±æ˜¯ 10 å¹´ï¼Œæ”¹æˆ 100 å¹´ // è¾“å…¥ /NotAfter æŸ¥æ‰¾ï¼Œå›è½¦å®šä½ func NewSelfSignedCACert(cfg Config, key crypto.Signer) (*x509.Certificate, error) { now := time.Now() tmpl := x509.Certificate{ SerialNumber: new(big.Int).SetInt64(0), Subject: pkix.Name{ CommonName: cfg.CommonName, Organization: cfg.Organization, }, NotBefore: now.UTC(), // NotAfter: now.Add(duration365d * 10).UTC(), NotAfter: now.Add(duration365d * 100).UTC(), KeyUsage: x509.KeyUsageKeyEncipherment | x509.KeyUsageDigitalSignature | x509.KeyUsageCertSign, BasicConstraintsValid: true, IsCA: true, } certDERBytes, err := x509.CreateCertificate(cryptorand.Reader, \u0026tmpl, \u0026tmpl, key.Public(), key) if err != nil { return nil, err } return x509.ParseCertificate(certDERBytes) } ä¿®æ”¹è¯ä¹¦æœ‰æ•ˆæœŸä¸º 100 å¹´ï¼ˆé»˜è®¤ä¸º 1 å¹´ï¼‰ vim ./cmd/kubeadm/app/constants/constants.go // å°±æ˜¯è¿™ä¸ªå¸¸é‡å®šä¹‰ CertificateValidityï¼Œæ”¹æˆ * 100 å¹´ // è¾“å…¥ /CertificateValidity æŸ¥æ‰¾ï¼Œå›è½¦å®šä½ const ( // KubernetesDir is the directory Kubernetes owns for storing various configuration files KubernetesDir = \"/etc/kubernetes\" // ManifestsSubDirName defines directory name to store manifests ManifestsSubDirName = \"manifests\" // TempDirForKubeadm defines temporary directory for kubeadm // should be joined with KubernetesDir. TempDirForKubeadm = \"tmp\" // CertificateValidity defines the validity for all the signed certificates generated by kubeadm // CertificateValidity = time.Hour * 24 * 365 CertificateValidity = time.Hour * 24 * 365 * 100 // CACertAndKeyBaseName defines certificate authority base name CACertAndKeyBaseName = \"ca\" // CACertName defines certificate name CACertName = \"ca.crt\" // CAKeyName defines certificate name CAKeyName = \"ca.key\" éªŒè¯ä¸€ä¸‹å·²ç»æ­£ç¡®ä¿®æ”¹ï¼š cat ./staging/src/k8s.io/client-go/util/cert/cert.go | grep NotAfter cat ./cmd/kubeadm/app/constants/constants.go | grep CertificateValidity git diff 3ã€ç¼–è¯‘ ä¸ºäº†ä¸å½±å“æœºå™¨ç¯å¢ƒï¼Œé‡‡ç”¨docker ä¸­ç¼–è¯‘ 1ï¼‰åˆ¶ä½œbuildçš„åŸºç¡€é•œåƒ FROM rockylinux:9 LABEL mantainer=\"serialt \u003ctserialt@gmail.com\u003e rocky9 image\" # change yum repo to ustc RUN sed -e 's|^mirrorlist=|#mirrorlist=|g' \\ -e 's|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.ustc.edu.cn/rocky|g' \\ -i.bak \\ /etc/yum.repos.d/rocky*.repo \u0026\u0026 \\ yum -y install epel-release \u0026\u0026 \\ sed -e 's|^metalink=|#metalink=|g' \\ -e 's|^#baseurl=https\\?://download.fedoraproject.org/pub/epel/|baseurl=https://mirrors.ustc.edu.cn/epel/|g' \\ -e 's|^#baseurl=https\\?://download.example/pub/epel/|baseurl=https://mirrors.ustc.edu.cn/epel/|g' \\ -i.bak \\ /etc/yum.repos.d/epel*.repo # install base software RUN yum -y install git vim-enhanced bash-completion wget gcc make golang \u0026\u0026 \\ yum groupinstall \"Development Tools\" -y \u0026\u0026 \\ yum -y upgrade \u0026\u0026 \\ yum clean all ENV LANG zh_CN.UTF-8 ENV TZ \"Asia/Shanghai\" WORKDIR /root EXPOSE 22 80 443 CMD /bin/bash # ç¼–è¯‘kubeadm, è¿™é‡Œä¸»è¦ç¼–è¯‘ kubeadm å³å¯ make all WHAT=cmd/kubeadm GOFLAGS=-v # ç¼–è¯‘ kubelet # make all WHAT=cmd/kubelet GOFLAGS=-v # ç¼–è¯‘ kubectl # make all WHAT=cmd/kubectl GOFLAGS=-v CentOSï¼š yum groupinstall \"Development Tools\" -y #gcc, make etc. yum install rsync jq -y Ubuntuï¼š sudo apt install build-essential #(Following command will install essential commands like gcc, make etc.) sudo apt install rsync jq -y GoLang ç¯å¢ƒ æŸ¥çœ‹ kube-cross çš„ TAG ç‰ˆæœ¬å· [root@51 kubernetes-1.21.14]# cat ./build/build-image/cross/VERSION v1.21.0-go1.16.15-buster.0 GitHubï¼šhttps://github.com/serialt/kubeadm 4ã€æ›´æ–°è¯ä¹¦ å¦‚æœæ˜¯ä½¿ç”¨åŸç‰ˆ kubeadm å®‰è£…ä¹‹åï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤æ›´æ–°è¯ä¹¦æœ‰æ•ˆæœŸåˆ° 100 å¹´ï¼Œä½†å› ä¸ºcaæœ‰æ•ˆæœŸæ˜¯10å¹´ï¼Œä½¿ç”¨kubeadmæ›´æ–°è¯ä¹¦çš„æ—¶å€™å¹¶ä¸ä¼šæ›´æ–°caè¯ä¹¦ï¼Œå»ºè®®ä¿®æ”¹åˆ°9å¹´ï¼›æˆ–è€…ä½¿ç”¨ç¼–è¯‘çš„kub","date":"2024-08-11","objectID":"/posts/2024-08-11-kubeadm-cert/:1:2","tags":["kubeadm-cert"],"title":"kubeadm-cert","uri":"/posts/2024-08-11-kubeadm-cert/"},{"categories":["DevOps","k8s"],"content":"æœåŠ¡æš´éœ² ","date":"2024-08-11","objectID":"/posts/2024-08-11-k8s-metallb-istio/:1:0","tags":["metallb-istio"],"title":"metallb-istio","uri":"/posts/2024-08-11-k8s-metallb-istio/"},{"categories":["DevOps","k8s"],"content":"ä¸€ã€metallb helm repo add metallb https://metallb.github.io/metallb helm install metallb metallb/metallb --version=0.13.7 -n metallb-system --create-namespace helm repo add serialt https://serialt.github.io/helm-charts helm install metallb-config serialt/metallb-config --set \"ipPoolRange=192.168.80.40-192.168.80.49\" -n metallb-system --version 0.0.1 helm æµ‹è¯•ï¼š https://artifacthub.io/packages/helm/bitnami/nginx $ helm repo add bitnami https://charts.bitnami.com/bitnami $ helm install my-release bitnami/nginx [root@localhost k3s]# kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 \u003cnone\u003e 443/TCP 4h my-release-nginx LoadBalancer 10.43.100.152 192.168.8.200 80:30840/TCP 63m [root@localhost k3s]# curl 192.168.8.200 \u003c!DOCTYPE html\u003e \u003chtml\u003e \u003chead\u003e \u003ctitle\u003eWelcome to nginx!\u003c/title\u003e \u003cstyle\u003e html { color-scheme: light dark; } body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } \u003c/style\u003e \u003c/head\u003e \u003cbody\u003e \u003ch1\u003eWelcome to nginx!\u003c/h1\u003e \u003cp\u003eIf you see this page, the nginx web server is successfully installed and working. Further configuration is required.\u003c/p\u003e \u003cp\u003eFor online documentation and support please refer to \u003ca href=\"http://nginx.org/\"\u003enginx.org\u003c/a\u003e.\u003cbr/\u003e Commercial support is available at \u003ca href=\"http://nginx.com/\"\u003enginx.com\u003c/a\u003e.\u003c/p\u003e \u003cp\u003e\u003cem\u003eThank you for using nginx.\u003c/em\u003e\u003c/p\u003e \u003c/body\u003e \u003c/html\u003e ","date":"2024-08-11","objectID":"/posts/2024-08-11-k8s-metallb-istio/:1:1","tags":["metallb-istio"],"title":"metallb-istio","uri":"/posts/2024-08-11-k8s-metallb-istio/"},{"categories":["DevOps","k8s"],"content":"äºŒã€Ingress-nginx controller: name: controller image: ## Keep false as default for now! chroot: false registry: docker.io image: serialt/controller digest: digestChroot: dnsPolicy: ClusterFirstWithHostNet hostNetwork: true ingressClassResource: # -- Name of the ingressClass name: nginx # -- Is this ingressClass enabled or not enabled: true # -- Is this the default ingressClass for the cluster default: true controllerValue: \"k8s.io/ingress-nginx\" publishService: # hostNetwork æ¨¡å¼ä¸‹è®¾ç½®ä¸ºfalseï¼Œé€šè¿‡èŠ‚ç‚¹IPåœ°å€ä¸ŠæŠ¥ingress statusæ•°æ® enabled: false # æ˜¯å¦éœ€è¦å¤„ç†ä¸å¸¦ ingressClass æ³¨è§£æˆ–è€… ingressClassName å±æ€§çš„ Ingress å¯¹è±¡ # è®¾ç½®ä¸º true ä¼šåœ¨æ§åˆ¶å™¨å¯åŠ¨å‚æ•°ä¸­æ–°å¢ä¸€ä¸ª --watch-ingress-without-class æ ‡æ³¨ watchIngressWithoutClass: false kind: DaemonSet # tolerations: # kubeadm å®‰è£…çš„é›†ç¾¤é»˜è®¤æƒ…å†µä¸‹masteræ˜¯æœ‰æ±¡ç‚¹ï¼Œéœ€è¦å®¹å¿è¿™ä¸ªæ±¡ç‚¹æ‰å¯ä»¥éƒ¨ç½² # - key: \"node-role.kubernetes.io/master\" # operator: \"Equal\" # effect: \"NoSchedule\" # nodeSelector: # å›ºå®šåˆ°master1èŠ‚ç‚¹ # kubernetes.io/hostname: master1 service: # HostNetwork æ¨¡å¼ä¸éœ€è¦åˆ›å»ºservice enabled: false admissionWebhooks: # å¼ºçƒˆå»ºè®®å¼€å¯ admission webhook enabled: true createSecretJob: resources: limits: cpu: 10m memory: 20Mi requests: cpu: 10m memory: 20Mi patchWebhookJob: resources: limits: cpu: 10m memory: 20Mi requests: cpu: 10m memory: 20Mi patch: enabled: true image: registry: docker.io image: serialt/kube-webhook-certgen digest: defaultBackend: # é…ç½®é»˜è®¤åç«¯ enabled: true name: defaultbackend image: registry: docker.io # arm64 æ¶æ„é…ç½® serialt/defaultbackend-arm64 image: serialt/defaultbackend-amd64 tcp: {} # 8080: \"default/example-tcp-svc:9000\" udp: {} # 53: \"kube-system/kube-dns:53\" helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx helm repo update helm upgrade --install ingress-nginx -n ingress-nginx --create-namespace ingress-nginx/ingress-nginx --version 4.5.2 -f ingress-nginx.yaml ","date":"2024-08-11","objectID":"/posts/2024-08-11-k8s-metallb-istio/:1:2","tags":["metallb-istio"],"title":"metallb-istio","uri":"/posts/2024-08-11-k8s-metallb-istio/"},{"categories":["DevOps","k8s"],"content":"k8s doc ","date":"2024-08-11","objectID":"/posts/2024-08-11-k8s-doc/:1:0","tags":["k8s-doc"],"title":"k8s-doc","uri":"/posts/2024-08-11-k8s-doc/"},{"categories":["DevOps","k8s"],"content":"1ã€èŠ‚ç‚¹åŠ å…¥å¤±è´¥ æ—¥å¿—ä¿¡æ¯ ...... [control-plane] Creating static Pod manifest for \"kube-controller-manager\" W0329 00:01:51.364121 19209 manifests.go:214] the default kube-apiserver authorization-mode is \"Node,RBAC\"; using \"Node,RBAC\" [control-plane] Creating static Pod manifest for \"kube-scheduler\" W0329 00:01:51.373807 19209 manifests.go:214] the default kube-apiserver authorization-mode is \"Node,RBAC\"; using \"Node,RBAC\" [check-etcd] Checking that the etcd cluster is healthy error execution phase check-etcd: etcd cluster is not healthy: failed to dial endpoint https://10.8.18.105:2379 with maintenance client: context deadline exceeded To see the stack trace of this error execute with --v=5 or higher æ ¹æ®å…³é”®ä¿¡æ¯ \"error execution phase check-etcd\" å¯çŸ¥ï¼Œå¯èƒ½æ˜¯åœ¨æ‰§è¡ŒåŠ å…¥ etcd æ—¶å€™å‡ºç°çš„é”™è¯¯ï¼Œå¯¼è‡´ master æ— æ³•åŠ å…¥åŸå…ˆçš„ kubernetes é›†ç¾¤ã€‚ è§£å†³åŠæ³•ï¼š 1ï¼‰è·å– Etcd é•œåƒåˆ—è¡¨ [root@k8s-master01 ~]# kubectl get pods -n kube-system | grep etcd etcd-k8s-master01 1/1 Running 4 4d20h etcd-k8s-master03 1/1 Running 1 4d20h 2ï¼‰è¿›å…¥ Etcd å®¹å™¨å¹¶åˆ é™¤èŠ‚ç‚¹ä¿¡æ¯ é€‰æ‹©ä¸Šé¢ä¸¤ä¸ª etcd ä¸­ä»»æ„ä¸€ä¸ª podï¼Œé€šè¿‡ kubectl å·¥å…·è¿›å…¥ pod å†…éƒ¨ [root@k8s-master01 ~]# kubectl exec -it -n kube-system etcd-k8s-master01 sh kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl kubectl exec [POD] -- [COMMAND] instead. è¿›å…¥å®¹å™¨åï¼ŒæŒ‰ä¸‹é¢æ­¥æ‰§è¡Œ ## é…ç½®ç¯å¢ƒ # export ETCDCTL_API=3 # alias etcdctl='etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key' ## æŸ¥çœ‹ etcd é›†ç¾¤æˆå‘˜åˆ—è¡¨ # etcdctl member list a9b6a1341829d62a, started, k8s-master03, https://172.20.5.13:2380, https://172.20.5.13:2379, false d1c737a26ea4dd70, started, k8s-master01, https://172.20.5.11:2380, https://172.20.5.11:2379, false fe2d4a2a33304913, started, k8s-master02, https://172.20.5.12:2380, https://172.20.5.12:2379, false ## åˆ é™¤ etcd é›†ç¾¤æˆå‘˜ k8s-master02 # etcdctl member remove fe2d4a2a33304913 Member fe2d4a2a33304913 removed from cluster 36067d1f1ca3f1db ## é€€å‡ºå®¹å™¨ # exit 3ï¼‰å†æ¬¡å°è¯•åŠ å…¥é›†ç¾¤ é€šè¿‡ kubeadm å‘½ä»¤å†æ¬¡å°è¯•å°† k8s-master02 èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼Œåœ¨æ‰§è¡Œå‰é¦–å…ˆè¿›å…¥åˆ° k8s-master02 èŠ‚ç‚¹æœåŠ¡å™¨ï¼Œæ‰§è¡Œ kubeadm çš„æ¸…é™¤å‘½ä»¤ï¼š $ kubeadm reset ç„¶åå°è¯•åŠ å…¥ kubernetes é›†ç¾¤ï¼š [check-etcd] Checking that the etcd cluster is healthy[kubelet-start] Downloading configuration for the kubelet from the \"kubelet-config-1.18\" ConfigMap in the kube-system namespace[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"[kubelet-start] Starting the kubelet[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...[etcd] Announced new etcd member joining to the existing etcd cluster[etcd] Creating static Pod manifest for \"etcd\"[etcd] Waiting for the new etcd member to join the cluster. This can take up to 40s{\"level\":\"warn\",\"ts\":\"2020-12-22T11:26:23.560+0800\",\"caller\":\"clientv3/retry_interceptor.go:61\",\"msg\":\"retrying of unary invoker failed\",\"target\":\"passthrough:///https://172.20.5.12:2379\",\"attempt\":0,\"error\":\"rpc error: code = DeadlineExceeded desc = context deadline exceeded\"}[upload-config] Storing the configuration used in ConfigMap \"kubeadm-config\" in the \"kube-system\" Namespace[mark-control-plane] Marking the node k8s-master02 as control-plane by adding the label \"node-role.kubernetes.io/master=''\"[mark-control-plane] Marking the node k8s-master02 as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]This node has joined the cluster and a new control plane instance was created:* Certificate signing request was sent to apiserver and approval was received.* The Kubelet was informed of the new secure connection details.* Control plane (master) label and taint were applied to the new node.* The Kubernetes control plane instances scaled up.* A new etcd member was added to the local/stacked etcd cluster.To start administering your cluster from this node, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $","date":"2024-08-11","objectID":"/posts/2024-08-11-k8s-doc/:1:1","tags":["k8s-doc"],"title":"k8s-doc","uri":"/posts/2024-08-11-k8s-doc/"},{"categories":["DevOps","k8s"],"content":"1ã€svcå‘½åé—®é¢˜ï¼Œå¯¼è‡´ingress nginxæ— æ³•æ˜ å°„ç«¯å£ åœ¨ingress-nginxçš„tcpç«¯å£æ˜ å°„è¿‡ç¨‹ä¸­ï¼Œåªæ”¯æŒxxx-svcï¼Œå¹¶ä¸”ï¼Œnameä¸­ï¼Œä¸èƒ½ä½¿ç”¨ä¸‹åˆ’çº¿ # é”™è¯¯ç”¨æ³• metadata: name: imau1_conf # æ­£ç¡®ç”¨æ³• metadata: name: imau1-conf ","date":"2024-08-11","objectID":"/posts/2024-08-11-k8s-doc/:1:2","tags":["k8s-doc"],"title":"k8s-doc","uri":"/posts/2024-08-11-k8s-doc/"},{"categories":["DevOps","k8s"],"content":"2ã€deploymentåˆ›å»ºpodå¤±è´¥ å‚è€ƒé“¾æ¥ï¼šhttps://developer.aliyun.com/article/791261 ç®€ä»‹ï¼šeploymentåˆ›å»ºpodå¤±è´¥ï¼Œé€šè¿‡describe deployment ${DEPLOY_NAME} æ²¡èƒ½çœ‹åˆ°å…·ä½“åŸå› ã€‚æœ€ç»ˆåœ¨â€œedit deployment ${DEPLOY_NAME}â€ä¸­çœ‹åˆ°é”™è¯¯åŸå› ã€‚ é€šè¿‡deploymentåˆ›å»ºpodå¤±è´¥ åœ¨k8sé›†ç¾¤ä¸­ï¼Œdeploymentå¯åŠ¨åæ²¡æœ‰æˆåŠŸåˆ›å»ºpodï¼Œé€šè¿‡â€œkubectl describe deployment ${DEPLOY_NAME} â€ï¼Œçœ‹åˆ°å¦‚ä¸‹æ—¥å¿—ï¼Œåªçœ‹åˆ°â€œReplicaFailure True FailedCreateâ€ï¼Œä½†æ˜¯æ²¡æœ‰failedçš„åŸå› ã€‚ \u003e kubectl describe deployment ${DEPLOY_NAME} ---------------------------------------------- Conditions: Type Status Reason ---- ------ ------ Progressing True NewReplicaSetCreated Available False MinimumReplicasUnavailable ReplicaFailure True FailedCreate OldReplicaSets: \u003cnone\u003e NewReplicaSet: james-mtfnwnbu4z7v5umk-67cc5d6b98 (0/1 replicas created) Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal ScalingReplicaSet 40s deployment-controller Scaled up replica set james-mtfnwnbu4z7v5umk-67cc5d6b98 to 1 å…¶å®åŸå› è—åœ¨edit deploymenté‡Œé¢ã€‚å¯ä»¥é€šè¿‡\"edit deploy\"æ¥æŸ¥çœ‹ã€‚ \u003e kubectl edit deployment ${DEPLOY_NAME} -------------------------------------------------------------- 'pods \"james-mtfnwnbu4z7v5umk-67cc5d6b98\" is forbidden: error looking up service account ns-james/davis: serviceaccount \"davis\" not found' åŸå› å¾ˆæ¸…æ¥šï¼Œè¿™ä¸ªpodæ˜¯éœ€è¦æŒ‡å®šçš„serviceaccountåˆ›å»ºï¼Œä½†æ˜¯é›†ç¾¤æ²¡æœ‰æå‰åˆ›å»ºå¥½saå¯¼è‡´podå¯åŠ¨å¤±è´¥ã€‚ åˆ›å»ºserviceaccount nsä¸‹é»˜è®¤æœ‰ä¸€ä¸ªdefaultçš„saï¼Œå…¶ä»–saéœ€è¦è‡ªå·±åˆ›å»º root@titum:~# kubectl create sa ${SA_NAME} -n ns-james serviceaccount/davis created root@titum:~# kubectl get sa -n test NAME SECRETS AGE default 1 94s davis 1 2s é‡æ–°è°ƒåº¦æœåŠ¡ ","date":"2024-08-11","objectID":"/posts/2024-08-11-k8s-doc/:1:3","tags":["k8s-doc"],"title":"k8s-doc","uri":"/posts/2024-08-11-k8s-doc/"},{"categories":["DevOps","k8s"],"content":"3ã€debug pod kubectl run sugar --image=serialt/debug --restart=Never ","date":"2024-08-11","objectID":"/posts/2024-08-11-k8s-doc/:1:4","tags":["k8s-doc"],"title":"k8s-doc","uri":"/posts/2024-08-11-k8s-doc/"},{"categories":["DevOps","k8s"],"content":"Ingress-Nginx kubernetesä¸­æš´éœ²æœåŠ¡çš„ä¸‰ç§æ–¹å¼ï¼š ClusterIP NodePort LoadBalance â€‹ è¿™å‡ ç§æ–¹å¼éƒ½æ˜¯åœ¨serviceçš„ç»´åº¦æä¾›çš„ï¼Œserviceçš„ä½œç”¨ä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢ï¼Œå¯¹é›†ç¾¤å†…éƒ¨ï¼Œå®ƒä¸æ–­è·Ÿè¸ªpodçš„å˜åŒ–ï¼Œæ›´æ–°endpointä¸­å¯¹åº”podçš„å¯¹è±¡ï¼Œæä¾›äº†ipä¸æ–­å˜åŒ–çš„podçš„æœåŠ¡å‘ç°æœºåˆ¶ï¼Œå¯¹é›†ç¾¤å¤–éƒ¨ï¼Œä»–ç±»ä¼¼è´Ÿè½½å‡è¡¡å™¨ï¼Œå¯ä»¥åœ¨é›†ç¾¤å†…å¤–éƒ¨å¯¹podè¿›è¡Œè®¿é—®ã€‚ä½†æ˜¯ï¼Œå•ç‹¬ç”¨serviceæš´éœ²æœåŠ¡çš„æ–¹å¼ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ä¸å¤ªåˆé€‚ï¼š ClusterIPçš„æ–¹å¼åªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ã€‚ NodePortæ–¹å¼çš„è¯ï¼Œæµ‹è¯•ç¯å¢ƒä½¿ç”¨è¿˜è¡Œï¼Œå½“æœ‰å‡ åä¸Šç™¾çš„æœåŠ¡åœ¨é›†ç¾¤ä¸­è¿è¡Œæ—¶ï¼ŒNodePortçš„ç«¯å£ç®¡ç†æ˜¯ç¾éš¾ã€‚ LoadBalanceæ–¹å¼å—é™äºäº‘å¹³å°ï¼Œä¸”é€šå¸¸åœ¨äº‘å¹³å°éƒ¨ç½²ELBè¿˜éœ€è¦é¢å¤–çš„è´¹ç”¨ã€‚ â€‹ æ‰€å¹¸k8sè¿˜æä¾›äº†ä¸€ç§é›†ç¾¤ç»´åº¦æš´éœ²æœåŠ¡çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ingressã€‚ingresså¯ä»¥ç®€å•ç†è§£ä¸ºserviceçš„serviceï¼Œä»–é€šè¿‡ç‹¬ç«‹çš„ingresså¯¹è±¡æ¥åˆ¶å®šè¯·æ±‚è½¬å‘çš„è§„åˆ™ï¼ŒæŠŠè¯·æ±‚è·¯ç”±åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªserviceä¸­ã€‚è¿™æ ·å°±æŠŠæœåŠ¡ä¸è¯·æ±‚è§„åˆ™è§£è€¦äº†ï¼Œå¯ä»¥ä»ä¸šåŠ¡ç»´åº¦ç»Ÿä¸€è€ƒè™‘ä¸šåŠ¡çš„æš´éœ²ï¼Œè€Œä¸ç”¨ä¸ºæ¯ä¸ªserviceå•ç‹¬è€ƒè™‘ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œç°åœ¨é›†ç¾¤æœ‰apiã€æ–‡ä»¶å­˜å‚¨ã€å‰ç«¯3ä¸ªserviceï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªingresså¯¹è±¡æ¥å®ç°å›¾ä¸­çš„è¯·æ±‚è½¬å‘ï¼š ","date":"2024-08-11","objectID":"/posts/2024-08-11-ingress-nginx/:1:0","tags":["ingress-nginx"],"title":"Ingress-Nginx","uri":"/posts/2024-08-11-ingress-nginx/"},{"categories":["DevOps","k8s"],"content":"ingress ä¸ingress-controller è¦ç†è§£ingressï¼Œéœ€è¦åŒºåˆ†ä¸¤ä¸ªæ¦‚å¿µï¼Œingresså’Œingress-controllerï¼š ingresså¯¹è±¡ï¼š æŒ‡çš„æ˜¯k8sä¸­çš„ä¸€ä¸ªapiå¯¹è±¡ï¼Œä¸€èˆ¬ç”¨yamlé…ç½®ã€‚ä½œç”¨æ˜¯å®šä¹‰è¯·æ±‚å¦‚ä½•è½¬å‘åˆ°serviceçš„è§„åˆ™ï¼Œå¯ä»¥ç†è§£ä¸ºé…ç½®æ¨¡æ¿ã€‚ ingress-controllerï¼š å…·ä½“å®ç°åå‘ä»£ç†åŠè´Ÿè½½å‡è¡¡çš„ç¨‹åºï¼Œå¯¹ingresså®šä¹‰çš„è§„åˆ™è¿›è¡Œè§£æï¼Œæ ¹æ®é…ç½®çš„è§„åˆ™æ¥å®ç°è¯·æ±‚è½¬å‘ã€‚ ç®€å•æ¥è¯´ï¼Œingress-controlleræ‰æ˜¯è´Ÿè´£å…·ä½“è½¬å‘çš„ç»„ä»¶ï¼Œé€šè¿‡å„ç§æ–¹å¼å°†å®ƒæš´éœ²åœ¨é›†ç¾¤å…¥å£ï¼Œå¤–éƒ¨å¯¹é›†ç¾¤çš„è¯·æ±‚æµé‡ä¼šå…ˆåˆ°ingress-controllerï¼Œè€Œingresså¯¹è±¡æ˜¯ç”¨æ¥å‘Šè¯‰ingress-controllerè¯¥å¦‚ä½•è½¬å‘è¯·æ±‚ï¼Œæ¯”å¦‚å“ªäº›åŸŸåå“ªäº›pathè¦è½¬å‘åˆ°å“ªäº›æœåŠ¡ç­‰ç­‰ã€‚ ","date":"2024-08-11","objectID":"/posts/2024-08-11-ingress-nginx/:1:1","tags":["ingress-nginx"],"title":"Ingress-Nginx","uri":"/posts/2024-08-11-ingress-nginx/"},{"categories":["DevOps","k8s"],"content":"ingress-controller ingress-controllerå¹¶ä¸æ˜¯k8sè‡ªå¸¦çš„ç»„ä»¶ï¼Œå®é™…ä¸Šingress-controlleråªæ˜¯ä¸€ä¸ªç»Ÿç§°ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ä¸åŒçš„ingress-controllerå®ç°ï¼Œç›®å‰ï¼Œç”±k8sç»´æŠ¤çš„ingress-controlleråªæœ‰googleäº‘çš„GCEä¸ingress-nginxä¸¤ä¸ªï¼Œå…¶ä»–è¿˜æœ‰å¾ˆå¤šç¬¬ä¸‰æ–¹ç»´æŠ¤çš„ingress-controllerï¼Œå…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚ä½†æ˜¯ä¸ç®¡å“ªä¸€ç§ingress-controllerï¼Œå®ç°çš„æœºåˆ¶éƒ½å¤§åŒå°å¼‚ï¼Œåªæ˜¯åœ¨å…·ä½“é…ç½®ä¸Šæœ‰å·®å¼‚ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œingress-controllerçš„å½¢å¼éƒ½æ˜¯ä¸€ä¸ªpodï¼Œé‡Œé¢è·‘ç€daemonç¨‹åºå’Œåå‘ä»£ç†ç¨‹åºã€‚daemonè´Ÿè´£ä¸æ–­ç›‘æ§é›†ç¾¤çš„å˜åŒ–ï¼Œæ ¹æ®ingresså¯¹è±¡ç”Ÿæˆé…ç½®å¹¶åº”ç”¨æ–°é…ç½®åˆ°åå‘ä»£ç†ï¼Œæ¯”å¦‚nginx-ingresså°±æ˜¯åŠ¨æ€ç”Ÿæˆnginxé…ç½®ï¼ŒåŠ¨æ€æ›´æ–°upstreamï¼Œå¹¶åœ¨éœ€è¦çš„æ—¶å€™reloadç¨‹åºåº”ç”¨æ–°é…ç½®ã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œåé¢çš„ä¾‹å­éƒ½ä»¥k8så®˜æ–¹ç»´æŠ¤çš„nginx-ingressä¸ºä¾‹ã€‚ ","date":"2024-08-11","objectID":"/posts/2024-08-11-ingress-nginx/:1:2","tags":["ingress-nginx"],"title":"Ingress-Nginx","uri":"/posts/2024-08-11-ingress-nginx/"},{"categories":["DevOps","k8s"],"content":"ingress ingressæ˜¯ä¸€ä¸ªAPIå¯¹è±¡ï¼Œå’Œå…¶ä»–å¯¹è±¡ä¸€æ ·ï¼Œé€šè¿‡yamlæ–‡ä»¶æ¥é…ç½®ã€‚ingressé€šè¿‡httpæˆ–httpsæš´éœ²é›†ç¾¤å†…éƒ¨serviceï¼Œç»™serviceæä¾›å¤–éƒ¨URLã€è´Ÿè½½å‡è¡¡ã€SSL/TLSèƒ½åŠ›ä»¥åŠåŸºäºhostçš„æ–¹å‘ä»£ç†ã€‚ingressè¦ä¾é ingress-controlleræ¥å…·ä½“å®ç°ä»¥ä¸ŠåŠŸèƒ½ã€‚å‰ä¸€å°èŠ‚çš„å›¾å¦‚æœç”¨ingressæ¥è¡¨ç¤ºï¼Œå¤§æ¦‚å°±æ˜¯å¦‚ä¸‹é…ç½®ï¼š apiVersion: extensions/v1beta1 kind: Ingress metadata: name: abc-ingress annotations: kubernetes.io/ingress.class: \"nginx\" nginx.ingress.kubernetes.io/use-regex: \"true\" spec: tls: - hosts: - api.abc.com secretName: abc-tls rules: - host: api.abc.com http: paths: - backend: serviceName: apiserver servicePort: 80 - host: www.abc.com http: paths: - path: /image/* backend: serviceName: fileserver servicePort: 80 - host: www.abc.com http: paths: - backend: serviceName: feserver servicePort: 8080 ä¸å…¶ä»–k8så¯¹è±¡ä¸€æ ·ï¼Œingressé…ç½®ä¹ŸåŒ…å«äº†apiVersionã€kindã€metadataã€specç­‰å…³é”®å­—æ®µã€‚æœ‰å‡ ä¸ªå…³æ³¨çš„åœ¨specå­—æ®µä¸­ï¼Œtlsç”¨äºå®šä¹‰httpså¯†é’¥ã€è¯ä¹¦ã€‚ruleç”¨äºæŒ‡å®šè¯·æ±‚è·¯ç”±è§„åˆ™ã€‚è¿™é‡Œå€¼å¾—å…³æ³¨çš„æ˜¯metadata.annotationså­—æ®µã€‚åœ¨ingressé…ç½®ä¸­ï¼Œannotationså¾ˆé‡è¦ã€‚å‰é¢æœ‰è¯´ingress-controlleræœ‰å¾ˆå¤šä¸åŒçš„å®ç°ï¼Œè€Œä¸åŒçš„ingress-controllerå°±å¯ä»¥æ ¹æ®\"kubernetes.io/ingress.class:â€œæ¥åˆ¤æ–­è¦ä½¿ç”¨å“ªäº›ingressé…ç½®ï¼ŒåŒæ—¶ï¼Œä¸åŒçš„ingress-controllerä¹Ÿæœ‰å¯¹åº”çš„annotationsé…ç½®ï¼Œç”¨äºè‡ªå®šä¹‰ä¸€äº›å‚æ•°ã€‚åˆ—å¦‚ä¸Šé¢é…ç½®çš„â€™nginx.ingress.kubernetes.io/use-regex: â€œtrueâ€â€™,æœ€ç»ˆæ˜¯åœ¨ç”Ÿæˆnginxé…ç½®ä¸­ï¼Œä¼šé‡‡ç”¨location ~æ¥è¡¨ç¤ºæ­£åˆ™åŒ¹é…ã€‚ ","date":"2024-08-11","objectID":"/posts/2024-08-11-ingress-nginx/:1:3","tags":["ingress-nginx"],"title":"Ingress-Nginx","uri":"/posts/2024-08-11-ingress-nginx/"},{"categories":["DevOps","k8s"],"content":"ingressçš„éƒ¨ç½² ingressçš„éƒ¨ç½²ï¼Œéœ€è¦è€ƒè™‘ä¸¤ä¸ªæ–¹é¢ï¼š ingress-controlleræ˜¯ä½œä¸ºpodæ¥è¿è¡Œçš„ï¼Œä»¥ä»€ä¹ˆæ–¹å¼éƒ¨ç½²æ¯”è¾ƒå¥½ ingressè§£å†³äº†æŠŠå¦‚ä½•è¯·æ±‚è·¯ç”±åˆ°é›†ç¾¤å†…éƒ¨ï¼Œé‚£å®ƒè‡ªå·±æ€ä¹ˆæš´éœ²ç»™å¤–éƒ¨æ¯”è¾ƒå¥½ ä¸‹é¢åˆ—ä¸¾ä¸€äº›ç›®å‰å¸¸è§çš„éƒ¨ç½²å’Œæš´éœ²æ–¹å¼ï¼Œå…·ä½“ä½¿ç”¨å“ªç§æ–¹å¼è¿˜æ˜¯å¾—æ ¹æ®å®é™…éœ€æ±‚æ¥è€ƒè™‘å†³å®šã€‚ Deployment+LoadBalanceræ¨¡å¼çš„Service å¦‚æœè¦æŠŠingresséƒ¨ç½²åœ¨å…¬æœ‰äº‘ï¼Œé‚£ç”¨è¿™ç§æ–¹å¼æ¯”è¾ƒåˆé€‚ã€‚ç”¨Deploymentéƒ¨ç½²ingress-controllerï¼Œåˆ›å»ºä¸€ä¸ªtypeä¸ºLoadBalancerçš„serviceå…³è”è¿™ç»„podã€‚å¤§éƒ¨åˆ†å…¬æœ‰äº‘ï¼Œéƒ½ä¼šä¸ºLoadBalancerçš„serviceè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ï¼Œé€šå¸¸è¿˜ç»‘å®šäº†å…¬ç½‘åœ°å€ã€‚åªè¦æŠŠåŸŸåè§£ææŒ‡å‘è¯¥åœ°å€ï¼Œå°±å®ç°äº†é›†ç¾¤æœåŠ¡çš„å¯¹å¤–æš´éœ²ã€‚ Deployment+NodePortæ¨¡å¼çš„Service åŒæ ·ç”¨deploymentæ¨¡å¼éƒ¨ç½²ingress-controllerï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„æœåŠ¡ï¼Œä½†æ˜¯typeä¸ºNodePortã€‚è¿™æ ·ï¼Œingresså°±ä¼šæš´éœ²åœ¨é›†ç¾¤èŠ‚ç‚¹ipçš„ç‰¹å®šç«¯å£ä¸Šã€‚ç”±äºnodeportæš´éœ²çš„ç«¯å£æ˜¯éšæœºç«¯å£ï¼Œä¸€èˆ¬ä¼šåœ¨å‰é¢å†æ­å»ºä¸€å¥—è´Ÿè½½å‡è¡¡å™¨æ¥è½¬å‘è¯·æ±‚ã€‚è¯¥æ–¹å¼ä¸€èˆ¬ç”¨äºå®¿ä¸»æœºæ˜¯ç›¸å¯¹å›ºå®šçš„ç¯å¢ƒipåœ°å€ä¸å˜çš„åœºæ™¯ã€‚ NodePortæ–¹å¼æš´éœ²ingressè™½ç„¶ç®€å•æ–¹ä¾¿ï¼Œä½†æ˜¯NodePortå¤šäº†ä¸€å±‚NATï¼Œåœ¨è¯·æ±‚é‡çº§å¾ˆå¤§æ—¶å¯èƒ½å¯¹æ€§èƒ½ä¼šæœ‰ä¸€å®šå½±å“ã€‚ DaemonSet+HostNetwork+nodeSelector ç”¨DaemonSetç»“åˆnodeselectoræ¥éƒ¨ç½²ingress-controlleråˆ°ç‰¹å®šçš„nodeä¸Šï¼Œç„¶åä½¿ç”¨HostNetworkç›´æ¥æŠŠè¯¥podä¸å®¿ä¸»æœºnodeçš„ç½‘ç»œæ‰“é€šï¼Œç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„80/433ç«¯å£å°±èƒ½è®¿é—®æœåŠ¡ã€‚è¿™æ—¶ï¼Œingress-controlleræ‰€åœ¨çš„nodeæœºå™¨å°±å¾ˆç±»ä¼¼ä¼ ç»Ÿæ¶æ„çš„è¾¹ç¼˜èŠ‚ç‚¹ï¼Œæ¯”å¦‚æœºæˆ¿å…¥å£çš„nginxæœåŠ¡å™¨ã€‚è¯¥æ–¹å¼æ•´ä¸ªè¯·æ±‚é“¾è·¯æœ€ç®€å•ï¼Œæ€§èƒ½ç›¸å¯¹NodePortæ¨¡å¼æ›´å¥½ã€‚ç¼ºç‚¹æ˜¯ç”±äºç›´æ¥åˆ©ç”¨å®¿ä¸»æœºèŠ‚ç‚¹çš„ç½‘ç»œå’Œç«¯å£ï¼Œä¸€ä¸ªnodeåªèƒ½éƒ¨ç½²ä¸€ä¸ªingress-controller podã€‚æ¯”è¾ƒé€‚åˆå¤§å¹¶å‘çš„ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚ å› æ­¤ï¼Œåœ¨è‡ªå»ºçš„kubernetesç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ä½¿ç”¨DaemonSet+HostNetwork+nodeSelectoræ–¹å¼å»éƒ¨ç½² ","date":"2024-08-11","objectID":"/posts/2024-08-11-ingress-nginx/:1:4","tags":["ingress-nginx"],"title":"Ingress-Nginx","uri":"/posts/2024-08-11-ingress-nginx/"},{"categories":["DevOps","k8s"],"content":"ingressæµ‹è¯• æˆ‘ä»¬æ¥å®é™…éƒ¨ç½²å’Œç®€å•æµ‹è¯•ä¸€ä¸‹ingressã€‚æµ‹è¯•é›†ç¾¤ä¸­å·²ç»éƒ¨ç½²æœ‰2ä¸ªæœåŠ¡gowebhostä¸gowebipï¼Œæ¯æ¬¡è¯·æ±‚èƒ½è¿”å›å®¹å™¨hostnameä¸ipã€‚æµ‹è¯•æ­å»ºä¸€ä¸ªingressæ¥å®ç°é€šè¿‡åŸŸåçš„ä¸åŒpathæ¥è®¿é—®è¿™ä¸¤ä¸ªæœåŠ¡ï¼š æµ‹è¯•ingressä½¿ç”¨k8sç¤¾åŒºçš„ingress-nginxï¼Œéƒ¨ç½²æ–¹å¼ç”¨DaemonSet+HostNetworkã€‚ éƒ¨ç½²ingress-controller éƒ¨ç½²ingress-controller podåŠç›¸å…³èµ„æº å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œéƒ¨ç½²åªè¦ç®€å•çš„æ‰§è¡Œä¸€ä¸ªyaml https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml mandatory.yamlè¿™ä¸€ä¸ªyamlä¸­åŒ…å«äº†å¾ˆå¤šèµ„æºçš„åˆ›å»ºï¼ŒåŒ…æ‹¬namespaceã€ConfigMapã€roleï¼ŒServiceAccountç­‰ç­‰æ‰€æœ‰éƒ¨ç½²ingress-controlleréœ€è¦çš„èµ„æºï¼Œé…ç½®å¤ªå¤šå°±ä¸ç²˜å‡ºæ¥äº†ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹deploymentéƒ¨åˆ†ï¼š apiVersion: apps/v1 kind: Deployment metadata: name: nginx-ingress-controller namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx spec: replicas: 1 selector: matchLabels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx template: metadata: labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx annotations: prometheus.io/port: \"10254\" prometheus.io/scrape: \"true\" spec: serviceAccountName: nginx-ingress-serviceaccount containers: - name: nginx-ingress-controller image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.25.0 args: - /nginx-ingress-controller - --configmap=$(POD_NAMESPACE)/nginx-configuration - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services - --udp-services-configmap=$(POD_NAMESPACE)/udp-services - --publish-service=$(POD_NAMESPACE)/ingress-nginx - --annotations-prefix=nginx.ingress.kubernetes.io securityContext: allowPrivilegeEscalation: true capabilities: drop: - ALL add: - NET_BIND_SERVICE # www-data -\u003e 33 runAsUser: 33 env: - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace ports: - name: http containerPort: 80 - name: https containerPort: 443 livenessProbe: failureThreshold: 3 httpGet: path: /healthz port: 10254 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 10 readinessProbe: failureThreshold: 3 httpGet: path: /healthz port: 10254 scheme: HTTP periodSeconds: 10 successThreshold: 1 timeoutSeconds: 10 å¯ä»¥çœ‹åˆ°ä¸»è¦ä½¿ç”¨äº†â€œquay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.25.0â€è¿™ä¸ªé•œåƒï¼ŒæŒ‡å®šäº†ä¸€äº›å¯åŠ¨å‚æ•°ã€‚åŒæ—¶å¼€æ”¾äº†80ä¸443ä¸¤ä¸ªç«¯å£ï¼Œå¹¶åœ¨10254ç«¯å£åšäº†å¥åº·æ£€æŸ¥ã€‚ æˆ‘ä»¬éœ€è¦ä½¿ç”¨daemonsetéƒ¨ç½²åˆ°ç‰¹å®šnodeï¼Œéœ€è¦ä¿®æ”¹éƒ¨åˆ†é…ç½®ï¼šå…ˆç»™è¦éƒ¨ç½²nginx-ingressçš„nodeæ‰“ä¸Šç‰¹å®šæ ‡ç­¾,è¿™é‡Œæµ‹è¯•éƒ¨ç½²åœ¨\"node-1\"è¿™ä¸ªèŠ‚ç‚¹ã€‚ $ kubectl label node node-1 isIngress=\"true\" ç„¶åä¿®æ”¹ä¸Šé¢mandatory.yamlçš„deploymentéƒ¨åˆ†é…ç½®ä¸ºï¼š # ä¿®æ”¹apiç‰ˆæœ¬åŠkind # apiVersion: apps/v1 # kind: Deployment apiVersion: extensions/v1beta1 kind: DaemonSet metadata: name: nginx-ingress-controller namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx spec: # åˆ é™¤Replicas # replicas: 1 selector: matchLabels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx template: metadata: labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx annotations: prometheus.io/port: \"10254\" prometheus.io/scrape: \"true\" spec: serviceAccountName: nginx-ingress-serviceaccount # é€‰æ‹©å¯¹åº”æ ‡ç­¾çš„node nodeSelector: isIngress: \"true\" # ä½¿ç”¨hostNetworkæš´éœ²æœåŠ¡ hostNetwork: true containers: - name: nginx-ingress-controller image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.25.0 args: - /nginx-ingress-controller - --configmap=$(POD_NAMESPACE)/nginx-configuration - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services - --udp-services-configmap=$(POD_NAMESPACE)/udp-services - --publish-service=$(POD_NAMESPACE)/ingress-nginx - --annotations-prefix=nginx.ingress.kubernetes.io securityContext: allowPrivilegeEscalation: true capabilities: drop: - ALL add: - NET_BIND_SERVICE # www-data -\u003e 33 runAsUser: 33 env: - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace ports: - name: http containerPort: 80 - name: https containerPort: 443 livenessProbe: failureThreshold: 3 httpGet: path: /healthz port: 10254 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThr","date":"2024-08-11","objectID":"/posts/2024-08-11-ingress-nginx/:1:5","tags":["ingress-nginx"],"title":"Ingress-Nginx","uri":"/posts/2024-08-11-ingress-nginx/"},{"categories":["DevOps","k8s"],"content":"å®‰è£…ingress-nginx è·å–é•œåƒ [root@k8s-n1 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v0.44.0 [root@k8s-n1 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v0.44.0 k8s.gcr.io/ingress-nginx/controller:v0.44.0 ä¸‹è½½èµ„æºæ¸…å•æ–‡ä»¶ [root@k8s-m1 ~]# wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.44.0/deploy/static/provider/baremetal/deploy.yaml ","date":"2024-08-11","objectID":"/posts/2024-08-11-ingress-nginx/:1:6","tags":["ingress-nginx"],"title":"Ingress-Nginx","uri":"/posts/2024-08-11-ingress-nginx/"},{"categories":["DevOps","k8s"],"content":"Ingress controlleræš´éœ²ç«¯å£ ç‰ˆæœ¬ï¼šv0.44.0 å‚è€ƒé“¾æ¥ï¼š https://kubernetes.github.io/ingress-nginx/user-guide/exposing-tcp-udp-services/ https://www.cnblogs.com/fengjian2016/p/8301668.html https://www.cnblogs.com/hongdada/p/11491974.html https://segmentfault.com/a/1190000019908991 https://www.servicemesher.com/blog/kubernetes-ingress-controller-deployment-and-ha/ https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.44.0/deploy/static/provider/baremetal/deploy.yaml ä¿®æ”¹deployæ–‡ä»¶ ä¿®æ”¹å­—æ®µï¼š 1ï¼‰320è¡Œå¢åŠ äº† hostNetwork: true 2ï¼‰335å’Œ336å¢åŠ äº†tcpå’Œudpæš´éœ²ç«¯å£çš„å‚æ•° 335 - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services 336 - --udp-services-configmap=$(POD_NAMESPACE)/udp-services 318 spec: 319 dnsPolicy: ClusterFirst 320 hostNetwork: true 321 containers: 322 - name: controller 323 image: k8s.gcr.io/ingress-nginx/controller:v0.44.0 324 imagePullPolicy: IfNotPresent 325 lifecycle: 326 preStop: 327 exec: 328 command: 329 - /wait-shutdown 330 args: 331 - /nginx-ingress-controller 332 - --election-id=ingress-controller-leader 333 - --ingress-class=nginx 334 - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller 335 - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services 336 - --udp-services-configmap=$(POD_NAMESPACE)/udp-services 337 - --validating-webhook=:8443 338 - --validating-webhook-certificate=/usr/local/certificates/cert 339 - --validating-webhook-key=/usr/local/certificates/key å¢åŠ hostNetworkçš„åŸå› ï¼šå®˜æ–¹çš„ingress controlleræ²¡æœ‰ç»‘å®šåˆ°å®¿ä¸»æœº 80 ç«¯å£ï¼Œä¹Ÿå°±æ˜¯è¯´å‰ç«¯ Nginx æ²¡æœ‰ç›‘å¬å®¿ä¸»æœº 80 ç«¯å£ï¼Œå› è€Œéœ€è¦æ”¶åˆ°ä¿®æ”¹èµ„æºæ¸…å•æ–‡ä»¶ï¼Œå¢åŠ ä¸€ä¸ª hostNetwork: true åˆ›å»ºIngress controller [root@k8s-m1 k8s]# kubectl apply -f deploy.yaml # ä¿è¯ ingress-nginx-controlleræ­£åœ¨è¿è¡Œ [root@k8s-m1 k8s]# kubectl get pod --all-namespaces NAMESPACE NAME READY STATUS RESTARTS AGE default nginx-test1-655ddd64cd-mbcq6 1/1 Running 0 3h15m default nginx-test1-655ddd64cd-nlprg 1/1 Running 0 3h15m default nginx-test1-655ddd64cd-s5sjf 1/1 Running 0 3h15m default nginx-test2-68c89f98c9-2tftz 1/1 Running 0 178m default nginx-test2-68c89f98c9-kx6hv 1/1 Running 0 178m default nginx-test2-68c89f98c9-sj7zn 1/1 Running 0 178m default nginx-test4-6d69f4ff55-dtg2k 1/1 Running 0 170m default nginx-test4-6d69f4ff55-j8h7c 1/1 Running 0 170m default nginx-test4-6d69f4ff55-wn8px 1/1 Running 0 170m default nginx-test5-b4d644bdf-7gxqf 1/1 Running 0 126m default nginx-test5-b4d644bdf-ptshz 1/1 Running 0 132m default nginx-test5-b4d644bdf-q6sj7 1/1 Running 0 132m default nginx-test5-b4d644bdf-zrq66 1/1 Running 0 132m ingress-nginx ingress-nginx-admission-create-g56c4 0/1 Completed 0 15m ingress-nginx ingress-nginx-admission-patch-c62nl 0/1 Completed 1 15m ingress-nginx ingress-nginx-controller-5fcc5f76dd-crz2g 1/1 Running 0 15m kube-system coredns-66bff467f8-fp948 1/1 Running 3 46h kube-system coredns-66bff467f8-vmhwq 1/1 Running 3 46h kube-system etcd-k8s-m1.com 1/1 Running 4 46h kube-system kube-apiserver-k8s-m1.com 1/1 Running 2 74m kube-system kube-controller-manager-k8s-m1.com 1/1 Running 5 46h kube-system kube-flannel-ds-8wpjv 1/1 Running 3 46h kube-system kube-flannel-ds-dhwtr 1/1 Running 4 46h kube-system kube-proxy-dd8l9 1/1 Running 4 46h kube-system kube-proxy-wh9bc 1/1 Running 3 46h kube-system kube-scheduler-k8s-m1.com 1/1 Running 4 46h kube-system tiller-deploy-56b574c76d-qbxhj 1/1 Running 1 18h å»ºç«‹æš´éœ²tcpç«¯å£çš„configmap [root@k8s-m1 k8s]# cat tcp-services-configmap.yaml apiVersion: v1 kind: ConfigMap metadata: name: tcp-services namespace: ingress-nginx data: 27004: \"default/nginx-test5:80\" 7004: \"default/nginx-test5:80\" [root@k8s-m1 k8s]# kubectl apply -f tcp-services-configmap.yaml æŸ¥çœ‹ingress-nginx-controllerè¿è¡Œçš„èŠ‚ç‚¹ [root@k8s-m1 k8s]# kubectl get pod --all-namespaces -o wide ... ingress-nginx ingress-nginx-controller-5fcc5f76dd-crz2g 1/1 Running 0 16m 192.168.122.101 k8s-n1.com \u003cnone\u003e \u003cnone\u003e ... æ£€æµ‹ç«¯å£è¿è¡ŒçŠ¶æ€ [root@k8s-n1 ~]# ss -anpl | grep 7004 tcp LISTEN 0 511 *:7004 *:* users:((\"nginx\",pid=24817,fd=41),(\"nginx\",pid=24816,fd=41),(\"nginx\",pid=24815,fd=41),(\"nginx\",pid=24813,fd=41),(\"nginx\",pid=19891,fd=41)) tcp LISTEN 0 511 *:27004 *:* users:((\"nginx\",pid=2","date":"2024-08-11","objectID":"/posts/2024-08-11-ingress-nginx/:1:7","tags":["ingress-nginx"],"title":"Ingress-Nginx","uri":"/posts/2024-08-11-ingress-nginx/"},{"categories":["DevOps","k8s"],"content":"å®¹å™¨é€€å‡ºçŠ¶æ€ç  å‚è€ƒé“¾æ¥ï¼šhttps://blog.hdls.me/16581348863966.html å½“å®¹å™¨ç»ˆæ­¢æ—¶ï¼Œå®¹å™¨å¼•æ“ä½¿ç”¨é€€å‡ºç æ¥æŠ¥å‘Šå®¹å™¨ç»ˆæ­¢çš„åŸå› ã€‚å¦‚æœæ‚¨æ˜¯ Kubernetes ç”¨æˆ·ï¼Œå®¹å™¨æ•…éšœæ˜¯ pod å¼‚å¸¸æœ€å¸¸è§çš„åŸå› ä¹‹ä¸€ï¼Œäº†è§£å®¹å™¨é€€å‡ºç å¯ä»¥å¸®åŠ©æ‚¨åœ¨æ’æŸ¥æ—¶æ‰¾åˆ° pod æ•…éšœçš„æ ¹æœ¬åŸå› ã€‚ ä»¥ä¸‹æ˜¯å®¹å™¨ä½¿ç”¨çš„æœ€å¸¸è§çš„é€€å‡ºç ï¼š é€€å‡ºç  åç§° å«ä¹‰ 0 æ­£å¸¸é€€å‡º å¼€å‘è€…ç”¨æ¥è¡¨æ˜å®¹å™¨æ˜¯æ­£å¸¸é€€å‡º 1 åº”ç”¨é”™è¯¯ å®¹å™¨å› åº”ç”¨ç¨‹åºé”™è¯¯æˆ–é•œåƒè§„èŒƒä¸­çš„é”™è¯¯å¼•ç”¨è€Œåœæ­¢ 125 å®¹å™¨æœªèƒ½è¿è¡Œ docker run å‘½ä»¤æ²¡æœ‰æ‰§è¡ŒæˆåŠŸ 126 å‘½ä»¤è°ƒç”¨é”™è¯¯ æ— æ³•è°ƒç”¨é•œåƒä¸­æŒ‡å®šçš„å‘½ä»¤ 127 æ‰¾ä¸åˆ°æ–‡ä»¶æˆ–ç›®å½• æ‰¾ä¸åˆ°é•œåƒä¸­æŒ‡å®šçš„æ–‡ä»¶æˆ–ç›®å½• 128 é€€å‡ºæ—¶ä½¿ç”¨çš„å‚æ•°æ— æ•ˆ é€€å‡ºæ˜¯ç”¨æ— æ•ˆçš„é€€å‡ºç è§¦å‘çš„ï¼ˆæœ‰æ•ˆä»£ç æ˜¯ 0-255 ä¹‹é—´çš„æ•´æ•°ï¼‰ 134 å¼‚å¸¸ç»ˆæ­¢ (SIGABRT) å®¹å™¨ä½¿ç”¨ abort() å‡½æ•°è‡ªè¡Œä¸­æ­¢ 137 ç«‹å³ç»ˆæ­¢ (SIGKILL) å®¹å™¨è¢«æ“ä½œç³»ç»Ÿé€šè¿‡ SIGKILL ä¿¡å·ç»ˆæ­¢ 139 åˆ†æ®µé”™è¯¯ (SIGSEGV) å®¹å™¨è¯•å›¾è®¿é—®æœªåˆ†é…ç»™å®ƒçš„å†…å­˜å¹¶è¢«ç»ˆæ­¢ 143 ä¼˜é›…ç»ˆæ­¢ (SIGTERM) å®¹å™¨æ”¶åˆ°å³å°†ç»ˆæ­¢çš„è­¦å‘Šï¼Œç„¶åç»ˆæ­¢ 255 é€€å‡ºçŠ¶æ€è¶…å‡ºèŒƒå›´ å®¹å™¨é€€å‡ºï¼Œè¿”å›å¯æ¥å—èŒƒå›´ä¹‹å¤–çš„é€€å‡ºä»£ç ï¼Œè¡¨ç¤ºé”™è¯¯åŸå› æœªçŸ¥ ","date":"2024-08-11","objectID":"/posts/2024-08-11-containerd-exit/:1:0","tags":["containerd-exit"],"title":"containerd-exit-code","uri":"/posts/2024-08-11-containerd-exit/"},{"categories":["DevOps","k8s"],"content":"å®¹å™¨ç”Ÿå‘½å‘¨æœŸ ä¸ºäº†æ›´å¥½åœ°ç†è§£å®¹å™¨æ•…éšœçš„åŸå› ï¼Œè®©æˆ‘ä»¬å…ˆè®¨è®ºå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸã€‚ä»¥ Docker ä¸ºä¾‹ â€”â€” åœ¨ä»»ä½•ç»™å®šæ—¶é—´ï¼ŒDocker å®¹å™¨éƒ½ä¼šå¤„äºä»¥ä¸‹å‡ ç§çŠ¶æ€ä¹‹ä¸€ï¼š Createdï¼šDocker å®¹å™¨å·²åˆ›å»ºä½†å°šæœªå¯åŠ¨ï¼ˆè¿™æ˜¯è¿è¡Œ docker create åä½†å®é™…è¿è¡Œå®¹å™¨ä¹‹å‰çš„çŠ¶æ€ï¼‰ Upï¼šDocker å®¹å™¨å½“å‰æ­£åœ¨è¿è¡Œã€‚è¿™æ„å‘³ç€å®¹å™¨ç®¡ç†çš„æ“ä½œç³»ç»Ÿè¿›ç¨‹æ­£åœ¨è¿è¡Œã€‚å½“æ‚¨ä½¿ç”¨å‘½ä»¤ docker start æˆ– docker run æ—¶ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œä½¿ç”¨ docker start æˆ– docker run å¯èƒ½ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚ Pausedï¼šå®¹å™¨è¿›ç¨‹æ­£åœ¨è¿è¡Œï¼Œä½† Docker æš‚åœäº†å®¹å™¨ã€‚é€šå¸¸ï¼Œå½“æ‚¨è¿è¡Œ docker pause å‘½ä»¤æ—¶ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µ Exitedï¼šDocker å®¹å™¨å·²ç»è¢«ç»ˆæ­¢ï¼Œé€šå¸¸æ˜¯å› ä¸ºå®¹å™¨çš„è¿›ç¨‹è¢«æ€æ­»äº† å½“ä¸€ä¸ªå®¹å™¨è¾¾åˆ° Exited çŠ¶æ€æ—¶ï¼ŒDocker ä¼šåœ¨æ—¥å¿—ä¸­æŠ¥å‘Šä¸€ä¸ªé€€å‡ºç ï¼Œå‘Šè¯‰ä½ å®¹å™¨å‘ç”Ÿäº†ä»€ä¹ˆå¯¼è‡´å®ƒé€€å‡ºã€‚ ","date":"2024-08-11","objectID":"/posts/2024-08-11-containerd-exit/:1:1","tags":["containerd-exit"],"title":"containerd-exit-code","uri":"/posts/2024-08-11-containerd-exit/"},{"categories":["DevOps","k8s"],"content":"äº†è§£å®¹å™¨é€€å‡ºç  ä¸‹é¢æˆ‘ä»¬å°†æ›´è¯¦ç»†åœ°ä»‹ç»æ¯ä¸ªé€€å‡ºç ã€‚ é€€å‡ºç  0ï¼šæ­£å¸¸é€€å‡º é€€å‡ºä»£ç  0 ç”±å¼€å‘äººå‘˜åœ¨ä»»åŠ¡å®Œæˆåæ•…æ„åœæ­¢å®¹å™¨æ—¶è§¦å‘ã€‚ä»æŠ€æœ¯ä¸Šè®²ï¼Œé€€å‡ºä»£ç  0 æ„å‘³ç€å‰å°è¿›ç¨‹æœªé™„åŠ åˆ°ç‰¹å®šå®¹å™¨ã€‚ å¦‚æœå®¹å™¨ä»¥é€€å‡ºç  0 ç»ˆæ­¢æ€ä¹ˆåŠï¼Ÿ æ£€æŸ¥å®¹å™¨æ—¥å¿—ï¼Œç¡®å®šå“ªä¸ªåº“å¯¼è‡´å®¹å™¨é€€å‡ºï¼› æŸ¥çœ‹ç°æœ‰åº“çš„ä»£ç ï¼Œå¹¶ç¡®å®šå®ƒè§¦å‘é€€å‡ºç  0 çš„åŸå› ï¼Œä»¥åŠå®ƒæ˜¯å¦æ­£å¸¸è¿è¡Œã€‚ é€€å‡ºç  1ï¼šåº”ç”¨é”™è¯¯ é€€å‡ºä»£ç  1 è¡¨ç¤ºå®¹å™¨ç”±äºä»¥ä¸‹åŸå› ä¹‹ä¸€åœæ­¢ï¼š åº”ç”¨ç¨‹åºé”™è¯¯ï¼šè¿™å¯èƒ½æ˜¯å®¹å™¨è¿è¡Œçš„ä»£ç ä¸­çš„ç®€å•ç¼–ç¨‹é”™è¯¯ï¼Œä¾‹å¦‚â€œé™¤ä»¥é›¶â€ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸è¿è¡Œæ—¶ç¯å¢ƒç›¸å…³çš„é«˜çº§é”™è¯¯ï¼Œä¾‹å¦‚ Javaã€Python ç­‰ï¼› æ— æ•ˆå¼•ç”¨ï¼šè¿™æ„å‘³ç€é•œåƒè§„èŒƒå¼•ç”¨äº†å®¹å™¨é•œåƒä¸­ä¸å­˜åœ¨çš„æ–‡ä»¶ã€‚ å¦‚æœå®¹å™¨ä»¥é€€å‡ºç  1 ç»ˆæ­¢æ€ä¹ˆåŠï¼Ÿ æ£€æŸ¥å®¹å™¨æ—¥å¿—ä»¥æŸ¥çœ‹æ˜¯å¦æ‰¾ä¸åˆ°æ˜ åƒè§„èŒƒä¸­åˆ—å‡ºçš„æ–‡ä»¶ä¹‹ä¸€ã€‚å¦‚æœè¿™æ˜¯é—®é¢˜æ‰€åœ¨ï¼Œè¯·æ›´æ­£é•œåƒä»¥æŒ‡å‘æ­£ç¡®çš„è·¯å¾„å’Œæ–‡ä»¶åã€‚ å¦‚æœæ‚¨æ‰¾ä¸åˆ°ä¸æ­£ç¡®çš„æ–‡ä»¶å¼•ç”¨ï¼Œè¯·æ£€æŸ¥å®¹å™¨æ—¥å¿—ä»¥æŸ¥æ‰¾åº”ç”¨ç¨‹åºé”™è¯¯ï¼Œå¹¶è°ƒè¯•å¯¼è‡´é”™è¯¯çš„åº“ã€‚ é€€å‡ºç  125ï¼šå®¹å™¨æœªèƒ½è¿è¡Œ é€€å‡ºç  125 è¡¨ç¤ºè¯¥å‘½ä»¤ç”¨äºè¿è¡Œå®¹å™¨ã€‚ä¾‹å¦‚ docker run åœ¨ shell ä¸­è¢«è°ƒç”¨ä½†æ²¡æœ‰æˆåŠŸæ‰§è¡Œã€‚ä»¥ä¸‹æ˜¯å¯èƒ½å‘ç”Ÿè¿™ç§æƒ…å†µçš„å¸¸è§åŸå› ï¼š å‘½ä»¤ä¸­ä½¿ç”¨äº†æœªå®šä¹‰çš„ flagï¼Œä¾‹å¦‚ docker run --abcdï¼› é•œåƒä¸­ç”¨æˆ·çš„å®šä¹‰å‘½ä»¤åœ¨æœ¬æœºæƒé™ä¸è¶³ï¼› å®¹å™¨å¼•æ“ä¸å®¿ä¸»æœºæ“ä½œç³»ç»Ÿæˆ–ç¡¬ä»¶ä¸å…¼å®¹ã€‚ å¦‚æœå®¹å™¨ä»¥é€€å‡ºç  125 ç»ˆæ­¢æ€ä¹ˆåŠï¼Ÿ æ£€æŸ¥è¿è¡Œå®¹å™¨çš„å‘½ä»¤è¯­æ³•æ˜¯å¦æ­£ç¡®ï¼› æ£€æŸ¥è¿è¡Œå®¹å™¨çš„ç”¨æˆ·ï¼Œæˆ–è€…é•œåƒä¸­æ‰§è¡Œå‘½ä»¤çš„ä¸Šä¸‹æ–‡ï¼Œæ˜¯å¦æœ‰è¶³å¤Ÿçš„æƒé™åœ¨å®¿ä¸»æœºä¸Šåˆ›å»ºå®¹å™¨ï¼› å¦‚æœæ‚¨çš„å®¹å™¨å¼•æ“æä¾›äº†è¿è¡Œå®¹å™¨çš„ optionï¼Œè¯·å°è¯•å®ƒä»¬ã€‚ä¾‹å¦‚ï¼Œåœ¨ Docker ä¸­ï¼Œå°è¯• docker start è€Œä¸æ˜¯ docker runï¼› æµ‹è¯•æ‚¨æ˜¯å¦èƒ½å¤Ÿä½¿ç”¨ç›¸åŒçš„ç”¨æˆ·åæˆ–ä¸Šä¸‹æ–‡åœ¨ä¸»æœºä¸Šè¿è¡Œå…¶ä»–å®¹å™¨ã€‚å¦‚æœä¸èƒ½ï¼Œé‡æ–°å®‰è£…å®¹å™¨å¼•æ“ï¼Œæˆ–è€…è§£å†³å®¹å™¨å¼•æ“å’Œä¸»æœºè®¾ç½®ä¹‹é—´çš„åº•å±‚å…¼å®¹æ€§é—®é¢˜ã€‚ é€€å‡ºç  126ï¼šå‘½ä»¤è°ƒç”¨é”™è¯¯ é€€å‡ºç  126 è¡¨ç¤ºæ— æ³•è°ƒç”¨å®¹å™¨é•œåƒä¸­ä½¿ç”¨çš„å‘½ä»¤ã€‚è¿™é€šå¸¸æ˜¯ç”¨äºè¿è¡Œå®¹å™¨çš„æŒç»­é›†æˆè„šæœ¬ä¸­ç¼ºå°‘ä¾èµ–é¡¹æˆ–é”™è¯¯çš„åŸå› ã€‚ å¦‚æœå®¹å™¨ä»¥é€€å‡ºç  126 ç»ˆæ­¢æ€ä¹ˆåŠï¼Ÿ æ£€æŸ¥å®¹å™¨æ—¥å¿—ï¼ŒæŸ¥çœ‹æ— æ³•è°ƒç”¨å“ªä¸ªå‘½ä»¤ï¼› å°è¯•åœ¨æ²¡æœ‰å‘½ä»¤çš„æƒ…å†µä¸‹è¿è¡Œå®¹å™¨ä»¥ç¡®ä¿éš”ç¦»é—®é¢˜ï¼› å¯¹å‘½ä»¤è¿›è¡Œæ•…éšœæ’é™¤ä»¥ç¡®ä¿æ‚¨ä½¿ç”¨æ­£ç¡®çš„è¯­æ³•ï¼Œå¹¶ä¸”æ‰€æœ‰ä¾èµ–é¡¹éƒ½å¯ç”¨ï¼› æ›´æ­£å®¹å™¨è§„èŒƒå¹¶é‡è¯•è¿è¡Œå®¹å™¨ã€‚ é€€å‡ºç  127ï¼šæ‰¾ä¸åˆ°æ–‡ä»¶æˆ–ç›®å½• é€€å‡ºç  127 è¡¨ç¤ºå®¹å™¨ä¸­æŒ‡å®šçš„å‘½ä»¤å¼•ç”¨äº†ä¸å­˜åœ¨çš„æ–‡ä»¶æˆ–ç›®å½•ã€‚ å¦‚æœå®¹å™¨ä»¥é€€å‡ºç  127 ç»ˆæ­¢æ€ä¹ˆåŠï¼Ÿ ä¸é€€å‡ºç  126 ç›¸åŒï¼Œè¯†åˆ«å¤±è´¥çš„å‘½ä»¤ï¼Œå¹¶ç¡®ä¿å®¹å™¨é•œåƒä¸­å¼•ç”¨çš„æ–‡ä»¶åæˆ–æ–‡ä»¶è·¯å¾„çœŸå®æœ‰æ•ˆã€‚ é€€å‡ºç  128ï¼šé€€å‡ºæ—¶ä½¿ç”¨çš„å‚æ•°æ— æ•ˆ é€€å‡ºç  128 è¡¨ç¤ºå®¹å™¨å†…çš„ä»£ç è§¦å‘äº†é€€å‡ºå‘½ä»¤ï¼Œä½†æ²¡æœ‰æä¾›æœ‰æ•ˆçš„é€€å‡ºç ã€‚ Linux exit å‘½ä»¤åªå…è®¸ 0-255 ä¹‹é—´çš„æ•´æ•°ï¼Œå› æ­¤å¦‚æœè¿›ç¨‹ä»¥é€€å‡ºç  3.5 é€€å‡ºï¼Œåˆ™æ—¥å¿—å°†æŠ¥å‘Šé€€å‡ºä»£ç  128ã€‚ å¦‚æœå®¹å™¨ä»¥é€€å‡ºç  128 ç»ˆæ­¢æ€ä¹ˆåŠï¼Ÿ æ£€æŸ¥å®¹å™¨æ—¥å¿—ä»¥ç¡®å®šå“ªä¸ªåº“å¯¼è‡´å®¹å™¨é€€å‡ºã€‚ ç¡®å®šæœ‰é—®é¢˜çš„åº“åœ¨å“ªé‡Œä½¿ç”¨äº† exit å‘½ä»¤ï¼Œå¹¶æ›´æ­£å®ƒä»¥æä¾›æœ‰æ•ˆçš„é€€å‡ºä»£ç ã€‚ é€€å‡ºç  134ï¼šå¼‚å¸¸ç»ˆæ­¢ (SIGABRT) é€€å‡ºç  134 è¡¨ç¤ºå®¹å™¨è‡ªèº«å¼‚å¸¸ç»ˆæ­¢ï¼Œå…³é—­è¿›ç¨‹å¹¶åˆ·æ–°æ‰“å¼€çš„æµã€‚æ­¤æ“ä½œæ˜¯ä¸å¯é€†çš„ï¼Œç±»ä¼¼ SIGKILLï¼ˆè¯·å‚é˜…ä¸‹é¢çš„é€€å‡ºç  137ï¼‰ã€‚è¿›ç¨‹å¯ä»¥é€šè¿‡æ‰§è¡Œä»¥ä¸‹æ“ä½œä¹‹ä¸€æ¥è§¦å‘ SIGABRTï¼š è°ƒç”¨ libc åº“ä¸­çš„ abort() å‡½æ•°ï¼› è°ƒç”¨ assert() å®ï¼Œç”¨äºè°ƒè¯•ã€‚å¦‚æœæ–­è¨€ä¸ºå‡ï¼Œåˆ™è¯¥è¿‡ç¨‹ä¸­æ­¢ã€‚ å¦‚æœå®¹å™¨ä»¥é€€å‡ºç  134 ç»ˆæ­¢æ€ä¹ˆåŠï¼Ÿ æ£€æŸ¥å®¹å™¨æ—¥å¿—ï¼ŒæŸ¥çœ‹å“ªä¸ªåº“è§¦å‘äº† SIGABRT ä¿¡å·ï¼› æ£€æŸ¥ä¸­æ­¢è¿›ç¨‹æ˜¯å¦æ˜¯é¢„æœŸå†…çš„ï¼ˆä¾‹å¦‚ï¼Œå› ä¸ºåº“å¤„äºè°ƒè¯•æ¨¡å¼ï¼‰ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™å¯¹åº“è¿›è¡Œæ•…éšœæ’é™¤ï¼Œå¹¶ä¿®æ”¹ä»¥é¿å…ä¸­æ­¢å®¹å™¨ã€‚ é€€å‡ºç  137ï¼šç«‹å³ç»ˆæ­¢ (SIGKILL) é€€å‡ºç  137 è¡¨ç¤ºå®¹å™¨å·²æ”¶åˆ°æ¥è‡ªä¸»æœºæ“ä½œç³»ç»Ÿçš„ SIGKILL ä¿¡å·ã€‚è¯¥ä¿¡å·æŒ‡ç¤ºè¿›ç¨‹ç«‹å³ç»ˆæ­¢ï¼Œæ²¡æœ‰å®½é™æœŸã€‚å¯èƒ½çš„åŸå› æ˜¯ï¼š å½“é€šè¿‡å®¹å™¨å¼•æ“æ€æ­»å®¹å™¨æ—¶è§¦å‘ï¼Œä¾‹å¦‚ä½¿ç”¨ docker kill å‘½ä»¤æ—¶ï¼› ç”± Linux ç”¨æˆ·å‘è¿›ç¨‹å‘é€ kill -9 å‘½ä»¤è§¦å‘ï¼› åœ¨å°è¯•ç»ˆæ­¢å®¹å™¨å¹¶ç­‰å¾… 30 ç§’çš„å®½é™æœŸåç”± Kubernetes è§¦å‘ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼‰ï¼› ç”±ä¸»æœºè‡ªåŠ¨è§¦å‘ï¼Œé€šå¸¸æ˜¯ç”±äºå†…å­˜ä¸è¶³ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œdocker inspect å‘½ä»¤å°†æŒ‡ç¤º OOMKilled é”™è¯¯ã€‚ å¦‚æœå®¹å™¨ä»¥é€€å‡ºç  137 ç»ˆæ­¢æ€ä¹ˆåŠï¼Ÿ æ£€æŸ¥ä¸»æœºä¸Šçš„æ—¥å¿—ï¼ŒæŸ¥çœ‹åœ¨å®¹å™¨ç»ˆæ­¢ä¹‹å‰å‘ç”Ÿäº†ä»€ä¹ˆï¼Œä»¥åŠåœ¨æ¥æ”¶åˆ° SIGKILL ä¹‹å‰æ˜¯å¦ä¹‹å‰æ”¶åˆ°è¿‡ SIGTERM ä¿¡å·ï¼ˆä¼˜é›…ç»ˆæ­¢ï¼‰ï¼› å¦‚æœä¹‹å‰æœ‰ SIGTERM ä¿¡å·ï¼Œè¯·æ£€æŸ¥æ‚¨çš„å®¹å™¨è¿›ç¨‹æ˜¯å¦å¤„ç† SIGTERM å¹¶èƒ½å¤Ÿæ­£å¸¸ç»ˆæ­¢ï¼› å¦‚æœæ²¡æœ‰ SIGTERM å¹¶ä¸”å®¹å™¨æŠ¥å‘Šäº† OOMKilled é”™è¯¯ï¼Œåˆ™æ’æŸ¥ä¸»æœºä¸Šçš„å†…å­˜é—®é¢˜ã€‚ é€€å‡ºç  139ï¼šåˆ†æ®µé”™è¯¯ (SIGSEGV) é€€å‡ºç  139 è¡¨ç¤ºå®¹å™¨æ”¶åˆ°äº†æ¥è‡ªæ“ä½œç³»ç»Ÿçš„ SIGSEGV ä¿¡å·ã€‚è¿™è¡¨ç¤ºåˆ†æ®µé”™è¯¯ â€”â€” å†…å­˜è¿è§„ï¼Œç”±å®¹å™¨è¯•å›¾è®¿é—®å®ƒæ— æƒè®¿é—®çš„å†…å­˜ä½ç½®å¼•èµ·ã€‚SIGSEGV é”™è¯¯æœ‰ä¸‰ä¸ªå¸¸è§åŸå› ï¼š ç¼–ç é”™è¯¯ï¼šå®¹å™¨è¿›ç¨‹æ²¡æœ‰æ­£ç¡®åˆå§‹åŒ–ï¼Œæˆ–è€…å®ƒè¯•å›¾é€šè¿‡æŒ‡å‘å…ˆå‰é‡Šæ”¾çš„å†…å­˜çš„æŒ‡é’ˆæ¥è®¿é—®å†…å­˜ äºŒè¿›åˆ¶æ–‡ä»¶å’Œåº“ä¹‹é—´ä¸å…¼å®¹ï¼šå®¹å™¨è¿›ç¨‹è¿è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸å…±äº«åº“ä¸å…¼å®¹ï¼Œå› æ­¤å¯èƒ½ä¼šå°è¯•è®¿é—®ä¸é€‚å½“çš„å†…å­˜åœ°å€ ç¡¬ä»¶ä¸å…¼å®¹æˆ–é…ç½®é”™è¯¯ï¼šå¦‚æœæ‚¨åœ¨å¤šä¸ªåº“ä¸­çœ‹åˆ°å¤šä¸ªåˆ†æ®µé”™è¯¯ï¼Œåˆ™ä¸»æœºä¸Šçš„å†…å­˜å­ç³»ç»Ÿå¯èƒ½å­˜åœ¨é—®é¢˜æˆ–ç³»ç»Ÿé…ç½®é—®é¢˜ å¦‚æœå®¹å™¨ä»¥é€€å‡ºç  139 ç»ˆæ­¢æ€ä¹ˆåŠï¼Ÿ æ£€æŸ¥å®¹å™¨è¿›ç¨‹æ˜¯å¦å¤„ç† SIGSEGVã€‚åœ¨ Linux å’Œ Windows ä¸Šï¼Œæ‚¨éƒ½å¯ä»¥å¤„ç†å®¹å™¨å¯¹åˆ†æ®µé”™è¯¯çš„å“åº”ã€‚ä¾‹å¦‚ï¼Œå®¹å™¨å¯ä»¥æ”¶é›†å’ŒæŠ¥å‘Šå †æ ˆè·Ÿè¸ªï¼› å¦‚æœæ‚¨éœ€è¦å¯¹ SIGSEGV è¿›è¡Œè¿›ä¸€æ­¥çš„æ•…éšœæ’é™¤ï¼Œæ‚¨å¯èƒ½éœ€è¦å°†æ“ä½œç³»ç»Ÿè®¾ç½®ä¸ºå³ä½¿åœ¨å‘ç”Ÿåˆ†æ®µé”™è¯¯åä¹Ÿå…è®¸ç¨‹åºè¿è¡Œï¼Œä»¥ä¾¿è¿›è¡Œè°ƒæŸ¥å’Œè°ƒè¯•ã€‚ç„¶åï¼Œå°è¯•æ•…æ„é€ æˆåˆ†æ®µé”™è¯¯å¹¶è°ƒè¯•å¯¼è‡´é—®é¢˜çš„åº“ï¼› å¦‚æœæ‚¨æ— æ³•å¤ç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ä¸»æœºä¸Šçš„å†…å­˜å­ç³»ç»Ÿå¹¶æ’é™¤å†…å­˜é…ç½®æ•…éšœã€‚ é€€å‡ºç  143ï¼šä¼˜é›…ç»ˆæ­¢ (SIGTERM) é€€å‡ºç  143 è¡¨ç¤ºå®¹å™¨æ”¶åˆ°æ¥è‡ªæ“ä½œç³»ç»Ÿçš„ SIGTERM ä¿¡å·ï¼Œè¯¥ä¿¡å·è¦æ±‚å®¹å™¨æ­£å¸¸ç»ˆæ­¢ï¼Œå¹¶ä¸”å®¹å™¨æˆåŠŸæ­£å¸¸ç»ˆæ­¢ï¼ˆå¦åˆ™æ‚¨å°†çœ‹åˆ°é€€å‡ºç  137ï¼‰ã€‚è¯¥é€€å‡ºç å¯èƒ½çš„åŸå› æ˜¯ï¼š å®¹å™¨å¼•æ“åœæ­¢å®¹å™¨æ—¶è§¦å‘ï¼Œä¾‹å¦‚ä½¿ç”¨ docker stop æˆ– docker-compose down å‘½ä»¤æ—¶ï¼› ç”± Kubernetes å°† Pod è®¾ç½®ä¸º Terminating çŠ¶æ€è§¦å‘ï¼Œå¹¶ç»™å®¹å™¨ 30 ç§’çš„æ—¶é—´ä»¥æ­£å¸¸å…³é—­ã€‚ å¦‚æœå®¹å™¨ä»¥é€€å‡ºç  143 ç»ˆæ­¢æ€ä¹ˆåŠï¼Ÿ æ£€æŸ¥ä¸»æœºæ—¥å¿—ï¼ŒæŸ¥çœ‹æ“ä½œç³»ç»Ÿå‘é€ SIGTERM ä¿¡å·çš„ä¸Šä¸‹æ–‡ã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ Kubernetesï¼Œè¯·æ£€æŸ¥ kubelet æ—¥å¿—ï¼ŒæŸ¥çœ‹ pod æ˜¯å¦ä»¥åŠä½•æ—¶å…³é—­ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œé€€å‡ºç  143 ä¸éœ€è¦æ•…éšœæ’é™¤ã€‚è¿™æ„å‘³ç€å®¹å™¨åœ¨ä¸»æœºæŒ‡ç¤ºåæ­£ç¡®å…³é—­ã€‚ é€€å‡ºç  255ï¼šé€€å‡ºçŠ¶æ€è¶…å‡ºèŒƒå›´ å½“æ‚¨çœ‹åˆ°é€€å‡ºç  255 æ—¶ï¼Œæ„å‘³ç€å®¹å™¨çš„ entrypoint ä»¥è¯¥çŠ¶æ€åœæ­¢ã€‚è¿™æ„å‘³ç€å®¹å™¨åœæ­¢äº†ï¼Œä½†ä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› ã€‚ å¦‚æœå®¹å™¨ä»¥é€€å‡ºç  255 ç»ˆæ­¢æ€ä¹ˆåŠï¼Ÿ å¦‚æœå®¹å™¨åœ¨è™šæ‹Ÿæœºä¸­è¿è¡Œï¼Œé¦–å…ˆå°è¯•åˆ é™¤è™šæ‹Ÿæœºä¸Šé…ç½®çš„ overlay ç½‘ç»œå¹¶é‡æ–°åˆ›å»ºå®ƒä»¬ã€‚ å¦‚æœè¿™ä¸èƒ½è§£å†³é—®é¢˜ï¼Œè¯·å°è¯•åˆ é™¤å¹¶é‡æ–°åˆ›å»ºè™šæ‹Ÿæœºï¼Œç„¶ååœ¨å…¶ä¸Šé‡æ–°è¿è¡Œå®¹å™¨ã€‚ å¦‚æœä¸Šè¿°æ“ä½œå¤±è´¥ï¼Œåˆ™ bash è¿›å…¥å®¹å™¨å¹¶æ£€æŸ¥æœ‰å…³ entrypoint è¿›ç¨‹åŠå…¶å¤±è´¥åŸå› çš„æ—¥å¿—æˆ–å…¶ä»–çº¿ç´¢ã€‚ ","date":"2024-08-11","objectID":"/posts/2024-08-11-containerd-exit/:1:2","tags":["containerd-exit"],"title":"containerd-exit-code","uri":"/posts/2024-08-11-containerd-exit/"},{"categories":["Database"],"content":"PostgreSQL ","date":"2024-08-11","objectID":"/posts/2023-11-12-postgresql/:0:0","tags":["pg","postgresql","db"],"title":"postgresql","uri":"/posts/2023-11-12-postgresql/"},{"categories":["Database"],"content":"ä¸€ã€å®‰è£… docker å®‰è£… # docker-compose.yaml version: \"3\" services: postgres10-5432: image: \"postgres:10-bullseye\" container_name: postgres10-5432 shm_size: \"1gb\" restart: always ports: - \"5432:5432\" volumes: - /data/postgresql:/var/lib/postgresql/data - $PWD/init.sql:/docker-entrypoint-initdb.d/init.sql environment: - POSTGRES_PASSWORD=xxxxxxxxxxx # init.sql CREATE USER db_user WITH CREATEDB ENCRYPTED PASSWORD 'xxxxxxxxxx'; alter user db_user superuser; mac ### install # å®‰è£…æŒ‡å®šç‰ˆæœ¬éœ€è¦åŠ @,ä¾‹å¦‚ @14 brew install postgresql@14 # æŸ¥çœ‹å®‰è£…çš„åŒ… [localhost@Sugar ~]ğŸ³ brew list ==\u003e Formulae icu4c openssl@1.1 postgresql@10 readline # æŸ¥çœ‹åŒ…å®‰è£…çš„ä½ç½® [localhost@Sugar ~]ğŸ³ brew list postgresql@14 /opt/homebrew/Cellar/postgresql@14/14.12/bin/clusterdb /opt/homebrew/Cellar/postgresql@14/14.12/bin/createdb /opt/homebrew/Cellar/postgresql@14/14.12/bin/createuser /opt/homebrew/Cellar/postgresql@14/14.12/bin/dropdb /opt/homebrew/Cellar/postgresql@14/14.12/bin/dropuser /opt/homebrew/Cellar/postgresql@14/14.12/bin/ecpg # é…ç½®ç¯å¢ƒå˜é‡ export PG_HOME=\"/opt/homebrew/opt/postgresql@14\" export PATH=$PG_HOME/bin:$PATH # åŠ è½½ç¯å¢ƒå˜é‡ source ~/.bash_profile ### åˆå§‹åŒ–æ•°æ®åº“ # æŸ¥çœ‹ç‰ˆæœ¬ [localhost@Sugar ~]ğŸ³ pg_ctl -V pg_ctl (PostgreSQL) 14.12 (Homebrew) # åˆå§‹åŒ–æ•°æ®åº“ initdb --locale=C -E UTF-8 /opt/homebrew/var/postgresql@14 # å¯åŠ¨æœåŠ¡ brew services start postgresql@14 # åœæ­¢æœåŠ¡ brew services start postgresql@14 # éåå°å¯åŠ¨ /opt/homebrew/opt/postgresql@14/bin/postgres -D /opt/homebrew/var/postgresql@14 ","date":"2024-08-11","objectID":"/posts/2023-11-12-postgresql/:1:0","tags":["pg","postgresql","db"],"title":"postgresql","uri":"/posts/2023-11-12-postgresql/"},{"categories":["Database"],"content":"äºŒã€é…ç½® ","date":"2024-08-11","objectID":"/posts/2023-11-12-postgresql/:2:0","tags":["pg","postgresql","db"],"title":"postgresql","uri":"/posts/2023-11-12-postgresql/"},{"categories":["Database"],"content":"1ã€ä¿®æ”¹æ•°æ®åº“æ—¶åŒº postgres=# show timezone; TimeZone ---------- Etc/UTC (1 row) sed -i \"s+timezone = 'Etc/UTC'+timezone = 'Asia/Shanghai\" postgresql.conf sed -i \"s+log_timezone = 'Etc/UTC'+log_timezone = 'Asia/Shanghai'\" postgresql.conf postgres=# select pg_reload_conf(); pg_reload_conf ---------------- t (1 row) postgres=# show timezone; TimeZone --------------- Asia/Shanghai (1 row) ","date":"2024-08-11","objectID":"/posts/2023-11-12-postgresql/:2:1","tags":["pg","postgresql","db"],"title":"postgresql","uri":"/posts/2023-11-12-postgresql/"},{"categories":["Database"],"content":"2ã€sqlä½¿ç”¨ æŸ¥è¯¢æ•°æ®åº“å¤§å°ï¼š select datname, pg_size_pretty (pg_database_size(datname)) AS size from pg_database order by size; æŸ¥çœ‹è¡¨å¤§å° --æ•°æ®åº“ä¸­å•ä¸ªè¡¨çš„å¤§å°ï¼ˆä¸åŒ…å«ç´¢å¼•ï¼‰ select pg_size_pretty(pg_relation_size('è¡¨å')); --æŸ¥å‡ºæ‰€æœ‰è¡¨ï¼ˆåŒ…å«ç´¢å¼•ï¼‰å¹¶æ’åº SELECT table_schema || '.' || table_name AS table_full_name, pg_size_pretty(pg_total_relation_size('\"' || table_schema || '\".\"' || table_name || '\"')) AS size FROM information_schema.tables ORDER BY pg_total_relation_size('\"' || table_schema || '\".\"' || table_name || '\"') DESC limit 20; --æŸ¥å‡ºè¡¨å¤§å°æŒ‰å¤§å°æ’åºå¹¶åˆ†ç¦»dataä¸index SELECT table_name, pg_size_pretty(table_size) AS table_size, pg_size_pretty(indexes_size) AS indexes_size, pg_size_pretty(total_size) AS total_size FROM ( SELECT table_name, pg_table_size(table_name) AS table_size, pg_indexes_size(table_name) AS indexes_size, pg_total_relation_size(table_name) AS total_size FROM ( SELECT ('\"' || table_schema || '\".\"' || table_name || '\"') AS table_name FROM information_schema.tables ) AS all_tables ORDER BY total_size DESC ) AS pretty_sizes -- ä¿®æ”¹ç”¨æˆ·å¯†ç  ALTER USER postgres with password 'hello_world'; -- ä¿®æ”¹æ•°æ®åº“å alter database db1 rename to db2; schema ç®¡ç† -- åˆ›å»ºschema create schema test; -- æŸ¥çœ‹schema \\dn -- ä¿®æ”¹schema å±ä¸» alter schema test owner to highgo; -- ä¿®æ”¹schemaåç§° alter schema test rename to testa; create schema test authorization highgo;; -- åˆ‡æ¢schema set search_path to test_schema ä¿®æ”¹æ•°æ®åº“å -- ä¿®æ”¹æ•°æ®åº“å alter database src_dbname rename to dst_dbname; -- å°†æ•°æ®åº“çš„åç§°ç”±database2æ”¹æˆdatabase1 UPDATE pg_database SET datname = 'database1' WHERE datname = 'database2'; æ…¢æŸ¥è¯¢é…ç½® # postgresql.conf # 10s log_min_duration_statement=10000 # çƒ­åŠ è½½é…ç½® postgres=# select pg_reload_conf(); 1 # æŸ¥çœ‹é…ç½®ï¼š postgres=# show log_min_duration_statement; log_min_duration_statement ---------------------------- 10s (1 row) # ä¹Ÿå¯ä»¥é’ˆå¯¹æŸä¸ªç”¨æˆ·æˆ–è€…æŸæ•°æ®åº“è¿›è¡Œè®¾ç½®ï¼š postgres=# alter database test set log_min_duration_statement=5000; # sql æŸ¥è¯¢æ…¢è¯­å¥ï¼Œè¶…è¿‡1s postgres=# select * from pg_stat_activity where state\u003c\u003e'idle' and now()-query_start \u003e interval '1 s' order by query_start; select * from pg_stat_activity where state\u003c\u003e'idle' and now()-query_start \u003e interval '5 s' order by query_start; # æ–­å¼€æ•°æ®åº“è¿æ¥ select pg_terminate_backend(pid) from (select pid from pg_stat_activity where datname = 'db_name' ) as a; # åˆ›å»ºä¸€ä¸ªæ•°æ®åº“å½’å±å…¶ä»–ç”¨æˆ· create database 'db_name' OWNER db_user; # æŸ¥çœ‹æ•°æ®åº“è¿æ¥æ•° select count(*) from pg_stat_activity; select * from pg_stat_activity; # æŸ¥è¯¢æ•°æ®åº“æœ€å¤§è¿æ¥æ•°ï¼Œé»˜è®¤æ˜¯100 postgres=\u003e show max_connections; # docker éƒ¨ç½²åˆ°æ•°æ®åº“ä¿®æ”¹æœ€å¤§è¿æ¥æ•° # è¿›å…¥å®¹å™¨ï¼Œä¿®æ”¹æœ€å¤§è¿æ¥æ•° root@ip142:~# docker exec -ti postgres10-5433 bash root@568a83e098a5:/# sed -ri '/max_connections/c max_connections = 2000' /var/lib/postgresql/data/postgresql.conf # sql åŠ è½½é…ç½® select pg_reload_conf(); ç”¨æˆ·åªè¯»æƒé™è®¾ç½®ï¼šhttps://blog.csdn.net/qq_41018743/article/details/105492884 -- ä»¥super useråˆ›å»ºåªè¯»ç”¨æˆ· CREATE USER readonly WITH PASSWORD '*****'; -- ä»¥super userè®¾ç½®ç”¨æˆ·é»˜è®¤äº‹åŠ¡åªè¯» alter user readonly set default_transaction_read_only=on; -- ä½¿ç”¨æ•°æ®åº“çš„åˆ›å»ºæ‰€æœ‰è€…å»æ‰§è¡Œä»¥ä¸‹æ“ä½œ -- å¢åŠ è¿æ¥æ•°æ®åº“æƒé™ GRANT CONNECT ON DATABASE testDB to readonly; -- åˆ‡æ¢åˆ° testDB \\c testDB; -- èµ‹äºˆç”¨æˆ·æƒé™è®¿é—®publicæ¨¡å¼ GRANT USAGE ON SCHEMA public to readonly; -- èµ‹äºˆè¡¨åºåˆ—æŸ¥çœ‹æƒé™ GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO readonly; GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly; -- æ–°å¢åŠ çš„è¡¨éƒ½é»˜è®¤å¢åŠ æƒé™ alter default privileges in schema public grant select on tables to readonly; -- æ–°å¢åŠ çš„åºåˆ—éƒ½é»˜è®¤å¢åŠ æƒé™ alter default privileges in schema public grant select on SEQUENCES to readonly; ","date":"2024-08-11","objectID":"/posts/2023-11-12-postgresql/:2:2","tags":["pg","postgresql","db"],"title":"postgresql","uri":"/posts/2023-11-12-postgresql/"},{"categories":["Database"],"content":"ä¸‰ã€ä»åº“é…ç½® å‚è€ƒé“¾æ¥ï¼šhttps://help.aliyun.com/document_detail/53096.html ","date":"2024-08-11","objectID":"/posts/2023-11-12-postgresql/:3:0","tags":["pg","postgresql","db"],"title":"postgresql","uri":"/posts/2023-11-12-postgresql/"},{"categories":["Database"],"content":"1ã€é…ç½®PostgreSQLä¸»èŠ‚ç‚¹ 1ï¼‰è¾“å…¥ä»¥ä¸‹SQLè¯­å¥åˆ›å»ºæ•°æ®åº“è´¦å·replicaï¼Œå¹¶è®¾ç½®å¯†ç åŠç™»å½•æƒé™å’Œå¤‡ä»½æƒé™ã€‚ æœ¬ç¤ºä¾‹ä¸­å°†å¯†ç è®¾ç½®ä¸ºreplicaã€‚ CREATE ROLE replica login replication encrypted password 'replica'; CREATE ROLE replica login replication encrypted password 'rRweb9iojLxhVeWNddddddddddd'; 2ï¼‰ä¿®æ”¹é…ç½®æ–‡ä»¶ data/pg_hba.conf åœ¨IPv4 local connectionsæ®µæ·»åŠ ä¸‹é¢ä¸¤è¡Œå†…å®¹ã€‚ host all all \u003cä»èŠ‚ç‚¹çš„VPC IPv4ç½‘æ®µ\u003e md5 #å…è®¸VPCç½‘æ®µä¸­md5å¯†ç è®¤è¯è¿æ¥ host replication replica \u003cä»èŠ‚ç‚¹çš„VPC IPv4ç½‘æ®µ\u003e md5 #å…è®¸ç”¨æˆ·ä»replicationæ•°æ®åº“è¿›è¡Œæ•°æ®åŒæ­¥ postgresql.conf listen_addresses = '*' #ç›‘å¬çš„IPåœ°å€ wal_level = hot_standby #å¯ç”¨çƒ­å¤‡æ¨¡å¼ synchronous_commit = on #å¼€å¯åŒæ­¥å¤åˆ¶ max_wal_senders = 32 #åŒæ­¥æœ€å¤§çš„è¿›ç¨‹æ•°é‡ wal_sender_timeout = 60s #æµå¤åˆ¶ä¸»æœºå‘é€æ•°æ®çš„è¶…æ—¶æ—¶é—´ max_connections = 100 #æœ€å¤§è¿æ¥æ•°ï¼Œä»åº“çš„max_connectionså¿…é¡»è¦å¤§äºä¸»åº“çš„ ä¿®æ”¹å®Œåé‡å¯æœåŠ¡ ","date":"2024-08-11","objectID":"/posts/2023-11-12-postgresql/:3:1","tags":["pg","postgresql","db"],"title":"postgresql","uri":"/posts/2023-11-12-postgresql/"},{"categories":["Database"],"content":"2ã€ä»èŠ‚ç‚¹ä¸Šæ“ä½œ å‚è€ƒé“¾æ¥ï¼šhttps://blog.51cto.com/u_13482808/6875114 pg_basebackup --help ç”¨æ³•ï¼š pg_basebackup [é€‰é¡¹] ... æ§åˆ¶è¾“å‡ºçš„é€‰é¡¹ï¼š -D, --pgdata=DIRECTORY æ¥æ”¶åŸºæœ¬å¤‡ä»½åˆ°ç›®å½•ï¼Œå¦‚æœä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»º -F, --format=p|t è¾“å‡ºæ ¼å¼ï¼ˆplain,ç›´æ¥æ‹·è´æ•°æ®æ–‡ä»¶ï¼Œtar é…åˆ -z -Z è¿›è¡Œæ‰“åŒ…å‹ç¼©ï¼‰ -r, --max-rate=RATE ä¼ è¾“æ•°æ®ç›®å½•çš„æœ€å¤§ä¼ è¾“é€Ÿç‡ï¼ˆä»¥ kB/s ä¸ºå•ä½ï¼Œæˆ–ä½¿ç”¨åç¼€â€œkâ€æˆ–â€œMâ€ï¼‰ -R,--write-recovery-conf æ˜¯å¦è¾“å‡ºrecovery-confæ–‡ä»¶ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨å¤‡ä»½å¿«é€Ÿæ­å»ºå‡ºä»èŠ‚ç‚¹ -T, --tablespace-mapping=OLDDIR=NEWDIR å°† OLDDIR ä¸­çš„è¡¨ç©ºé—´é‡å®šä½åˆ° NEWDIR --waldir=WALDIR é¢„å†™æ—¥å¿—ç›®å½•çš„ä½ç½® -X, --wal-method=none|fetch|stream åŒ…å«æŒ‡å®šæ–¹æ³•æ‰€éœ€çš„ WAL æ–‡ä»¶ -z, --gzip å‹ç¼© tar è¾“å‡º -Z, --compress=0-9 ä½¿ç”¨ç»™å®šçš„å‹ç¼©çº§åˆ«å‹ç¼© tar è¾“å‡º å¸¸è§„é€‰é¡¹ï¼š -c, --checkpoint=fast|spread è®¾ç½®å¿«é€Ÿæˆ–æ‰©å±•æ£€æŸ¥ç‚¹ -C, --create-slot åˆ›å»ºå¤åˆ¶æ§½ -l, --label=LABEL è®¾ç½®å¤‡ä»½æ ‡ç­¾ -n, --no-clean å‡ºé”™åä¸æ¸…ç† -N, --no-sync ä¸ç­‰å¾…æ›´æ”¹å®‰å…¨å†™å…¥ç£ç›˜ -P, --progress æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯ -S, --slot=SLOTNAME è¦ä½¿ç”¨çš„å¤åˆ¶æ§½ -v, --verbose è¾“å‡ºè¯¦ç»†ä¿¡æ¯ -V, --version è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯ï¼Œç„¶åé€€å‡º --no-slot é˜²æ­¢åˆ›å»ºä¸´æ—¶å¤åˆ¶æ§½ --no-verify-checksums ä¸éªŒè¯æ ¡éªŒå’Œ -?, --help æ˜¾ç¤ºæ­¤å¸®åŠ©ï¼Œç„¶åé€€å‡º è¿æ¥é€‰é¡¹ï¼š -d, --dbname æ•°æ®åº“åç§° -h, --host æ•°æ®åº“æœåŠ¡å™¨ä¸»æœºipæˆ–å¥—æ¥å­—ç›®å½• -p, --port æ•°æ®åº“å£å· -s, --status-interval=çŠ¶æ€åŒ…å‘é€åˆ°æœåŠ¡å™¨çš„é—´éš”æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ -U, --username è¿æ¥ç”¨æˆ·ï¼Œè¦æœ‰superæƒé™ -w, --no-password ä»ä¸æç¤ºè¾“å…¥å¯†ç  1ï¼‰å¤‡ä»½æ•°æ® ä½¿ç”¨pg_basebackupåŸºç¡€å¤‡ä»½å·¥å…·æŒ‡å®šå¤‡ä»½ç›®å½•ã€‚ #ä¿æŒpg dataç›®å½•æ ¼å¼ pg_basebackup -h 192.168.1.1 -p 5432 -U replica -D /data/test -cfast -Xs -Pv # è‡ªåŠ¨åˆ›å»ºrecovery.conf pg_basebackup -h 192.168.1.1 -p 5432 -U replica -D /data/test -cfast -Xs -Pv -R # æ‰“åŒ…æˆtaræ–‡ä»¶ pg_basebackup -h 192.168.1.1 -p 5432 -U replica -D /data/test -cfast -Xs -Pv -Ft # æ‰“åŒ…æˆtar.gzæ–‡ä»¶ pg_basebackup -h 192.168.1.1 -p 5432 -U replica -D /data/test -cfast -Xs -Pv -Ft -z æ–°å»ºå¹¶ä¿®æ”¹recovery.confé…ç½®æ–‡ä»¶ã€‚ vim /var/lib/pgsql/11/data/recovery.conf ####åˆ†åˆ«æ‰¾åˆ°ä»¥ä¸‹å‚æ•°ï¼Œå¹¶å°†å‚æ•°ä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼š standby_mode = on #å£°æ˜æ­¤èŠ‚ç‚¹ä¸ºä»åº“ primary_conninfo = 'host=\u003cä¸»èŠ‚ç‚¹IP\u003e port=5432 user=replica password=replica' #å¯¹åº”ä¸»åº“çš„è¿æ¥ä¿¡æ¯ recovery_target_timeline = 'latest' #æµå¤åˆ¶åŒæ­¥åˆ°æœ€æ–°çš„æ•°æ® ä¿®æ”¹postgresql.confæ–‡ä»¶ max_connections = 1000 # æœ€å¤§è¿æ¥æ•°ï¼Œä»èŠ‚ç‚¹éœ€è®¾ç½®æ¯”ä¸»èŠ‚ç‚¹å¤§ hot_standby = on # å¼€å¯çƒ­å¤‡ max_standby_streaming_delay = 30s # æ•°æ®æµå¤‡ä»½çš„æœ€å¤§å»¶è¿Ÿæ—¶é—´ wal_receiver_status_interval = 5s # ä»èŠ‚ç‚¹å‘ä¸»èŠ‚ç‚¹æŠ¥å‘Šè‡ªèº«çŠ¶æ€çš„æœ€é•¿é—´éš”æ—¶é—´ hot_standby_feedback = on # å¦‚æœæœ‰é”™è¯¯çš„æ•°æ®å¤åˆ¶å‘ä¸»è¿›è¡Œåé¦ˆ ä¿®æ”¹æ•°æ®ç›®å½•çš„æƒé™ chown -R postgres.postgres /var/lib/pgsql/11/data å¯åŠ¨æœåŠ¡ ","date":"2024-08-11","objectID":"/posts/2023-11-12-postgresql/:3:2","tags":["pg","postgresql","db"],"title":"postgresql","uri":"/posts/2023-11-12-postgresql/"},{"categories":["Database"],"content":"3ã€éªŒè¯ 1ï¼‰åœ¨ä¸»èŠ‚ç‚¹ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹senderè¿›ç¨‹ã€‚ ps aux |grep sender è¿”å›ç»“æœå¦‚ä¸‹ï¼Œè¡¨ç¤ºå¯æˆåŠŸæŸ¥çœ‹åˆ°senderè¿›ç¨‹ã€‚ postgres 2916 0.0 0.3 340388 3220 ? Ss 15:38 0:00 postgres: wal sender process replica 192.168.**.**(49640) streaming 0/F01C1A8 2ï¼‰åœ¨ä»èŠ‚ç‚¹ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹receiverè¿›ç¨‹ã€‚ ps aux |grep receiver è¿”å›ç»“æœå¦‚ä¸‹ï¼Œè¡¨ç¤ºå¯æˆåŠŸæŸ¥çœ‹åˆ°receiverè¿›ç¨‹ã€‚ postgres 23284 0.0 0.3 387100 3444 ? Ss 16:04 0:00 postgres: wal receiver process streaming 0/F01C1A8 3ï¼‰åœ¨ä¸»èŠ‚ç‚¹ä¸­è¿›å…¥PostgreSQLäº¤äº’ç»ˆç«¯ï¼Œè¾“å…¥ä»¥ä¸‹SQLè¯­å¥ï¼Œåœ¨ä¸»åº“ä¸­æŸ¥çœ‹ä»åº“çŠ¶æ€ã€‚ select * from pg_stat_replication; è¿”å›ç»“æœå¦‚ä¸‹ï¼Œè¡¨ç¤ºå¯æˆåŠŸæŸ¥çœ‹åˆ°ä»åº“çŠ¶æ€ã€‚ pid | usesysid | usename | application_name | client_addr | client_hostname | client_port | backend_start | backend_xmin | state | sent_location | write_locati on | flush_location | replay_location | sync_priority | sync_state ------+----------+---------+------------------+---------------+-----------------+------------- +-------------------------------+--------------+-----------+---------------+------------- ---+----------------+-----------------+---------------+------------ 2916 | 16393 | replica | walreceiver | 192.168.**.** | | 49640 | 2017-05-02 15:38:06.188988+08 | 1836 | streaming | 0/F01C0C8 | 0/F01C0C8 | 0/F01C0C8 | 0/F01C0C8 | 0 | async (1 rows) ","date":"2024-08-11","objectID":"/posts/2023-11-12-postgresql/:3:3","tags":["pg","postgresql","db"],"title":"postgresql","uri":"/posts/2023-11-12-postgresql/"},{"categories":["Database"],"content":"4ã€æŸ¥çœ‹ä¸»ä»å»¶è¿Ÿ å¦‚æœä¸»åº“æ²¡æœ‰æ’å…¥æˆ–è€…ä¿®æ”¹çš„æ•°æ®çš„sqlæ‰§è¡Œï¼Œä¸»ä»åŒæ­¥çš„å»¶æ—¶ä¼šé€æ¸å¢åŠ  select now() - pg_last_xact_replay_timestamp() AS replication_delay; ","date":"2024-08-11","objectID":"/posts/2023-11-12-postgresql/:3:4","tags":["pg","postgresql","db"],"title":"postgresql","uri":"/posts/2023-11-12-postgresql/"},{"categories":["Go åŸºç¡€"],"content":"1ã€å˜é‡å®šä¹‰ var name string var isOk bool // éšå¼ç”³æ˜ a := 100 str := \"sugar\" // æ‰¹é‡å£°æ˜ var ( a string b int c bool d float32 ) // å˜é‡çš„åˆå§‹åŒ– var name string = \"github\" var age int = 10 var name, age = \"github\", 11 // ç±»å‹æ¨å¯¼ var name = \"github\" var age = 11 // å¸¸é‡å£°æ˜ const pi = 3.1415 const e = 2.7182 const ( pi = 3.1415 e = 2.7182 ) // conståŒæ—¶å£°æ˜å¤šä¸ªå¸¸é‡æ—¶ï¼Œå¦‚æœçœç•¥äº†å€¼åˆ™è¡¨ç¤ºå’Œä¸Šé¢ä¸€è¡Œçš„å€¼ç›¸åŒã€‚ const ( n1 = 100 n2 n3 ) // æšä¸¾ const ( n1 = iota //0 n2 //1 n3 //2 n4 //3 ) // ä½¿ç”¨_è·³è¿‡æŸäº›å€¼ const ( n1 = iota //0 n2 //1 _ n4 //3 ) ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:1:0","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["Go åŸºç¡€"],"content":"2ã€æµç¨‹æ§åˆ¶ func ifDemo1() { score := 65 if score \u003e= 90 { fmt.Println(\"A\") } else if score \u003e 75 { fmt.Println(\"B\") } else { fmt.Println(\"C\") } } func forDemo() { for i := 0; i \u003c 10; i++ { fmt.Println(i) } } func forDemo3() { i := 0 for i \u003c 10 { fmt.Println(i) i++ } } // æ— é™å¾ªç¯ for { å¾ªç¯ä½“è¯­å¥ } // switch è¯­æ³• func testSwitch3() { n := 7 switch n { case 1, 3, 5, 7, 9: fmt.Println(\"å¥‡æ•°\") case 2, 4, 6, 8: fmt.Println(\"å¶æ•°\") default: fmt.Println(n) } } ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:2:0","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["Go åŸºç¡€"],"content":"3ã€slice a := []int{1, 2, 3, 4, 5} // ä»åˆ‡ç‰‡ä¸­åˆ é™¤å…ƒç´  func main() { // ä»åˆ‡ç‰‡ä¸­åˆ é™¤å…ƒç´  a := []int{30, 31, 32, 33, 34, 35, 36, 37} // è¦åˆ é™¤ç´¢å¼•ä¸º2çš„å…ƒç´  a = append(a[:2], a[3:]...) fmt.Println(a) //[30 31 33 34 35 36 37] } ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:3:0","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["Go åŸºç¡€"],"content":"4ã€å‡½æ•° // åŒ¿åå‡½æ•° func(x, y int) { fmt.Println(x + y) }(10, 20) ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:4:0","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["Go åŸºç¡€"],"content":"ç»“æ„ä½“ // åµŒå¥—åŒ¿åå­—æ®µ type Address struct { Province string City string } //User ç”¨æˆ·ç»“æ„ä½“ type User struct { Name string Gender string Address //åŒ¿åå­—æ®µ } ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:4:1","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["Go åŸºç¡€"],"content":"5ã€ç¼–è¯‘ Mac ä¸‹ç¼–è¯‘ Linux å’Œ Windowså¹³å° 64ä½ å¯æ‰§è¡Œç¨‹åºï¼š CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build # go 1.16+ç‰ˆæœ¬ CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build CGO_ENABLED=0 GOOS=windows GOARCH=arm64 go build Linux ä¸‹ç¼–è¯‘ Mac å’Œ Windows å¹³å°64ä½å¯æ‰§è¡Œç¨‹åºï¼š CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build Windowsä¸‹ç¼–è¯‘Macå¹³å°64ä½å¯æ‰§è¡Œç¨‹åºï¼š SET CGO_ENABLED=0 SET GOOS=darwin SET GOARCH=amd64 go build å›½å†…é•œåƒè®¾ç½® export GOPROXY=https://goproxy.cn,direct export GOPATH=/root/go export GO111MODULE=\"on\" export GOBIN=$GOPATH/bin export PATH=$PATH:$GOROOT/bin:$GOBIN ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:5:0","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["Go åŸºç¡€"],"content":"6ã€ç§æœ‰ä»“åº“è®¾ç½® go env -w GOPRIVATE=\"github.com/private_org/private_repo\" go env -w GOPRIVATE=\"github.com/private_org\" å¼ºåˆ¶èµ°sshåè®®getç§æœ‰åŒ…ä»£ç  [url \"ssh://git@github.com/\"] insteadOf = https://github.com/ # æˆ–è€… git config --global url.\"ssh://git@github.com/\".insteadOf https://github.com/ # go get/install é»˜è®¤æ˜¯èµ°httpsçš„ï¼Œé»˜è®¤go getå‘èµ·è¯·æ±‚ä½¿ç”¨çš„æ˜¯HTTPSï¼Œå¦‚æœè‡ªå·±çš„ç§æœ‰æœåŠ¡æ˜¯HTTPçš„ï¼Œåˆ™éœ€è¦é…ç½®ä¸‹ã€‚ go env -w GOINSECURE=git.local.com ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:6:0","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["Go åŸºç¡€"],"content":"7ã€makefile # ======================== # Project Info # ======================== PROJECT_NAME := sync-image APP_NAME := $(PROJECT_NAME) DIST_DIR := dist GOBASE := $(shell pwd) GOFILES := $(wildcard *.go) # ======================== # Version \u0026 Build Info # ======================== BRANCH := $(shell git rev-parse --abbrev-ref HEAD 2\u003e/dev/null || echo \"unknown\") BUILD_TIME := $(shell date -u '+%Y-%m-%d %H:%M:%S UTC') GIT_HASH := $(shell git rev-parse --short HEAD 2\u003e/dev/null || echo \"unknown\") GO_VERSION := $(shell go version | awk '{print $$3}') KEY := wzFdVccccccccccccccc LDFLAGS := -s -w \\ -X 'main.APPVersion=$(BRANCH)' \\ -X 'main.GoVersion=$(GO_VERSION)' \\ -X 'main.BuildTime=$(BUILD_TIME)' \\ -X 'main.GitCommit=$(GIT_HASH)' \\ -X 'main.AesKey=$(KEY)' PLATFORMS := \\ linux/amd64 \\ linux/arm64 # linux/riscv64 \\ darwin/amd64 \\ darwin/arm64 \\ windows/amd64 \\ windows/arm64 .PHONY: all all: build .PHONY: clean clean: @echo \"Cleaning...\" @rm -rf $(DIST_DIR) .PHONY: serve serve: @echo \"Running locally...\" go run . .PHONY: build build: clean @mkdir -p $(DIST_DIR) @echo \"Building $(APP_NAME) for local OS...\" @go build -trimpath -ldflags \"$(LDFLAGS)\" -o $(DIST_DIR)/$(APP_NAME) @echo \"\\nâœ… Build succeeded:\" @ls -lh $(DIST_DIR)/$(APP_NAME)* .PHONY: release release: clean @mkdir -p $(DIST_DIR) @go mod tidy @set -e; \\ for plat in $(PLATFORMS); do \\ OS=$${plat%/*}; \\ ARCH=$${plat#*/}; \\ EXE=$$( [ \"$$OS\" = \"windows\" ] \u0026\u0026 echo \".exe\" || echo \"\" ); \\ OUT=$(DIST_DIR)/$(APP_NAME)-$$OS-$$ARCH$$EXE; \\ echo \"ğŸš€ Building $$OUT\"; \\ GOOS=$$OS GOARCH=$$ARCH go build -trimpath -ldflags \"$(LDFLAGS)\" -o $$OUT .; \\ done @echo \"\\nâœ… Release build succeeded:\" @ls -lh $(DIST_DIR)/ ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:7:0","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["Go åŸºç¡€"],"content":"8ã€go work å‚è€ƒé“¾æ¥ï¼šhttps://cloud.tencent.com/developer/article/1970405 go 1.18 æ–°å¢åŠ  workspaceçš„å¼€å‘æ¨¡å¼ï¼Œ ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:8:0","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["Go åŸºç¡€"],"content":"Go work ä½¿ç”¨ä»‹ç» 1ï¼‰åˆ›å»ºä¸€ä¸ªworkspace [root@tc ~]$ mkdir github [root@tc ~]$ cd github 2ï¼‰åˆ›å»ºåŒ… p1 [root@tc p1]$ tree . . â”œâ”€â”€ go.mod â””â”€â”€ p1.go 0 directories, 2 files [root@tc p1]$ cat p1.go package p1 import \"fmt\" func Hello(obj string) { fmt.Printf(\"Hello %s\\n\", obj) } 3ï¼‰å›åˆ°githubç›®å½•ï¼Œç”Ÿæˆgo.work [root@tc github]$ go work init ./p1 [root@tc github]$ cat go.work go 1.18 use ( ./p1 ) 4ã€åˆ›å»ºp2ï¼Œgo [root@tc p2]$ tree . . â”œâ”€â”€ go.mod â””â”€â”€ main.go 0 directories, 2 files [root@tc p2]$ cat main.go package main import ( \"github.com/serialt/p1\" ) func main() { p1.Hello(\"world\") } [root@tc p2]$ go run main.go Hello world æ³¨æ„ï¼šä»¥ä¸Šæ“ä½œä¸èƒ½buildæˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå› ä¸ºp2 æ²¡æœ‰è¢«æ·»åŠ go worké‡Œï¼Œéœ€è¦æŠŠp2 æ·»åŠ è¿›go workæ‰èƒ½ä½¿ç”¨ï¼Œå¯ä»¥ç›´æ¥ç¼–è¾‘githubç›®å½•ä¸‹çš„go.workï¼Œä¹Ÿå¯ä½¿ç”¨go work use p2 æŠŠp2æ·»åŠ åˆ°go worké‡Œï¼Œç„¶åå†æ‰§è¡Œgo build [root@tc p2]$ go build [root@tc p2]$ ls go.mod main.go p2 [root@tc p2]$ ./p2 Hello world æ³¨æ„ï¼šå› ä¸ºæ­¤æ—¶p1 æ²¡æœ‰æäº¤åˆ°è¿œç¨‹gitä»“åº“ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œgo mod tidy çš„æ—¶å€™æ˜¯ä¼šå»è¿œç¨‹ä»“åº“ä¸‹è½½è§£å†³ä¾èµ–ï¼Œå¯ä»¥ç­‰p1 å¼€å‘å®Œå æŠŠp1 æäº¤åˆ°è¿œç¨‹ä»“åº“åå†å¯¹p2 è¿›è¡Œgo mod tidyã€‚ ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:8:1","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["Go åŸºç¡€"],"content":"9ã€ä¾èµ–ç‰ˆæœ¬æ§åˆ¶ go ç‰ˆæœ¬ä¾èµ–åº“ç®¡ç†æ–¹å¼ä¸»è¦æœ‰ä¸‰ç§ ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:9:0","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["Go åŸºç¡€"],"content":"æ–¹å¼1ï¼š v1ç‰ˆæœ¬go.mod module github.com/serialt/sugar v2ç‰ˆæœ¬go.md module github.com/serialt/sugar/v2 ä½¿ç”¨åº“æ—¶åº“åä»ç„¶æ˜¯sugar.xxxx å‚è€ƒåœ°å€ https://github.com/serialt/sugar ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:9:1","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["Go åŸºç¡€"],"content":"æ–¹å¼2: github.com/go-git/go-git/v5 ä½¿ç”¨åº“æ—¶å€™åº“åæ˜¯gitï¼Œä½¿ç”¨åº“åæ—¶å€™ä¼šè‡ªåŠ¨å»æ‰go-ï¼Œç›´æ¥ä½¿ç”¨gitã€‚ å‚è€ƒåœ°å€ï¼š https://github.com/serialt/git-mirror/blob/master/service/github.go ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:9:2","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["Go åŸºç¡€"],"content":"æ–¹å¼3ï¼š gopkg.in/yaml.v3 å‚è€ƒåœ°å€ï¼š https://github.com/go-yaml/yaml ä½¿ç”¨åº“æ˜¯æ—¶å€™æ˜¯yaml.xxxxxï¼Œä¼šè‡ªåŠ¨å»æ‰.v3 æ³¨æ„ï¼Œä»¥ä¸Šæ–¹å¼ä¸€ä¸ªrepoå¤šä¸ªç‰ˆæœ¬å…±å­˜çš„åŸºç¡€æ˜¯éœ€è¦ä¸go.mdå¯¹åº”ã€‚ ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:9:3","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["Go åŸºç¡€"],"content":"10ã€å¯é€‰å‚æ•° type Option func(*OptionSet) func New(opts ...Option){ //ä¸‹é¢è®¾ç½®é»˜è®¤å€¼ options:=OptionSet{ A:\"default-a\", B:\"default-b\", C:\"default-c\", } for _,fun:=range opts{ fun(\u0026options) } } //å¦‚æœæˆ‘ä»¬éœ€è¦æä¾›optioné€‰é¡¹,æ¯”æ–¹è¯´è®¾ç½®A func WithA(a string) Option{ return func(opt *OptionSet){ opt.A=a } } // ä½¿ç”¨çš„æ—¶å€™ a=New(WithA(\"abc\")) ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:10:0","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["Go åŸºç¡€"],"content":"11ã€è¿›ç¨‹é€€å‡º // è¿›ç¨‹æŒç»­è¿è¡Œ c := make(chan os.Signal, 1) signal.Notify(c, syscall.SIGTERM, syscall.SIGINT) s := \u003c-c slog.Info(\"Aborting...\", \"signal\", s) os.Exit(2) ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:11:0","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["Go åŸºç¡€"],"content":"12ã€å‡çº§Goç‰ˆæœ¬ å®˜æ–¹æ¨èæ–¹æ³•ç¤ºä¾‹ [sugar@Sugar ~]ğŸ³ go install golang.org/dl/go1.22.6@latest go: downloading golang.org/dl v0.0.0-20240806160245-f9b8f0a29fb9 [sugar@Sugar ~]ğŸ³ go1.22.6 download Downloaded 0.0% ( 16384 / 67301095 bytes) ... Downloaded 1.8% ( 1179648 / 67301095 bytes) ... Downloaded 7.8% ( 5242880 / 67301095 bytes) ... Downloaded 12.9% ( 8667136 / 67301095 bytes) ... Downloaded 18.3% (12337136 / 67301095 bytes) ... Downloaded 23.9% (16056304 / 67301095 bytes) ... Downloaded 27.7% (18661344 / 67301095 bytes) ... Downloaded 31.7% (21348352 / 67301095 bytes) ... Downloaded 36.9% (24821744 / 67301095 bytes) ... Downloaded 44.3% (29818880 / 67301095 bytes) ... Downloaded 50.1% (33750880 / 67301095 bytes) ... Downloaded 55.6% (37437424 / 67301095 bytes) ... Downloaded 61.2% (41205680 / 67301095 bytes) ... Downloaded 65.9% (44367568 / 67301095 bytes) ... Downloaded 71.8% (48348944 / 67301095 bytes) ... Downloaded 77.4% (52084672 / 67301095 bytes) ... Downloaded 82.5% (55492320 / 67301095 bytes) ... Downloaded 88.9% (59834080 / 67301095 bytes) ... Downloaded 95.1% (63995424 / 67301095 bytes) ... Downloaded 100.0% (67301095 / 67301095 bytes) Unpacking /home/sugar/sdk/go1.22.6/go1.22.6.darwin-arm64.tar.gz ... Success. You may now run 'go1.22.6' [sugar@Sugar ~]ğŸ³ å®˜æ–¹æ¨èæ–¹æ³•ä¼šæŠŠå®‰è£…åŒ…ä¸‹è½½åˆ° ~/sdkï¼ŒGOPATH è®¾ç½®ä¸º ~/sdk/goï¼Œåšè½¯é“¾æ¥å³å¯æ–¹ä¾¿ä½¿ç”¨ [sugar@Sugar sdk]ğŸ³ ll total 0 lrwxr-xr-x@ 1 sugar staff 27 Jul 24 09:43 go -\u003e /home/sugar/sdk/go1.21.1 drwxr-xr-x 20 sugar staff 640 Jul 22 20:57 go1.21.1 drwxr-xr-x@ 20 sugar staff 640 Aug 11 13:07 go1.22.6 gvm shell ç®€å•ç‰ˆï¼Œæ”¾å…¥bash_profileä¸­ gvm(){ MY_GO_VERSION=$1 cd \"${HOME}\"/sdk [[ -d \"${HOME}\"/sdk/go${MY_GO_VERSION} ]] if [[ $? -ne 0 ]]; then go install golang.org/dl/go${MY_GO_VERSION}@latest \u0026\u003e/dev/null go${MY_GO_VERSION} download \u0026\u003e/dev/null fi ln -snf \"${HOME}\"/sdk/go${MY_GO_VERSION} \"${HOME}\"/sdk/go } [sugar@Sugar sdk]ğŸ³ gvm 1.22.3 [sugar@Sugar sdk]ğŸ³ go version go version go1.22.3 darwin/arm64 [sugar@Sugar sdk]ğŸ³ gvm 1.22.6 [sugar@Sugar sdk]ğŸ³ go version go version go1.22.6 darwin/arm64 [sugar@Sugar sdk]ğŸ³ ","date":"2024-08-11","objectID":"/posts/2023-11-11-go-basic/:12:0","tags":["Go","basic"],"title":"Go basic","uri":"/posts/2023-11-11-go-basic/"},{"categories":["DevOps"],"content":"Terraform å¸¸ç”¨ provider http tls helm kubernetes vault null local dns random ad cloudï¼š aws aliyun tencent cloud huaweicloud ç¬¬ä¸‰æ–¹åº“ï¼š shellï¼Œæ‰§è¡Œå‘½ä»¤ï¼Œè·å–è¿”å›å€¼ï¼šshell gitlab harbor nexusï¼šdatadrivers serialt postgresql mysql rabbitmq proxmox libvirt grafana docker keycloak restapi kafka virtualbox kubectl kubectl elasticsearch argocd acme artifactory kong hyperv minio elasticstack ovirt eksctl jenkins jira sonarqube kibana zabbix mssql ssh ldap filesystem ","date":"2024-07-21","objectID":"/posts/2024-07-21-tf-lib/:1:0","tags":["terraform-lib","tf-lib"],"title":"TF-lib","uri":"/posts/2024-07-21-tf-lib/"},{"categories":["Dev"],"content":"Protobuf gRPCæ¨èä½¿ç”¨proto3ï¼Œè¿™é‡Œåªä»‹ç»å¸¸ç”¨è¯­æ³•ï¼ŒæŒ‰ç…§å®˜æ–¹æ–‡æ¡£çš„ç»“æ„ç¿»è¯‘ï¼Œè‹±æ–‡æ°´å¹³æœ‰é™ï¼Œå¤æ‚çš„éƒ¨åˆ†æœæ–­æ”¾å¼ƒï¼Œæ›´å¤šé«˜çº§ä½¿ç”¨å§¿åŠ¿è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ ","date":"2024-07-20","objectID":"/posts/2024-07-07-protobuf/:1:0","tags":["Protobuf"],"title":"Protobuf","uri":"/posts/2024-07-07-protobuf/"},{"categories":["Dev"],"content":"Messageå®šä¹‰ ä¸€ä¸ªmessageç±»å‹å®šä¹‰æè¿°äº†ä¸€ä¸ªè¯·æ±‚æˆ–å“åº”çš„æ¶ˆæ¯æ ¼å¼ï¼Œå¯ä»¥åŒ…å«å¤šç§ç±»å‹å­—æ®µã€‚ ä¾‹å¦‚å®šä¹‰ä¸€ä¸ªæœç´¢è¯·æ±‚çš„æ¶ˆæ¯æ ¼å¼SearchRequestï¼Œæ¯ä¸ªè¯·æ±‚åŒ…å«æŸ¥è¯¢å­—ç¬¦ä¸²ã€é¡µç ã€æ¯é¡µæ•°ç›®ã€‚æ¯ä¸ªå­—æ®µå£°æ˜ä»¥åˆ†å·ç»“å°¾ã€‚ syntax = \"proto3\"; message SearchRequest { string query = 1; int32 page_number = 2; int32 result_per_page = 3; } ","date":"2024-07-20","objectID":"/posts/2024-07-07-protobuf/:1:1","tags":["Protobuf"],"title":"Protobuf","uri":"/posts/2024-07-07-protobuf/"},{"categories":["Dev"],"content":"åˆ†é…Tags æ¶ˆæ¯çš„å®šä¹‰ä¸­ï¼Œæ¯ä¸ªå­—æ®µéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ•°å€¼æ ‡ç­¾ã€‚è¿™äº›æ ‡ç­¾ç”¨äºæ ‡è¯†è¯¥å­—æ®µåœ¨æ¶ˆæ¯ä¸­çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œä½¿ç”¨ä¸­çš„ç±»å‹ä¸åº”è¯¥éšæ„æ”¹åŠ¨ã€‚å…¶ä¸­ï¼Œ[1-15]å†…çš„æ ‡è¯†åœ¨ç¼–ç æ—¶å ç”¨ä¸€ä¸ªå­—èŠ‚ï¼ŒåŒ…å«æ ‡è¯†å’Œå­—æ®µç±»å‹ã€‚[16-2047]ä¹‹é—´çš„æ ‡è¯†ç¬¦å ç”¨2ä¸ªå­—èŠ‚ã€‚å»ºè®®ä¸ºé¢‘ç¹å‡ºç°çš„æ¶ˆæ¯å…ƒç´ åˆ†é…[1-15]é—´çš„æ ‡ç­¾ã€‚å¦‚æœè€ƒè™‘åˆ°ä»¥åå¯èƒ½æˆ–æ‰©å±•é¢‘ç¹å…ƒç´ ï¼Œå¯ä»¥é¢„ç•™ä¸€äº›ã€‚ æœ€å°çš„æ ‡è¯†ç¬¦å¯ä»¥ä»1å¼€å§‹ï¼Œæœ€å¤§åˆ°229 - 1ï¼Œæˆ–536,870,911ã€‚ä¸å¯ä»¥ä½¿ç”¨[19000ï¼19999]ä¹‹é—´çš„æ ‡è¯†ç¬¦ï¼Œ Protobufåè®®å®ç°ä¸­é¢„ç•™äº†è¿™äº›æ ‡è¯†ç¬¦ã€‚åœ¨.protoæ–‡ä»¶ä¸­ä½¿ç”¨è¿™äº›é¢„ç•™æ ‡è¯†å·ï¼Œç¼–è¯‘æ—¶ä¼šæŠ¥é”™ã€‚ ","date":"2024-07-20","objectID":"/posts/2024-07-07-protobuf/:1:2","tags":["Protobuf"],"title":"Protobuf","uri":"/posts/2024-07-07-protobuf/"},{"categories":["Dev"],"content":"å­—æ®µè§„åˆ™ å•æ•°å½¢æ€ï¼šä¸€ä¸ªmessageå†…åŒåå•æ•°å½¢æ€çš„å­—æ®µä¸èƒ½è¶…è¿‡ä¸€ä¸ª repeatedï¼šå‰ç½®repeatedå…³é”®è¯ï¼Œå£°æ˜è¯¥å­—æ®µä¸ºæ•°ç»„ç±»å‹ proto3ä¸æ”¯æŒproto2ä¸­çš„requiredå’Œoptionalå…³é”®å­— ","date":"2024-07-20","objectID":"/posts/2024-07-07-protobuf/:1:3","tags":["Protobuf"],"title":"Protobuf","uri":"/posts/2024-07-07-protobuf/"},{"categories":["Dev"],"content":"æ·»åŠ æ³¨é‡Š å‘.protoæ–‡ä»¶ä¸­æ·»åŠ æ³¨é‡Šï¼Œæ”¯æŒC/C++é£æ ¼åŒæ–œçº¿//å•è¡Œæ³¨é‡Šã€‚ syntax = \"proto3\"; // åè®®ç‰ˆæœ¬å£°æ˜ // SearchRequest æœç´¢è¯·æ±‚æ¶ˆæ¯ message SearchRequest { string query = 1; // æŸ¥è¯¢å­—ç¬¦ä¸² int32 page_number = 2; // é¡µç  int32 result_per_page = 3; // æ¯é¡µæ¡æ•° } ","date":"2024-07-20","objectID":"/posts/2024-07-07-protobuf/:1:4","tags":["Protobuf"],"title":"Protobuf","uri":"/posts/2024-07-07-protobuf/"},{"categories":["Dev"],"content":"ä¿ç•™å­—æ®µåä¸Tag å¯ä»¥ä½¿ç”¨reservedå…³é”®å­—æŒ‡å®šä¿ç•™å­—æ®µåå’Œæ ‡ç­¾ã€‚ message Foo { reserved 2, 15, 9 to 11; reserved \"foo\", \"bar\"; } ","date":"2024-07-20","objectID":"/posts/2024-07-07-protobuf/:1:5","tags":["Protobuf"],"title":"Protobuf","uri":"/posts/2024-07-07-protobuf/"},{"categories":["Dev"],"content":"åŸºæœ¬æ•°æ®ç±»å‹ .proto C++ Java Python Go Ruby C# double double double float float64 Float double float float float float float32 Float float int32 int32 int int int32 Fixnum or Bignum int int64 int64 long ing/long[3] int64 Bignum long uint32 uint32 int[1] int/long[3] uint32 Fixnum or Bignum uint uint64 uint64 long[1] int/long[3] uint64 Bignum ulong sint32 int32 int intj int32 Fixnum or Bignum int sint64 int64 long int/long[3] int64 Bignum long fixed32 uint32 int[1] int uint32 Fixnum or Bignum uint fixed64 uint64 long[1] int/long[3] uint64 Bignum ulong sfixed32 int32 int int int32 Fixnum or Bignum int sfixed64 int64 long int/long[3] int64 Bignum long bool bool boolean boolean bool TrueClass/FalseClass bool string string String str/unicode[4] string String(UTF-8) string bytes string ByteString str []byte String(ASCII-8BIT) ByteString ","date":"2024-07-20","objectID":"/posts/2024-07-07-protobuf/:1:6","tags":["Protobuf"],"title":"Protobuf","uri":"/posts/2024-07-07-protobuf/"},{"categories":["Dev"],"content":"MessageåµŒå¥— message SearchResponse { message Result { string url = 1; string title = 2; repeated string snippets = 3; } repeated Result results = 1; } message Outer { // Level 0 message MiddleAA { // Level 1 message Inner { // Level 2 int64 ival = 1; bool booly = 2; } } message MiddleBB { // Level 1 message Inner { // Level 2 int32 ival = 1; bool booly = 2; } } } ","date":"2024-07-20","objectID":"/posts/2024-07-07-protobuf/:1:7","tags":["Protobuf"],"title":"Protobuf","uri":"/posts/2024-07-07-protobuf/"},{"categories":["Dev"],"content":"Protobuf â€”\u003e Go protoä¸­çš„messageå¯¹åº”goä¸­çš„structï¼Œå…¨éƒ¨ä½¿ç”¨é©¼å³°å‘½åè§„åˆ™ã€‚åµŒå¥—å®šä¹‰çš„messageï¼Œenumè½¬æ¢ä¸ºgoä¹‹åï¼Œåç§°å˜ä¸ºParent_Childç»“æ„ã€‚ // Test æµ‹è¯• message Test { int32 age = 1; int64 count = 2; double money = 3; float score = 4; string name = 5; bool fat = 6; bytes char = 7; // Status æšä¸¾çŠ¶æ€ enum Status { OK = 0; FAIL = 1; } Status status = 8; // Child å­ç»“æ„ message Child { string sex = 1; } Child child = 9; map\u003cstring, string\u003e dict = 10; } // Status æšä¸¾çŠ¶æ€ type Test_Status int32 const ( Test_OK Test_Status = 0 Test_FAIL Test_Status = 1 ) // Test æµ‹è¯• type Test struct { Age int32 `protobuf:\"varint,1,opt,name=age\" json:\"age,omitempty\"` Count int64 `protobuf:\"varint,2,opt,name=count\" json:\"count,omitempty\"` Money float64 `protobuf:\"fixed64,3,opt,name=money\" json:\"money,omitempty\"` Score float32 `protobuf:\"fixed32,4,opt,name=score\" json:\"score,omitempty\"` Name string `protobuf:\"bytes,5,opt,name=name\" json:\"name,omitempty\"` Fat bool `protobuf:\"varint,6,opt,name=fat\" json:\"fat,omitempty\"` Char []byte `protobuf:\"bytes,7,opt,name=char,proto3\" json:\"char,omitempty\"` Status Test_Status `protobuf:\"varint,8,opt,name=status,enum=test.Test_Status\" json:\"status,omitempty\"` Child *Test_Child `protobuf:\"bytes,9,opt,name=child\" json:\"child,omitempty\"` Dict map[string]string `protobuf:\"bytes,10,rep,name=dict\" json:\"dict,omitempty\" protobuf_key:\"bytes,1,opt,name=key\" protobuf_val:\"bytes,2,opt,name=value\"` } // Child å­ç»“æ„ type Test_Child struct { Sex string `protobuf:\"bytes,1,opt,name=sex\" json:\"sex,omitempty\"` } é—®é¢˜å¤„ç† GRPC proto go é‡Œé¢ï¼Œå®šä¹‰äº†int64ï¼Œç”Ÿæˆçš„swaggeræ–‡æ¡£ä¸­ç±»å‹å›è¢«å˜æˆstring ç±»å‹ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ³•å¤„ç†ï¼Œè¿™æ ·ç”Ÿæˆçš„swaggeræ–‡æ¡£ä¸­å°±ä¸å›å‡ºç°æ•°å­—å˜æˆå­—ç¬¦ä¸²çš„é—®é¢˜ import \"protoc-gen-openapiv2/options/openapiv2.proto\"; message List{ int64 date=17 [ (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = { type: INTEGER, format: \"int64\" } ]; // æ—¶é—´ } ","date":"2024-07-20","objectID":"/posts/2024-07-07-protobuf/:1:8","tags":["Protobuf"],"title":"Protobuf","uri":"/posts/2024-07-07-protobuf/"},{"categories":["Dev"],"content":"Kratos ç›®å½•ç»“æ„ . â”œâ”€â”€ Dockerfile â”œâ”€â”€ LICENSE â”œâ”€â”€ Makefile â”œâ”€â”€ README.md â”œâ”€â”€ api // ä¸‹é¢ç»´æŠ¤äº†å¾®æœåŠ¡ä½¿ç”¨çš„protoæ–‡ä»¶ä»¥åŠæ ¹æ®å®ƒä»¬æ‰€ç”Ÿæˆçš„goæ–‡ä»¶ â”‚Â â””â”€â”€ helloworld â”‚Â â””â”€â”€ v1 â”‚Â â”œâ”€â”€ error_reason.pb.go â”‚Â â”œâ”€â”€ error_reason.proto â”‚Â â”œâ”€â”€ error_reason.swagger.json â”‚Â â”œâ”€â”€ greeter.pb.go â”‚Â â”œâ”€â”€ greeter.proto â”‚Â â”œâ”€â”€ greeter.swagger.json â”‚Â â”œâ”€â”€ greeter_grpc.pb.go â”‚Â â””â”€â”€ greeter_http.pb.go â”œâ”€â”€ cmd // æ•´ä¸ªé¡¹ç›®å¯åŠ¨çš„å…¥å£æ–‡ä»¶ â”‚Â â””â”€â”€ server â”‚Â â”œâ”€â”€ main.go â”‚Â â”œâ”€â”€ wire.go // æˆ‘ä»¬ä½¿ç”¨wireæ¥ç»´æŠ¤ä¾èµ–æ³¨å…¥ â”‚Â â””â”€â”€ wire_gen.go â”œâ”€â”€ configs // è¿™é‡Œé€šå¸¸ç»´æŠ¤ä¸€äº›æœ¬åœ°è°ƒè¯•ç”¨çš„æ ·ä¾‹é…ç½®æ–‡ä»¶ â”‚Â â””â”€â”€ config.yaml â”œâ”€â”€ generate.go â”œâ”€â”€ go.mod â”œâ”€â”€ go.sum â”œâ”€â”€ internal // è¯¥æœåŠ¡æ‰€æœ‰ä¸å¯¹å¤–æš´éœ²çš„ä»£ç ï¼Œé€šå¸¸çš„ä¸šåŠ¡é€»è¾‘éƒ½åœ¨è¿™ä¸‹é¢ï¼Œä½¿ç”¨internalé¿å…é”™è¯¯å¼•ç”¨ â”‚ â”œâ”€â”€ biz // ä¸šåŠ¡é€»è¾‘çš„ç»„è£…å±‚ï¼Œç±»ä¼¼ DDD çš„ domain å±‚ï¼Œdata ç±»ä¼¼ DDD çš„ repoï¼Œè€Œ repo æ¥å£åœ¨è¿™é‡Œå®šä¹‰ï¼Œä½¿ç”¨ä¾èµ–å€’ç½®çš„åŸåˆ™ã€‚ â”‚Â â”‚Â â”œâ”€â”€ README.md â”‚Â â”‚Â â”œâ”€â”€ biz.go â”‚Â â”‚Â â””â”€â”€ greeter.go â”‚Â â”œâ”€â”€ conf // å†…éƒ¨ä½¿ç”¨çš„configçš„ç»“æ„å®šä¹‰ï¼Œä½¿ç”¨protoæ ¼å¼ç”Ÿæˆ â”‚Â â”‚Â â”œâ”€â”€ conf.pb.go â”‚Â â”‚Â â””â”€â”€ conf.proto â”‚Â â”œâ”€â”€ data // ä¸šåŠ¡æ•°æ®è®¿é—®ï¼ŒåŒ…å« cacheã€db ç­‰å°è£…ï¼Œå®ç°äº† biz çš„ repo æ¥å£ã€‚æˆ‘ä»¬å¯èƒ½ä¼šæŠŠ data ä¸ dao æ··æ·†åœ¨ä¸€èµ·ï¼Œdata åé‡ä¸šåŠ¡çš„å«ä¹‰ï¼Œå®ƒæ‰€è¦åšçš„æ˜¯å°†é¢†åŸŸå¯¹è±¡é‡æ–°æ‹¿å‡ºæ¥ï¼Œæˆ‘ä»¬å»æ‰äº† DDD çš„ infraå±‚ã€‚ â”‚Â â”‚Â â”œâ”€â”€ README.md â”‚Â â”‚Â â”œâ”€â”€ data.go â”‚Â â”‚Â â””â”€â”€ greeter.go â”‚Â â”œâ”€â”€ server // httpå’Œgrpcå®ä¾‹çš„åˆ›å»ºå’Œé…ç½® â”‚Â â”‚Â â”œâ”€â”€ grpc.go â”‚Â â”‚Â â”œâ”€â”€ http.go â”‚Â â”‚Â â””â”€â”€ server.go â”‚Â â””â”€â”€ service // å®ç°äº† api å®šä¹‰çš„æœåŠ¡å±‚ï¼Œç±»ä¼¼ DDD çš„ application å±‚ï¼Œå¤„ç† DTO åˆ° biz é¢†åŸŸå®ä½“çš„è½¬æ¢(DTO -\u003e DO)ï¼ŒåŒæ—¶ååŒå„ç±» biz äº¤äº’ï¼Œä½†æ˜¯ä¸åº”å¤„ç†å¤æ‚é€»è¾‘ â”‚Â â”œâ”€â”€ README.md â”‚Â â”œâ”€â”€ greeter.go â”‚Â â””â”€â”€ service.go â””â”€â”€ third_party // api ä¾èµ–çš„ç¬¬ä¸‰æ–¹proto â”œâ”€â”€ README.md â”œâ”€â”€ google â”‚Â â””â”€â”€ api â”‚Â â”œâ”€â”€ annotations.proto â”‚Â â”œâ”€â”€ http.proto â”‚Â â””â”€â”€ httpbody.proto â””â”€â”€ validate â”œâ”€â”€ README.md â””â”€â”€ validate.proto ","date":"2024-07-20","objectID":"/posts/2024-07-07-kratos/:0:1","tags":["kratos"],"title":"kratos","uri":"/posts/2024-07-07-kratos/"},{"categories":["Dev"],"content":"kratos å‘½ä»¤ # åˆ›å»ºé¡¹ç›® kratos new helloworld # ç”Ÿæˆæ‰€æœ‰protoæºç ã€wireç­‰ç­‰ go generate ./... ### è¿è¡Œé¡¹ç›® kratos run # æˆ–è€… go run cmd/hello/ # makefile make init # ç”Ÿæˆé…ç½®æ–‡ä»¶ make config # ç”Ÿæˆ api proto make api make generate ","date":"2024-07-20","objectID":"/posts/2024-07-07-kratos/:0:2","tags":["kratos"],"title":"kratos","uri":"/posts/2024-07-07-kratos/"},{"categories":["DevOps"],"content":"CVE OpenSSH CVE-2024-6387 è¯¥æ¼æ´æ˜¯ OpenSSH æœåŠ¡å™¨ ï¼ˆsshdï¼‰ ä¸­çš„ä¿¡å·å¤„ç†ç¨‹åºäº‰ç”¨æ¡ä»¶ï¼Œå…è®¸åœ¨åŸºäº glibc çš„ Linux ç³»ç»Ÿä¸Šä»¥ root èº«ä»½æ‰§è¡Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ ï¼ˆRCEï¼‰;è¿™å¸¦æ¥äº†é‡å¤§çš„å®‰å…¨é£é™©ã€‚æ­¤äº‰ç”¨æ¡ä»¶ä¼šå½±å“ sshd çš„é»˜è®¤é…ç½®ã€‚ https://avd.aliyun.com/detail?id=AVD-2024-6387 ç¼“è§£æªæ–½ # /etc/ssh/sshd_config LoginGraceTime 0 systemctl restart sshd 8.5p1 \u003c= OpenSSH \u003c 9.8p1 ubuntu 22.04 ubuntu 24.04 debian 12 bookworm ubuntuï¼šhttps://ubuntu.com/security/CVE-2024-6387 jammy 22.04 fixed version: 1:8.9p1-3ubuntu0.10 noble 24.04 fixed version: 1:9.6p1-3ubuntu13.3 apt --only-upgrade install openssh-client openssh-server debianï¼šhttps://security-tracker.debian.org/tracker/CVE-2024-6387 bookworm ï¼ˆ12ï¼‰ fixed version: 1:9.2p1-2+deb12u3 almalinux: https://almalinux.org/blog/2024-07-01-almalinux-9-cve-2024-6387/ 9 fixed version: openssh-8.7p1-38.el9.alma.2 dnf --refresh upgrade openssh RHEL: https://access.redhat.com/security/cve/CVE-2024-6387 ä½¿ç”¨ç¼“è§£æªæ–½ Rocky: https://forums.rockylinux.org/t/openssh-vulnerability-cve-2024-6387/14883/2 yum install rocky-release-security yum update openssh openssh-server ","date":"2024-07-01","objectID":"/posts/2024-07-01-cve/:1:0","tags":["openssh","cve"],"title":"openssh-cve","uri":"/posts/2024-07-01-cve/"},{"categories":["DevOps"],"content":"WinSW æœåŠ¡ç®¡ç† â€‹ â€‹ æœ‰æ—¶å€™éœ€è¦å°†batã€exeç­‰æ–‡ä»¶ä½œä¸ºWindowsçš„æœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨batã€nssmç­‰å·¥å…·å°†æ­¤ç±»æ–‡ä»¶è®¾ç½®ä¸ºWindowsæœåŠ¡ï¼Œä½†ä½¿ç”¨winswå¯ä»¥æ›´ç®€å•ã€‚ ä½¿ç”¨winsw æ³¨å†Œæˆç³»ç»Ÿçš„æœåŠ¡åé»˜è®¤å¼€å¯å¼€æœºè‡ªå¯ ","date":"2024-06-30","objectID":"/posts/2024-06-27.winsw/:1:0","tags":["winsw"],"title":"winsw","uri":"/posts/2024-06-27.winsw/"},{"categories":["DevOps"],"content":"1ã€ä¸‹è½½åœ°å€ https://github.com/winsw/winsw/releases ","date":"2024-06-30","objectID":"/posts/2024-06-27.winsw/:1:1","tags":["winsw"],"title":"winsw","uri":"/posts/2024-06-27.winsw/"},{"categories":["DevOps"],"content":"2ã€é…ç½®ç¤ºä¾‹ ä»¥ä¸‹å·²frpä½œä¸ºé…ç½®ç¤ºä¾‹ä»‹ç» ä¸‹è½½ä¸‹æ¥çš„WinSW-x64.exeæ–‡ä»¶å¤åˆ¶åˆ°frpcçš„å®‰è£…ç›®å½•å¹¶é‡å‘½åï¼ˆæ–¹ä¾¿å†™å‘½ä»¤ï¼Œå¦‚service.exeï¼‰ åœ¨frpcçš„å®‰è£…ç›®å½•ä¸­æ–°å»ºä¸€ä¸ªåç§°ä¸ºserviceçš„xmlæ–‡ä»¶ï¼ˆå¿…é¡»è¦å’ŒWinSW-x64.exeé‡å‘½åçš„serviceåç§°ä¸€è‡´ï¼‰ï¼Œç›®çš„æ˜¯WinSWä¼šå»è¯»å–å’Œè‡ªå·±ç›¸åŒåç§°çš„xmlæ–‡ä»¶ä¸­çš„é…ç½®è¿›è¡Œç›¸å…³è®¾ç½®ï¼Œxmlæ–‡ä»¶ä¸­çš„å…·ä½“é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š \u003cservice\u003e \u003c!-- æœåŠ¡IDåç§°ï¼ˆå”¯ä¸€ï¼‰ --\u003e \u003cid\u003eFrpc-Server\u003c/id\u003e \u003c!-- æœåŠ¡æ˜¾ç¤ºåç§° --\u003e \u003cname\u003eFrpc-Server\u003c/name\u003e \u003c!-- æœåŠ¡çš„æè¿°ä¿¡æ¯ --\u003e \u003cdescription\u003eFrpcå®¢æˆ·ç«¯\u003c/description\u003e \u003c!-- å¯è®¾ç½®ç¯å¢ƒå˜é‡ --\u003e \u003cenv name=\"HOME\" value=\"%BASE%\"/\u003e \u003c!-- è¦æ‰§è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶ --\u003e \u003cexecutable\u003e%BASE%\\frpc.exe\u003c/executable\u003e \u003c!-- å¯æ‰§è¡Œæ–‡ä»¶ä¼ é€’çš„å‚æ•° --\u003e \u003c!-- \u003carguments\u003eserver \"%BASE%\\data\"\u003c/arguments\u003e --\u003e \u003clog mode=\"roll-by-size-time\"\u003e \u003c!-- å•ä½ä¸ºKBï¼Œé»˜è®¤å€¼10MB --\u003e \u003csizeThreshold\u003e102400\u003c/sizeThreshold\u003e \u003cpattern\u003eyyyyMMdd\u003c/pattern\u003e \u003cautoRollAtTime\u003e00:00:00\u003c/autoRollAtTime\u003e \u003c/log\u003e \u003c/service\u003e \u003cservice\u003e \u003c!-- è¯¥æœåŠ¡çš„å”¯ä¸€æ ‡è¯† --\u003e \u003cid\u003efrp\u003c/id\u003e \u003c!-- è¯¥æœåŠ¡çš„åç§° --\u003e \u003cname\u003efrpc.exe\u003c/name\u003e \u003c!-- è¯¥æœåŠ¡çš„æè¿° --\u003e \u003cdescription\u003efrpcå®¢æˆ·ç«¯ è¿™ä¸ªæœåŠ¡ç”¨ frpc å®ç°å†…ç½‘ç©¿é€\u003c/description\u003e \u003c!-- è®¾ç½®ç¯å¢ƒå˜é‡ --\u003e \u003cenv name=\"HOME\" value=\"%BASE%\"/\u003e \u003c!-- è¦è¿è¡Œçš„ç¨‹åºè·¯å¾„ --\u003e \u003cexecutable\u003eD:\\frp\\frpc.exe\u003c/executable\u003e \u003c!-- æºå¸¦çš„å‚æ•° --\u003e \u003carguments\u003e-c frpc.ini\u003c/arguments\u003e \u003c!-- ç¬¬ä¸€æ¬¡å¯åŠ¨å¤±è´¥ 60ç§’é‡å¯ --\u003e \u003confailure action=\"restart\" delay=\"60 sec\"/\u003e \u003c!-- ç¬¬äºŒæ¬¡å¯åŠ¨å¤±è´¥ 120ç§’åé‡å¯ --\u003e \u003confailure action=\"restart\" delay=\"120 sec\"/\u003e \u003c!-- æ—¥å¿—æ¨¡å¼ --\u003e \u003clogmode\u003eappend\u003c/logmode\u003e \u003c!-- æŒ‡å®šæ—¥å¿—æ–‡ä»¶ç›®å½•(ç›¸å¯¹äºexecutableé…ç½®çš„è·¯å¾„) --\u003e \u003clogpath\u003elogs\u003c/logpath\u003e \u003c/service\u003e yamlæ ¼å¼ service.yaml id: jenkins name: Jenkins description: This service runs Jenkins continuous integration system. env: - name: JENKINS_HOME value: \"%BASE%\" executable: java # arguments: arg1 arg2 arg3 arguments: \u003e -Xrs -Xmx256m -jar \"%BASE%\\jenkins.war\" --httpPort=8080 log: mode: roll-by-size logpath: '%BASE%\\log' # 100M sizeThreshold: 102400 keepFiles: 5 depend: - Eventlog - W32Time onFailure: - action: restart delay: 10 sec workingdirectory: '%BASE%\\workdir' ç›®å½•: D:\\frp Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 2022/11/10 15:36 logs -a---- 2022/11/10 9:54 11677696 frpc.exe -a---- 2022/11/10 15:20 451 frpc.ini -a---- 2022/11/10 15:34 17462251 service.exe -a---- 2022/11/10 15:34 831 service.xml ","date":"2024-06-30","objectID":"/posts/2024-06-27.winsw/:1:2","tags":["winsw"],"title":"winsw","uri":"/posts/2024-06-27.winsw/"},{"categories":["DevOps"],"content":"3ã€æœåŠ¡ç®¡ç† æ‰“å¼€CMDæˆ–Powershell è¿›è¡Œå®‰è£…æœåŠ¡ # å®‰è£…æœåŠ¡ PS D:\\frp\u003e .\\service.exe install 2022-11-10 15:45:11,601 INFO - Installing service 'Frpc-Server (Frpc-Server)'... 2022-11-10 15:45:11,654 INFO - Service 'Frpc-Server (Frpc-Server)' was installed successfully. # å¯åŠ¨æœåŠ¡ PS D:\\frp\u003e .\\service.exe start 2022-11-10 15:45:20,538 INFO - Starting service 'Frpc-Server (Frpc-Server)'... 2022-11-10 15:45:21,705 INFO - Service 'Frpc-Server (Frpc-Server)' started successfully. # æŸ¥çœ‹æœåŠ¡çŠ¶æ€ PS D:\\frp\u003e .\\service.exe status Started # é‡å¯æœåŠ¡ PS D:\\frp\u003e .\\service.exe restart 2022-11-10 15:45:41,415 INFO - Stopping service 'Frpc-Server (Frpc-Server)'... 2022-11-10 15:45:41,703 INFO - Starting service 'Frpc-Server (Frpc-Server)'... 2022-11-10 15:45:43,255 INFO - Service 'Frpc-Server (Frpc-Server)' restarted successfully. # åœæ­¢æœåŠ¡ PS D:\\frp\u003e .\\service.exe stop 2022-11-10 15:45:51,015 INFO - Stopping service 'Frpc-Server (Frpc-Server)'... 2022-11-10 15:45:51,033 INFO - Service 'Frpc-Server (Frpc-Server)' stopped successfully. # å¸è½½æœåŠ¡ PS D:\\frp\u003e .\\service.exe uninstall 2022-11-10 15:45:57,827 INFO - Uninstalling service 'Frpc-Server (Frpc-Server)'... 2022-11-10 15:45:57,839 INFO - Service 'Frpc-Server (Frpc-Server)' was uninstalled successfully. # æŸ¥çœ‹helpå‘½ä»¤ PS D:\\frp\u003e .\\service.exe --help A wrapper binary that can be used to host executables as Windows services Usage: winsw \u003ccommand\u003e [\u003cargs\u003e] Missing arguments triggers the service mode Available commands: install install the service to Windows Service Controller uninstall uninstall the service start start the service (must be installed before) stop stop the service stopwait stop the service and wait until it's actually stopped restart restart the service restart! self-restart (can be called from child processes) status check the current status of the service test check if the service can be started and then stopped testwait starts the service and waits until a key is pressed then stops the service version print the version info help print the help info (aliases: -h,--help,-?,/?) Extra options: /redirect redirect the wrapper's STDOUT and STDERR to the specified file WinSW 2.11.0.0 More info: GitHub - winsw/winsw: A wrapper executable that can run any executable as a Windows service, in a pe Bug tracker: https://github.com/winsw/winsw/issues ","date":"2024-06-30","objectID":"/posts/2024-06-27.winsw/:1:3","tags":["winsw"],"title":"winsw","uri":"/posts/2024-06-27.winsw/"},{"categories":["DevOps"],"content":"4ã€windows æœåŠ¡ä¸­æ£€æŸ¥ Win + R æ‰“å¼€è¿è¡Œ â€“\u003e è¾“å…¥ services.msc ","date":"2024-06-30","objectID":"/posts/2024-06-27.winsw/:1:4","tags":["winsw"],"title":"winsw","uri":"/posts/2024-06-27.winsw/"},{"categories":["DevOps"],"content":"5ã€WinSWå‘½ä»¤ å‘½ä»¤ æè¿° install å®‰è£…æœåŠ¡ uninstall å¸è½½æœåŠ¡ start å¯åŠ¨æœåŠ¡ stop åœæ­¢æœåŠ¡ restart é‡å¯æœåŠ¡ status æ£€æŸ¥æœåŠ¡çŠ¶æ€ refresh åˆ·æ–°æœåŠ¡å±æ€§è€Œä¸æ˜¯é‡æ–°å®‰è£… customize â€“ ","date":"2024-06-30","objectID":"/posts/2024-06-27.winsw/:1:5","tags":["winsw"],"title":"winsw","uri":"/posts/2024-06-27.winsw/"},{"categories":["web server"],"content":"Caddy Caddy æ˜¯ä¸€ä¸ª Go ç¼–å†™çš„ Web æœåŠ¡å™¨ï¼Œç±»ä¼¼äº Nginxï¼ŒCaddy æä¾›äº†æ›´åŠ å¼ºå¤§çš„åŠŸèƒ½ï¼Œéšç€ v2 ç‰ˆæœ¬å‘å¸ƒ Caddy å·²ç»å¯ä»¥ä½œä¸ºä¸­å°å‹ç«™ç‚¹ Web æœåŠ¡å™¨çš„å¦ä¸€ä¸ªé€‰æ‹©ï¼›ç›¸è¾ƒäº Nginx æ¥è¯´ä½¿ç”¨ Caddy çš„ä¼˜åŠ¿å¦‚ä¸‹: è‡ªåŠ¨çš„ HTTPS è¯ä¹¦ç”³è¯·(ACME HTTP/DNS æŒ‘æˆ˜) è‡ªåŠ¨è¯ä¹¦ç»­æœŸä»¥åŠ OCSP stapling ç­‰ æ›´é«˜çš„å®‰å…¨æ€§åŒ…æ‹¬ä½†ä¸é™äº TLS é…ç½®ä»¥åŠå†…å­˜å®‰å…¨ç­‰ å‹å¥½ä¸”å¼ºå¤§çš„é…ç½®æ–‡ä»¶æ”¯æŒ æ”¯æŒ API åŠ¨æ€è°ƒæ•´é…ç½®(æœ‰æœ¨æœ‰äººå¯ä»¥æä¸ª Dashboardï¼Ÿ) æ”¯æŒ HTTP3(QUIC) æ”¯æŒåŠ¨æ€åç«¯ï¼Œä¾‹å¦‚è¿æ¥ Consulã€ä½œä¸º k8s ingress ç­‰ åç«¯å¤šç§è´Ÿè½½ç­–ç•¥ä»¥åŠå¥åº·æ£€æµ‹ç­‰ æœ¬èº« Go ç¼–å†™ï¼Œé«˜åº¦æ¨¡å—åŒ–çš„ç³»ç»Ÿæ–¹ä¾¿æ‰©å±•(CoreDNS åŸºäº Caddy1 å¼€å‘) ","date":"2024-06-26","objectID":"/posts/2024-06-26-caddy/:0:0","tags":["caddy","go-web","web-server"],"title":"caddy","uri":"/posts/2024-06-26-caddy/"},{"categories":["web server"],"content":"ä¸€ã€Caddyfile ","date":"2024-06-26","objectID":"/posts/2024-06-26-caddy/:1:0","tags":["caddy","go-web","web-server"],"title":"caddy","uri":"/posts/2024-06-26-caddy/"},{"categories":["web server"],"content":"1ã€ç®€å•ä½¿ç”¨ åœ¨å½“å‰ç›®å½•ä¸‹æ–°å»ºCaddyfileæ–‡ä»¶ localhost { respond \"Hello, world!\" } localhost:2016 { respond \"Goodbye, world!\" } æœåŠ¡ç®¡ç† # å¯åŠ¨æœåŠ¡ caddy start # é‡å¯æœåŠ¡ï¼Œé‡å¯æœåŠ¡æœ‰ä¸¤ç§æ–¹å¼ caddy reload curl localhost:2019/load \\ -X POST \\ -H \"Content-Type: text/caddyfile\" \\ --data-binary @Caddyfile # åœæ­¢æœåŠ¡ caddy stop ","date":"2024-06-26","objectID":"/posts/2024-06-26-caddy/:1:1","tags":["caddy","go-web","web-server"],"title":"caddy","uri":"/posts/2024-06-26-caddy/"},{"categories":["web server"],"content":"2ã€é™æ€æ–‡ä»¶ç®¡ç† æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨ localhost file_server browse æ–‡ä»¶å¤¹ä½œä¸ºç«™ç‚¹æ ¹ç›®å½•ï¼š localhost root * /home/me/mysite file_server ","date":"2024-06-26","objectID":"/posts/2024-06-26-caddy/:1:2","tags":["caddy","go-web","web-server"],"title":"caddy","uri":"/posts/2024-06-26-caddy/"},{"categories":["web server"],"content":"3ã€åå‘ä»£ç† localhost reverse_proxy 127.0.0.1:9000 ","date":"2024-06-26","objectID":"/posts/2024-06-26-caddy/:1:3","tags":["caddy","go-web","web-server"],"title":"caddy","uri":"/posts/2024-06-26-caddy/"},{"categories":["web server"],"content":"4ã€å¯ç”¨å‹ç¼©ç®—æ³• localhost encode zstd gzip file_server browse ","date":"2024-06-26","objectID":"/posts/2024-06-26-caddy/:1:4","tags":["caddy","go-web","web-server"],"title":"caddy","uri":"/posts/2024-06-26-caddy/"},{"categories":["web server"],"content":"5ã€å¤šä¸ªç«™ç‚¹ :8080 { respond \"I am 8080\" } :8081 { respond \"I am 8081\" } å¤šç«¯å£ :8080, :8081 { ... } ","date":"2024-06-26","objectID":"/posts/2024-06-26-caddy/:1:5","tags":["caddy","go-web","web-server"],"title":"caddy","uri":"/posts/2024-06-26-caddy/"},{"categories":["web server"],"content":"6ã€åŒ¹é…å™¨ å¯¹æŸä¸€ä¸ªapiä½¿ç”¨åå‘ä»£ç† localhost file_server reverse_proxy /api/* 127.0.0.1:9005 # ç°åœ¨åå‘ä»£ç†åªä¼šå¤„ç†æ‰€æœ‰ä»¥/api/å¼€å§‹çš„è¯·æ±‚ã€‚ ä½¿ç”¨ç¯å¢ƒå˜é‡ export SITE_ADDRESS=localhost:9055 {$SITE_ADDRESS} file_server root * /var/www # matcher token: * root /index.html /var/www # matcher token: /index.html root @post /var/www # matcher token: @post å ä½ç¬¦ ç®€å†™ æ›¿æ¢ {dir} {http.request.uri.path.dir} {file} {http.request.uri.path.file} {header.*} {http.request.header.*} {host} {http.request.host} {labels.*} {http.request.host.labels.*} {hostport} {http.request.hostport} {port} {http.request.port} {method} {http.request.method} {path} {http.request.uri.path} {path.*} {http.request.uri.path.*} {query} {http.request.uri.query} {query.*} {http.request.uri.query.*} {re.*.*} {http.regexp.*.*} {remote} {http.request.remote} {remote_host} {http.request.remote.host} {remote_port} {http.request.remote.port} {scheme} {http.request.scheme} {uri} {http.request.uri} {tls_cipher} {http.request.tls.cipher_suite} {tls_version} {http.request.tls.version} {tls_client_fingerprint} {http.request.tls.client.fingerprint} {tls_client_issuer} {http.request.tls.client.issuer} {tls_client_serial} {http.request.tls.client.serial} {tls_client_subject} {http.request.tls.client.subject} {tls_client_certificate_pem} {http.request.tls.client.certificate_pem} {tls_client_certificate_der_base64} {http.request.tls.client.certificate_der_base64} {upstream_hostport} {http.reverse_proxy.upstream.hostport} åœ¨Caddyfileä¸­ï¼Œç´§è·Ÿåœ¨æŒ‡ä»¤åé¢çš„åŒ¹é…å™¨æ ‡è®°å¯ä»¥é™åˆ¶è¯¥æŒ‡ä»¤çš„èŒƒå›´ã€‚åŒ¹é…å™¨æ ‡è®°å¯ä»¥æ˜¯ä»¥ä¸‹å½¢å¼ä¹‹ä¸€ï¼š \\* åŒ¹é…æ‰€æœ‰è¯·æ±‚ï¼ˆé€šé…ç¬¦ï¼›é»˜è®¤ï¼‰ã€‚ /path ä»¥æ­£æ–œæ å¼€å¤´ä»¥åŒ¹é…è¯·æ±‚è·¯å¾„ã€‚ @name æŒ‡å®šä¸€ä¸ªå‘½ååŒ¹é…å™¨ã€‚ åŒ¹é…å™¨æ ‡è®°é€šå¸¸æ˜¯å¯é€‰çš„ã€‚å¦‚æœçœç•¥åŒ¹é…å™¨æ ‡è®°ï¼Œåˆ™å®ƒä¸é€šé…ç¬¦åŒ¹é…å™¨ï¼ˆ*ï¼‰ç›¸åŒã€‚ å‘½ååŒ¹é…å™¨ è¦åŒ¹é…è·¯å¾„ä»¥å¤–çš„ä»»ä½•å†…å®¹ï¼Œè¯·å®šä¹‰ä¸€ä¸ªå‘½ååŒ¹é…å™¨å¹¶ä½¿ç”¨@nameå¼•ç”¨å®ƒï¼š @postfoo { method POST path /foo/* } reverse_proxy @postfoo localhost:9000 @websockets { header Connection *Upgrade* header Upgrade websocket } reverse_proxy @websockets localhost:6001 file file { root \u003cpaths\u003e try_files \u003cfiles...\u003e try_policy first_exist|smallest_size|largest_size|most_recent_modified split_path \u003cdelims...\u003e } é€šè¿‡æ–‡ä»¶è¿›è¡ŒåŒ¹é…ã€‚ rootå®šä¹‰åœ¨å…¶ä¸­æŸ¥æ‰¾æ–‡ä»¶çš„ç›®å½•ã€‚é»˜è®¤æ˜¯å½“å‰å·¥ä½œç›®å½•ï¼Œæˆ–è€…rootå˜é‡ ({http.vars.root})å¯¹åº”çš„ä½ç½® (å¯ä»¥é€šè¿‡rootæŒ‡ä»¤è®¾ç½®)ã€‚ try_filesæ£€æŸ¥å…¶åˆ—è¡¨ä¸­ä¸é‡è¯•ç­–ç•¥(try_policy)åŒ¹é…çš„æ–‡ä»¶ã€‚å¦‚æœtry_policyæ˜¯first_existï¼Œé‚£ä¹ˆåˆ—è¡¨ä¸­çš„æœ€åä¸€é¡¹å¯èƒ½æ˜¯ä¸€ä¸ªä»¥=(æ¯”å¦‚=404)å¼€å¤´çš„æ•°å­—ï¼Œä½œä¸ºåå¤‡ï¼Œå°†è§¦å‘ä»¥è¿™ä¸ªæ•°å­—ä½œä¸ºé”™è¯¯ç çš„å›è°ƒ; è¯¥é”™è¯¯ä¹Ÿå¯ä»¥ä½¿ç”¨handle_errorsæ•è·å’Œå¤„ç†é”™è¯¯ã€‚ try_policy æŒ‡å®šå¦‚ä½•é€‰æ‹©æ–‡ä»¶ã€‚é»˜è®¤ä¸º first_exist . first_existæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚é€‰æ‹©å­˜åœ¨çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ã€‚ smallest_sizeé€‰æ‹©å¤§å°æœ€å°çš„æ–‡ä»¶ã€‚ largest_sizeé€‰æ‹©æœ€å¤§çš„æ–‡ä»¶ã€‚ most_recent_modifiedé€‰æ‹©æœ€è¿‘ä¿®æ”¹çš„æ–‡ä»¶ã€‚ split_pathå°†å¯¼è‡´è·¯å¾„åœ¨æ¯ä¸ªè¦å°è¯•çš„æ–‡ä»¶è·¯å¾„ä¸­æ‰¾åˆ°çš„åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªåˆ†éš”ç¬¦å¤„æ‹†åˆ†ã€‚å¯¹äºæ¯ä¸ªæ‹†åˆ†å€¼ï¼Œæ‹†åˆ†çš„å·¦ä¾§ï¼ˆåŒ…æ‹¬åˆ†éš”ç¬¦æœ¬èº«ï¼‰å°†æ˜¯å°è¯•çš„æ–‡ä»¶è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œ/remote.php/dav/ä½¿ç”¨.phpä½œä¸ºåˆ†éš”ç¬¦ï¼Œå°†å°è¯•æ–‡ä»¶/remote.phpã€‚æ¯ä¸ªåˆ†éš”ç¬¦å¿…é¡»å‡ºç°åœ¨ URI è·¯å¾„ç»„ä»¶çš„æœ«å°¾ï¼Œæ‰èƒ½ç”¨ä½œæ‹†åˆ†åˆ†éš”ç¬¦ã€‚è¿™æ˜¯ä¸€ä¸ªå°ä¼—è®¾ç½®ï¼Œä¸»è¦ç”¨äºä¸º PHP ç«™ç‚¹æä¾›æœåŠ¡ã€‚ ","date":"2024-06-26","objectID":"/posts/2024-06-26-caddy/:1:6","tags":["caddy","go-web","web-server"],"title":"caddy","uri":"/posts/2024-06-26-caddy/"},{"categories":["web server"],"content":"7ã€åœ°å€ æœ‰æ•ˆåœ°å€ï¼š localhost example.com :443 http://example.com localhost:8080 127.0.0.1 [::1]:2015 example.com/foo/* *.example.com http:// æ³¨æ„ï¼šå¦‚æœä½ çš„ç«™ç‚¹åœ°å€åŒ…å«ä¸»æœºåæˆ– IP åœ°å€ï¼Œåˆ™ä¼šå¯ç”¨è‡ªåŠ¨HTTPSã€‚ç„¶è€Œï¼Œè¿™ç§è¡Œä¸ºçº¯ç²¹æ˜¯éšå«çš„ï¼Œå› æ­¤å®ƒæ°¸è¿œä¸ä¼šè¦†ç›–ä»»ä½•æ˜¾å¼é…ç½®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç«™ç‚¹çš„åœ°å€æ˜¯http://example.comï¼Œåˆ™ä¸ä¼šæ¿€æ´»è‡ªåŠ¨HTTPSï¼Œå› ä¸ºè¯¥æ–¹æ¡ˆæ˜¯æ˜ç¡®çš„http://ã€‚ å¦‚æœæ‰¾ä¸åˆ°æ–‡ä»¶ï¼Œåˆ™å›é€€åˆ°å‘å‡º404é”™è¯¯ã€‚ file {path}.html {path} =404 header header \u003cfield\u003e [\u003cvalue\u003e] é€šè¿‡è¯·æ±‚å¤´å­—æ®µè¿›è¡ŒåŒ¹é…ã€‚ \u003cfield\u003e æ˜¯è¦æ£€æŸ¥çš„ HTTP æ ‡å¤´å­—æ®µçš„åç§°ã€‚ å¦‚æœä»¥!ä¸ºå‰ç¼€ï¼Œåˆ™è¯¥å­—æ®µå¿…é¡»ä¸å­˜åœ¨æ‰èƒ½åŒ¹é… (çœç•¥valueå‚æ•°). \u003cvalue\u003e æ˜¯å­—æ®µå¿…é¡»åŒ¹é…çš„å€¼ã€‚ å¦‚æœå‰ç¼€æ˜¯*ï¼Œåˆ™æ‰§è¡Œå¿«é€Ÿåç¼€åŒ¹é…ã€‚ å¦‚æœåç¼€ä¸º*ï¼Œåˆ™æ‰§è¡Œå¿«é€Ÿå‰ç¼€åŒ¹é…ã€‚ å¦‚æœç”¨*æ‹¬èµ·æ¥ï¼Œå®ƒå°†æ‰§è¡Œå¿«é€Ÿå­å­—ç¬¦ä¸²åŒ¹é…ã€‚ å¦åˆ™ï¼Œå®ƒæ˜¯å¿«é€Ÿç²¾ç¡®åŒ¹é…ã€‚ ç»Ÿä¸€é›†åˆçš„ä¸åŒheaderå­—æ®µæ˜¯â€œå’Œâ€çš„å…³ç³»ã€‚æ¯ä¸ªå­—æ®µçš„å¤šä¸ªå€¼ä¹‹é—´æ˜¯â€œæˆ–â€çš„å…³ç³»ã€‚ ç¤ºä¾‹ï¼š åŒ¹é…è¯·æ±‚Connectionæ ‡å¤´å­—æ®µåŒ…å«Upgradeçš„è¯·æ±‚ï¼š header Connection *Upgrade* åŒ¹é…Fooæ ‡å¤´å­—æ®µåŒ…å«baræˆ–è€…bazçš„è¯·æ±‚ï¼š @foo { header Foo bar header Foo baz } åŒ¹é…æ ¹æœ¬æ²¡æœ‰Fooæ ‡å¤´å­—æ®µçš„è¯·æ±‚ï¼š @not_foo { header !Foo } ","date":"2024-06-26","objectID":"/posts/2024-06-26-caddy/:1:7","tags":["caddy","go-web","web-server"],"title":"caddy","uri":"/posts/2024-06-26-caddy/"},{"categories":["web server"],"content":"8ã€ç‰‡æ®µ å¯ä»¥å®šä¹‰ç§°ä¸ºç‰‡æ®µçš„ç‰¹æ®Šå—ï¼Œæ–¹æ³•æ˜¯ç»™å®ƒä»¬ä¸€ä¸ªç”¨æ‹¬å·æ‹¬èµ·æ¥çš„åç§°ï¼š (redirect) { @http { protocol http } redir @http https://{host}{uri} } ç„¶åä½ å¯ä»¥åœ¨ä»»ä½•ä½ éœ€è¦çš„åœ°æ–¹é‡å¤ä½¿ç”¨å®ƒï¼š import redirect ä¾‹å¦‚ï¼š (snippet) { respond \"Yahaha! You found {args.0}!\" } a.example.com { import snippet \"Example A\" } b.example.com { import snippet \"Example B\" } ","date":"2024-06-26","objectID":"/posts/2024-06-26-caddy/:1:8","tags":["caddy","go-web","web-server"],"title":"caddy","uri":"/posts/2024-06-26-caddy/"},{"categories":["web server"],"content":"9ã€å…¨å±€å‚æ•° { # General Options debug http_port \u003cport\u003e https_port \u003cport\u003e order \u003cdir1\u003e first|last|[before|after \u003cdir2\u003e] storage \u003cmodule_name\u003e { \u003coptions...\u003e } storage_clean_interval \u003cduration\u003e admin off|\u003caddr\u003e { origins \u003corigins...\u003e enforce_origin } log [name] { output \u003cwriter_module\u003e ... format \u003cencoder_module\u003e ... level \u003clevel\u003e include \u003cnamespaces...\u003e exclude \u003cnamespaces...\u003e } grace_period \u003cduration\u003e # TLS Options auto_https off|disable_redirects|ignore_loaded_certs email \u003cyours\u003e default_sni \u003cname\u003e local_certs skip_install_trust acme_ca \u003cdirectory_url\u003e acme_ca_root \u003cpem_file\u003e acme_eab \u003ckey_id\u003e \u003cmac_key\u003e acme_dns \u003cprovider\u003e ... on_demand_tls { ask \u003cendpoint\u003e interval \u003cduration\u003e burst \u003cn\u003e } key_type ed25519|p256|p384|rsa2048|rsa4096 cert_issuer \u003cname\u003e ... ocsp_stapling off preferred_chains [smallest] { root_common_name \u003ccommon_names...\u003e any_common_name \u003ccommon_names...\u003e } # Server Options servers [\u003clistener_address\u003e] { listener_wrappers { \u003clistener_wrappers...\u003e } timeouts { read_body \u003cduration\u003e read_header \u003cduration\u003e write \u003cduration\u003e idle \u003cduration\u003e } max_header_size \u003csize\u003e protocol { allow_h2c experimental_http3 strict_sni_host } } } ","date":"2024-06-26","objectID":"/posts/2024-06-26-caddy/:1:9","tags":["caddy","go-web","web-server"],"title":"caddy","uri":"/posts/2024-06-26-caddy/"},{"categories":["web server"],"content":"äºŒã€ä½¿ç”¨ç¤ºä¾‹ 1ã€é™æ€æ–‡ä»¶æœåŠ¡å™¨ example.com { root * /var/www file_server } åƒå¾€å¸¸ä¸€æ ·ï¼Œç¬¬ä¸€è¡Œæ˜¯ç«™ç‚¹åœ°å€ã€‚è¯¥rootæŒ‡ä»¤æŒ‡å®šç«™ç‚¹æ ¹ç›®å½•çš„è·¯å¾„ï¼ˆ*åŒ¹é…æ‰€æœ‰è¯·æ±‚çš„æ–¹æ³•ï¼Œä»¥ä¾¿ä¸è·¯å¾„åŒ¹é…å™¨æ¶ˆé™¤æ­§ä¹‰ï¼‰ï¼›å¦‚æœç«™ç‚¹ä¸æ˜¯å½“å‰å·¥ä½œç›®å½•ï¼Œåˆ™æ›´æ”¹ç«™ç‚¹çš„è·¯å¾„ã€‚æœ€åï¼Œæˆ‘ä»¬å¯ç”¨é™æ€æ–‡ä»¶æœåŠ¡å™¨ã€‚ 2ã€åå‘ä»£ç†æœåŠ¡å™¨ ä»£ç†æ‰€æœ‰è¯·æ±‚ example.com { reverse_proxy localhost:5000 } åªä»£ç†ä»¥/api/å¼€å¤´çš„è¯·æ±‚ï¼Œå¹¶ä¸ºå…¶ä»–æ‰€æœ‰å†…å®¹æä¾›é™æ€æ–‡ä»¶ï¼š example.com {} root * /var/www reverse_proxy /api/* localhost:5000 file_server } 3ã€php åœ¨è¿è¡ŒPHP FastCGIæœåŠ¡çš„æƒ…å†µä¸‹ï¼Œç±»ä¼¼è¿™æ ·çš„å†…å®¹é€‚ç”¨äºå¤§å¤šæ•°ç°ä»£PHPåº”ç”¨ç¨‹åº example.com root * /var/www php_fastcgi /blog/* localhost:9000 file_server è¯·å¯¹åº”åœ°è°ƒæ•´ç«™ç‚¹æ ¹ç›®å½•å’Œè·¯å¾„åŒ¹é…å™¨ï¼›æ­¤ç¤ºä¾‹å‡å®šPHPä»…ä½äº/blog/å­ç›®å½•ä¸­â€”â€”æ‰€æœ‰å…¶ä»–è¯·æ±‚å°†ä½œä¸ºé™æ€æ–‡ä»¶æä¾›ã€‚ è¯¥php_fastcgiæŒ‡ä»¤å®é™…ä¸Šåªæ˜¯å‡ ä¸ªé…ç½®çš„å¿«æ·æ–¹å¼ã€‚ 4ã€é‡å®šå‘åˆ°www.å­åŸŸå example.com { redir https://www.example.com{uri} } www.example.com { } www.example.com { redir https://example.com{uri} } example.com { } 5ã€é€šé…ç¬¦è¯ä¹¦ *.example.com { tls { dns \u003cprovider_name\u003e [\u003cparams...\u003e] } @foo host foo.example.com handle @foo { respond \"Foo!\" } @bar host bar.example.com handle @bar { respond \"Bar!\" } # Fallback for otherwise unhandled domains handle { abort } } 6ã€web example.com { # ç½‘ç«™çš„åŸŸåä¿¡æ¯ tls example.com.pem example.com.key # è¯ä¹¦å’Œå¯†é’¥çš„ PEM æ ¼å¼çš„æ–‡ä»¶è·¯å¾„ encode zstd gzip # å¯ç”¨å‹ç¼© root * ./ # åŸŸåæ˜ å°„æ ¹è·¯å¾„ file_server # å¯åŠ¨æ–‡ä»¶æœåŠ¡ } example2.com { # ç½‘ç«™çš„åŸŸåä¿¡æ¯ tls example2.com.pem example2.com.key # è¯ä¹¦å’Œå¯†é’¥çš„ PEM æ ¼å¼çš„æ–‡ä»¶è·¯å¾„ reverse_proxy localhost:9000 # åå‘ä»£ç† } ","date":"2024-06-26","objectID":"/posts/2024-06-26-caddy/:2:0","tags":["caddy","go-web","web-server"],"title":"caddy","uri":"/posts/2024-06-26-caddy/"},{"categories":["web server"],"content":"ä¸‰ã€éƒ¨ç½² docker-compose.yaml version: \"3.7\" services: caddy: image: caddy:\u003cversion\u003e restart: unless-stopped ports: - \"80:80\" - \"443:443\" volumes: - $PWD/Caddyfile:/etc/caddy/Caddyfile - $PWD/site:/srv - caddy_data:/data - caddy_config:/config volumes: caddy_data: caddy_config: caddyfile ç¤ºä¾‹ { http_port 9080 # è®¾ç½®httpç±»å‹ servers { protocols h1 h2 } # å…³é—­admin api admin off # auto_https off|disable_redirects|ignore_loaded_certs } (TLSC) { tls /etc/nginx/cert_files/local.com.crt /etc/nginx/cert_files/local.com.key } (LOGC) { log { format transform `{request\u003eremote_ip} - {user_id} [{ts}] \"{request\u003emethod} {request\u003euri} {request\u003eproto}\" {status} {size} \"{request\u003eheaders\u003eReferer\u003e[0]}\" \"{request\u003eheaders\u003eUser-Agent\u003e[0]}\"` { time_format \"iso8601\" } # {args.0} å£°æ˜å¼•ç”¨ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•° output file {args.0} { roll_size 100mb roll_keep 7 roll_local_time roll_keep_for 30d } } } https://terraform-registry.local.com:9090 { encode zstd gzip root * /data/terraform-registry try_files {path} /index.html file_server browse import TLSC import LOGC /var/log/nginx/tf-registry.log } (PROXY_HEADER) { header_up Host {host} header_up REMOTE-HOST {remote} header_up X-Real-IP {remote} header_up X-Forwarded-For {remote} } git.local.com:9090, local.com:9090 { encode zstd gzip import TLSC import LOGC /var/log/nginx/local.com.log reverse_proxy http://localhost4:5000 { import PROXY_HEADER } } ","date":"2024-06-26","objectID":"/posts/2024-06-26-caddy/:2:1","tags":["caddy","go-web","web-server"],"title":"caddy","uri":"/posts/2024-06-26-caddy/"},{"categories":["DevOps"],"content":"Nexus å‚è€ƒï¼š https://juejin.cn/post/6844904016762109959 https://cloud.tencent.com/developer/article/1764866 å®˜ç½‘ï¼šhttps://help.sonatype.com/repomanager3/ ","date":"2024-06-16","objectID":"/posts/2024-06-16-nexus/:0:0","tags":["nexus","repo"],"title":"Nexus","uri":"/posts/2024-06-16-nexus/"},{"categories":["DevOps"],"content":"ä»‹ç» ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸€èˆ¬ä¸ä¼šå…è®¸æ‰€æœ‰æœåŠ¡å™¨éƒ½èƒ½è®¿é—®å…¬ç½‘ï¼Œç†æƒ³çš„æƒ…å†µæ˜¯æœ‰å‡ å°æœåŠ¡å™¨ä½œä¸ºè®¿é—®ä»£ç†ï¼ŒåŒæ—¶ä½œä¸ºç¼“å­˜æœåŠ¡å™¨ã€‚å½“æœåŠ¡å™¨ä¸­æœ‰æ‰€éœ€åŒ…æ—¶é€šè¿‡å†…ç½‘è·å–ï¼Œå¦‚æ— åˆ™é€šè¿‡å…¬ç½‘è·å–åŒæ—¶åœ¨æœ¬åœ°ä¿å­˜ã€‚å¸¸ç”¨æ­å»ºç§æœ‰yumæºçš„æ–¹æ³•æ˜¯createrepoç”Ÿæˆæœ¬åœ°ä»“åº“ï¼Œå…¶å®ƒæœåŠ¡å™¨é€šè¿‡httpè®¿é—®ä»“åº“ã€‚è¿™ç§æ–¹æ³•çš„å¼Šç«¯æ˜¯å¦‚æœå½“å‰ä»“åº“ä¸­æ²¡æœ‰æ‰€éœ€è½¯ä»¶åŒ…ä¼šå¯¼è‡´å®‰è£…å¤±è´¥ï¼Œä¸ä¼šå»å…¶å®ƒæºè·å–æ•°æ®ã€‚Nexusæ˜¯ä¸€ä¸ªå¼ºå¤§çš„ä»“åº“ç®¡ç†å™¨ï¼Œå®ƒæå¤§åœ°ç®€åŒ–äº†è‡ªå·±å†…éƒ¨ä»“åº“çš„ç»´æŠ¤å’Œå¤–éƒ¨ä»“åº“çš„è®¿é—®ã€‚ Nexusæ˜¯ä¸€ä¸ªå¼ºå¤§çš„Mavenä»“åº“ç®¡ç†å™¨ï¼Œå®ƒæå¤§åœ°ç®€åŒ–äº†æœ¬åœ°å†…éƒ¨ä»“åº“çš„ç»´æŠ¤å’Œå¤–éƒ¨ä»“åº“çš„è®¿é—®ã€‚ å¦‚æœä½¿ç”¨äº†å…¬å…±çš„Mavenä»“åº“æœåŠ¡å™¨ï¼Œå¯ä»¥ä»Mavenä¸­å¤®ä»“åº“ä¸‹è½½æ‰€éœ€è¦çš„æ„ä»¶ï¼ˆArtifactï¼‰ï¼Œä½†è¿™é€šå¸¸ä¸æ˜¯ä¸€ä¸ªå¥½çš„åšæ³•ã€‚ æ­£å¸¸åšæ³•æ˜¯åœ¨æœ¬åœ°æ¶è®¾ä¸€ä¸ªMavenä»“åº“æœåŠ¡å™¨ï¼Œå³åˆ©ç”¨Nexuså¯ä»¥åªåœ¨ä¸€ä¸ªåœ°æ–¹å°±èƒ½å¤Ÿå®Œå…¨æ§åˆ¶è®¿é—®å’Œéƒ¨ç½²åœ¨ä½ æ‰€ç»´æŠ¤ä»“åº“ä¸­çš„æ¯ä¸ªArtifactã€‚ Nexusåœ¨ä»£ç†è¿œç¨‹ä»“åº“çš„åŒæ—¶ç»´æŠ¤æœ¬åœ°ä»“åº“ï¼Œä»¥é™ä½ä¸­å¤®ä»“åº“çš„è´Ÿè·,èŠ‚çœå¤–ç½‘å¸¦å®½å’Œæ—¶é—´ï¼ŒNexuså°±å¯ä»¥æ»¡è¶³è¿™æ ·çš„éœ€è¦ã€‚ Nexusæ˜¯ä¸€å¥—â€œå¼€ç®±å³ç”¨â€çš„ç³»ç»Ÿä¸éœ€è¦æ•°æ®åº“ï¼Œå®ƒä½¿ç”¨æ–‡ä»¶ç³»ç»ŸåŠ Luceneæ¥ç»„ç»‡æ•°æ®ã€‚ Nexusä½¿ç”¨ExtJSæ¥å¼€å‘ç•Œé¢ï¼Œåˆ©ç”¨Restletæ¥æä¾›å®Œæ•´çš„REST APIsï¼Œé€šè¿‡m2eclipseä¸Eclipseé›†æˆä½¿ç”¨ã€‚ Nexusæ”¯æŒWebDAVä¸LDAPå®‰å…¨èº«ä»½è®¤è¯ã€‚ Nexusè¿˜æä¾›äº†å¼ºå¤§çš„ä»“åº“ç®¡ç†åŠŸèƒ½ï¼Œæ„ä»¶æœç´¢åŠŸèƒ½ï¼Œå®ƒåŸºäºRESTï¼Œå‹å¥½çš„UIæ˜¯ä¸€ä¸ªextjsçš„RESTå®¢æˆ·ç«¯ï¼Œå®ƒå ç”¨è¾ƒå°‘çš„å†…å­˜ï¼ŒåŸºäºç®€å•æ–‡ä»¶ç³»ç»Ÿè€Œéæ•°æ®åº“ã€‚ ä¸ºä»€ä¹ˆè¦æ„å»ºNexusç§æœï¼Ÿ å¦‚æœæ²¡æœ‰Nexusç§æœï¼Œæˆ‘ä»¬æ‰€éœ€çš„æ‰€æœ‰æ„ä»¶éƒ½éœ€è¦é€šè¿‡mavençš„ä¸­å¤®ä»“åº“å’Œç¬¬ä¸‰æ–¹çš„Mavenä»“åº“ä¸‹è½½åˆ°æœ¬åœ°ï¼Œè€Œä¸€ä¸ªå›¢é˜Ÿä¸­çš„æ‰€æœ‰äººéƒ½é‡å¤çš„ä»mavenä»“åº“ä¸‹è½½æ„ä»¶æ— ç–‘åŠ å¤§äº†ä»“åº“çš„è´Ÿè½½å’Œæµªè´¹äº†å¤–ç½‘å¸¦å®½ï¼Œå¦‚æœç½‘é€Ÿæ…¢çš„è¯ï¼Œè¿˜ä¼šå½±å“é¡¹ç›®çš„è¿›ç¨‹ã€‚å¾ˆå¤šæƒ…å†µä¸‹é¡¹ç›®çš„å¼€å‘éƒ½æ˜¯åœ¨å†…ç½‘è¿›è¡Œçš„ï¼Œè¿æ¥ä¸åˆ°mavenä»“åº“æ€ä¹ˆåŠå‘¢ï¼Ÿå¼€å‘çš„å…¬å…±æ„ä»¶æ€ä¹ˆè®©å…¶å®ƒé¡¹ç›®ä½¿ç”¨ï¼Ÿè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¸å¾—ä¸ä¸ºè‡ªå·±çš„å›¢é˜Ÿæ­å»ºå±äºè‡ªå·±çš„mavenç§æœï¼Œè¿™æ ·æ—¢èŠ‚çœäº†ç½‘ç»œå¸¦å®½ä¹Ÿä¼šåŠ é€Ÿé¡¹ç›®æ­å»ºçš„è¿›ç¨‹ï¼Œå½“ç„¶å‰ææ¡ä»¶å°±æ˜¯ä½ çš„ç§æœä¸­æ‹¥æœ‰é¡¹ç›®æ‰€éœ€çš„æ‰€æœ‰æ„ä»¶ã€‚ åŒæ—¶Nexusæ”¯æŒä»“åº“æœ‰ï¼šAptã€Bowerã€CocoaPodsã€Condaã€Dockerã€Git LFSã€Goã€Mavenã€Npmã€NuGetã€PyPiã€Rawã€RubyGemsã€Yum ","date":"2024-06-16","objectID":"/posts/2024-06-16-nexus/:1:0","tags":["nexus","repo"],"title":"Nexus","uri":"/posts/2024-06-16-nexus/"},{"categories":["DevOps"],"content":"äºŒã€å®‰è£… äºŒè¿›åˆ¶å®‰è£… # ä¸‹è½½åœ°å€ https://help.sonatype.com/repomanager3/download # è§£å‹ tar zxf nexus-3.23.0-03-unix.tar.gz mv nexus-3.23.0-03 sonatype-work /data echo 'NEXUS_HOME=\"/data/nexus-3.23.0-03\"' \u003e\u003e ~/.bashrc echo 'run_as_user=\"root\"' \u003e\u003e /data/nexus-3.23.0-03/bin/nexus.rc # é…ç½®systemdæœåŠ¡ $ vim /etc/systemd/system/nexus.service [Unit] Description=nexus service After=network.target [Service] Type=forking LimitNOFILE=65536 ExecStart=/data/nexus-3.23.0-03/bin/nexus start ExecStop=/data/nexus-3.23.0-03/bin/nexus stop User=root Restart=on-abort [Install] WantedBy=multi-user.target # å¯åŠ¨æœåŠ¡ systemctl start nexus # æ­¤å¤„å¯åŠ¨åï¼Œè¯·è€å¿ƒç­‰å¾…ï¼Œnetstat -tunlp æŸ¥çœ‹ç«¯å£8081ç›‘å¬åç»§ç»­ # æŸ¥çœ‹adminç”¨æˆ·çš„å¯†ç  cat /data/sonatype-work/nexus3/admin.password åŸºäºdockerå®‰è£…nexus mkdir -p /data/nexus/data \u0026\u0026 chown -R 200 /data/nexus/data docker run -d -p 8081:8081 --name nexus -v /data/nexus/data:/nexus-data sonatype/nexus3 docker-composeå®‰è£… mkdir -p /data/nexus/data \u0026\u0026 chown -R 200 /data/nexus/data # docker-compose cat \u003edocker-compose.yaml \u003c\u003cEOF version: \"3\" services: nexus3: image: sonatype/nexus3 container_name: nexus3 restart: always privileged: true environment: - TZ=Asia/Shanghai ports: - '8081:8081' volumes: - /data/nexus/data:/nexus-data EOF æŸ¥çœ‹å¯†ç  ç®¡ç†å‘˜ï¼šadmin å¯†ç ï¼šcat /data/nexus/data/admin.passwor nginxä»£ç†è®¾ç½® upstream nexus-server{ server 127.0.0.1:8081; } #server { # listen 80; # server_name mirrors.cccc.io; # location / { # return 301 https://xx.xx; # } # location ~ /.well-known { # root /tmp; # } #} server { listen 80; server_name nexus.local.com; client_max_body_size 1024m; client_body_buffer_size 128k; location / { proxy_set_header Host $host; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-Proto $scheme; proxy_max_temp_file_size 0; proxy_pass http://nexus-server; proxy_connect_timeout 90; proxy_send_timeout 90; proxy_read_timeout 90; proxy_temp_file_write_size 64k; # Required for new HTTP-based CLI #proxy_http_version 1.1; #proxy_request_buffering off; #proxy_buffering off; # Required for HTTP-based CLI to work over SSL } #ssl_certificate cert/xx.pem; #ssl_certificate_key cert/xx.key; } server { listen 80; server_name mirrors.local.com ; client_max_body_size 1024m; client_body_buffer_size 128k; charset utf-8; location / { proxy_pass http://nexus.local.com/repository/; proxy_set_header Host nexus.local.com; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } access_log /var/log/nginx/mirrors.log; error_log /var/log/nginx/mirrors-error.log; } docker nginx # compose.yaml version: \"3\" services: nexus3: image: sonatype/nexus3:3.67.1-java11 container_name: nexus3 restart: always privileged: true environment: - TZ=Asia/Shanghai ports: - '8081:8081' volumes: - /data/nexus:/nexus-data - /data/nexus-databackup:/nexus3-databackup nginx: container_name: nginx image: nginx restart: always privileged: true volumes: - \"/etc/localtime:/etc/localtime:ro\" - \"${PWD}/ssl:/etc/nginx/cert_files\" - \"${PWD}/config:/etc/nginx/conf.d\" - \"/data/nginx/log:/var/log/nginx\" network_mode: \"host\" # config/nexus.conf upstream nexus-local { server localhost:8081; } server { listen 80; server_name nexus.local.com ; charset utf-8; client_max_body_size 100m; client_body_buffer_size 12800k; location / { proxy_set_header Host $host; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://nexus-local; } access_log /var/log/nginx/nexus.log; error_log /var/log/nginx/nexus-error.log; } server { listen 443 ssl; server_name nexus.local.com ; charset utf-8; client_max_body_size 100m; client_body_buffer_size 12800k; location / { proxy_set_header Host $host; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://nexus-local; } ssl_certificate /etc/","date":"2024-06-16","objectID":"/posts/2024-06-16-nexus/:2:0","tags":["nexus","repo"],"title":"Nexus","uri":"/posts/2024-06-16-nexus/"},{"categories":["DevOps"],"content":"äºŒã€nexusä»“åº“ Nexus ä»“åº“æŒ‰ç…§ç±»å‹ï¼ˆTypeï¼‰åŒºåˆ†ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹ 3 ä¸ªç±»å‹ï¼š ä»£ç†ä»“åº“ï¼ˆproxyï¼‰ï¼šä¸»è¦ç”¨äºä»£ç†ç¼“å­˜è®¿é—®å¤–ç½‘ä¸Šå…¶ä»–å…¬å¼€çš„ä»“åº“ï¼Œå°†æ¯æ¬¡ä»ä»£ç†ä»“åº“æ‹‰å–çš„åˆ¶å“ç¼“å­˜åˆ°nexusæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä¸‹æ¬¡å†æ‹‰å–ç›¸åŒç‰ˆæœ¬åˆ¶å“æ—¶å°±ä¸éœ€å†æ¬¡ä»å¤–ç½‘æ‹‰å–ï¼Œèµ·åˆ°ä»£ç†è®¿é—®ç¼“å­˜çš„åŠŸèƒ½ã€‚ å®¿ä¸»ä»“åº“ï¼ˆhostedï¼‰ï¼šç±»å‹çš„ä»“åº“ä¸»è¦ç”¨äºå­˜æ”¾å„ä¸ªé¡¹ç›®ç»„äº§å‡ºçš„ã€ç”¨äºå…±äº«ã€ä¸èƒ½æ”¾åˆ°å…¬ç½‘ä¸Šã€ç§æœ‰çš„åˆ¶å“ã€‚æœ‰ä¸¤ç§ç‰ˆæœ¬ç­–ç•¥ï¼Œä¸€ç§æ˜¯Snapshotsç‰ˆæœ¬ç­–ç•¥ç±»å‹çš„ï¼Œå¯¹äºç›¸åŒç‰ˆæœ¬åˆ¶å“çš„ä¸Šä¼ ï¼Œnexusä¼šè‡ªåŠ¨è¿½åŠ æ—¶é—´æˆ³åŠ ä»¥åŒºåˆ†ï¼›ä¸€ç§æ˜¯Releaseç‰ˆæœ¬ç­–ç•¥ç±»å‹çš„ï¼Œå¯¹äºç›¸åŒçš„åˆ¶å“ï¼Œè¦æ˜ç¡®ç‰ˆæœ¬ï¼Œä¸èƒ½å­˜æ”¾ç›¸åŒç‰ˆæœ¬ã€‚å¯ä»¥ç†è§£ä¸ºsnapshotsä»“åº“å­˜æ”¾ä¸€äº›å†…å®¹å˜æ›´é¢‘ç¹çš„åˆ¶å“ï¼Œè¿™æ ·ä¸ç®¡ä¸Šä¼ è¿˜æ˜¯ä½¿ç”¨æ—¶ä¸ç”¨é¢‘ç¹å˜æ›´ç‰ˆæœ¬å·å°±èƒ½æ‹‰å–åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚è€Œreleaseä»“åº“å­˜æ”¾ä¸€äº›å†…å®¹ç¨³å®šå˜æ›´å°‘çš„åˆ¶å“ï¼Œä½¿ç”¨æ—¶æŒ‡å®šå¥½ç‰ˆæœ¬å°±è¡Œï¼Œæ— éœ€ç»å¸¸å˜åŠ¨ã€‚ ä»“åº“ç»„ï¼ˆgroupï¼‰ï¼šä¸»è¦ç”¨äºç»„åˆå…¶ä»–ä»“åº“ï¼Œç»Ÿä¸€å¯¹å¤–ä½¿ç”¨æ–¹å¼ã€‚å¯è®¾ç½®ç»„ä»“åº“ç»„åˆå…¶ä»–ä»“åº“çš„é¡ºåºã€‚ä¾‹å¦‚ç»„åˆé¡ºåºä¸ºå…ˆæ‹‰å–mavenæ ¼å¼aliyunä»£ç†ä»“åº“ä¸­çš„åˆ¶å“ï¼Œå¦‚æœå…¶ä¸­æ²¡æœ‰æƒ³è¦çš„åˆ¶å“ï¼Œå†å»æ‹‰å–mavenæ ¼å¼Centralä»£ç†ä»“åº“ä¸­çš„åˆ¶å“ã€‚å¦‚æœè¿˜æ²¡æœ‰ï¼Œå°±å»mavenæ ¼å¼hostedç±»å‹ä»“åº“ä¸­æ‹‰å–ï¼Œç›´åˆ°éå†å®Œæ‰€æœ‰çš„ç»„åˆä»“åº“ã€‚åŒæ—¶ï¼Œæ‹‰å–ä½¿ç”¨æ—¶ä¸éœ€è¦é…ç½®é‚£ä¹ˆå¤šçš„ä»“åº“åœ°å€ï¼Œåªéœ€è¦é…ç½®groupä»“åº“åœ°å€å°±è¡Œã€‚ groupä»“åº“å¯ä»¥åŒ…å«proxyå’Œhostedç±»å‹çš„ä»“åº“ï¼Œå¹¶å¯¹å¤–æä¾›ç»Ÿä¸€çš„æœåŠ¡ ","date":"2024-06-16","objectID":"/posts/2024-06-16-nexus/:3:0","tags":["nexus","repo"],"title":"Nexus","uri":"/posts/2024-06-16-nexus/"},{"categories":["DevOps"],"content":"1ã€yum 1ï¼‰åˆ›å»º proxy ç±»å‹æ ¼å¼ä¸º yum çš„ repo 2ï¼‰åˆ›å»ºgroupç±»å‹çš„ repoï¼Œåœ¨ member repository ä¸­å¢åŠ proxy ç±»å‹çš„repo 3ï¼‰yum æºé…ç½® groupçš„åœ°å€ ","date":"2024-06-16","objectID":"/posts/2024-06-16-nexus/:3:1","tags":["nexus","repo"],"title":"Nexus","uri":"/posts/2024-06-16-nexus/"},{"categories":["DevOps"],"content":"2ã€npm 1ï¼‰åˆ›å»º proxy ç±»å‹çš„ repo â€‹ åˆ›å»ºproxyç±»å‹çš„repoï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ª # å®˜æ–¹åœ°å€ https://registry.npmjs.org/ # é˜¿é‡Œäº‘åœ°å€ https://registry.npmmirror.com # è…¾è®¯ http://mirrors.cloud.tencent.com/npm/ # åä¸º https://repo.huaweicloud.com/repository/npm/ # å—äº¬å¤§å­¦ https://repo.nju.edu.cn/repository/npm/ 2ï¼‰åˆ›å»ºgroupç±»å‹çš„ repoï¼Œåœ¨ member repository ä¸­å¢åŠ proxy ç±»å‹çš„repo 3ï¼‰ npm é…ç½® groupçš„åœ°å€ # é…ç½® npmé»˜è®¤æº npm config set registry http://nexus.local.com/repository/npm # æˆ–è€…ç›´æ¥ä½¿ç”¨npmå‘½ä»¤ npm install -y --registry=http://nexus.local.com/repository/npm/ ","date":"2024-06-16","objectID":"/posts/2024-06-16-nexus/:3:2","tags":["nexus","repo"],"title":"Nexus","uri":"/posts/2024-06-16-nexus/"},{"categories":["DevOps"],"content":"3ã€pypi 1ï¼‰åˆ›å»º proxy ç±»å‹çš„ repo â€‹ åˆ›å»ºproxyç±»å‹çš„repoï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ª # é˜¿é‡Œäº‘ https://mirrors.aliyun.com/pypi # tuna https://pypi.tuna.tsinghua.edu.cn # huaweicloud https://mirrors.huaweicloud.com/repository/pypi/ # nju https://mirror.nju.edu.cn/pypi/web/ # sjtu https://mirror.sjtu.edu.cn/pypi/web 2ï¼‰åˆ›å»ºgroupç±»å‹çš„ repoï¼Œåœ¨ member repository ä¸­å¢åŠ proxy ç±»å‹çš„repo 3ï¼‰é…ç½® groupçš„åœ°å€ vim .pip/pip.conf [global] index-url = http://nexus.local.com/repository/pypi/simple trusted-host = nexus.local.com timeout = 120 # ä¸é…ç½®pip.confç›´æ¥ä½¿ç”¨ pip3 install redis -i http://mirrors.local.com/pypi/simple --truste d-host mirrors.local.com ","date":"2024-06-16","objectID":"/posts/2024-06-16-nexus/:3:3","tags":["nexus","repo"],"title":"Nexus","uri":"/posts/2024-06-16-nexus/"},{"categories":["DevOps"],"content":"4ã€maven 1ï¼‰åˆ›å»º proxy ç±»å‹çš„ repo â€‹ åˆ›å»ºproxyç±»å‹çš„repoï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ª # maven-central https://maven.aliyun.com/repository/central # maven-confluent https://packages.confluent.io/maven/ 2ï¼‰åˆ›å»ºgroupç±»å‹çš„ repoï¼Œåœ¨ member repository ä¸­å¢åŠ proxy ç±»å‹çš„repo 3ï¼‰é…ç½® groupçš„åœ°å€ settings.xml \u003csettings xmlns=\"http://maven.apache.org/SETTINGS/1.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd\"\u003e \u003clocalRepository\u003e/usr/share/maven/ref/repository\u003c/localRepository\u003e \u003cmirrors\u003e \u003cmirror\u003e \u003cid\u003enexus\u003c/id\u003e \u003cname\u003enexus\u003c/name\u003e \u003curl\u003ehttp://nexus.local.com/repository/maven/\u003c/url\u003e \u003cmirrorOf\u003e*\u003c/mirrorOf\u003e \u003c/mirror\u003e \u003c/mirrors\u003e \u003c/settings\u003e ","date":"2024-06-16","objectID":"/posts/2024-06-16-nexus/:3:4","tags":["nexus","repo"],"title":"Nexus","uri":"/posts/2024-06-16-nexus/"},{"categories":["DevOps"],"content":"5ã€apt ä»¥debianä»“åº“ä½œä¸ºç¤ºä¾‹ 1ï¼‰åˆ›å»º proxy ç±»å‹æ ¼å¼ä¸º apt çš„ repoï¼ŒAPT Settings â€”\u003e Distribution é…ç½®ä¸º * ï¼ŒProxy â€”\u003e Remote storage é…ç½®ä¸ºdebian apt æºçš„åœ°å€ 2ï¼‰é…ç½® proxy çš„åœ°å€ # ç¤ºä¾‹: https://mirrors.ustc.edu.cn/debian/ https://nexus.local.com/repositories/debian/ # ä¿®æ”¹å‘½ä»¤ sed -i 's+\\w*.debian.org+nexus.local.com/repository+g' /etc/apt/sources.list ","date":"2024-06-16","objectID":"/posts/2024-06-16-nexus/:3:5","tags":["nexus","repo"],"title":"Nexus","uri":"/posts/2024-06-16-nexus/"},{"categories":["DevOps"],"content":"6ã€alpine ç›®å‰ nexus å®˜æ–¹æš‚æ—¶ä¸æ”¯æŒé…ç½® alpine proxyï¼Œä½†æœ‰ç¤¾åŒºå¼€å‘äº†æ’ä»¶æ”¯æŒ alpine apk ä»£ç† 1ï¼‰å®‰è£…æ’ä»¶ï¼šåˆ° https://central.sonatype.com/ ä¸­æœç´¢å¯¹åº”æ’ä»¶ï¼Œå¹¶ä¸‹è½½å¯¹åº”çš„ jar åŒ…ã€‚ä¸‹è½½åæŠŠ jar åŒ…å¤åˆ¶åˆ°nexusç›®å½•ä¸­çš„deployç›®å½•é‡Œ https://sonatype-nexus-community.github.io/nexus-development-guides/plugin-install.html # for docker wget https://repo1.maven.org/maven2/org/sonatype/nexus/plugins/nexus-repository-apk/0.0.26/nexus-repository-apk-0.0.26.jar docker cp nexus-repository-apk-0.0.26.jar nexus3:/opt/sonatype/nexus/deploy 2ï¼‰åˆ›å»º proxy ç±»å‹æ ¼å¼ä¸º apk çš„ repoï¼Œ 3ï¼‰é…ç½® apk æº sed -i 's+https://dl-cdn.alpinelinux.org+http://nexus.local.com/repository+g' /etc/apk/repositories 4ï¼‰è‡ªå®šä¹‰é•œåƒ wget https://repo1.maven.org/maven2/org/sonatype/nexus/plugins/nexus-repository-apk/0.0.26/nexus-repository-apk-0.0.26.jar # dockerfile FROM sonatype/nexus3:3.68.1-java11 ADD nexus-repository-apk-0.0.26.jar /opt/sonatype/nexus/deploy/ ","date":"2024-06-16","objectID":"/posts/2024-06-16-nexus/:3:6","tags":["nexus","repo"],"title":"Nexus","uri":"/posts/2024-06-16-nexus/"},{"categories":["DevOps"],"content":"7ã€docker 1ï¼‰åœ¨nexus3 åå°é¡µé¢ä¸­åˆ›å»ºä¸€ä¸ªrepositoryï¼Œç±»å‹é€‰æ‹©docker(proxy) 2ï¼‰å¡«å…¥ç›¸å…³å‚æ•° Nameï¼šrepo å Allow anonymous docker pullï¼šå…è®¸æœªç™»å½•çš„ç”¨æˆ·æ‹‰å–é•œåƒï¼Œçœ‹è‡ªå·±æƒ…å†µå‹¾é€‰ Proxy-Remote storageï¼šä»£ç†çš„docker é•œåƒæºã€‚å¯ä»¥å¡«å…¥docker å®˜æ–¹é•œåƒæºhttps://registry-1.docker.io Proxy-Docker Indexï¼šé€‰æ‹© Use Docker Hub Storage-Blob storeï¼šæœ¬åœ°é•œåƒå­˜å‚¨çš„åœ°å€ HTTP-Authenticationï¼šé€‰å¡«ï¼ŒUsernameå’ŒPassword å¡«å…¥docker å®˜ç½‘çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œå¡«çš„è¯æ¯å¤©å¯ä»¥ä¸‹è½½æ›´å¤šé•œåƒï¼ˆå¤§æ¦‚æ˜¯è¿™ä¹ˆä¸ªæ•ˆæœï¼Œä½†ä¸å¡«å½±å“ä¸å¤§ï¼‰ ç‚¹å‡»Create repositoryåˆ›å»º 3ï¼‰åˆ›å»ºä¸€ä¸ªhost repo host repo ä½œä¸ºæœ¬åœ°åˆ›å»ºçš„é•œåƒçš„å­˜æ”¾åœ°å€ï¼Œå¦‚æœä¸æƒ³å°†é•œåƒå­˜åˆ°docker hubï¼Œå°±å¯ä»¥ä¸Šä¼ åˆ°è¿™è¾¹ã€‚ aã€åœ¨nexus3 åå°é¡µé¢ä¸­åˆ›å»ºä¸€ä¸ªrepositoryï¼Œç±»å‹é€‰æ‹©docker(host) bã€å¡«å…¥ç›¸å…³å‚æ•° Nameï¼šrepo å HTTPï¼šç”¨äºæ¨é€åˆ°æœ¬repo çš„http ç«¯å£ï¼Œ8082 Allow anonymous docker pullï¼šå…è®¸æœªç™»å½•çš„ç”¨æˆ·æ‹‰å–é•œåƒï¼Œçœ‹è‡ªå·±æƒ…å†µå‹¾é€‰ Storage-Blob storeï¼šæœ¬åœ°é•œåƒå­˜å‚¨çš„åœ°å€ Host-Deployment policyï¼šä¸Šä¼ é•œåƒçš„è§„åˆ™ Allow redeployï¼šå…è®¸é‡ä¼ ï¼Œä¸€èˆ¬é€‰æ‹©è¿™ä¸ªå³å¯ Disable redeployï¼šç¦æ­¢é‡ä¼  ç‚¹å‡»Create repositoryåˆ›å»º 4ï¼‰åˆ›å»ºä¸€ä¸ªgroup repo group repo å¯ä»¥å°†å¤šä¸ªå…¶ä»–repo èšåˆèµ·æ¥ï¼Œæ‹‰å–é•œåƒæ—¶ç›´æ¥é€‰æ‹©group repo å³å¯ã€‚ åœ¨nexus3 åå°é¡µé¢ä¸­åˆ›å»ºä¸€ä¸ªrepositoryï¼Œç±»å‹é€‰æ‹©docker(group) å¡«å…¥ç›¸å…³å‚æ•° Nameï¼šrepo å HTTPï¼šç”¨äºä¸‹è½½é•œåƒçš„http ç«¯å£ï¼Œ8083 Allow anonymous docker pullï¼šå…è®¸æœªç™»å½•çš„ç”¨æˆ·æ‹‰å–é•œåƒï¼Œçœ‹è‡ªå·±æƒ…å†µå‹¾é€‰ Storage-Blob storeï¼šæœ¬åœ°é•œåƒå­˜å‚¨çš„åœ°å€ Group-Menber repositioriesï¼šå½“å‰repo åŒ…æ‹¬çš„å…¶ä»–repoï¼Œå°†ä¹‹å‰åˆ›å»ºhost repo å’Œproxy repo åŠ å…¥å³è¾¹çš„Membersåˆ—è¡¨ä¸­ï¼ˆhost repo å¯ä»¥ä¼˜å…ˆäºproxy repoï¼Œä»¥ä¼˜å…ˆæ‹‰å–æœ¬åœ°ä¸Šä¼ çš„é•œåƒï¼‰ ç‚¹å‡»Create repositoryåˆ›å»º 5ï¼‰å¯ç”¨Docker Bearer Token Realmä»¥å…è®¸docker ç™»å½•nexus â€‹ aã€è¿›å…¥nexus åå°ç®¡ç†é¡µé¢ï¼ŒSecurity - Realms â€‹ bã€å°†Docker Bearer Token Realmæ·»åŠ åˆ°å³è¾¹Activeæ å†… â€‹ cã€ä¿å­˜ 6ï¼‰nginxé…ç½®æ–‡ä»¶ # webç®¡ç†æ§åˆ¶å° upstream nexus_web { server 10.0.0.5:8081; } # docker-groupèšåˆä»“åº“ upstream nexus_docker_get { server 10.0.0.5:8083; } # docker-hostedæœ¬åœ°ä»“åº“ upstream nexus_docker_put { server 10.0.0.5:8082; } # HTTP è‡ªåŠ¨è·³è½¬ HTTPS server { listen 80; # è®¾ç½®dockerä»£ç†ä½¿ç”¨çš„åŸŸåï¼Œä½ å¯ä»¥å°† docker-registry.hellogitlab.com æ›¿æ¢æˆä½ çš„åŸŸå server_name docker.local.com; rewrite ^ https://$http_host$request_uri? permanent; } server { # ç”±äºä¸Šé¢è®¾ç½®äº†HTTP è‡ªåŠ¨è·³è½¬ HTTPSï¼Œæ­¤å¤„æ³¨é‡Šæ‰80ç«¯å£ # listen 80; listen 443 ssl; # è®¾ç½®dockerä»£ç†ä½¿ç”¨çš„åŸŸåï¼Œä½ å¯ä»¥å°† docker-registry.hellogitlab.com æ›¿æ¢æˆä½ çš„åŸŸå server_name docker.local.com; # è®¾ç½®æ—¥å¿—æ–‡ä»¶ï¼Œå¯¹åº”çš„æ—¥å¿—æ ¼å¼ä½¿ç”¨main # mainæ—¥å¿—æ ¼å¼ï¼Œåœ¨nginx.confä¸­log_format mainè¡Œå®šä¹‰è¿‡ access_log /var/log/nginx/docker-registry.log main; error_log /var/log/nginx/docker-registry-error.log; # è¯ä¹¦ ssl_certificate /etc/nginx/cert_files/local.com.crt; ssl_certificate_key /etc/nginx/cert_files/local.com.key; ssl_protocols TLSv1.1 TLSv1.2; ssl_ciphers '!aNULL:kECDH+AESGCM:ECDH+AESGCM:RSA+AESGCM:kECDH+AES:ECDH+AES:RSA+AES:'; ssl_prefer_server_ciphers on; ssl_session_cache shared:SSL:10m; # disable any limits to avoid HTTP 413 for large image uploads client_max_body_size 0; # required to avoid HTTP 411: see Issue #1486 (https://github.com/docker/docker/issues/1486) chunked_transfer_encoding on; # è¯·æ±‚é€»è¾‘è°ƒæ•´ # è®¾ç½®é»˜è®¤ä½¿ç”¨docker-groupèšåˆä»“åº“ï¼Œå³æ‹‰å–é•œåƒçš„æƒ…å†µå¤šäº› set $upstream \"nexus_docker_put\"; # å½“è¯·æ±‚æ˜¯GETï¼Œä¹Ÿå°±æ˜¯æ‹‰å–é•œåƒçš„æ—¶å€™ï¼Œè¿™é‡Œæ”¹ä¸ºæ‹‰å–ä»£ç†ï¼Œå¦‚æ­¤ä¾¿è§£å†³äº†æ‹‰å–å’Œæ¨é€çš„ç«¯å£ç»Ÿä¸€ if ( $request_method ~* 'GET') { set $upstream \"nexus_docker_get\"; } # æˆ‘æµ‹è¯•çš„æ—¶å€™ï¼Œdocker-hostedæœ¬åœ°ä»“åº“å’Œdocker-proxyä»£ç†ä»“åº“éƒ½æ”¯æŒæœç´¢ï¼Œæ‰€ä»¥å°†ä¸‹é¢è¿™æ®µé€»è¾‘è°ƒæ•´æ³¨é‡Šæ‰ # åªæœ‰æœ¬åœ°ä»“åº“æ‰æ”¯æŒæœç´¢ï¼Œæ‰€ä»¥å°†æœç´¢è¯·æ±‚è½¬å‘åˆ°æœ¬åœ°ä»“åº“ï¼Œå¦åˆ™å‡ºç° 500 æŠ¥é”™ # if ($request_uri ~ '/search') { # set $upstream \"nexus_docker_put\"; # } index index.html index.htm index.php; location / { proxy_pass http://$upstream; proxy_set_header Host $host; proxy_connect_timeout 3600; proxy_send_timeout 3600; proxy_read_timeout 3600; proxy_set_header X-Real-IP $remote_addr; proxy_buffering off; proxy_request_buffering off; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # ç›´æ¥ä½¿ç”¨ä»¥ä¸‹é…ç½®ã€proxy_set_header X-Forwarded-Proto http; ã€‘æ—¶ï¼Œ # åœ¨å°è¯•å‘ä»“åº“ä¸­pushæ¨é€é•œåƒæ—¶ï¼Œå°±æ˜¯docker loginç™»é™†æˆåŠŸäº†ä¹Ÿä¼šæŠ¥ä»¥ä¸‹è®¤è¯å¼‚å¸¸ # unauthorized: access to the requested resource is not authorized # proxy_set_header X-Forwarded-Proto http; # ä¿®å¤docker pushè®¤è¯å¼‚å¸¸é—®é¢˜ï¼Œå°†httpæ›¿æ¢æˆhttpså³å¯ proxy_set_header X-Forwarded-Proto https; } } é…ç½®docker registry-mirrors harbor ä¹Ÿå¯ä»¥æ­å»º registry-mirrors { \"insecure-registries\" : [\"docker.local.com\"], \"exec-opts\": [\"native.cgroupdriver=systemd\"], \"registry-mirrors\": [ \"https://docker.local.com\"], \"log-driver\": \"json-file\", \"log-opts\": { \"max-size\": \"100m\", \"max-file\": \"3\" }, \"dns\": [\"119.29.29.29\", \"223.5.5.5\"], \"data-root\": \"/var/lib/docker\" } é‡å¯dockeræœåŠ¡ï¼Œæ‹‰å–é•œåƒæµ‹è¯• è‹¥é‡åˆ°docker login denied ï¼Œåˆ™å¯ä»¥å…ˆ docker logout [root@dev ~]# docker pull build/alpine:3.20 Error response from daemon: pull a","date":"2024-06-16","objectID":"/posts/2024-06-16-nexus/:3:7","tags":["nexus","repo"],"title":"Nexus","uri":"/posts/2024-06-16-nexus/"},{"categories":["DevOps"],"content":"ä¸‰ã€æ•°æ®æ¥å…¥prometheus grafanaæ¨¡æ¿ï¼š 155563 https://grafana.com/grafana/dashboards/16459 neuxs å®˜æ–¹å‚è€ƒåœ°å€ï¼š https://help.sonatype.com/repomanager3/nexus-repository-administration/support-features#SupportFeatures-Prometheus é…ç½®æ–‡ä»¶æ¨¡æ¿ global: scrape_interval: 15s scrape_timeout: 10s evaluation_interval: 15s alerting: alertmanagers: - static_configs: - targets: [] scheme: http timeout: 10s scrape_configs: - job_name: nxrm scrape_interval: 15s scrape_timeout: 10s metrics_path: /service/metrics/prometheus scheme: http basic_auth: username: admin password: admin123 static_configs: - targets: - localhost:8081 ","date":"2024-06-16","objectID":"/posts/2024-06-16-nexus/:4:0","tags":["nexus","repo"],"title":"Nexus","uri":"/posts/2024-06-16-nexus/"},{"categories":["DevOps"],"content":"å››ã€æ•°æ®æ¸…ç† nexusçš„repoåœ¨åˆ é™¤å¤šä¸ªç›®æ ‡åï¼Œä¼šå‘ç°å®é™…ç‰©ç†ç£ç›˜å¹¶æ²¡æœ‰é‡Šæ”¾å‡ºæ¥ï¼Œæ˜¯å› ä¸ºåœ¨åå°åªæ˜¯è¢«æ ‡è®°ä¸ºdeletionï¼Œè‹¥è¦æ¸…ç†ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªtaskå»æ¸…ç†ã€‚ 1ã€åˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œä»»åŠ¡ç±»å‹ä¸ºAdmin Compact Blobstoreï¼Œç„¶åå¡«å†™å®šæ—¶ä»»åŠ¡è¯¦æƒ… 2ã€æ‰‹åŠ¨è¿è¡Œä¸€ä¸‹å®šæ—¶ä»»åŠ¡ï¼Œtaskå›æ…¢æ…¢æ¸…ç†blobçš„æ•°æ® ","date":"2024-06-16","objectID":"/posts/2024-06-16-nexus/:5:0","tags":["nexus","repo"],"title":"Nexus","uri":"/posts/2024-06-16-nexus/"},{"categories":["DevOps"],"content":"äº”ã€ä¸»ä»åŒæ­¥ å¯ä»¥ä½¿ç”¨nexus proxy repoå»å®ç°ä¸»ä»åŒæ­¥ï¼Œä¹Ÿå¯å®šæ—¶åŒæ­¥æ•°æ® #/bin/bash # sync nexus data to bak server # é™é€Ÿ 3MB/s rsync --delete -avzP --bwlimit=3000 --chown=200:200 /data/nexus/ root@172.16.80.234:/data/nexus å¤‡ nexusä¸Šçš„æ•°æ®åœ¨å¯åŠ¨æœåŠ¡çš„æ—¶å€™å¯èƒ½éœ€è¦ä¿®æ”¹ä¸€ä¸‹æ•°æ®æƒé™ï¼Œå…·ä½“æ“ä½œéœ€è¦è§‚å¯Ÿä¸€ä¸‹nexusæ—¥å¿— chartæ•°æ®åŒæ­¥ #!/usr/bin/env bash src_repo=http://nexus.local.local.cc/repository/helm src_repo_name=local dst_repo=http://nexus.local.cc/repository/helm dst_repo_name=newlocal # add repo for helm #helm repo add ${src_repo_name} ${src_repo} #helm repo add ${dst_repo_name} ${dst_repo} #helm repo update befor_time=\"20221104160208\" end_time=\"20230328093331\" user=ccccc password=dddddd project_list=$(helm search repo ${src_repo_name} | awk '{print $1}' | grep -v NAME | awk -F '/' '{print $2}') for project in ${project_list} ;do version_list=$(helm search repo ${src_repo_name}/${project} -l | awk '{print $2}') for version in ${version_list};do if [[ ${version} -gt ${befor_time} ]];then if [[ ${version} -lt ${end_time} ]];then helm fetch ${src_repo_name}/${project} --version ${version} helm nexus-push ${dst_repo_name} ${project}-${version}.tgz -u ${user} -p ${password} fi fi done done ","date":"2024-06-16","objectID":"/posts/2024-06-16-nexus/:6:0","tags":["nexus","repo"],"title":"Nexus","uri":"/posts/2024-06-16-nexus/"},{"categories":["DevOps"],"content":"å…­ã€Terraform ç›®å‰ nexus æ²¡æœ‰ api æä¾›å»é…ç½® cleanup policyï¼Œéœ€è¦é…ç½® nexus è¿è¡Œè¿è¡Œ script ï¼Œä½¿ç”¨groovyè„šæœ¬è¿›è¡Œæ·»åŠ  å¼€å¯nexus å…è®¸è¿è¡Œscript # nexus_dir/etc/nexus.properties nexus.scripts.allowCreation=true é‡å¯ nexus ","date":"2024-06-16","objectID":"/posts/2024-06-16-nexus/:7:0","tags":["nexus","repo"],"title":"Nexus","uri":"/posts/2024-06-16-nexus/"},{"categories":["ç³»ç»Ÿæˆ–è½¯ä»¶æ¢æº"],"content":"æ“ä½œç³»ç»Ÿæˆ–è€…è½¯ä»¶æ¢æºåŠ é€Ÿ ","date":"2024-06-13","objectID":"/posts/2024-06-13-mirror-cn/:0:0","tags":["mirror","source","mirror-to-cn"],"title":"To-mirror","uri":"/posts/2024-06-13-mirror-cn/"},{"categories":["ç³»ç»Ÿæˆ–è½¯ä»¶æ¢æº"],"content":"1ã€æ“ä½œç³»ç»Ÿ ","date":"2024-06-13","objectID":"/posts/2024-06-13-mirror-cn/:1:0","tags":["mirror","source","mirror-to-cn"],"title":"To-mirror","uri":"/posts/2024-06-13-mirror-cn/"},{"categories":["ç³»ç»Ÿæˆ–è½¯ä»¶æ¢æº"],"content":"rocky # 8 base sed -e 's|^mirrorlist=|#mirrorlist=|g' \\ -e 's|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.ustc.edu.cn/rocky|g' \\ -i.bak /etc/yum.repos.d/Rocky*.repo # 8 epel sed -e 's|^metalink=|#metalink=|g' \\ -e 's|^#baseurl=https\\?://download.fedoraproject.org/pub/epel/|baseurl=https://mirrors.ustc.edu.cn/epel/|g' \\ -e 's|^#baseurl=https\\?://download.example/pub/epel/|baseurl=https://mirrors.ustc.edu.cn/epel/|g' \\ -i.bak /etc/yum.repos.d/epel*.repo # 9 base sed -e 's|^mirrorlist=|#mirrorlist=|g' \\ -e 's|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.ustc.edu.cn/rocky|g' \\ -i.bak /etc/yum.repos.d/rocky*.repo # 9 epel sed -e 's|^metalink=|#metalink=|g' \\ -e 's|^#baseurl=https\\?://download.fedoraproject.org/pub/epel/|baseurl=https://mirrors.ustc.edu.cn/epel/|g' \\ -e 's|^#baseurl=https\\?://download.example/pub/epel/|baseurl=https://mirrors.ustc.edu.cn/epel/|g' \\ -i.bak /etc/yum.repos.d/epel*.repo ","date":"2024-06-13","objectID":"/posts/2024-06-13-mirror-cn/:1:1","tags":["mirror","source","mirror-to-cn"],"title":"To-mirror","uri":"/posts/2024-06-13-mirror-cn/"},{"categories":["ç³»ç»Ÿæˆ–è½¯ä»¶æ¢æº"],"content":"almalinux sed -e 's|^mirrorlist=|#mirrorlist=|g' \\ -e 's|^# baseurl=https://repo.almalinux.org|baseurl=https://mirrors.aliyun.com|g' \\ -i.bak \\ /etc/yum.repos.d/almalinux*.repo ","date":"2024-06-13","objectID":"/posts/2024-06-13-mirror-cn/:1:2","tags":["mirror","source","mirror-to-cn"],"title":"To-mirror","uri":"/posts/2024-06-13-mirror-cn/"},{"categories":["ç³»ç»Ÿæˆ–è½¯ä»¶æ¢æº"],"content":"ubuntu # http sed -e \"s@http://.*archive.ubuntu.com@http://mirrors.aliyun.com@g\" \\ -e \"s@http://.*security.ubuntu.com@http://mirrors.aliyun.com@g\" \\ -i.bak -i /etc/apt/sources.list # https sed -e \"s@http://.*archive.ubuntu.com@https://mirrors.aliyun.com@g\" \\ -e \"s@http://.*security.ubuntu.com@https://mirrors.aliyun.com@g\" \\ -i.bak -i /etc/apt/sources.list ","date":"2024-06-13","objectID":"/posts/2024-06-13-mirror-cn/:1:3","tags":["mirror","source","mirror-to-cn"],"title":"To-mirror","uri":"/posts/2024-06-13-mirror-cn/"},{"categories":["ç³»ç»Ÿæˆ–è½¯ä»¶æ¢æº"],"content":"debian # debian 12åŠä»¥ä¸Š sed -i 's/\\w*.debian.org/mirrors.ustc.edu.cn/g' /etc/apt/sources.list.d/debian.sources sed -i \"s@http://mirrors.ustc.edu.cn@https://mirrors.ustc.edu.cn@g\" /etc/apt/sources.list.d/debian.sources # debian 12ä»¥ä¸‹ sed -i 's/\\w*.debian.org/mirrors.ustc.edu.cn/g' /etc/apt/sources.list sed -i \"s@http://mirrors.ustc.edu.cn@https://mirrors.ustc.edu.cn@g\" /etc/apt/sources.list # é€šç”¨ç‰ˆ sed -i 's/\\w*.debian.org/mirrors.ustc.edu.cn/g' /etc/apt/sources.list || sed -i 's/\\w*.debian.org/mirrors.ustc.edu.cn/g' /etc/apt/sources.list.d/debian.sources ","date":"2024-06-13","objectID":"/posts/2024-06-13-mirror-cn/:1:4","tags":["mirror","source","mirror-to-cn"],"title":"To-mirror","uri":"/posts/2024-06-13-mirror-cn/"},{"categories":["ç³»ç»Ÿæˆ–è½¯ä»¶æ¢æº"],"content":"alpine # alpine å®˜æ–¹æº https://dl-cdn.alpinelinux.org/alpine/v3.18/main https://dl-cdn.alpinelinux.org/alpine/v3.18/community # ustc sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories # edge æº echo \"https://mirrors.ustc.edu.cn/alpine/edge/main\" \u003e\u003e /etc/apk/repositories echo \"https://mirrors.ustc.edu.cn/alpine/edge/community\" \u003e\u003e /etc/apk/repositories echo \"https://mirrors.ustc.edu.cn/alpine/edge/testing\" \u003e\u003e /etc/apk/repositories # alpine å®¹å™¨åŒ… apk update --no-cache \u0026\u0026 apk add --update --no-cache coreutils ca-certificates \u0026\u0026 apk add --no-cache tzdata coreutils ","date":"2024-06-13","objectID":"/posts/2024-06-13-mirror-cn/:1:5","tags":["mirror","source","mirror-to-cn"],"title":"To-mirror","uri":"/posts/2024-06-13-mirror-cn/"},{"categories":["ç³»ç»Ÿæˆ–è½¯ä»¶æ¢æº"],"content":"2ã€å¼€å‘è¯­è¨€ç±» go export GOPROXY=https://goproxy.cn,direct # aliyun export GOPROXY=https://mirrors.aliyun.com/goproxy/ python export PIP_MIRROR=mirrors.aliyun.com echo -e \"[global]\\nindex-url=https://${PIP_MIRROR}/pypi/simple\\n[install]\\ntrusted-host=${PIP_MIRROR}\" \u003e /etc/pip.conf # å‘½ä»¤é…ç½® pip3 install xxx -i https://mirrors.aliyun.com/pypi/simple/ npm # è®¾ç½®å…¨å±€ npm config set registry https://registry.npmmirror.com # cmd npm install -y --registry=https://registry.npmmirror.com # å®˜æ–¹åœ°å€ https://registry.npmjs.org/ # é˜¿é‡Œäº‘åœ°å€ https://registry.npmmirror.com # è…¾è®¯ http://mirrors.cloud.tencent.com/npm/ # åä¸º https://repo.huaweicloud.com/repository/npm/ # å—äº¬å¤§å­¦ https://repo.nju.edu.cn/repository/npm/ java curl -O https://repo1.maven.org/maven2/archetype-catalog.xml settings.xml \u003csettings xmlns=\"http://maven.apache.org/SETTINGS/1.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd\"\u003e \u003clocalRepository\u003e/home/sugar/.m2/repository\u003c/localRepository\u003e \u003cmirrors\u003e \u003cmirror\u003e \u003cid\u003ealimaven\u003c/id\u003e \u003cmirrorOf\u003ecentral\u003c/mirrorOf\u003e \u003cname\u003ealiyun maven\u003c/name\u003e \u003curl\u003ehttps://maven.aliyun.com/nexus/content/groups/public/\u003c/url\u003e \u003c/mirror\u003e \u003c/mirrors\u003e \u003cprofiles\u003e \u003cprofile\u003e \u003cid\u003earchetype-catalog\u003c/id\u003e \u003cactivation\u003e \u003cactiveByDefault\u003etrue\u003c/activeByDefault\u003e \u003c/activation\u003e \u003cproperties\u003e \u003carchetypeCatalog\u003efile:///Users/sugar/.m2/archetype-catalog.xml\u003c/archetypeCatalog\u003e \u003c/properties\u003e \u003c/profile\u003e \u003c/profiles\u003e \u003c/settings\u003e # ä¸‹è½½ä¾èµ– mvn -B -f pom.xml -s /usr/share/maven/ref/settings.xml dependency:resolve ","date":"2024-06-13","objectID":"/posts/2024-06-13-mirror-cn/:2:0","tags":["mirror","source","mirror-to-cn"],"title":"To-mirror","uri":"/posts/2024-06-13-mirror-cn/"},{"categories":["ç³»ç»Ÿæˆ–è½¯ä»¶æ¢æº"],"content":"3ã€å®¹å™¨ä»£ç† é…ç½®æ¨¡ç‰ˆ { \"insecure-registries\": [ \"repo.local.com\" ], \"exec-opts\": [ \"native.cgroupdriver=systemd\" ], \"registry-mirrors\": [ \"https://docker.mirrors.sjtug.sjtu.edu.cn\", \"https://docker.nju.edu.cn\", \"http://hub-mirror.c.163.com\" ], \"log-driver\": \"json-file\", \"log-opts\": { \"max-size\": \"100m\", \"max-file\": \"3\" }, \"bip\":\"192.161.20.1/24\", \"dns\": [ \"119.29.29.29\", \"223.5.5.5\" ], \"data-root\": \"/var/lib/docker\", \"features\": { \"buildkit\": true } } docker registry å›½å†… docker registry å·²æš‚æ—¶æ— æ³•ä½¿ç”¨ gcr.io # ä¸Šæµ·äº¤å¤§ https://gcr-io.mirrors.sjtug.sjtu.edu.cn # å—äº¬å¤§å­¦ https://gcr.nju.edu.cn # dockerproxy https://gcr.dockerproxy.com ghcr.io # å—äº¬å¤§å­¦ https://htghcr.nju.edu.cn # dockerproxy https://ghcr.dockerproxy.com nvcr.io # å—äº¬å¤§å­¦ https://nvcr.nju.edu.cn quay.io # å—äº¬å¤§å­¦ https://quay.nju.edu.cn # dockerproxy quay.dockerproxy.com registry.k8s.io # å—äº¬å¤§å­¦ k8s.mirror.nju.edu.cn # dockerproxy k8s.dockerproxy.com Microsoft Artifact Registry mcr.dockerproxy.com åŒæ­¥é•œåƒè„šæœ¬ #!/usr/bin/env bash SRC_REPO=swr.cn-east-3.myhuaweicloud.com/serialt DEST_REPO=docker.local.com/lib # è·å–é•œåƒ # docker images --format \"table {{.Repository}}:{{.Tag}}\" # registry.cn-hangzhou.aliyuncs.com/serialt/node:v3.22.5 # node:v3.22.5 imageList=( golang:1.22.4-alpine golang:1.21-alpine3.18 python:3.8-alpine python:3.9-alpine ) for imageName in ${imageList[@]} do imageName=`echo ${imageName} |awk -F '/' '{print $NF}'` docker pull ${SRC_REPO}/${imageName} docker tag ${SRC_REPO}/${imageName} ${DEST_REPO}/${imageName} docker push ${DEST_REPO}/${imageName} # docker rmi ${DEST_REPO}/${imageName} done v2ç‰ˆ #!/usr/bin/env bash imageList=( local.com/build/alpine:3=docker.local.cc/build/alpine:3 ) #!/usr/bin/env bash . images.sh for imageName in ${imageList[@]} do SRC_IMAGE=`echo ${imageName} | awk -F '=' '{print $1}' ` DST_IMAGE=`echo ${imageName} | awk -F '=' '{print $2}' ` docker pull ${SRC_IMAGE} docker tag ${SRC_IMAGE} ${DST_IMAGE} docker push ${DST_IMAGE} # docker rmi ${DEST_REPO}/${imageName} done ","date":"2024-06-13","objectID":"/posts/2024-06-13-mirror-cn/:3:0","tags":["mirror","source","mirror-to-cn"],"title":"To-mirror","uri":"/posts/2024-06-13-mirror-cn/"},{"categories":["contianerd"],"content":"containerd å‚è€ƒé“¾æ¥ï¼š https://www.aneasystone.com/archives/2023/06/containerd-notes.html https://juejin.cn/post/7312330825206693939 ","date":"2024-06-13","objectID":"/posts/2024-06-13-containerd/:1:0","tags":["contianerd"],"title":"contianerd","uri":"/posts/2024-06-13-containerd/"},{"categories":["contianerd"],"content":"containerd ä¸ Docker å’Œ Kubernetes çš„å…³ç³» ä»”ç»†è§‚å¯Ÿ containerd æ¶æ„å›¾çš„ä¸Šé¢éƒ¨åˆ†ï¼Œå¯ä»¥çœ‹å‡º containerd é€šè¿‡æä¾› gRPC API æ¥ä¾›ä¸Šå±‚åº”ç”¨è°ƒç”¨ï¼Œä¸Šå±‚åº”ç”¨å¯ä»¥ç›´æ¥é›†æˆ containerd client æ¥è®¿é—®å®ƒçš„æ¥å£ï¼Œè¯¸å¦‚ Docker Engineã€BuildKit ä»¥åŠ containerd è‡ªå¸¦çš„å‘½ä»¤è¡Œå·¥å…· ctr éƒ½æ˜¯è¿™æ ·å®ç°çš„ï¼›æ‰€ä»¥ä» Docker 1.11 å¼€å§‹ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ docker run å‘½ä»¤æ—¶ï¼Œæ•´ä¸ªæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š docker api grpc api docker ------------\u003e docker engine ----------\u003e containerd ----\u003e runc å½“å‰kubelet cri kubectl ----------\u003e containerd ----\u003e runc ","date":"2024-06-13","objectID":"/posts/2024-06-13-containerd/:2:0","tags":["contianerd"],"title":"contianerd","uri":"/posts/2024-06-13-containerd/"},{"categories":["contianerd"],"content":"é…ç½®é•œåƒ Containerd é»˜è®¤é…ç½®æ–‡ä»¶è·¯å¾„æ˜¯ /etc/containerd/config.toml Containerdé…ç½®æ–‡ä»¶è¯¦æƒ…å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œè¯·é€‰æ‹©å¯¹åº”ç‰ˆæœ¬ã€‚ https://github.com/containerd/containerd/blob/v2.0.0-rc.2/docs/cri/registry.md 1.6.24 # ä½¿ç”¨SystemdCgroup sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml # ä¿®æ”¹é…ç½®ç›®å½• sed -i 's+config_path = \"\"+config_path = \"/etc/containerd/certs.d\"+' /etc/containerd/config.toml mkdir /etc/containerd/certs.d/docker.io -pv # é…ç½®åŠ é€Ÿ sed -i 's+registry.k8s.io+registry.cn-hangzhou.aliyuncs.com/serialt+' /etc/containerd/config.toml cat \u003e /etc/containerd/certs.d/docker.io/hosts.toml \u003c\u003c EOF server = \"https://docker.io\" [host.\"https://docker.mirrors.sjtug.sjtu.edu.cn\"] capabilities = [\"pull\", \"resolve\", \"push\"] # skip_verify = true # ca = \"/path/to/ca.crt\" EOF # Config file is parsed as version 1 by default. # To use the long form of plugin names set \"version = 2\" # explicitly use v2 config format version = 2 [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors] [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"] endpoint = [\"https://registry-1.docker.io\"] [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"test.https-registry.io\"] endpoint = [\"https://HostIP1:Port1\"] [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"test.http-registry.io\"] endpoint = [\"http://HostIP2:Port2\"] # wildcard matching is supported but not required. [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"*\"] endpoint = [\"https://HostIP3:Port3\"] [plugins.\"io.containerd.grpc.v1.cri\".registry] [plugins.\"io.containerd.grpc.v1.cri\".registry.auths] [plugins.\"io.containerd.grpc.v1.cri\".registry.configs] [plugins.\"io.containerd.grpc.v1.cri\".registry.headers] [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors] #ä¸»è¦åœ¨è¿™ä¸‹é¢é…ç½®é•œåƒåŠ é€ŸæœåŠ¡ [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"] endpoint=[\"https://registry-1.docker.io\", \"https://xxx.mirror.aliyuncs.com\"] [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"registry.k8s.io\"] endpoint=[\"https://xxx.mirror.aliyuncs.com\", \"https://k8s.m.daocloud.io\", \"https://docker.mirrors.ustc.edu.cn\",\"https://hub-mirror.c.163.com\"] éªŒè¯ root@master:/etc/containerd# crictl info \"registry\": { \"configPath\": \"\", \"mirrors\": { \"docker.io\": { \"endpoint\": [ \"https://registry-1.docker.io\", \"https://45hrqeao.mirror.aliyuncs.com\" ] }, \"registry.k8s.io\": { \"endpoint\": [ \"https://45hrqeao.mirror.aliyuncs.com\", \"https://k8s.m.daocloud.io\", \"https://docker.mirrors.ustc.edu.cn\", \"https://hub-mirror.c.163.com\" ] } }, å®Œæ•´é…ç½® disabled_plugins = [] imports = [] oom_score = 0 plugin_dir = \"\" required_plugins = [] root = \"/var/lib/containerd\" state = \"/run/containerd\" temp = \"\" version = 2 [cgroup] path = \"\" [debug] address = \"\" format = \"\" gid = 0 level = \"\" uid = 0 [grpc] address = \"/run/containerd/containerd.sock\" gid = 0 max_recv_message_size = 16777216 max_send_message_size = 16777216 tcp_address = \"\" tcp_tls_ca = \"\" tcp_tls_cert = \"\" tcp_tls_key = \"\" uid = 0 [metrics] address = \"\" grpc_histogram = false [plugins] [plugins.\"io.containerd.gc.v1.scheduler\"] deletion_threshold = 0 mutation_threshold = 100 pause_threshold = 0.02 schedule_delay = \"0s\" startup_delay = \"100ms\" [plugins.\"io.containerd.grpc.v1.cri\"] device_ownership_from_security_context = false disable_apparmor = false disable_cgroup = false disable_hugetlb_controller = true disable_proc_mount = false disable_tcp_service = true enable_selinux = false enable_tls_streaming = false enable_unprivileged_icmp = false enable_unprivileged_ports = false ignore_image_defined_volumes = false max_concurrent_downloads = 3 max_container_log_line_size = 16384 netns_mounts_under_state_dir = false restrict_oom_score_adj = false sandbox_image = \"registry.aliyuncs.com/google_containers/pause:3.9\" selinux_category_range = 1024 stats_collect_period = 10 stream_idle_timeout = \"4h0m0s\" stream_server_address = \"127.0.0.1\" stream_server_port = \"0\" systemd_cgroup = false tolerate_missing_hugetlb_controller = true unset_seccomp_profile = \"\" [plugins.\"io.containerd.grpc.v1.cri\".cni] bin","date":"2024-06-13","objectID":"/posts/2024-06-13-containerd/:2:1","tags":["contianerd"],"title":"contianerd","uri":"/posts/2024-06-13-containerd/"},{"categories":["Podman"],"content":"Podman å‚è€ƒè¿æ¥ï¼šhttp://www.yunweipai.com/40798.html â€‹ Podman æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨è¿è¡Œæ—¶é¡¹ç›®ï¼Œå¯åœ¨å¤§å¤šæ•° Linux å¹³å°ä¸Šä½¿ç”¨ã€‚Podman æä¾›ä¸ Docker éå¸¸ç›¸ä¼¼çš„åŠŸèƒ½ã€‚æ­£å¦‚å‰é¢æåˆ°çš„é‚£æ ·ï¼Œå®ƒä¸éœ€è¦åœ¨ä½ çš„ç³»ç»Ÿä¸Šè¿è¡Œä»»ä½•å®ˆæŠ¤è¿›ç¨‹ï¼Œå¹¶ä¸”å®ƒä¹Ÿå¯ä»¥åœ¨æ²¡æœ‰ root æƒé™çš„æƒ…å†µä¸‹è¿è¡Œã€‚ â€‹ Podman å¯ä»¥ç®¡ç†å’Œè¿è¡Œä»»ä½•ç¬¦åˆ OCIï¼ˆOpen Container Initiativeï¼‰è§„èŒƒçš„å®¹å™¨å’Œå®¹å™¨é•œåƒã€‚Podman æä¾›äº†ä¸€ä¸ªä¸ Docker å…¼å®¹çš„å‘½ä»¤è¡Œå‰ç«¯æ¥ç®¡ç† Docker é•œåƒ podmanæ˜¯ä»€ä¹ˆ â€‹ podmanç³»åˆ—ä¸»è¦åŒ…å«ä¸‰ä¸ªå‘½ä»¤podmanã€buildahã€skopeoï¼Œå…¶ä¸­podmanæœ¬èº«è´Ÿè´£è¿è¡Œã€åœæ­¢ã€ç®¡ç†å®¹å™¨ï¼Œbuildahè´Ÿè´£æ„å»ºå®¹å™¨é•œåƒã€skopeoè´Ÿè´£ä¸remote repoäº¤äº’ï¼Œæ‹‰å–æˆ–æ¨é€é•œåƒã€‚ä½†æˆ‘ä»¬ä½¿ç”¨æ—¶ä¸å¿…è¿™ä¹ˆéº»çƒ¦ï¼Œredhatä¸ºäº†æ–¹ä¾¿ç”¨æˆ·ä»dockerè¿ç§»åˆ°podmanï¼Œåœ¨podmanä¸Šå‡ ä¹å®ç°äº†å¤§å¤šæ•°dockerçš„å¸¸ç”¨å‘½ä»¤ï¼Œpodmanä¼šæ›¿ä½ è½¬è°ƒbuildahå’Œskopeoï¼Œä½ ç”šè‡³å¯ä»¥ç›´æ¥ alias docker=podmanï¼Œç„¶ååƒä½¿ç”¨dockerä¸€æ ·ä½¿ç”¨podmanã€‚ Podman â€‹ Podmanå¯ä»¥æ›¿æ¢Dockerä¸­äº†å¤§å¤šæ•°å­å‘½ä»¤ï¼ˆRUNï¼ŒPUSHï¼ŒPULLç­‰ï¼‰ã€‚Podmanä¸éœ€è¦å®ˆæŠ¤è¿›ç¨‹ï¼Œè€Œæ˜¯ä½¿ç”¨ç”¨æˆ·å‘½åç©ºé—´æ¥æ¨¡æ‹Ÿå®¹å™¨ä¸­çš„rootï¼Œæ— éœ€è¿æ¥åˆ°å…·æœ‰rootæƒé™çš„å¥—æ¥å­—ä¿è¯å®¹å™¨çš„ä½“ç³»å®‰å…¨ã€‚Podmanä¸“æ³¨äºç»´æŠ¤å’Œä¿®æ”¹OCIé•œåƒçš„æ‰€æœ‰å‘½ä»¤å’ŒåŠŸèƒ½ï¼Œä¾‹å¦‚æ‹‰åŠ¨å’Œæ ‡è®°ã€‚å®ƒè¿˜å…è®¸æˆ‘ä»¬åˆ›å»ºï¼Œè¿è¡Œå’Œç»´æŠ¤ä»è¿™äº›å›¾åƒåˆ›å»ºçš„å®¹å™¨ã€‚ Buildah â€‹ Buildahç”¨æ¥æ„å»ºOCIå›¾åƒã€‚è™½ç„¶Podmanä¹Ÿå¯ä»¥ç”¨æˆ·æ„å»ºDockeré•œåƒï¼Œä½†æ˜¯æ„å»ºé€Ÿåº¦è¶…æ…¢ï¼Œå¹¶ä¸”é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨vfså­˜å‚¨é©±åŠ¨ç¨‹åºä¼šè€—å°½å¤§é‡ç£ç›˜ç©ºé—´ã€‚ buildah budï¼ˆä½¿ç”¨Dockerfileæ„å»ºï¼‰åˆ™ä¼šéå¸¸å¿«ï¼Œå¹¶ä½¿ç”¨è¦†ç›–å­˜å‚¨é©±åŠ¨ç¨‹åºã€‚Buildahä¸“æ³¨äºæ„å»ºOCIé•œåƒã€‚ Buildahçš„å‘½ä»¤å¤åˆ¶äº†Dockerfileä¸­çš„æ‰€æœ‰å‘½ä»¤ã€‚å¯ä»¥ä½¿ç”¨Dockerfilesæ„å»ºé•œåƒï¼Œå¹¶ä¸”ä¸éœ€è¦ä»»ä½•rootæƒé™ã€‚ Buildahçš„æœ€ç»ˆç›®æ ‡æ˜¯æä¾›æ›´ä½çº§åˆ«çš„coreutilsç•Œé¢æ¥æ„å»ºå›¾åƒã€‚Buildahä¹Ÿæ”¯æŒéDockerfilesæ„å»ºé•œåƒï¼Œå¯ä»¥å…è®¸å°†å…¶ä»–è„šæœ¬è¯­è¨€é›†æˆåˆ°æ„å»ºè¿‡ç¨‹ä¸­ã€‚ Buildahéµå¾ªä¸€ä¸ªç®€å•çš„fork-execæ¨¡å‹ï¼Œä¸ä»¥å®ˆæŠ¤è¿›ç¨‹è¿è¡Œï¼Œä½†å®ƒåŸºäºgolangä¸­çš„ç»¼åˆAPIï¼Œå¯ä»¥å­˜å‚¨åˆ°å…¶ä»–å·¥å…·ä¸­ã€‚ Skopeo â€‹ Skopeoæ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå…è®¸æˆ‘ä»¬é€šè¿‡æ¨ã€æ‹‰å’Œå¤åˆ¶é•œåƒæ¥å¤„ç†Dockerå’ŒOCé•œåƒã€‚ ","date":"2024-06-13","objectID":"/posts/2024-06-12-podman/:1:0","tags":["podman","contianerd"],"title":"Podman","uri":"/posts/2024-06-12-podman/"},{"categories":["Podman"],"content":"ä½¿ç”¨ 1ï¼‰å®‰è£… [root@dev ~]# yum -y install podman 2ã€é…ç½®é•œåƒåŠ é€Ÿ podmançš„é…ç½®æ–‡ä»¶ # é…ç½®é•œåƒåƒä»“åº“ [root@dev ~]# vim /etc/containers/registries.conf # å–æ¶ˆä»é»˜è®¤åœ°å€æœç´¢çš„ä»“åº“åŸŸå #unqualified-search-registries = [\"registry.fedoraproject.org\", \"registry.access.redhat.com\", \"docker.io\", \"quay.io\"] unqualified-search-registries = [\"docker.io\"] # è‡ªå®šä¹‰æœç´¢å™¨ [[registry]] # ä»“åº“å‰ç¼€ prefix = \"docker.io\" # åŠ é€Ÿå™¨åœ°å€ location = \"hub.local.com\" # é•œåƒåˆ«å [root@localhost containers]# ls registries.conf.d/ 000-shortnames.conf 001-rhel-shortnames.conf 002-rhel-shortnames-overrides.conf # é…ç½®é•œåƒä»“åº“å’Œè¿è¡Œæ—¶ç›®å½• [root@localhost containers]# vim storage.conf [storage] # Default Storage Driver, Must be set for proper operation. driver = \"overlay\" # root ç”¨æˆ·è¿è¡Œæ—¶ç›®å½• # Temporary storage location runroot = \"/run/containers/storage\" # Primary Read/Write location of container storage # When changing the graphroot location on an SELINUX system, you must # ensure the labeling matches the default locations labels with the # following commands: # semanage fcontext -a -e /var/lib/containers/storage /NEWSTORAGEPATH # restorecon -R -v /NEWSTORAGEPATH # root ç”¨æˆ·é•œåƒä»“åº“ç›®å½• graphroot = \"/var/lib/containers/storage\" # Storage path for rootless users # # rootless_storage_path = \"$HOME/.local/share/containers/storage\" linux é…ç½®å…¨å±€ [root@localhost ~]# cat /etc/containers/registries.conf.d/sugar.conf [[registry]] location = \"quay.io\" [[registry.mirror]] location = \"quay.nju.edu.cn\" [[registry]] location = \"gcr.io\" [[registry.mirror]] location = \"gcr.nju.edu.cn\" [[registry]] location = \"ghcr.io\" [[registry.mirror]] location = \"ghcr.nju.edu.cn\" [[registry]] location = \"registry.k8s.io\" [[registry.mirror]] location = \"k8s.nju.edu.cn\" [[registry]] location = \"registry.gitlab.com\" [[registry.mirror]] location = \"glcr.nju.edu.cn\" [[registry]] location = \"docker.io\" [[registry.mirror]] location = \"m.daocloud.io/docker.io\" # mac,linux é…ç½®é•œåƒä»“åº“ cat ~/.config/containers/registries.conf unqualified-search-registries = [\"docker.io\"] short-name-mode = \"enforcing\" [[registry]] location = \"quay.io\" [[registry.mirror]] location = \"quay.nju.edu.cn\" [[registry]] location = \"gcr.io\" [[registry.mirror]] location = \"gcr.nju.edu.cn\" [[registry]] location = \"ghcr.io\" [[registry.mirror]] location = \"ghcr.nju.edu.cn\" [[registry]] location = \"registry.k8s.io\" [[registry.mirror]] location = \"k8s.nju.edu.cn\" [[registry]] location = \"registry.gitlab.com\" [[registry.mirror]] location = \"glcr.nju.edu.cn\" [[registry]] location = \"docker.io\" [[registry.mirror]] location = \"m.daocloud.io/docker.io\" podman desktop mac é…ç½® https://desktop.podman.org.cn/docs/containers/registries 3ã€podmanå¸¸ç”¨å‘½ä»¤ å®¹å™¨ podman run #åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨ podman start #å¯åŠ¨å®¹å™¨ podman ps #æŸ¥çœ‹å®¹å™¨ podman stop #ç»ˆæ­¢å®¹å™¨ podman restart #é‡å¯å®¹å™¨ podman attach #è¿›å…¥å®¹å™¨ podman exec #è¿›å…¥å®¹å™¨ podman export #å¯¼å‡ºå®¹å™¨ podman import #å¯¼å…¥å®¹å™¨å¿«ç…§ podman rm #åˆ é™¤å®¹å™¨ podman logs #æŸ¥çœ‹æ—¥å¿— é•œåƒ podman search #æ£€ç´¢é•œåƒ docke pull #è·å–é•œåƒ podman images #åˆ—å‡ºé•œåƒ podman image Is #åˆ—å‡ºé•œåƒ podman rmi #åˆ é™¤é•œåƒ podman image rm #åˆ é™¤é•œåƒ podman save #å¯¼å‡ºé•œåƒ podman load #å¯¼å…¥é•œåƒ podmanfile #å®šåˆ¶é•œåƒï¼ˆä¸‰ä¸ªï¼‰ podman build #æ„å»ºé•œåƒ podman run #è¿è¡Œé•œåƒ podmanfile #å¸¸ç”¨æŒ‡ä»¤ï¼ˆå››ä¸ªï¼‰ COPY #å¤åˆ¶æ–‡ä»¶ ADD #é«˜çº§å¤åˆ¶ CMD #å®¹å™¨å¯åŠ¨å‘½ä»¤ ENV #ç¯å¢ƒå˜é‡ EXPOSE #æš´éœ²ç«¯å£ 4ã€ä½¿ç”¨podman ä½¿ç”¨ Podman éå¸¸çš„ç®€å•ï¼ŒPodman çš„æŒ‡ä»¤è·Ÿ Docker å¤§å¤šæ•°éƒ½æ˜¯ç›¸åŒçš„ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªå¸¸ç”¨çš„ä¾‹å­ï¼š [root@localhost ~]# podman run -d --name httpd docker.io/library/httpd Trying to pull docker.io/library/httpd... Getting image source signatures Copying blob e5ae68f74026 done Copying blob d3576f2b6317 done Copying blob bc36ee1127ec done Copying blob f1aa5f54b226 done Copying blob aa379c0cedc2 done Copying config ea28e1b82f done Writing manifest to image destination Storing signatures 0492e405b9ecb05e6e6be1fec0ac1a8b6ba3ff949df259b45146037b5f355035 //æŸ¥çœ‹é•œåƒ [root@localhost ~]# podman images REPOSITORY TAG IMAGE ID CREATED SIZE docker.io/library/httpd latest ea28e1b82f31 11 days ago 148 MB [root@localhost ~]# podman ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 0492e405b9ec docker.io/library/httpd:latest httpd-foreground About a minute ago Up About a minute ago httpd æŸ¥çœ‹å®¹å™¨é‡Œçš„è¿›ç¨‹ [root@localhost ~]# podman top httpd USE","date":"2024-06-13","objectID":"/posts/2024-06-12-podman/:1:1","tags":["podman","contianerd"],"title":"Podman","uri":"/posts/2024-06-12-podman/"},{"categories":["Docker é•œåƒæ„å»ºä¼˜åŒ–"],"content":"Docker é•œåƒä½“ç§¯ä¼˜åŒ– å‚è€ƒé“¾æ¥ï¼š https://icloudnative.io/posts/docker-images-part1-reducing-image-size/ ","date":"2024-06-13","objectID":"/posts/2024-06-12-docker-image/:1:0","tags":["Docker","Dockerfile"],"title":"Docker é•œåƒæ„å»ºä¼˜åŒ–","uri":"/posts/2024-06-12-docker-image/"},{"categories":["Docker é•œåƒæ„å»ºä¼˜åŒ–"],"content":"1ã€é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ å¸¸ç”¨çš„é•œåƒæœ‰alpineï¼Œdebian-slim ä»–ä»¬çš„ä½“ç§¯éƒ½æ¯” æ ‡å‡†debianã€ubuntu å’Œ rhel ç³»åˆ—çš„åŸºç¡€é•œåƒå°å¾ˆå¤šã€‚ ","date":"2024-06-13","objectID":"/posts/2024-06-12-docker-image/:1:1","tags":["Docker","Dockerfile"],"title":"Docker é•œåƒæ„å»ºä¼˜åŒ–","uri":"/posts/2024-06-12-docker-image/"},{"categories":["Docker é•œåƒæ„å»ºä¼˜åŒ–"],"content":"2ã€å¤šé˜¶æ®µæ„å»º è¦æƒ³å¤§å¹…åº¦å‡å°‘é•œåƒçš„ä½“ç§¯ï¼Œå¤šé˜¶æ®µæ„å»ºæ˜¯å¿…ä¸å¯å°‘çš„ã€‚å¤šé˜¶æ®µæ„å»ºçš„æƒ³æ³•å¾ˆç®€å•ï¼šâ€œæˆ‘ä¸æƒ³åœ¨æœ€ç»ˆçš„é•œåƒä¸­åŒ…å«ä¸€å † C æˆ– Go ç¼–è¯‘å™¨å’Œæ•´ä¸ªç¼–è¯‘å·¥å…·é“¾ï¼Œæˆ‘åªè¦ä¸€ä¸ªç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼â€ å¤šé˜¶æ®µæ„å»ºå¯ä»¥ç”±å¤šä¸ª FROM æŒ‡ä»¤è¯†åˆ«ï¼Œæ¯ä¸€ä¸ª FROM è¯­å¥è¡¨ç¤ºä¸€ä¸ªæ–°çš„æ„å»ºé˜¶æ®µï¼Œé˜¶æ®µåç§°å¯ä»¥ç”¨ AS å‚æ•°æŒ‡å®šï¼Œä¾‹å¦‚ï¼š FROM gcc AS mybuildstage COPY hello.c . RUN gcc -o hello hello.c FROM ubuntu COPY --from=mybuildstage /src/hello . CMD [\"./hello\"] ","date":"2024-06-13","objectID":"/posts/2024-06-12-docker-image/:1:2","tags":["Docker","Dockerfile"],"title":"Docker é•œåƒæ„å»ºä¼˜åŒ–","uri":"/posts/2024-06-12-docker-image/"},{"categories":["Docker é•œåƒæ„å»ºä¼˜åŒ–"],"content":"3ã€å¯¹ä¸åŒè¯­è¨€è¿›è¡Œç›¸åº”ä¼˜åŒ– Go FROM golang:alpine COPY hello.go . RUN go build hello.go FROM alpine COPY --from=0 /go/hello . CMD [\"./hello\"] Java Java å±äºç¼–è¯‘å‹è¯­è¨€ï¼Œä½†è¿è¡Œæ—¶è¿˜æ˜¯è¦è·‘åœ¨ JVM ä¸­ï¼Œè¿™å°±æ„å‘³ç€ç†è®ºä¸Šå¯ä»¥ä½¿ç”¨ä»»æ„çš„ JVM æ¥è¿è¡Œ Java ç¨‹åºï¼Œç³»ç»Ÿæ ‡å‡†åº“æ˜¯ musl libc è¿˜æ˜¯ glibc éƒ½æ— æ‰€è°“ã€‚å› æ­¤ï¼Œä¹Ÿå°±å¯ä»¥ä½¿ç”¨ä»»æ„å¸¦æœ‰ JVM çš„åŸºç¡€é•œåƒæ¥æ„å»º Java ç¨‹åºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä»»æ„å¸¦æœ‰ JVM çš„é•œåƒä½œä¸ºè¿è¡Œ Java ç¨‹åºçš„åŸºç¡€é•œåƒ è§£é‡Šå‹è¯­è¨€ Python å¯¹äºè§£é‡Šå‹è¯­è¨€æ¥è¯´ï¼Œå¦‚æœç¨‹åºä»…ç”¨åˆ°äº†æ ‡å‡†åº“æˆ–è€…ä¾èµ–é¡¹å’Œç¨‹åºæœ¬èº«ä½¿ç”¨çš„æ˜¯åŒä¸€ç§è¯­è¨€ï¼Œä¸”æ— éœ€è°ƒç”¨ C åº“å’Œå¤–éƒ¨ä¾èµ–ï¼Œé‚£ä¹ˆä½¿ç”¨ Alpine ä½œä¸ºåŸºç¡€é•œåƒä¸€èˆ¬æ˜¯æ²¡æœ‰å•¥é—®é¢˜çš„ã€‚ä¸€æ—¦ä½ çš„ç¨‹åºéœ€è¦è°ƒç”¨å¤–éƒ¨ä¾èµ–ï¼Œæƒ…å†µå°±å¤æ‚äº†ï¼Œæƒ³ç»§ç»­ä½¿ç”¨ Alpine é•œåƒï¼Œå°±å¾—å®‰è£…è¿™äº›ä¾èµ–ã€‚æˆ–è€…æ¢æˆslimé•œåƒï¼Œslim é•œåƒä¸€èˆ¬éƒ½åŸºäº Debian å’Œ glibcï¼Œåˆ é™¤äº†è®¸å¤šéå¿…éœ€çš„è½¯ä»¶åŒ…ï¼Œä¼˜åŒ–äº†ä½“ç§¯ã€‚å¦‚æœæ„å»ºè¿‡ç¨‹ä¸­éœ€è¦ç¼–è¯‘å™¨ï¼Œé‚£ä¹ˆ slim é•œåƒä¸é€‚åˆï¼Œé™¤æ­¤ä¹‹å¤–å¤§å¤šæ•°æƒ…å†µä¸‹è¿˜æ˜¯å¯ä»¥ä½¿ç”¨ slim ä½œä¸ºåŸºç¡€é•œåƒçš„ã€‚ ","date":"2024-06-13","objectID":"/posts/2024-06-12-docker-image/:1:3","tags":["Docker","Dockerfile"],"title":"Docker é•œåƒæ„å»ºä¼˜åŒ–","uri":"/posts/2024-06-12-docker-image/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go timeåŒ… å‚è€ƒé“¾æ¥ï¼šhttps://www.liwenzhou.com/posts/Go/go_time/ æ—¶é—´å’Œæ—¥æœŸæ˜¯æˆ‘ä»¬ç¼–ç¨‹ä¸­ç»å¸¸ä¼šç”¨åˆ°çš„ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»äº†Goè¯­è¨€å†…ç½®çš„timeåŒ…çš„åŸºæœ¬ç”¨æ³•ã€‚ ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-time/:1:0","tags":["Go","time"],"title":"Go time","uri":"/posts/2024-06-02-go-time/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"timeåŒ… timeåŒ…æä¾›äº†æ—¶é—´çš„æ˜¾ç¤ºå’Œæµ‹é‡ç”¨çš„å‡½æ•°ã€‚æ—¥å†çš„è®¡ç®—é‡‡ç”¨çš„æ˜¯å…¬å†ã€‚ ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-time/:1:1","tags":["Go","time"],"title":"Go time","uri":"/posts/2024-06-02-go-time/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æ—¶é—´æ ¼å¼ const ( ANSIC = \"Mon Jan _2 15:04:05 2006\" UnixDate = \"Mon Jan _2 15:04:05 MST 2006\" RubyDate = \"Mon Jan 02 15:04:05 -0700 2006\" RFC822 = \"02 Jan 06 15:04 MST\" RFC822Z = \"02 Jan 06 15:04 -0700\" // RFC822 with numeric zone RFC850 = \"Monday, 02-Jan-06 15:04:05 MST\" RFC1123 = \"Mon, 02 Jan 2006 15:04:05 MST\" RFC1123Z = \"Mon, 02 Jan 2006 15:04:05 -0700\" // RFC1123 with numeric zone RFC3339 = \"2006-01-02T15:04:05Z07:00\" RFC3339Nano = \"2006-01-02T15:04:05.999999999Z07:00\" Kitchen = \"3:04PM\" // Handy time stamps. Stamp = \"Jan _2 15:04:05\" StampMilli = \"Jan _2 15:04:05.000\" StampMicro = \"Jan _2 15:04:05.000000\" StampNano = \"Jan _2 15:04:05.000000000\" ) ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-time/:1:2","tags":["Go","time"],"title":"Go time","uri":"/posts/2024-06-02-go-time/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æ—¶é—´ç±»å‹ time.Timeç±»å‹è¡¨ç¤ºæ—¶é—´ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡time.Now()å‡½æ•°è·å–å½“å‰çš„æ—¶é—´å¯¹è±¡ï¼Œç„¶åè·å–æ—¶é—´å¯¹è±¡çš„å¹´æœˆæ—¥æ—¶åˆ†ç§’ç­‰ä¿¡æ¯ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š func timeDemo() { now := time.Now() //è·å–å½“å‰æ—¶é—´ fmt.Printf(\"current time:%v\\n\", now) year := now.Year() //å¹´ month := now.Month() //æœˆ day := now.Day() //æ—¥ hour := now.Hour() //å°æ—¶ minute := now.Minute() //åˆ†é’Ÿ second := now.Second() //ç§’ fmt.Printf(\"%d-%02d-%02d %02d:%02d:%02d\\n\", year, month, day, hour, minute, second) } ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-time/:1:3","tags":["Go","time"],"title":"Go time","uri":"/posts/2024-06-02-go-time/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æ—¶é—´æˆ³ æ—¶é—´æˆ³æ˜¯è‡ª1970å¹´1æœˆ1æ—¥ï¼ˆ08:00:00GMTï¼‰è‡³å½“å‰æ—¶é—´çš„æ€»æ¯«ç§’æ•°ã€‚å®ƒä¹Ÿè¢«ç§°ä¸ºUnixæ—¶é—´æˆ³ï¼ˆUnixTimestampï¼‰ã€‚ åŸºäºæ—¶é—´å¯¹è±¡è·å–æ—¶é—´æˆ³çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š func timestampDemo() { now := time.Now() //è·å–å½“å‰æ—¶é—´ timestamp1 := now.Unix() //æ—¶é—´æˆ³ timestamp2 := now.UnixNano() //çº³ç§’æ—¶é—´æˆ³ fmt.Printf(\"current timestamp1:%v\\n\", timestamp1) fmt.Printf(\"current timestamp2:%v\\n\", timestamp2) } ä½¿ç”¨time.Unix()å‡½æ•°å¯ä»¥å°†æ—¶é—´æˆ³è½¬ä¸ºæ—¶é—´æ ¼å¼ã€‚ func timestampDemo2(timestamp int64) { timeObj := time.Unix(timestamp, 0) //å°†æ—¶é—´æˆ³è½¬ä¸ºæ—¶é—´æ ¼å¼ fmt.Println(timeObj) year := timeObj.Year() //å¹´ month := timeObj.Month() //æœˆ day := timeObj.Day() //æ—¥ hour := timeObj.Hour() //å°æ—¶ minute := timeObj.Minute() //åˆ†é’Ÿ second := timeObj.Second() //ç§’ fmt.Printf(\"%d-%02d-%02d %02d:%02d:%02d\\n\", year, month, day, hour, minute, second) } ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-time/:1:4","tags":["Go","time"],"title":"Go time","uri":"/posts/2024-06-02-go-time/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æ—¶é—´é—´éš” time.Durationæ˜¯timeåŒ…å®šä¹‰çš„ä¸€ä¸ªç±»å‹ï¼Œå®ƒä»£è¡¨ä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹é—´ç»è¿‡çš„æ—¶é—´ï¼Œä»¥çº³ç§’ä¸ºå•ä½ã€‚time.Durationè¡¨ç¤ºä¸€æ®µæ—¶é—´é—´éš”ï¼Œå¯è¡¨ç¤ºçš„æœ€é•¿æ—¶é—´æ®µå¤§çº¦290å¹´ã€‚ timeåŒ…ä¸­å®šä¹‰çš„æ—¶é—´é—´éš”ç±»å‹çš„å¸¸é‡å¦‚ä¸‹ï¼š const ( Nanosecond Duration = 1 Microsecond = 1000 * Nanosecond Millisecond = 1000 * Microsecond Second = 1000 * Millisecond Minute = 60 * Second Hour = 60 * Minute ) ä¾‹å¦‚ï¼štime.Durationè¡¨ç¤º1çº³ç§’ï¼Œtime.Secondè¡¨ç¤º1ç§’ã€‚ ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-time/:1:5","tags":["Go","time"],"title":"Go time","uri":"/posts/2024-06-02-go-time/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æ—¶é—´æ“ä½œ Add æˆ‘ä»¬åœ¨æ—¥å¸¸çš„ç¼–ç è¿‡ç¨‹ä¸­å¯èƒ½ä¼šé‡åˆ°è¦æ±‚æ—¶é—´+æ—¶é—´é—´éš”çš„éœ€æ±‚ï¼ŒGoè¯­è¨€çš„æ—¶é—´å¯¹è±¡æœ‰æä¾›Addæ–¹æ³•å¦‚ä¸‹ï¼š func (t Time) Add(d Duration) Time ä¸¾ä¸ªä¾‹å­ï¼Œæ±‚ä¸€ä¸ªå°æ—¶ä¹‹åçš„æ—¶é—´ï¼š func main() { now := time.Now() later := now.Add(time.Hour) // å½“å‰æ—¶é—´åŠ 1å°æ—¶åçš„æ—¶é—´ fmt.Println(later) } Sub æ±‚ä¸¤ä¸ªæ—¶é—´ä¹‹é—´çš„å·®å€¼ï¼š func (t Time) Sub(u Time) Duration è¿”å›ä¸€ä¸ªæ—¶é—´æ®µt-uã€‚å¦‚æœç»“æœè¶…å‡ºäº†Durationå¯ä»¥è¡¨ç¤ºçš„æœ€å¤§å€¼/æœ€å°å€¼ï¼Œå°†è¿”å›æœ€å¤§å€¼/æœ€å°å€¼ã€‚è¦è·å–æ—¶é—´ç‚¹t-dï¼ˆdä¸ºDurationï¼‰ï¼Œå¯ä»¥ä½¿ç”¨t.Add(-d)ã€‚ Equal func (t Time) Equal(u Time) bool åˆ¤æ–­ä¸¤ä¸ªæ—¶é—´æ˜¯å¦ç›¸åŒï¼Œä¼šè€ƒè™‘æ—¶åŒºçš„å½±å“ï¼Œå› æ­¤ä¸åŒæ—¶åŒºæ ‡å‡†çš„æ—¶é—´ä¹Ÿå¯ä»¥æ­£ç¡®æ¯”è¾ƒã€‚æœ¬æ–¹æ³•å’Œç”¨t==uä¸åŒï¼Œè¿™ç§æ–¹æ³•è¿˜ä¼šæ¯”è¾ƒåœ°ç‚¹å’Œæ—¶åŒºä¿¡æ¯ã€‚ Before func (t Time) Before(u Time) bool å¦‚æœtä»£è¡¨çš„æ—¶é—´ç‚¹åœ¨uä¹‹å‰ï¼Œè¿”å›çœŸï¼›å¦åˆ™è¿”å›å‡ã€‚ After func (t Time) After(u Time) bool å¦‚æœtä»£è¡¨çš„æ—¶é—´ç‚¹åœ¨uä¹‹åï¼Œè¿”å›çœŸï¼›å¦åˆ™è¿”å›å‡ã€‚ ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-time/:1:6","tags":["Go","time"],"title":"Go time","uri":"/posts/2024-06-02-go-time/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å®šæ—¶å™¨ ä½¿ç”¨time.Tick(æ—¶é—´é—´éš”)æ¥è®¾ç½®å®šæ—¶å™¨ï¼Œå®šæ—¶å™¨çš„æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé€šé“ï¼ˆchannelï¼‰ã€‚ func tickDemo() { ticker := time.Tick(time.Second) //å®šä¹‰ä¸€ä¸ª1ç§’é—´éš”çš„å®šæ—¶å™¨ for i := range ticker { fmt.Println(i)//æ¯ç§’éƒ½ä¼šæ‰§è¡Œçš„ä»»åŠ¡ } } ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-time/:1:7","tags":["Go","time"],"title":"Go time","uri":"/posts/2024-06-02-go-time/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æ—¶é—´æ ¼å¼åŒ– æ—¶é—´ç±»å‹æœ‰ä¸€ä¸ªè‡ªå¸¦çš„æ–¹æ³•Formatè¿›è¡Œæ ¼å¼åŒ–ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯Goè¯­è¨€ä¸­æ ¼å¼åŒ–æ—¶é—´æ¨¡æ¿ä¸æ˜¯å¸¸è§çš„Y-m-d H:M:Sè€Œæ˜¯ä½¿ç”¨Goçš„è¯ç”Ÿæ—¶é—´2006å¹´1æœˆ2å·15ç‚¹04åˆ†ï¼ˆè®°å¿†å£è¯€ä¸º2006 1 2 3 4ï¼‰ã€‚ä¹Ÿè®¸è¿™å°±æ˜¯æŠ€æœ¯äººå‘˜çš„æµªæ¼«å§ã€‚ è¡¥å……ï¼šå¦‚æœæƒ³æ ¼å¼åŒ–ä¸º12å°æ—¶æ–¹å¼ï¼Œéœ€æŒ‡å®šPMã€‚ func formatDemo() { now := time.Now() // æ ¼å¼åŒ–çš„æ¨¡æ¿ä¸ºGoçš„å‡ºç”Ÿæ—¶é—´2006å¹´1æœˆ2å·15ç‚¹04åˆ† Mon Jan // 24å°æ—¶åˆ¶ fmt.Println(now.Format(\"2006-01-02 15:04:05.000 Mon Jan\")) // 12å°æ—¶åˆ¶ fmt.Println(now.Format(\"2006-01-02 03:04:05.000 PM Mon Jan\")) fmt.Println(now.Format(\"2006/01/02 15:04\")) fmt.Println(now.Format(\"15:04 2006/01/02\")) fmt.Println(now.Format(\"2006/01/02\")) } è§£æå­—ç¬¦ä¸²æ ¼å¼çš„æ—¶é—´ now := time.Now() fmt.Println(now) // åŠ è½½æ—¶åŒº loc, err := time.LoadLocation(\"Asia/Shanghai\") if err != nil { fmt.Println(err) return } // æŒ‰ç…§æŒ‡å®šæ—¶åŒºå’ŒæŒ‡å®šæ ¼å¼è§£æå­—ç¬¦ä¸²æ—¶é—´ timeObj, err := time.ParseInLocation(\"2006/01/02 15:04:05\", \"2019/08/04 14:15:20\", loc) if err != nil { fmt.Println(err) return } fmt.Println(timeObj) fmt.Println(timeObj.Sub(now)) ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-time/:1:8","tags":["Go","time"],"title":"Go time","uri":"/posts/2024-06-02-go-time/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go Storm stormæ˜¯ä¸€ä¸ªä½¿ç”¨BoltDBçš„ä¸Šå±‚ormæ¡†æ¶ https://juejin.cn/post/7031361355856740389 æ•°æ®æŸ¥çœ‹å·¥å…·: https://github.com/br0xen/boltbrowser é©±åŠ¨: https://github.com/asdine/storm ä¸‹è½½boltbrowser go install github.com/br0xen/boltbrowser@latest ä½¿ç”¨lib go get github.com/asdine/storm ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-storm/:1:0","tags":["Go","storm","boltdb"],"title":"Go storm","uri":"/posts/2024-06-02-go-storm/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"ä¸€ã€åŸºæœ¬ä½¿ç”¨ åˆå§‹åŒ– db, err := storm.Open(\"my.db\") defer db.Close() å¯¹è±¡æ¨¡å‹ type User struct { ID int // primary key Group string `storm:\"index\"` // this field will be indexed Email string `storm:\"unique\"` // this field will be indexed with a unique constraint Name string // this field will not be indexed Age int `storm:\"index\"` } å¯¹è±¡æ¨¡å‹storm tagæ•´ç† å¯ä»¥ç¬¦åˆä½¿ç”¨, å„ä¸ªå€¼ç”¨ , (é€—å·) åˆ†å‰² storm:\"index\" æ·»åŠ ç´¢å¼• storm:\"id\" ä¸»é”®æ ‡è¯† storm:\"increment\" è‡ªå¢å­—æ®µ storm:\"increment=20\" è‡ªå¢å­—æ®µ, ä»20å¼€å§‹è‡ªå¢ storm:\"unique\" ä¸èƒ½é‡å¤ storm:\"inline\" å†…è”æ ‡è®°åµŒå¥— storm:\"__storm_index_\" ??? ä¿å­˜æ•°æ® user := User{ ID: 10, Group: \"staff\", Email: \"john@provider.com\", Name: \"John\", Age: 21, CreatedAt: time.Now(), } err := db.Save(\u0026user) // err == nil user.ID++ err = db.Save(\u0026user) // err == storm.ErrAlreadyExists ä¿®æ”¹ // Update multiple fields err := db.Update(\u0026User{ID: 10, Name: \"Jack\", Age: 45}) // Update a single field err := db.UpdateField(\u0026User{ID: 10}, \"Age\", 0) åˆ é™¤æ•°æ® err := db.DeleteStruct(\u0026user) è¡¨ç®¡ç†æ“ä½œ åˆå§‹åŒ–ç´¢å¼• err := db.Init(\u0026User{}) é‡å»ºç´¢å¼•: err := db.ReIndex(\u0026User{}) åˆ è¡¨: err := db.Drop(\u0026User) æˆ– err := db.Drop(\"User\") ç®€å•æŸ¥è¯¢ var user User err := db.One(\"Email\", \"john@provider.com\", \u0026user) // err == nil err = db.One(\"Name\", \"John\", \u0026user) // err == nil err = db.One(\"Name\", \"Jack\", \u0026user) // err == storm.ErrNotFound // Fetch multiple objects var users []User err := db.Find(\"Group\", \"staff\", \u0026users) // Fetch all objects var users []User err := db.All(\u0026users) // Fetch all objects sorted by index var users []User err := db.AllByIndex(\"CreatedAt\", \u0026users) // Fetch a range of objects var users []User err := db.Range(\"Age\", 10, 21, \u0026users) // Fetch objects by prefix var users []User err := db.Prefix(\"Name\", \"Jo\", \u0026users) // Skip, Limit and Reverse var users []User err := db.Find(\"Group\", \"staff\", \u0026users, storm.Skip(10)) err = db.Find(\"Group\", \"staff\", \u0026users, storm.Limit(10)) err = db.Find(\"Group\", \"staff\", \u0026users, storm.Reverse()) err = db.Find(\"Group\", \"staff\", \u0026users, storm.Limit(10), storm.Skip(10), storm.Reverse()) err = db.All(\u0026users, storm.Limit(10), storm.Skip(10), storm.Reverse()) err = db.AllByIndex(\"CreatedAt\", \u0026users, storm.Limit(10), storm.Skip(10), storm.Reverse()) err = db.Range(\"Age\", 10, 21, \u0026users, storm.Limit(10), storm.Skip(10), storm.Reverse()) é«˜çº§æŸ¥è¯¢ import ( \"github.com/asdine/storm/q\" ) ... // Equality q.Eq(\"Name\", John) // Strictly greater than q.Gt(\"Age\", 7) // Lesser than or equal to q.Lte(\"Age\", 77) // Regex with name that starts with the letter D q.Re(\"Name\", \"^D\") // In the given slice of values q.In(\"Group\", []string{\"Staff\", \"Admin\"}) // Comparing fields q.EqF(\"FieldName\", \"SecondFieldName\") q.LtF(\"FieldName\", \"SecondFieldName\") q.GtF(\"FieldName\", \"SecondFieldName\") q.LteF(\"FieldName\", \"SecondFieldName\") q.GteF(\"FieldName\", \"SecondFieldName\") // Match if all match q.And( q.Gt(\"Age\", 7), q.Re(\"Name\", \"^D\") ) // Matchers can also be combined with And, Or and Not: // Match if one matches q.Or( q.Re(\"Name\", \"^A\"), q.Not( q.Re(\"Name\", \"^B\") ), q.Re(\"Name\", \"^C\"), q.In(\"Group\", []string{\"Staff\", \"Admin\"}), q.And( q.StrictEq(\"Password\", []byte(password)), q.Eq(\"Registered\", true) ) ) query := db.Select(q.Gte(\"Age\", 7), q.Lte(\"Age\", 77)) // Calls can also be chained query = query.Limit(10).Skip(20).OrderBy(\"Age\").Reverse() // But also to specify how to fetch them. var users []User err = query.Find(\u0026users) var user User err = query.First(\u0026user) // demo // Examples with Select: / Find all users with an ID between 10 and 100 err = db.Select(q.Gte(\"ID\", 10), q.Lte(\"ID\", 100)).Find(\u0026users) // Nested matchers err = db.Select(q.Or( q.Gt(\"ID\", 50), q.Lt(\"Age\", 21), q.And( q.Eq(\"Group\", \"admin\"), q.Gte(\"Age\", 21), ), )).Find(\u0026users) query := db.Select(q.Gte(\"ID\", 10), q.Lte(\"ID\", 100)).Limit(10).Skip(5).Reverse().OrderBy(\"Age\", \"Name\") // Find multiple records err = query.Find(\u0026users) // or err = db.Select(q.Gte(\"ID\", 10), q.Lte(\"ID\", 100)).Limit(10).Skip(5).Reverse().OrderBy(\"Age\", \"Name\").Find(\u0026users) // Find first record err = query.First(\u0026user) // or err = db.Select(q.Gte(\"ID\", 10), q.Lte(\"ID\", 100)).L","date":"2024-06-02","objectID":"/posts/2024-06-02-go-storm/:1:1","tags":["Go","storm","boltdb"],"title":"Go storm","uri":"/posts/2024-06-02-go-storm/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"slog ç»“æ„åŒ–æ—¥å¿— å‚è€ƒé“¾æ¥ï¼šhttps://betterstack.com/community/guides/logging/logging-in-go/#customizing-the-default-logger ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-slog/:1:0","tags":["Go","slog"],"title":"Go slog","uri":"/posts/2024-06-02-go-slog/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"1ã€ä¸‹è½½ go get golang.org/x/exp/slog@latest ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-slog/:1:1","tags":["Go","slog"],"title":"Go slog","uri":"/posts/2024-06-02-go-slog/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"2ã€ä½¿ç”¨ 1ï¼‰ç®€å•å®ç”¨ package main import ( \"errors\" \"golang.org/x/exp/slog\" ) func main() { slog.Debug(\"Debug message\") slog.Info(\"Info message\") slog.Warn(\"Warning message\") slog.Error(\"Error message\") } output 2023/03/15 12:55:56 INFO Info message 2023/03/15 12:55:56 WARN Warning message 2023/03/15 12:55:56 ERROR Error message 2ï¼‰jsonæ ¼å¼è¾“å‡º package main import ( \"errors\" \"os\" \"golang.org/x/exp/slog\" ) func main() { logger := slog.New(slog.NewJSONHandler(os.Stdout)) logger.Debug(\"Debug message\") logger.Info(\"Info message\") logger.Warn(\"Warning message\") logger.Error(\"Error message\") } output {\"time\":\"2023-03-15T12:59:22.227408691+01:00\",\"level\":\"INFO\",\"msg\":\"Info message\"} {\"time\":\"2023-03-15T12:59:22.227468972+01:00\",\"level\":\"WARN\",\"msg\":\"Warning message\"} {\"time\":\"2023-03-15T12:59:22.227472149+01:00\",\"level\":\"ERROR\",\"msg\":\"Error message\",\"!BADKEY\":\"an error\"} 3ï¼‰è‡ªå·±å®šä¹‰ package sugar import ( \"os\" \"path/filepath\" \"golang.org/x/exp/slog\" ) type Log struct { Level string // æ—¥å¿—çº§åˆ« string // æ—¥å¿—æ–‡ä»¶å­˜æ”¾è·¯å¾„,å¦‚æœä¸ºç©ºï¼Œåˆ™è¾“å‡ºåˆ°æ§åˆ¶å° Type string // æ—¥å¿—ç±»å‹ï¼Œæ”¯æŒ txt å’Œ json ï¼Œé»˜è®¤txt Short bool // ä»¥åŒ…/æ–‡ä»¶:è¡Œå· æ˜¾ç¤ºçŸ­è·¯å¾„ï¼Œä¸æ˜¾ç¤ºå…¨è·¯å¾„ } type LogOptions func(*Log) func WithLevel(level string) LogOptions { return func(lg *Log) { lg.Level = level } } func WithType(tp string) LogOptions { return func(lg *Log) { lg.Type = tp } } func WithShort(short bool) LogOptions { return func(lg *Log) { lg.Short = short } } // LevelToZapLevel è½¬æ¢æ—¥å¿—çº§åˆ« func LevelToSlogLevel(level string) slog.Level { switch level { case \"debug\", \"DEBUG\": return slog.LevelDebug case \"info\", \"INFO\": return slog.LevelInfo case \"warn\", \"WARN\", \"WARNING\": return slog.LevelWarn case \"error\", \"ERROR\": return slog.LevelError default: return slog.LevelInfo } } func NewSlog(lg *Log) *slog.Logger { replace := func(groups []string, a slog.Attr) slog.Attr { // Remove the directory from the source's filename. if a.Key == slog.SourceKey \u0026\u0026 lg.Short { a.Value = slog.StringValue(filepath.Base(a.Value.String())) } return a } opts := slog.HandlerOptions{ AddSource: true, Level: LevelToSlogLevel(lg.Level), ReplaceAttr: replace, } var log *slog.Logger if lg.Type == \"json\" { log = slog.New(opts.NewJSONHandler(os.Stdout)) } else { log = slog.New(opts.NewTextHandler(os.Stdout)) } return log } func New(options ...LogOptions) *slog.Logger { // é»˜è®¤å€¼çš„è®¾å®š lg := \u0026Log{ Level: \"info\", Type: \"txt\", Short: true, } // éå†å¯é€‰å‚æ•°ï¼Œç„¶ååˆ†åˆ«è°ƒç”¨åŒ¿åå‡½æ•°ï¼Œå°†è¿æ¥å¯¹è±¡æŒ‡é’ˆä¼ å…¥ï¼Œè¿›è¡Œä¿®æ”¹ for _, opt := range options { // éå†è°ƒç”¨å‡½æ•°ï¼Œè¿›è¡Œæ•°æ®ä¿®æ”¹ opt(lg) } return NewSlog(lg) } ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-slog/:1:2","tags":["Go","slog"],"title":"Go slog","uri":"/posts/2024-06-02-go-slog/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Shamirå¯†é’¥åˆ†äº«ç®—æ³• å‚è€ƒï¼šhttps://www.cxyzjd.com/article/shangsongwww/90266455 ç§˜å¯†å…±äº«æŠ€æœ¯æ˜¯å¯†ç å­¦å’Œä¿¡æ¯å®‰å…¨çš„ä¸€ä¸ªé‡è¦ç ”ç©¶å†…å®¹ï¼ŒShamirå¯†é’¥åˆ†äº«ç®—æ³•æœ€æ—©æ˜¯ç”±Shamirå’ŒBlacklyåœ¨1970å¹´åŸºäºLagrangeæ’å€¼å’ŒçŸ¢é‡æ–¹æ³•æå‡ºçš„ï¼Œå…¶åŸºæœ¬æ€æƒ³æ˜¯åˆ†å‘è€…é€šè¿‡ç§˜å¯†å¤šé¡¹å¼ï¼Œå°†ç§˜å¯†såˆ†è§£ä¸ºnä¸ªç§˜å¯†åˆ†å‘ä¸ªæŒæœ‰è€…ï¼Œå…¶ä¸­ä»»æ„ä¸å°‘äºkä¸ªç§˜å¯†å‡èƒ½æ¢å¤å¯†æ–‡ï¼Œè€Œä»»æ„å°‘äºkä¸ªç§˜å¯†å‡æ— æ³•å¾—åˆ°å¯†æ–‡çš„ä»»ä½•ä¿¡æ¯ã€‚ ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-shamir/:1:0","tags":["Go","shamir"],"title":"Go shamir","uri":"/posts/2024-06-02-go-shamir/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å®é™…åº”ç”¨ æ¯”å¦‚åœ¨é—¨é™ä½“ç³»ä¸­ï¼Œä¸ºäº†ä¿è¯ä¿¡æ¯å®‰å…¨æ€§ï¼Œä¸€ä¸ªç§˜å¯†é€šå¸¸ä¸èƒ½ç”±å•ä¸ªæŒæœ‰è€…ä¿å­˜ã€‚æ¯”å¦‚ä¸€äº›é‡è¦åœºæ‰€çš„é€šè¡Œï¼Œæ¯”å¦‚é—å˜±çš„ç”Ÿæ•ˆç­‰ï¼Œå¿…é¡»å°†ç§˜å¯†åˆ†ç”±å¤šäººä¿ç®¡å¹¶ä¸”åªæœ‰å½“å¤šäººåŒæ—¶åœ¨åœºæ—¶ç§˜å¯†æ‰èƒ½å¾—ä»¥æ¢å¤ã€‚åœ¨è¿™äº›åœºåˆï¼Œå°±éœ€è¦è¿™æ ·ä¸€å¥—çš„å¯†é’¥åˆ†äº«æŠ€æœ¯ã€‚ ç¤ºä¾‹1ï¼š # ç®—æ³•åº“ github.com/hashicorp/vault/shamir github.com/serialt/lancet/cryptor/shamir (åŸºäºvault) github.com/corvus-ch/shamir package main import ( \"encoding/base64\" \"fmt\" \"github.com/serialt/lancet/cryptor/shamir\" ) func main() { secret := []byte(\"dnwkUubRaEXr7TV7VswNqh4L3cHEbJjH\") // å°†å¯†ç åˆ†æˆ5ä»½ï¼Œæœ€å°‘éœ€è¦3ä»½æ‰èƒ½åˆå¹¶æˆåŸå§‹å¯†ç  msg, err := shamir.Split(secret, 5, 3) if err != nil { fmt.Println(err) } else { for k, v := range msg { fmt.Printf(\"shamir share secret %v: %v\\n\", k, base64.RawStdEncoding.EncodeToString(v)) } } deCode() } func combine(parts ...[]byte) []byte { var msgParts [][]byte for _, v := range parts { msgParts = append(msgParts, v) } result, err := shamir.Combine(msgParts) if err != nil { return nil } return result } func deCode() { msg1, _ := base64.StdEncoding.DecodeString(\"Im3P+3AOr7So+dB7feyrNGY0lAeT1Ou3I3Rn0PmWN5Ad\") msg2, _ := base64.StdEncoding.DecodeString(\"xguYlI5C77FDOln9R0gNT963V9B+RR12C7RlQVcSfCWX\") msg3, _ := base64.StdEncoding.DecodeString(\"9AytrQ+ZDzSHJNx4rq3qGYxKeM/bcBclWiCwZYqdUlC8\") // msg := [][]byte{ // msg1, // msg2, // msg3, // } fmt.Printf(\"\\ncomboine secret: %s \\n\", string(combine(msg1, msg2, msg3))) } ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-shamir/:1:1","tags":["Go","shamir"],"title":"Go shamir","uri":"/posts/2024-06-02-go-shamir/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go æ±‰å­—è½¬æ‹¼éŸ³åº“ æ±‰è¯­æ‹¼éŸ³è½¬æ¢å·¥å…· Go ç‰ˆã€‚ 1ã€å®‰è£… go get -u github.com/mozillazg/go-pinyin å®‰è£…cliå·¥å…· go get -u github.com/mozillazg/go-pinyin/cmd/pinyin $ pinyin ä¸­å›½äºº zhÅng guÃ³ rÃ©n 2ã€ç®€å•ä½¿ç”¨ package main import ( \"fmt\" \"github.com/mozillazg/go-pinyin\" ) func main() { hans := \"ä¸­å›½äºº\" // é»˜è®¤ a := pinyin.NewArgs() fmt.Println(pinyin.Pinyin(hans, a)) // [[zhong] [guo] [ren]] // åŒ…å«å£°è°ƒ a.Style = pinyin.Tone fmt.Println(pinyin.Pinyin(hans, a)) // [[zhÅng] [guÃ³] [rÃ©n]] // å£°è°ƒç”¨æ•°å­—è¡¨ç¤º a.Style = pinyin.Tone2 fmt.Println(pinyin.Pinyin(hans, a)) // [[zho1ng] [guo2] [re2n]] // å¼€å¯å¤šéŸ³å­—æ¨¡å¼ a = pinyin.NewArgs() a.Heteronym = true fmt.Println(pinyin.Pinyin(hans, a)) // [[zhong zhong] [guo] [ren]] a.Style = pinyin.Tone2 fmt.Println(pinyin.Pinyin(hans, a)) // [[zho1ng zho4ng] [guo2] [re2n]] fmt.Println(pinyin.LazyPinyin(hans, pinyin.NewArgs())) // [zhong guo ren] fmt.Println(pinyin.Convert(hans, nil)) // [[zhong] [guo] [ren]] fmt.Println(pinyin.LazyConvert(hans, nil)) // [zhong guo ren] } è¾“å‡ºè°ƒè¯• package main import ( \"fmt\" \"github.com/mozillazg/go-pinyin\" ) func main() { hans := \"éŸ³ä¹\" // é»˜è®¤ a := pinyin.NewArgs() p1 := pinyin.Pinyin(hans, a) fmt.Println(p1) // [[zhong] [guo] [ren]] // åŒ…å«å£°è°ƒ a.Style = pinyin.Tone p2 := pinyin.Pinyin(hans, a) fmt.Println(p2) // [[zhÅng] [guÃ³] [rÃ©n]] // å£°è°ƒç”¨æ•°å­—è¡¨ç¤º a.Style = pinyin.Tone2 p3 := pinyin.Pinyin(hans, a) fmt.Println(p3) // [[zho1ng] [guo2] [re2n]] // å¼€å¯å¤šéŸ³å­—æ¨¡å¼ a = pinyin.NewArgs() a.Heteronym = true p4 := pinyin.Pinyin(hans, a) fmt.Println(p4) // [[zhong zhong] [guo] [ren]] a.Style = pinyin.Tone2 p5 := pinyin.Pinyin(hans, a) fmt.Println(p5) // [[zho1ng zho4ng] [guo2] [re2n]] p6 := pinyin.LazyPinyin(hans, pinyin.NewArgs()) fmt.Println(p6) // [zhong guo ren] p7 := pinyin.Convert(hans, nil) fmt.Println(p7) // [[zhong] [guo] [ren]] p8 := pinyin.LazyConvert(hans, nil) fmt.Println(p8) // [zhong guo ren] } ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-pinyin/:1:0","tags":["Go","pinyin"],"title":"Go pinyin","uri":"/posts/2024-06-02-go-pinyin/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"os/exec ç³»ç»Ÿå†…æ‰§è¡Œå‘½ä»¤ 1ã€æŸ¥æ‰¾å‘½ä»¤æ‰€åœ¨çš„è·¯å¾„ func findCommandPath(str string) (string, error) { path, err := exec.LookPath(str) if err != nil { return \"\", err } return path, nil } 2ã€CombinedOutputç»„åˆè¾“å‡ºï¼Œæ ‡å‡†æ­£ç¡®é”™è¯¯è¾“å‡ºï¼Œç±»ä¼¼äºshellçš„å°†æ ‡å‡†é”™è¯¯è¾“å‡ºé‡å®šå‘åˆ°æ ‡å‡†æ­£ç¡®è¾“å‡º func main() { cmd := exec.Command(\"/bin/bash\", \"-c\", \"datex\") std, err := cmd.CombinedOutput() if err != nil { } fmt.Println(string(std)) } 3ã€Output æ ‡å‡†æ­£ç¡®è¾“å‡º func main() { cmd := exec.Command(\"/bin/bash\", \"-c\", \"date\") result, err := cmd.Output() if err != nil { fmt.Println(\"å‘½ä»¤æ‰§è¡Œå¤±è´¥\", err) } fmt.Println(string(result)) } 4ã€é˜»å¡Run package main import ( \"log\" \"os/exec\" ) func main() { cmd := exec.Command(\"sleep\", \"1\") log.Printf(\"Running command and waiting for it to finish...\") err := cmd.Run() log.Printf(\"Command finished with error: %v\", err) } å¯ç”¨å‡½æ•° // è·å–å‘½ä»¤çš„è·¯å¾„ func findCommandPath(str string) (string, error) { path, err := exec.LookPath(str) if err != nil { return \"\", err } return path, nil } // è·å–æ ‡å‡†æ­£ç¡®è¾“å‡º func runCmd(str string) (string, error) { cmd := exec.Command(\"/bin/sh\", \"-c\", str) result, err := cmd.Output() if err != nil { return \"\", err } return string(result), nil } // æ ‡å‡†æ­£ç¡®é”™è¯¯è¾“å‡ºåˆ°æ ‡å‡†æ­£ç¡®è¾“å‡º func runCMD(str string) (string, error) { cmd := exec.Command(\"/bin/sh\", \"-c\", str) result, err := cmd.CombinedOutput() if err != nil { return string(result), err } return string(result), nil } ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-os-exec/:1:0","tags":["Go","exec"],"title":"Go exec","uri":"/posts/2024-06-02-go-os-exec/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"os å‡½æ•°å è¯´æ˜ å¤‡æ³¨ os.Hostname() è·å–ä¸»æœºå os.Getwd() è·å–å½“å‰ç›®å½• os.Getuid() è·å–ç”¨æˆ·ID os.Geteuid() è·å–æœ‰æ•ˆç”¨æˆ·ID os.Getgid() è·å–ç»„ID os.Getegid() è·å–æœ‰æ•ˆç»„ID os.Getpid() è·å–è¿›ç¨‹ID os.Getppid() è·å–çˆ¶è¿›ç¨‹ID os.Getenv(â€œGOPATHâ€) è·å–ç¯å¢ƒå˜é‡çš„å€¼ os.Setenv(â€œORACLE_BASEâ€, â€œ/op/oracle/orabaseâ€) è®¾ç½®ç¯å¢ƒå˜é‡çš„å€¼ os.Chdir(\"/home/oracle\") æ”¹å˜å½“å‰å·¥ä½œç›®å½• ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-os-exec/:1:1","tags":["Go","exec"],"title":"Go exec","uri":"/posts/2024-06-02-go-os-exec/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Gorm å®˜ç½‘ï¼šhttps://gorm.io/ ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-gorm/:1:0","tags":["Go","gorm"],"title":"Go gorm","uri":"/posts/2024-06-02-go-gorm/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"ç‰¹æ€§ï¼š å…¨åŠŸèƒ½ ORM å…³è” (Has Oneï¼ŒHas Manyï¼ŒBelongs Toï¼ŒMany To Manyï¼Œå¤šæ€ï¼Œå•è¡¨ç»§æ‰¿) Createï¼ŒSaveï¼ŒUpdateï¼ŒDeleteï¼ŒFind ä¸­é’©å­æ–¹æ³• æ”¯æŒ Preloadã€Joins çš„é¢„åŠ è½½ äº‹åŠ¡ï¼ŒåµŒå¥—äº‹åŠ¡ï¼ŒSave Pointï¼ŒRollback To Saved Point Contextã€é¢„ç¼–è¯‘æ¨¡å¼ã€DryRun æ¨¡å¼ æ‰¹é‡æ’å…¥ï¼ŒFindInBatchesï¼ŒFind/Create with Mapï¼Œä½¿ç”¨ SQL è¡¨è¾¾å¼ã€Context Valuer è¿›è¡Œ CRUD SQL æ„å»ºå™¨ï¼ŒUpsertï¼Œæ•°æ®åº“é”ï¼ŒOptimizer/Index/Comment Hintï¼Œå‘½åå‚æ•°ï¼Œå­æŸ¥è¯¢ å¤åˆä¸»é”®ï¼Œç´¢å¼•ï¼Œçº¦æŸ Auto Migration è‡ªå®šä¹‰ Logger çµæ´»çš„å¯æ‰©å±•æ’ä»¶ APIï¼šDatabase Resolverï¼ˆå¤šæ•°æ®åº“ï¼Œè¯»å†™åˆ†ç¦»ï¼‰ã€Prometheusâ€¦ æ¯ä¸ªç‰¹æ€§éƒ½ç»è¿‡äº†æµ‹è¯•çš„é‡é‡è€ƒéªŒ å¼€å‘è€…å‹å¥½ ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-gorm/:1:1","tags":["Go","gorm"],"title":"Go gorm","uri":"/posts/2024-06-02-go-gorm/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"quickstart sqlite go get -u gorm.io/gorm go get -u github.com/glebarez/sqlite package main import ( \"github.com/glebarez/sqlite\" \"gorm.io/gorm\" \"gorm.io/gorm/schema\" ) type Product struct { gorm.Model Code string Price uint } func main() { db, err := gorm.Open(sqlite.Open(\"test.db\"), \u0026gorm.Config{ DisableForeignKeyConstraintWhenMigrating: true, NamingStrategy: schema.NamingStrategy{ SingularTable: true, // è®¾ç½®åˆ›å»ºè¡¨åæ—¶ä¸ä½¿ç”¨å¤æ•° }, }) if err != nil { panic(\"failed to connect database\") } // è¿ç§» schema db.AutoMigrate(\u0026Product{}) // Create db.Create(\u0026Product{Code: \"D42\", Price: 100}) // Read var product Product db.First(\u0026product, 1) // æ ¹æ®æ•´å½¢ä¸»é”®æŸ¥æ‰¾ db.First(\u0026product, \"code = ?\", \"D42\") // æŸ¥æ‰¾ code å­—æ®µå€¼ä¸º D42 çš„è®°å½• // Update - å°† product çš„ price æ›´æ–°ä¸º 200 db.Model(\u0026product).Update(\"Price\", 200) // Update - æ›´æ–°å¤šä¸ªå­—æ®µ db.Model(\u0026Product{}).Updates(Product{Price: 200, Code: \"F42\"}) // ä»…æ›´æ–°éé›¶å€¼å­—æ®µ db.Model(\u0026Product{}).Updates(map[string]interface{}{\"Price\": 200, \"Code\": \"F42\"}) // Delete - åˆ é™¤ product db.Delete(\u0026product, 1) } ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-gorm/:1:2","tags":["Go","gorm"],"title":"Go gorm","uri":"/posts/2024-06-02-go-gorm/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æ¨¡å‹å®šä¹‰ GORM å®šä¹‰ä¸€ä¸ª gorm.Model ç»“æ„ä½“ï¼Œå…¶åŒ…æ‹¬å­—æ®µ IDã€CreatedAtã€UpdatedAtã€DeletedAt // gorm.Model çš„å®šä¹‰ type Model struct { ID uint `gorm:\"primaryKey\"` CreatedAt time.Time UpdatedAt time.Time DeletedAt gorm.DeletedAt `gorm:\"index\"` } åµŒå…¥ç»“æ„ä½“ä¸­ä½¿ç”¨ type Student struct{ gorm.Model StuName string StuAge uint } å­—æ®µæ§åˆ¶ å¯å¯¼å‡ºçš„å­—æ®µåœ¨ä½¿ç”¨ GORM è¿›è¡Œ CRUD æ—¶æ‹¥æœ‰å…¨éƒ¨çš„æƒé™ï¼Œæ­¤å¤–ï¼ŒGORM å…è®¸æ‚¨ç”¨æ ‡ç­¾æ§åˆ¶å­—æ®µçº§åˆ«çš„æƒé™ã€‚è¿™æ ·æ‚¨å°±å¯ä»¥è®©ä¸€ä¸ªå­—æ®µçš„æƒé™æ˜¯åªè¯»ã€åªå†™ã€åªåˆ›å»ºã€åªæ›´æ–°æˆ–è€…è¢«å¿½ç•¥ æ³¨æ„ï¼š ä½¿ç”¨ GORM Migrator åˆ›å»ºè¡¨æ—¶ï¼Œä¸ä¼šåˆ›å»ºè¢«å¿½ç•¥çš„å­—æ®µ type User struct { Name string `gorm:\"\u003c-:create\"` // å…è®¸è¯»å’Œåˆ›å»º Name string `gorm:\"\u003c-:update\"` // å…è®¸è¯»å’Œæ›´æ–° Name string `gorm:\"\u003c-\"` // å…è®¸è¯»å’Œå†™ï¼ˆåˆ›å»ºå’Œæ›´æ–°ï¼‰ Name string `gorm:\"\u003c-:false\"` // å…è®¸è¯»ï¼Œç¦æ­¢å†™ Name string `gorm:\"-\u003e\"` // åªè¯»ï¼ˆé™¤éæœ‰è‡ªå®šä¹‰é…ç½®ï¼Œå¦åˆ™ç¦æ­¢å†™ï¼‰ Name string `gorm:\"-\u003e;\u003c-:create\"` // å…è®¸è¯»å’Œå†™ Name string `gorm:\"-\u003e:false;\u003c-:create\"` // ä»…åˆ›å»ºï¼ˆç¦æ­¢ä» db è¯»ï¼‰ Name string `gorm:\"-\"` // é€šè¿‡ struct è¯»å†™ä¼šå¿½ç•¥è¯¥å­—æ®µ } ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-gorm/:1:3","tags":["Go","gorm"],"title":"Go gorm","uri":"/posts/2024-06-02-go-gorm/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"CRUD åˆ›å»º åˆ›å»ºè®°å½• user := User{Name: \"Jinzhu\", Age: 18, Birthday: time.Now()} result := db.Create(\u0026user) // é€šè¿‡æ•°æ®çš„æŒ‡é’ˆæ¥åˆ›å»º user.ID // è¿”å›æ’å…¥æ•°æ®çš„ä¸»é”® result.Error // è¿”å› error result.RowsAffected // è¿”å›æ’å…¥è®°å½•çš„æ¡æ•° ç”¨æŒ‡å®šçš„å­—æ®µåˆ›å»ºè®°å½• åˆ›å»ºè®°å½•å¹¶æ›´æ–°ç»™å‡ºçš„å­—æ®µ db.Select(\"Name\", \"Age\", \"CreatedAt\").Create(\u0026user) // INSERT INTO `users` (`name`,`age`,`created_at`) VALUES (\"jinzhu\", 18, \"2020-07-04 11:05:21.775\") åˆ›å»ºè®°å½•å¹¶æ›´æ–°æœªç»™å‡ºçš„å­—æ®µ db.Omit(\"Name\", \"Age\", \"CreatedAt\").Create(\u0026user) // INSERT INTO `users` (`birthday`,`updated_at`) VALUES (\"2020-01-01 00:00:00.000\", \"2020-07-04 11:05:21.775\") æ‰¹é‡æ’å…¥ è¦æœ‰æ•ˆåœ°æ’å…¥å¤§é‡è®°å½•ï¼Œè¯·å°†ä¸€ä¸ª slice ä¼ é€’ç»™ Create æ–¹æ³•ã€‚ å°†åˆ‡ç‰‡æ•°æ®ä¼ é€’ç»™ Create æ–¹æ³•ï¼ŒGORM å°†ç”Ÿæˆä¸€ä¸ªå•ä¸€çš„ SQL è¯­å¥æ¥æ’å…¥æ‰€æœ‰æ•°æ®ï¼Œå¹¶å›å¡«ä¸»é”®çš„å€¼ï¼Œé’©å­æ–¹æ³•ä¹Ÿä¼šè¢«è°ƒç”¨ã€‚ var users = []User{{Name: \"jinzhu1\"}, {Name: \"jinzhu2\"}, {Name: \"jinzhu3\"}} db.Create(\u0026users) for _, user := range users { user.ID // 1,2,3 } ä½¿ç”¨ CreateInBatches åˆ›å»ºæ—¶ï¼Œä½ è¿˜å¯ä»¥æŒ‡å®šåˆ›å»ºçš„æ•°é‡ï¼Œä¾‹å¦‚ï¼š var users = []User{{name: \"jinzhu_1\"}, ...., {Name: \"jinzhu_10000\"}} // æ•°é‡ä¸º 100 db.CreateInBatches(users, 100) åˆ›å»ºé’©å­ GORM å…è®¸ç”¨æˆ·å®šä¹‰çš„é’©å­æœ‰ BeforeSave, BeforeCreate, AfterSave, AfterCreate åˆ›å»ºè®°å½•æ—¶å°†è°ƒç”¨è¿™äº›é’©å­æ–¹æ³•ï¼Œè¯·å‚è€ƒ Hooks ä¸­å…³äºç”Ÿå‘½å‘¨æœŸçš„è¯¦ç»†ä¿¡æ¯ func (u *User) BeforeCreate(tx *gorm.DB) (err error) { u.UUID = uuid.New() if u.Role == \"admin\" { return errors.New(\"invalid role\") } return } å¦‚æœæ‚¨æƒ³è·³è¿‡ é’©å­ æ–¹æ³•ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ SkipHooks ä¼šè¯æ¨¡å¼ï¼Œä¾‹å¦‚ï¼š DB.Session(\u0026gorm.Session{SkipHooks: true}).Create(\u0026user) DB.Session(\u0026gorm.Session{SkipHooks: true}).Create(\u0026users) DB.Session(\u0026gorm.Session{SkipHooks: true}).CreateInBatches(users, 100) æ ¹æ®Mapåˆ›å»º GORM æ”¯æŒæ ¹æ® map[string]interface{} å’Œ []map[string]interface{}{} åˆ›å»ºè®°å½•ï¼Œä¾‹å¦‚ï¼š db.Model(\u0026User{}).Create(map[string]interface{}{ \"Name\": \"jinzhu\", \"Age\": 18, }) // batch insert from `[]map[string]interface{}{}` db.Model(\u0026User{}).Create([]map[string]interface{}{ {\"Name\": \"jinzhu_1\", \"Age\": 18}, {\"Name\": \"jinzhu_2\", \"Age\": 20}, }) æ³¨æ„ï¼š æ ¹æ® map åˆ›å»ºè®°å½•æ—¶ï¼Œassociation ä¸ä¼šè¢«è°ƒç”¨ï¼Œä¸”ä¸»é”®ä¹Ÿä¸ä¼šè‡ªåŠ¨å¡«å…… é«˜çº§é€‰é¡¹ å…³è”åˆ›å»º åˆ›å»ºå…³è”æ•°æ®æ—¶ï¼Œå¦‚æœå…³è”å€¼æ˜¯éé›¶å€¼ï¼Œè¿™äº›å…³è”ä¼šè¢« upsertï¼Œä¸”å®ƒä»¬çš„ Hook æ–¹æ³•ä¹Ÿä¼šè¢«è°ƒç”¨ type CreditCard struct { gorm.Model Number string UserID uint } type User struct { gorm.Model Name string CreditCard CreditCard } db.Create(\u0026User{ Name: \"jinzhu\", CreditCard: CreditCard{Number: \"411111111111\"} }) // INSERT INTO `users` ... // INSERT INTO `credit_cards` ... æ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ Selectã€ Omit è·³è¿‡å…³è”ä¿å­˜ï¼Œä¾‹å¦‚ï¼š db.Omit(\"CreditCard\").Create(\u0026user) // è·³è¿‡æ‰€æœ‰å…³è” db.Omit(clause.Associations).Create(\u0026user) é»˜è®¤å€¼ æ‚¨å¯ä»¥é€šè¿‡æ ‡ç­¾ default ä¸ºå­—æ®µå®šä¹‰é»˜è®¤å€¼ï¼Œå¦‚ï¼š type User struct { ID int64 Name string `gorm:\"default:galeone\"` Age int64 `gorm:\"default:18\"` } æ’å…¥è®°å½•åˆ°æ•°æ®åº“æ—¶ï¼Œé»˜è®¤å€¼ ä¼šè¢«ç”¨äº å¡«å……å€¼ä¸º é›¶å€¼ çš„å­—æ®µ æ³¨æ„ åƒ 0ã€''ã€false ç­‰é›¶å€¼ï¼Œä¸ä¼šå°†è¿™äº›å­—æ®µå®šä¹‰çš„é»˜è®¤å€¼ä¿å­˜åˆ°æ•°æ®åº“ã€‚æ‚¨éœ€è¦ä½¿ç”¨æŒ‡é’ˆç±»å‹æˆ– Scanner/Valuer æ¥é¿å…è¿™ä¸ªé—®é¢˜ï¼Œä¾‹å¦‚ï¼š type User struct { gorm.Model Name string Age *int `gorm:\"default:18\"` Active sql.NullBool `gorm:\"default:true\"` } æ³¨æ„ è‹¥è¦æ•°æ®åº“æœ‰é»˜è®¤ã€è™šæ‹Ÿ/ç”Ÿæˆçš„å€¼ï¼Œä½ å¿…é¡»ä¸ºå­—æ®µè®¾ç½® default æ ‡ç­¾ã€‚è‹¥è¦åœ¨è¿ç§»æ—¶è·³è¿‡é»˜è®¤å€¼å®šä¹‰ï¼Œä½ å¯ä»¥ä½¿ç”¨ default:(-)ï¼Œä¾‹å¦‚ï¼š type User struct { ID string `gorm:\"default:uuid_generate_v3()\"` // db func FirstName string LastName string Age uint8 FullName string `gorm:\"-\u003e;type:GENERATED ALWAYS AS (concat(firstname,' ',lastname));default:(-);\"` } ä½¿ç”¨è™šæ‹Ÿ/ç”Ÿæˆçš„å€¼æ—¶ï¼Œä½ å¯èƒ½éœ€è¦ç¦ç”¨å®ƒçš„åˆ›å»ºã€æ›´æ–°æƒé™ï¼ŒæŸ¥çœ‹ å­—æ®µçº§æƒé™ è·å–è¯¦æƒ… ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-gorm/:1:4","tags":["Go","gorm"],"title":"Go gorm","uri":"/posts/2024-06-02-go-gorm/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æŸ¥è¯¢ æ£€æµ‹å•ä¸ªå¯¹è±¡ GORM æä¾›äº† Firstã€Takeã€Last æ–¹æ³•ï¼Œä»¥ä¾¿ä»æ•°æ®åº“ä¸­æ£€ç´¢å•ä¸ªå¯¹è±¡ã€‚å½“æŸ¥è¯¢æ•°æ®åº“æ—¶å®ƒæ·»åŠ äº† LIMIT 1 æ¡ä»¶ï¼Œä¸”æ²¡æœ‰æ‰¾åˆ°è®°å½•æ—¶ï¼Œå®ƒä¼šè¿”å› ErrRecordNotFound é”™è¯¯ // è·å–ç¬¬ä¸€æ¡è®°å½•ï¼ˆä¸»é”®å‡åºï¼‰ db.First(\u0026user) // SELECT * FROM users ORDER BY id LIMIT 1; // è·å–ä¸€æ¡è®°å½•ï¼Œæ²¡æœ‰æŒ‡å®šæ’åºå­—æ®µ db.Take(\u0026user) // SELECT * FROM users LIMIT 1; // è·å–æœ€åä¸€æ¡è®°å½•ï¼ˆä¸»é”®é™åºï¼‰ db.Last(\u0026user) // SELECT * FROM users ORDER BY id DESC LIMIT 1; result := db.First(\u0026user) result.RowsAffected // è¿”å›æ‰¾åˆ°çš„è®°å½•æ•° result.Error // returns error // æ£€æŸ¥ ErrRecordNotFound é”™è¯¯ errors.Is(result.Error, gorm.ErrRecordNotFound) å¦‚æœä½ æƒ³é¿å…ErrRecordNotFoundé”™è¯¯ï¼Œä½ å¯ä»¥ä½¿ç”¨Findï¼Œæ¯”å¦‚db.Limit(1).Find(\u0026user)ï¼ŒFindæ–¹æ³•å¯ä»¥æ¥å—structå’Œsliceçš„æ•°æ®ã€‚ First, Lastæ–¹æ³•å°†æŒ‰ä¸»é”®æ’åºæŸ¥æ‰¾ç¬¬ä¸€/æœ€åä¸€æ¡è®°å½•ï¼Œåªæœ‰åœ¨ç”¨structæŸ¥è¯¢æˆ–æä¾›model valueæ—¶æ‰æœ‰æ•ˆï¼Œå¦‚æœå½“å‰modelæ²¡æœ‰å®šä¹‰ä¸»é”®ï¼Œå°†æŒ‰ç¬¬ä¸€ä¸ªå­—æ®µæ’åºï¼Œä¾‹å¦‚ï¼š var user User var users []User // å¯ä»¥ db.First(\u0026user) // SELECT * FROM `users` ORDER BY `users`.`id` LIMIT 1 // å¯ä»¥ result := map[string]interface{}{} db.Model(\u0026User{}).First(\u0026result) // SELECT * FROM `users` ORDER BY `users`.`id` LIMIT 1 // ä¸è¡Œ result := map[string]interface{}{} db.Table(\"users\").First(\u0026result) // ä½†å¯ä»¥é…åˆ Take ä½¿ç”¨ result := map[string]interface{}{} db.Table(\"users\").Take(\u0026result) // æ ¹æ®ç¬¬ä¸€ä¸ªå­—æ®µæ’åº type Language struct { Code string Name string } db.First(\u0026Language{}) // SELECT * FROM `languages` ORDER BY `languages`.`code` LIMIT 1 ç”¨ä¸»é”®æ£€ç´¢ å¦‚æœä¸»é”®æ˜¯æ•°å€¼ç±»å‹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ å†…è”æ¡ä»¶ ä¼ å…¥ä¸»é”®æ¥æ£€ç´¢å¯¹è±¡ã€‚å¦‚æœä¸»é”®æ˜¯ string ç±»å‹ï¼Œè¦å°å¿ƒé¿å… SQL æ³¨å…¥ï¼ŒæŸ¥çœ‹ å®‰å…¨ è·å–è¯¦æƒ… db.First(\u0026user, 10) // SELECT * FROM users WHERE id = 10; db.First(\u0026user, \"10\") // SELECT * FROM users WHERE id = 10; db.Find(\u0026users, []int{1,2,3}) // SELECT * FROM users WHERE id IN (1,2,3); å¦‚æœä¸»é”®æ˜¯åƒ uuid è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œæ‚¨éœ€è¦è¿™è¦å†™ï¼š db.First(\u0026user, \"id = ?\", \"1b74413f-f3b8-409f-ac47-e8c062e3472a\") // SELECT * FROM users WHERE id = \"1b74413f-f3b8-409f-ac47-e8c062e3472a\"; æ›´æ–° db.Model(\u0026User{}).Where(\"active = ?\", true).Update(\"name\", \"hello\") äº‹ç‰© bErr := db.WithContext(ctx).Transaction(func(tx *gorm.DB) (err error) { err = s.repo.CreateUser(ctx, tx, []*model.User{user}) return }) ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-gorm/:1:5","tags":["Go","gorm"],"title":"Go gorm","uri":"/posts/2024-06-02-go-gorm/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go Goph æ¨¡å— githubåœ°å€ï¼šhttps://github.com/melbahja/goph goå¼€å‘å°è£…çš„ ssh client æ¨¡å— Features Easy to use and simple API. Supports known hosts by default. Supports connections with passwords. Supports connections with private keys. Supports connections with protected private keys with passphrase. Supports upload files from local to remote. Supports download files from remote to local. Supports connections with ssh agent (Unix systems only). Supports adding new hosts to known_hosts file. Supports file system operations like: Open, Create, Chmod... Supports context.Context for command cancellation. ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-goph/:1:0","tags":["Go","goph","ssh"],"title":"Go goph","uri":"/posts/2024-06-02-go-goph/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"1ã€å®‰è£… go get github.com/melbahja/goph ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-goph/:1:1","tags":["Go","goph","ssh"],"title":"Go goph","uri":"/posts/2024-06-02-go-goph/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"2ã€ä½¿ç”¨ç¤ºä¾‹ 1ï¼‰ä½¿ç”¨ssh æ‰§è¡Œå‘½ä»¤ package main import ( \"log\" \"fmt\" \"github.com/melbahja/goph\" ) func main() { // Start new ssh connection with private key. auth, err := goph.Key(\"/home/serialt/.ssh/id_rsa\", \"\") if err != nil { log.Fatal(err) } // goph.New é»˜è®¤ä½¿ç”¨22ç«¯å£ï¼Œå¦‚æœé22ç«¯å£ï¼Œåˆ™å‚è€ƒgoph.Newçš„å®ç° client, err := goph.New(\"root\", \"192.1.1.3\", auth) if err != nil { log.Fatal(err) } // Defer closing the network connection. defer client.Close() // Execute your command. out, err := client.Run(\"ls /tmp/\") if err != nil { log.Fatal(err) } // Get your output as []byte. fmt.Println(string(out)) } 2ï¼‰å¯†é’¥å¸¦å¯†ç  auth, err := goph.Key(\"/home/serialt/.ssh/id_rsa\", \"you_passphrase_here\") if err != nil { // handle error } client, err := goph.New(\"root\", \"192.1.1.3\", auth) 3ï¼‰ä½¿ç”¨å¯†ç è¿æ¥ auth, err := goph.UseAgent() if err != nil { // handle error } client, err := goph.New(\"root\", \"192.1.1.3\", auth) 4ï¼‰ä¸Šä¼ å’Œä¸‹è½½æ–‡ä»¶ // upload local file to remote err := client.Upload(\"/path/to/local/file\", \"/path/to/remote/file\") // download remote file to local err := client.Download(\"/path/to/remote/file\", \"/path/to/local/file\") 5ï¼‰æ‰§è¡Œshellå‘½ä»¤ // execute bash commands out, err := client.Run(\"bash -c 'printenv'\") // execute bash command whith timeout context, cancel := context.WithTimeout(ctx, time.Second) defer cancel() // will send SIGINT and return error after 1 second out, err := client.RunContext(ctx, \"sleep 5\") // execute bash command whith env variables out, err := client.Run(`env MYVAR=\"MY VALUE\" bash -c 'echo $MYVAR;'`) 6ï¼‰ä½¿ç”¨goph cmd Goph.Cmd struct is like the Go standard os/exec.Cmd. // Get new `Goph.Cmd` cmd, err := client.Command(\"ls\", \"-alh\", \"/tmp\") // or with context: // cmd, err := client.CommandContext(ctx, \"ls\", \"-alh\", \"/tmp\") if err != nil { // handle the error! } // You can set env vars, but the server must be configured to `AcceptEnv line`. cmd.Env = []string{\"MY_VAR=MYVALUE\"} // Run you command. err = cmd.Run() ust like os/exec.Cmd you can run CombinedOutput, Output, Start, Wait, and ssh.Session methods like Signalâ€¦ 7ï¼‰ä½¿ç”¨sftpæ“ä½œæ–‡ä»¶ç³»ç»Ÿ sftp, err := client.NewSftp() if err != nil { // handle the error! } file, err := sftp.Create(\"/tmp/remote_file\") file.Write([]byte(`Hello world`)) file.Close() For more file operations see SFTP Docs. ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-goph/:1:2","tags":["Go","goph","ssh"],"title":"Go goph","uri":"/posts/2024-06-02-go-goph/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"3ã€å®˜æ–¹ç¤ºä¾‹ package main import ( \"bufio\" \"context\" \"errors\" \"flag\" \"fmt\" \"log\" \"net\" \"os\" \"strings\" \"time\" \"github.com/melbahja/goph\" \"github.com/pkg/sftp\" \"golang.org/x/crypto/ssh\" \"golang.org/x/crypto/ssh/terminal\" ) // // Run command and auth via password: // \u003e go run main.go --ip 192.168.122.102 --pass --cmd ls // // Run command and auth via private key: // \u003e go run main.go --ip 192.168.122.102 --cmd ls // Or: // \u003e go run main.go --ip 192.168.122.102 --key /path/to/private_key --cmd ls // // Run command and auth with private key and passphrase: // \u003e go run main.go --ip 192.168.122.102 --passphrase --cmd ls // // Run a command and interrupt it after 1 second: // \u003e go run main.go --ip 192.168.122.102 --cmd \"sleep 10\" --timeout=1s // // You can test with the interactive mode without passing --cmd flag. // var ( err error auth goph.Auth client *goph.Client addr string user string port uint key string cmd string pass bool passphrase bool timeout time.Duration agent bool sftpc *sftp.Client ) func init() { flag.StringVar(\u0026addr, \"ip\", \"127.0.0.1\", \"machine ip address.\") flag.StringVar(\u0026user, \"user\", \"root\", \"ssh user.\") flag.UintVar(\u0026port, \"port\", 22, \"ssh port number.\") flag.StringVar(\u0026key, \"key\", strings.Join([]string{os.Getenv(\"HOME\"), \".ssh\", \"id_rsa\"}, \"/\"), \"private key path.\") flag.StringVar(\u0026cmd, \"cmd\", \"\", \"command to run.\") flag.BoolVar(\u0026pass, \"pass\", false, \"ask for ssh password instead of private key.\") flag.BoolVar(\u0026agent, \"agent\", false, \"use ssh agent for authentication (unix systems only).\") flag.BoolVar(\u0026passphrase, \"passphrase\", false, \"ask for private key passphrase.\") flag.DurationVar(\u0026timeout, \"timeout\", 0, \"interrupt a command with SIGINT after a given timeout (0 means no timeout)\") } func VerifyHost(host string, remote net.Addr, key ssh.PublicKey) error { // // If you want to connect to new hosts. // here your should check new connections public keys // if the key not trusted you shuld return an error // // hostFound: is host in known hosts file. // err: error if key not in known hosts file OR host in known hosts file but key changed! hostFound, err := goph.CheckKnownHost(host, remote, key, \"\") // Host in known hosts but key mismatch! // Maybe because of MAN IN THE MIDDLE ATTACK! if hostFound \u0026\u0026 err != nil { return err } // handshake because public key already exists. if hostFound \u0026\u0026 err == nil { return nil } // Ask user to check if he trust the host public key. if askIsHostTrusted(host, key) == false { // Make sure to return error on non trusted keys. return errors.New(\"you typed no, aborted!\") } // Add the new host to known hosts file. return goph.AddKnownHost(host, remote, key, \"\") } func main() { flag.Parse() var err error if agent || goph.HasAgent() { auth, err = goph.UseAgent() } else if pass { auth = goph.Password(askPass(\"Enter SSH Password: \")) } else { auth, err = goph.Key(key, getPassphrase(passphrase)) } if err != nil { panic(err) } client, err = goph.NewConn(\u0026goph.Config{ User: user, Addr: addr, Port: port, Auth: auth, Callback: VerifyHost, }) if err != nil { panic(err) } // Close client net connection defer client.Close() // If the cmd flag exists if cmd != \"\" { ctx := context.Background() // create a context with timeout, if supplied in the argumetns if timeout \u003e 0 { var cancel context.CancelFunc ctx, cancel = context.WithTimeout(ctx, timeout) defer cancel() } out, err := client.RunContext(ctx, cmd) fmt.Println(string(out), err) return } // else open interactive mode. playWithSSHJustForTestingThisProgram(client) } func askPass(msg string) string { fmt.Print(msg) pass, err := terminal.ReadPassword(0) if err != nil { panic(err) } fmt.Println(\"\") return strings.TrimSpace(string(pass)) } func getPassphrase(ask bool) string { if ask { return askPass(\"Enter Private Key Passphrase: \") } return \"\" } func askIsHostTrusted(host string, key ssh.PublicKey) bool { reader := bufio.NewReader(os.Stdin) fmt.Printf(\"Unknown Host: %s \\nFingerprint: %s \\n\", host, ssh.FingerprintSHA256(key)) fmt.Print(\"Would you like ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-goph/:1:3","tags":["Go","goph","ssh"],"title":"Go goph","uri":"/posts/2024-06-02-go-goph/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go flagæ¨¡å— å‚è€ƒé“¾æ¥ï¼šhttps://www.liwenzhou.com/posts/Go/go_flag/ Goè¯­è¨€å†…ç½®çš„flagåŒ…å®ç°äº†å‘½ä»¤è¡Œå‚æ•°çš„è§£æï¼ŒflagåŒ…ä½¿å¾—å¼€å‘å‘½ä»¤è¡Œå·¥å…·æ›´ä¸ºç®€å•ã€‚ ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-flag/:1:0","tags":["Go","flag"],"title":"Go flag","uri":"/posts/2024-06-02-go-flag/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"os.Args å¦‚æœä½ åªæ˜¯ç®€å•çš„æƒ³è¦è·å–å‘½ä»¤è¡Œå‚æ•°ï¼Œå¯ä»¥åƒä¸‹é¢çš„ä»£ç ç¤ºä¾‹ä¸€æ ·ä½¿ç”¨os.Argsæ¥è·å–å‘½ä»¤è¡Œå‚æ•°ã€‚ package main import ( \"fmt\" \"os\" ) //os.Args demo func main() { //os.Argsæ˜¯ä¸€ä¸ª[]string if len(os.Args) \u003e 0 { for index, arg := range os.Args { fmt.Printf(\"args[%d]=%v\\n\", index, arg) } } } å°†ä¸Šé¢çš„ä»£ç æ‰§è¡Œgo build -o \"args_demo\"ç¼–è¯‘ä¹‹åï¼Œæ‰§è¡Œï¼š $ ./args_demo a b c d args[0]=./args_demo args[1]=a args[2]=b args[3]=c args[4]=d os.Argsæ˜¯ä¸€ä¸ªå­˜å‚¨å‘½ä»¤è¡Œå‚æ•°çš„å­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ‰§è¡Œæ–‡ä»¶çš„åç§°ã€‚ ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-flag/:1:1","tags":["Go","flag"],"title":"Go flag","uri":"/posts/2024-06-02-go-flag/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"flagåŒ…åŸºæœ¬ä½¿ç”¨ æœ¬æ–‡ä»‹ç»äº†flagåŒ…çš„å¸¸ç”¨å‡½æ•°å’ŒåŸºæœ¬ç”¨æ³•ï¼Œæ›´è¯¦ç»†çš„å†…å®¹è¯·æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚ ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-flag/:1:2","tags":["Go","flag"],"title":"Go flag","uri":"/posts/2024-06-02-go-flag/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å¯¼å…¥flagåŒ… import flag ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-flag/:1:3","tags":["Go","flag"],"title":"Go flag","uri":"/posts/2024-06-02-go-flag/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"flagå‚æ•°ç±»å‹ flagåŒ…æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°ç±»å‹æœ‰boolã€intã€int64ã€uintã€uint64ã€float float64ã€stringã€durationã€‚ flagå‚æ•° æœ‰æ•ˆå€¼ å­—ç¬¦ä¸²flag åˆæ³•å­—ç¬¦ä¸² æ•´æ•°flag 1234ã€0664ã€0x1234ç­‰ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯è´Ÿæ•°ã€‚ æµ®ç‚¹æ•°flag åˆæ³•æµ®ç‚¹æ•° boolç±»å‹flag 1, 0, t, f, T, F, true, false, TRUE, FALSE, True, Falseã€‚ æ—¶é—´æ®µflag ä»»ä½•åˆæ³•çš„æ—¶é—´æ®µå­—ç¬¦ä¸²ã€‚å¦‚â€300msâ€ã€â€-1.5hâ€ã€â€2h45mâ€ã€‚ åˆæ³•çš„å•ä½æœ‰â€nsâ€ã€â€usâ€ /â€œÂµsâ€ã€â€msâ€ã€â€sâ€ã€â€mâ€ã€â€hâ€ã€‚ ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-flag/:1:4","tags":["Go","flag"],"title":"Go flag","uri":"/posts/2024-06-02-go-flag/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å®šä¹‰å‘½ä»¤è¡Œflagå‚æ•° æœ‰ä»¥ä¸‹ä¸¤ç§å¸¸ç”¨çš„å®šä¹‰å‘½ä»¤è¡Œflagå‚æ•°çš„æ–¹æ³•ã€‚ flag.Type() åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š flag.Type(flagå, é»˜è®¤å€¼, å¸®åŠ©ä¿¡æ¯)*Type ä¾‹å¦‚æˆ‘ä»¬è¦å®šä¹‰å§“åã€å¹´é¾„ã€å©šå¦ä¸‰ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼å®šä¹‰ï¼š name := flag.String(\"name\", \"å¼ ä¸‰\", \"å§“å\") age := flag.Int(\"age\", 18, \"å¹´é¾„\") married := flag.Bool(\"married\", false, \"å©šå¦\") delay := flag.Duration(\"d\", 0, \"æ—¶é—´é—´éš”\") éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤æ—¶nameã€ageã€marriedã€delayå‡ä¸ºå¯¹åº”ç±»å‹çš„æŒ‡é’ˆã€‚ flag.TypeVar() åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š flag.TypeVar(TypeæŒ‡é’ˆ, flagå, é»˜è®¤å€¼, å¸®åŠ©ä¿¡æ¯) ä¾‹å¦‚æˆ‘ä»¬è¦å®šä¹‰å§“åã€å¹´é¾„ã€å©šå¦ä¸‰ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼å®šä¹‰ï¼š var name string var age int var married bool var delay time.Duration flag.StringVar(\u0026name, \"name\", \"å¼ ä¸‰\", \"å§“å\") flag.IntVar(\u0026age, \"age\", 18, \"å¹´é¾„\") flag.BoolVar(\u0026married, \"married\", false, \"å©šå¦\") flag.DurationVar(\u0026delay, \"d\", 0, \"æ—¶é—´é—´éš”\") flag.Parse() é€šè¿‡ä»¥ä¸Šä¸¤ç§æ–¹æ³•å®šä¹‰å¥½å‘½ä»¤è¡Œflagå‚æ•°åï¼Œéœ€è¦é€šè¿‡è°ƒç”¨flag.Parse()æ¥å¯¹å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œè§£æã€‚ æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°æ ¼å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š -flag xxx ï¼ˆä½¿ç”¨ç©ºæ ¼ï¼Œä¸€ä¸ª-ç¬¦å·ï¼‰ --flag xxx ï¼ˆä½¿ç”¨ç©ºæ ¼ï¼Œä¸¤ä¸ª-ç¬¦å·ï¼‰ -flag=xxx ï¼ˆä½¿ç”¨ç­‰å·ï¼Œä¸€ä¸ª-ç¬¦å·ï¼‰ --flag=xxx ï¼ˆä½¿ç”¨ç­‰å·ï¼Œä¸¤ä¸ª-ç¬¦å·ï¼‰ å…¶ä¸­ï¼Œå¸ƒå°”ç±»å‹çš„å‚æ•°å¿…é¡»ä½¿ç”¨ç­‰å·çš„æ–¹å¼æŒ‡å®šã€‚ Flagè§£æåœ¨ç¬¬ä¸€ä¸ªéflagå‚æ•°ï¼ˆå•ä¸ªâ€-â€œä¸æ˜¯flagå‚æ•°ï¼‰ä¹‹å‰åœæ­¢ï¼Œæˆ–è€…åœ¨ç»ˆæ­¢ç¬¦â€â€“â€œä¹‹ååœæ­¢ã€‚ flagå…¶ä»–å‡½æ•° flag.Args() ////è¿”å›å‘½ä»¤è¡Œå‚æ•°åçš„å…¶ä»–å‚æ•°ï¼Œä»¥[]stringç±»å‹ flag.NArg() //è¿”å›å‘½ä»¤è¡Œå‚æ•°åçš„å…¶ä»–å‚æ•°ä¸ªæ•° flag.NFlag() //è¿”å›ä½¿ç”¨çš„å‘½ä»¤è¡Œå‚æ•°ä¸ªæ•° ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-flag/:1:5","tags":["Go","flag"],"title":"Go flag","uri":"/posts/2024-06-02-go-flag/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å®Œæ•´ç¤ºä¾‹ å®šä¹‰ func main() { //å®šä¹‰å‘½ä»¤è¡Œå‚æ•°æ–¹å¼1 var name string var age int var married bool var delay time.Duration flag.StringVar(\u0026name, \"name\", \"å¼ ä¸‰\", \"å§“å\") flag.IntVar(\u0026age, \"age\", 18, \"å¹´é¾„\") flag.BoolVar(\u0026married, \"married\", false, \"å©šå¦\") flag.DurationVar(\u0026delay, \"d\", 0, \"å»¶è¿Ÿçš„æ—¶é—´é—´éš”\") //è§£æå‘½ä»¤è¡Œå‚æ•° flag.Parse() fmt.Println(name, age, married, delay) //è¿”å›å‘½ä»¤è¡Œå‚æ•°åçš„å…¶ä»–å‚æ•° fmt.Println(flag.Args()) //è¿”å›å‘½ä»¤è¡Œå‚æ•°åçš„å…¶ä»–å‚æ•°ä¸ªæ•° fmt.Println(flag.NArg()) //è¿”å›ä½¿ç”¨çš„å‘½ä»¤è¡Œå‚æ•°ä¸ªæ•° fmt.Println(flag.NFlag()) } ä½¿ç”¨ å‘½ä»¤è¡Œå‚æ•°ä½¿ç”¨æç¤ºï¼š $ ./flag_demo -help Usage of ./flag_demo: -age int å¹´é¾„ (default 18) -d duration æ—¶é—´é—´éš” -married å©šå¦ -name string å§“å (default \"å¼ ä¸‰\") æ­£å¸¸ä½¿ç”¨å‘½ä»¤è¡Œflagå‚æ•°ï¼š $ ./flag_demo -name æ²™æ²³å¨œæ‰ --age 28 -married=false -d=1h30m æ²™æ²³å¨œæ‰ 28 false 1h30m0s [] 0 4 ä½¿ç”¨éflagå‘½ä»¤è¡Œå‚æ•°ï¼š $ ./flag_demo a b c å¼ ä¸‰ 18 false 0s [a b c] 3 0 ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-flag/:1:6","tags":["Go","flag"],"title":"Go flag","uri":"/posts/2024-06-02-go-flag/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"GO æ–‡ä»¶æ•°æ®åº“boltdb githubåœ°å€: https://github.com/etcd-io/bbolt https://github.com/boltdb/bolt ç”±äºä½œè€…ä¸ªäººèƒ½åŠ›æœ‰é™ï¼Œå®£å¸ƒä¸å†ç»´æŠ¤ï¼Œå»ºè®®ä½¿ç”¨ç¤¾åŒºç»´æŠ¤çš„bbolt å‚è€ƒï¼šhttps://zhuanlan.zhihu.com/p/84988890 ä½¿ç”¨ go get go.etcd.io/bbolt/... ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-boltdb/:1:0","tags":["Go","bolt"],"title":"Go boltdb","uri":"/posts/2024-06-02-go-boltdb/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"1ã€ä»‹ç» BoltDBæ˜¯çº¯Goè¯­è¨€å®ç°çš„æŒä¹…åŒ–è§£å†³æ–¹æ¡ˆï¼Œä¿å­˜æ•°æ®è‡³å†…å­˜æ˜ å°„æ–‡ä»¶ã€‚ç§°ä¹‹ä¸ºæŒä¹…åŒ–è§£å†³æ–¹æ¡ˆä¸æ˜¯æ•°æ®åº“ï¼Œå› ä¸ºæ•°æ®åº“è¿™ä¸ªè¯æœ‰å¾ˆå¤šé¢å¤–åŠŸèƒ½æ˜¯boltæ‰€ä¸å…·å¤‡çš„ã€‚æ­£æ˜¯å› ä¸ºç¼ºä¹è¿™äº›åŠŸèƒ½ä½¿å¾—boltå¦‚æ­¤ä¼˜é›…ã€å¥½ç”¨ã€‚ Boltå°±æ˜¯ä¸€ä¸ªGoåŒ…ã€‚æ— éœ€åœ¨ç³»ç»Ÿä¸­å®‰è£…ï¼Œå¼€å§‹ç¼–ç å‰ä¹Ÿæ— éœ€é…ç½®ï¼Œä»€ä¹ˆéƒ½ä¸éœ€è¦ï¼Œä»…éœ€è¦go get github.com/boltdb/boltï¼Œç„¶åimport â€œgithub.com/boltdb/boltâ€ã€‚ è¦å®Œå…¨ä½¿ç”¨boltçš„å­˜å‚¨åŠŸèƒ½ï¼Œåªéœ€è¦ä¸€ä¸ªæ–‡ä»¶åã€‚æ— è®ºä»å¼€å‘è€…æˆ–ç”¨æˆ·è§†è§’éƒ½æ„Ÿè§‰ä¸å¯æ€è®®ã€‚ä¸çŸ¥ä½ çš„æ„Ÿæƒ³å¦‚ä½•ï¼Œåœ¨æˆ‘çš„å·¥ä½œç»å†ä¸­èŠ±è¿‡å¾ˆå¤šæ—¶é—´æ­å»ºæ•°æ®åº“ç¯å¢ƒï¼Œè°ƒè¯•é…ç½®é—®é¢˜ï¼Œç”¨æˆ·å’Œæƒé™ä»¥åŠå…¶ä»–å„ç§é—®é¢˜ï¼Œå¦‚å…³ç³»å‹æ•°æ®åº“PostgreSqlã€Oracleå’ŒNoSQLã€‚è¿™äº›boltéƒ½ä¸éœ€è¦ï¼Œæ²¡æœ‰ç”¨æˆ·ã€æ— éœ€å®‰è£…ï¼Œä»…ä¸€ä¸ªæ–‡ä»¶åã€‚è¿™å¯¹åº”ç”¨ç¨‹åºçš„ç”¨æˆ·æ¥è¯´ä¹Ÿæ˜¯ä¸€ç§æ©æƒ ï¼Œå› ä¸ºä»–ä»¬ä¹Ÿä¸å¿…ä¸ºé‚£äº›éº»çƒ¦é—®é¢˜è€ŒçæŠ˜è…¾ã€‚ Boltä¸æ˜¯å…³ç³»å‹æ•°æ®åº“ã€‚ç”šè‡³ä¸å­˜å‚¨æ–‡æ¡£ï¼Œè™½ç„¶ä½ å¯ä»¥æŒ‰ç…§è¿™ç§æ–¹å¼ä½¿ç”¨å®ƒã€‚å…¶ä»…ä»…å­˜å‚¨é”®å€¼å¯¹â€¦ä½†æ˜¯å¦‚æœä½ ä¸çŸ¥é“è¿™æ˜¯ä»€ä¹ˆæ„æ€æˆ–è€…ä¸çŸ¥é“ä½ å¦‚ä½•ä½¿ç”¨å®ƒè¿›è¡Œå­˜å‚¨ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒã€‚å®ƒè¶…çº§ç®€å•ï¼Œè€Œä¸”éå¸¸çµæ´»ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ã€‚ ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-boltdb/:1:1","tags":["Go","bolt"],"title":"Go boltdb","uri":"/posts/2024-06-02-go-boltdb/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"2ã€ä½¿ç”¨ç¤ºä¾‹ï¼š boltå­˜å‚¨æ˜¯åˆ†ç»„ä¸ºæ¡¶ï¼Œæ¡¶æ˜¯ä¸€ç»„é”®å€¼å¯¹é›†åˆçš„åç§°ï¼Œå°±åƒGoä¸­çš„mapã€‚æ¡¶çš„åç§°ã€é”®ä»¥åŠå€¼éƒ½æ˜¯[]byteç±»å‹ã€‚æ¡¶å¯ä»¥åŒ…æ‹¬å…¶ä»–æ¡¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡[]byteç±»å‹åç§°ä½œä¸ºkeyã€‚ BoltåŸºæœ¬ä¸Šæ˜¯ä¸€ç»„åµŒå¥—æ˜ å°„ã€‚è¿™ç§ç®€å•æ€§ä½¿å¾—å®ƒæ˜“äºä½¿ç”¨ã€‚ä¸éœ€è¦è®¾ç½®è¡¨ã€æ¨¡å¼ã€å¤æ‚çš„æŸ¥è¯¢è¯­è¨€ã€‚ 1ï¼‰åˆ›å»ºå’Œæ‰“å¼€ä¸€ä¸ªæ•°æ®åº“ package main import ( \"log\" bolt \"go.etcd.io/bbolt\" ) func main() { // Open the my.db data file in your current directory. // It will be created if it doesn't exist. db, err := bolt.Open(\"my.db\", 0600, nil) if err != nil { log.Fatal(err) } defer db.Close() ... } è¿™é‡Œåˆ° db ä¸æ”¯æŒå¤šé“¾æ¥ã€‚è¿™æ˜¯å› ä¸ºå¯¹äº database file ä¸€ä¸ªé“¾æ¥ä¿æŒäº†ä¸€ä¸ªæ–‡ä»¶é” file lockã€‚å¦‚æœå¹¶å‘ï¼Œåç»­é“¾æ¥ä¼šé˜»å¡ã€‚å¯ä»¥ä¸ºå•ä¸ªé“¾æ¥æ·»åŠ  è¶…æ—¶æ§åˆ¶ db, err := bolt.Open(\"my.db\", 0600, \u0026bolt.Options{Timeout: 1 * time.Second}) ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-boltdb/:1:2","tags":["Go","bolt"],"title":"Go boltdb","uri":"/posts/2024-06-02-go-boltdb/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"3ã€äº‹åŠ¡ å¹¶å‘è¯»å†™ åŒæ—¶åªèƒ½æœ‰ ä¸€ä¸ªè¯»å†™äº‹åŠ¡ å¤šä¸ªåªè¯»äº‹åŠ¡ æ³¨æ„ï¼šåœ¨äº‹åŠ¡å¼€å§‹æ—¶ï¼Œä¼šä¿æŒä¸€ä¸ªæ•°æ®è§†å›¾ è¿™æ„å‘³ç€äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­ä¸ä¼šç”±äºåˆ«å¤„æ›´æ”¹è€Œæ”¹å˜ çº¿ç¨‹å®‰å…¨ å•ä¸ªäº‹åŠ¡å’Œå®ƒæ‰€åˆ›å»ºçš„æ‰€æœ‰å¯¹è±¡ï¼ˆæ¡¶ï¼Œé”®ï¼‰éƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ å»ºè®®åŠ é” æˆ–è€… æ¯ä¸€ä¸ª goroutine å¹¶å‘éƒ½å¼€å¯ ä¸€ä¸ª äº‹åŠ¡ å½“ç„¶ï¼Œä» db è¿™ä¸ª bbolt çš„é¡¶çº§ç»“æ„åˆ›å»º äº‹åŠ¡ æ˜¯ çº¿ç¨‹å®‰å…¨ çš„ æ­»é” å‰é¢æåˆ°çš„ è¯»å†™äº‹åŠ¡ å’Œ åªè¯»äº‹åŠ¡ æ‹’ç»ç›¸äº’ä¾èµ–ã€‚å½“ç„¶ä¹Ÿä¸èƒ½åœ¨åŒä¸€ä¸ª goroutine é‡Œã€‚ æ­»é”åŸå› æ˜¯ è¯»å†™äº‹åŠ¡ éœ€è¦å‘¨æœŸæ€§é‡æ–°æ˜ å°„ data æ–‡ä»¶ï¼ˆå³databaseï¼‰ã€‚è¿™åœ¨å¼€å¯åªè¯»äº‹åŠ¡æ—¶æ˜¯ä¸å¯è¡Œçš„ã€‚ è¯»å†™äº‹åŠ¡ ä½¿ç”¨ db.Updateå¼€å¯ä¸€ä¸ªè¯»å†™äº‹åŠ¡ err := db.Update(func(tx *bolt.Tx) error{ Â·Â·Â· return nil }) ä¸Šæ–‡æè¿‡ï¼Œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ ï¼Œæ•°æ®è§†å›¾æ˜¯ä¸€æ ·çš„ã€‚ ï¼ˆè¯¦ç»†è§£é‡Šå°±æ˜¯ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä½œç”¨åŸŸä¸­ï¼Œæ•°æ®å¯¹ä½ å‘ˆç°æœ€ç»ˆä¸€è‡´æ€§ï¼‰ è¿”å›å€¼ bboltdb æ ¹æ®ä½ çš„è¿”å›å€¼åˆ¤æ–­äº‹åŠ¡çŠ¶æ€ï¼Œä½ å¯ä»¥æ·»åŠ ä»»æ„é€»è¾‘å¹¶è®¤ä¸ºå‡ºé”™æ—¶è¿”å› return err bboltdb ä¼šå›æ»šï¼Œå¦‚æœ return nil åˆ™æäº¤ä½ çš„äº‹åŠ¡ã€‚ å»ºè®®æ°¸è¿œæ£€æŸ¥ Update çš„è¿”å›å€¼ï¼Œå› ä¸ºä»–ä¼šè¿”å›å¦‚ ç¡¬ç›˜å‹åŠ› ç­‰é€ æˆäº‹åŠ¡å¤±è´¥çš„ä¿¡æ¯ï¼ˆè¿™æ˜¯åœ¨ä½ çš„é€»è¾‘ä¹‹å¤–çš„æƒ…å†µï¼‰ æ³¨æ„ï¼šä½ è‡ªå®šä¹‰è¿”å› error çš„ error ä¿¡æ¯åŒæ ·ä¼šè¢«ä¼ é€’å‡ºæ¥ã€‚ åªè¯»äº‹åŠ¡ ä½¿ç”¨ db.View æ¥æ–°å»ºä¸€ä¸ª åªè¯»äº‹åŠ¡ err := db.View(func(tx *bolt.Tx) error { Â·Â·Â· return nil }) åŒä¸Šï¼Œä½ ä¼šè·å¾—ä¸€ä¸ªä¸€è‡´æ€§çš„æ•°æ®è§†å›¾ã€‚ å½“ç„¶ï¼Œåªè¯»äº‹åŠ¡ åªèƒ½æ£€ç´¢ä¿¡æ¯ï¼Œä¸ä¼šæœ‰ä»»ä½•æ›´æ”¹ã€‚ï¼ˆbtw,ä½†æ˜¯ä½ å¯ä»¥ copy ä¸€ä¸ª database çš„å‰¯æœ¬ï¼Œæ¯•ç«Ÿè¿™åªéœ€è¦è¯»æ•°æ®ï¼‰ æ‰¹é‡è¯»å†™äº‹åŠ¡ è¯»å†™äº‹åŠ¡ db.Update æœ€åéœ€è¦å¯¹ databaseæäº¤æ›´æ”¹ï¼Œè¿™ä¼šç­‰å¾…ç¡¬ç›˜å°±ç»ªã€‚ æ¯ä¸€æ¬¡æ–‡ä»¶è¯»å†™éƒ½æ˜¯å’Œç£ç›˜äº¤äº’ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªå°å¼€é”€ã€‚ ä½ å¯ä»¥ä½¿ç”¨ db.Batch å¼€å¯ä¸€ä¸ª æ‰¹å¤„ç†äº‹åŠ¡ã€‚ä»–ä¼šåœ¨æœ€åæ‰¹é‡æäº¤ï¼ˆå…¶å®æ˜¯å¤šä¸ª goroutines å¼€å¯ db.Batch äº‹åŠ¡æ—¶æœ‰æœºä¼šåˆå¹¶ä¹‹åä¸€èµ·æäº¤ï¼‰ä»è€Œå‡å°äº†å¼€é”€ã€‚ âš ï¸ï¼šdb.Batch åªå¯¹ goroutine èµ·æ•ˆ ä½¿ç”¨ æ‰¹å¤„ç†äº‹åŠ¡ éœ€è¦åšå–èˆï¼Œç”¨ å¹‚ç­‰å‡½æ•° æ¢å– é€Ÿåº¦ âš ï¸ï¼š db.Batch åœ¨ä¸€éƒ¨åˆ†äº‹åŠ¡å¤±è´¥çš„æ—¶å€™ä¼šå°è¯•å¤šæ¬¡è°ƒç”¨é‚£äº›äº‹åŠ¡å‡½æ•°ï¼Œå¦‚æœä¸æ˜¯å¹‚ç­‰ä¼šé€ æˆä¸å¯é¢„çŸ¥çš„éæœ€ç»ˆä¸€è‡´æ€§ã€‚ ä¾‹ï¼šä½¿ç”¨äº‹åŠ¡å¤–çš„å˜é‡æ¥ä½¿ä½ çš„æ—¥å¿—ä¸é‚£ä¹ˆå¥‡æ€ª var id uint64 err := db.Batch(func(tx *bolt.Tx) error { // Find last key in bucket, decode as bigendian uint64, increment // by one, encode back to []byte, and add new key. ... id = newValue return nil }) if err != nil { return ... } fmt.Println(\"Allocated ID %d\", id) æ‰‹åŠ¨äº‹åŠ¡ å¯ä»¥æ‰‹åŠ¨è¿›è¡Œäº‹åŠ¡çš„ å¼€å¯ ï¼Œå›æ»šï¼Œæ–°å»ºå¯¹è±¡ï¼Œæäº¤ç­‰æ“ä½œã€‚å› ä¸ºæœ¬èº« db.Update å’Œ db.View å°±æ˜¯ä»–ä»¬çš„åŒ…è£… âš ï¸ï¼šæ‰‹åŠ¨äº‹åŠ¡è®°å¾— å…³é—­ ï¼ˆCloseï¼‰ å¼€å¯äº‹åŠ¡ä½¿ç”¨ db.Begin(bool) åŒæ—¶å‚æ•°ä»£è¡¨ç€æ˜¯å¦å¯ä»¥å†™æ“ä½œã€‚å¦‚ä¸‹ï¼š true - è¯»å†™äº‹åŠ¡ false - åªè¯»äº‹åŠ¡ // Start a writable transaction. tx, err := db.Begin(true) if err != nil { return err } defer tx.Rollback() // Use the transaction... _, err := tx.CreateBucket([]byte(\"MyBucket\")) if err != nil { return err } // Commit the transaction and check for error. if err := tx.Commit(); err != nil { return err } ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-boltdb/:1:3","tags":["Go","bolt"],"title":"Go boltdb","uri":"/posts/2024-06-02-go-boltdb/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"4ã€å­˜å‚¨ä¸buckets bucket æ¡¶æ˜¯é”®å€¼å¯¹çš„é›†åˆã€‚åœ¨ä¸€ä¸ªæ¡¶ä¸­ï¼Œé”®å€¼å”¯ä¸€ã€‚ 1ï¼‰åˆ›å»ºbucket ä½¿ç”¨ Tx.CreateBucket() å’Œ Tx.CreateBucketIfNotExists() å»ºç«‹ä¸€ä¸ªæ–°æ¡¶ï¼ˆæ¨èä½¿ç”¨ç¬¬äºŒä¸ªï¼‰ æ¥å—å‚æ•°æ˜¯æ¡¶çš„åå­— 2ï¼‰åˆ é™¤ ä½¿ç”¨ Tx.DeleteBucket() æ ¹æ®æ¡¶çš„åå­—æ¥åˆ é™¤ ç¤ºä¾‹ï¼š func main() { db, err := bbolt.Open(\"./data\", 0666, nil) if err != nil { log.Fatal(err) } defer db.Close() db.Update(func(tx *bbolt.Tx) error { b, err := tx.CreateBucketIfNotExists([]byte(\"MyBucket\")) if err != nil { return fmt.Errorf(\"create bucket: %v\", err) } if err = tx.DeleteBucket([]byte(\"MyBucket\")); err != nil { return err } return nil }) } 2ï¼‰KVå­˜å‚¨ Put: ä½¿ç”¨Bucket.Put()æ¥å­˜å‚¨é”®å€¼å¯¹ï¼Œæ¥æ”¶ä¸¤ä¸ª []byte ç±»å‹çš„å‚æ•° db.Update(func(tx *bolt.Tx) error { b := tx.Bucket([]byte(\"MyBucket\")) err := b.Put([]byte(\"answer\"), []byte(\"42\")) return err }) Get: ä½¿ç”¨ Bucket.Get() æ¥æŸ¥è¯¢é”®å€¼ã€‚å‚æ•°æ˜¯ä¸€ä¸ª []byteï¼ˆåˆ«å¿˜äº†è¿™æ¬¡æˆ‘ä»¬åªæ˜¯æŸ¥è¯¢ï¼Œå¯ä»¥ä½¿ç”¨ åªè¯»äº‹åŠ¡ï¼‰ db.View(func(tx *bolt.Tx) error { b := tx.Bucket([]byte(\"MyBucket\")) v := b.Get([]byte(\"answer\")) fmt.Printf(\"The answer is: %s\\n\", v) return nil }) ç»†å¿ƒä¼šæ³¨æ„åˆ°ï¼ŒGetæ˜¯ä¸ä¼šè¿”å› error çš„ï¼Œè¿™æ˜¯å› ä¸º Get() ä¸€å®šèƒ½æ­£å¸¸å·¥ä½œï¼ˆé™¤éç³»ç»Ÿé”™è¯¯ï¼‰ï¼Œç›¸åº”çš„ï¼Œå½“è¿”å› nil æ—¶ï¼ŒæŸ¥è¯¢çš„é”®å€¼å¯¹ä¸å­˜åœ¨ã€‚ âš ï¸ï¼šæ³¨æ„ 0 é•¿åº¦çš„å€¼ å’Œ ä¸å­˜åœ¨é”®å€¼å¯¹ çš„è¡Œä¸ºæ˜¯ä¸ä¸€æ ·çš„ã€‚ï¼ˆä¸€ä¸ªè¿”å›æ˜¯ nilï¼Œ ä¸€ä¸ªä¸æ˜¯ï¼‰ func main() { db, err := bolt.Open(\"./data.db\", 0666, nil) if err != nil { log.Fatal(err) } defer db.Close() err = db.Update(func(tx *bolt.Tx) error { b, err := tx.CreateBucketIfNotExists([]byte(\"MyBucket\")) if err != nil { return fmt.Errorf(\"create bucket: %v\", err) } if err = b.Put([]byte(\"answer\"), []byte(\"42\")); err != nil { return err } if err = b.Put([]byte(\"zero\"), []byte(\"\")); err != nil { return err } return nil }) db.View(func(tx *bolt.Tx) error { b := tx.Bucket([]byte(\"MyBucket\")) v := b.Get([]byte(\"noexists\")) fmt.Println(reflect.DeepEqual(v, nil)) // false fmt.Println(v == nil) // true v = b.Get([]byte(\"zero\")) fmt.Println(reflect.DeepEqual(v, nil)) // false fmt.Println(v == nil) // true return nil }) } Delete: ä½¿ç”¨ Bucket.Delete() åˆ é™¤é”®å€¼å¯¹ db.View(func(tx *bolt.Tx) error { b := tx.Bucket([]byte(\"MyBucket\")) fmt.Println(b.Get([]byte(\"answer\"))) err := b.Delete([]byte(\"answer\")) if err != nil { return err } return nil }) âš ï¸ï¼š Get() è·å–åˆ°çš„å­—èŠ‚åˆ‡ç‰‡å€¼åªåœ¨å½“å‰äº‹åŠ¡ï¼ˆå½“å‰å‡½æ•°ä½œç”¨åŸŸï¼‰æœ‰æ•ˆï¼Œå¦‚æœè¦åœ¨å…¶ä»–äº‹åŠ¡ä¸­ä½¿ç”¨éœ€è¦ä½¿ç”¨ copy() å°†å…¶æ‹·è´åˆ°å…¶ä»–çš„å­—èŠ‚åˆ‡ç‰‡ Tricks: æ¡¶çš„è‡ªå¢é”® ä½¿ç”¨ NextSequence()æ¥åˆ›å»ºè‡ªå¢é”®ï¼Œè§ä¸‹ä¾‹ // CreateUser saves u to the store. The new user ID is set on u once the data is persisted. func (s *Store) CreateUser(u *User) error { return s.db.Update(func(tx *bolt.Tx) error { // Retrieve the users bucket. // This should be created when the DB is first opened. b := tx.Bucket([]byte(\"users\")) // Generate ID for the user. // This returns an error only if the Tx is closed or not writeable. // That can't happen in an Update() call so I ignore the error check. id, _ := b.NextSequence() u.ID = int(id) // Marshal user data into bytes. buf, err := json.Marshal(u) if err != nil { return err } // Persist bytes to users bucket. return b.Put(itob(u.ID), buf) }) } // itob returns an 8-byte big endian representation of v. func itob(v int) []byte { b := make([]byte, 8) binary.BigEndian.PutUint64(b, uint64(v)) return b } type User struct { ID int ... } åµŒå¥—æ¡¶ å¾ˆç®€å•çš„ï¼Œæ¡¶å¯ä»¥å®ç°åµŒå¥—å­˜å‚¨ func (*Bucket) CreateBucket(key []byte) (*Bucket, error) func (*Bucket) CreateBucketIfNotExists(key []byte) (*Bucket, error) func (*Bucket) DeleteBucket(key []byte) error ä¾‹å­ï¼šå‡è®¾æ‚¨æœ‰ä¸€ä¸ªå¤šç§Ÿæˆ·åº”ç”¨ç¨‹åºï¼Œå…¶ä¸­æ ¹çº§åˆ«å­˜å‚¨æ¡¶æ˜¯å¸æˆ·å­˜å‚¨æ¡¶ã€‚è¯¥å­˜å‚¨æ¡¶å†…éƒ¨æœ‰ä¸€ç³»åˆ—å¸æˆ·çš„åºåˆ—ï¼Œè¿™äº›å¸æˆ·æœ¬èº«å°±æ˜¯å­˜å‚¨æ¡¶ã€‚åœ¨åºåˆ—å­˜å‚¨æ¡¶ï¼ˆå­æ¡¶ï¼‰ä¸­ï¼Œå¯èƒ½æœ‰è®¸å¤šç›¸å…³çš„å­˜å‚¨æ¡¶ï¼ˆUsersï¼ŒNoteç­‰ï¼‰ã€‚ // createUser creates a new user in the given account. func createUser(accountID int, u *User) error { // Start the transaction. tx, err := db.Begin(true) if err != nil { return err } defer tx.Rollback() // Retrieve the root bucket for the account. // Assume this has already been created when the account was set up. root := tx.Bucket([]byte(strconv.FormatUint(accountID, 10))) // Setup the users bucket. bkt, err := root.CreateBucketIfNotExists([]byte(\"USERS\")) if err != nil { return err } // Generate an ID for the new user. userID, err := bkt.NextSequence() if err != nil { return err } u.ID = userID // Marshal and save the encoded user. if buf, err := json.Marshal(u); err != nil { return err } else if err := bkt.Put([]byte(strconv.FormatUint(u.ID, 10)),","date":"2024-06-02","objectID":"/posts/2024-06-02-go-boltdb/:1:4","tags":["Go","bolt"],"title":"Go boltdb","uri":"/posts/2024-06-02-go-boltdb/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"5ã€é«˜çº§ç”¨æ³• boltdb æ˜¯ä¸€ä¸ªå•ä¸€çš„æ–‡ä»¶ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å¤‡ä»½ã€‚ä½ å¯ä»¥ä½¿ç”¨Tx.writeto()å‡½æ•°å†™ä¸€è‡´çš„æ•°æ®åº“ã€‚å¦‚æœä»åªè¯»äº‹åŠ¡è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå®ƒå°†æ‰§è¡Œçƒ­å¤‡ä»½ï¼Œè€Œä¸ä¼šé˜»å¡å…¶ä»–æ•°æ®åº“çš„è¯»å†™æ“ä½œã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå°†ä½¿ç”¨ä¸€ä¸ªå¸¸è§„æ–‡ä»¶å¥æŸ„ï¼Œè¯¥å¥æŸ„å°†åˆ©ç”¨æ“ä½œç³»ç»Ÿçš„é¡µé¢ç¼“å­˜ã€‚ æœ‰å…³ä¼˜åŒ–å¤§äºRAMæ•°æ®é›†çš„ä¿¡æ¯ï¼Œè¯·å‚è§Txæ–‡æ¡£ã€‚ ä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹æ˜¯åœ¨HTTPä¸Šè¿›è¡Œå¤‡ä»½ï¼Œè¿™æ ·æ‚¨å°±å¯ä»¥ä½¿ç”¨åƒcURLè¿™æ ·çš„å·¥å…·æ¥è¿›è¡Œæ•°æ®åº“å¤‡ä»½ï¼š func BackupHandleFunc(w http.ResponseWriter, req *http.Request) { err := db.View(func(tx *bolt.Tx) error { w.Header().Set(\"Content-Type\", \"application/octet-stream\") w.Header().Set(\"Content-Disposition\", `attachment; filename=\"my.db\"`) w.Header().Set(\"Content-Length\", strconv.Itoa(int(tx.Size()))) _, err := tx.WriteTo(w) return err }) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) } } ç„¶åæ‚¨å¯ä»¥ä½¿ç”¨æ­¤å‘½ä»¤è¿›è¡Œå¤‡ä»½ï¼š $ curl http://localhost/backup \u003e my.db æˆ–è€…ä½ å¯ä»¥æ‰“å¼€ä½ çš„æµè§ˆå™¨ä»¥http://localhost/backupï¼Œå®ƒä¼šè‡ªåŠ¨ä¸‹è½½ã€‚ å¦‚æœä½ æƒ³å¤‡ä»½åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ï¼Œä½ å¯ä»¥ä½¿ç”¨TX.copyfile()è¾…åŠ©åŠŸèƒ½ã€‚ Statistics æ•°æ®åº“å¯¹è¿è¡Œçš„è®¸å¤šå†…éƒ¨æ“ä½œä¿æŒä¸€ä¸ªè¿è¡Œè®¡æ•°ï¼Œè¿™æ ·æ‚¨å°±å¯ä»¥æ›´å¥½åœ°äº†è§£å‘ç”Ÿäº†ä»€ä¹ˆã€‚é€šè¿‡æ•æ‰ä¸¤ä¸ªæ—¶é—´ç‚¹æ•°æ®çš„å¿«ç…§ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨è¿™ä¸ªæ—¶é—´èŒƒå›´å†…æ‰§è¡Œäº†å“ªäº›æ“ä½œã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª goroutine é‡Œè®°å½•ç»Ÿè®¡æ¯ä¸€ä¸ª 10 ç§’ï¼š go func() { // Grab the initial stats. prev := db.Stats() for { // Wait for 10s. time.Sleep(10 * time.Second) // Grab the current stats and diff them. stats := db.Stats() diff := stats.Sub(\u0026prev) // Encode stats to JSON and print to STDERR. json.NewEncoder(os.Stderr).Encode(diff) // Save stats for the next loop. prev = stats } }() å°†è¿™äº›ä¿¡æ¯é€šè¿‡ç®¡é“è¾“å‡ºåˆ°ç›‘æ§ä¹Ÿå¾ˆæœ‰ç”¨ã€‚ Read-Only Mode å¯ä»¥å¼€å¯åªè¯»æ¨¡å¼é˜²æ­¢é”™è¯¯æ›´æ”¹ db, err := bolt.Open(\"my.db\", 0666, \u0026bolt.Options{ReadOnly: true}) if err != nil { log.Fatal(err) } ç°åœ¨ä½¿ç”¨ db.Update() ç­‰å¼€å¯è¯»å†™äº‹åŠ¡ å°†ä¼šé˜»å¡ Mobile Use ç§»åŠ¨ç«¯æ”¯æŒç”± gomobile å·¥å…·æä¾› Create a struct that will contain your database logic and a reference to a *bolt.DB with a initializing constructor that takes in a filepath where the database file will be stored. Neither Android nor iOS require extra permissions or cleanup from using this method. func NewBoltDB(filepath string) *BoltDB { db, err := bolt.Open(filepath+\"/demo.db\", 0600, nil) if err != nil { log.Fatal(err) } return \u0026BoltDB{db} } type BoltDB struct { db *bolt.DB ... } func (b *BoltDB) Path() string { return b.db.Path() } func (b *BoltDB) Close() { b.db.Close() } Database logic should be defined as methods on this wrapper struct. To initialize this struct from the native language (both platforms now sync their local storage to the cloud. These snippets disable that functionality for the database file): Android String path; if (android.os.Build.VERSION.SDK_INT \u003e=android.os.Build.VERSION_CODES.LOLLIPOP){ path = getNoBackupFilesDir().getAbsolutePath(); } else{ path = getFilesDir().getAbsolutePath(); } Boltmobiledemo.BoltDB boltDB = Boltmobiledemo.NewBoltDB(path) iOS - (void)demo { NSString* path = [NSSearchPathForDirectoriesInDomains(NSLibraryDirectory, NSUserDomainMask, YES) objectAtIndex:0]; GoBoltmobiledemoBoltDB * demo = GoBoltmobiledemoNewBoltDB(path); [self addSkipBackupAttributeToItemAtPath:demo.path]; //Some DB Logic would go here [demo close]; } - (BOOL)addSkipBackupAttributeToItemAtPath:(NSString *) filePathString { NSURL* URL= [NSURL fileURLWithPath: filePathString]; assert([[NSFileManager defaultManager] fileExistsAtPath: [URL path]]); NSError *error = nil; BOOL success = [URL setResourceValue: [NSNumber numberWithBool: YES] forKey: NSURLIsExcludedFromBackupKey error: \u0026error]; if(!success){ NSLog(@\"Error excluding %@ from backup %@\", [URL lastPathComponent], error); } return success; } ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-boltdb/:1:5","tags":["Go","bolt"],"title":"Go boltdb","uri":"/posts/2024-06-02-go-boltdb/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"6ã€æ‰©å±•é˜…è¯» æ›´å¤šæŒ‡å¯¼ For more information on getting started with Bolt, check out the following articles: Intro to BoltDB: Painless Performant Persistence by Nate Finch. Bolt â€“ an embedded key/value database for Go by Progville ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-boltdb/:1:6","tags":["Go","bolt"],"title":"Go boltdb","uri":"/posts/2024-06-02-go-boltdb/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"7ã€ä¸å…¶ä»–æ•°æ®åº“çš„æ¯”è¾ƒ Postgresï¼ŒMySQLå’Œå…¶ä»–å…³ç³»æ•°æ®åº“ å…³ç³»æ•°æ®åº“å°†æ•°æ®ç»„ç»‡æˆè¡Œï¼Œå¹¶ä¸”åªèƒ½é€šè¿‡ä½¿ç”¨SQLè¿›è¡Œè®¿é—®ã€‚è¿™ç§æ–¹æ³•åœ¨å­˜å‚¨å’ŒæŸ¥è¯¢æ•°æ®æ–¹é¢æä¾›äº†çµæ´»æ€§ï¼Œä½†æ˜¯åœ¨è§£æå’Œè®¡åˆ’SQLè¯­å¥æ—¶ä¹Ÿä¼šäº§ç”Ÿå¼€é”€ã€‚Bolté€šè¿‡å­—èŠ‚åˆ‡ç‰‡é”®è®¿é—®æ‰€æœ‰æ•°æ®ã€‚è¿™ä½¿å¾—Boltå¯ä»¥å¿«é€Ÿåœ°é€šè¿‡é”®è¯»å–å’Œå†™å…¥æ•°æ®ï¼Œä½†æ˜¯ä¸æä¾›å°†å€¼è¿æ¥åœ¨ä¸€èµ·çš„å†…ç½®æ”¯æŒã€‚ å¤§å¤šæ•°å…³ç³»æ•°æ®åº“ï¼ˆSQLiteé™¤å¤–ï¼‰éƒ½æ˜¯ç‹¬ç«‹äºåº”ç”¨ç¨‹åºè¿è¡Œçš„ç‹¬ç«‹æœåŠ¡å™¨ã€‚è¿™ä½¿æ‚¨çš„ç³»ç»Ÿå…·æœ‰å°†å¤šä¸ªåº”ç”¨ç¨‹åºæœåŠ¡å™¨è¿æ¥åˆ°å•ä¸ªæ•°æ®åº“æœåŠ¡å™¨çš„çµæ´»æ€§ï¼Œä½†åŒæ—¶ä¹Ÿå¢åŠ äº†åœ¨ç½‘ç»œä¸Šåºåˆ—åŒ–å’Œä¼ è¾“æ•°æ®çš„å¼€é”€ã€‚Boltä½œä¸ºåº”ç”¨ç¨‹åºä¸­åŒ…å«çš„åº“è¿è¡Œï¼Œå› æ­¤æ‰€æœ‰æ•°æ®è®¿é—®éƒ½å¿…é¡»ç»è¿‡åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ã€‚è¿™ä½¿æ•°æ®æ›´æ¥è¿‘æ‚¨çš„åº”ç”¨ç¨‹åºï¼Œä½†é™åˆ¶äº†å¯¹æ•°æ®çš„å¤šè¿›ç¨‹è®¿é—®ã€‚ LevelDBï¼ŒRocksDB LevelDBåŠå…¶æ´¾ç”Ÿç±»ï¼ˆRocksDBï¼ŒHyperLevelDBï¼‰ä¸Boltç±»ä¼¼ï¼Œå› ä¸ºå®ƒä»¬æ˜¯æ†ç»‘åˆ°åº”ç”¨ç¨‹åºä¸­çš„åº“ï¼Œä½†æ˜¯å®ƒä»¬çš„åº•å±‚ç»“æ„æ˜¯æ—¥å¿—ç»“æ„çš„åˆå¹¶æ ‘ï¼ˆLSMæ ‘ï¼‰ã€‚LSMæ ‘é€šè¿‡ä½¿ç”¨é¢„å†™æ—¥å¿—å’Œç§°ä¸ºSSTablesçš„å¤šå±‚æ’åºæ–‡ä»¶æ¥ä¼˜åŒ–éšæœºå†™å…¥ã€‚Boltåœ¨å†…éƒ¨ä½¿ç”¨B +æ ‘ï¼Œå¹¶ä¸”ä»…ä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶ã€‚ä¸¤ç§æ–¹æ³•éƒ½éœ€è¦æƒè¡¡ã€‚ å¦‚æœæ‚¨éœ€è¦è¾ƒé«˜çš„éšæœºå†™å…¥ååé‡ï¼ˆ\u003e 10,000 w / secï¼‰ï¼Œæˆ–è€…éœ€è¦ä½¿ç”¨æ—‹è½¬ç£ç›˜ï¼Œé‚£ä¹ˆLevelDBå¯èƒ½æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºæ˜¯å¤§é‡è¯»å–æˆ–è¿›è¡Œå¤§é‡èŒƒå›´æ‰«æï¼Œé‚£ä¹ˆBoltå¯èƒ½æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ å¦ä¸€ä¸ªé‡è¦çš„è€ƒè™‘å› ç´ æ˜¯LevelDBæ²¡æœ‰äº‹åŠ¡ã€‚å®ƒæ”¯æŒé”®/å€¼å¯¹çš„æ‰¹é‡å†™å…¥ï¼Œå¹¶ä¸”æ”¯æŒè¯»å–å¿«ç…§ï¼Œä½†ä¸èƒ½ä½¿æ‚¨å®‰å…¨åœ°æ‰§è¡Œæ¯”è¾ƒå’Œäº¤æ¢æ“ä½œã€‚Boltæ”¯æŒå®Œå…¨å¯åºåˆ—åŒ–çš„ACIDäº‹åŠ¡ã€‚ LMDB Boltæœ€åˆæ˜¯LMDBçš„ç«¯å£ï¼Œå› æ­¤åœ¨æ¶æ„ä¸Šç›¸ä¼¼ã€‚ä¸¤è€…éƒ½ä½¿ç”¨B +æ ‘ï¼Œå…·æœ‰ACIDè¯­ä¹‰å’Œå®Œå…¨å¯åºåˆ—åŒ–çš„äº‹åŠ¡ï¼Œå¹¶æ”¯æŒä½¿ç”¨å•ä¸ªå†™å…¥å™¨å’Œå¤šä¸ªè¯»å–å™¨çš„æ— é”MVCCã€‚ è¿™ä¸¤ä¸ªé¡¹ç›®æœ‰äº›åˆ†æ­§ã€‚LMDBä¸“æ³¨äºåŸå§‹æ€§èƒ½ï¼Œè€ŒBoltä¸“æ³¨äºç®€å•æ€§å’Œæ˜“ç”¨æ€§ã€‚ä¾‹å¦‚ï¼Œå‡ºäºæ€§èƒ½è€ƒè™‘ï¼ŒLMDBå…è®¸æ‰§è¡Œå‡ ç§ä¸å®‰å…¨çš„æ“ä½œï¼Œä¾‹å¦‚ç›´æ¥å†™å…¥ã€‚Bolté€‰æ‹©ç¦æ­¢å¯èƒ½ä½¿æ•°æ®åº“å¤„äºæŸåçŠ¶æ€çš„æ“ä½œã€‚Boltå”¯ä¸€çš„ä¾‹å¤–æ˜¯DB.NoSyncã€‚ APIä¹Ÿæœ‰ä¸€äº›åŒºåˆ«ã€‚æ‰“å¼€LMDBæ—¶éœ€è¦æœ€å¤§çš„mmapå¤§å°ï¼Œmdb_envè€ŒBoltä¼šè‡ªåŠ¨å¤„ç†å¢é‡mmapçš„å¤§å°ã€‚LMDBä½¿ç”¨å¤šä¸ªæ ‡å¿—æ¥é‡è½½getterå’Œsetterå‡½æ•°ï¼Œè€ŒBoltå°†è¿™äº›ç‰¹æ®Šæƒ…å†µæ‹†åˆ†ä¸ºè‡ªå·±çš„å‡½æ•°ã€‚ ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-boltdb/:1:7","tags":["Go","bolt"],"title":"Go boltdb","uri":"/posts/2024-06-02-go-boltdb/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"7ã€æ³¨æ„äº‹é¡¹å’Œå±€é™æ€§ é€‰æ‹©åˆé€‚çš„å·¥å…·æ¥å®Œæˆè¿™é¡¹å·¥ä½œå¾ˆé‡è¦ï¼Œè€ŒBoltä¹Ÿä¸ä¾‹å¤–ã€‚åœ¨è¯„ä¼°å’Œä½¿ç”¨Boltæ—¶ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š Boltéå¸¸é€‚åˆè¯»å–å¯†é›†å‹å·¥ä½œè´Ÿè½½ã€‚é¡ºåºå†™å…¥æ€§èƒ½ä¹Ÿå¾ˆå¿«ï¼Œä½†æ˜¯éšæœºå†™å…¥å¯èƒ½ä¼šå¾ˆæ…¢ã€‚æ‚¨å¯ä»¥ä½¿ç”¨DB.Batch()æˆ–æ·»åŠ é¢„å†™æ—¥å¿—æ¥å¸®åŠ©ç¼“è§£æ­¤é—®é¢˜ã€‚ Boltåœ¨å†…éƒ¨ä½¿ç”¨B + treeï¼Œå› æ­¤å¯ä»¥æœ‰å¾ˆå¤šéšæœºé¡µé¢è®¿é—®ã€‚ä¸æ—‹è½¬ç£ç›˜ç›¸æ¯”ï¼ŒSSDå¯ä»¥æ˜¾ç€æé«˜æ€§èƒ½ã€‚ å°è¯•é¿å…é•¿æ—¶é—´è¿è¡Œçš„è¯»å–äº‹åŠ¡ã€‚Boltä½¿ç”¨å†™æ—¶å¤åˆ¶åŠŸèƒ½ï¼Œå› æ­¤åœ¨æ—§äº‹åŠ¡ä½¿ç”¨æ—§é¡µæ—¶æ— æ³•å›æ”¶è¿™äº›æ—§é¡µã€‚ ä»Boltè¿”å›çš„å­—èŠ‚ç‰‡ä»…åœ¨äº‹åŠ¡æœŸé—´æœ‰æ•ˆã€‚ä¸€æ—¦äº‹åŠ¡è¢«æäº¤æˆ–å›æ»šï¼Œå®ƒä»¬æ‰€æŒ‡å‘çš„å†…å­˜å°±å¯ä»¥è¢«æ–°é¡µé¢é‡ç”¨ï¼Œæˆ–è€…å¯ä»¥ä»è™šæ‹Ÿå†…å­˜ä¸­å–æ¶ˆæ˜ å°„ï¼Œunexpected fault addressè®¿é—®æ—¶ä¼šå‡ºç°ææ…Œã€‚ Boltåœ¨æ•°æ®åº“æ–‡ä»¶ä¸Šä½¿ç”¨æ’ä»–å†™é”å®šï¼Œå› æ­¤ä¸èƒ½è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ã€‚ ä½¿ç”¨æ—¶è¦å°å¿ƒBucket.FillPercentã€‚ä¸ºå…·æœ‰éšæœºæ’å…¥çš„å­˜å‚¨æ¡¶è®¾ç½®è¾ƒé«˜çš„å¡«å……ç™¾åˆ†æ¯”å°†å¯¼è‡´æ•°æ®åº“çš„é¡µé¢åˆ©ç”¨ç‡éå¸¸å·®ã€‚ é€šå¸¸ä½¿ç”¨è¾ƒå¤§çš„æ°´æ¡¶ã€‚è¾ƒå°çš„å­˜å‚¨æ¡¶ä¸€æ—¦è¶…è¿‡é¡µé¢å¤§å°ï¼ˆé€šå¸¸ä¸º4KBï¼‰ï¼Œå°±ä¼šå¯¼è‡´é¡µé¢åˆ©ç”¨ç‡ä¸‹é™ã€‚ æ‰¹é‡åŠ è½½å¤§é‡éšæœºå†™å…¥æ–°çš„å­˜å‚¨æ¡¶å¯èƒ½å¾ˆæ…¢ï¼Œå› ä¸ºåœ¨æäº¤äº‹åŠ¡ä¹‹å‰é¡µé¢ä¸ä¼šæ‹†åˆ†ã€‚å»ºè®®ä¸è¦åœ¨å•ä¸ªäº‹åŠ¡ä¸­å°†100,000ä¸ªä»¥ä¸Šçš„é”®/å€¼å¯¹éšæœºæ’å…¥åˆ°ä¸€ä¸ªæ–°çš„å­˜å‚¨æ¡¶ä¸­ã€‚ Boltä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œå› æ­¤åº•å±‚æ“ä½œç³»ç»Ÿå¯ä»¥å¤„ç†æ•°æ®çš„ç¼“å­˜ã€‚é€šå¸¸ï¼Œæ“ä½œç³»ç»Ÿå°†åœ¨å†…å­˜ä¸­ç¼“å­˜å°½å¯èƒ½å¤šçš„æ–‡ä»¶ï¼Œå¹¶æ ¹æ®éœ€è¦å°†å†…å­˜é‡Šæ”¾ç»™å…¶ä»–è¿›ç¨‹ã€‚è¿™æ„å‘³ç€åœ¨ä½¿ç”¨å¤§å‹æ•°æ®åº“æ—¶ï¼ŒBoltå¯èƒ½ä¼šæ˜¾ç¤ºå¾ˆé«˜çš„å†…å­˜ä½¿ç”¨ç‡ã€‚ä½†æ˜¯ï¼Œè¿™æ˜¯é¢„æ–™ä¹‹ä¸­çš„ï¼Œæ“ä½œç³»ç»Ÿå°†æ ¹æ®éœ€è¦é‡Šæ”¾å†…å­˜ã€‚åªè¦Boltçš„å†…å­˜æ˜ å°„é€‚åˆè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå®ƒå°±å¯ä»¥å¤„ç†æ¯”å¯ç”¨ç‰©ç†RAMå¤§å¾—å¤šçš„æ•°æ®åº“ã€‚åœ¨32ä½ç³»ç»Ÿä¸Šå¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚ Boltæ•°æ®åº“ä¸­çš„æ•°æ®ç»“æ„æ˜¯å†…å­˜æ˜ å°„çš„ï¼Œå› æ­¤æ•°æ®æ–‡ä»¶å°†æ˜¯ç‰¹å®šäºå­—èŠ‚åºçš„ã€‚è¿™æ„å‘³ç€æ‚¨æ— æ³•å°†Boltæ–‡ä»¶ä»å°å­—èŠ‚åºè®¡ç®—æœºå¤åˆ¶åˆ°å¤§å­—èŠ‚åºè®¡ç®—æœºå¹¶ä½¿å…¶æ­£å¸¸å·¥ä½œã€‚å¯¹äºå¤§å¤šæ•°ç”¨æˆ·è€Œè¨€ï¼Œè¿™ä¸æ˜¯é—®é¢˜ï¼Œå› ä¸ºå¤§å¤šæ•°ç°ä»£CPUçš„å­—èŠ‚åºéƒ½å¾ˆå°‘ã€‚ ç”±äºé¡µé¢åœ¨ç£ç›˜ä¸Šçš„å¸ƒå±€æ–¹å¼ï¼ŒBoltæ— æ³•æˆªæ–­æ•°æ®æ–‡ä»¶å¹¶å°†å¯ç”¨é¡µé¢è¿”å›åˆ°ç£ç›˜ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ï¼ŒBoltä¼šåœ¨å…¶æ•°æ®æ–‡ä»¶ä¸­ç»´æŠ¤æœªä½¿ç”¨é¡µé¢çš„ç©ºé—²åˆ—è¡¨ã€‚è¿™äº›ç©ºé—²é¡µé¢å¯ä»¥è¢«ä»¥åçš„äº‹åŠ¡é‡ç”¨ã€‚ç”±äºæ•°æ®åº“é€šå¸¸ä¼šå¢é•¿ï¼Œå› æ­¤è¿™åœ¨è®¸å¤šç”¨ä¾‹ä¸­æ•ˆæœå¾ˆå¥½ã€‚ä½†æ˜¯ï¼Œè¯·åŠ¡å¿…æ³¨æ„ï¼Œåˆ é™¤å¤§å—æ•°æ®å°†ä¸å…è®¸æ‚¨å›æ”¶ç£ç›˜ä¸Šçš„è¯¥ç©ºé—´ã€‚ æœ‰å…³é¡µé¢åˆ†é…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§æ­¤æ³¨é‡Šã€‚ ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-boltdb/:1:8","tags":["Go","bolt"],"title":"Go boltdb","uri":"/posts/2024-06-02-go-boltdb/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"é˜…è¯»èµ„æ–™ å¯¹äºåµŒå…¥å¼ï¼Œå¯åºåˆ—åŒ–çš„äº‹åŠ¡æ€§é”®/å€¼æ•°æ®åº“ï¼ŒBoltæ˜¯ä¸€ä¸ªç›¸å¯¹è¾ƒå°çš„ä»£ç åº“ï¼ˆ\u003c5KLOCï¼‰ï¼Œå› æ­¤å¯¹äºé‚£äº›å¯¹æ•°æ®åº“çš„å·¥ä½œæ–¹å¼æ„Ÿå…´è¶£çš„äººæ¥è¯´ï¼ŒBoltå¯èƒ½æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹ã€‚ æœ€ä½³èµ·ç‚¹æ˜¯Boltçš„ä¸»è¦åˆ‡å…¥ç‚¹ï¼š Open()-åˆå§‹åŒ–å¯¹æ•°æ®åº“çš„å¼•ç”¨ã€‚å®ƒè´Ÿè´£åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰ï¼Œè·å¾—æ–‡ä»¶çš„æ’ä»–é”ï¼Œè¯»å–å…ƒé¡µé¢ä»¥åŠå¯¹æ–‡ä»¶è¿›è¡Œå†…å­˜æ˜ å°„ã€‚ DB.Begin()-æ ¹æ®writableå‚æ•°çš„å€¼å¯åŠ¨åªè¯»æˆ–è¯»å†™äº‹åŠ¡ã€‚è¿™éœ€è¦çŸ­æš‚è·å¾—â€œå…ƒâ€é”ä»¥è·Ÿè¸ªæœªç»“äº¤æ˜“ã€‚ä¸€æ¬¡åªèƒ½å­˜åœ¨ä¸€ä¸ªè¯»å†™äº‹åŠ¡ï¼Œå› æ­¤åœ¨è¯»å†™äº‹åŠ¡æœŸé—´å°†è·å¾—â€œ rwlockâ€ã€‚ Bucket.Put()-å°†é”®/å€¼å¯¹å†™å…¥å­˜å‚¨æ¡¶ã€‚éªŒè¯å‚æ•°ä¹‹åï¼Œä½¿ç”¨å…‰æ ‡å°†B +æ ‘éå†åˆ°å°†é”®å’Œå€¼å†™å…¥çš„é¡µé¢å’Œä½ç½®ã€‚æ‰¾åˆ°ä½ç½®åï¼Œå­˜å‚¨æ¡¶ä¼šå°†åŸºç¡€é¡µé¢å’Œé¡µé¢çš„çˆ¶é¡µé¢å…·ä½“åŒ–ä¸ºâ€œèŠ‚ç‚¹â€åˆ°å†…å­˜ä¸­ã€‚è¿™äº›èŠ‚ç‚¹æ˜¯åœ¨è¯»å†™äº‹åŠ¡æœŸé—´å‘ç”Ÿçªå˜çš„åœ°æ–¹ã€‚æäº¤æœŸé—´ï¼Œè¿™äº›æ›´æ”¹å°†åˆ·æ–°åˆ°ç£ç›˜ã€‚ Bucket.Get()-ä»å­˜å‚¨æ¡¶ä¸­æ£€ç´¢é”®/å€¼å¯¹ã€‚è¿™ä½¿ç”¨å…‰æ ‡ç§»åŠ¨åˆ°é”®/å€¼å¯¹çš„é¡µé¢å’Œä½ç½®ã€‚åœ¨åªè¯»äº‹åŠ¡æœŸé—´ï¼Œé”®å’Œå€¼æ•°æ®å°†ä½œä¸ºå¯¹åŸºç¡€mmapæ–‡ä»¶çš„ç›´æ¥å¼•ç”¨è¿”å›ï¼Œå› æ­¤æ²¡æœ‰åˆ†é…å¼€é”€ã€‚å¯¹äºè¯»å†™äº‹åŠ¡ï¼Œæ­¤æ•°æ®å¯ä»¥å¼•ç”¨mmapæ–‡ä»¶æˆ–å†…å­˜èŠ‚ç‚¹å€¼ä¹‹ä¸€ã€‚ Cursor-è¯¥å¯¹è±¡ä»…ç”¨äºéå†ç£ç›˜é¡µæˆ–å†…å­˜èŠ‚ç‚¹çš„B +æ ‘ã€‚å®ƒå¯ä»¥æŸ¥æ‰¾ç‰¹å®šçš„é”®ï¼Œç§»è‡³ç¬¬ä¸€ä¸ªæˆ–æœ€åä¸€ä¸ªå€¼ï¼Œä¹Ÿå¯ä»¥å‘å‰æˆ–å‘åç§»åŠ¨ã€‚å…‰æ ‡å¯¹æœ€ç»ˆç”¨æˆ·é€æ˜åœ°å¤„ç†B +æ ‘çš„ä¸Šä¸‹ç§»åŠ¨ã€‚ Tx.Commit()-å°†å†…å­˜ä¸­çš„è„èŠ‚ç‚¹å’Œå¯ç”¨é¡µé¢åˆ—è¡¨è½¬æ¢ä¸ºè¦å†™å…¥ç£ç›˜çš„é¡µé¢ã€‚ç„¶åå†™å…¥ç£ç›˜åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µã€‚é¦–å…ˆï¼Œè„é¡µè¢«å†™å…¥ç£ç›˜å¹¶fsync()å‘ç”Ÿã€‚å…¶æ¬¡ï¼Œå†™å…¥å…·æœ‰é€’å¢çš„äº‹åŠ¡IDçš„æ–°å…ƒé¡µé¢ï¼Œç„¶åfsync()å‘ç”Ÿå¦ä¸€ä¸ªé¡µé¢ ã€‚è¿™ä¸¤ä¸ªé˜¶æ®µçš„å†™å…¥æ“ä½œç¡®ä¿å´©æºƒæ—¶ä¼šå¿½ç•¥éƒ¨åˆ†å†™å…¥çš„æ•°æ®é¡µï¼Œå› ä¸ºæŒ‡å‘å®ƒä»¬çš„å…ƒé¡µä¸ä¼šè¢«å†™å…¥ã€‚éƒ¨åˆ†å†™å…¥çš„å…ƒé¡µé¢æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºå®ƒä»¬æ˜¯ç”¨æ ¡éªŒå’Œå†™å…¥çš„ã€‚ å¦‚æœæ‚¨è¿˜æœ‰å…¶ä»–å¯èƒ½å¯¹ä»–äººæœ‰ç”¨çš„æ³¨é‡Šï¼Œè¯·é€šè¿‡è¯·æ±‚è¯·æ±‚å°†å…¶æäº¤ã€‚ ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-boltdb/:2:0","tags":["Go","bolt"],"title":"Go boltdb","uri":"/posts/2024-06-02-go-boltdb/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å…¶ä»–ä½¿ç”¨Boltçš„é¡¹ç›® ä»¥ä¸‹æ˜¯ä½¿ç”¨Boltçš„å…¬å…±å¼€æºé¡¹ç›®çš„åˆ—è¡¨ï¼š Algernon - A HTTP/2 web server with built-in support for Lua. Uses BoltDB as the default database backend. Bazil - A file system that lets your data reside where it is most convenient for it to reside. bolter - Command-line app for viewing BoltDB file in your terminal. boltcli - the redis-cli for boltdb with Lua script support. BoltHold - An embeddable NoSQL store for Go types built on BoltDB BoltStore - Session store using Bolt. Boltdb Boilerplate - Boilerplate wrapper around bolt aiming to make simple calls one-liners. BoltDbWeb - A web based GUI for BoltDB files. bleve - A pure Go search engine similar to ElasticSearch that uses Bolt as the default storage backend. btcwallet - A bitcoin wallet. buckets - a bolt wrapper streamlining simple tx and key scans. cayley - Cayley is an open-source graph database using Bolt as optional backend. ChainStore - Simple key-value interface to a variety of storage engines organized as a chain of operations. Consul - Consul is service discovery and configuration made easy. Distributed, highly available, and datacenter-aware. DVID - Added Bolt as optional storage engine and testing it against Basho-tuned leveldb. dcrwallet - A wallet for the Decred cryptocurrency. drive - drive is an unofficial Google Drive command line client for *NIX operating systems. event-shuttle - A Unix system service to collect and reliably deliver messages to Kafka. Freehold - An open, secure, and lightweight platform for your files and data. Go Report Card - Go code quality report cards as a (free and open source) service. GoWebApp - A basic MVC web application in Go using BoltDB. GoShort - GoShort is a URL shortener written in Golang and BoltDB for persistent key/value storage and for routing itâ€™s using high performent HTTPRouter. gopherpit - A web service to manage Go remote import paths with custom domains Gitchain - Decentralized, peer-to-peer Git repositories aka â€œGit meets Bitcoinâ€. InfluxDB - Scalable datastore for metrics, events, and real-time analytics. ipLocator - A fast ip-geo-location-server using bolt with bloom filters. ipxed - Web interface and api for ipxed. Ironsmith - A simple, script-driven continuous integration (build - \u003e test -\u003e release) tool, with no external dependencies Kala - Kala is a modern job scheduler optimized to run on a single node. It is persistent, JSON over HTTP API, ISO 8601 duration notation, and dependent jobs. Key Value Access Langusge (KVAL) - A proposed grammar for key-value datastores offering a bbolt binding. LedisDB - A high performance NoSQL, using Bolt as optional storage. lru - Easy to use Bolt-backed Least-Recently-Used (LRU) read-through cache with chainable remote stores. mbuckets - A Bolt wrapper that allows easy operations on multi level (nested) buckets. MetricBase - Single-binary version of Graphite. MuLiFS - Music Library Filesystem creates a filesystem to organise your music files. NATS - NATS Streaming uses bbolt for message and metadata storage. Operation Go: A Routine Mission - An online programming game for Golang using Bolt for user accounts and a leaderboard. photosite/session - Sessions for a photo viewing site. Prometheus Annotation Server - Annotation server for PromDash \u0026 Prometheus service monitoring system. reef-pi - reef-pi is an award winning, modular, DIY reef tank controller using easy to learn electronics based on a Raspberry Pi. Request Baskets - A web service to collect arbitrary HTTP requests and inspect them via REST API or simple web UI, similar to RequestBin service Seaweed File System - Highly scalable distributed key~file system with O(1) disk read. stow - a persistence manager for objects backed by boltdb. Storm - Simple and powerful ORM for BoltDB. SimpleBolt - A simple way to use BoltDB. Deals mainly with strings. Skybox Analytics - A standalone funnel analysis tool for web analytics. Scuttlebutt - Uses Bolt to store and process all Twitter mentions of GitHub projects. tentacool - REST api server ","date":"2024-06-02","objectID":"/posts/2024-06-02-go-boltdb/:3:0","tags":["Go","bolt"],"title":"Go boltdb","uri":"/posts/2024-06-02-go-boltdb/"},{"categories":["linux"],"content":"LVM Logical Volume Management é€»è¾‘å·ç®¡ç† ä¼˜åŠ¿ï¼š åœ¨çº¿æ‰©å±•/ç¼©å‡å­˜å‚¨ç©ºé—´/æ•´åˆçç¢ç©ºé—´ æ”¯æŒå¿«ç…§ Device Mapperè®¾å¤‡æ˜ å°„ lvmç»„ç»‡æ–¹å¼ï¼š çœŸå®å­˜å‚¨è®¾å¤‡ --- pv(ç‰©ç†å·) --- vg(å·ç»„) --- lv(é€»è¾‘å·) ---- åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ --- æŒ‚è½½ä½¿ç”¨ ","date":"2024-05-27","objectID":"/posts/2024-05-27-linux-lvm/:1:0","tags":["lvm","linux-lvm"],"title":"lvm","uri":"/posts/2024-05-27-linux-lvm/"},{"categories":["linux"],"content":"ç›¸å…³å‘½ä»¤ 1ã€pv(ç‰©ç†å·) 1) æŸ¥çœ‹ç‰©ç†å· pvscan 2) åˆ›å»ºç‰©ç†å· pvcreate disk/partition 3) åˆ é™¤ç‰©ç†å· pvremove pv_name 2ã€vg(å·ç»„) 1) æŸ¥çœ‹å·ç»„ [root@node01 ~]# vgscan [root@node01 ~]# vgdisplay vg_name 2) åˆ›å»ºå·ç»„ vgcreate vg_name pv_name pv_name .... 3) åˆ é™¤å·ç»„ vgremove vg_name 3ã€lv(é€»è¾‘å·) 1) æŸ¥çœ‹é€»è¾‘å· [root@node01 ~]# lvscan ACTIVE '/dev/centos/swap' [2.00 GiB] inherit ACTIVE '/dev/centos/root' [\u003c17.00 GiB] inherit [root@node01 ~]# lvdisplay /dev/centos/swap 2) åˆ›å»ºé€»è¾‘å· lvcreate -L size -n lv_name vg_name lvcreate -L 400G -n lv01 vg01 3) åˆ é™¤é€»è¾‘å· lvremove /dev/vg01/lv01 æ“ä½œè¿‡ç¨‹ # pv 1.åˆ›å»ºpv pvcreate /dev/sda6 pvcreate /dev/sda7 2.æŸ¥è¯¢pv pvs pvdisplay # vg 1.åˆ›å»ºvg vgcreate vg0 /dev/sda6 /dev/sda7 2.æŸ¥è¯¢vg vgs vgdisplay # lv 1.åˆ›å»º lvcreate -L 700M -n lv0 vg0 -L size -n name 2.æŸ¥è¯¢ lvs lvdisplay æ ¼å¼åŒ– mkfs.xfs /dev/vg0/lv0 æŒ‚è½½ mount /dev/vg0/lv0 /mnt/ ç¤ºä¾‹ï¼šæ‰©å®¹è·Ÿåˆ†åŒº 1ã€åˆ›å»ºç‰©ç†å· [root@localhost ~]# pvcreate /dev/sdb Physical volume \"/dev/sdb\" successfully created. [root@localhost ~]# vgs VG #PV #LV #SN Attr VSize VFree centos 2 2 0 wz--n- 39.49g 0 [root@localhost ~]# lvs LV VG Attr LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert root centos -wi-ao---- \u003c19.00g swap centos -wi-ao---- 508.00m 2ã€ æ‰©å®¹å·ç»„ [root@localhost ~]# vgextend centos /dev/sdb Volume group \"centos\" successfully extended [root@localhost ~]# lvs LV VG Attr LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert root centos -wi-ao---- \u003c19.00g swap centos -wi-ao---- 508.00m 3ã€æ‰©å±•æ ¹é€»è¾‘å· [root@localhost ~]# lvextend -l +100%FREE /dev/centos/root Size of logical volume centos/root changed from \u003c19.00 GiB (4863 extents) to \u003c39.00 GiB (9983 extents). Logical volume centos/root successfully resized. [root@localhost ~]# df -Th æ–‡ä»¶ç³»ç»Ÿ ç±»å‹ å®¹é‡ å·²ç”¨ å¯ç”¨ å·²ç”¨% æŒ‚è½½ç‚¹ devtmpfs devtmpfs 2.0G 0 2.0G 0% /dev tmpfs tmpfs 2.0G 0 2.0G 0% /dev/shm tmpfs tmpfs 2.0G 12M 2.0G 1% /run tmpfs tmpfs 2.0G 0 2.0G 0% /sys/fs/cgroup /dev/mapper/centos-root xfs 19G 18G 1.5G 93% / /dev/sr0 iso9660 8.1G 8.1G 0 100% /var/ftp/iso /dev/sda1 xfs 509M 165M 344M 33% /boot tmpfs tmpfs 394M 0 394M 0% /run/user/0 4ã€åŒæ­¥ [root@localhost ~]# xfs_growfs /dev/centos/root meta-data=/dev/mapper/centos-root isize=512 agcount=4, agsize=1244928 blks = sectsz=512 attr=2, projid32bit=1 = crc=1 finobt=0 spinodes=0 data = bsize=4096 blocks=4979712, imaxpct=25 = sunit=0 swidth=0 blks naming =version 2 bsize=4096 ascii-ci=0 ftype=1 log =internal bsize=4096 blocks=2560, version=2 = sectsz=512 sunit=0 blks, lazy-count=1 realtime =none extsz=4096 blocks=0, rtextents=0 data blocks changed from 4979712 to 10222592 [root@localhost ~]# df -Th æ–‡ä»¶ç³»ç»Ÿ ç±»å‹ å®¹é‡ å·²ç”¨ å¯ç”¨ å·²ç”¨% æŒ‚è½½ç‚¹ devtmpfs devtmpfs 2.0G 0 2.0G 0% /dev tmpfs tmpfs 2.0G 0 2.0G 0% /dev/shm tmpfs tmpfs 2.0G 12M 2.0G 1% /run tmpfs tmpfs 2.0G 0 2.0G 0% /sys/fs/cgroup /dev/mapper/centos-root xfs 39G 18G 22G 46% / /dev/sr0 iso9660 8.1G 8.1G 0 100% /var/ftp/iso /dev/sda1 xfs 509M 165M 344M 33% /boot tmpfs tmpfs 394M 0 394M 0% /run/user/0 [root@localhost ~]# æ‰©å®¹ ext2/ext3/ext4 æ–‡ä»¶ç³»ç»Ÿ resize2fs /dev/vg0/lv0 æ–°å»ºé€»è¾‘å· ï¼ˆ1ï¼‰åˆ›å»ºä¸€ä¸ªæŒ‡å®šå¤§å°çš„lvï¼Œå¹¶æŒ‡å®šåå­—ä¸ºlv_2 lvcreate -L 2G -n lv_2 vg_1 ï¼ˆ2ï¼‰åˆ›å»ºä¸€ä¸ªå å…¨éƒ¨å·ç»„å¤§å°çš„lvï¼Œå¹¶æŒ‡å®šåå­—ä¸ºlv_3ï¼ˆæ³¨æ„å‰ææ˜¯vgå¹¶æ²¡æœ‰åˆ›å»ºæœ‰lvï¼‰ lvcreate -l 100%VG -n lv_3 vg_1 ï¼ˆ3ï¼‰åˆ›å»ºä¸€ä¸ªç©ºé—²ç©ºé—´80%å¤§å°çš„lvï¼Œå¹¶æŒ‡å®šåå­—ä¸ºlv_4(å¸¸ç”¨) lvcreate -l 80%Free -n lv_4 vg_1 ","date":"2024-05-27","objectID":"/posts/2024-05-27-linux-lvm/:1:1","tags":["lvm","linux-lvm"],"title":"lvm","uri":"/posts/2024-05-27-linux-lvm/"},{"categories":["DevOps"],"content":"é’‰é’‰æœºå™¨äººå‘æ¶ˆæ¯ ","date":"2024-05-14","objectID":"/posts/2024-05-14-dingbot/:1:0","tags":["dingbot"],"title":"dingbot","uri":"/posts/2024-05-14-dingbot/"},{"categories":["DevOps"],"content":"1ã€ç­¾åè®¡ç®— ç”±äº mac ä¸Šçš„æ˜¯ BSD çš„ dateï¼Œä¸ linux ä¸Šçš„ date ä¸åŒï¼Œåœ¨ mac ä¸Šä½¿ç”¨éœ€è¦æ›¿æ¢ä¸º linux çš„ gdateã€‚ #!/usr/bin/env bash ## éœ€è¦è‰¾ç‰¹çš„äººçš„æ‰‹æœºå·ç ï¼Œä»¥ç©ºæ ¼éš”å¼€ atMobiles=(13333333333 18888888888) ACCESS_TOKEN=\"fdebf803ece5080bdb432446ef6649e8c371bcxxxxxxxxxxx\" SECRET=\"SEC4622afcfbf51b8e71f0cc22154ba2f6f87xxxxxxxxxxxx\" dingbot() { message=$1 timestamp=$(date +%s%3N) stringtosign=\"${timestamp}\\n${SECRET}\" signdata=$(printf \"${stringtosign}\" | openssl dgst -sha256 -hmac ${SECRET} -binary | base64) sign=$(echo -n \"${signdata}\" | xxd -plain | tr -d '\\n' | sed 's/\\(..\\)/%\\1/g') webhook_url=\"https://oapi.dingtalk.com/robot/send?access_token=${ACCESS_TOKEN}\u0026timestamp=${timestamp}\u0026sign=${sign}\" at_who=$(printf '\"%s\",' \"${atMobiles[@]}\") at_who=${at_who%,} # ç§»é™¤æœ€åä¸€ä¸ªé€—å· # æ„é€ JSONæ•°æ® json_data=$(cat \u003c\u003cEOF { \"at\": { \"atMobiles\": [${at_who}] }, \"msgtype\": \"text\", \"text\": { \"content\": \"${message}\" } } EOF ) curl -s -X POST -H 'Content-Type: application/json' \"${webhook_url}\" -d \"${json_data}\" } dingbot \"ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯ã€‚\" function dingbotMD(){ title=\"$1\" message=\"$2\" timestamp=$(date +%s%3N) stringtosign=\"${timestamp}\\n${SECRET}\" signdata=$(printf \"${stringtosign}\" | openssl dgst -sha256 -hmac ${SECRET} -binary | base64) sign=$(echo -n \"${signdata}\" | xxd -plain | tr -d '\\n' | sed 's/\\(..\\)/%\\1/g') webhook_url=\"https://oapi.dingtalk.com/robot/send?access_token=${ACCESS_TOKEN}\u0026timestamp=${timestamp}\u0026sign=${sign}\" at_who=$(printf '\"%s\",' \"${atMobiles[@]}\") at_who=${at_who%,} # ç§»é™¤æœ€åä¸€ä¸ªé€—å· # æ„é€ JSONæ•°æ® json_data=$(cat \u003c\u003cEOF { \"msgtype\": \"markdown\", \"markdown\": { \"title\": \"${title}\", \"text\": \"${message}\" } } EOF ) curl -s -X POST -H 'Content-Type: application/json' \"${webhook_url}\" -d \"${json_data}\" } msg=\"$(date)\" dingbotMD \"msg\" \"### ä¸œå…«åŒºæ—¶é—´ï¼š${msg}\" echo ","date":"2024-05-14","objectID":"/posts/2024-05-14-dingbot/:1:1","tags":["dingbot"],"title":"dingbot","uri":"/posts/2024-05-14-dingbot/"},{"categories":["DevOps"],"content":"2ã€é€šç”¨ç‰ˆ #!/usr/bin/env bash # *********************************************************************** # Description : Dingbot for shell # Author : serialt # Email : tserialt@gmail.com # FilePath : /shell/DingMsg.sh # Other : # : # # æ”¯æŒå®‰å…¨ç±»å‹ï¼šã€å…³é”®å­—ã€‘ å’Œ ã€åŠ ç­¾ã€‘ # ä¾èµ–å‘½ä»¤ï¼šcurl openssl date echo # # æ³¨æ„ï¼šmacä¸Šçš„dateå‘½ä»¤æ˜¯bsdçš„ï¼Œä¸linuxä¸Šçš„dateä¸åŒï¼Œè·å–ä¸åˆ°æ¯«ç§’ï¼Œä¸èƒ½ç”¨äºç­¾åè®¡ç®—ã€‚ # æˆ–è€…å®‰è£…coreutilsï¼Œä½¿ç”¨gdateæ›¿æ¢date # # *********************************************************************** ## é’‰é’‰æœºå™¨äººé…ç½® dingbot_secret='SECa87a39d5b80e32xxxxxxxxxxxxxxxxxxxxxxxx' dingbot_url='https://oapi.dingtalk.com/robot/send?access_token=cd316d9df306852b6da7d10xxxxxxxxxxxxxxxxxxxxxxx' ## secret_type keywords || sign ding_secret_type='sign' ## éœ€è¦è‰¾ç‰¹çš„äººçš„æ‰‹æœºå·ç ï¼Œä»¥ç©ºæ ¼éš”å¼€ atMobiles=(13333333333 18888888888) ## encode url function url_encode() { t=\"${1}\" if [[ -n \"${1}\" \u0026\u0026 -n \"${2}\" ]];then if ! echo 'xX' | grep -q \"${t}\";then t='x' fi echo -n \"${2}\" | od -t d1 | awk -v a=\"${t}\" '{for (i = 2; i \u003c= NF; i++) {printf(($i\u003e=48 \u0026\u0026 $i\u003c=57) || ($i\u003e=65 \u0026\u0026$i\u003c=90) || ($i\u003e=97 \u0026\u0026 $i\u003c=122) ||$i==45 || $i==46 || $i==95 || $i==126 ?\"%c\" : \"%%%02\"a, $i)}}' else echo -e '$1 and $2 can not empty\\n$1 ==\u003e 'x' or 'X', x ==\u003e lower, X ==\u003e toupper.\\n$2 ==\u003e Strings need to url encode' fi } ## dingbot function dingbot(){ send_strs=\"${1}\" new_url=\"${dingbot_url}\" at_who='' for i in ${atMobiles[*]} do if [ -n \"${at_who}\" ];then at_who=\"${at_who},\\\"${i}\\\"\" else at_who=\"\\\"${i}\\\"\" fi done if [ \"${ding_secret_type}\" == 'keywords' ];then curl -s -X POST -H 'Content-Type: application/json' \"${new_url}\" \\ -d \"{\\\"at\\\":{\\\"atMobiles\\\":[${at_who}]},\\\"msgtype\\\":\\\"text\\\",\\\"text\\\":{\\\"content\\\":\\\"${send_strs}\\\"}}\" elif [ \"${ding_secret_type}\" == 'sign' ];then timestamp=$(date \"+%s%3N\") dingbot_sign=$(echo -ne \"${timestamp}\\n${dingbot_secret}\" | openssl dgst -sha256 -hmac \"${dingbot_secret}\" -binary | base64) dingbot_sign=$(url_encode 'X' \"${dingbot_sign}\") post_url=\"${dingbot_url}\u0026timestamp=${timestamp}\u0026sign=${dingbot_sign}\" curl -s -X POST -H 'Content-Type: application/json' \"${post_url}\" \\ -d \"{\\\"at\\\":{\\\"atMobiles\\\":[${at_who}]},\\\"msgtype\\\":\\\"text\\\",\\\"text\\\":{\\\"content\\\":\\\"${send_strs}\\\"}}\" else echo \"secret_type æœªçŸ¥ï¼Œè¯·æ£€æŸ¥é…ç½®\" fi } msg=\"$(date)\" dingbot \"ä¸œå…«åŒºæ—¶é—´ï¼š${msg}\" ","date":"2024-05-14","objectID":"/posts/2024-05-14-dingbot/:1:2","tags":["dingbot"],"title":"dingbot","uri":"/posts/2024-05-14-dingbot/"},{"categories":["DevOps"],"content":"3ã€å…¶ä»– shell ç‰ˆæœ¬ #!/usr/bin/env bash info='msg to you' #å‘é€æ¶ˆæ¯ sendMsg(){ token='1e18ffe069052b56f5a0f8fe9b6c058373e7df7ef49dc24baa6xxxxxxxxxxxxxx' curl -s \"https://oapi.dingtalk.com/robot/send?access_token=$token\" \\ -H 'Content-Type: application/json' \\ -d \"{'msgtype': 'text','text': {'content': 'msg:\\n$*'}} } main(){ logRotate sendMsg $info } main #!/bin/bash # ****************************************************** # Description : send msg by dingRobot # ä½¿ç”¨è„šæœ¬å‰è¯·è®¾ç½®é’‰é’‰æœºå™¨äººçš„å®‰å…¨ç±»å‹ï¼Œè„šæœ¬æ”¯æŒå…³é”®å­—å’ŒIP # # ****************************************************** logFile='/var/log/dingbot.log' #å‘é€æ¶ˆæ¯ sendMsg(){ local info=$* token='1e18ffe069052b56f5a0f8fe9b6c058373e7df7ef49dc24bacccccccccccc' result=`curl -s \"https://oapi.dingtalk.com/robot/send?access_token=$token\" \\ -H 'Content-Type: application/json' \\ -d \"{'msgtype': 'text', 'text': { 'content': '$info' } }\"` [ `echo $result | grep \"errmsg.*ok\"` ] \u0026\u0026 echo 'send succees!' echo \"$(date +'%Y-%m-%d %H:%M.%S') state: $result MessagesType: text [ text: $* ]\" \u003e\u003e $logFile } SendMsgByMD(){ local info=$1 # $info markdownçš„æ ‡é¢˜ local infoMsg=$2 # $infoMsg å†…å®¹ token='1e18ffe069052b56f5a0f8fe9b6c058373e7df7ef49dc24baa6cccccccccc' result=`curl -s \"https://oapi.dingtalk.com/robot/send?access_token=$token\" \\ -H 'Content-Type: application/json' \\ -d \"{ 'msgtype': 'markdown', 'markdown': { 'title':'$info', 'text': '$infoMsg' }, 'at': { 'atMobiles': [ '156xxxx8827', '189xxxx8325' ], 'isAtAll': true } }\"` [ `echo $result | grep \"errmsg.*ok\"` ] \u0026\u0026 echo 'send succees!' echo \"$(date +'%Y-%m-%d %H:%M.%S') state: $result MessagesType: markdown [ title: $info text: $infoMsg ]\" \u003e\u003e $logFile } #main() (sendMsg 'zabbix' )\u0026 (SendMsgByMD 'zabbix' '# send msg')\u0026 exit 55 ","date":"2024-05-14","objectID":"/posts/2024-05-14-dingbot/:1:3","tags":["dingbot"],"title":"dingbot","uri":"/posts/2024-05-14-dingbot/"},{"categories":["DevOps"],"content":"4ã€python ç‰ˆ https://github.com/zhuifengshen/DingtalkChatbot ","date":"2024-05-14","objectID":"/posts/2024-05-14-dingbot/:1:4","tags":["dingbot"],"title":"dingbot","uri":"/posts/2024-05-14-dingbot/"},{"categories":["DevOps"],"content":"5ã€goç‰ˆ https://github.com/blinkbean/dingtalk ","date":"2024-05-14","objectID":"/posts/2024-05-14-dingbot/:1:5","tags":["dingbot"],"title":"dingbot","uri":"/posts/2024-05-14-dingbot/"},{"categories":["DevOps"],"content":"Publish Terraform Provider https://registry.terraform.io/ ä¸Šçš„provideråªèƒ½æ‰˜ç®¡åœ¨ github ä¸Š ","date":"2024-03-31","objectID":"/posts/2024-03-31-publish-terraform-provider/:1:0","tags":["terraform-registry","hashicorp"],"title":"Publish Provider to Registry","uri":"/posts/2024-03-31-publish-terraform-provider/"},{"categories":["DevOps"],"content":"1ã€Terraform Registry å®˜ç½‘ä¸Šæ³¨å†Œè´¦å· è´¦å·ä½¿ç”¨ github ç™»å½•ï¼Œè®¾ç½® github éœ€è¦å¯¹ terraform registry çš„æˆæƒ ","date":"2024-03-31","objectID":"/posts/2024-03-31-publish-terraform-provider/:1:1","tags":["terraform-registry","hashicorp"],"title":"Publish Provider to Registry","uri":"/posts/2024-03-31-publish-terraform-provider/"},{"categories":["DevOps"],"content":"2ã€åˆ›å»º github projectï¼Œé…ç½® github action åå­—éœ€è¦ç¬¦åˆ terraform-provider-xxxxxï¼Œä¾‹å¦‚ terraform-provider-messageï¼Œ 1ï¼‰ç”Ÿæˆ GPG keyï¼Œç”¨äº provider ç­¾åå’ŒéªŒç­¾ [root@dev ~]# gpg --full-generate-key gpg (GnuPG) 2.2.20; Copyright (C) 2020 Free Software Foundation, Inc. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Please select what kind of key you want: (1) RSA and RSA (default) (2) DSA and Elgamal (3) DSA (sign only) (4) RSA (sign only) (14) Existing key from card Your selection? 1 # é€‰æ‹©RSA RSA keys may be between 1024 and 4096 bits long. What keysize do you want? (2048) 4096 # è¾“å…¥åŠ å¯†å¯†é’¥çš„é•¿åº¦ï¼Œ4096 Requested keysize is 4096 bits Please specify how long the key should be valid. 0 = key does not expire \u003cn\u003e = key expires in n days \u003cn\u003ew = key expires in n weeks \u003cn\u003em = key expires in n months \u003cn\u003ey = key expires in n years Key is valid for? (0) 0 # è®¾ç½®å¯†ç æœ‰æ•ˆæœŸ Key does not expire at all Is this correct? (y/N) y GnuPG needs to construct a user ID to identify your key. Real name: serialt # è®¾ç½®å¯†é’¥çš„æ¶ˆæ¯ Email address: t@local.com Comment: msg You selected this USER-ID: \"serialt (msg) \u003ct@local.com\u003e\" Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? o We need to generate a lot of random bytes. It is a good idea to perform some other action (type on the keyboard, move the mouse, utilize the disks) during the prime generation; this gives the random number generator a better chance to gain enough entropy. We need to generate a lot of random bytes. It is a good idea to perform some other action (type on the keyboard, move the mouse, utilize the disks) during the prime generation; this gives the random number generator a better chance to gain enough entropy. gpg: key A02032881C9460CE marked as ultimately trusted gpg: revocation certificate stored as '/root/.gnupg/openpgp-revocs.d/16630E5129BFAB582DDFBF71A02032881C9460CE.rev' public and secret key created and signed. pub rsa4096 2021-08-23 [SC] 16630E5129BFAB582DDFBF71A02032881C9460CE uid serialt (msg) \u003ct@local.com\u003e sub rsa4096 2021-08-23 [E] â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Please enter the passphrase to â”‚ â”‚ protect your new key â”‚ â”‚ â”‚ â”‚ Passphrase: ________________________________________ â”‚ â”‚ â”‚ â”‚ \u003cOK\u003e \u003cCancel\u003e â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Please re-enter this passphrase â”‚ â”‚ â”‚ â”‚ Passphrase: ________________________________________ â”‚ â”‚ â”‚ â”‚ \u003cOK\u003e \u003cCancel\u003e â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ # æŸ¥çœ‹æ‰€æœ‰å¯†é’¥ gpg -k # å¯¼å‡ºå¯†é’¥ gpg --output public_key.gpg --armor --export 375xxxxx gpg --output private_key.gpg --armor --export-secret-key 375xxxxx 2ï¼‰github action éœ€è¦é…ç½®ä¸€ä¸‹ secret TOKEN GPG_PRIVATE_KEY # Terraform Provider release workflow. name: Release # This GitHub action creates a release when a tag that matches the pattern # \"v*\" (e.g. v0.1.0) is created. on: push: tags: - 'v*' # Releases need permissions to read and write the repository contents. # GitHub considers creating releases and uploading assets as writing contents. permissions: contents: write jobs: goreleaser: runs-on: ubuntu-latest steps: - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1 with: # Allow goreleaser to access older tag information. fetch-depth: 0 - uses: actions/setup-go@0c52d547c9bc32b1aa3301fd7a9cb496313a4491 # v5.0.0 with: go-version-file: 'go.mod' cache: true - name: Import GPG key uses: crazy-max/ghaction-import-gpg@01dd5d3ca463c7f10f7f4f7b4f177225ac661ee4 # v6.1.0 id: import_gpg with: gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }} #passphrase: ${{ secrets.GPG_PRIVATE_PASSPHRASE }} - name: Run GoReleaser uses: goreleaser/goreleaser-action@7ec5c2b0c6cdda6e8bbb49444bc797dd33d74dd8 # v5.0.0 with: args: release --clean env: # GitHub sets the GITHUB_TOKEN secret automatically. GITHUB_TOKEN: ${{ secrets.TOKEN }} GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }} æ¨é€é¡¹ç›®åˆ°github ","date":"2024-03-31","objectID":"/posts/2024-03-31-publish-terraform-provider/:1:2","tags":["terraform-registry","hashicorp"],"title":"Publish Provider to Registry","uri":"/posts/2024-03-31-publish-terraform-provider/"},{"categories":["DevOps"],"content":"3ã€Terraform Registryä¸Šé…ç½®å…¬é’¥å’Œå‘å¸ƒprovider 1ï¼‰å¯¼å…¥å…¬é’¥ https://registry.terraform.io/settings/gpg-keys 2ï¼‰å‘å¸ƒprovider https://registry.terraform.io/publish/provider ","date":"2024-03-31","objectID":"/posts/2024-03-31-publish-terraform-provider/:1:3","tags":["terraform-registry","hashicorp"],"title":"Publish Provider to Registry","uri":"/posts/2024-03-31-publish-terraform-provider/"},{"categories":["Network"],"content":"wlanç»„ç½‘ ","date":"2024-03-23","objectID":"/posts/2024-03-24-wlan/:1:0","tags":["network","ap","ac"],"title":"wlan","uri":"/posts/2024-03-24-wlan/"},{"categories":["Network"],"content":"ä¸€ã€æ¦‚è¿° æ— çº¿å±€åŸŸç½‘(Wireless Local Area Networksï¼› WLAN)åˆ©ç”¨æ— çº¿æŠ€æœ¯åœ¨ç©ºä¸­ä¼ è¾“æ•°æ®ã€è¯éŸ³å’Œè§†é¢‘ä¿¡å·ã€‚ä½œä¸ºä¼ ç»Ÿå¸ƒçº¿ç½‘ç»œçš„ä¸€ç§æ›¿ä»£æ–¹æ¡ˆæˆ–å»¶ä¼¸ï¼Œæ— çº¿å±€åŸŸç½‘æŠŠä¸ªäººä»åŠå…¬æ¡Œè¾¹è§£æ”¾äº†å‡ºæ¥ï¼Œä½¿ä»–ä»¬å¯ä»¥éšæ—¶éšåœ°è·å–ä¿¡æ¯ï¼Œæé«˜äº†å‘˜å·¥çš„åŠå…¬æ•ˆç‡ã€‚ WLANçš„ä¼˜ç‚¹ï¼šå®ƒèƒ½å¤Ÿæ–¹ä¾¿åœ°è”ç½‘ï¼Œå› ä¸ºWLANå¯ä»¥ä¾¿æ·ã€è¿…é€Ÿåœ°æ¥çº³æ–°åŠ å…¥çš„é›‡å‘˜ï¼Œè€Œä¸å¿…å¯¹ç½‘ç»œçš„ç”¨æˆ·ç®¡ç†é…ç½®è¿›è¡Œè¿‡å¤šçš„å˜åŠ¨ï¼›WLANåœ¨æœ‰çº¿ç½‘ç»œå¸ƒçº¿å›°éš¾çš„åœ°æ–¹æ¯”è¾ƒå®¹æ˜“å®æ–½ï¼Œä½¿ç”¨WLANæ–¹æ¡ˆï¼Œåˆ™ä¸å¿…å†å®æ–½æ‰“å­”æ•·çº¿ä½œä¸šï¼Œå› è€Œä¸ä¼šå¯¹å»ºç­‘è®¾æ–½é€ æˆä»»ä½•æŸå®³ã€‚ ","date":"2024-03-23","objectID":"/posts/2024-03-24-wlan/:1:1","tags":["network","ap","ac"],"title":"wlan","uri":"/posts/2024-03-24-wlan/"},{"categories":["Network"],"content":"äºŒã€802.11åŸºæœ¬å…ƒç´  åŸºæœ¬æœåŠ¡å™¨(Basic Service Set)æ˜¯802.11ç½‘ç»œçš„åŸºæœ¬ç»„ä»¶ï¼Œç”±ä¸€ç»„ç›¸äº’é€šä¿¡çš„å·¥ä½œç«™æ‰€æ„æˆã€‚å·¥ä½œç«™ä¹‹é—´çš„é€šä¿¡åœ¨æŸä¸ªæ¨¡ç³Šåœ°å¸¦è¿›è¡Œï¼Œç§°ä¸ºåŸºæœ¬æœåŠ¡åŒºåŸŸ(Basic Service Area)ï¼Œæ­¤åŒºåŸŸå—é™äºæ‰€ä½¿ç”¨çš„æ— çº¿åª’ä»‹çš„ä¼ æ’­ç‰¹æ€§ BSAï¼šBSSçš„è¦†ç›–èŒƒå›´ç§°ä¸ºåŸºæœ¬æœåŠ¡åŒº BSSåˆ†ä¸ºIndependent BSSå’ŒInfrastructure BSSä¸¤ç§ ç‹¬ç«‹æœåŠ¡é›†ç®€ç§°IBSSï¼Œå·¥ä½œç«™ä¹‹é—´å¯ä»¥ç›´æ¥é€šä¿¡ï¼Œä½†ä¸¤è€…é—´çš„è·ç¦»å¿…é¡»åœ¨å¯ä»¥é€šä¿¡çš„èŒƒå›´å†…ã€‚ ç”±äºæŒç»­æ—¶é—´ä¸é•¿ï¼Œè§„æ¨¡å°ä¸”ç›®çš„ç‰¹æ®Šï¼ŒIBSSæœ‰æ—¶ç§°ä¸ºç‰¹è®¾BSSæˆ–ad hoc newwork åŸºç¡€æ¶æ„æ¨¡å¼åŸºæœ¬æœåŠ¡é›†ã€‚åˆ¤æ–­æ˜¯å¦ä¸ºåŸºç¡€ç»“æ„å‹ç½‘ç»œï¼Œåªè¦æŸ¥çœ‹æ˜¯å¦æœ‰æ¥å…¥ç‚¹(AP)å‚ä¸å…¶ä¸­ ESSï¼šåˆ©ç”¨éª¨å¹²ç½‘ç»œå°†BSSè¿›è¡Œè¿æ¥ SSIDï¼šç”¨æˆ·çš„ç½‘ç»œåç§° BSSIDï¼šAPçš„MACåœ°å€ï¼Œç”¨æ¥æ ‡è¯†APæ‰€ç®¡ç†çš„BSS ","date":"2024-03-23","objectID":"/posts/2024-03-24-wlan/:1:2","tags":["network","ap","ac"],"title":"wlan","uri":"/posts/2024-03-24-wlan/"},{"categories":["Network"],"content":"ä¸‰ã€WLANæ‹“æ‰‘ç»“æ„ 3.1 Ad-Hoc Ad-Hocæ‹“æ‰‘çš„æ— çº¿ç½‘ç»œç”±æ— çº¿å·¥ä½œç«™ç»„æˆï¼Œç”¨äºä¸€å°æ— çº¿å·¥ä½œç«™å’Œå¦ä¸€å°æˆ–å¤šå°å…¶ä»–æ— çº¿å·¥ä½œç«™çš„ç›´æ¥é€šè®¯ï¼Œè¯¥ç½‘ç»œæ— æ³•æ¥å…¥åˆ°æœ‰çº¿ç½‘ç»œä¸­ï¼Œåªèƒ½ç‹¬ç«‹ä½¿ç”¨ 3.2 IBSS ç”±å¤šä¸ªAPä»¥åŠè¿æ¥ä»–ä»¬çš„åˆ†å¸ƒå¼ç³»ç»Ÿ(DS)ç»„æˆçš„åŸºç¡€æ¶æ„æ¨¡å¼ç½‘ç»œï¼Œä¹Ÿç§°ä¸ºæ‰©å±•æœåŠ¡åŒº(ESS)ã€‚æ‰©å±•æœåŠ¡åŒºå†…çš„æ¯ä¸ªAPéƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ— çº¿ç½‘ç»œåŸºç¡€æœåŠ¡åŒº(BSS)ï¼Œæ‰€æœ‰APå…±äº«åŒä¸€ä¸ªæ‰©å±•æœåŠ¡åŒºæ ‡è¯†ç¬¦(ESSID) ç›¸åŒESSIDçš„æ— çº¿ç½‘ç»œå¯ä»¥è¿›è¡Œæ¼«æ¸¸ï¼Œä¸åŒESSIDçš„æ— çº¿ç½‘ç»œå½¢æˆé€»è¾‘å­ç½‘ APä¹‹é—´ä½¿ç”¨äº’ç›¸ä¸é‡å çš„ä¿¡é“ï¼ŒAPä¹‹é—´ä¿¡å·è¦†ç›–é‡å åŒºåŸŸä¸º10%-15% 3.3 WDS WDS(Wireless Distribution Systemæ— çº¿åˆ†å¸ƒå¼ç³»ç»Ÿ)ï¼šé€šè¿‡æ— çº¿é“¾è·¯é“¾æ¥ä¸¤ä¸ªæˆ–è€…å¤šä¸ªç‹¬ç«‹çš„æœ‰çº¿å±€åŸŸç½‘æˆ–è€…æ— çº¿å±€åŸŸç½‘ï¼Œç»„æˆä¸€ä¸ªäº’é€šçš„ç½‘ç»œ æ— çº¿WDSæŠ€æœ¯æé«˜äº†æ•´ä¸ªç½‘ç»œç»“æ„çš„çµæ´»æ€§å’Œä¾¿æ·æ€§ åœ¨WDSéƒ¨ç½²ä¸­ï¼Œç½‘æ¡¥ç»„ç½‘æ¨¡å¼å¯åˆ†ä¸ºï¼š ç‚¹å¯¹ç‚¹(P2P) ç‚¹å¯¹å¤šç‚¹(P2MP) ä¸­ç»§æ¡¥æ¥æ–¹å¼ ","date":"2024-03-23","objectID":"/posts/2024-03-24-wlan/:1:3","tags":["network","ap","ac"],"title":"wlan","uri":"/posts/2024-03-24-wlan/"},{"categories":["Network"],"content":"å››ã€AP 4.1 æ¦‚è¿° æ— çº¿å±€åŸŸç½‘çš„æ¶æ„ä¸»è¦åˆ†ä¸º åŸºäºæ§åˆ¶å™¨çš„APæ¶æ„(ç˜¦APï¼ŒFitAP) ä¼ ç»Ÿçš„ç‹¬ç«‹APæ¶æ„(èƒ–APï¼ŒFatAP) è¿‘å‡ å¹´WLANæŠ€æœ¯çš„å‘å±•ï¼Œç˜¦APæ­£åœ¨è¿…é€Ÿæ›¿ä»£èƒ–APæ¨¡å¼ 4.2 èƒ–AP é™¤æ— çº¿æ¥å…¥åŠŸèƒ½å¤–ï¼Œä¸€èˆ¬å…·å¤‡WLANã€LANä¸¤ä¸ªæ¥å£ï¼Œå¤šæ”¯æŒDHCPæœåŠ¡å™¨ã€DNSå’ŒMACåœ°å€å…‹éš†ï¼Œä»¥åŠVPNæ¥å…¥ã€é˜²ç«å¢™ç­‰å®‰å…¨åŠŸèƒ½ èƒ–APä¹Ÿç§°ä¸ºç‹¬ç«‹APï¼Œæ‰€æœ‰çš„é…ç½®å­˜å‚¨äºè‡ªæ²»å‹æ¥å…¥ç‚¹æœ¬èº«ï¼Œå› æ­¤è®¾å¤‡çš„ç®¡ç†å’Œé…ç½®å‡ç”±æ¥å…¥ç‚¹å¤„ç†ã€‚æ‰€æœ‰åŠ è§£å¯†å’ŒMACå±‚åŠŸèƒ½ä¹Ÿç”±è‡ªæ²»å‹æ¥å…¥ç‚¹å®Œæˆ èƒ–APçš„ä¾‹å­å…¸å‹çš„æ˜¯æ— çº¿è·¯ç”±å™¨ 4.3 ç˜¦AP æ— çº¿å±€åŸŸç½‘ä¸€ä½“åŒ–å‘å±•çš„ä¸‹ä¸€ä¸ªé˜¶æ®µæ˜¯é›†ä¸­å¼WLANæ¶æ„ã€‚è¿™ç§æ¨¡å¼ä½¿ç”¨ä½äºç½‘ç»œæ ¸å¿ƒçš„WLANæ§åˆ¶å™¨ï¼Œåœ¨é›†ä¸­å¼çš„æ— çº¿å±€åŸŸç½‘ä½“ç³»ç»“æ„ä¸­ï¼ŒåŸºäºæ§åˆ¶å™¨çš„æ¥å…¥ç‚¹ï¼Œä¹Ÿç§°ä¸ºè½»é‡å‹AP ä¸ºäº†å®ç°WLANç½‘ç»œçš„å¿«é€Ÿéƒ¨ç½²ã€ç½‘ç»œè®¾å¤‡çš„é›†ä¸­ç®¡ç†ã€ç²¾ç»†åŒ–çš„ç”¨æˆ·ç®¡ç†ï¼Œç›¸æ¯”èƒ–APæ–¹å¼ï¼Œä¼ä¸šç”¨æˆ·ä»¥åŠè¿è¥å•†æ›´å€¾å‘äºé‡‡ç”¨é›†ä¸­æ§åˆ¶æ€§WLANç»„ç½‘(ç˜¦AP+AC) ACå’ŒAPä¹‹é—´é‡‡ç”¨CAPWAPåè®® ","date":"2024-03-23","objectID":"/posts/2024-03-24-wlan/:1:4","tags":["network","ap","ac"],"title":"wlan","uri":"/posts/2024-03-24-wlan/"},{"categories":["Network"],"content":"äº”ã€CAPWAPç®€ä»‹ CAPWAP(æ— çº¿æ¥å…¥ç‚¹æ§åˆ¶å’Œé…ç½®åè®®)ï¼Œç”¨äºæ— çº¿ç»ˆç«¯æ¥å…¥ç‚¹(AP)å’Œæ— çº¿ç½‘ç»œæ§åˆ¶å™¨(AC)ä¹‹é—´çš„é€šä¿¡å’Œäº¤äº’ï¼Œå®ç°ACå¯¹å…¶æ‰€å…³è”çš„APçš„é›†ä¸­ç®¡ç†å’Œæ§åˆ¶ åè®®å†…å®¹ APå¯¹ACçš„è‡ªåŠ¨å‘ç°ä»¥åŠAP\u0026ACçš„çŠ¶æ€æœºè¿è¡Œã€ç»´æŠ¤ ACå¯¹APè¿›è¡Œç®¡ç†ã€ä¸šåŠ¡é…ç½®ä¸‹å‘ STAæ•°æ®å°è£…CAPWAPéš§é“è¿›è¡Œè½¬å‘ ","date":"2024-03-23","objectID":"/posts/2024-03-24-wlan/:1:5","tags":["network","ap","ac"],"title":"wlan","uri":"/posts/2024-03-24-wlan/"},{"categories":["Network"],"content":"å…­ã€APå’ŒACå·¥ä½œè¿‡ç¨‹ 6.1 ç˜¦APå‘ç°AC 6.2 APå’ŒACè¯¦ç»†å·¥ä½œè¿‡ç¨‹ 6.2.1 åŠ¨æ€å‘ç° APå¯åŠ¨ä»¥åä¼šé€šè¿‡DHCPè·å–IPåœ°å€ã€DNS Serverã€åŸŸå APå‘å‡ºL2å¹¿æ’­çš„å‘ç°è¯·æ±‚æŠ¥æ–‡è¯•å›¾è”ç³»ä¸€ä¸ªAC å¦‚æœé•¿æ—¶é—´(30ç§’)æ²¡æœ‰å“åº”ï¼ŒAPä¼šå¯åŠ¨L3å‘ç°ã€‚APä¼šä»DHCP Serveré€šè¿‡Option43è·å¾—ACçš„IPï¼Œæˆ–è€…é€šè¿‡Opthion15è·å¾—ACçš„åŸŸåï¼ŒAPå‘è¯¥IPåœ°å€(åŸŸå)å‘é€è¯·æ±‚ æ¥æ”¶åˆ°å‘ç°è¯·æ±‚æŠ¥æ–‡çš„ACä¼šæ£€æŸ¥è¯¥APæ˜¯å¦æ¥å…¥æœ¬æœºçš„æƒé™ï¼Œå¦‚æœæœ‰åˆ™å›åº”å‘ç°å“åº” ACå’ŒAPé—´å»ºç«‹CAPWAPéš§é“ 6.2.2 CAPWAPéš§é“å»ºç«‹è¿‡ç¨‹ DHCP CAPWAPéš§é“å»ºç«‹-Discover APä½¿ç”¨APå‘ç°æœºåˆ¶æ¥è·å–å“ªäº›ACå¯ç”¨ï¼Œå†³å®šä¸æœ€ä½³ACå»ºç«‹CAPWAPè¿æ¥ã€‚(å½“APä¸Šå·²ç»é™æ€é…ç½®äº†ACï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦å®ŒæˆACçš„å‘ç°è¿‡ç¨‹) APå¯åŠ¨CAPWAPåè®®çš„å‘ç°æœºåˆ¶ï¼Œä»¥å•æ’­æˆ–å¹¿æ’­çš„å½¢å¼å‘é€è¯·æ±‚æŠ¥æ–‡è¯•å›¾å…³è”ACï¼ŒACæ”¶åˆ°APçš„discovery Requestä»¥åï¼Œä¼šå‘é€ä¸€ä¸ªå•æ’­çš„discovery responseç»™APï¼ŒAPå¯ä»¥é€šè¿‡discovery responseä¸­æ‰€å¸¦çš„ACä¼˜å…ˆçº§æˆ–è€…ACä¸Šå½“å‰APçš„ä¸ªæ•°ç­‰ï¼Œç¡®å®šä¸å“ªä¸ªACå»ºç«‹ä¼šè¯ CAPWAPéš§é“å»ºç«‹-DTLS(å¯é€‰) APæ ¹æ®æ­¤IPåœ°å€ä¸ACåå•†ï¼ŒAPæ¥å—åˆ°å“åº”æ¶ˆæ¯åå¼€å§‹ä¸ACå»ºç«‹CAPWAPéš§é“ï¼Œè¿™ä¸ªé˜¶æ®µå¯ä»¥é€‰æ‹©CAPWAPéš§é“æ˜¯å¦é‡‡ç”¨DTLSåŠ å¯†ä¼ è¾“UDPæŠ¥æ–‡ DTLSï¼šDatagram Transport Layer Security(æ•°æ®æŠ¥ä¼ è¾“å±‚å®‰å…¨åè®®) CAPWAPéš§é“å»ºç«‹-Join åœ¨å®ŒæˆDTLSæ¡æ‰‹åï¼ŒACä¸APå¼€å§‹å»ºç«‹æ§åˆ¶éš§é“ï¼Œåœ¨å»ºç«‹æ§åˆ¶éš§é“çš„äº¤äº’è¿‡ç¨‹ä¸­ï¼ŒACå›åº”çš„Join ResponseæŠ¥æ–‡ä¸­ä¼šæºå¸¦ç”¨æˆ·é…ç½®çš„å‡çº§ç‰ˆæœ¬å·ï¼Œæ¡æ‰‹æŠ¥æ–‡é—´éš”/è¶…æ—¶æ—¶é—´ï¼Œæ§åˆ¶æŠ¥æ–‡ä¼˜å…ˆçº§ç­‰ä¿¡æ¯ã€‚ACä¼šæ£€æŸ¥APçš„å½“å‰ç‰ˆæœ¬ï¼Œå¦‚æœAPçš„ç‰ˆæœ¬æ— æ³•ä¸ACè¦æ±‚çš„ç›¸åŒ¹é…ï¼ŒAPå’ŒACä¼šè¿›å…¥Image DataçŠ¶æ€åšå›ºä»¶å‡çº§ï¼Œä»¥æ­¤æ¥æ›´æ–°APçš„ç‰ˆæœ¬ï¼Œå¦‚æœAPçš„ç‰ˆæœ¬ç¬¦åˆè¦æ±‚ï¼Œåˆ™è¿›å…¥ConfigurationçŠ¶æ€ CAPWAPéš§é“å»ºç«‹-Configure å°†å…¥ConfigureçŠ¶æ€åä¸ºäº†åšAPçš„ç°æœ‰é…ç½®å’ŒACè®¾å®šé…ç½®çš„åŒ¹é…æ£€æŸ¥ï¼ŒAPå‘é€Configuration Requeståˆ°ACï¼Œè¯¥ä¿¡æ¯ä¸­åŒ…å«ç°æœ‰APçš„é…ç½®ï¼Œå½“APå½“å‰é…ç½®ä¸ACè¦æ±‚ä¸ç¬¦æ—¶ï¼ŒACé€šè¿‡Configuration Responseé€šçŸ¥AP CAPWAPéš§é“å»ºç«‹-data check è¿›å…¥runçŠ¶æ€ï¼Œä»–ä»¬ä¹‹é—´ä¼šå‘é€keepliveæŠ¥æ–‡æ¥ç»´æŠ¤æ•°æ®éš§é“ ä¸ƒã€ç»¼åˆå®éªŒ 7.1 å®éªŒç»„ç½‘ 7.2 å®éªŒé…ç½® 7.2.1 ç˜¦APé…ç½® 1ã€åˆ’åˆ†vlan10 20ï¼Œvlan10ç”¨äºç®¡ç†ï¼Œvlan20ç”¨äºä¸šåŠ¡ 2ã€LSW4çš„é…ç½® \u003cHuawei\u003eundo terminal monitor \u003cHuawei\u003esys [Huawei]vlan batch 10 20 [Huawei]int g0/0/2 [Huawei-GigabitEthernet0/0/2]port link-type trunk [Huawei-GigabitEthernet0/0/2]port trunk allow-pass vlan 10 20 [Huawei-GigabitEthernet0/0/2]port trunk pvid vlan 10 [Huawei-GigabitEthernet0/0/3]int g0/0/1 [Huawei-GigabitEthernet0/0/1]port link-type trunk [Huawei-GigabitEthernet0/0/1]port trunk allow-pass vlan 10 20 3ã€LSW3çš„é…ç½® [Huawei]int g0/0/1 [Huawei-GigabitEthernet0/0/1]port link-type trunk [Huawei-GigabitEthernet0/0/1]port trunk allow-pass vlan 10 20 [Huawei-GigabitEthernet0/0/1]int g0/0/3 [Huawei-GigabitEthernet0/0/3]port link-type trunk [Huawei-GigabitEthernet0/0/3]port trunk allow-pass vlan 10 20 4ã€ACé…ç½® [AC6005]vlan batch 10 20 [AC6005-GigabitEthernet0/0/1]port link-type trunk [AC6005-GigabitEthernet0/0/1]port trunk allow-pass vlan 10 20 [AC6005-GigabitEthernet0/0/1]q //é…ç½®dhcp [AC6005]dhcp enable [AC6005]int Vlanif 10 [AC6005-Vlanif10]ip address 10.1.10.1 24 [AC6005-Vlanif10]dhcp select interface [AC6005-Vlanif10]int vlanif 20 [AC6005-Vlanif20]ip address 10.1.20.1 24 [AC6005-Vlanif20]dhcp select interface [AC6005-Vlanif20]q //åœ¨ACä¸Šé…ç½®APä¸Šçº¿ //åˆ›å»ºAPç»„ï¼Œç”¨äºå°†ç›¸åŒé…ç½®çš„APåŠ å…¥åˆ°åŒä¸€APç»„ [AC6005]wlan [AC6005-wlan-view]ap-group name ap-group1 [AC6005-wlan-ap-group-ap-group1]q //åˆ›å»ºåŸŸç®¡ç†æ¨¡æ¿ï¼Œåœ¨åŸŸç®¡ç†æ¨¡æ¿é…ç½®ACçš„å›½å®¶ç å¹¶åœ¨APç»„ä¸‹å¼•ç”¨ç®¡ç†æ¨¡å— [AC6005-wlan-view]regulatory-domain-profile name defult [AC6005-wlan-regulate-domain-defult]country-code cn [AC6005-wlan-regulate-domain-defult]q [AC6005-wlan-view]ap-group name ap-group1 [AC6005-wlan-ap-group-ap-group1]regulatory-domain-profile default Warning: Modifying the country code will clear channel, power and antenna gain c onfigurations of the radio and reset the AP. Continue?[Y/N]:y [AC6005-wlan-ap-group-ap-group1]q [AC6005-wlan-view]q //é…ç½®ACæºæ¥å£ [AC6005]capwap source int Vlanif 10 //æŸ¥çœ‹AP2çš„MACåœ°å€ï¼Œå¹¶è®°å½•ä¸‹æ¥ [AC6005]wlan [AC6005-wlan-view]ap auth-mode mac-auth [AC6005-wlan-view]ap-id 0 ap-mac [ap2çš„macåœ°å€] [AC6005-wlan-ap-0]ap-name area_1 [AC6005-wlan-ap-0]ap-group ap-group1 [AC6005-wlan-ap-0]q //é…ç½®WLANä¸šåŠ¡å‚æ•°ï¼Œé…ç½®WPA-WPA2+PSK+AES [AC6005]wlan [AC6005-wlan-view]security-profile name wlan-net [AC6005-wlan-sec-prof-wlan-net]security wpa-wpa2 psk pass-phrase 12345678 aes Warning: The current password is too simple. For the sake of security, you are a dvised to set a password containing at least two of the following: lowercase let ters a to z, uppercase letters A to Z, digits, and special characters. Continue? [Y/N]:y [AC6005-wlan-sec-prof-wlan-net]q //åˆ›å»ºåä¸º\"wlan-net\"çš„SSIDï¼Œå¹¶é…ç½®SSIDåç§°ä¸º\"wlan-net\" [AC6005-wlan-view]ssid-profile name wlan-net [AC6005-wlan-ssid-prof-wlan-net]ssid wlan-net Info: This operation may take a few seconds, please wait.done. [AC6005-wlan-ssid-prof-wlan-net]q //åˆ›å»ºåä¸º\"wlan-net\"çš„VAPæ¨¡æ¿ï¼Œé…ç½®ä¸šåŠ¡æ•°æ®è½¬å‘æ¨¡å¼ï¼Œä¸šåŠ¡VLANï¼Œå¹¶ä¸”å¼•ç”¨å®‰å…¨æ¨¡æ¿å’ŒSSID [AC6005-wlan-view]vap-profile name wlan-net //é…ç½®ç›´æ¥è½¬å‘ [AC6005-wlan-vap-prof-wlan","date":"2024-03-23","objectID":"/posts/2024-03-24-wlan/:1:6","tags":["network","ap","ac"],"title":"wlan","uri":"/posts/2024-03-24-wlan/"},{"categories":["Network"],"content":"è·¯ç”±äº¤æ¢åŸºç¡€é…ç½® è®¾å¤‡åä¿®æ”¹ \u003cHuawei\u003e system-view [Huawei] sysname Server [Server] undo sysname [Huawei] æŸ¥çœ‹é…ç½® # æŸ¥çœ‹å½“å‰é…ç½® display this # æŸ¥çœ‹å½“å‰æ‰€æœ‰é…ç½® display current-configuration ç¦ç”¨ftpåŠŸèƒ½ \u003cHuawei\u003e system-view [Huawei] ftp server enable [Huawei] undo ftp server åˆ é™¤portç‰ˆå®šçš„ip [Huawei]interface g0/0/1 [Huawei-GigabitEthernet0/0/1]ip address 192.168.1.1 24 [Huawei-GigabitEthernet0/0/1]undo ip address é…ç½®æ—¶é—´ display clock æŸ¥çœ‹å½“å‰æ—¶é—´ clock timezone è®¾ç½®æ‰€åœ¨æ—¶åŒº clock datetime è®¾ç½®å½“å‰æ—¶é—´å’Œæ—¥æœŸ clock daylight-saving-time è®¾ç½®é‡‡ç”¨å¤æ—¶åˆ¶ é…ç½®æ ‡é¢˜æ¶ˆæ¯ # é…ç½®ç™»å½•å‰æ˜¾ç¤ºçš„æ ‡é¢˜ä¿¡æ¯ [Huawei] header login information \"welcome to huawei\" # é…ç½®ç™»å½•åæ˜¾ç¤ºçš„æ ‡é¢˜ä¿¡æ¯ [Huawei] header shell information \"Please do not reboot the device\" é…ç½®è·¯ç”±å™¨æ¥å£è®¾ç½®IPåœ°å€ \u003cHuawei\u003e system-view [Huawei] intface GigabitEthernet0/0/1 [Huawei-GigabitEthernet0/0/1] ip address 192.168.10.2 255.255.255.0 [Huawei-GigabitEthernet0/0/1]display ip interface brief # æ˜¾ç¤ºå½“å‰æ¥å£ä¿¡æ¯ ****** Interface IP Address/Mask Physical Protocol GigabitEthernet0/0/1 192.168.10.2/24 down down [Huawei-GigabitEthernet0/0/1]display this # æ˜¾ç¤ºå½“å‰é…ç½® Telneté…ç½® # å¼€å¯telnet æœåŠ¡ telnet server enable # æŸ¥çœ‹çŠ¶æ€ display telnet server status # è¿›å…¥VTYé…ç½®æ¨¡å¼ user-interface vty 0 4 # é…ç½®æ”¯æŒTelnetæˆ–SSHåè®® protocol inbound telnet/ssh # é…ç½®è®¤è¯æ¨¡å¼ authentication-mode password/aaa # é…ç½®è®¤è¯å¯†ç  set authentication password cipher huawei # é…ç½®ç”¨æˆ·çº§åˆ« user privilege level 15 # é…ç½®æœ€å¤§VTYä¼šè¯æ•°é‡ user-interface maximum-vty 15 # è¿›å…¥AAAé…ç½®æ¨¡å¼ aaa # åˆ›å»ºç”¨æˆ·å’Œå¯†ç  local-user wakin password cipher huawei # é…ç½®ç”¨æˆ·çº§åˆ« local-user wakin privilege level 15 # é…ç½®ç”¨æˆ·å¯ç”¨æœåŠ¡ local-user wakin service-type telnet #æŸ¥çœ‹ç”¨æˆ·ç•Œé¢å ç”¨æƒ…å†µ: display users \u003cHuawei\u003esystem-view [Huawei]telnet server enable [Huawei]aaa [Huawei-aaa]loc-user huawei password irreversible-cipher Huawei@123 [Huawei-aaa]local-user huawei privilege level 15 [Huawei-aaa]local-user huawei service-type telnet [Huawei-aaa]quit [Huawei]user-interface vty 0 4 [Huawei]authentication-mode aaa è·¯ç”±è®¾ç½® # æ˜¾ç¤ºè·¯ç”±è¡¨ display ip routing-table # é™æ€è·¯ç”± # ip route-static ç›®æ ‡ç½‘ç»œ æ©ç  ä¸‹ä¸€è·³ ip route-static 192.168.1.0 24 10.1.12.2 # ç¼ºçœè·¯ç”± # ip route-static 0.0.0.0 ä¸‹ä¸€è·³åœ°å€ ip route-static 0.0.0.0 10.1.12.3 # æµ®åŠ¨é™æ€è·¯ç”±ï¼šé€šè¿‡è°ƒæ•´ä¼˜å…ˆçº§ï¼Œå®ç°è·¯ç”±çš„å¤‡ä»½ï¼ˆå³ï¼šä¸»å¤‡å¤‡ä»½ï¼‰ã€‚ [RTA]ip route-static 20.0.0.0 30 10.1.1.2 [RTA]ip route-static 20.0.0.0 30 10.1.2.2 preference 70 # é˜²æ­¢è·¯ç”±ç¯å› [RTB]ip route-static 10.1.0.0 16 null0 å¼€å¯ssh [R1]public-key local create rsa The range of public key modulus is (512 ~ 2048). If the key modulus is greater than 512, it will take a few minutes. Press CTRL+C to abort. Input the modulus length [default = 1024]: Generating Keys... .. Create the key pair successfully. [R1]ssh server enable # è¿›å…¥ VTY è§†å›¾ï¼Œé…ç½®éªŒè¯æ¨¡å¼ä¸º schemeï¼Œè®¾ç½®ç”¨æˆ·æƒé™ä¸º Level-15ï¼Œå¹¶é…ç½®åè®®ä¸º ssh [R1]user-interface vty 0 4 [R1-line-vty0-4]authentication-mode scheme [R1-line-vty0-4]user-role level-15 [R1-line-vty0-4]protocol inbound ssh # åˆ›å»ºç”¨äºç™»å½•éªŒè¯çš„ç”¨æˆ·ï¼Œé…ç½®å¯†ç ï¼Œé…ç½®ç”¨æˆ·æƒé™ä¸º Level-15ï¼ŒæœåŠ¡ç±»å‹ä¸º ssh [R1]local-user wangdaye class manage New local user added. [R1-luser-manage-wangdaye]password simple 123456 [R1-luser-manage-wangdaye]service-type ssh [R1-luser-manage-wangdaye]authorization-attribute user-role level-15 ","date":"2024-03-23","objectID":"/posts/2024-03-24-route-switch-base/:1:0","tags":["network"],"title":"Route\u0026Swich åŸºç¡€","uri":"/posts/2024-03-24-route-switch-base/"},{"categories":["Network"],"content":"vlan # ä¼ æ•™vlan [SW1]vlan 10 [SW1-vlan10]vlan 20 # æŠŠäº¤æ¢æœºçš„å£åŠ åˆ°vlanä¸­ [SW1]int g1/0/2 [SW1-GigabitEthernet1/0/2]port access vlan 10 [SW1]int g1/0/3 [SW1-GigabitEthernet1/0/3]port access vlan 20 # è®¾ç½®trunkå£ [SW1]int g1/0/1 [SW1-GigabitEthernet1/0/1]port link-type trunk [SW1-GigabitEthernet1/0/1]port trunk permit vlan 10 20 å•è‡‚è·¯ç”± [SW1]vlan 10 [SW1]vlan 20 [SW1]int g1/0/2 [SW1-GigabitEthernet1/0/2]port access vlan 10 [SW1]int g1/0/3 [SW1-GigabitEthernet1/0/3]port access vlan 20 [SW1]int g1/0/1 [SW1-GigabitEthernet1/0/1]port link-type trunk [SW1-GigabitEthernet1/0/1]port trunk permit vlan 10 20 [R1]int g0/0.1 [R1-GigabitEthernet0/0.1]vlan-type dot1q vid 10 [R1-GigabitEthernet0/0.1]ip add 192.168.1.254 24 [R1]int g0/0.2 [R1-GigabitEthernet0/0.2]vlan-type dot1q vid 20 [R1-GigabitEthernet0/0.2]ip add 192.168.2.254 24 [R1]dis ip routing-table Destinations : 16 Routes : 16 Destination/Mask Proto Pre Cost NextHop Interface 0.0.0.0/32 Direct 0 0 127.0.0.1 InLoop0 127.0.0.0/8 Direct 0 0 127.0.0.1 InLoop0 127.0.0.0/32 Direct 0 0 127.0.0.1 InLoop0 127.0.0.1/32 Direct 0 0 127.0.0.1 InLoop0 127.255.255.255/32 Direct 0 0 127.0.0.1 InLoop0 192.168.1.0/24 Direct 0 0 192.168.1.254 GE0/0.1 192.168.1.0/32 Direct 0 0 192.168.1.254 GE0/0.1 192.168.1.254/32 Direct 0 0 127.0.0.1 InLoop0 192.168.1.255/32 Direct 0 0 192.168.1.254 GE0/0.1 192.168.2.0/24 Direct 0 0 192.168.2.254 GE0/0.2 192.168.2.0/32 Direct 0 0 192.168.2.254 GE0/0.2 192.168.2.254/32 Direct 0 0 127.0.0.1 InLoop0 192.168.2.255/32 Direct 0 0 192.168.2.254 GE0/0.2 224.0.0.0/4 Direct 0 0 0.0.0.0 NULL0 224.0.0.0/24 Direct 0 0 0.0.0.0 NULL0 255.255.255.255/32 Direct 0 0 127.0.0.1 InLoop0 [R1] ä¸‰å±‚äº¤æ¢æœºåšè·¯ç”± [SW1]vlan 10 [SW1-vlan10]vlan 20 [SW1]int g1/0/1 [SW1-GigabitEthernet1/0/1]port access vlan 10 [SW1]int g1/0/2 [SW1-GigabitEthernet1/0/2]port access vlan 20 [SW1]int vlan 10 [SW1-Vlan-interface10]ip add 192.168.1.254 24 [SW1]int vlan 20 [SW1-Vlan-interface20]ip add 192.168.2.254 24 [SW1]dis ip routing-table Destinations : 16 Routes : 16 Destination/Mask Proto Pre Cost NextHop Interface 0.0.0.0/32 Direct 0 0 127.0.0.1 InLoop0 127.0.0.0/8 Direct 0 0 127.0.0.1 InLoop0 127.0.0.0/32 Direct 0 0 127.0.0.1 InLoop0 127.0.0.1/32 Direct 0 0 127.0.0.1 InLoop0 127.255.255.255/32 Direct 0 0 127.0.0.1 InLoop0 192.168.1.0/24 Direct 0 0 192.168.1.254 Vlan10 192.168.1.0/32 Direct 0 0 192.168.1.254 Vlan10 192.168.1.254/32 Direct 0 0 127.0.0.1 InLoop0 192.168.1.255/32 Direct 0 0 192.168.1.254 Vlan10 192.168.2.0/24 Direct 0 0 192.168.2.254 Vlan20 192.168.2.0/32 Direct 0 0 192.168.2.254 Vlan20 192.168.2.254/32 Direct 0 0 127.0.0.1 InLoop0 192.168.2.255/32 Direct 0 0 192.168.2.254 Vlan20 224.0.0.0/4 Direct 0 0 0.0.0.0 NULL0 224.0.0.0/24 Direct 0 0 0.0.0.0 NULL0 255.255.255.255/32 Direct 0 0 127.0.0.1 InLoop0 [SW1] DHCP # å¼€å¯dhcp [R1]dhcp enable [R1]dhcp server ip-pool 1 [R1-dhcp-pool-1]network 192.168.1.0 mask 255.255.255.0 [R1-dhcp-pool-1]gateway-list 192.168.1.254 [R1-dhcp-pool-1]dns-list 202.103.24.68 202.103.0.117 # è®¾ç½®ä¸“ç”¨åœ°å€æ®µï¼Œè¦æ±‚ä¸èƒ½ç”¨äºè‡ªåŠ¨åˆ†é… [R1]dhcp server forbidden-ip 192.168.1.10 192.168.1.20 ","date":"2024-03-23","objectID":"/posts/2024-03-24-route-switch-base/:1:1","tags":["network"],"title":"Route\u0026Swich åŸºç¡€","uri":"/posts/2024-03-24-route-switch-base/"},{"categories":["DevOps"],"content":"OpenConnect å‚è€ƒæ–‡æ¡£ https://github.com/huataihuang/cloud-atlas-draft/blob/master/security/vpn/openconnect/deploy_ocserv_vpn_server_on_ubuntu.md https://www.cnblogs.com/grafin/p/17785264.html https://cn.linux-console.net/?p=22087 OpenConnectèµ·æºäºå¯¹Cisco AnyConnect VPNå®¢æˆ·ç«¯çš„å¼€æºæ›¿ä»£æ–¹æ¡ˆçš„éœ€æ±‚ã€‚Cisco AnyConnectæ˜¯ä¸€æ¬¾å•†ä¸šVPNè§£å†³æ–¹æ¡ˆï¼Œç”¨äºå»ºç«‹å®‰å…¨çš„è¿œç¨‹è¿æ¥ã€‚ç„¶è€Œï¼Œç”±äºå…¶é—­æºå’Œå•†ä¸šæ€§è´¨ï¼Œç¤¾åŒºå¯¹äºä¸€ä¸ªå¼€æºçš„æ›¿ä»£å“çš„éœ€æ±‚é€æ¸å¢åŠ ã€‚OpenConnectçš„å‘å±•æ—¨åœ¨å¡«è¡¥è¿™ä¸€ç©ºç™½ï¼Œä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªè‡ªç”±ã€çµæ´»ä¸”å®‰å…¨çš„VPNè¿æ¥é€‰é¡¹ã€‚ å·¥ä½œåŸç† OpenConnectçš„å·¥ä½œåŸç†åŸºäºä¸Cisco AnyConnectæœåŠ¡å™¨å»ºç«‹çš„å®‰å…¨è¿æ¥ã€‚å®ƒä½¿ç”¨SSLå’ŒDTLSåè®®è¿›è¡Œèº«ä»½éªŒè¯å’ŒåŠ å¯†é€šä¿¡ã€‚ç”¨æˆ·é¦–å…ˆæä¾›æ‰€éœ€çš„è¿æ¥å‚æ•°ï¼Œä¾‹å¦‚æœåŠ¡å™¨åœ°å€ã€ç”¨æˆ·åå’Œå¯†ç ã€‚ç„¶åï¼ŒOpenConnectä½¿ç”¨è¿™äº›å‚æ•°ä¸æœåŠ¡å™¨è¿›è¡Œæ¡æ‰‹å’Œè®¤è¯ã€‚ä¸€æ—¦èº«ä»½éªŒè¯æˆåŠŸï¼ŒVPNè¿æ¥å°†å»ºç«‹èµ·æ¥ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡åŠ å¯†é€šé“å®‰å…¨åœ°ä¼ è¾“æ•°æ®ã€‚ è½¯ä»¶åˆ†ä¸ºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ï¼š æœåŠ¡ç«¯ï¼šocserv å®¢æˆ·ç«¯ï¼šopenconnect å®¢æˆ·ç«¯æ”¯æŒçš„vpnæœåŠ¡æœ‰ Cisco AnyConnect SSL VPN Juniper Network Connect GlobalProtect SSL VPN F5 BIG-IP SSL VPN FortiGate SSL VPN Array Networks SSL VPN Set VPN protocol: --protocol=anyconnect Compatible with Cisco AnyConnect SSL VPN, as well as ocserv (default) --protocol=nc Compatible with Juniper Network Connect --protocol=gp Compatible with Palo Alto Networks (PAN) GlobalProtect SSL VPN --protocol=pulse Compatible with Pulse Connect Secure SSL VPN --protocol=f5 Compatible with F5 BIG-IP SSL VPN --protocol=fortinet Compatible with FortiGate SSL VPN --protocol=array Compatible with Array Networks SSL VPN ","date":"2024-03-23","objectID":"/posts/2024-03-21-openconnect/:1:0","tags":["OpenConnect","vpn"],"title":"OpenConnect","uri":"/posts/2024-03-21-openconnect/"},{"categories":["DevOps"],"content":"ä¸€ã€éƒ¨ç½² 1ã€å®‰è£… ocserv RHEL ç³»åˆ— ocserv å·²ç»åœ¨ epel ä»“åº“ä¸­æä¾›äº†ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡ yum å®‰è£… [root@dev ~]# yum install epel-release # gnutls-utils åŒ…å«è¯ä¹¦çš„åˆ¶ä½œå·¥å…· certtool [root@dev ~]# yum install ocserv gnutls-utils 2ã€ç”Ÿæˆè¯ä¹¦ [root@dev ~]# mkdir /opt/anyconnect [root@dev ~]# cd /opt/anyconnect/ # ç”Ÿæˆ CA è¯ä¹¦ [root@dev ~]# certtool --generate-privkey --outfile ca-key.pem cat \u003eca.tmpl \u003c\u003cEOF cn = \"VPN CA\" organization = \"Local Corp\" serial = 1 expiration_days = 36500 ca signing_key cert_signing_key crl_signing_key EOF [root@dev ~]# certtool --generate-self-signed --load-privkey ca-key.pem \\ --template ca.tmpl --outfile ca-cert.pem # å¤åˆ¶ CA è¯ä¹¦åˆ° ocserv é…ç½®ç›®å½•ä¸­ [root@dev ~]# cp ca-key.pem /etc/ocserv/ # åˆ›å»ºæœåŠ¡ç«¯è¯ä¹¦ [root@dev ~]# certtool --generate-privkey --outfile server-key.pem [root@dev ~]# cat \u003eserver.tmpl \u003c\u003cEOF cn = \"VPN server\" organization = \"Local\" serial = 2 expiration_days = 3650 encryption_key signing_key tls_www_server EOF [root@dev ~]# certtool --generate-certificate --load-privkey server-key.pem \\ --load-ca-certificate ca-cert.pem --load-ca-privkey ca-key.pem \\ --template server.tmpl --outfile server-cert.pem [root@dev ~]# cp server-cert.pem server-key.pem /etc/ocserv/ 3ã€é…ç½®ocserv /etc/ocserv/ocserv.conf #ocservæ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼Œè¿™æ˜¯è‡ªå¸¦çš„å¯†ç è®¤è¯ï¼Œä½¿ç”¨ocpasswdåˆ›å»ºå¯†ç æ–‡ä»¶ #ocservè¿˜æ”¯æŒè¯ä¹¦è®¤è¯ï¼Œå¯ä»¥é€šè¿‡Pluggable Authentication Modules (PAM)ä½¿ç”¨radiusç­‰è®¤è¯æ–¹å¼ auth = \"plain[passwd=/etc/ocserv/ocpasswd]\" #æŒ‡å®šæ›¿ä»£çš„ç™»å½•æ–¹å¼ï¼Œè¿™é‡Œä½¿ç”¨è¯ä¹¦ç™»å½•ä½œä¸ºç¬¬äºŒç§ç™»å½•æ–¹å¼ #æŒ‡å®šæ›¿ä»£çš„ç™»å½•æ–¹å¼ï¼Œè¿™é‡Œä½¿ç”¨è¯ä¹¦ç™»å½•ä½œä¸ºç¬¬äºŒç§ç™»å½•æ–¹å¼ #enable-auth = \"certificate\" #tcpå’Œudpç«¯å£ tcp-port = 44333 udp-port = 44333 #è¿è¡Œç”¨æˆ·å’Œç»„ run-as-user = ocserv run-as-group = ocserv # socketæ–‡ä»¶ socket-file = /var/run/ocserv.sock #è¯ä¹¦è·¯å¾„ server-cert = /etc/ocserv/server-cert.pem server-key = /etc/ocserv/server-key.pem #caè·¯å¾„ ca-cert = /etc/ocserv/ca-cert.pem # å¼€å¯lz4å‹ç¼© compression = true # éš”ç¦»å·¥ä½œï¼Œé»˜è®¤ä¸åŠ¨ isolate-workers = true # æœ€å¤§å®¢æˆ·ç«¯æ•°é‡ï¼Œ0è¡¨ç¤ºæ— é™æ•°é‡ max-clients = 16 # åŒä¸€ç”¨æˆ·å¯ä»¥åŒæ—¶ç™»é™†çš„å®¢æˆ·ç«¯æ•°é‡ max-same-clients = 5 # é»˜è®¤ä¸åŠ¨ rate-limit-ms = 100 # æœåŠ¡å™¨ç»Ÿè®¡é‡ç½®æ—¶é—´ï¼Œä¸åŠ¨ server-stats-reset-time = 604800 # ä¿æŒè¿æ¥ï¼Œæ¯éš”å¤šå°‘ç§’å‘å®¢æˆ·ç«¯å‘é€è¿æ¥æ•°æ®åŒ…ï¼Œé˜²æ­¢æ–­çº¿ã€‚ # IOSç³»ç»Ÿ5åˆ†é’Ÿä¼šå…³é—­åå°æ•°æ®é€šè®¯ï¼Œç„¶åå°±ä¼šæ–­çº¿ã€‚ # å› æ­¤å°†keepaliveå’Œmobile-dpdè®¾ç½®æˆ200ç§’ keepalive = 200 dpd = 90 mobile-dpd = 200 # udpç«¯å£æ— ä¼ è¾“25ç§’åè½¬æˆtcpç«¯å£ switch-to-tcp-timeout = 25 # å¯ç”¨MTUè½¬å‘ä»¥ä¼˜åŒ–æ€§èƒ½ try-mtu-discovery = true # ç©ºé—²æ–­å¼€æ—¶é—´ï¼Œå¦‚æœæƒ³æ— é™æœŸè¿æ¥ï¼Œæ³¨é‡Šè¿™ä¸¤è¡Œ # idle-timeout=1200 # mobile-idle-timeout=2400 # ä»…ä½¿ç”¨TLS1.2ä»¥ä¸Šç‰ˆæœ¬ cert-user-oid = 0.9.2342.19200300.100.1.1 tls-priorities = \"NORMAL:%SERVER_PRECEDENCE:%COMPAT:-RSA:-VERS-SSL3.0:-ARCFOUR-128:-VERS-TLS1.0:-VERS-TLS1.1\" # è®¤è¯è¶…æ—¶æ—¶é—´ auth-timeout = 240 # æœ€å°é‡æ–°è®¤è¯æ—¶é—´ min-reauth-time = 300 max-ban-score = 80 ban-reset-time = 1200 cookie-timeout = 324000 deny-roaming = false rekey-time = 172800 rekey-method = ssl use-occtl = true pid-file = /var/run/ocserv.pid device = vpns predictable-ips = true # é»˜è®¤åŸŸåï¼Œä¿®æ”¹ä¸ºä½ çš„åŸŸåæˆ–ipåœ°å€ï¼Œè¿™ä¸ªè®¾ç½®æ²¡æœ‰ä»»ä½•ä½œç”¨ default-domain = xxx.com:4433 # é…ç½®è‡ªå®šä¹‰ç§æœ‰IPåœ°å€èŒƒå›´(vpnå®¢æˆ·ç«¯)ï¼Œæ³¨é‡Šé»˜è®¤çš„ä¸¤è¡Œ #ipv4-network = 192.168.1.0 #ipv4-netmask = 255.255.255.0 ipv4-network = 10.70.25.0 ipv4-netmask = 255.255.255.0 # ä»¥VPNéš§é“ä¼ è¾“æ‰€æœ‰DNSæŸ¥è¯¢ tunnel-all-dns = true # æ›´æ”¹DNSæœåŠ¡å™¨(å›½å†…æœåŠ¡å™¨å°±å¡«å†™å›½å†…dns) dns = 8.8.8.8 dns = 1.1.1.1 # å…è®¸æ€ç§‘å®¢æˆ·ç«¯è¿æ¥ cisco-client-compat = true # ä»¥ä¸‹è·¯ç”±è¡¨ä¸é€šè¿‡VPNéš§é“ï¼Œç›´æ¥æœ¬åœ°ç½‘ç»œè¿æ¥ # ä¸€å®šè¦æ·»åŠ è‡ªå·±æœåŠ¡å™¨çš„ipåœ°å€ï¼Œå¦åˆ™è¿ä¸ŠVPNåæ‰“ä¸å¼€è‡ªå·±çš„ç½‘ç«™ no-route = x.x.x.x/255.255.255.255 #åªå…è®¸è®¿é—®ä¸‹é¢çš„ç½‘æ®µ(æ¨é€çš„è·¯ç”±) route = 192.168.0.0/255.255.0.0 route = 172.16.0.0/255.255.0.0 4ã€åˆ›å»ºç”¨æˆ· #usernameä¸ºä½ è¦æ·»åŠ çš„ç”¨æˆ·å [root@dev ~]# ocpasswd -c /etc/ocserv/ocpasswd username # æ£€æŸ¥å†…æ ¸è½¬å‘ [root@dev ~]# cat /proc/sys/net/ipv4/ip_forward # å¼€å¯å†…æ ¸è½¬å‘ [root@dev ~]# echo \"net.ipv4.ip_forward = 1\" \u003e\u003e /etc/sysctl.conf [root@dev ~]# sysctl -p # é…ç½®iptablesè§„åˆ™(ä¸éœ€è¦é…ç½®) # å¯¹æŒ‡å®šçš„è¡¨ table è¿›è¡Œæ“ä½œï¼Œæ·»åŠ ä¸€ä¸ªè§„åˆ™ï¼ŒæŠŠ192.168.111.0çš„æµé‡æŒ‡å®šåˆ°ens36å‡ºå» iptables -t nat -A POSTROUTING -s 192.168.111.0 -o ens36 -j MASQUERADE iptables -A FORWARD -i vpns+ -j ACCEPT iptables -A FORWARD -o vpns+ -j ACCEPT # ä¿å­˜è·¯ç”±è¡¨ iptables-save \u003e /etc/sysconfig/iptables # æ”¾è¡Œç«¯å£(firewalldé…ç½®) firewall-cmd --permanent --add-port=44333/tcp firewall-cmd --permanent --add-port=44333/udp firewall-cmd --add-masquerade --permanent #å¿…é¡»é…ç½®ï¼Œé‡è¦ firewall-cmd --reload 5ã€æµ‹è¯• æµ‹è¯•æœåŠ¡å¯åŠ¨ [root@dev ~]# ocserv -c /etc/ocserv/ocserv.conf -f -d 10 å¯åŠ¨æœåŠ¡ [root@dev ~]# systemctl enable ocserv [root@dev ~]# systemctl start ","date":"2024-03-23","objectID":"/posts/2024-03-21-openconnect/:1:1","tags":["OpenConnect","vpn"],"title":"OpenConnect","uri":"/posts/2024-03-21-openconnect/"},{"categories":["DevOps"],"content":"K3s è¯ä¹¦ k3s æ ¹CAè¯ä¹¦é»˜è®¤10å¹´ï¼Œç­¾ç½²çš„è¯ä¹¦æœ‰æ•ˆæœŸé»˜è®¤1å¹´ï¼Œåœ¨åˆ°æœŸå‰çš„90å¤©å†…éœ€è¦é‡å¯ï¼Œé‡å¯åä¼šè‡ªåŠ¨è½®è½¬è¯ä¹¦ã€‚ å‚è€ƒæ–‡æ¡£ï¼š https://forums.rancher.cn/t/k3s-ca-10/331 https://blog.starudream.cn/2023/07/21/k3s-client-cert-extend/ https://forums.rancher.cn/t/k3s-ca-10/331/37 https://github.com/qkboy/k3s/tree/v1.29.0%2Bk3s1-longcert https://docs.k3s.io/zh/cli/certificate#%E8%BD%AE%E6%8D%A2%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%81%E4%B9%A6 https://www.linuxfly.org/post/733/ ","date":"2024-03-21","objectID":"/posts/2024-03-11-k3s-cert/:0:0","tags":["k3s cert"],"title":"k3s-cert","uri":"/posts/2024-03-11-k3s-cert/"},{"categories":["DevOps"],"content":"ä¸€ã€æ‰‹åŠ¨è½®è½¬è¯ä¹¦ 1ã€æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ # server for i in `ls /var/lib/rancher/k3s/server/tls/*.crt`; do echo $i; openssl x509 -enddate -noout -in $i; done # agent for i in `ls /var/lib/rancher/k3s/agent/*.crt`; do echo $i; openssl x509 -enddate -noout -in $i; done 2ã€è®¾ç½®ç¯å¢ƒå˜é‡ echo CATTLE_NEW_SIGNED_CERT_EXPIRATION_DAYS=\"3600\" \u003e\u003e /etc/default/k3s 3ã€è½®è½¬è¯ä¹¦ server # åœæ­¢ K3s systemctl stop k3s # è½®æ¢è¯ä¹¦ k3s certificate rotate # å¯åŠ¨ K3s systemctl start k3s agent systemctl restart k3s-agent 4ã€æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ for i in `ls /var/lib/rancher/k3s/server/tls/*.crt`; do echo $i; openssl x509 -enddate -noout -in $i; done kubectl get secret -n kube-system k3s-serving -o jsonpath='{.data.tls\\.crt}' | base64 -d | openssl x509 -noout -text | grep Not ","date":"2024-03-21","objectID":"/posts/2024-03-11-k3s-cert/:1:0","tags":["k3s cert"],"title":"k3s-cert","uri":"/posts/2024-03-11-k3s-cert/"},{"categories":["DevOps"],"content":"äºŒã€ä¿®æ”¹æºç æ–¹å¼ k3s æ˜¯å¼•ç”¨dynamiclistener è¿™ä¸ªåº“æ¥ç”Ÿæˆè¯ä¹¦çš„ï¼Œå¯ä»¥ä¿®æ”¹æºç å®ç°ç™¾å¹´è¯ä¹¦ ","date":"2024-03-21","objectID":"/posts/2024-03-11-k3s-cert/:2:0","tags":["k3s cert"],"title":"k3s-cert","uri":"/posts/2024-03-11-k3s-cert/"},{"categories":["DevOps"],"content":"ä¸‰ã€è‡ªå®šä¹‰è¯ä¹¦ k3s å®˜æ–¹æœ‰æä¾›è„šæœ¬ç”¨äºåœ¨åˆ›å»ºé›†ç¾¤å‰å…ˆåˆ›å»ºè¯ä¹¦ wget https://raw.githubusercontent.com/k3s-io/k3s/master/contrib/util/generate-custom-ca-certs.sh sed -ri 's/7300/36500/g' generate-custom-ca-certs.sh sed -ri 's/3700/36500/g' generate-custom-ca-certs.sh echo CATTLE_NEW_SIGNED_CERT_EXPIRATION_DAYS=\"36500\" \u003e /etc/default/k3s bash generate-custom-ca-certs.sh curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn INSTALL_K3S_EXEC=\"--disable=traefik --disable=servicelb --kube-proxy-arg proxy-mode=ipvs --write-kubeconfig ~/.kube/config --write-kubeconfig-mode 644 \" sh -s - --docker check for i in `ls /var/lib/rancher/k3s/server/tls/*.crt`; do echo $i; openssl x509 -enddate -noout -in $i; done kubectl get secret -n kube-system k3s-serving -o jsonpath='{.data.tls\\.crt}' | base64 -d | openssl x509 -noout -text | grep Not ","date":"2024-03-21","objectID":"/posts/2024-03-11-k3s-cert/:3:0","tags":["k3s cert"],"title":"k3s-cert","uri":"/posts/2024-03-11-k3s-cert/"},{"categories":["DevOps"],"content":"å››ã€RBAC ç®¡ç† 1ã€åˆ›å»ºè¯ä¹¦å’Œç­¾åè¯·æ±‚ [root@dev ~]# openssl genrsa -out dev.key 2048 [root@dev ~]# openssl req -new -key dev.key -out dev.csr -subj \"/CN=dev/O=dev\" 2ã€åˆ›å»º csr ï¼Œè¯·æ±‚ç­¾å [root@dev ~]# cat \u003c\u003cEOF | kubectl apply -f - apiVersion: certificates.k8s.io/v1 kind: CertificateSigningRequest metadata: name: dev spec: groups: - system:authenticated request: $(cat dev.csr | base64 | tr -d '\\n') signerName: kubernetes.io/kube-apiserver-client usages: - client auth EOF [root@dev ~]# kubectl get csr [root@dev ~]# kubectl certificate approve dev [root@dev ~]# kubectl get csr dev -o jsonpath='{.status.certificate}' | base64 -d \u003e dev.crt 3ã€ç”Ÿæˆè¯ä¹¦ # å¤åˆ¶ä¸€ä»½å½“å‰çš„è¯ä¹¦ä½œä¸ºæ¨¡æ¿ [root@dev ~]# cp ~/.kube/config local-config [root@dev ~]# kubectl config set-credentials default --client-key=dev.key --client-certificate=dev.crt --embed-certs=true --kubeconfig=local-config [root@dev ~]# kubectl config set-context default --cluster=default --user=default --kubeconfig=local-config è¯ä¹¦æœ‰æ•ˆæœŸé»˜è®¤æ˜¯ä¸€å¹´ 4ã€rbac é…ç½® https://github.com/serialt/terraform-module-k8s-rbac rbacï¼ˆç”¨äºæµ‹è¯•ï¼‰ [root@dev ~]# cat \u003e rbac.yaml \u003c\u003cEOF apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: namespace: default name: dev rules: - apiGroups: [\"\"] #core apiç»„ resources: [\"pods\"] verbs: [\"get\", \"watch\", \"list\"] --- apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: dev namespace: default #æˆæƒçš„å‘½åç©ºé—´ä¸ºdefault subjects: - kind: User name: dev # ç»‘å®šdevç”¨æˆ· apiGroup: rbac.authorization.k8s.io roleRef: kind: Role name: dev #ç»‘å®šRole apiGroup: rbac.authorization.k8s.io EOF kubectl apply -f rbac.yaml [root@dev ~]# export KUBECONFIG=local-config [root@dev ~]#kubectl get pod NAME READY STATUS RESTARTS AGE myapp-deployment-6587ffc4b-ws4hm 1/1 Running 2 27d myapp-deployment-6587ffc4b-zx8g2 1/1 Running 1 27d [root@master-01 user]# kubectl get ns Error from server (Forbidden): namespaces is forbidden: User \"dev\" cannot list resource \"namespaces\" in API group \"\" at the cluster scope [root@dev ~]# kubectl get svc Error from server (Forbidden): services is forbidden: User \"dev\" cannot list resource \"services\" in API group \"\" in the namespace \"default\" ","date":"2024-03-21","objectID":"/posts/2024-03-11-k3s-cert/:4:0","tags":["k3s cert"],"title":"k3s-cert","uri":"/posts/2024-03-11-k3s-cert/"},{"categories":["DevOps"],"content":"Terraform Registry Mirror terraform çš„ provider æ‰˜ç®¡åœ¨æµ·å¤–ï¼Œä½¿ç”¨æ—¶å€™ä¼šç»å¸¸å› ä¸ºç½‘ç»œé—®é¢˜å¯¼è‡´ä¸‹è½½å¤±è´¥ï¼Œterraform å®˜æ–¹æœ‰ Provider Network Mirror Protocolï¼Œæ”¯æŒä½¿ç”¨æœ¬åœ°æ–‡ä»¶å’Œ Static Websiteï¼Œåˆ¶ä½œæ–¹æ³•éƒ½ä¾èµ–äºterraform providers mirror å‘½ä»¤è·å–åˆ°çš„èµ„æºã€‚ ","date":"2024-03-17","objectID":"/posts/2024-03-17-tf-mirror-registery/:1:0","tags":["terraform-registry","hashicorp"],"title":"Terraform Registry Mirror","uri":"/posts/2024-03-17-tf-mirror-registery/"},{"categories":["DevOps"],"content":"1ã€åˆ¶ä½œç¦»çº¿ provider èµ„æº åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆ provider.tf æ–‡ä»¶ terraform { required_providers { docker = { source = \"kreuzwerker/docker\" version = \"2.20.3\" } } } åˆ›å»ºå­˜å‚¨çš„ç›®å½•ï¼Œå¹¶ä¸‹è½½ provider # ä¸‹è½½å½“å‰ç‰ˆ terraform æ¶æ„çš„ provider åˆ° provider ç›®å½•ï¼Œå¯ä»¥ç”¨ -platform=OS_ARCH æŒ‡å®šæ¶æ„ [serialt@Sugar tf-demo]ğŸ³ mkdir providers terraform providers mirror providers # ä¸‹è½½ darwin_arm64 linux_amd64 [serialt@Sugar tf-demo]ğŸ³ terraform providers mirror -platform=linux_amd64 providers [serialt@Sugar tf-demo]ğŸ³ terraform providers mirror -platform=darwin_arm64 providers [serialt@Sugar tf-demo]ğŸ³ tree providers providers â””â”€â”€ registry.terraform.io â””â”€â”€ kreuzwerker â””â”€â”€ docker â”œâ”€â”€ 2.20.3.json â”œâ”€â”€ index.json â”œâ”€â”€ terraform-provider-docker_2.20.3_darwin_arm64.zip â””â”€â”€ terraform-provider-docker_2.20.3_linux_amd64.zip 3 directories, 4 files ","date":"2024-03-17","objectID":"/posts/2024-03-17-tf-mirror-registery/:1:1","tags":["terraform-registry","hashicorp"],"title":"Terraform Registry Mirror","uri":"/posts/2024-03-17-tf-mirror-registery/"},{"categories":["DevOps"],"content":"2ã€æœ¬åœ°æ–‡ä»¶é•œåƒ é…ç½®æ’ä»¶ç¼“å­˜ç›®å½• export TF_PLUGIN_CACHE_DIR=/home/user/.terraform.d/plugin-cache é…ç½® ~/.terraformrc provider_installation { filesystem_mirror { path = \"/home/user/tf-demo/providers\" include = [\"*/*/*\"] } direct { exclude = [\"*/*/*\"] } } [serialt@Sugar tf-ccc]ğŸ³ terraform init Initializing the backend... Initializing provider plugins... - Finding kreuzwerker/docker versions matching \"2.20.3\"... - Installing kreuzwerker/docker v2.20.3... - Installed kreuzwerker/docker v2.20.3 (unauthenticated) Terraform has created a lock file .terraform.lock.hcl to record the provider selections it made above. Include this file in your version control repository so that Terraform can guarantee to make the same selections by default when you run \"terraform init\" in the future. â•· â”‚ Warning: Incomplete lock file information for providers â”‚ â”‚ Due to your customized provider installation methods, Terraform was forced to â”‚ calculate lock file checksums locally for the following providers: â”‚ - kreuzwerker/docker â”‚ â”‚ The current .terraform.lock.hcl file only includes checksums for â”‚ darwin_arm64, so Terraform running on another platform will fail to install â”‚ these providers. â”‚ â”‚ To calculate additional checksums for another platform, run: â”‚ terraform providers lock -platform=linux_amd64 â”‚ (where linux_amd64 is the platform to generate) â•µ Terraform has been successfully initialized! You may now begin working with Terraform. Try running \"terraform plan\" to see any changes that are required for your infrastructure. All Terraform commands should now work. If you ever set or change modules or backend configuration for Terraform, rerun this command to reinitialize your working directory. If you forget, other commands will detect it and remind you to do so if necessary. ","date":"2024-03-17","objectID":"/posts/2024-03-17-tf-mirror-registery/:1:2","tags":["terraform-registry","hashicorp"],"title":"Terraform Registry Mirror","uri":"/posts/2024-03-17-tf-mirror-registery/"},{"categories":["DevOps"],"content":"3ã€ç½‘ç»œé•œåƒ nginxé…ç½®æ–‡ä»¶ server { server_name tf-mirror.local.com; listen 80; return 301 https://$server_name$request_uri; } server{ server_name tf-mirror.local.com; listen 443 ssl; charset utf-8; gzip on; gzip_min_length 1K; gzip_comp_level 4; gzip_buffers 32 4K; gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png; gzip_vary on; add_header Strict-Transport-Security \"max-age=31536000; includeSubDomians;proload\" always; root /data/terraform-mirror/; index index.html index.htm; try_files $uri $uri/ /index.html; client_max_body_size 20m; access_log /var/log/nginx/tf-mirror.local.com.log main; error_log /var/log/nginx/tf-mirror.local.com-err.log; ssl_certificate /etc/nginx/cert_files/local.com.crt; ssl_certificate_key /etc/nginx/cert_files/local.com.key; } ä¸Šä¼ ä¸‹è½½çš„ provider èµ„æºåˆ° web æ ¹ç›®å½• ä¾‹å¦‚ï¼š/data/terraform-mirror/ [serialt@Sugar tf-ccc]ğŸ³ scp -r ./providers local.com:/data/terraform-mirror/ å¯åŠ¨nginxæœåŠ¡ é…ç½®~/.terraformrcæ–‡ä»¶ provider_installation { network_mirror { url = \"https://tf-mirror.local.com/providers/\" } } [serialt@Sugar tf-ccc]ğŸ³ terraform init Initializing the backend... Initializing provider plugins... - Finding latest version of hashicorp/random... - Installing hashicorp/random v3.6.0... - Installed hashicorp/random v3.6.0 (verified checksum) Terraform has created a lock file .terraform.lock.hcl to record the provider selections it made above. Include this file in your version control repository so that Terraform can guarantee to make the same selections by default when you run \"terraform init\" in the future. Terraform has been successfully initialized! You may now begin working with Terraform. Try running \"terraform plan\" to see any changes that are required for your infrastructure. All Terraform commands should now work. If you ever set or change modules or backend configuration for Terraform, rerun this command to reinitialize your working directory. If you forget, other commands will detect it and remind you to do so if necessary. ","date":"2024-03-17","objectID":"/posts/2024-03-17-tf-mirror-registery/:1:3","tags":["terraform-registry","hashicorp"],"title":"Terraform Registry Mirror","uri":"/posts/2024-03-17-tf-mirror-registery/"},{"categories":["DevOps"],"content":"4ã€åŸºäºè„šæœ¬ä¸‹è½½ provider ç¦»çº¿èµ„æº https://github.com/serialt/terraform-registry-mirror è¦æ±‚ï¼š terraform jq 1ï¼‰ä¿®æ”¹ä¸‹è½½çš„å¹³å°å’Œæ¶æ„ sed -ri PLATFORMS=\"linux_amd64 darwin_amd64 darwin_arm64\" sed -ri '/^PLATFORMS=/cPLATFORMS=\"linux_amd64 darwin_amd64 darwin_arm64\"' bin/mirror.sh sed -ri '/^PLATFORMS=/cPLATFORMS=\"linux_amd64 darwin_amd64 darwin_arm64\"' bin/core.sh 2ï¼‰ä¸‹è½½ terraform bin/core.sh terraform.json 3ï¼‰ä¸‹è½½ provider # ä¸‹è½½å•ä¸ª bin/core.sh ./providers/aws.json # ä¸‹è½½å¤šä¸ª mirror(){ action=$1 providers=`ls ./providers` for i in ${providers};do bash ./bin/${action} ./providers/${i} done } mirror mirror.sh # mirror updater.sh ","date":"2024-03-17","objectID":"/posts/2024-03-17-tf-mirror-registery/:1:4","tags":["terraform-registry","hashicorp"],"title":"Terraform Registry Mirror","uri":"/posts/2024-03-17-tf-mirror-registery/"},{"categories":["DevOps"],"content":"Packer å‚è€ƒé“¾æ¥ï¼š https://developer.hashicorp.com/packer/docs?product_intent=packer https://blog.k8s.li/packer-vsphere-example.html https://cloud.tencent.com/developer/article/1474736 https://blog.csdn.net/weixin_45941099/article/details/123838526 https://github.com/serialt/packer-demo https://lonegunmanb.github.io/packer-handbook/ ","date":"2024-03-16","objectID":"/posts/2024-03-15-packer/:1:0","tags":["packer","hashicorp"],"title":"Packer","uri":"/posts/2024-03-15-packer/"},{"categories":["DevOps"],"content":"ä»‹ç»ï¼š Packeræ˜¯ç”¨ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œåœ¨å¤šç§äº‘è®¡ç®—å¹³å°ä¸Šåˆ›å»ºå®Œå…¨ä¸€è‡´é•œåƒçš„å¼€æºå·¥å…·ã€‚Packeræ˜¯ç”±HashiCorpåœ¨2013å¹´å·¦å³æ¨å‡ºçš„ã€‚Packerå¯ä»¥åœ¨å„ç§ä¸»æµæ“ä½œç³»ç»Ÿä¸Šè¿è¡Œï¼Œå¯ä»¥é«˜é€Ÿã€å¹¶è¡Œåœ¨å¤šç§äº‘å¹³å°ä¸Šåˆ›å»ºé•œåƒã€‚Packerå¹¶ä¸èƒ½å–ä»£puppetæˆ–è€…Chefä¹‹ç±»çš„ä¸»æœºé…ç½®å·¥å…·ï¼Œè€Œæ˜¯äº’ä¸ºè¡¥å……-Packeråœ¨åˆ›å»ºé•œåƒæ—¶ï¼Œå¯ä»¥è°ƒç”¨è¿™äº›å·¥å…·åœ¨åŸºç¡€é•œåƒä¸Šå®‰è£…ã€é…ç½®è½¯ä»¶ã€‚ é•œåƒæ˜¯æŒ‡ä¸€ä¸ªé¢„å…ˆå®‰è£…äº†è½¯ä»¶ã€é…ç½®å¥½äº†çš„æ“ä½œç³»ç»Ÿï¼Œè¿™ä¸ªé•œåƒå¯ä»¥è¢«ç”¨å¼€å¿«é€Ÿåˆ›å»ºäº‘ä¸»æœºã€‚æ¯ä¸ªäº‘å¹³å°é€šå¸¸æœ‰ä¸åŒçš„é•œåƒæ ¼å¼ã€‚ Packerè§£å†³ä»€ä¹ˆé—®é¢˜ ä½¿ç”¨é¢„å…ˆå‡†å¤‡å¥½çš„é•œåƒæœ‰å¾ˆå¤šå¥½å¤„ï¼Œä½†æ˜¯å¾ˆå¤šäººéƒ½ä¸å¤ªæ„¿æ„ä½¿ç”¨è¿™ç§æ–¹å¼ï¼ŒåŸå› æ˜¯åˆ›å»ºå’Œç®¡ç†é•œåƒå®åœ¨æ˜¯å¤ªå¤æ‚äº†ã€‚æ‰€ä»¥åœ¨Packerå‡ºç°ä¹‹å‰ï¼Œé•œåƒéƒ½æ˜¯äººå·¥åœ¨äº‘å¹³å°ä¸Šæ­å»ºä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼Œç„¶åé€šè¿‡äº‘å¹³å°çš„åŠŸèƒ½è½¬æ¢æˆé•œåƒè€Œåˆ›å»ºçš„ï¼Œè¿™å¯¹è¿ç»´å›¢é˜Ÿçš„é€Ÿåº¦å½±å“å¾ˆå¤§ï¼Œå› æ­¤å¤§å®¶éƒ½ä¸æ€ä¹ˆä½¿ç”¨é•œåƒã€‚ Packerçš„å‡ºç°è§£å†³äº†è¿™äº›é—®é¢˜ã€‚Packeråªæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œæ˜“äºé€šè¿‡ç»ˆç«¯ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å¾ˆç®€å•çš„æ”¾åˆ°è‡ªåŠ¨åŒ–å·¥å…·é‡Œè¾¹ï¼Œç”¨æ¥è‡ªåŠ¨åˆ›å»ºä»»ä½•ç±»å‹çš„ä¸»æœºé•œåƒã€‚ ä½¿ç”¨Packerçš„å¥½å¤„ å¿«é€Ÿçš„åŸºç¡€æ¶æ„å®æ–½ï¼šPackeråˆ›å»ºçš„é•œåƒå¯ä»¥è®©è¿ç»´äººå‘˜å‡ ç§’é’Ÿå†…åˆ›å»ºä¸€ä¸ªé¢„å…ˆé…ç½®å¥½çš„äº‘ä¸»æœºï¼Œè€Œä¸æ˜¯å‡ åˆ†é’Ÿç”šè‡³å‡ ä¸ªå°æ—¶ã€‚è¿™ä¸€å¥½å¤„ä¸ä½†å¯¹ç”Ÿäº§ç¯å¢ƒï¼Œä¹Ÿå¯¹æµ‹è¯•åŠå¼€å‘ç¯å¢ƒæœ‰ç›Šã€‚ å¤šå¹³å°å…¼å®¹ï¼šç”±äºPackerå¯ä»¥ä¸ºå¤šä¸ªå¹³å°åˆ›å»ºå®Œå…¨ä¸€è‡´çš„é•œåƒï¼Œä½ å¯ä»¥åœ¨è…¾è®¯äº‘ä¸Šè¿è¡Œç”Ÿäº§ç¯å¢ƒï¼Œåœ¨è‡ªå·±çš„ç§æœ‰äº‘é‡Œè¾¹è¿è¡Œæµ‹è¯•ç¯å¢ƒï¼Œåœ¨è‡ªå·±çš„vmwareè™šæ‹Ÿæœºé‡Œè¿è¡Œå¼€å‘ç¯å¢ƒã€‚è€Œæ¯ä¸ªç¯å¢ƒéƒ½å®Œå…¨ä¸€è‡´ã€‚ æé«˜ç¨³å®šæ€§ï¼šPackeråœ¨åˆ›å»ºé•œåƒæ—¶å®‰è£…å¹¶é…ç½®è½¯ä»¶ã€‚å®‰è£…æˆ–è€…é…ç½®æ­¥éª¤ä¸­çš„é—®é¢˜ä¼šåœ¨è¿™æ—¶å€™å‘ç°ï¼Œè€Œä¸æ˜¯åœ¨ç©¿ä»¶äº‘ä¸»æœºçš„æ—¶å€™ã€‚ æé«˜å¯æµ‹è¯•æ€§ï¼šé•œåƒåˆ›å»ºå®Œæˆåï¼Œå¯ä»¥å¾ˆå¿«çš„å¯åŠ¨ä¸€ä¸ªäº‘ä¸»æœºå¹¶å¯¹å…¶è¿›è¡Œæµ‹è¯•ã€‚å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œé‚£å°±å¯ä»¥ç›¸ä¿¡ï¼Œé€šè¿‡è¿™ä¸ªé•œåƒåˆ›å»ºçš„äº‘ä¸»æœºéƒ½ä¼šé€šè¿‡æµ‹è¯•ã€‚ ","date":"2024-03-16","objectID":"/posts/2024-03-15-packer/:1:1","tags":["packer","hashicorp"],"title":"Packer","uri":"/posts/2024-03-15-packer/"},{"categories":["DevOps"],"content":"å…·ä½“ç”¨ä¾‹ åœ¨æŒç»­å¼€å‘ã€æŒç»­äº¤ä»˜Pipelineé‡Œä½¿ç”¨Packer Packeræ˜¯ç”¨å‘½ä»¤è¡Œé©±åŠ¨çš„ï¼Œè€Œä¸”ä¸éœ€è¦å¾ˆå¤šèµ„æºã€‚å› æ­¤å¯ä»¥å¾ˆå®¹æ˜“æŠŠPackeræ”¾åˆ°æŒç»­äº¤ä»˜çš„pipelineé‡Œï¼Œåˆ›å»ºé•œåƒã€‚åœ¨æŒç»­äº¤ä»˜éšåçš„æ­¥éª¤ä¸­ï¼Œå¯ä»¥å¯¹æ­¤é•œåƒè¿›è¡Œæµ‹è¯•ï¼Œçœ‹åŸºç¡€è®¾æ–½çš„å˜åŒ–æ˜¯ä¸æ˜¯èƒ½å¤Ÿé€šè¿‡æµ‹è¯•ã€‚å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œé‚£å°±å¯ä»¥ç›¸ä¿¡åœ¨è¿™ä¸€é•œåƒåŸºç¡€ä¸Šæ­å»ºçš„äº‘ä¸»æœºä¹Ÿä¼šå·¥ä½œã€‚è¿™å¯¹åŸºç¡€è®¾æ–½å˜åŒ–çš„ç¨³å®šæ€§å’Œå¯æµ‹è¯•æ€§æä¾›äº†åŸºç¡€ã€‚ ä¿è¯å¼€å‘ä¸ç”Ÿäº§ç¯å¢ƒçš„ä¸€è‡´æ€§ Packerå¯ä»¥è®©å¼€å‘ä¸ç”Ÿäº§ç¯å¢ƒå°½é‡ä¸€è‡´ã€‚ç”±äºPackerå¯ä»¥ä¸ºå¤šä¸ªå¹³å°åˆ›å»ºå®Œå…¨ä¸€è‡´çš„é•œåƒï¼Œä½ å¯ä»¥åœ¨è…¾è®¯äº‘ä¸Šè¿è¡Œç”Ÿäº§ç¯å¢ƒï¼Œåœ¨è‡ªå·±çš„ç§æœ‰äº‘é‡Œè¾¹è¿è¡Œæµ‹è¯•ç¯å¢ƒï¼Œåœ¨è‡ªå·±çš„vmwareè™šæ‹Ÿæœºé‡Œè¿è¡Œå¼€å‘ç¯å¢ƒã€‚è€Œæ¯ä¸ªç¯å¢ƒéƒ½å®Œå…¨ä¸€è‡´ã€‚æŠŠè¿™ä¸€ç”¨ä¾‹ä¸å‰è¾¹çš„æŒç»­äº¤ä»˜ç»“åˆåœ¨ä¸€èµ·ï¼Œç”¨æˆ·å¯ä»¥ä¿éšœå¼€å‘ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒå°½é‡ä¸€è‡´ï¼Œä»è€Œå‡å°‘å‡ºé—®é¢˜çš„å¯èƒ½ã€‚ ","date":"2024-03-16","objectID":"/posts/2024-03-15-packer/:1:2","tags":["packer","hashicorp"],"title":"Packer","uri":"/posts/2024-03-15-packer/"},{"categories":["DevOps"],"content":"buildè¿‡ç¨‹ Packerä½¿ç”¨hclå’Œjsonæ–‡ä»¶çš„æ¨¡æ¿å°†é…ç½®æºå¸¦åˆ°å„ç§ä»»åŠ¡ä¸­ã€‚ æ ¸å¿ƒä»»åŠ¡æ˜¯Build ã€‚ åœ¨æ­¤é˜¶æ®µï¼ŒPackeræ­£åœ¨ä½¿ç”¨Buildersä¸ºå•ä¸ªå¹³å°åˆ›å»ºæœºå™¨æ˜ åƒã€‚ ä¾‹å¦‚ã€‚ Qemu Builderåˆ›å»ºä¸€ä¸ªkvm / xenè™šæ‹Ÿæœºæ˜ åƒã€‚ ä¸‹ä¸€é˜¶æ®µæ˜¯é…ç½®ã€‚ åœ¨æ­¤ä»»åŠ¡ä¸­ï¼Œ é¢„é…å™¨ ï¼ˆå¦‚ansibleæˆ–shellè„šæœ¬ï¼‰åœ¨è®¡ç®—æœºæ˜ åƒå†…æ‰§è¡Œä»»åŠ¡ã€‚ å®Œæˆåï¼Œ åå¤„ç†å™¨å°†å¤„ç†æœ€ç»ˆä»»åŠ¡ã€‚ ä¾‹å¦‚å‹ç¼©è™šæ‹Ÿæ˜ åƒæˆ–å°†å…¶å¯¼å…¥ç‰¹å®šçš„åº”ç”¨ç¨‹åºã€‚ packeræ¨¡æ¿ï¼šä¸€ä¸ª hcl template file åŒ…å«ï¼š builders (å¿…éœ€) description (å¯é€‰) variables (å¯é€‰) min_packer_version (å¯é€‰) provisioners (å¯é€‰) post-processors(å¯é€‰) ","date":"2024-03-16","objectID":"/posts/2024-03-15-packer/:1:3","tags":["packer","hashicorp"],"title":"Packer","uri":"/posts/2024-03-15-packer/"},{"categories":["DevOps"],"content":"ç¤ºä¾‹ 1ã€dockeré•œåƒæ‰“åŒ… åŸºäº ubuntu 2204 ç”Ÿæˆè‡ªå®šä¹‰é•œåƒï¼Œå¹¶å¯¼å‡ºåˆ° ubuntu.image.tar [root@dev docker]# cat docker.pkr.hcl packer { required_plugins { docker = { version = \"\u003e= 0.0.7\" source = \"github.com/hashicorp/docker\" } } } variable \"msg\" { type = string default = \"build image\" } source \"docker\" \"app\" { image = \"ubuntu:22.04\" commit = \"true\" } build { name = \"build image\" sources = [\"source.docker.app\"] provisioner \"shell\" { environment_vars = [ \"FOO=hello world\", ] inline = [ \"echo Adding file to Docker Container\", \"echo \\\"FOO is $FOO\\\" \u003e example.txt\", ] } provisioner \"shell\" { inline = [\"echo This provisioner runs last ${var.msg} \"] } post-processor \"docker-tag\" { repository = \"docker.io/serialt/ubuntu-packer\" tags = [\"app\", \"packer-app\"] only = [\"docker.app\"] } } RHELç³»åˆ—ç³»ç»Ÿä¸­å·²ç»æœ‰packerå‘½ä»¤ï¼Œåœ¨ä¸‹è½½ hashicorp packer åä¸ºäº†é˜²æ­¢å†²çªï¼Œå¯ä»¥å°† hashicorp çš„ packer æ”¹åä¸º packer.io # å®‰è£… dockerçš„æ’ä»¶ packer.io plugins install github.com/hashicorp/docker # è‡ªåŠ¨è¡¥å…¨ packer.io -autocomplete-install # åˆ—å‡ºå·²ç»å®‰è£…çš„æ’ä»¶ [root@dev docker]# packer.io --version 1.9.1 [root@dev docker]# packer.io plugins installed /root/.config/packer/plugins/github.com/hashicorp/docker/packer-plugin-docker_v1.0.7_x5.0_linux_amd64 /root/.config/packer/plugins/github.com/hashicorp/qemu/packer-plugin-qemu_v1.0.8_x5.0_linux_amd64 /root/.config/packer/plugins/github.com/hashicorp/qemu/packer-plugin-qemu_v1.0.9_x5.0_linux_amd64 /root/.config/packer/plugins/github.com/hashicorp/ansible/packer-plugin-ansible_v1.1.0_x5.0_linux_amd64 # æ‰“åŒ…é•œåƒ [root@dev docker]# packer.io build . build image.docker.app: output will be in this color. ==\u003e build image.docker.app: Creating a temporary directory for sharing data... ==\u003e build image.docker.app: Pulling Docker image: ubuntu:22.04 build image.docker.app: 22.04: Pulling from library/ubuntu build image.docker.app: Digest: sha256:77906da86b60585ce12215807090eb327e7386c8fafb5402369e421f44eff17e build image.docker.app: Status: Image is up to date for ubuntu:22.04 build image.docker.app: docker.io/library/ubuntu:22.04 ==\u003e build image.docker.app: Starting docker container... build image.docker.app: Run command: docker run -v /root/.config/packer/tmp2973759040:/packer-files -d -i -t --entrypoint=/bin/sh -- ubuntu:22.04 build image.docker.app: Container ID: 7d3c046baf8524135b2ac56470943d872f52c9890f75a1fa47cd26f1548fd008 ==\u003e build image.docker.app: Using docker communicator to connect: 172.17.0.8 ==\u003e build image.docker.app: Provisioning with shell script: /tmp/packer-shell3125516653 build image.docker.app: Adding file to Docker Container ==\u003e build image.docker.app: Provisioning with shell script: /tmp/packer-shell1890782291 build image.docker.app: This provisioner runs last build image ==\u003e build image.docker.app: Committing the container build image.docker.app: Image ID: sha256:1e5475a585ac3894ab4890a8901babc0f190388a5dfab28b1c0a35a4eb2d2ff6 ==\u003e build image.docker.app: Killing the container: 7d3c046baf8524135b2ac56470943d872f52c9890f75a1fa47cd26f1548fd008 ==\u003e build image.docker.app: Running post-processor: (type docker-tag) build image.docker.app (docker-tag): Tagging image: sha256:1e5475a585ac3894ab4890a8901babc0f190388a5dfab28b1c0a35a4eb2d2ff6 build image.docker.app (docker-tag): Repository: docker.io/serialt/ubuntu-packer:app build image.docker.app (docker-tag): Tagging image: sha256:1e5475a585ac3894ab4890a8901babc0f190388a5dfab28b1c0a35a4eb2d2ff6 build image.docker.app (docker-tag): Repository: docker.io/serialt/ubuntu-packer:packer-app Build 'build image.docker.app' finished after 6 seconds 607 milliseconds. ==\u003e Wait completed after 6 seconds 607 milliseconds ==\u003e Builds finished. The artifacts of successful builds are: --\u003e build image.docker.app: Imported Docker image: sha256:1e5475a585ac3894ab4890a8901babc0f190388a5dfab28b1c0a35a4eb2d2ff6 --\u003e build image.docker.app: Imported Docker image: docker.io/serialt/ubuntu-packer:packer-app with tags docker.io/serialt/ubuntu-packer:app docker.io/serialt/ubuntu-packer:packer-app [root@dev docker]# ","date":"2024-03-16","objectID":"/posts/2024-03-15-packer/:1:4","tags":["packer","hashicorp"],"title":"Packer","uri":"/posts/2024-03-15-packer/"},{"categories":["DevOps"],"content":"2ã€Mac ä¸Šæ„å»º VMware Fusion é•œåƒ https://github.com/serialt/packer-demo åŸºäº vagrant æ„å»º rockylinux iso # å®‰è£… vagrant brew tap hashicorp/tap brew install hashicorp/tap/hashicorp-vagrant # å®‰è£… vagrant-vmware-desktop # https://developer.hashicorp.com/vagrant/docs/providers/vmware/installation vagrant plugin install vagrant-vmware-desktop # å®‰è£…æ’ä»¶ [sugar@dev docker]# packer init . # æ ¼å¼åŒ–ä»£ç  [sugar@dev docker]# packer fmt . [sugar@dev docker]# packer build -only=vmware-iso.rockylinux-9-aarch64 . [sugarSugar rockylinux]ğŸ³ packer build -only=vmware-iso.rockylinux-9-aarch64 . Warning: Your vmx data contains the following variable(s), which Packer normally sets when it generates its own default vmx template. This may cause your build to fail or behave unpredictably: virtualHW.version on rockylinux-9-vagrant.pkr.hcl line 115: (source code not available) vmware-iso.rockylinux-9-aarch64: output will be in this color. ==\u003e vmware-iso.rockylinux-9-aarch64: Retrieving ISO ==\u003e vmware-iso.rockylinux-9-aarch64: Trying https://mirror.sjtu.edu.cn/rocky/9.3/isos/aarch64/Rocky-9.3-aarch64-boot.iso ==\u003e vmware-iso.rockylinux-9-aarch64: Trying https://mirror.sjtu.edu.cn/rocky/9.3/isos/aarch64/Rocky-9.3-aarch64-boot.iso?checksum=sha256%3Ae23f647456234d11d08eea5071c8d6dc56981ec54fa2da3a6b696adbf5543453 ==\u003e vmware-iso.rockylinux-9-aarch64: https://mirror.sjtu.edu.cn/rocky/9.3/isos/aarch64/Rocky-9.3-aarch64-boot.iso?checksum=sha256%3Ae23f647456234d11d08eea5071c8d6dc56981ec54fa2da3a6b696adbf5543453 =\u003e /Users/serialt/.cache/packer/b49961728ad30951d1cbcb3007deff311f5c929d.iso ==\u003e vmware-iso.rockylinux-9-aarch64: Configuring output and export directories... ==\u003e vmware-iso.rockylinux-9-aarch64: Creating required virtual machine disks ==\u003e vmware-iso.rockylinux-9-aarch64: Building and writing VMX file ==\u003e vmware-iso.rockylinux-9-aarch64: Starting HTTP server on port 8963 ==\u003e vmware-iso.rockylinux-9-aarch64: Starting virtual machine... vmware-iso.rockylinux-9-aarch64: The VM will be run headless, without a GUI. If you want to vmware-iso.rockylinux-9-aarch64: view the screen of the VM, connect via VNC with the password \"GsYgoysa\" to vmware-iso.rockylinux-9-aarch64: vnc://127.0.0.1:5938 ==\u003e vmware-iso.rockylinux-9-aarch64: Connecting to VNC... ==\u003e vmware-iso.rockylinux-9-aarch64: Waiting 10s for boot... ==\u003e vmware-iso.rockylinux-9-aarch64: Typing the boot command over VNC... ==\u003e vmware-iso.rockylinux-9-aarch64: Waiting for SSH to become available... ==\u003e vmware-iso.rockylinux-9-aarch64: Connected to SSH! ==\u003e vmware-iso.rockylinux-9-aarch64: Provisioning with Ansible... vmware-iso.rockylinux-9-aarch64: Setting up proxy adapter for Ansible.... ==\u003e vmware-iso.rockylinux-9-aarch64: Executing Ansible: ansible-playbook -e packer_build_name=\"rockylinux-9-aarch64\" -e packer_builder_type=vmware-iso -e packer_http_addr=172.16.1.1:8963 --ssh-extra-args '-o IdentitiesOnly=yes' --extra-vars packer_provider=vmware-iso -e ansible_ssh_private_key_file=/var/folders/vm/zlhwbdyj2031f088_w9q3f8w0000gn/T/ansible-key3377589468 -i /var/folders/vm/zlhwbdyj2031f088_w9q3f8w0000gn/T/packer-provisioner-ansible4016248806 /Users/serialt/github/packer/rockylinux/ansible/*****-box.yml vmware-iso.rockylinux-9-aarch64: vmware-iso.rockylinux-9-aarch64: PLAY [RockyLinux Vagrant Box] ************************************************** vmware-iso.rockylinux-9-aarch64: vmware-iso.rockylinux-9-aarch64: TASK [Gathering Facts] ********************************************************* vmware-iso.rockylinux-9-aarch64: ok: [default] vmware-iso.rockylinux-9-aarch64: vmware-iso.rockylinux-9-aarch64: TASK [cleanup_vm : Upgrade packages] ******************************************* vmware-iso.rockylinux-9-aarch64: ok: [default] vmware-iso.rockylinux-9-aarch64: vmware-iso.rockylinux-9-aarch64: TASK [cleanup_vm : Install python3-libselinux] ********************************* vmware-iso.rockylinux-9-aarch64: ok: [default] vmware-iso.rockylinux-9-aarch64: vmware-iso.rockylinux-9-aarch64: TASK [cleanup_vm : Install epel] ****************","date":"2024-03-16","objectID":"/posts/2024-03-15-packer/:1:5","tags":["packer","hashicorp"],"title":"Packer","uri":"/posts/2024-03-15-packer/"},{"categories":["DevOps"],"content":"3ã€linux ä¸Šæ„å»ºqemué•œåƒ [root@dev cloud-images]# packer.io build -var qemu_binary=\"/usr/libexec/qemu-kvm\" -only=qemu.almalinux-8-gencloud-x86_64 . qemu.almalinux-8-gencloud-x86_64: output will be in this color. ==\u003e qemu.almalinux-8-gencloud-x86_64: Retrieving ISO ==\u003e qemu.almalinux-8-gencloud-x86_64: Trying https://mirror.sjtu.edu.cn/almalinux/8.8/isos/x86_64/AlmaLinux-8.8-x86_64-boot.iso ==\u003e qemu.almalinux-8-gencloud-x86_64: Trying https://mirror.sjtu.edu.cn/almalinux/8.8/isos/x86_64/AlmaLinux-8.8-x86_64-boot.iso?checksum=sha256%3A016e59963c2c3bd4c99c18ac957573968e23da51131104568fbf389b11df3e05 ==\u003e qemu.almalinux-8-gencloud-x86_64: https://mirror.sjtu.edu.cn/almalinux/8.8/isos/x86_64/AlmaLinux-8.8-x86_64-boot.iso?checksum=sha256%3A016e59963c2c3bd4c99c18ac957573968e23da51131104568fbf389b11df3e05 =\u003e /root/.cache/packer/cd61467f6ca2d6762e243b18a2705c8b210e11aa.iso ==\u003e qemu.almalinux-8-gencloud-x86_64: Starting HTTP server on port 8889 ==\u003e qemu.almalinux-8-gencloud-x86_64: Found port for communicator (SSH, WinRM, etc): 2564. ==\u003e qemu.almalinux-8-gencloud-x86_64: Looking for available port between 5900 and 6000 on 127.0.0.1 ==\u003e qemu.almalinux-8-gencloud-x86_64: Starting VM, booting from CD-ROM qemu.almalinux-8-gencloud-x86_64: The VM will be run headless, without a GUI. If you want to qemu.almalinux-8-gencloud-x86_64: view the screen of the VM, connect via VNC without a password to qemu.almalinux-8-gencloud-x86_64: vnc://127.0.0.1:5955 ==\u003e qemu.almalinux-8-gencloud-x86_64: Waiting 10s for boot... ==\u003e qemu.almalinux-8-gencloud-x86_64: Connecting to VM via VNC (127.0.0.1:5955) ==\u003e qemu.almalinux-8-gencloud-x86_64: Typing the boot commands over VNC... qemu.almalinux-8-gencloud-x86_64: Not using a NetBridge -- skipping StepWaitGuestAddress ==\u003e qemu.almalinux-8-gencloud-x86_64: Using SSH communicator to connect: 127.0.0.1 ==\u003e qemu.almalinux-8-gencloud-x86_64: Waiting for SSH to become available... ==\u003e qemu.almalinux-8-gencloud-x86_64: Connected to SSH! ==\u003e qemu.almalinux-8-gencloud-x86_64: Provisioning with Ansible... qemu.almalinux-8-gencloud-x86_64: Setting up proxy adapter for Ansible.... qemu.almalinux-8-gencloud-x86_64: Executing Ansible Galaxy qemu.almalinux-8-gencloud-x86_64: Starting galaxy role install process qemu.almalinux-8-gencloud-x86_64: [WARNING]: The requirements file '/opt/packer/cloud- qemu.almalinux-8-gencloud-x86_64: - downloading role 'vbox_guest', owned by ezamriy qemu.almalinux-8-gencloud-x86_64: images/ansible/requirements.yml' contains collections which will be ignored. To qemu.almalinux-8-gencloud-x86_64: install these collections run 'ansible-galaxy collection install -r' or to qemu.almalinux-8-gencloud-x86_64: install both at the same time run 'ansible-galaxy install -r' without a custom qemu.almalinux-8-gencloud-x86_64: install path. qemu.almalinux-8-gencloud-x86_64: - downloading role from https://github.com/ezamriy/ansible-role-vbox_guest/archive/v0.2.0.tar.gz qemu.almalinux-8-gencloud-x86_64: [ERROR]: failed to download the file: The read operation timed out qemu.almalinux-8-gencloud-x86_64: [WARNING]: - ezamriy.vbox_guest was NOT installed successfully. qemu.almalinux-8-gencloud-x86_64: ERROR! - you can use --ignore-errors to skip failed roles and finish processing the list. ==\u003e qemu.almalinux-8-gencloud-x86_64: Provisioning step had errors: Running the cleanup provisioner, if present... ==\u003e qemu.almalinux-8-gencloud-x86_64: Deleting output directory... Build 'qemu.almalinux-8-gencloud-x86_64' errored after 17 minutes 14 seconds: Error executing Ansible: Error executing Ansible Galaxy: Non-zero exit status: exit status 1 ==\u003e Wait completed after 17 minutes 14 seconds ==\u003e Some builds didn't complete successfully and had errors: --\u003e qemu.almalinux-8-gencloud-x86_64: Error executing Ansible: Error executing Ansible Galaxy: Non-zero exit status: exit status 1 ==\u003e Builds finished but no artifacts were created. [root@dev cloud-images]# [root@dev cloud-images]# [root@dev cloud-images]# ","date":"2024-03-16","objectID":"/posts/2024-03-15-packer/:1:6","tags":["packer","hashicorp"],"title":"Packer","uri":"/posts/2024-03-15-packer/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go embed å®ç°å°†æ–‡ä»¶æ‰“åŒ…åˆ°Goç¨‹åºä¸­ å‚è€ƒé“¾æ¥ï¼šhttps://juejin.cn/post/7103539856805986334 Goæ˜¯ä¸€é—¨ç¼–è¯‘å‹è¯­è¨€ï¼Œç¼–è¯‘åç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥ç›´æ¥åœ¨å¯¹åº”çš„æ“ä½œç³»ç»Ÿç›´æ¥è¿è¡Œï¼Œæˆ‘ä»¬ç¼–è¯‘å‡ºæ¥çš„ç¨‹åºä¸€èˆ¬éƒ½æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½†æ˜¯åœ¨å®é™…çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œé™¤äº†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€äº›é…ç½®æ–‡ä»¶æˆ–è€…ä¸€äº›é™æ€çš„æ–‡ä»¶ï¼Œå¦‚Htmlï¼ŒCSSï¼Œç­‰æ–‡ä»¶ã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥å°†è¿™äº›æ–‡ä»¶åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå°±ä¸€åŒæ‰“åŒ…åˆ°æˆ‘ä»¬çš„äºŒè¿›åˆ¶ä¸­ï¼Œé‚£æ˜¯ä¸€ä»¶å¾ˆæ¯ç§’çš„äº‹æƒ…ï¼Œä¹Ÿèƒ½é™ä½ä½¿ç”¨æ–¹çš„é—¨æ§›~ Goåœ¨1.16ä¸­æä¾›äº†go:embedçš„åŠŸèƒ½ï¼Œæœ‰äº†ä»–ï¼Œå°±å¯ä»¥å®ç°å°†ä¸€äº›æ–‡ä»¶åµŒå…¥åˆ°æˆ‘ä»¬çš„æ‰“åŒ…ç¨‹åºä¸­ã€‚ ","date":"2024-03-16","objectID":"/posts/2024-03-15-go-embed/:1:0","tags":["Go","embed"],"title":"Go Embed","uri":"/posts/2024-03-15-go-embed/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"ç‰›åˆ€å°è¯• å‡†å¤‡ä¸€ä¸ªæ–‡ä»¶hello.txt,é‡Œé¢å†…å®¹ä¸º hello go:embed é¡¹ç›®çš„æ–‡ä»¶è·¯å¾„å¦‚ä¸‹ - hello.txt - hello_embed.go - hello_embed_test.go hello_embed.go import ( _ \"embed\" ) //go:embed hello.txt var hello string func ReadHelloTxt() string { return hello } æµ‹è¯•æ–¹æ³• import \"testing\" func Test(t *testing.T) { t.Log(ReadHelloTxt()) } é€šè¿‡è¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œæ§åˆ¶å°è¾“å‡ºäº†hello.txtä¸­çš„æ–‡æœ¬å†…å®¹ === RUN Test hello_embed_test.go:6: hello go:embed --- PASS: Test (0.00s) PASS ok gotest 0.124s æ³¨æ„äº‹é¡¹ 1ï¼‰//go:embed æ–‡ä»¶åï¼Œæ³¨é‡Šåé¢ä¸èƒ½åŠ ç©ºæ ¼ï¼Œå¦åˆ™å¤±æ•ˆï¼Œæœ‰çš„å°ä¼™ä¼´å–œæ¬¢åœ¨æ³¨é‡Šåé¢åŠ ä¸€ä¸ªç©ºæ ¼ï¼Œä½†æ˜¯å¦‚æœæ˜¯åœ¨æ­¤å¤„åŠ çš„è¯ï¼Œå½¢å¦‚ï¼š// go:embed è¿™æ ·ä¼šå¯¼è‡´embedå¤±æ•ˆ 2ï¼‰æˆ‘ä»¬éœ€è¦å¯¼å…¥embedçš„åŒ…æ‰èƒ½ä½¿ç”¨ï¼Œå³ import _ \"embed\" 3ï¼‰è¦è¯»å–çš„æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹åªèƒ½åœ¨å½“å‰ç›®å½•æˆ–è€…å½“å‰ç›®å½•çš„å­ç›®å½•ï¼Œä¸èƒ½æ˜¯å…¶ä»–ç›®å½•ï¼Œå¦åˆ™ä¼šæ‰§è¡ŒæŠ¥é”™~ ","date":"2024-03-16","objectID":"/posts/2024-03-15-go-embed/:1:1","tags":["Go","embed"],"title":"Go Embed","uri":"/posts/2024-03-15-go-embed/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"go:embed å¯ä»¥åµŒå…¥çš„å†…å®¹\u0026æ³¨æ„äº‹é¡¹ 1ï¼‰å¯¹äºå•ä¸ªæ–‡ä»¶ï¼Œæ”¯æŒåµŒå…¥ä¸ºå­—ç¬¦ä¸²æˆ–è€…å­—èŠ‚åˆ‡ç‰‡ 2ï¼‰å¯¹äºå¤šä¸ªæ–‡ä»¶ï¼Œæ”¯æŒåµŒå…¥æ–‡ä»¶ç³»ç»Ÿembed.FS 3ï¼‰åªèƒ½åµŒå…¥ä¸º stringï¼Œbyte sliceå’Œembed.FSä¸‰ç§ç±»å‹ï¼Œè¿™ä¸‰ç§ç±»å‹çš„åˆ«åæˆ–è€…ç±»å‹å‘½åéƒ½ä¸å¯ä»¥ ","date":"2024-03-16","objectID":"/posts/2024-03-15-go-embed/:1:2","tags":["Go","embed"],"title":"Go Embed","uri":"/posts/2024-03-15-go-embed/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"åµŒå…¥ä¸ºå­—ç¬¦ä¸²æˆ–è€…å­—èŠ‚åˆ‡ç‰‡ //go:embed hello.txt var hello string //go:embed hello.txt var helloRaw []byte ","date":"2024-03-16","objectID":"/posts/2024-03-15-go-embed/:1:3","tags":["Go","embed"],"title":"Go Embed","uri":"/posts/2024-03-15-go-embed/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"åµŒå…¥ä¸ºembed.FSæ–‡ä»¶ç³»ç»Ÿ åµŒå…¥ä¸ºæ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ä¸ªåŠŸèƒ½åœ¨åµŒå…¥ä¸ºå¤šä¸ªæ–‡ä»¶æˆ–è€…åµŒå…¥çš„æ˜¯æ–‡ä»¶å¤¹çš„æ—¶å€™ï¼Œéå¸¸å®ç”¨ã€‚ //go:embed hello.txt var helloFS embed.FS func ReadHelloFS() string { data, _ := helloFS.ReadFile(\"hello.txt\") return string(data) } åµŒå…¥å¤šä¸ªæ–‡ä»¶ æ–°å¢hello_1.txtæ–‡ä»¶åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­ - hello.txt - hello_1.txt - hello_embed.go - hello_embed_test.go åµŒå…¥å¤šä¸ªæ–‡ä»¶çš„å†™æ³•æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚: ä½¿ç”¨å¤šä¸ªgo:embed //go:embed hello.txt var hello string //go:embed hello_1.txt var hello1 string ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿ //go:embed hello.txt //go:embed hello_1.txt var hello embed.FS func main() { data, _ := helloFS.ReadFile(\"hello.txt\") fmt.Println(string(data)) data1, _ := helloFS.ReadFile(\"hello.txt\") fmt.Println(string(data1)) } å†™åˆ°ä¸€è¡Œ //go:embed hello_1.txt hello.txt var hello embed.FS ","date":"2024-03-16","objectID":"/posts/2024-03-15-go-embed/:1:4","tags":["Go","embed"],"title":"Go Embed","uri":"/posts/2024-03-15-go-embed/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æ–‡ä»¶å¤¹åµŒå…¥ åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­å¢åŠ ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œå¹¶å°†åˆšæ‰çš„æ–‡æœ¬æ–‡ä»¶æ”¾åˆ°æ–‡ä»¶å¤¹ä¸­ cmd - p |- hello.txt |- hello_1.txt - hello_embed.go - hello_embed_test.go æˆ‘ä»¬å¯ä»¥é€šè¿‡åµŒå…¥æ–‡ä»¶å¤¹çš„å½¢å¼å°†Pæ–‡ä»¶å¤¹ä¸­ä»¥åŠå­æ–‡ä»¶å¤¹å…¨éƒ¨åµŒå…¥åˆ°æˆ‘ä»¬çš„é¡¹ç›®ä¸­,è¿™é‡Œä½¿ç”¨çš„æ˜¯ç›¸å¯¹è·¯å¾„ //go:embed p var helloFS embed.FS func main() { data, _ := helloFS.ReadFile(\"p/hello.txt\") fmt.Println(string(data)) data1, _ := helloFS.ReadFile(\"p/hello.txt\") fmt.Println(string(data1)) } ","date":"2024-03-16","objectID":"/posts/2024-03-15-go-embed/:1:5","tags":["Go","embed"],"title":"Go Embed","uri":"/posts/2024-03-15-go-embed/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æ¨¡ç³ŠåŒ¹é… go:embedæŒ‡ä»¤ä¸­å¯ä»¥åªå†™æ–‡ä»¶å¤¹åç§°ï¼Œæ¬¡æ–‡ä»¶å¤¹ä¸­é™¤äº†.æˆ–è€…_å¼€å¤´çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹éƒ½ä¼šåµŒå…¥åˆ°ç¨‹åºä¸­ï¼Œå¹¶ä¸”å­æ–‡ä»¶å¤¹ä¹Ÿä¼šè¢«é€’å½’çš„åµŒå…¥ï¼Œå½¢æˆä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚ å¦‚æœæƒ³åµŒå…¥.æˆ–è€…_å¼€å¤´çš„æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨*,æ¯”å¦‚ï¼šgo:embed p/*,æ³¨æ„ï¼Œ*ä¸å…·æœ‰é€’å½’æ€§ï¼Œæ‰€ä»¥å­æ–‡ä»¶å¤¹ä¸‹é¢çš„.æˆ–è€…_ä¸ä¼šè¢«åµŒå…¥ æ–‡ä»¶è¿‡æ»¤ go:embedè¿˜æ”¯æŒæ–‡ä»¶å‰ç¼€è¿‡æ»¤çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³åµŒå…¥æ‰€æœ‰æ‹“å±•åæ˜¯.txtçš„æ–‡ä»¶åˆ°ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ //go:embed p var helloFS embed.FS func main() { data, _ := helloFS.ReadFile(\"p/hello.txt\") fmt.Println(string(data)) data1, _ := helloFS.ReadFile(\"p/hello.txt\") fmt.Println(string(data1)) } ","date":"2024-03-16","objectID":"/posts/2024-03-15-go-embed/:1:6","tags":["Go","embed"],"title":"Go Embed","uri":"/posts/2024-03-15-go-embed/"},{"categories":["DevOps"],"content":"Terraform Harbor ç®¡ç† provider.tf terraform { required_providers { harbor = { source = \"goharbor/harbor\" version = \"3.10.9\" } } } # set env # HARBOR_USERNAME # HARBOR_PASSWORD provider \"harbor\" { url = var.harbor.url insecure = var.harbor.insecure } user.tf resource \"harbor_user\" \"upload\" { admin = true comment = \"ç”¨äºé•œåƒä¸Šä¼ å’Œä¸‹è½½ä½¿ç”¨\" email = \"tf@local.com\" full_name = \"app\" username = \"app\" password = \"xxxxxx*****\" } image.tf resource \"harbor_registry\" \"hk_harbor\" { access_id = \"app\" access_secret = \"xxxxxxx********\" description = \"harbor hk\" endpoint_url = \"https://harbor-kh.local.com\" insecure = true name = \"hk_harbor\" provider_name = \"harbor\" } replication.tf resource \"harbor_replication\" \"hk\" { action = \"push\" deletion = false dest_namespace = \"sugar\" dest_namespace_replace = 0 enabled = true name = \"hk-sugar\" description = \"sync image to hk harbor\" override = true registry_id = harbor_registry.hk_harbor.registry_id schedule = \"event_based\" filters { name = \"sugar/*\" } } ","date":"2024-03-09","objectID":"/posts/2024-03-09-tf-harbor/:0:0","tags":["TF Harbor"],"title":"TF Harbor","uri":"/posts/2024-03-09-tf-harbor/"},{"categories":["DevOps"],"content":"Terraform ä»£ç ç‰‡æ®µ ","date":"2024-02-25","objectID":"/posts/2024-02-25-tf-code/:0:0","tags":["tf code"],"title":"tf-code","uri":"/posts/2024-02-25-tf-code/"},{"categories":["DevOps"],"content":"1ã€å˜é‡æ§åˆ¶ä»£ç æ˜¯å¦å¯ç”¨ module \"istio\" { count = var.istio.enabled ? 1 : 0 source = \"xxxxxx\" } ","date":"2024-02-25","objectID":"/posts/2024-02-25-tf-code/:0:1","tags":["tf code"],"title":"tf-code","uri":"/posts/2024-02-25-tf-code/"},{"categories":["DevOps"],"content":"2ã€stateæ–‡ä»¶ä¸­è·å–æ•°æ® stateæ–‡ä»¶ä¸­éœ€è¦æœ‰outputï¼Œæ‰èƒ½ä½¿ç”¨ data \"terraform_remote_state\" \"global\" { backend = \"local\" config = { path = \"../../global/terraform.tfstate\" } } data \"terraform_remote_state\" \"global\" { backend = \"http\" config = { address = \"http://git.local.com/api/v4/projects/111/terraform/state/xxxstatefile\" } } locals { domain = data.terraform_remote_state.global.outputs.domain ã€ ","date":"2024-02-25","objectID":"/posts/2024-02-25-tf-code/:0:2","tags":["tf code"],"title":"tf-code","uri":"/posts/2024-02-25-tf-code/"},{"categories":["DevOps"],"content":"3ã€è·å–terraformå½“å‰æ‰§è¡Œçš„ç›®å½• resource \"null_resource\" \"pwd\" { triggers = { always_run = \"${uuid()}\" } provisioner \"local-exec\" { command = \"echo ${path.cwd} \u003e\u003e somefile.txt\" } } ","date":"2024-02-25","objectID":"/posts/2024-02-25-tf-code/:0:3","tags":["tf code"],"title":"tf-code","uri":"/posts/2024-02-25-tf-code/"},{"categories":["DevOps"],"content":"4ã€for_each å¾ªç¯ resource \"tencentcloud_dnspod_record\" \"domain_record_dnspod\" { for_each = { for k, v in var.domain_record : k =\u003e { type = v.type, record = v.record, sub_domain = v.sub_domain, domain = v.domain, record_line = v.record_line } } domain = each.value.domain record_line = each.value.record_line record_type = each.value.type value = each.value.record sub_domain = each.value.sub_domain } resource \"xxxxx\" \"xxxx\" { for_each = {for k,v in var.ack_nodes: k =\u003e v if !contains(keys(v), \"hello\")} ***** } ","date":"2024-02-25","objectID":"/posts/2024-02-25-tf-code/:0:4","tags":["tf code"],"title":"tf-code","uri":"/posts/2024-02-25-tf-code/"},{"categories":["DevOps"],"content":"5ã€contains # å¦‚æœ var.hello.world æœ‰worldè¿™ä¸ªkeyï¼Œå°±ä½¿ç”¨å¯¹åº”çš„å€¼ï¼Œå¦åˆ™å°±ä½¿ç”¨ github è¿™ä¸ªé»˜è®¤å€¼ resource \"xxxx\" \"xxx\" { name = contains(keys(var.hello), \"world\") ? var.hello.world:\"github\" age = var.age \u003e 50 ? var.age : 18 } ","date":"2024-02-25","objectID":"/posts/2024-02-25-tf-code/:0:5","tags":["tf code"],"title":"tf-code","uri":"/posts/2024-02-25-tf-code/"},{"categories":["DevOps"],"content":"6ã€merge data \"aliyun_images_image\" \"image\" { for_each = merge(var.ack_nodes, var.ecs) name_regex = contains(keys(var.ack_nodes), each.key) ? \"Ubuntu 20.*bit$\":\"${each.value.os}.*bit$\" architecture = \"x86\" visibility = \"public\" most_recent = true } ","date":"2024-02-25","objectID":"/posts/2024-02-25-tf-code/:0:6","tags":["tf code"],"title":"tf-code","uri":"/posts/2024-02-25-tf-code/"},{"categories":["DevOps"],"content":"7ã€concat æ‹¼æ¥å’Œåˆå¹¶å¤šä¸ªlist member_names = [] member_names = concat( [for i in nexus_repository_npm_proxy.proxy: i.name], [nexus_repository_npm_hosted.local.name], ) terraform å†…ç½®å‡½æ•° https://whyliyi.github.io/2020/01/29/terraform-%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0(Built-in-functions).html å¯ä»¥ä½¿ç”¨ terraform console è¿›è¡Œè°ƒè¯• # max/minï¼šå–æœ€å¤§/æœ€å° \u003e max(100,1) 100 \u003e min(12, 54, 3) 3 # absï¼šå–æ•°å­—çš„ç»å¯¹å€¼ \u003e abs(23) 23 \u003e abs(0) 0 \u003e abs(-12.4) 12.4 # ceilï¼šä¸Šå–æ•´ \u003e ceil(5) 5 \u003e ceil(5.1) 6 # floorï¼šä¸‹å–æ•´ \u003e floor(5) 5 \u003e floor(4.9) 4 # logï¼š å–å¯¹æ•° \u003e log(16, 2) 4 # parseintï¼šå°†å­—ç¬¦ä¸²è½¬æ¢æˆå¯¹åº”è¿›åˆ¶çš„æ•°å­— \u003e parseint(\"100\", 10) 100 \u003e parseint(\"FF\", 16) 255 \u003e parseint(\"-10\", 16) -16 \u003e parseint(\"1011111011101111\", 2) 48879 # powï¼šæ±‚å¹‚ \u003e pow(3, 2) 9 # signumï¼šæ±‚ç¬¦å· \u003e signum(-13) -1 \u003e signum(0) 0 \u003e signum(344) 1 #### å­—ç¬¦ä¸²å‡½æ•° # chompï¼šåˆ é™¤æ¢è¡Œç¬¦ \u003e chomp(\"hello\\n\\n\") hello # formatï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸² \u003e format(\"Hello, %s!\", var.name) Hello, Valentina! # formatlistï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²åˆ—è¡¨ \u003e formatlist(\"%s, %s!\", \"Salutations\", [\"Valentina\", \"Ander\", \"Olivia\", \"Sam\"]) [ \"Salutations, Valentina!\", \"Salutations, Ander!\", \"Salutations, Olivia!\", \"Salutations, Sam!\", ] # indentï¼šå¤šè¡Œå­—ç¬¦ä¸²ç¼©è¿›æŒ‡å®šå­—ç¬¦ä¸²æ•° \u003e \" items: %{indent(2, \"[\\n foo,\\n bar,\\n]\\n\")}\" items: [ foo, bar, ] # joinï¼šç”¨æŒ‡å®šåˆ†éš”ç¬¦è¿æ¥åˆ—è¡¨ä¸­çš„å­—ç¬¦ä¸² \u003e join(\", \", [\"foo\", \"bar\", \"baz\"]) foo, bar, baz # splitï¼šæŒ‰ç…§æŒ‡å®šåˆ†éš”ç¬¦åˆ†å‰²å­—ç¬¦ä¸² \u003e split(\"+\", \"1+2+3\") [1, 2, 3,] # lowerï¼šå­—ç¬¦ä¸²è½¬åŒ–ä¸ºå…¨å°å†™ # upperï¼šå­—ç¬¦ä¸²è½¬åŒ–ä¸ºå…¨å¤§å†™ # regexï¼šæŒ‰ç…§æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…æˆåŠŸçš„å­å­—ç¬¦ä¸² \u003e regex(\"[a-z]+\", \"53453453.345345aaabbbccc23454\") aaabbbccc # regexallï¼šæŒ‰ç…§æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å­—ç¬¦ä¸²ï¼Œå¹¶è¿”å›åŒ¹é…çš„å­å­—ç¬¦ä¸²åˆ—è¡¨ \u003e regexall(\"[a-z]+\", \"1234abcd5678efgh9\") [ \"abcd\", \"efgh\", ] # replaceï¼šæ›¿æ¢å­—ç¬¦ä¸²ä¸­ç¬¦åˆæ¡ä»¶çš„å­å­—ç¬¦ä¸² \u003e replace(\"1 + 2 + 3\", \"+\", \"-\") 1 - 2 - 3 # strrevï¼šå­—ç¬¦ä¸²é€†åº \u003e strrev(\"hello\") olleh # substrï¼šå­—ç¬¦ä¸²åˆ†ç‰‡ \u003e substr(\"hello world\", 1, 4) ello # titleï¼šå•è¯çš„é¦–å­—æ¯å¤§å†™ \u003e title(\"hello world\") Hello World # trimï¼šåˆ é™¤å­—ç¬¦ä¸²é¦–å°¾æŒ‡å®šå­—ç¬¦ä¸² \u003e trim(\"?!hello?!\", \"!?\") hello # trimprefixï¼šåˆ é™¤å­—ç¬¦ä¸²æŒ‡å®šå‰ç¼€ \u003e trimprefix(\"helloworld\", \"hello\") world # trimsuffixï¼šåˆ é™¤å­—ç¬¦ä¸²æŒ‡å®šåç¼€ \u003e trimsuffix(\"helloworld\", \"world\") hello # trimspaceï¼šåˆ é™¤å‰åç©ºæ ¼ \u003e trimspace(\" hello\\n\\n\") hello ##### ç±»å‹è½¬æ¢å‡½æ•° # toboolï¼šè½¬æ¢æˆboolç±»å‹ï¼Œä»…ä»…æ˜¯trueã€falseã€â€trueâ€ã€â€falseâ€å¯ä»¥è½¬æ¢ # tolistï¼šå°†å‚æ•°è½¬åŒ–æˆåˆ—è¡¨ç±»å‹ \u003e tolist([\"a\", \"b\", 3]) [ \"a\", \"b\", \"3\", ] # tomapï¼šè½¬æ¢æˆmapç±»å‹ \u003e tomap({\"a\" = \"foo\", \"b\" = true}) { \"a\" = \"foo\" \"b\" = \"true\" } # tonumberï¼šè½¬æ¢æˆæ•°å­— \u003e tonumber(1) 1 \u003e tonumber(\"1\") 1 \u003e tonumber(\"no\") Error: Invalid function argument # tosetï¼šè½¬æ¢æˆsetç±»å‹ \u003e toset([\"c\", \"b\", \"b\", 3]) [ \"b\", \"c\", \"3\", ] # tostringï¼šè½¬æ¢æˆå­—ç¬¦ä¸²ç±»å‹, åªå¯¹stringã€numberã€boolç±»å‹æœ‰æ•ˆ \u003e tostring(\"hello\") hello \u003e tostring(1) 1 \u003e tostring(true) true \u003e tostring([]) Error: Invalid function argument # tryï¼šè®¡ç®—æ‰€æœ‰çš„è¡¨è¾¾å¼ï¼Œå¹¶è¿”å›ç¬¬ä¸€ä¸ªè®¡ç®—æˆåŠŸçš„ç»“æœï¼Œå¹¶ä¸”ä¸ä¼šæŠ›å‡ºä»»ä½•é”™è¯¯ \u003e local.foo { \"bar\" = \"baz\" } \u003e try(local.foo.bar, \"fallback\") baz \u003e try(local.foo.boop, \"fallback\") fallback # chunklist åˆ†ç‰‡ chunklist(list, chunk_size) \u003e chunklist([\"a\", \"b\", \"c\", \"d\", \"e\"], 2) [ [ \"a\", \"b\", ], [ \"c\", \"d\", ], [ \"e\", ], ] # coalesce è¿”å›ç¬¬ä¸€ä¸ªä¸ä¸ºç©ºçš„å…ƒç´  \u003e coalesce(\"a\", \"b\") a \u003e coalesce([\"\", \"b\"]...) b # coalescelist è¿”å›ç¬¬ä¸€ä¸ªä¸ä¸ºç©ºçš„list \u003e coalescelist([\"a\", \"b\"], [\"c\", \"d\"]) [ \"a\", \"b\", ] \u003e coalescelist([], [\"c\", \"d\"]) [ \"c\", \"d\", ] # compact è¿”å›éç©ºçš„å…¨éƒ¨å…ƒç´  \u003e compact([\"a\", \"\", \"b\", null, \"c\"]) [ \"a\", \"b\", \"c\", ] # concat åˆå¹¶å¤šä¸ªlist \u003e concat([\"a\", \"\"], [\"b\", \"c\"]) [ \"a\", \"\", \"b\", \"c\", ] # contains åˆ¤æ–­æ˜¯å¦åŒ…å« contains(list, value) # distinct è½¬æ¢ä¸ºå­—å…¸ï¼Œå»é‡ \u003e distinct([\"a\", \"b\", \"a\", \"c\", \"d\", \"b\"]) [ \"a\", \"b\", \"c\", \"d\", ] # element å–list ä¸­çš„ç´¢å¼•å…ƒç´  element(list, index) \u003e element([\"a\", \"b\", \"c\"], 1) b #å¤§äºç´¢å¼•çš„æ—¶å€™å–ç¬¬ä¸€ä¸ªå…ƒç´  \u003e element([\"a\", \"b\", \"c\"], 3) a \u003e element([\"a\", \"b\", \"c\"], length([\"a\", \"b\", \"c\"])-1) c # flatten æ‰å¹³åŒ–åˆå¹¶ \u003e flatten([[\"a\", \"b\"], [], [\"c\"]]) [\"a\", \"b\", \"c\"] \u003e flatten([[[\"a\", \"b\"], []], [\"c\"]]) [\"a\", \"b\", \"c\"] # lookup æŸ¥æ‰¾ lookup(map, key, default) \u003e lookup({a=\"ay\", b=\"bee\"}, \"a\", \"what?\") ay \u003e lookup({a=\"ay\", b=\"bee\"}, \"c\", \"what?\") what? # range range(max) range(start, limit) range(start, limit, step) \u003e range(3) [ 0, 1, 2, ] \u003e range(1, 4) [ 1, 2, 3, ] \u003e range(1, 8, 2) [ 1, 3, 5, 7, ] # reverse åè½¬ \u003e reverse([1, 2, 3]) [ 3, 2, 1, ] # setintersection è·å–é‡å¤çš„å…ƒç´  \u003e setintersection([\"a\", \"b\"], [\"b\", \"c\"], [\"b\", \"d\"]) [ \"b\", ] # setunion set è”åˆ \u003e setunion([\"a","date":"2024-02-25","objectID":"/posts/2024-02-25-tf-code/:0:7","tags":["tf code"],"title":"tf-code","uri":"/posts/2024-02-25-tf-code/"},{"categories":["DevOps"],"content":"å…¶ä»– å‡å° terraform é¡¹ç›®ç›®å½•ä½“ç§¯ ç›®å½•ä¸­ provider çš„äºŒè¿›åˆ¶åŒ…å ä¸»è¦ï¼Œåœ¨åˆ†å‘é¡¹ç›®åˆ°å…¶å®ƒ Arch å’Œ OS çš„æœºå™¨è¿è¡Œçš„æ—¶å€™ï¼Œå¯ä»¥å…ˆå°† providerç›®å½•åˆ é™¤ï¼Œç„¶ååœ¨å‹ç¼©å¹¶è¿›è¡Œåˆ†å‘ã€‚ ","date":"2024-02-25","objectID":"/posts/2024-02-25-tf-code/:0:8","tags":["tf code"],"title":"tf-code","uri":"/posts/2024-02-25-tf-code/"},{"categories":["DevOps"],"content":"KtConnect å®˜æ–¹æ–‡æ¡£ï¼šhttps://alibaba.github.io/kt-connect/#/zh-cn/guide/quickstart ç®€å•ç¤ºä¾‹ï¼š apiVersion: v1 kind: Service metadata: name: myapp spec: type: ClusterIP selector: app: myapp ports: - protocol: TCP port: 80 targetPort: 80 --- apiVersion: apps/v1 kind: Deployment metadata: name: myapp labels: app: myapp spec: replicas: 2 selector: matchLabels: app: myapp template: metadata: labels: app: myapp spec: containers: - name: nginx image: nginx ports: - containerPort: 80 resources: requests: cpu: 100m memory: 100Mi limits: cpu: 100m memory: 100Mi sudo ktctl connect -c ~/.kube/config ktctl ä¼šåœ¨ default namespace é‡Œå¯åŠ¨ä¸€ä¸ª pod ç”¨äºè½¬å‘æµé‡ï¼Œè¿™æ ·æœ¬åœ°å°±å¯ä»¥åƒåœ¨é›†ç¾¤ä¸­ä¸€æ ·ï¼Œè®¿é—®é‡Œé¢çš„æœåŠ¡ã€‚ ","date":"2024-01-29","objectID":"/posts/2024-01-29-ktconnect/:0:0","tags":["ktconnect"],"title":"ktconnect","uri":"/posts/2024-01-29-ktconnect/"},{"categories":["DevOps"],"content":"alpine è™šæ‹Ÿæœºå®‰è£… ","date":"2024-01-22","objectID":"/posts/2024-01-22-alpine-vm/:0:0","tags":["alpine-vm"],"title":"Alpine vm","uri":"/posts/2024-01-22-alpine-vm/"},{"categories":["DevOps"],"content":"ä½¿ç”¨alpine-vm iso æ–‡ä»¶è¿›è¡Œå®‰è£… å‚è€ƒæ–‡æ¡£ï¼š https://www.qunniao.net/1408.html https://wener.me/notes/os/alpine/intro https://blog.xiaohack.org/4674.html https://tonylee.name/Alpine-Linux-4f1cbdb482754c65a61e7f08e9691234 å…³é—­äº¤æ¢åˆ†åŒºå‡å°é•œåƒå¤§å°ï¼š vi /sbin/setup-alpine # åœ¨ setup-disk å¢åŠ å‚æ•°å…³é—­äº¤æ¢åˆ†åŒº setup-disk -s 0 alpine 3.19 é•œåƒå¯ä»¥æœ€å°è¾¾åˆ°123M å®˜æ–¹ ä¸‹è½½é¡µ åˆ—äº†å‡ ç§ç±»å‹çš„é•œåƒ, æ‰€æœ‰é•œåƒçš„æ„å»ºè„šæœ¬ä½äº alpinelinux/alpine-iso. TIPS åšå®‰è£…ç›˜å»ºè®®é€‰æ‹© EXTENDED, åœ¨ä¸éœ€è¦ setup-repository çš„å‰æä¸‹ä¹Ÿèƒ½å¤Ÿå®‰è£…åˆ°ç¡¬ç›˜. ä»“åº“é•œåƒä¸­ä¹Ÿèƒ½ä¸‹è½½ç³»ç»Ÿé•œåƒ v3.10/releases STANDARD æ ‡å‡†é•œåƒ é•œåƒè¾ƒå°‘, å®‰è£…éœ€è¦ç½‘ç»œè¿æ¥ EXTENDED æ‰©å±•é•œåƒ é™„å¸¦äº†å¸¸ç”¨åŒ…, å®‰è£…ä¸éœ€è¦ç½‘ç»œè¿æ¥; é€‚ç”¨äºè·¯ç”±å’ŒæœåŠ¡å™¨ VANILLA æœª Hardened çš„é•œåƒ è‡ª 3.8 å¼€å§‹ï¼Œå·²ç»æ²¡æœ‰ hardened çš„å†…æ ¸äº† VIRTUAL é€‚ç”¨äºè™šæ‹Ÿæœºçš„é•œåƒ XEN é€‚ç”¨äº XEN è™šæ‹ŸåŒ–çš„é•œåƒ MINI ROOT FILESYSTEM æœ€å°æ ¹ç›®å½•ç³»ç»Ÿ é€‚ç”¨äºå®¹å™¨å’Œ chroot RASPBERRY PI æ ‘è“æ´¾ç³»ç»Ÿ GENERIC ARM é€šç”¨ ARM ç³»ç»Ÿ ","date":"2024-01-22","objectID":"/posts/2024-01-22-alpine-vm/:1:0","tags":["alpine-vm"],"title":"Alpine vm","uri":"/posts/2024-01-22-alpine-vm/"},{"categories":["DevOps"],"content":"alpine arm64 å®‰è£…docker failed to start daemon: Devices cgroup isn't mounted echo 'none /sys/fs/cgroup cgroup defaults 0 0' \u003e\u003e /etc/fstab mount -a ","date":"2024-01-22","objectID":"/posts/2024-01-22-alpine-vm/:2:0","tags":["alpine-vm"],"title":"Alpine vm","uri":"/posts/2024-01-22-alpine-vm/"},{"categories":["DevOps"],"content":"Python è‡ªç­¾åè¯ä¹¦ mozilla ç»´æŠ¤è€…ä¸€ä¸ªå…¬å…±caçš„æ–‡ä»¶ï¼Œåœ¨ä½¿ç”¨httpå®¢æˆ·ç«¯ä½¿ç”¨è‡ªç­¾åè¯ä¹¦çš„æ—¶å€™å¯ä»¥æŠŠå¯¹åº”çš„æ–‡ä»¶åˆå¹¶ç„¶åå†å¯¼å…¥ï¼Œç¤ºä¾‹ä»£ç ï¼š requirements.txt certifi==2023.11.17 urllib3==2.1.0 #!/usr/bin/env python3 # coding=utf-8 # *********************************************************************** # Description : Blue Planet # Author : serialt # Created Time : 2024-01-15 20:12:32 # Last modified : 2024-01-16 20:35:00 # FilePath : /urlib3/lib.py # Other : # : # # # # *********************************************************************** import os import urllib3 import certifi pablic_ca = 'pub_ca.crt' def load_ca(path): if not os.path.exists(pablic_ca): mozilla_ca = certifi.where() with open(pablic_ca, \"a\")as pub_ca: # get cert from certifi m_ca = open(mozilla_ca) m_ca_data = m_ca.read() pub_ca.write(m_ca_data) m_ca.close() # get cert from ca_path ca_files = os.listdir(path) for file in ca_files: if not os.path.isdir(file): fl = open(path+'/'+file) data = fl.read() fl.close() pub_ca.write('\\n'+data) pub_ca.close() # Creating a PoolManager instance for sending requests. http = urllib3.PoolManager( cert_reqs=\"CERT_REQUIRED\", maxsize=10, ca_certs=pablic_ca, ) # Sending a GET request and getting back response as HTTPResponse object. resp = http.request(\"GET\", \"http://httpbin.org/get\") # Print the returned data. print(resp.data) load_ca('ca') ","date":"2024-01-16","objectID":"/posts/2024-01-15-python-cert/:0:0","tags":["python-cert"],"title":"Python Cert","uri":"/posts/2024-01-15-python-cert/"},{"categories":["DevOps"],"content":"Terraform Registry ","date":"2024-01-14","objectID":"/posts/2024-01-14-terraform-registry/:0:0","tags":["terraform-registry"],"title":"Terraform Registry","uri":"/posts/2024-01-14-terraform-registry/"},{"categories":["DevOps"],"content":"ä¸€ã€Registry åè®® æ–‡æ¡£åœ°å€ï¼šhttps://developer.hashicorp.com/terraform/internals/provider-registry-protocol # listå¯ç”¨çš„provider curl 'https://registry.terraform.io/v1/providers/hashicorp/random/versions' { \"versions\": [ { \"version\": \"2.0.0\", \"protocols\": [\"4.0\", \"5.1\"], \"platforms\": [ {\"os\": \"darwin\", \"arch\": \"amd64\"}, {\"os\": \"linux\", \"arch\": \"amd64\"}, {\"os\": \"linux\", \"arch\": \"arm\"}, {\"os\": \"windows\", \"arch\": \"amd64\"} ] }, { \"version\": \"2.0.1\", \"protocols\": [\"5.2\"], \"platforms\": [ {\"os\": \"darwin\", \"arch\": \"amd64\"}, {\"os\": \"linux\", \"arch\": \"amd64\"}, {\"os\": \"linux\", \"arch\": \"arm\"}, {\"os\": \"windows\", \"arch\": \"amd64\"} ] } ] } # find provider package curl 'https://registry.terraform.io/v1/providers/hashicorp/random/2.0.0/download/linux/amd64' { \"protocols\": [\"4.0\", \"5.1\"], \"os\": \"linux\", \"arch\": \"amd64\", \"filename\": \"terraform-provider-random_2.0.0_linux_amd64.zip\", \"download_url\": \"https://releases.hashicorp.com/terraform-provider-random/2.0.0/terraform-provider-random_2.0.0_linux_amd64.zip\", \"shasums_url\": \"https://releases.hashicorp.com/terraform-provider-random/2.0.0/terraform-provider-random_2.0.0_SHA256SUMS\", \"shasums_signature_url\": \"https://releases.hashicorp.com/terraform-provider-random/2.0.0/terraform-provider-random_2.0.0_SHA256SUMS.sig\", \"shasum\": \"5f9c7aa76b7c34d722fc9123208e26b22d60440cb47150dd04733b9b94f4541a\", \"signing_keys\": { \"gpg_public_keys\": [ { \"key_id\": \"51852D87348FFC4C\", \"ascii_armor\": \"-----BEGIN PGP PUBLIC KEY BLOCK-----\\nVersion: GnuPG v1\\n\\nmQENBFMORM0BCADBRyKO1MhCirazOSVwcfTr1xUxjPvfxD3hjUwHtjsOy/bT6p9f\\nW2mRPfwnq2JB5As+paL3UGDsSRDnK9KAxQb0NNF4+eVhr/EJ18s3wwXXDMjpIifq\\nfIm2WyH3G+aRLTLPIpscUNKDyxFOUbsmgXAmJ46Re1fn8uKxKRHbfa39aeuEYWFA\\n3drdL1WoUngvED7f+RnKBK2G6ZEpO+LDovQk19xGjiMTtPJrjMjZJ3QXqPvx5wca\\nKSZLr4lMTuoTI/ZXyZy5bD4tShiZz6KcyX27cD70q2iRcEZ0poLKHyEIDAi3TM5k\\nSwbbWBFd5RNPOR0qzrb/0p9ksKK48IIfH2FvABEBAAG0K0hhc2hpQ29ycCBTZWN1\\ncml0eSA8c2VjdXJpdHlAaGFzaGljb3JwLmNvbT6JATgEEwECACIFAlMORM0CGwMG\\nCwkIBwMCBhUIAgkKCwQWAgMBAh4BAheAAAoJEFGFLYc0j/xMyWIIAIPhcVqiQ59n\\nJc07gjUX0SWBJAxEG1lKxfzS4Xp+57h2xxTpdotGQ1fZwsihaIqow337YHQI3q0i\\nSqV534Ms+j/tU7X8sq11xFJIeEVG8PASRCwmryUwghFKPlHETQ8jJ+Y8+1asRydi\\npsP3B/5Mjhqv/uOK+Vy3zAyIpyDOMtIpOVfjSpCplVRdtSTFWBu9Em7j5I2HMn1w\\nsJZnJgXKpybpibGiiTtmnFLOwibmprSu04rsnP4ncdC2XRD4wIjoyA+4PKgX3sCO\\nklEzKryWYBmLkJOMDdo52LttP3279s7XrkLEE7ia0fXa2c12EQ0f0DQ1tGUvyVEW\\nWmJVccm5bq25AQ0EUw5EzQEIANaPUY04/g7AmYkOMjaCZ6iTp9hB5Rsj/4ee/ln9\\nwArzRO9+3eejLWh53FoN1rO+su7tiXJA5YAzVy6tuolrqjM8DBztPxdLBbEi4V+j\\n2tK0dATdBQBHEh3OJApO2UBtcjaZBT31zrG9K55D+CrcgIVEHAKY8Cb4kLBkb5wM\\nskn+DrASKU0BNIV1qRsxfiUdQHZfSqtp004nrql1lbFMLFEuiY8FZrkkQ9qduixo\\nmTT6f34/oiY+Jam3zCK7RDN/OjuWheIPGj/Qbx9JuNiwgX6yRj7OE1tjUx6d8g9y\\n0H1fmLJbb3WZZbuuGFnK6qrE3bGeY8+AWaJAZ37wpWh1p0cAEQEAAYkBHwQYAQIA\\nCQUCUw5EzQIbDAAKCRBRhS2HNI/8TJntCAClU7TOO/X053eKF1jqNW4A1qpxctVc\\nz8eTcY8Om5O4f6a/rfxfNFKn9Qyja/OG1xWNobETy7MiMXYjaa8uUx5iFy6kMVaP\\n0BXJ59NLZjMARGw6lVTYDTIvzqqqwLxgliSDfSnqUhubGwvykANPO+93BBx89MRG\\nunNoYGXtPlhNFrAsB1VR8+EyKLv2HQtGCPSFBhrjuzH3gxGibNDDdFQLxxuJWepJ\\nEK1UbTS4ms0NgZ2Uknqn1WRU1Ki7rE4sTy68iZtWpKQXZEJa0IGnuI2sSINGcXCJ\\noEIgXTMyCILo34Fa/C6VCm2WBgz9zZO8/rHIiQm1J5zqz0DrDwKBUM9C\\n=LYpS\\n-----END PGP PUBLIC KEY BLOCK-----\", \"trust_signature\": \"\", \"source\": \"HashiCorp\", \"source_url\": \"https://www.hashicorp.com/security.html\" } ] } } ","date":"2024-01-14","objectID":"/posts/2024-01-14-terraform-registry/:1:0","tags":["terraform-registry"],"title":"Terraform Registry","uri":"/posts/2024-01-14-terraform-registry/"},{"categories":["DevOps"],"content":"äºŒã€Cache Terraform Registry â€‹ åœ¨æ‰§è¡Œterraform init çš„æ—¶å€™ï¼Œterraform cli ä¼šä»å®˜æ–¹çš„RegistryæŸ¥æ‰¾å’Œä¸‹è½½å¯¹åº”çš„providerï¼Œå°çš„providerå‡ Mï¼Œå¤§çš„å¯èƒ½å‡ ç™¾Mï¼Œè€Œä¸”å¦‚æœå½“æ‰§è¡Œplanæˆ–applyå‡ºç°é—®é¢˜éœ€è¦é‡æ–°æ‰§è¡Œinitï¼Œå¯èƒ½éœ€è¦å¤šæ¬¡è¯·æ±‚registryï¼Œè¿™å¯¹ç½‘ç»œçš„é€Ÿåº¦å’Œç¨³å®šæ€§è¦æ±‚æ¯”è¾ƒé«˜ã€‚å› æ­¤ï¼ŒåŸºäºå®˜æ–¹çš„ Provider Registry Protocol å’Œ Remote Serviceï¼Œå¯ä»¥å¼€å‘ä¸€ä¸ªç®€å•çš„cliç¼“å­˜å’Œæä¾›RegistryæœåŠ¡ã€‚ â€‹ ","date":"2024-01-14","objectID":"/posts/2024-01-14-terraform-registry/:2:0","tags":["terraform-registry"],"title":"Terraform Registry","uri":"/posts/2024-01-14-terraform-registry/"},{"categories":["DevOps"],"content":"1ã€terraformä¸‹è½½provideråŸç† â€‹ å½“æ‰§è¡Œterraform init åï¼Œterraform cli ä¼šæ ¹æ® tfæ–‡ä»¶ä¸­å®šä¹‰çš„providerå»å‘ registry.terraform.io å‘èµ·GETè¯·æ±‚ï¼Œä¾‹å¦‚ï¼štfæ–‡ä»¶ä¸­æœ‰ä½¿ç”¨hashicorp/randomï¼Œterraform cli ä¼šå‘å‡ºGetè¯·æ±‚ https://registry.terraform.io/v1/providers/hashicorp/random/versionsï¼Œè¯·æ±‚åˆ°æ•°æ®åå†è·Ÿtfæ–‡ä»¶ä¸­å®šä¹‰çš„ç‰ˆæœ¬åˆ¤æ–­ä¸€è‡´åè·å–è¦ä¸‹è½½çš„provider package åŒ…çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šhttps://registry.terraform.io/v1/providers/hashicorp/random/2.0.0/download/linux/amd64ï¼Œè¿”å›çš„æ•°æ®ä¸­æœ‰providerçš„ä¸‹è½½åœ°å€ã€provideçš„hashå€¼å’Œç”¨äºéªŒè¯providerç­¾åçš„å…¬é’¥ï¼Œç”±hashicorpç»´æŠ¤çš„provider packageä¼šå­˜æ”¾åœ¨releases.hashicorp.comä¸­ï¼Œè€Œç”±ç¬¬ä¸‰æ–¹å¼€å‘è€…ç»´æŠ¤çš„åªèƒ½ä½¿ç”¨githubæ‰˜ç®¡ï¼Œè¦æ±‚ä»£ç å¿…é¡»æ˜¯å¼€æºçš„ï¼Œä¸”repoçš„å‘½åæ ¼å¼ç¬¦åˆ terraform-provider-sshã€‚ ","date":"2024-01-14","objectID":"/posts/2024-01-14-terraform-registry/:2:1","tags":["terraform-registry"],"title":"Terraform Registry","uri":"/posts/2024-01-14-terraform-registry/"},{"categories":["DevOps"],"content":"2ã€ç¼“å­˜åŠ é€ŸåŸç† ~/.terraformrcæ–‡ä»¶ä¸­å¯ä»¥å¯ä»¥é…ç½®é•œåƒï¼Œä¾‹å¦‚ï¼š host \"registry.terraform.io\" { services = { \"modules.v1\" = \"http://127.0.0.1:9090/pub/v1/modules/\", \"providers.v1\" = \"http://127.0.0.1:9090/v1/providers/\" } } å½“æ‰§è¡Œterraform initçš„æ—¶å€™ï¼Œè®¿é—® registry.terraform.io/v1/providers/ ä¼šè¢«æ›¿æ¢ä¸ºhttp://127.0.0.1:9090/v1/providers/ ","date":"2024-01-14","objectID":"/posts/2024-01-14-terraform-registry/:2:2","tags":["terraform-registry"],"title":"Terraform Registry","uri":"/posts/2024-01-14-terraform-registry/"},{"categories":["DevOps"],"content":"ä¸‰ã€åŸºäºnexuså­˜å‚¨provider ","date":"2024-01-14","objectID":"/posts/2024-01-14-terraform-registry/:3:0","tags":["terraform-registry"],"title":"Terraform Registry","uri":"/posts/2024-01-14-terraform-registry/"},{"categories":["DevOps"],"content":"1ã€ä¸‹è½½æ•°æ®å¹¶åŒæ­¥åˆ°nexus é…ç½®æ–‡ä»¶æ ¼å¼ storage: type: nexus nexus: url: http://nexus.local.com repo: terraform tf: providerLast: 2 provider: - \"hashicorp/random\" - \"hashicorp/aws\" - \"hashicorp/tls\" - \"hashicorp/dns\" providerOS: - linux - darwin providerArch: - amd64 - arm64 providerVersion: hashicorp/random: - \"3.6.0\" - \"3.3.2\" loafoe/ssh: - \"2.5.0\" # è·å–providerçš„ç‰ˆæœ¬ï¼ŒæŠŠè¿™ä¸ªæ–‡ä»¶ä¸Šä¼ åˆ°nexusï¼Œè·¯å¾„: hashicorp/random/versions curl 'https://registry.terraform.io/v1/providers/hashicorp/random/versions' # è·å–åˆ°ç‰ˆæœ¬ä¿¡æ¯åè¯·æ±‚ä¸‹è½½çš„provider package ä¿¡æ¯ ,ä¸‹è½½é‡Œé¢çš„æ–‡ä»¶ï¼Œå¹¶æŠŠå¯¹åº”çš„é“¾æ¥ä¿¡ä¿®æ”¹ä¸ºnexusä¸­çš„åœ°å€ curl https://registry.terraform.io/v1/providers/hashicorp/random/2.0.0/download/linux/amd64' # ä¸‹è½½ä¸Šä¸€æ­¥è·å–åˆ°çš„åŸå§‹ provider pcakge é“¾æ¥ä¸­çš„æ–‡ä»¶ï¼ŒæŠŠæ–‡ä»¶ä¸Šä¼ åˆ°nexus ","date":"2024-01-14","objectID":"/posts/2024-01-14-terraform-registry/:3:1","tags":["terraform-registry"],"title":"Terraform Registry","uri":"/posts/2024-01-14-terraform-registry/"},{"categories":["DevOps"],"content":"2ã€å®ç°Provider Registry Protocol æ ¹æ® Provider Registry Protocolå®ç°ä¸€ä¸ªç§æœ‰çš„registryï¼Œæ ¹æ®è¯·æ±‚æ¥çš„ä¿¡æ¯å»è¯·æ±‚nexusä¸Šçš„å¯¹åº”æ•°æ®ï¼ŒæŠŠæ•°æ®è¿”å›ç»™terraform cli , terraform cli ä¼šè‡ªå·±ä»æ¥æ”¶åˆ°çš„æ•°æ®å»ä»nexusä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„providerã€‚ ","date":"2024-01-14","objectID":"/posts/2024-01-14-terraform-registry/:3:2","tags":["terraform-registry"],"title":"Terraform Registry","uri":"/posts/2024-01-14-terraform-registry/"},{"categories":["DevOps"],"content":"Vault å‚è€ƒé“¾æ¥ï¼šhttps://thiscute.world/posts/experience-of-vault/#%E4%B8%80vault-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5 ä»‹ç» Vault æ˜¯ hashicorp æ¨å‡ºçš„ secrets ç®¡ç†ã€åŠ å¯†å³æœåŠ¡ä¸æƒé™ç®¡ç†å·¥å…·ã€‚å®ƒçš„åŠŸèƒ½ç®€ä»‹å¦‚ä¸‹ï¼š 1ï¼‰secrets ç®¡ç†ï¼šæ”¯æŒä¿å­˜å„ç§è‡ªå®šä¹‰ä¿¡æ¯ã€è‡ªåŠ¨ç”Ÿæˆå„ç±»å¯†é’¥ï¼Œvault è‡ªåŠ¨ç”Ÿæˆçš„å¯†é’¥è¿˜èƒ½è‡ªåŠ¨è½®è½¬(rotate) 2ï¼‰è®¤è¯æ–¹å¼ï¼šæ”¯æŒæ¥å…¥å„å¤§äº‘å‚å•†çš„è´¦å·ä½“ç³»ï¼ˆæ¯”å¦‚é˜¿é‡Œäº‘RAMå­è´¦å·ä½“ç³»ï¼‰æˆ–è€… LDAP ç­‰è¿›è¡Œèº«ä»½éªŒè¯ï¼Œä¸éœ€è¦åˆ›å»ºé¢å¤–çš„è´¦å·ä½“ç³»ã€‚ 3ï¼‰æƒé™ç®¡ç†ï¼šé€šè¿‡ policyï¼Œå¯ä»¥è®¾å®šéå¸¸ç»†è‡´çš„ ACL æƒé™ã€‚ 4ï¼‰å¯†é’¥å¼•æ“ï¼šä¹Ÿæ”¯æŒæ¥ç®¡å„å¤§äº‘å‚å•†çš„è´¦å·ä½“ç³»ï¼ˆæ¯”å¦‚é˜¿é‡Œäº‘RAMå­è´¦å·ä½“ç³»ï¼‰ï¼Œå®ç° API Key çš„è‡ªåŠ¨è½®è½¬ã€‚ 5ï¼‰æ”¯æŒæ¥å…¥ kubernetes rbac è®¤è¯ä½“ç³»ï¼Œé€šè¿‡ serviceaccount+role ä¸ºæ¯ä¸ª Pod å•ç‹¬é…ç½®è®¤è¯è§’è‰²ã€‚ 6ï¼‰æ”¯æŒé€šè¿‡ sidecar/init-container å°† secrets æ³¨å…¥åˆ° pod ä¸­ï¼Œæˆ–è€…é€šè¿‡ k8s operator å°† vault æ•°æ®åŒæ­¥åˆ° k8s secrets ä¸­ ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:0:0","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"ä¸€ã€Vault åŸºç¡€æ¦‚å¿µ â€‹ å‡ ä¹æ‰€æœ‰çš„ Vault ç»„ä»¶éƒ½è¢«ç»Ÿç§°ä¸ºã€Œå±éšœï¼ˆBarrierï¼‰ã€ã€‚Vault å¯ä»¥ç®€å•åœ°è¢«åˆ’åˆ†ä¸ºå­˜å‚¨åç«¯ï¼ˆStorage Backendï¼‰ã€å±éšœï¼ˆBarrierï¼‰å’Œ HTTP/S API ä¸‰ä¸ªéƒ¨åˆ†ã€‚ â€‹ Vaultï¼Œç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯é‡‘åº“ã€‚ç±»æ¯”é“¶è¡Œé‡‘åº“ï¼Œã€Œå±éšœã€å°±æ˜¯ç”¨äºä¿æŠ¤é‡‘åº“çš„åˆé‡‘å¤§é—¨å’Œé’¢ç­‹æ··å‡åœŸï¼Œå­˜å‚¨åç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„æ‰€æœ‰æ•°æ®æµåŠ¨éƒ½éœ€è¦ç»è¿‡å®ƒã€‚ã€Œå±éšœã€ç¡®ä¿åªæœ‰åŠ å¯†æ•°æ®ä¼šè¢«å†™å…¥å­˜å‚¨åç«¯ï¼ŒåŠ å¯†æ•°æ®åœ¨ç»è¿‡ã€Œå±éšœã€è¢«è¯»å‡ºçš„è¿‡ç¨‹ä¸­è¢«éªŒè¯ä¸è§£å¯†ã€‚å’Œé“¶è¡Œé‡‘åº“çš„å¤§é—¨éå¸¸ç±»ä¼¼ï¼Œã€Œå±éšœã€ä¹Ÿå¿…é¡»å…ˆè§£å°ï¼Œæ‰èƒ½è§£å¯†å­˜å‚¨åç«¯ä¸­çš„æ•°æ®ã€‚ ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:1:0","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"1ã€æ•°æ®å­˜å‚¨åŠåŠ å¯†è§£å¯† å­˜å‚¨åç«¯ï¼ˆStorage Backendï¼‰: Vault è‡ªèº«ä¸å­˜å‚¨æ•°æ®ï¼Œå› æ­¤éœ€è¦ä¸ºå®ƒé…ç½®ä¸€ä¸ªå­˜å‚¨åç«¯ã€‚ å­˜å‚¨åç«¯æ˜¯ä¸å—ä¿¡ä»»çš„ï¼Œåªç”¨äºå­˜å‚¨åŠ å¯†æ•°æ®ã€‚ åˆå§‹åŒ–ï¼ˆInitializationï¼‰: Vault åœ¨é¦–æ¬¡å¯åŠ¨æ—¶éœ€è¦åˆå§‹åŒ–ï¼Œè¿™ä¸€æ­¥ç”Ÿæˆä¸€ä¸ªåŠ å¯†å¯†é’¥ï¼ˆEncryption Keyï¼‰ç”¨äºåŠ å¯†æ•°æ®ï¼ŒåŠ å¯†å®Œæˆçš„æ•°æ®æ‰èƒ½è¢«ä¿å­˜åˆ°å­˜å‚¨åç«¯ã€‚ è§£å°ï¼ˆUnsealï¼‰: Vault å¯åŠ¨åï¼Œå› ä¸ºä¸çŸ¥é“åŠ å¯†å¯†é’¥æ‰€ä»¥æ— æ³•è§£å¯†æ•°æ®ï¼Œè¿™ç§çŠ¶æ€è¢«å½¢è±¡å¾—ç§°ä½œå·²å°å°ï¼ˆSealedï¼‰ã€‚åœ¨è§£å°å‰ Vault æ— æ³•è¿›è¡Œä»»ä½•æ“ä½œã€‚ åŠ å¯†å¯†é’¥è¢«ä¸»å¯†é’¥ï¼ˆMaster Keyï¼‰ä¿æŠ¤ï¼Œæˆ‘ä»¬å¿…é¡»æä¾›ä¸»å¯†é’¥æ‰èƒ½è§£å¯†å‡º Vault çš„åŠ å¯†å¯†é’¥ï¼Œä»è€Œå®Œæˆè§£å°æ“ä½œã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒVault ä½¿ç”¨æ²™ç±³å°”å¯†é’¥åˆ†å‰²ç®—æ³• å°†ä¸»å¯†é’¥åˆ†å‰²æˆäº”ä¸ªåˆ†å‰²å¯†é’¥ï¼ˆKey Sharesï¼‰ï¼Œå¿…é¡»è¦æä¾›å…¶ä¸­ä»»æ„ä¸‰ä¸ªåˆ†å‰²å¯†é’¥æ‰èƒ½é‡å»ºå‡ºä¸»å¯†é’¥ï¼Œå®Œæˆè§£å°æ“ä½œã€‚ åˆ†å‰²å¯†é’¥çš„æ€»æ•°ï¼Œä»¥åŠé‡å»ºä¸»å¯†é’¥æœ€å°‘éœ€è¦çš„åˆ†å‰²å¯†é’¥æ•°é‡ï¼Œéƒ½æ˜¯å¯ä»¥è°ƒæ•´çš„ã€‚ æ²™ç±³å°”å¯†é’¥åˆ†å‰²ç®—æ³•ä¹Ÿå¯ä»¥å…³é—­ï¼Œè¿™æ ·ä¸»å¯†é’¥å°†è¢«ç›´æ¥æä¾›ç»™ç®¡ç†å‘˜ï¼Œç®¡ç†å‘˜å¯ç›´æ¥ä½¿ç”¨å®ƒè¿›è¡Œè§£å°æ“ä½œã€‚ ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:1:1","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"2. è®¤è¯ç³»ç»ŸåŠæƒé™ç³»ç»Ÿ åœ¨è§£å°å®Œæˆåï¼ŒVault å°±å¯ä»¥å¼€å§‹å¤„ç†è¯·æ±‚äº†ã€‚ HTTP è¯·æ±‚è¿›å…¥åçš„æ•´ä¸ªå¤„ç†æµç¨‹éƒ½ç”± vault core ç®¡ç†ï¼Œcore ä¼šå¼ºåˆ¶è¿›è¡Œ ACL æ£€æŸ¥ï¼Œå¹¶ç¡®ä¿å®¡è®¡æ—¥å¿—(audit logging)å®Œæˆè®°å½•ã€‚ å®¢æˆ·ç«¯é¦–æ¬¡è¿æ¥ vault æ—¶ï¼Œéœ€è¦å…ˆå®Œæˆèº«ä»½è®¤è¯ï¼Œvault çš„ auth methods æ¨¡å—æœ‰å¾ˆå¤šèº«ä»½è®¤è¯æ–¹æ³•å¯é€‰ï¼š 1ï¼‰ç”¨æˆ·å‹å¥½çš„è®¤è¯æ–¹æ³•ï¼Œé€‚åˆç®¡ç†å‘˜ä½¿ç”¨ï¼šusername/passwordã€äº‘æœåŠ¡å•†ã€ldapï¼Œåœ¨åˆ›å»º user çš„æ—¶å€™ï¼Œéœ€è¦ä¸º user ç»‘å®š policyï¼Œç»™äºˆåˆé€‚çš„æƒé™ã€‚ 2ï¼‰åº”ç”¨å‹å¥½çš„æ–¹æ³•ï¼Œé€‚åˆåº”ç”¨ç¨‹åºä½¿ç”¨ï¼špublic/private keysã€tokensã€kubernetesã€jwtèº«ä»½éªŒè¯è¯·æ±‚æµç» core å¹¶è¿›å…¥ auth methodsï¼Œauth methods ç¡®å®šè¯·æ±‚æ˜¯å¦æœ‰æ•ˆå¹¶è¿”å›ã€Œå…³è”ç­–ç•¥(policies)ã€çš„åˆ—è¡¨ã€‚ ACL ç­–ç•¥ç”± policy store è´Ÿè´£ç®¡ç†ä¸å­˜å‚¨ï¼Œç”± core è¿›è¡Œ ACL æ£€æŸ¥ã€‚ ACL çš„é»˜è®¤è¡Œä¸ºæ˜¯æ‹’ç»ï¼Œè¿™æ„å‘³ç€é™¤éæ˜ç¡®é…ç½® policy å…è®¸æŸé¡¹æ“ä½œï¼Œå¦åˆ™è¯¥æ“ä½œå°†è¢«æ‹’ç»ã€‚åœ¨é€šè¿‡ auth methods å®Œæˆäº†èº«ä»½è®¤è¯ï¼Œå¹¶ä¸”è¿”å›çš„å…³è”ç­–ç•¥ä¹Ÿæ²¡æ¯›ç—…ä¹‹åï¼Œtoken store å°†ä¼šç”Ÿæˆå¹¶ç®¡ç†ä¸€ä¸ªæ–°çš„å‡­è¯ï¼ˆtokenï¼‰ï¼Œ è¿™ä¸ª token ä¼šè¢«è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œç”¨äºè¿›è¡Œåç»­è¯·æ±‚ã€‚ç±»ä¼¼ web ç½‘ç«™çš„ cookieï¼Œtoken ä¹Ÿéƒ½å­˜åœ¨ä¸€ä¸ªç§ŸæœŸï¼ˆleaseï¼‰æˆ–è€…è¯´æœ‰æ•ˆæœŸï¼Œè¿™åŠ å¼ºäº†å®‰å…¨æ€§ã€‚token å…³è”äº†ç›¸å…³çš„ç­–ç•¥ policiesï¼Œè¿™äº›ç­–ç•¥å°†è¢«ç”¨äºéªŒè¯è¯·æ±‚çš„æƒé™ã€‚ è¯·æ±‚ç»è¿‡éªŒè¯åï¼Œå°†è¢«è·¯ç”±åˆ° secret engineã€‚å¦‚æœ secret engine è¿”å›äº†ä¸€ä¸ª secretï¼ˆç”± vault è‡ªåŠ¨ç”Ÿæˆçš„ secretï¼‰ï¼Œ core ä¼šå°†å…¶æ³¨å†Œåˆ° expiration managerï¼Œå¹¶ç»™å®ƒé™„åŠ ä¸€ä¸ª lease IDã€‚lease ID è¢«å®¢æˆ·ç«¯ç”¨äºæ›´æ–°(renew)æˆ–åŠé”€(revoke)å®ƒå¾—åˆ°çš„ secret. å¦‚æœå®¢æˆ·ç«¯å…è®¸ç§Ÿçº¦(lease)åˆ°æœŸï¼Œexpiration manager å°†è‡ªåŠ¨åŠé”€è¿™ä¸ª secret. core è¿˜è´Ÿè´£å¤„ç†å®¡æ ¸ä»£ç† audit brokerçš„è¯·æ±‚åŠå“åº”æ—¥å¿—ï¼Œå°†è¯·æ±‚å‘é€åˆ°æ‰€æœ‰å·²é…ç½®çš„å®¡æ ¸è®¾å¤‡ audit devices. ä¸è¿‡é»˜è®¤æƒ…å†µä¸‹è¿™ä¸ªåŠŸèƒ½è²Œä¼¼æ˜¯å…³é—­çš„ã€‚ ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:1:2","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"3. Secret Engine Secret Engine æ˜¯ä¿å­˜ã€ç”Ÿæˆæˆ–è€…åŠ å¯†æ•°æ®çš„ç»„ä»¶ï¼Œå®ƒéå¸¸çµæ´»ã€‚ æœ‰çš„ Secret Engines åªæ˜¯å•çº¯åœ°å­˜å‚¨ä¸è¯»å–æ•°æ®ï¼Œæ¯”å¦‚ kv å°±å¯ä»¥çœ‹ä½œä¸€ä¸ªåŠ å¯†çš„ Redisã€‚ è€Œå…¶ä»–çš„ Secret Engines åˆ™è¿æ¥åˆ°å…¶ä»–çš„æœåŠ¡å¹¶æŒ‰éœ€ç”ŸæˆåŠ¨æ€å‡­è¯ã€‚ è¿˜æœ‰äº› Secret Engines æä¾›ã€ŒåŠ å¯†å³æœåŠ¡(encryption as a service)ã€çš„èƒ½åŠ›ï¼Œå¦‚ transitã€è¯ä¹¦ç®¡ç†ç­‰ã€‚ å¸¸ç”¨çš„ engine ä¸¾ä¾‹ï¼š 1ï¼‰AliCloud Secrets Engine: åŸºäº RAM ç­–ç•¥åŠ¨æ€ç”Ÿæˆ AliCloud Access Tokenï¼Œæˆ–åŸºäº RAM è§’è‰²åŠ¨æ€ç”Ÿæˆ AliCloud STS å‡­æ®ï¼ŒAccess Token ä¼šè‡ªåŠ¨æ›´æ–°(Renew)ï¼Œè€Œ STS å‡­æ®æ˜¯ä¸´æ—¶ä½¿ç”¨çš„ï¼Œè¿‡æœŸåå°±å¤±æ•ˆäº†ã€‚ 2ï¼‰kv: é”®å€¼å­˜å‚¨ï¼Œå¯ç”¨äºå­˜å‚¨ä¸€äº›é™æ€çš„é…ç½®ã€‚å®ƒä¸€å®šç¨‹åº¦ä¸Šèƒ½æ›¿ä»£æ‰æºç¨‹çš„ Apollo é…ç½®ä¸­å¿ƒã€‚ 3ï¼‰Transit Secrets Engine: æä¾›åŠ å¯†å³æœåŠ¡çš„åŠŸèƒ½ï¼Œå®ƒåªè´Ÿè´£åŠ å¯†å’Œè§£å¯†ï¼Œä¸è´Ÿè´£å­˜å‚¨ã€‚ä¸»è¦åº”ç”¨åœºæ™¯æ˜¯å¸® app åŠ è§£å¯†æ•°æ®ï¼Œä½†æ˜¯æ•°æ®ä»æ—§å­˜å‚¨åœ¨ MySQL ç­‰æ•°æ®åº“ä¸­ã€‚ ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:1:3","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"äºŒã€éƒ¨ç½² ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:2:0","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"1ã€docker-compose version: '3.3' services: vault: image: vault:1.12.3 container_name: vault ports: - \"8200:8200\" restart: always volumes: - ./logs:/vault/logs - ./file:/vault/date - ./config.hcl:/vault/config/config.hcl #- ./certs:/certs # vault éœ€è¦é”å®šå†…å­˜ä»¥é˜²æ­¢æ•æ„Ÿå€¼ä¿¡æ¯è¢«äº¤æ¢(swapped)åˆ°ç£ç›˜ä¸­ # ä¸ºæ­¤éœ€è¦æ·»åŠ å¦‚ä¸‹ capability cap_add: - IPC_LOCK entrypoint: vault server -config /vault/config/config.hcl config.hcl å†…å®¹å¦‚ä¸‹ï¼š # å•æœºç‰ˆ ui = true listener \"tcp\" { tls_disable = 1 address = \"[::]:8200\" cluster_address = \"[::]:8201\" } storage \"file\" { path = \"/vault/data\" } ui = true // ä½¿ç”¨æ–‡ä»¶åšæ•°æ®å­˜å‚¨ï¼ˆå•èŠ‚ç‚¹ï¼‰ storage \"raft\" { path = \"/vault/date\" node_id = \"node1\" } listener \"tcp\" { address = \"[::]:8200\" tls_disable = \"true\" } api_addr = \"http://0.0.0.0/8200\" // ha è®¿é—®å…¥å£ï¼Œä¸èƒ½å†™0.0.0.0 cluster_addr = \"http://172.16.78.161:8201\" ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:2:1","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"2ã€åˆå§‹åŒ– # è®¾ç½®vaultåœ°å€ [root@sugar vault]# export VAULT_ADDR='http://127.0.0.1:8200' # å¤åˆ¶å‘½ä»¤åˆ°å®¿ä¸»æœº [root@sugar vault]# docker cp vault:/bin/vault /usr/local/bin/vault [root@sugar vault]# chmod +x /usr/local/bin/vault [root@sugar vault]# vault operator init vault operator init Unseal Key 1: aTpDcs5FQ1GzklifRwYCKdLPHpCUvNm9EGhZ0NH8Ut0p Unseal Key 2: 33V89ljeUr23AQpBgDANgFRzft+8f7E5KRXPDjsFpOG2 Unseal Key 3: OwfbdEA481baX8TZ0/kT49dBFg6ArXboVapBAd1y0fqk Unseal Key 4: DD1Lp86WGqVq+18LwUdGPxb6cquTjSz/yAIc9fkYNzF9 Unseal Key 5: FrqRqQSlhb/sjj7h9Pcau5eqrB/rxtkFBbBJSfuv48IM Initial Root Token: hvs.FTcALTSfrVuw9On8B2g2JQIl Vault initialized with 5 key shares and a key threshold of 3. Please securely distribute the key shares printed above. When the Vault is re-sealed, restarted, or stopped, you must supply at least 3 of these keys to unseal it before it can start servicing requests. Vault does not store the generated root key. Without at least 3 keys to reconstruct the root key, Vault will remain permanently sealed! It is possible to generate new unseal keys, provided you have a quorum of ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:2:2","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"3ã€è§£å° [root@sugar vault]# vault operator unseal aTpDcs5FQ1GzklifRwYCKdLPHpCUvNm9EGhZ0NH8Ut0p Key Value --- ----- Seal Type shamir Initialized true Sealed true Total Shares 5 Threshold 3 Unseal Progress 1/3 Unseal Nonce 8d5a33c3-bff5-e407-eb13-15c1457bdb63 Version 1.12.3 Build Date 2023-02-02T09:07:27Z Storage Type raft HA Enabled true [root@sugar vault]# vault operator unseal OwfbdEA481baX8TZ0/kT49dBFg6ArXboVapBAd1y0fqk Key Value --- ----- Seal Type shamir Initialized true Sealed true Total Shares 5 Threshold 3 Unseal Progress 2/3 Unseal Nonce 8d5a33c3-bff5-e407-eb13-15c1457bdb63 Version 1.12.3 Build Date 2023-02-02T09:07:27Z Storage Type raft HA Enabled true [root@sugar vault]# vault operator unseal 'FrqRqQSlhb/sjj7h9Pcau5eqrB/rxtkFBbBJSfuv48IM' Key Value --- ----- Seal Type shamir Initialized true Sealed false Total Shares 5 Threshold 3 Version 1.12.3 Build Date 2023-02-02T09:07:27Z Storage Type raft Cluster Name vault-cluster-8257ffed Cluster ID 2eccf238-400e-1ba5-f491-321c1388c826 HA Enabled true HA Cluster n/a HA Mode standby Active Node Address \u003cnone\u003e Raft Committed Index 31 Raft Applied Index 31 [root@sugar vault]# vault status Key Value --- ----- Seal Type shamir Initialized true Sealed false Total Shares 5 Threshold 3 Version 1.12.3 Build Date 2023-02-02T09:07:27Z Storage Type raft Cluster Name vault-cluster-8257ffed Cluster ID 2eccf238-400e-1ba5-f491-321c1388c826 HA Enabled true HA Cluster https://192.168.10.161:8201 HA Mode active Active Since 2023-03-07T12:11:38.884017872Z Raft Committed Index 36 Raft Applied Index 36 ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:2:3","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"4ã€ç™»å½•æµ‹è¯• # export VAULT_TOKEN='hvs.FTcALTSfrVuw9On8B2g2JQIl' [root@jenkins116 vault]# vault login Token (will be hidden): WARNING! The VAULT_TOKEN environment variable is set! The value of this variable will take precedence; if this is unwanted please unset VAULT_TOKEN or update its value accordingly. Success! You are now authenticated. The token information displayed below is already stored in the token helper. You do NOT need to run \"vault login\" again. Future Vault requests will automatically use this token. Key Value --- ----- token hvs.FTcALTSfrVuw9On8B2g2JQIl token_accessor vkDaIsiPx3w9JEpUWv9NRnQm token_duration âˆ token_renewable false token_policies [\"root\"] identity_policies [] policies [\"root\"] ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:2:4","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"ä¸‰ã€ç­–ç•¥ä¸æˆæƒ å‚è€ƒé“¾æ¥ï¼šhttps://zhuanlan.zhihu.com/p/370343645 â€‹ Vaultæ¨¡æ‹Ÿäº†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼ŒVaultä¸­æ‰€æœ‰çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬æœºå¯†ã€é…ç½®ç­‰ï¼Œéƒ½æ˜¯ä¾ç…§å„è‡ªçš„è·¯å¾„æ¥ä½¿ç”¨çš„ã€‚ä½¿ç”¨Vaultç­–ç•¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å£°æ˜å¼çš„è¯­æ³•æ¥èµ‹äºˆæˆ–è€…ç¦æ­¢å¯¹ç‰¹å®šè·¯å¾„çš„ç‰¹å®šæ“ä½œã€‚Vaultçš„ç­–ç•¥é»˜è®¤æƒ…å†µä¸‹æ˜¯æ‹’ç»ä¸€åˆ‡è®¿é—®çš„ï¼Œæ‰€ä»¥ä¸€ä¸ªç©ºçš„ç­–ç•¥ä¸ä¼šèµ‹äºˆå¯¹ç³»ç»Ÿçš„ä»»ä½•è®¿é—®æƒé™ã€‚ ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:3:0","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"1ã€ç­–ç•¥è¯­æ³• ç­–ç•¥ä½¿ç”¨HCLæˆ–æ˜¯JSONè¯­æ³•ç¼–å†™ï¼Œæè¿°äº†ä¸€ä¸ªäººç±»ç”¨æˆ·æˆ–æ˜¯åº”ç”¨ç¨‹åºå…è®¸è®¿é—®Vaultä¸­å“ªäº›è·¯å¾„ã€‚ ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œèµ‹äºˆå¯¹secret/fooè·¯å¾„çš„è¯»æƒé™ï¼š path \"secret/foo\" { capabilities = [\"read\"] } å½“è¿™ä¸ªç­–ç•¥è¢«é™„åŠ åˆ°ä¸€ä¸ªä»¤ç‰Œåï¼Œè¯¥ä»¤ç‰Œå¯ä»¥è¯»å–secret/fooï¼Œç„¶è€Œæ— æ³•ä¿®æ”¹æˆ–åˆ é™¤secret/fooï¼Œå› ä¸ºæ²¡æœ‰æˆäºˆå…¶ç›¸å…³èƒ½åŠ›ï¼ˆCapabilityï¼‰ã€‚ç”±äºç­–ç•¥ç³»ç»Ÿæ˜¯é»˜è®¤æ‹’ç»çš„ï¼Œæ‰€ä»¥ä»¤ç‰Œåœ¨Vaultä¸­æ²¡æœ‰å…¶ä»–æƒé™ã€‚ å¦ä¸€ä¸ªæ›´åŠ ä¸°å¯Œçš„ç­–ç•¥ï¼ŒåŒ…å«æ³¨é‡Šï¼š # This section grants all access on \"secret/*\". Further restrictions can be # applied to this broad policy, as shown below. path \"secret/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\"] } # Even though we allowed secret/*, this line explicitly denies # secret/super-secret. This takes precedence. path \"secret/super-secret\" { capabilities = [\"deny\"] } # Policies can also specify allowed, disallowed, and required parameters. Here # the key \"secret/restricted\" can only contain \"foo\" (any value) and \"bar\" (one # of \"zip\" or \"zap\"). path \"secret/restricted\" { capabilities = [\"create\"] allowed_parameters = { \"foo\" = [] \"bar\" = [\"zip\", \"zap\"] } } ç­–ç•¥åŸºäºè·¯å¾„åŒ¹é…æ¥éªŒè¯ä¸€ä¸ªè¯·æ±‚æ‰€éœ€è¦çš„èƒ½åŠ›ã€‚ä¸€ä¸ªç­–ç•¥è·¯å¾„å¯ä»¥ç²¾å‡†åŒ¹é…ä¸€ä¸ªç¡®åˆ‡çš„è·¯å¾„ï¼Œæˆ–è€…å¯ä»¥ä½¿ç”¨*æ¨¡å¼æŒ‡å®šå‰ç¼€åŒ¹é…ï¼š # Permit reading only \"secret/foo\". An attached token cannot read \"secret/food\" # or \"secret/foo/bar\". path \"secret/foo\" { capabilities = [\"read\"] } # Permit reading everything under \"secret/bar\". An attached token could read # \"secret/bar/zip\", \"secret/bar/zip/zap\", but not \"secret/bars/zip\". path \"secret/bar/*\" { capabilities = [\"read\"] } # Permit reading everything prefixed with \"zip-\". An attached token could read # \"secret/zip-zap\" or \"secret/zip-zap/zong\", but not \"secret/zip/zap path \"secret/zip-*\" { capabilities = [\"read\"] } å¦å¤–ï¼Œè·¯å¾„å½“ä¸­å¯ä»¥ä½¿ç”¨+ä»£è¡¨è·¯å¾„ä¸­ä¸€ä¸ªæ®µå†…ä»»æ„é•¿åº¦çš„å­—ç¬¦ï¼ˆä»Vault 1.1å¼€å§‹æ”¯æŒï¼‰ï¼š # Permit reading the \"teamb\" path under any top-level path under secret/ path \"secret/+/teamb\" { capabilities = [\"read\"] } # Permit reading secret/foo/bar/teamb, secret/bar/foo/teamb, etc. path \"secret/+/+/teamb\" { capabilities = [\"read\"] } Vaultæ¨¡æ‹Ÿäº†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½å¯¹åº”äº†ä¸€ä¸ªè·¯å¾„ï¼Œä»¥åŠå¯¹åº”çš„èƒ½åŠ›ï¼Œå³ä½¿æ˜¯Vaultå†…éƒ¨çš„æ ¸å¿ƒé…ç½®ä¿¡æ¯ä¹ŸæŒ‚è½½äºsys/è·¯å¾„ä¸‹ã€‚ç­–ç•¥å¯ä»¥å®šä¹‰ä¸€ä¸ªä»¤ç‰Œå¯¹è¿™äº›è·¯å¾„å’Œèƒ½åŠ›çš„è®¿é—®æƒé™ã€‚ Vaulté‡‡ç”¨ä¸€ç»„å…·æœ‰ä¼˜å…ˆçº§çš„åˆ¤å®šè§„åˆ™æ¥å†³å®šæœ€ä¸ºå…·ä½“çš„è·¯å¾„åŒ¹é…ã€‚å¦‚æœä¸€ä¸ªåŒ¹é…æ¨¡å¼è¢«å¤šä¸ªç­–ç•¥ä½¿ç”¨å¹¶èƒ½åŒ¹é…ä¸Šç»™å®šè·¯å¾„ï¼ŒVaultä¼šå–å…¶èƒ½åŠ›çš„å¹¶é›†ã€‚å¦‚æœä¸€ä¸ªè·¯å¾„èƒ½è¢«å¤šä¸ªç­–ç•¥å®šä¹‰çš„ä¸åŒçš„åŒ¹é…æ¨¡å¼æ‰€åŒ¹é…ï¼Œé‚£ä¹ˆåªæœ‰æœ€é«˜ä¼˜å…ˆçº§çš„åŒ¹é…ä¼šè¢«é‡‡ç”¨ã€‚ å‡è®¾å¯¹ç»™å®šè·¯å¾„Pï¼Œå­˜åœ¨ä¸¤æ¡ç­–ç•¥éƒ½èƒ½å¤ŸåŒ¹é…ï¼Œå®ƒä»¬çš„è·¯å¾„åŒ¹é…æ¨¡å¼åˆ†åˆ«æ˜¯P1å’ŒP2ï¼ŒVaulté‡‡ç”¨å¦‚ä¸‹ä¼˜å…ˆçº§è§„åˆ™ï¼š 1ï¼‰å¦‚æœP1ä¸­ç¬¬ä¸€ä¸ª+æˆ–æ˜¯*å‡ºç°çš„ä½ç½®æ—©äºP2ï¼Œé‚£ä¹ˆé‡‡ç”¨P2 2ï¼‰å¦‚æœP1ä»¥*ç»“å°¾ï¼Œè€ŒP2ä¸æ˜¯ï¼Œé‚£ä¹ˆé‡‡ç”¨P2 3ï¼‰å¦‚æœP1åŒ…å«æ›´å¤šçš„+æ®µï¼Œé‚£ä¹ˆé‡‡ç”¨P2 4ï¼‰å¦‚æœP1æ›´çŸ­ï¼Œé‚£ä¹ˆé‡‡ç”¨P2 5ï¼‰å¦‚æœP1å¾—åˆ°çš„å­—å…¸åºæ›´å°ï¼Œé‚£ä¹ˆé‡‡ç”¨P2 ä¸¾ä¸ªä¾‹å­ï¼Œç»™å®šä¸¤ä¸ªè·¯å¾„ï¼šsecret/*å’Œsecret/+/+/foo/*ï¼Œç”±äºç¬¬ä¸€ä¸ªé€šé…ç¬¦çš„ä½ç½®ç›¸åŒï¼ˆéƒ½åœ¨secret/ä¹‹åï¼‰ï¼Œå¹¶ä¸”éƒ½ä»¥*ç»“å°¾ï¼Œè€Œåè€…æ‹¥æœ‰æ›´å¤šçš„é€šé…ç¬¦æ®µï¼ˆå¤šäº†ä¸¤ä¸ª+/æ®µï¼‰ï¼Œæ‰€ä»¥ç»“æœæ˜¯ä½¿ç”¨secret/*è·¯å¾„æ¨¡å¼çš„ç­–ç•¥ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ*ä¸æ­£åˆ™è¡¨è¾¾å¼ä¸­çš„åŒç¬¦å·å¹¶ä¸åŒä¹‰ï¼ŒVaultä»…å…è®¸*å‡ºç°åœ¨æ¨¡å¼çš„æœ«å°¾ã€‚ å¦‚æœèµ‹äºˆäº†listèƒ½åŠ›ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å› ä¸ºlistæ“ä½œæ€»æ˜¯ä½œç”¨äºä¸€ä¸ªè·¯å¾„å‰ç¼€ä¸Šï¼Œæ‰€ä»¥ç­–ç•¥å®šä¹‰çš„è·¯å¾„åŒ¹é…æ¨¡å¼å¿…é¡»ä½¿ç”¨å‰ç¼€åŒ¹é…ï¼ˆå³ä»¥*ç»“å°¾ï¼‰ã€‚ èƒ½åŠ›ï¼ˆCapabilitesï¼‰ é™¤äº†è·¯å¾„åŒ¹é…æ¨¡å¼ä»¥å¤–ï¼Œæ¯æ¡è§„åˆ™éƒ½å¿…é¡»æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªèƒ½åŠ›æ¥å®šä¹‰ç»†é¢—ç²’åº¦çš„å…è®¸-ç¦æ­¢è§„åˆ™ã€‚èƒ½åŠ›æ°¸è¿œä»¥ä¸€ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨çš„å½¢å¼å®šä¹‰ï¼Œå“ªæ€•åªæœ‰ä¸€ä¸ªèƒ½åŠ›ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨ä¸‹é¢åˆ—å‡ºèƒ½åŠ›çš„åŒæ—¶ï¼Œä¹Ÿä¼šç»™å‡ºè¯¥èƒ½åŠ›ç›¸å¯¹åº”çš„HTTPåŠ¨è¯ã€‚å½“ç¼–å†™ç­–ç•¥æ—¶ï¼Œå¯ä»¥å…ˆæŸ¥é˜…ç›¸å…³HTTP APIæ–‡æ¡£äº†è§£è·¯å¾„ä¿¡æ¯ä»¥åŠç›¸å…³HTTPåŠ¨è¯ï¼Œç„¶åæ˜ å°„åˆ°ç­–ç•¥å®šä¹‰ä¸­çš„èƒ½åŠ›ã€‚è™½ç„¶æ˜ å°„å…³ç³»å¹¶ä¸æ˜¯ä¸¥æ ¼çš„1:1ï¼Œä½†å®ƒä»¬é€šå¸¸éå¸¸ç›¸ä¼¼åœ°åŒ¹é…ã€‚ create(POST/PUT)â€”â€”å…è®¸åœ¨æŒ‡å®šè·¯å¾„åˆ›å»ºæ•°æ®ã€‚åªæœ‰å¾ˆå°‘çš„Vaultéƒ¨ä»¶ä¼šåŒºåˆ†createå’Œupdateï¼Œæ‰€ä»¥å¤§å¤šæ•°æ“ä½œåŒæ—¶éœ€è¦createä»¥åŠupdateèƒ½åŠ›ã€‚éœ€è¦åŒºåˆ†äºŒè€…çš„éƒ¨åˆ†ä¼šåœ¨ç›¸å…³æ–‡æ¡£ä¸­è¯´æ˜ã€‚ read(GET)â€”â€”å…è®¸è¯»å–æŒ‡å®šè·¯å¾„çš„æ•°æ® update(POST/PUT)â€”â€”å…è®¸ä¿®æ”¹æŒ‡å®šè·¯å¾„çš„æ•°æ®ã€‚å¯¹å¤šæ•°Vaultéƒ¨ä»¶æ¥è¯´ï¼Œè¿™éšå«äº†åœ¨æŒ‡å®šä½ç½®åˆ›å»ºåˆå§‹å€¼çš„èƒ½åŠ› delete(DELETE)â€”â€”å…è®¸åˆ é™¤æŒ‡å®šè·¯å¾„çš„æ•°æ® list(LIST)â€”â€”å…è®¸ç½—åˆ—æŒ‡å®šè·¯å¾„çš„æ‰€æœ‰å€¼ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œç»ç”±listæ“ä½œè¿”å›çš„é”®æ˜¯æœªç»ç­–ç•¥è¿‡æ»¤çš„ã€‚è¯·å‹¿åœ¨é”®åä¸­ç¼–ç æ•æ„Ÿä¿¡æ¯ã€‚ä¸æ˜¯æ‰€æœ‰åç«¯éƒ½æ”¯æŒlistæ“ä½œ ä¸‹é¢çš„èƒ½åŠ›å¹¶æ— å¯¹åº”çš„HTTPåŠ¨è¯ï¼š sudoâ€”â€”å…è®¸è®¿é—®éœ€è¦æ ¹æƒé™ä¿æŠ¤çš„è·¯å¾„ã€‚é™¤éæ‹¥æœ‰sudoèƒ½åŠ›ï¼Œå¦åˆ™ä»¤ç‰Œè¢«ç¦æ­¢ä¸è¿™äº›è·¯å¾„äº¤äº’ï¼ˆå¯¹è¿™ç§è·¯å¾„çš„æ“ä½œå¯èƒ½åŒæ—¶éœ€è¦å…¶ä»–èƒ½åŠ›ï¼Œä¾‹å¦‚readæˆ–deleteï¼‰ ä¾‹å¦‚ï¼Œä¿®æ”¹å®¡è®¡æ—¥å¿—åç«¯é…ç½®å°±éœ€è¦ä»¤ç‰Œå…·æœ‰sudoç‰¹æƒã€‚ denyâ€”â€”ä¸å…è®¸è®¿é—®ã€‚è¯¥å®šä¹‰æ€»æ˜¯ä¼˜å…ˆäºå…¶ä»–èƒ½åŠ›å®šä¹‰ï¼ŒåŒ…æ‹¬sudoï¼Œåªè¦èƒ½åŠ›ä¸­å­˜åœ¨denyï¼Œå°±ä¸å…è®¸æ‰§è¡Œä»»ä½•æ“ä½œ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šè¿°çš„èƒ½åŠ›æ˜ å°„åˆ°çš„æ˜¯HTTPåŠ¨è¯è€Œéå®é™…åº•å±‚æ‰§è¡Œçš„æ“ä½œï¼Œè¿™é€šå¸¸ä¼šä½¿äººæ„Ÿåˆ°å›°æƒ‘ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œé€šè¿‡Vaultçš„æ•°æ®åº“æœºå¯†å¼•æ“åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ç”¨æˆ·åå¯†ç ï¼Œåº•å±‚å®é™…æ‰§è¡Œçš„æ“ä½œæ˜¯åˆ›å»ºï¼Œä½†å¯¹åº”çš„HTTPåŠ¨è¯å´æ˜¯GETï¼Œæ‰€ä»¥è¦åœ¨å¯¹åº”è·¯å¾„ä¸Šé…ç½®readèƒ½åŠ›ã€‚ ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:3:1","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"2ã€ç»†é¢—ç²’åº¦æ§åˆ¶ é™¤å´ä»¥ä¸Šæ ‡å‡†çš„èƒ½åŠ›ï¼ŒVaultè¿˜æä¾›äº†å¯¹æŒ‡å®šè·¯å¾„çš„æ›´ç»†é¢—ç²’åº¦çš„æƒé™æ§åˆ¶ã€‚ä¸è·¯å¾„ç›¸å…³è”çš„åŠŸèƒ½ä¼˜å…ˆäºå¯¹å‚æ•°çš„æ§åˆ¶ã€‚ 1ï¼‰å‚æ•°é™åˆ¶ éœ€è¦é¦–å…ˆè¯´æ˜ï¼ŒVersion 2çš„kvæœºå¯†å¼•æ“ä¸æ”¯æŒå‚æ•°é™åˆ¶ï¼Œæ‰€ä»¥ä»¥ä¸‹ä¾‹å­å‡å‡è®¾secret/è·¯å¾„æŒ‚è½½çš„æ˜¯Version 1çš„kvæœºå¯†å¼•æ“ã€‚ Vaultä¸­çš„æ•°æ®ä»¥é”®å€¼å¯¹çš„å½¢å¼è¡¨è¾¾ï¼škey=valueã€‚Vaultç­–ç•¥å¯ä»¥è¿›ä¸€æ­¥é™åˆ¶å¯¹æŒ‡å®šè·¯å¾„ä¸‹ç‰¹å®šé”®å’Œå€¼çš„è®¿é—®ã€‚è¿™äº›å¯é€‰çš„ç»†é¢—ç²’åº¦æ§åˆ¶é¡¹æœ‰ï¼š required_parametersâ€”â€”ä¸€ç»„å¿…é¡»æŒ‡å®šçš„å‚æ•°ï¼š # This requires the user to create \"secret/foo\" with a parameter named # \"bar\" and \"baz\". path \"secret/foo\" { capabilities = [\"create\"] required_parameters = [\"bar\", \"baz\"] } ä¸Šè¿°ä¾‹å­ä¸­ï¼Œç”¨æˆ·æƒ³è¦åœ¨secret/fooä¸‹åˆ›å»ºæ•°æ®ï¼Œå¿…é¡»åŒ…å«åä¸ºbarå’Œbazçš„å‚æ•°ã€‚ allowed_parametersâ€”â€”é’ˆå¯¹æŒ‡å®šè·¯å¾„å…è®¸æ“ä½œçš„é”®å€¼å¯¹çš„ç™½åå•ã€‚å€¼ä¸ºç©ºç™½åˆ—è¡¨åˆ™ä»£è¡¨å…è®¸ä½¿ç”¨ä»»æ„å€¼ï¼š # This allows the user to create \"secret/foo\" with a parameter named # \"bar\". It cannot contain any other parameters, but \"bar\" can contain # any value. path \"secret/foo\" { capabilities = [\"create\"] allowed_parameters = { \"bar\" = [] } } ä¸Šè¿°ä¾‹å­å…è®¸åœ¨secret/fooä¸‹åˆ›å»ºé”®ä¸ºbarï¼Œå€¼ä¸ºä»»æ„å€¼çš„æ•°æ®ã€‚ ç»™å®šéç©ºåˆ—è¡¨å€¼åˆ™æ„å‘³ç€åªèƒ½ä½¿ç”¨åˆ—è¡¨ä¸­é™å®šçš„å€¼ï¼š # This allows the user to create \"secret/foo\" with a parameter named # \"bar\". It cannot contain any other parameters, and \"bar\" can only # contain the values \"zip\" or \"zap\". path \"secret/foo\" { capabilities = [\"create\"] allowed_parameters = { \"bar\" = [\"zip\", \"zap\"] } } ä¸Šè¿°ä¾‹å­å…è®¸åœ¨secret/fooä¸‹åˆ›å»ºé”®ä¸ºbarï¼Œå€¼ä¸ºzipæˆ–zapçš„æ•°æ®ã€‚ å¦‚æœæŒ‡å®šäº†ä»»æ„çš„é”®ï¼Œé‚£ä¹ˆæ‰€æœ‰æœªè¢«æŒ‡å®šçš„é”®éƒ½ä¼šè¢«æ‹’ç»ï¼Œé™¤éåŒæ—¶æŒ‡å®šäº†*å‚æ•°ä¸ºç©ºåˆ—è¡¨ï¼Œè¿™å°±å…è®¸ä¿®æ”¹å…¶ä»–ä»»æ„é”®æ•°æ®ã€‚è¢«æŒ‡å®šçš„é”®ä»ç„¶å—åˆ°ç»™å®šçš„å€¼åˆ—è¡¨çš„é™åˆ¶ï¼š # This allows the user to create \"secret/foo\" with a parameter named # \"bar\". The parameter \"bar\" can only contain the values \"zip\" or \"zap\", # but any other parameters may be created with any value. path \"secret/foo\" { capabilities = [\"create\"] allowed_parameters = { \"bar\" = [\"zip\", \"zap\"] \"*\" = [] } } ä¸Šè¿°ä¾‹å­ä¸­ï¼Œåªé™åˆ¶å¯¹barçš„å€¼å¿…é¡»æ˜¯zipæˆ–zapï¼Œå¯¹å…¶ä»–é”®çš„å€¼åˆ™æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œå¯ä»¥åˆ›å»ºä»»æ„é”®ã€‚ é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œä½¿ç”¨*å¯èƒ½ä¼šé€ æˆæ„å¤–çš„åæœï¼š # This allows the user to create or update \"secret/foo\" with a parameter # named \"bar\". The values passed to parameter \"bar\" must start with \"baz/\" # so values like \"baz/quux\" are fine. However, values like # \"baz/quux,wibble,wobble,wubble\" would also be accepted. The API that # underlies \"secret/foo\" might allow comma delimited values for the \"bar\" # parameter, and if it did, specifying a value like # \"baz/quux,wibble,wobble,wubble\" would result in 4 different values getting # passed along. Seeing values like \"wibble\" or \"wobble\" getting passed to # \"secret/foo\" might surprise someone that expected the allowed_parameters # constraint to only allow values starting with \"baz/\". path \"secret/foo\" { capabilities = [\"create\", \"update\"] allowed_parameters = { \"bar\" = [\"baz/*\"] } } åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é™åˆ¶å¯¹secret/fooåªèƒ½å†™å…¥é”®ä¸ºbarçš„æ•°æ®ï¼Œå¹¶ä¸”å€¼å¿…é¡»ä»¥baz/ä¸ºå‰ç¼€ã€‚æ¯”å¦‚bar=baz/quuxè¿™æ ·çš„æ•°æ®å°±æ˜¯åˆæ³•çš„ã€‚é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠå€¼è®¾ç½®æˆbaz/quux,wibble,wobble,wubbleï¼ŒVaultä¼šæ¥çº³è¿™ç§å¸¦æœ‰åˆ†éš”ç¬¦çš„å€¼ï¼Œè€Œè¿™æ ·çš„å€¼å¯èƒ½ä¼šè¢«åº”ç”¨ç¨‹åºè§£æä¸ºé•¿åº¦ä¸º4çš„åˆ—è¡¨ï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬å¯èƒ½ä¼šæƒŠè®¶åœ°å‘ç°å³ä½¿æˆ‘ä»¬é™åˆ¶äº†barçš„å€¼å¿…é¡»ä»¥baz/ä¸ºå‰ç¼€ï¼Œä»ç„¶è¯»å–åˆ°äº†è¯¸å¦‚wibbleè¿™æ ·çš„å€¼ã€‚ denied_parametersâ€”â€”é”®å€¼å¯¹çš„é»‘åå•ï¼Œä¼˜å…ˆçº§é«˜äºallowed_parametersã€‚ è®¾ç½®å€¼ä¸ºç©ºåˆ—è¡¨ä¼šå¯¼è‡´æ‹’ç»å¯¹å¯¹åº”é”®çš„ä»»æ„ä¿®æ”¹ã€‚ # This allows the user to create \"secret/foo\" with any parameters not # named \"bar\". path \"secret/foo\" { capabilities = [\"create\"] denied_parameters = { \"bar\" = [] } } ä¸Šé¢çš„ä¾‹å­ç¦æ­¢åœ¨secret/fooä¸‹åˆ›å»ºé”®ä¸ºbarçš„ä»»æ„é”®å€¼å¯¹ã€‚ å¦‚æœå¯¹denied_parametersèµ‹å€¼ä¸€ä¸ªéç©ºåˆ—è¡¨ï¼Œä¼šå¯¼è‡´ç¦æ­¢å‚æ•°çš„å€¼åŒ…å«åˆ—è¡¨ä¸­çš„ä»»æ„å…ƒç´ ï¼š # This allows the user to create \"secret/foo\" with a parameter named # \"bar\". It can contain any other parameters, but \"bar\" cannot contain # the values \"zip\" or \"zap\". path \"secret/foo\" { capabilities = [\"create\"] denied_parameters = { \"bar\" = [\"zip\", \"zap\"] } } ä¸Šè¿°ä¾‹å­ç¦æ­¢è®¾ç½®secret/fooçš„barçš„å€¼ä¸ºzipæˆ–æ˜¯zapã€‚ è®¾ç½®denied_parametersçš„é”®ä¸º*ï¼Œåˆ™ç¦æ­¢æ“ä½œä»»æ„é”®ï¼š # This allows the user to create \"secret/foo\", but it cannot have any # parameters. path \"secret/foo\" { capabilities = [\"create\"] denied_parameters = { \"*\" = [] } } å¦‚æœdenied_parametersé…ç½®äº†ä»»æ„é”®ï¼Œé‚£ä¹ˆé»˜è®¤æ‰€æœ‰æœªè¢«æŒ‡å®šçš„é”®éƒ½æ˜¯å…è®¸æ“ä½œçš„ï¼Œé™¤éå¦æœ‰æ˜¾å¼çš„allowed_parametersé…ç½®ã€‚ å‚æ•°é™åˆ¶ä¸­çš„å€¼ä¹Ÿæ”¯æŒå‰ç¼€ä¸åç¼€è¡¨ç¤ºï¼š path \"secret/foo\" { capabilities = [\"create\"] allowed_parameters = { \"bar\" = [\"foo-*\"] } } ä¸Šé¢çš„ä¾‹å­è§„å®šå¯¹secret/fooï¼Œåªèƒ½åˆ›å»ºé”®ä¸ºbarï¼Œå€¼ä»¥foo-ä¸ºå‰ç¼€çš„é”®å€¼å¯¹ã€‚ path \"secret/foo\" { capabilities = [\"create\"] allowed_parameters = { \"bar\" = [\"*-foo\"] } } è€Œä¸Šé¢çš„ä¾‹å­åˆ™æ˜¯é™åˆ¶å€¼å¿…é¡»ä»¥-fooä¸ºåç¼€ã€‚ 2ï¼‰é™åˆ¶å“åº”å°è£…çš„æœ‰æ•ˆæœŸ Vaultå¯ä»¥è®¾ç½®å“åº”å°è£…æœºåˆ¶ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ç­–ç•¥ä¸­ä½¿ç”¨ç›¸å…³å‚æ•°é™åˆ¶å®¢æˆ·ç«¯å¯ä»¥ç”³è¯·çš„å“åº”å°è£…çš„æœ‰æ•ˆæœŸæ—¶é™ï¼Œç²¾ç¡®åˆ°ç§’ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡sã€mæˆ–æ˜¯håç¼€æ¥ä»£è¡¨ç§’ã€åˆ†é’Ÿå’Œå°æ—¶ã€‚ åœ¨å®è·µä¸­ï¼Œä¸ºç‰¹å®šè·¯å¾„æŒ‡å®šå€¼ä¸ºä¸€ç§’çš„min_wrapping_ttlå¯ä»¥è¾¾åˆ°å¼ºåˆ¶å¿…é¡»ä»¥å“åº”å°è£…çš„å½¢å¼è¿”å›ç›¸åº”è·¯å¾„æ•°æ®çš„ç›®çš„ã€‚ min_wrapping_ttlâ€”â€”å®¢æˆ·ç«¯å¯ä»¥æŒ‡å®šçš„å“åº”å°è£…æœ‰æ•ˆæœŸçš„æœ€å°å€¼ï¼Œå¦‚æœè®¾ç½®è¯¥å€¼ï¼Œåˆ™å¼ºåˆ¶å¿…é¡»ä»¥å“åº”å°è£…çš„å½¢å¼è¿”å›ç›¸åº”è·¯å¾„çš„æ•°æ® max_wrapping_ttlâ€”â€”å…","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:3:2","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"3ã€å†…å»ºç­–ç•¥ Vaultæœ‰ä¸¤ä¸ªå†…å»ºç­–ç•¥ï¼šdefaultå’Œrootã€‚æœ¬èŠ‚æ¥è®¨è®ºä¸‹è¿™ä¸¤ä¸ªå†…å»ºç­–ç•¥ã€‚ 1ï¼‰Defaultç­–ç•¥ defaultç­–ç•¥æ˜¯ä¸€ä¸ªæ— æ³•åˆ é™¤çš„Vaultå†…å»ºç­–ç•¥ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒè¢«é™„åŠ åˆ°æ‰€æœ‰ä»¤ç‰Œä¸Šï¼Œä½†å¯ä»¥é€šè¿‡ä½¿ç”¨èº«ä»½éªŒè¯æ–¹å¼åˆ›å»ºä»¤ç‰Œæ—¶æ˜¾å¼æ’é™¤ä¹‹ã€‚ è¯¥ç­–ç•¥åŒ…å«äº†åŸºç¡€çš„åŠŸèƒ½ï¼Œä¾‹å¦‚å‡†è®¸ä»¤ç‰ŒæŸ¥è¯¢æœ‰å…³è‡ªèº«çš„æ•°æ®ä»¥åŠä½¿ç”¨**Cubbyholeæ•°æ®**ã€‚ç„¶è€Œï¼ŒVaultå¹¶ä¸é™åˆ¶è¯¥ç­–ç•¥çš„å†…å®¹ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹å®ƒã€‚Vaultæ°¸è¿œä¸ä¼šè¦†ç›–ä½ çš„è®¾ç½®ã€‚å¦‚æœä½ æƒ³æŠŠdefaultç­–ç•¥åŒæ­¥åˆ°æœ€æ–°çš„Vaultç‰ˆæœ¬çš„é»˜è®¤å€¼ï¼Œåªè¦ç”¨æ–°ç‰ˆVaultæ‰§è¡Œvault server -devå¯åŠ¨ä¸€ä¸ªæµ‹è¯•æœåŠ¡ï¼Œè¯»å–å®ƒçš„defaultç­–ç•¥å†…å®¹ï¼Œç„¶åå†™å›åˆ°åŸæ¥çš„VaultæœåŠ¡çš„defaultç­–ç•¥å³å¯ï¼š $ vault read sys/policy/default Key Value --- ----- name default rules # Allow tokens to look up their own properties path \"auth/token/lookup-self\" { capabilities = [\"read\"] } # Allow tokens to renew themselves path \"auth/token/renew-self\" { capabilities = [\"update\"] } # Allow tokens to revoke themselves path \"auth/token/revoke-self\" { capabilities = [\"update\"] } # Allow a token to look up its own capabilities on a path path \"sys/capabilities-self\" { capabilities = [\"update\"] } # Allow a token to look up its own entity by id or name path \"identity/entity/id/{{identity.entity.id}}\" { capabilities = [\"read\"] } path \"identity/entity/name/{{identity.entity.name}}\" { capabilities = [\"read\"] } # Allow a token to look up its resultant ACL from all policies. This is useful # for UIs. It is an internal path because the format may change at any time # based on how the internal ACL features and capabilities change. path \"sys/internal/ui/resultant-acl\" { capabilities = [\"read\"] } # Allow a token to renew a lease via lease_id in the request body; old path for # old clients, new path for newer path \"sys/renew\" { capabilities = [\"update\"] } path \"sys/leases/renew\" { capabilities = [\"update\"] } # Allow looking up lease properties. This requires knowing the lease ID ahead # of time and does not divulge any sensitive information. path \"sys/leases/lookup\" { capabilities = [\"update\"] } # Allow a token to manage its own cubbyhole path \"cubbyhole/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\"] } # Allow a token to wrap arbitrary values in a response-wrapping token path \"sys/wrapping/wrap\" { capabilities = [\"update\"] } # Allow a token to look up the creation time and TTL of a given # response-wrapping token path \"sys/wrapping/lookup\" { capabilities = [\"update\"] } # Allow a token to unwrap a response-wrapping token. This is a convenience to # avoid client token swapping since this is also part of the response wrapping # policy. path \"sys/wrapping/unwrap\" { capabilities = [\"update\"] } # Allow general purpose tools path \"sys/tools/hash\" { capabilities = [\"update\"] } path \"sys/tools/hash/*\" { capabilities = [\"update\"] } # Allow checking the status of a Control Group request if the user has the # accessor path \"sys/control-group/request\" { capabilities = [\"update\"] } åˆ›å»ºä»¤ç‰Œæ—¶æ’é™¤defaultç­–ç•¥ï¼š $ vault token create -no-default-policy æˆ–æ˜¯è°ƒç”¨APIï¼š $ curl \\ --request POST \\ --header \"X-Vault-Token: ...\" \\ --data '{\"no_default_policy\": \"true\"}' \\ https://vault.hashicorp.rocks/v1/auth/token/create æ ¹ç­–ç•¥ rootç­–ç•¥æ˜¯ä¸€ä¸ªæ— æ³•åˆ é™¤ä¹Ÿæ— æ³•ä¿®æ”¹çš„Vaultå†…å»ºç­–ç•¥ã€‚ä»»ä½•å…³è”äº†è¯¥ç­–ç•¥çš„ç”¨æˆ·éƒ½å°†æ˜¯æ ¹ç”¨æˆ·ã€‚æ ¹ç”¨æˆ·å¯ä»¥åœ¨Vaultå†…æ‰§è¡Œä»»æ„æ“ä½œï¼Œå¼ºçƒˆå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨Vaultå‰é¦–å…ˆåŠé”€æ‰€æœ‰çš„æ ¹ä»¤ç‰Œã€‚ æ¯å½“VaultæœåŠ¡è¢«é¦–æ¬¡åˆå§‹åŒ–æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ¹ç”¨æˆ·ã€‚è¿™ä¸ªæ ¹ç”¨æˆ·æ˜¯ç”¨æ¥æ‰§è¡ŒVaultçš„åˆå§‹åŒ–é…ç½®çš„ã€‚é…ç½®å®Œæˆåï¼Œåº”åˆ›å»ºå¹¶ä½¿ç”¨ç”±ç»†é¢—ç²’åº¦ç­–ç•¥çº¦æŸçš„ç”¨æˆ·å¹¶å¯ç”¨èº«ä»½è®¤è¯æ–¹å¼ï¼Œç„¶ååŠé”€æ ¹ä»¤ç‰Œã€‚ è¦åŠé”€æ ¹ä»¤ç‰Œå¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œï¼š $ vault token revoke \"\u003ctoken\u003e\" æˆ–æ˜¯é€šè¿‡HTTP APIï¼š $ curl \\ --request POST \\ --header \"X-Vault-Token: ...\" \\ --data '{\"token\": \"\u003ctoken\u003e\"}' \\ https://vault.hashicorp.rocks/v1/auth/token/revoke ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:3:3","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"å››ã€vault cliä½¿ç”¨ æ˜¾ç¤ºæ‰€æœ‰ç­–ç•¥ $ vault read sys/policy ä¸Šä¼ å¹¶åˆ›å»ºç­–ç•¥ $ vault policy write policy-name policy-file.hcl # http $ curl \\ --request POST \\ --header \"X-Vault-Token: ...\" \\ --data '{\"policy\":\"path \\\"...\\\" {...} \"}' \\ https://vault.hashicorp.rocks/v1/sys/policy/policy-name # è¿™ä¸¤ä¸ªä¾‹å­é‡Œï¼Œç­–ç•¥çš„åç§°éƒ½æ˜¯ policy-nameã€‚ä½ å¯ä»¥æŠŠç­–ç•¥åç†è§£æˆæŒ‡å‘ç­–ç•¥è§„åˆ™çš„æŒ‡é’ˆã€‚ä»¤ç‰Œé€šè¿‡ç­–ç•¥åå…³è”ç›¸å…³ç­–ç•¥è§„åˆ™ã€‚ æ›´æ–°ç­–ç•¥ $ vault write my-existing-policy updated-policy.json # http $ curl \\ --request POST \\ --header \"X-Vault-Token: ...\" \\ --data '{\"policy\":\"path \\\"...\\\" {...} \"}' \\ https://vault.hashicorp.rocks/v1/sys/policy/my-existing-policy åˆ é™¤ç­–ç•¥ $ vault delete sys/policy/policy-name # http $ curl \\ --request DELETE \\ --header \"X-Vault-Token: ...\" \\ https://vault.hashicorp.rocks/v1/sys/policy/policy-name # åˆ é™¤æ˜¯ä¸€ä¸ªå¹‚ç­‰æ“ä½œã€‚åˆ é™¤ä¸€ä¸ªä¸å­˜åœ¨çš„ç­–ç•¥ä¸ä¼šå¯¼è‡´Vaultè¿”å›é”™è¯¯ã€‚ ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:4:0","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"äº”ã€ç”¨æˆ·æƒé™ç®¡ç† ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:5:0","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"1ã€å…³è”ç­–ç•¥ Vaultå¯ä»¥é€šè¿‡èº«ä»½è®¤è¯æ–¹å¼ç™»å½•æ—¶è‡ªåŠ¨åœ¨ä»¤ç‰Œä¸Šå…³è”ä¸€ç»„ç­–ç•¥ï¼Œç›¸å…³é…ç½®éšå…·ä½“çš„èº«ä»½è®¤è¯æ–¹å¼ç±»å‹è€Œä¸åŒã€‚ç®€å•èµ·è§ï¼Œæˆ‘ä»¬æ¼”ç¤ºä¸€ä¸‹Vaultå†…å»ºçš„userpassè®¤è¯æ–¹å¼ã€‚ Vaultç®¡ç†å‘˜æˆ–æ˜¯å®‰å…¨å›¢é˜Ÿæˆå‘˜å¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤è¡Œåˆ›å»ºä¸€ä¸ªå…³è”äº†ä¸€ç»„ç­–ç•¥çš„ç”¨æˆ·ï¼š # å¼€å¯ç”¨æˆ·ç™»å½• vault auth enable userpass # http æ–¹å¼å¼€å¯ $ curl \\ --request DELETE \\ --header \"X-Vault-Token: ...\" \\ https://vault.hashicorp.rocks/v1/sys/policy/policy-name curl -XPOST -s -H \"X-Vault-Token: xxxxx\" \"http://vault.local.com/v1/sys/auth/userpass\" -d'{\"type\": \"userpass\"}' # åˆ›å»ºsethvargoç”¨æˆ·ï¼Œå¹¶è®¾ç½®å¯†ç å’Œç­–ç•¥ $ vault write auth/userpass/users/sethvargo \\ password=\"s3cr3t!\" \\ policies=\"dev-readonly,logs\" ç”¨æˆ·å¯ä»¥ç”¨å‘½ä»¤è¡Œæ‰§è¡Œèº«ä»½è®¤è¯ï¼Œè·å–ä»¤ç‰Œï¼š $ vault login -method=\"userpass\" username=\"sethvargo\" Password (will be hidden): ... å¦‚æœç”¨æˆ·åå¯†ç æ­£ç¡®ï¼ŒVaultä¼šåˆ›å»ºä¸€ä¸ªä»¤ç‰Œï¼Œå°†é¢„è®¾çš„ç­–ç•¥é™„åŠ åœ¨ä»¤ç‰Œä¸Šï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·ã€‚ ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:5:1","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"2ã€åˆ›å»ºä»¤ç‰Œæ—¶é™„åŠ ç­–ç•¥ å¯ä»¥åœ¨é€šè¿‡å‘½ä»¤è¡Œåˆ›å»ºä»¤ç‰Œæ—¶å…³è”ç­–ç•¥ï¼š $ vault token create -policy=dev-readonly -policy=logs å­ä»¤ç‰Œå¯ä»¥å…³è”ä¸€ç»„çˆ¶ä»¤ç‰Œæ‹¥æœ‰çš„ç­–ç•¥çš„å­é›†ã€‚æ ¹ç”¨æˆ·å¯ä»¥åˆ†æ´¾ä»»æ„ç­–ç•¥ã€‚ ä¸€æ—¦ä»¤ç‰Œè¢«ç­¾å‘ï¼Œå…¶å…³è”çš„ç­–ç•¥æ— æ³•å†è¢«ä¿®æ”¹ã€‚å¿…é¡»åŠé”€æ—§ä»¤ç‰Œå¹¶ç”³è¯·æ–°ä»¤ç‰Œæ‰èƒ½å¾—åˆ°æ›´æ–°åçš„å…³è”ç­–ç•¥ã€‚ ç„¶è€Œï¼Œä»¤ç‰Œå…³è”çš„ç­–ç•¥å†…å®¹æ˜¯å®æ—¶è§£æçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ›´æ–°äº†ç­–ç•¥å†…å®¹ï¼Œé™„åŠ æ­¤ç­–ç•¥çš„ä»¤ç‰Œä¸‹æ¬¡çš„è¯·æ±‚å°±ä¼šæŒ‰ç…§æ–°ç­–ç•¥å†…å®¹è¿›è¡Œæƒé™æ£€æŸ¥ã€‚ ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:5:2","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"å…­ã€terraform ç®¡ç† terraform { required_providers { vault = { source = \"hashicorp/vault\" } } } provider \"vault\" { address = var.vault-init.url token = var.vault-init.token } resource \"vault_mount\" \"secret_path\" { for_each = var.vault-init.secret_path path = each.value.path type = each.value.type description = each.value.description options = { version = \"1\" } } resource \"vault_policy\" \"policy\" { for_each = var.vault-init.policy name = each.key policy = each.value.policy } resource \"vault_auth_backend\" \"userpass\" { type = \"userpass\" } resource \"vault_generic_endpoint\" \"create_user\" { for_each = var.vault-init.userlist path = \"auth/userpass/users/${each.key}\" ignore_absent_fields = true data_json = jsonencode(each.value) depends_on = [ vault_auth_backend.userpass, vault_policy.policy ] } resource \"vault_generic_secret\" \"secret_value\" { for_each = var.vault-init.secret_value path = \"${each.value.path}/${each.key}\" data_json = jsonencode(each.value.data) depends_on = [ vault_mount.secret_path, vault_policy.policy ] } variable \"vault-init\" { type = any default = { url = null token = null secret_path = {} userlist = {} policy = {} secret_value = {} } } tfvars vault-init = { url = \"http://127.0.0.1:8200\" token = \"cccccccccc\" secret_path = { p2 = { path = \"Monitor\" type = \"kv\" description = \"Metrics/Tracing/Logs\" }, p5 = { path = \"APP\" type = \"kv\" description = \"Gitea/Gitlab\" } } policy = { admin = { policy = \u003c\u003cEOT path \"cubbyhole/*\" { capabilities = [\"deny\"] } path \"sys/auth\" { capabilities = [\"read\"] } path \"auth/userpass/users/*\" { capabilities = [\"list\", \"read\", \"update\"] } path \"Monitor/+\" { capabilities = [\"read\", \"list\"] } path \"APP/+\" { capabilities = [\"read\", \"list\", \"update\", \"patch\"] } path \"APP/+/+\" { capabilities = [\"read\", \"list\"] } EOT }, user = { policy = \u003c\u003cEOT path \"cubbyhole/*\" { capabilities = [\"deny\"] } path \"Hardware/+\" { capabilities = [\"deny\"] } path \"Monitor/+\" { capabilities = [\"read\", \"list\"] } EOT } } userlist = { user = { username = \"user\", password = \"hello_world\", policies = [\"user\"] }, admin = { username = \"admin\", password = \"hello_world\", policies = [\"admin\"] } } secret_value = { Grafana = { path = \"Monitor\" data = { \"External Address\"= \"http://grafana.local.com\", \"Password\"= \"CvcTKkm4xxxxxxxxx\", \"Username\"= \"admin\" } } } } ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:6:0","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["DevOps"],"content":"Terraform vault unseal vault å®˜æ–¹æ”¯æŒçš„è‡ªåŠ¨ unseal ä¾èµ–äºç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œé™¤æ­¤ä»¥å¤–å¯ä»¥ä½¿ç”¨ vault cli å’Œ http æ–¹å¼è§£å°ã€‚ åŸºäº scottwinkler/shellï¼Œé€šè¿‡æ‰§è¡Œå‘½ä»¤è¿›è¡Œ vault çš„åˆå§‹åŒ–å’Œ unseal terraform { required_providers { helm = { source = \"hashicorp/helm\" } shell = { source = \"scottwinkler/shell\" version = \"1.7.10\" } } } module \"vault\" { count = var.vault.enabled ? 1 : 0 source = \"xxxx\" xxxxx } resource \"shell_script\" \"vault_init\" { count = var.vault.enabled ? 1 : 0 lifecycle_commands { create = \u003c\u003cEOF sleep 50 kubectl -n ${module.vault[0].namespace} exec vault-0 -- vault operator init -key-shares=6 -key-threshold=3 -format=json EOF delete = \"\" } environment = { KUBECONFIG = var.kubeconfig } depends_on = [ module.vault, ] } resource \"shell_script\" \"vault_unseal\" { count = var.vault.enabled ? 1 : 0 lifecycle_commands { create = \u003c\u003cEOF kubectl -n ${module.vault[0].namespace} exec vault-0 -- vault operator unseal ${jsondecode(shell_script.vault_init[0].output.unseal_keys_b64)[0]} kubectl -n ${module.vault[0].namespace} exec vault-0 -- vault operator unseal ${jsondecode(shell_script.vault_init[0].output.unseal_keys_b64)[1]} kubectl -n ${module.vault[0].namespace} exec vault-0 -- vault operator unseal ${jsondecode(shell_script.vault_init[0].output.unseal_keys_b64)[2]} EOF delete = \"\" } environment = { KUBECONFIG = var.kubeconfig } depends_on = [module.vault] } ","date":"2024-01-07","objectID":"/posts/2024-01-07-vault/:6:1","tags":["vault"],"title":"Vault","uri":"/posts/2024-01-07-vault/"},{"categories":["Database"],"content":"SQL Server docker run -e \"ACCEPT_EULA=Y\" -e \"SA_PASSWORD=Y.sa123456\" -p 1433:1433 --name mssql2022 -d mcr.microsoft.com/mssql/server:2022-latest å…¶ä¸­ sa123456 ä¸º SQL Server sa ç”¨æˆ·çš„å¯†ç ï¼ŒSA_PASSWORD=Y.sa123456 ä¸ºå¯†ç ï¼Œè¦æ±‚æ˜¯æœ€å°‘8ä½çš„å¼ºå¯†ç ï¼Œè¦æœ‰å¤§å†™å­—æ¯ï¼Œå°å†™å­—æ¯ï¼Œæ•°å­—ä»¥åŠç‰¹æ®Šç¬¦å·ï¼Œ ","date":"2023-12-27","objectID":"/posts/2023-12-27-mssql/:0:0","tags":["db","sqlserver","mssql"],"title":"SQL Server","uri":"/posts/2023-12-27-mssql/"},{"categories":["DevOps"],"content":"k3s å‚è€ƒé“¾æ¥ï¼š https://www.escapelife.site/posts/754ba85c.html ","date":"2023-12-16","objectID":"/posts/2023-12-16-k3s/:0:0","tags":["k3s","k8s"],"title":"k3s","uri":"/posts/2023-12-16-k3s/"},{"categories":["DevOps"],"content":"ä¸€ã€ç®€ä»‹ K3s æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ Kubernetes å‘è¡Œç‰ˆï¼Œå®ƒé’ˆå¯¹è¾¹ç¼˜è®¡ç®—ã€ç‰©è”ç½‘ç­‰åœºæ™¯è¿›è¡Œäº†é«˜åº¦ä¼˜åŒ–ã€‚ CNCF è®¤è¯çš„ Kubernetes å‘è¡Œç‰ˆ æ”¯æŒ X86_64, ARM64, ARMv7 å¹³å° å•ä¸€è¿›ç¨‹åŒ…å« Kubernetes masterï¼Œkubelet å’Œ containerd K3s æœ‰ä»¥ä¸‹å¢å¼ºåŠŸèƒ½ï¼š æ‰“åŒ…ä¸ºå•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ æŠŠ K8S ç›¸å…³çš„ç»„ä»¶ï¼Œæ¯”å¦‚ kube-api/ kube-manager éƒ½æ‰“åŒ…åˆ°åŒä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶é‡Œé¢ï¼Œè¿™æ ·çš„è¯ï¼Œåªéœ€è¦å¯åŠ¨è¿™ä¸ªæ–‡ä»¶å°±å¯ä»¥å¿«é€Ÿçš„å¯åŠ¨å¯¹åº”çš„ç»„ä»¶ã€‚ ä½¿ç”¨åŸºäº sqlite3 çš„é»˜è®¤å­˜å‚¨æœºåˆ¶ åŒæ—¶æ”¯æŒä½¿ç”¨ etcd3ã€MySQL å’Œ PostgreSQL ä½œä¸ºå­˜å‚¨æœºåˆ¶ã€‚ é»˜è®¤æƒ…å†µä¸‹æ˜¯å®‰å…¨çš„ åœ¨ K3s ä¸­æœ‰ä¸€ä¸ªé»˜è®¤çš„è¯ä¹¦ç®¡ç†æœºåˆ¶(é»˜è®¤ä¸€å¹´æœ‰æ•ˆæœŸ)ï¼Œä¹Ÿæœ‰ä¸€ä¸ªå¯ä»¥è½®è½¬è¯ä¹¦çš„åŠŸèƒ½(å°±æ˜¯åœ¨å°äºä¹åå¤©ä¹‹å†…é‡å¯ K3s çš„è¯ï¼Œå°±ä¼šè‡ªåŠ¨ç»­ä¸€å¹´)ã€‚ åŠŸèƒ½å¼ºå¤§çš„ batteries-included åŠŸèƒ½ å°±æ˜¯è™½ç„¶æœ‰äº›æœåŠ¡æœ¬èº«è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶å¹¶æ²¡æœ‰æä¾›ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å†…ç½®çš„æœåŠ¡ï¼Œå°†é…ç½®æ–‡ä»¶æ”¾åˆ°æŒ‡å®šçš„ç›®å½•ä¸‹é¢ï¼Œå°±å¯ä»¥åœ¨å¯åŠ¨çš„æ—¶å€™ä¸€å¹¶å°†è¯¥æœåŠ¡å¯åŠ¨æˆ–æ›¿æ¢é»˜è®¤ç»„ä»¶ã€‚ æ‰€æœ‰ K8S control-plane ç»„ä»¶éƒ½å°è£…åœ¨å•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶å’Œè¿›ç¨‹ä¸­ å› ä¸ºå°è£…åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥å¯åŠ¨çš„æ—¶å€™åªæœ‰ä¸€ä¸ªè¿›ç¨‹ã€‚å¥½å¤„åœ¨äºåªéœ€è¦ç®¡ç†è¿™ä¸ªå•ä¸€è¿›ç¨‹å°±å¯ä»¥äº†ï¼ŒåŒæ—¶ä¹Ÿå…·å¤‡æ“ä½œå¤æ‚é›†ç¾¤çš„èƒ½åŠ›ã€‚ æœ€å¤§ç¨‹åº¦å‡è½»äº†å¤–éƒ¨ä¾èµ–æ€§ å³ç¨æ–°ä¸€ç‚¹çš„ Linux å†…æ ¸å°±å¯ä»¥äº†(éœ€è¦ kernel å’Œ cgroup æŒ‚è½½)ã€‚ ä¹‹æ‰€ä»¥å«åš K3S æ˜¯å› ä¸ºå¸Œæœ›å®‰è£…çš„ K8S åœ¨å†…å­˜å ç”¨æ–¹é¢åªæ˜¯ä¸€åŠçš„å¤§å°ï¼Œè€Œä¸€åŠå¤§çš„ä¸œè¥¿å°±æ˜¯ä¸€ä¸ª 5 ä¸ªå­—æ¯çš„å•è¯ï¼Œç®€å†™ä¸º K3Sã€‚ ç”Ÿå‘½å‘¨æœŸ åŒæ—¶æ”¯æŒ 3 ä¸ª K8s ç‰ˆæœ¬ï¼Œæ”¯æŒçš„ç”Ÿå‘½å‘¨æœŸä¸ K8s ç›¸åŒ å¯ä»¥å‚è€ƒ: Kubernetes ç‰ˆæœ¬åŠç‰ˆæœ¬åå·®æ”¯æŒç­–ç•¥ è¿›è¡Œå­¦ä¹  æ›´æ–°å‘¨æœŸ å½“ K8s æ›´æ–°æ–°ç‰ˆæœ¬åï¼Œä¸€èˆ¬ K3s åœ¨ä¸€å‘¨å†…åŒæ­¥æ›´æ–° å¯ä»¥é€šè¿‡ è¿™ä¸ªé“¾æ¥ è·å– latest/stable/testing ç‰ˆæœ¬ æˆ‘ä»¬é»˜è®¤å®‰è£…çš„æ˜¯ stable ç‰ˆæœ¬ï¼Œå¯ä»¥è¿è¡Œé€šè¿‡å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ å‘½åè§„èŒƒ v1.20.4+k3s1: v1.20.4 ä¸º K8s ç‰ˆæœ¬ï¼Œk3s1 ä¸ºè¡¥ä¸ç‰ˆæœ¬ ","date":"2023-12-16","objectID":"/posts/2023-12-16-k3s/:1:0","tags":["k3s","k8s"],"title":"k3s","uri":"/posts/2023-12-16-k3s/"},{"categories":["DevOps"],"content":"äºŒã€å•æœºéƒ¨ç½² ","date":"2023-12-16","objectID":"/posts/2023-12-16-k3s/:2:0","tags":["k3s","k8s"],"title":"k3s","uri":"/posts/2023-12-16-k3s/"},{"categories":["DevOps"],"content":"1ã€åœ¨çº¿éƒ¨ç½² curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_SELINUX_WARN=false INSTALL_K3S_MIRROR=cn INSTALL_K3S_EXEC=\"--write-kubeconfig ~/.kube/config --write-kubeconfig-mode 644 \" sh - # tokenå­˜æ”¾åœ¨/var/lib/rancher/k3s/server/node-token # cat /var/lib/rancher/k3s/server/node-token curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn K3S_URL=https://172.16.1.164:6443 K3S_TOKEN=K105b756f7f9ce7b0d7f776405cc197e74fa5002701ac76dc63edd57dce8cd272ba::server:a61905854a82cc9280a3ac57ccd649d5 sh - ","date":"2023-12-16","objectID":"/posts/2023-12-16-k3s/:2:1","tags":["k3s","k8s"],"title":"k3s","uri":"/posts/2023-12-16-k3s/"},{"categories":["DevOps"],"content":"2ã€ç¦»çº¿éƒ¨ç½² 1ï¼‰ä¸‹è½½k3säºŒè¿›åˆ¶åŒ…ã€é•œåƒå’Œå®‰è£…è„šæœ¬ äºŒè¿›åˆ¶åŒ…ï¼šhttps://github.com/rancher/k3s/releases é•œåƒï¼šhttps://github.com/k3s-io/k3s/releases éƒ¨ç½²è„šæœ¬ï¼šhttps://github.com/k3s-io/k3s/blob/master/install.sh RHELç³»åˆ—éœ€è¦å®‰è£…selinuxï¼šhttps://github.com/k3s-io/k3s-selinux/releases ä¸€ä¸‹ä»¥ Rocky 9 arm64 ä¸ºç¤ºä¾‹ # download wget https://github.com/k3s-io/k3s/releases/download/v1.28.4%2Bk3s2/k3s-arm64 wget https://github.com/k3s-io/k3s-selinux/releases/download/v1.4.stable.1/k3s-selinux-1.4-1.el9.noarch.rpm wget https://github.com/k3s-io/k3s/releases/download/v1.28.4%2Bk3s2/k3s-airgap-images-arm64.tar.gz # wget https://get.k3s.io -o ./install.sh # wget http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh wget https://raw.githubusercontent.com/k3s-io/k3s/master/install.sh # set k3s cp ./k3s /usr/local/bin/ chmod 755 /usr/local/bin/k3s # set images gzip -d k3s-airgap-images-$ARCH.tar.gz mkdir -p /var/lib/rancher/k3s/agent/images/ cp ./k3s-airgap-images-$ARCH.tar /var/lib/rancher/k3s/agent/images/ # install selinux and set system yum -y localinstall k3s-selinux-.rpm systemctl stop firewalld systemctl disable firewalld setenforce 0 sed -ri '/^SELINUX=/cSELINUX=disabled' /etc/selinux/config # install k3s INSTALL_K3S_SKIP_DOWNLOAD=true INSTALL_K3S_MIRROR=cn INSTALL_K3S_SELINUX_WARN=true INSTALL_K3S_SKIP_SELINUX_RPM=true INSTALL_K3S_EXEC=\"--write-kubeconfig ~/.kube/config --write-kubeconfig-mode 644 --docker \" ./install.sh # å…¶ä»–èŠ‚ç‚¹åŠ å…¥ # tokenå­˜æ”¾åœ¨/var/lib/rancher/k3s/server/node-token # cat /var/lib/rancher/k3s/server/node-token INSTALL_K3S_SKIP_DOWNLOAD=true INSTALL_K3S_MIRROR=cn INSTALL_K3S_SELINUX_WARN=false K3S_URL=https://172.16.1.5:6443 K3S_TOKEN=K101e11731af882398bc6757080f0d8e4b46f8cdb2a17a2edfce54d7971cb3411d1::server:81ee583304cc2b38bf15190298403d34 ./install.sh ","date":"2023-12-16","objectID":"/posts/2023-12-16-k3s/:2:2","tags":["k3s","k8s"],"title":"k3s","uri":"/posts/2023-12-16-k3s/"},{"categories":["DevOps"],"content":"äºŒã€é«˜çº§é…ç½® ","date":"2023-12-16","objectID":"/posts/2023-12-16-k3s/:3:0","tags":["k3s","k8s"],"title":"k3s","uri":"/posts/2023-12-16-k3s/"},{"categories":["DevOps"],"content":"1ã€è®¾ç½®èŠ‚ç‚¹hostname é›†ç¾¤ä¸­ä¸èƒ½æœ‰å…±åŒçš„ä¸»æœºåï¼Œå¦‚æœhostnameæœ‰ç›¸åŒï¼Œåˆ™éœ€è¦åœ¨åŠ å…¥é›†ç¾¤æ—¶è®¾ç½®ä¸€ä¸‹ä¸»æœºå # ä¸ºæ¯ä¸ªèŠ‚ç‚¹æŒ‡å®šä¸»æœºå curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ K3S_NODE_NAME=\"k3s2\" INSTALL_K3S_MIRROR=cn \\ K3S_URL=https://192.168.64.3:6443 K3S_TOKEN=xxx sh - # ä¸ºæ¯ä¸ªèŠ‚ç‚¹æŒ‡å®šä¸»æœºå curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn K3S_URL=https://192.168.64.3:6443 \\ K3S_TOKEN=xxx sh -s - --node-name k3s2 ","date":"2023-12-16","objectID":"/posts/2023-12-16-k3s/:3:1","tags":["k3s","k8s"],"title":"k3s","uri":"/posts/2023-12-16-k3s/"},{"categories":["DevOps"],"content":"2ã€å¯ç”¨ç¯å¢ƒå˜é‡ Environment Variable Description INSTALL_K3S_SKIP_DOWNLOAD å¦‚æœè®¾ç½®ä¸º â€œtrue â€œå°†ä¸ä¼šä¸‹è½½ K3s çš„å“ˆå¸Œå€¼æˆ–äºŒè¿›åˆ¶ã€‚ INSTALL_K3S_SYMLINK é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœè·¯å¾„ä¸­ä¸å­˜åœ¨å‘½ä»¤ï¼Œå°†ä¸º kubectlã€crictl å’Œ ctr äºŒè¿›åˆ¶æ–‡ä»¶åˆ›å»ºç¬¦å·é“¾æ¥ã€‚å¦‚æœè®¾ç½®ä¸ºâ€™skipâ€™å°†ä¸ä¼šåˆ›å»ºç¬¦å·é“¾æ¥ï¼Œè€Œâ€™forceâ€™å°†è¦†ç›–ã€‚ INSTALL_K3S_SKIP_ENABLE å¦‚æœè®¾ç½®ä¸º â€œtrueâ€ï¼Œå°†ä¸å¯ç”¨æˆ–å¯åŠ¨ K3s æœåŠ¡ã€‚ INSTALL_K3S_SKIP_START å¦‚æœè®¾ç½®ä¸º â€œtrue â€œå°†ä¸ä¼šå¯åŠ¨ K3s æœåŠ¡ã€‚ INSTALL_K3S_VERSION ä» Github ä¸‹è½½ K3s çš„ç‰ˆæœ¬ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œå°†å°è¯•ä»\"stable\"é¢‘é“ä¸‹è½½ã€‚ INSTALL_K3S_BIN_DIR å®‰è£… K3s äºŒè¿›åˆ¶æ–‡ä»¶ã€é“¾æ¥å’Œå¸è½½è„šæœ¬çš„ç›®å½•ï¼Œæˆ–è€…ä½¿ç”¨/usr/local/binä½œä¸ºé»˜è®¤ç›®å½•ã€‚ INSTALL_K3S_BIN_DIR_READ_ONLY å¦‚æœè®¾ç½®ä¸º true å°†ä¸ä¼šæŠŠæ–‡ä»¶å†™å…¥INSTALL_K3S_BIN_DIRï¼Œå¼ºåˆ¶è®¾ç½®INSTALL_K3S_SKIP_DOWNLOAD=trueã€‚ INSTALL_K3S_SYSTEMD_DIR å®‰è£… systemd æœåŠ¡å’Œç¯å¢ƒæ–‡ä»¶çš„ç›®å½•ï¼Œæˆ–è€…ä½¿ç”¨/etc/systemd/systemä½œä¸ºé»˜è®¤ç›®å½•ã€‚ INSTALL_K3S_EXEC å¸¦æœ‰æ ‡å¿—çš„å‘½ä»¤ï¼Œç”¨äºåœ¨æœåŠ¡ä¸­å¯åŠ¨ K3sã€‚å¦‚æœæœªæŒ‡å®šå‘½ä»¤ï¼Œå¹¶ä¸”è®¾ç½®äº†K3S_URLï¼Œå®ƒå°†é»˜è®¤ä¸ºâ€œagentâ€ã€‚å¦‚æœæœªè®¾ç½®K3S_URLï¼Œå®ƒå°†é»˜è®¤ä¸ºâ€œserverâ€ã€‚è¦è·å¾—å¸®åŠ©ï¼Œè¯·å‚è€ƒæ­¤ç¤ºä¾‹ã€‚ INSTALL_K3S_NAME è¦åˆ›å»ºçš„ systemd æœåŠ¡åç§°ï¼Œå¦‚æœä»¥æœåŠ¡å™¨æ–¹å¼è¿è¡Œ k3sï¼Œåˆ™é»˜è®¤ä¸ºâ€™k3sâ€™ï¼›å¦‚æœä»¥ agent æ–¹å¼è¿è¡Œ k3sï¼Œåˆ™é»˜è®¤ä¸ºâ€™k3s-agentâ€™ã€‚å¦‚æœæŒ‡å®šäº†æœåŠ¡åï¼Œåˆ™æœåŠ¡åå°†ä»¥â€™k3s-â€˜ä¸ºå‰ç¼€ã€‚ INSTALL_K3S_TYPE è¦åˆ›å»ºçš„ systemd æœåŠ¡ç±»å‹ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œå°†é»˜è®¤ä½¿ç”¨ K3s exec å‘½ä»¤ã€‚ INSTALL_K3S_SELINUX_WARN å¦‚æœè®¾ç½®ä¸º trueï¼Œåˆ™åœ¨æ²¡æœ‰æ‰¾åˆ° k3s-selinux ç­–ç•¥çš„æƒ…å†µä¸‹å°†ç»§ç»­ã€‚ INSTALL_K3S_SKIP_SELINUX_RPM å¦‚æœè®¾ç½®ä¸º â€œtrue â€œå°†è·³è¿‡ k3s RPM çš„è‡ªåŠ¨å®‰è£…ã€‚ INSTALL_K3S_CHANNEL_URL ç”¨äºè·å– K3s ä¸‹è½½ç½‘å€çš„é¢‘é“ URLã€‚é»˜è®¤ä¸º https://update.k3s.io/v1-release/channels ã€‚ INSTALL_K3S_CHANNEL ç”¨äºè·å– K3s ä¸‹è½½ URL çš„é€šé“ã€‚é»˜è®¤å€¼ä¸º â€œstableâ€ã€‚é€‰é¡¹åŒ…æ‹¬ï¼šstable, latest, testingã€‚ K3S_CONFIG_FILE æŒ‡å®šé…ç½®æ–‡ä»¶çš„ä½ç½®ã€‚é»˜è®¤ç›®å½•ä¸º/etc/rancher/k3s/config.yamlã€‚ K3S_TOKEN ç”¨äºå°† server æˆ– agent åŠ å…¥é›†ç¾¤çš„å…±äº« secretã€‚ K3S_TOKEN_FILE æŒ‡å®š cluster-secret,token çš„æ–‡ä»¶ç›®å½•ã€‚ ","date":"2023-12-16","objectID":"/posts/2023-12-16-k3s/:3:2","tags":["k3s","k8s"],"title":"k3s","uri":"/posts/2023-12-16-k3s/"},{"categories":["DevOps"],"content":"3ã€k3så®‰è£…å‚æ•°è®¾ç½® # ä½¿ç”¨dockerä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ $ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn \\ INSTALL_K3S_EXEC=\"--docker\" sh - # æŒ‡å®šè¿è¡Œæ—¶å·¥å…· $ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn \\ INSTALL_K3S_EXEC=\"--container-runtime-endpoint containerd\" \\ sh - # è®¾ç½®ç§æœ‰é•œåƒä»“åº“é…ç½®æ–‡ä»¶ # é»˜è®¤é…ç½®æ–‡ä»¶: /etc/rancher/k3s/registries.yaml $ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn \\ INSTALL_K3S_EXEC=\"--private-registry xxx\" \\ sh - # é’ˆå¯¹å¤šç½‘å¡ä¸»æœºå®‰è£…K3sé›†ç¾¤ # é»˜è®¤å¤šç½‘å¡ä¼šä½¿ç”¨é»˜è®¤ç½‘å…³çš„é‚£ä¸ªå¡ $ rout -n # K3s server $ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn \\ INSTALL_K3S_EXEC=\"--node-ip=192.168.100.100\" \\ sh - # K3s agent $ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn \\ K3S_URL=https://192.168.99.211:6443 K3S_TOKEN=xxx \\ INSTALL_K3S_EXEC=\"--node-ip=192.168.100.100\" \\ sh - # --tls-san # åœ¨TLSè¯ä¹¦ä¸­æ·»åŠ å…¶ä»–ä¸»æœºåæˆ–IPä½œä¸ºä¸»æœºå¤‡ç”¨åç§° # å³åœ¨å…¬ç½‘ç¯å¢ƒä¸‹å…è®¸é€šè¿‡å…¬ç½‘IPè®¿é—®æ§åˆ¶ã€æ“ä½œè¿œç¨‹é›†ç¾¤ # æˆ–è€…éƒ¨ç½²å¤šä¸ªServerå¹¶ä½¿ç”¨LBè¿›è¡Œè´Ÿè´£ï¼Œå°±éœ€è¦ä¿ç•™å…¬ç½‘åœ°å€ $ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn \\ INSTALL_K3S_EXEC=\"--tls-san 1.1.1.1\" \\ sh - # è·å–é…ç½® $ kubectl get secret k3s-serving -n kube-system -o yaml # ç„¶åæœ¬æœºå¤åˆ¶å…¬ç½‘ä¸»èŠ‚ç‚¹å¯¹åº”çš„yamlæ–‡ä»¶å³å¯æœ¬åœ°æ“ä½œäº† $ scp ci@1.1.1.1:/etc/rancher/k3s/k3s.yaml ~/.kube/config # ä¿®æ”¹å¯åŠ¨çš„æœåŠ¡å¯¹åº”é…ç½®(è°ƒæ•´èŠ‚ç‚¹çš„å¯åŠ¨çš„æœ€å¤§Podæ•°é‡) $ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn \\ INSTALL_K3S_EXEC='--kubelet-arg=max-pods=200' \\ sh - # ä¿®æ”¹å¯åŠ¨çš„æœåŠ¡å¯¹åº”é…ç½®(ä½¿ç”¨ipvsä½œä¸ºæœåŠ¡è°ƒåº¦å·¥å…·) $ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn \\ INSTALL_K3S_EXEC='--kube-proxy-arg=proxy-mode=ipvs' \\ sh - # ä¿®æ”¹å¯åŠ¨çš„æœåŠ¡å¯¹åº”é…ç½®(è°ƒæ•´æœåŠ¡å¯åŠ¨çš„ç«¯å£èŒƒå›´) $ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn \\ INSTALL_K3S_EXEC='--kube-apiserver-arg=service-node-port-range=40000-50000' \\ sh - # kubelet-arg --kubelet-arg # kube-apiserver --kube-apiserver-arg # kube-proxy-arg --kube-proxy-arg # kube-proxy-arg --kube-proxy-arg=proxy-mode=ipvs # --data-dir # ä¿®æ”¹K3sæ•°æ®å­˜å‚¨ç›®å½• $ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn \\ INSTALL_K3S_EXEC='--data-dir=/opt/k3s-data' \\ sh - # ç¦ç”¨ç»„ä»¶ $ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn \\ INSTALL_K3S_EXEC='--disable traefik' \\ sh - # è‡ªå·±åŠ è‡ªå·±éœ€è¦çš„æœåŠ¡ $ ls /var/lib/rancher/k3s/server/manifests $ kubectl get pods -A | grep traefik # æ·»åŠ labelå’Œtaintæ ‡è¯† $ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn \\ INSTALL_K3S_EXEC='--node-label foo=bar,hello=world \\ --node-taint key1=value1:NoExecute' sh - # æŸ¥çœ‹ä¸€ä¸‹ $ kubectl describe nodes K3s Server/Agent - æ•°æ®åº“é€‰é¡¹ # æŒ‡å®šæ•°æ®æºåç§° # æ ‡å¿—ä½: --datastore-endpoint\u0026nbsp;value # ç¯å¢ƒå˜é‡: K3S_DATASTORE_ENDPOINT $ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn \\ INSTALL_K3S_EXEC='--datastore-endpoint\u0026nbsp;etcd' \\ sh - # cronè§„èŒƒä¸­çš„å¿«ç…§é—´éš”æ—¶é—´ # --etcd-snapshot-schedule-cron\u0026nbsp;value $ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn \\ INSTALL_K3S_EXEC='--etcd-snapshot-schedule-cron *\u0026nbsp;*/5\u0026nbsp;*\u0026nbsp;*\u0026nbsp;*' \\ sh - ","date":"2023-12-16","objectID":"/posts/2023-12-16-k3s/:3:3","tags":["k3s","k8s"],"title":"k3s","uri":"/posts/2023-12-16-k3s/"},{"categories":["DevOps"],"content":"4ã€ç½‘ç»œé€‰é¡¹é…ç½® é»˜è®¤æƒ…å†µä¸‹ï¼ŒK3s å°†ä»¥ flannel ä½œä¸º CNI è¿è¡Œï¼Œä½¿ç”¨ VXLAN ä½œä¸ºé»˜è®¤åç«¯ï¼ŒCNI å’Œé»˜è®¤åç«¯éƒ½å¯ä»¥é€šè¿‡å‚æ•°ä¿®æ”¹ã€‚è¦å¯ç”¨åŠ å¯†ï¼Œè¯·ä½¿ç”¨ä¸‹é¢çš„ IPSec æˆ– WireGuard é€‰é¡¹ã€‚ # é»˜è®¤å®‰è£…K3sä¹‹åçš„ç½‘ç»œé…ç½® $ sudo cat /var/lib/rancher/k3s/agent/etc/flannel/net-conf.json { \"Network\": \"10.42.0.0/16\", \"EnableIPv6\": false, \"EnableIPv4\": true, \"IPv6Network\": \"::/0\", \"Backend\": { \"Type\": \"vxlan\" } } CLI Flag å’Œ Value æè¿° --flannel-backend=vxlan ä½¿ç”¨ VXLAN åç«¯(é»˜è®¤) --flannel-backend=host-gw ä½¿ç”¨ host-gw åç«¯ --flannel-backend=ipsec ä½¿ç”¨ IPSEC åç«¯ï¼›å¯¹ç½‘ç»œæµé‡è¿›è¡ŒåŠ å¯† --flannel-backend=wireguard ä½¿ç”¨ WireGuard åç«¯ï¼›å¯¹ç½‘ç»œæµé‡è¿›è¡ŒåŠ å¯† 1ï¼‰é…ç½® Flannel é€‰é¡¹ è¿™æ ·ï¼Œæˆ‘å°±å¯ä»¥åœ¨å®‰è£… K3s æˆ–è€…ä¹‹åä¿®æ”¹å¯¹åº”é…ç½®æ–‡ä»¶ï¼Œæ¥ä¿®æ”¹ Flannel é»˜è®¤çš„åç«¯ç½‘ç»œé…ç½®é€‰é¡¹(é‡å¯ä¼šè¦†ç›–ä¸ç”Ÿæ•ˆ)äº†ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æ¼”ç¤ºä¸‹ï¼Œå¦‚ä½•ä¿®æ”¹ä¸º host-gw æ¨¡å¼ã€‚ # ä¸»èŠ‚ç‚¹ # flannel-backendä½¿ç”¨host-gw # è¯¥æ¨¡å¼ä¼šæŠŠå¯¹ç«¯ä¸»æœºçš„IPå½“åšé»˜è®¤ç½‘ç®¡(å¤šServeræƒ…å†µ) $ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn \\ INSTALL_K3S_EXEC='--flannel-backend=host-gw' \\ sh - # å·¥ä½œèŠ‚ç‚¹ $ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn K3S_URL=https://192.168.100.100:6443 \\ K3S_TOKEN=xxx sh - # é»˜è®¤çš„è·¯ç”±ä¿¡æ¯ $ route -n 0.0.0.0 172.16.64.1 0.0.0.0 UG 100 0 0 enp0s2 10.42.1.0 172.16.64.9 255.255.255.0 UG 0 0 0 enp0s2 # æŸ¥çœ‹é…ç½®ä¹‹åçš„ç½‘ç»œé…ç½® $ sudo cat /var/lib/rancher/k3s/agent/etc/flannel/net-conf.json { \"Network\": \"10.42.0.0/16\", \"Backend\": { \"Type\": \"host-gw\" } } ","date":"2023-12-16","objectID":"/posts/2023-12-16-k3s/:3:4","tags":["k3s","k8s"],"title":"k3s","uri":"/posts/2023-12-16-k3s/"},{"categories":["DevOps"],"content":"5ã€é•œåƒä»“åº“è®¾ç½® K3s é»˜è®¤ä½¿ç”¨ containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œæ‰€ä»¥åœ¨ docker ä¸Šé…ç½®é•œåƒä»“åº“æ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚K3s é•œåƒä»“åº“é…ç½®æ–‡ä»¶ç”±ä¸¤å¤§éƒ¨åˆ†ç»„æˆï¼šmirrors å’Œ configsã€‚ Mirrors æ˜¯ä¸€ä¸ªç”¨äºå®šä¹‰ä¸“ç”¨é•œåƒä»“åº“çš„åç§°å’Œ endpoint çš„æŒ‡ä»¤ Configs éƒ¨åˆ†å®šä¹‰äº†æ¯ä¸ª mirror çš„ TLS å’Œè¯ä¹¦é…ç½® å¯¹äºæ¯ä¸ª mirrorï¼Œä½ å¯ä»¥å®šä¹‰ auth å’Œ / æˆ– tls K3s registry é…ç½®ç›®å½•ä¸ºï¼š /etc/rancher/k3s/registries.yamlã€‚K3s å¯åŠ¨æ—¶ä¼šæ£€æŸ¥ /etc/rancher/k3s/ ä¸­æ˜¯å¦å­˜åœ¨ registries.yaml æ–‡ä»¶ï¼Œå¹¶æŒ‡ç¤º containerd ä½¿ç”¨æ–‡ä»¶ä¸­å®šä¹‰çš„é•œåƒä»“åº“ã€‚å¦‚æœä½ æƒ³ä½¿ç”¨ä¸€ä¸ªç§æœ‰çš„é•œåƒä»“åº“ï¼Œé‚£ä¹ˆä½ éœ€è¦åœ¨æ¯ä¸ªä½¿ç”¨é•œåƒä»“åº“çš„èŠ‚ç‚¹ä¸Šä»¥ root èº«ä»½åˆ›å»ºè¿™ä¸ªæ–‡ä»¶ã€‚ è¯·æ³¨æ„ï¼Œserver èŠ‚ç‚¹é»˜è®¤æ˜¯å¯ä»¥è°ƒåº¦çš„ã€‚å¦‚æœä½ æ²¡æœ‰åœ¨ server èŠ‚ç‚¹ä¸Šè®¾ç½®æ±¡ç‚¹ï¼Œé‚£ä¹ˆå°†åœ¨å®ƒä»¬ä¸Šè¿è¡Œå·¥ä½œè´Ÿè½½ï¼Œè¯·ç¡®ä¿åœ¨æ¯ä¸ª server èŠ‚ç‚¹ä¸Šåˆ›å»º registries.yaml æ–‡ä»¶ã€‚ containerd ä½¿ç”¨äº†ç±»ä¼¼ K8S ä¸­ svc ä¸ endpoint çš„æ¦‚å¿µï¼Œsvc å¯ä»¥ç†è§£ä¸ºè®¿é—®åç§°ï¼Œè¿™ä¸ªåç§°ä¼šè§£æåˆ°å¯¹åº”çš„ endpoint ä¸Šã€‚ä¹Ÿå¯ä»¥ç†è§£ mirror é…ç½®å°±æ˜¯ä¸€ä¸ªåå‘ä»£ç†ï¼Œå®ƒæŠŠå®¢æˆ·ç«¯çš„è¯·æ±‚ä»£ç†åˆ° endpoint é…ç½®çš„åç«¯é•œåƒä»“åº“ã€‚mirror åç§°å¯ä»¥éšæ„å¡«å†™ï¼Œä½†æ˜¯å¿…é¡»ç¬¦åˆ IP æˆ–åŸŸåçš„å®šä¹‰è§„åˆ™ã€‚å¹¶ä¸”å¯ä»¥é…ç½®å¤šä¸ª endpointï¼Œé»˜è®¤è§£æåˆ°ç¬¬ä¸€ä¸ª endpointï¼Œå¦‚æœç¬¬ä¸€ä¸ª endpoint æ²¡æœ‰è¿”å›æ•°æ®ï¼Œåˆ™è‡ªåŠ¨åˆ‡æ¢åˆ°ç¬¬äºŒä¸ª endpointï¼Œä»¥æ­¤ç±»æ¨ã€‚ # /etc/rancher/k3s/registries.yaml # åŒæ—¶å¯ä»¥è®¾ç½®å¤šä¸ªmirrorsåœ°å€ # å¯ä»¥å¯¹mirrorsè®¾ç½®æƒé™å’Œè¯ä¹¦ mirrors: \"172.31.6.200:5000\": endpoint: - \"http://172.31.6.200:5000\" - \"http://x.x.x.x:5000\" - \"http://y.y.y.y:5000\" \"rancher.ksd.top:5000\": endpoint: - \"http://172.31.6.200:5000\" \"docker.io\": endpoint: - \"https://fogjl973.mirror.aliyuncs.com\" - \"https://registry-1.docker.io\" configs: \"172.31.6.200:5000\": auth: username: admin password: Harbor@12345 tls: cert_file: /home/ubuntu/harbor2.escapelife.site.cert key_file: /home/ubuntu/harbor2.escapelife.site.key ca_file: /home/ubuntu/ca.crt # é•œåƒéƒ½æ˜¯ä»åŒä¸€ä¸ªä»“åº“è·å–åˆ°çš„ $ sudo systemctl restart k3s.service $ sudo crictl pull 172.31.6.200:5000/library/alpine $ sudo crictl pull rancher.ksd.top:5000/library/alpine è¿™é‡Œæˆ‘ä»¬ä»‹ç»ä¸‹ï¼Œå¦‚ä½•ä½¿ç”¨ TLS é…ç½®ã€‚ # è¯ä¹¦é¢å‘æœºæ„é¢å‘çš„è¯ä¹¦ $ cat \u003e\u003e /etc/rancher/k3s/registries.yaml \u003c\u003cEOF mirrors: \"harbor.escapelife.site\": endpoint: - \"https://harbor.escapelife.site\" configs: \"harbor.escapelife.site\": auth: username: admin password: Harbor@12345 EOF $ sudo systemctl restart k3s # è‡ªç­¾åè¯ä¹¦ $ cat \u003e\u003e /etc/rancher/k3s/registries.yaml \u003c\u003cEOF mirrors: \"harbor2.escapelife.site\": endpoint: - \"https://harbor2.escapelife.site\" configs: \"harbor2.escapelife.site\": auth: username: admin password: Harbor@12345 tls: cert_file: /home/ubuntu/harbor2.escapelife.site.cert key_file: /home/ubuntu/harbor2.escapelife.site.key ca_file: /home/ubuntu/ca.crt EOF $ sudo systemctl restart k3s # ä¸ä½¿ç”¨TLSè¯ä¹¦ $ cat \u003e\u003e /etc/rancher/k3s/registries.yaml \u003c\u003cEOF mirrors: \"docker.io\": endpoint: - \"https://fogjl973.mirror.aliyuncs.com\" - \"https://registry-1.docker.io\" EOF $ sudo systemctl restart k3s K3s å°†ä¼šåœ¨ /var/lib/rancher/k3s/agent/etc/containerd/config.toml ä¸­ä¸º containerd ç”Ÿæˆ config.tomlã€‚å¦‚æœè¦å¯¹è¿™ä¸ªæ–‡ä»¶è¿›è¡Œé«˜çº§è®¾ç½®ï¼Œä½ å¯ä»¥åœ¨åŒä¸€ç›®å½•ä¸­åˆ›å»ºå¦ä¸€ä¸ªåä¸º config.toml.tmpl çš„æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶å°†ä¼šä»£æ›¿é»˜è®¤è®¾ç½®ã€‚ # å¯ç”¨ç¤ºä¾‹ # mkdir -p /etc/rancher/k3s cat \u003e /etc/rancher/k3s/registries.yaml \u003c\u003cEOF mirrors: docker.io: endpoint: - \"https://docker.mirrors.sjtug.sjtu.edu.cn\" - \"https://docker.nju.edu.cn\" quay.io: endpoint: - \"https://quay.nju.edu.cn\" gcr.io: endpoint: - \"https://gcr.nju.edu.cn\" ghcr.io: endpoint: - \"https://ghcr.nju.edu.cn\" nvcr.io: endpoint: - \"https://ngc.nju.edu.cn\" EOF systemctl restart k3s # å®Œæ•´ç¤ºä¾‹ $ cat \u003e\u003e /etc/rancher/k3s/registries.yaml mirrors: \"harbor.escapelife.site\": endpoint: - \"https://harbor.escapelife.site\" \"harbor2.escapelife.site\": endpoint: - \"https://harbor2.escapelife.site\" \"172.31.19.227:5000\": endpoint: - \"http://172.31.19.227:5000\" \"docker.io\": endpoint: - \"https://fogjl973.mirror.aliyuncs.com\" - \"https://registry-1.docker.io\" configs: \"harbor.escapelife.site\": auth: username: admin password: Harbor@12345 \"harbor2.escapelife.site\": auth: username: admin password: Harbor@12345 tls: cert_file: /home/ubuntu/harbor2.escapelife.site.cert key_file: /home/ubuntu/harbor2.escapelife.site.key ca_file: /home/ubuntu/ca.crt ","date":"2023-12-16","objectID":"/posts/2023-12-16-k3s/:3:5","tags":["k3s","k8s"],"title":"k3s","uri":"/posts/2023-12-16-k3s/"},{"categories":["DevOps"],"content":"6ã€è¯ä¹¦ç®¡ç† å‚è€ƒé“¾æ¥ï¼šhttps://blog.starudream.cn/2023/07/21/k3s-client-cert-extend/ é»˜è®¤æƒ…å†µä¸‹ï¼ŒK3s çš„è¯ä¹¦åœ¨ 12 ä¸ªæœˆå†…è¿‡æœŸã€‚å¦‚æœè¯ä¹¦å·²ç»è¿‡æœŸæˆ–å‰©ä½™çš„æ—¶é—´ä¸è¶³ 90 å¤©ï¼Œåˆ™åœ¨ K3s é‡å¯æ—¶è½®æ¢è¯ä¹¦ã€‚ # æŸ¥è¯¢K3sè¯ä¹¦è¿‡æœŸæ—¶é—´ $ for i in `ls /var/lib/rancher/k3s/server/tls/*.crt`; \\ do \\ echo $i;\\ openssl x509 -enddate -noout -in $i; \\ done # ä¿®æ”¹ç³»ç»Ÿæ—¶é—´ä¸ºè¯ä¹¦è¿‡æœŸå‰90å¤©æˆ–è¯ä¹¦è¿‡æœŸå $ timedatectl set-ntp no $ date -s 20220807 # é‡å¯K3sæœåŠ¡ $ service k3s restart k3s é»˜è®¤çš„æ ¹è¯ä¹¦ç­¾å‘ åå¹´ï¼Œå®¢æˆ·ç«¯è¯ä¹¦ç­¾å‘ ä¸€å¹´ã€‚ ç»å¸¸éœ€è¦é‡æ–°ç­¾å‘å®¢æˆ·ç«¯è¯ä¹¦ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ k3s çš„ç¯å¢ƒå˜é‡æ¥å»¶é•¿å®¢æˆ·ç«¯è¯ä¹¦çš„æœ‰æ•ˆæœŸã€‚ æ–°å¢ /etc/default/k3s æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š CATTLE_NEW_SIGNED_CERT_EXPIRATION_DAYS=\"3650\" è¯¥å˜é‡åœ¨ k3s server é‡æ–°ç­¾å‘è¯ä¹¦æ—¶æœ‰æ•ˆï¼Œæˆ–è€…åœ¨å®‰è£…ä¹‹å‰è®¾ç½®ã€‚ # è½®æ¢è¯ä¹¦ k3s certificate rotate # å¯åŠ¨ K3s systemctl start k3s ","date":"2023-12-16","objectID":"/posts/2023-12-16-k3s/:3:6","tags":["k3s","k8s"],"title":"k3s","uri":"/posts/2023-12-16-k3s/"},{"categories":["DevOps"],"content":"ä¸‰ã€å¤šmasteré«˜å¯ç”¨ç”Ÿäº§çº§åˆ«éƒ¨ç½²â€”åœ¨çº¿ç‰ˆ https://kube-vip.io/docs/usage/k3s/ https://zhuanlan.zhihu.com/p/651292552 HA + kube-vip ","date":"2023-12-16","objectID":"/posts/2023-12-16-k3s/:4:0","tags":["k3s","k8s"],"title":"k3s","uri":"/posts/2023-12-16-k3s/"},{"categories":["DevOps"],"content":"1ã€é…ç½®å†…æ ¸å‚æ•° [root@k8s-m1 ~]# cat \u003c\u003cEOF \u003e /etc/sysctl.d/k8s.conf # https://github.com/moby/moby/issues/31208 # ipvsadm -l --timout # ä¿®å¤ipvsæ¨¡å¼ä¸‹é•¿è¿æ¥timeouté—®é¢˜ å°äº900å³å¯ net.ipv4.tcp_keepalive_time = 600 net.ipv4.tcp_keepalive_intvl = 30 net.ipv4.tcp_keepalive_probes = 10 net.ipv6.conf.all.disable_ipv6 = 1 net.ipv6.conf.default.disable_ipv6 = 1 net.ipv6.conf.lo.disable_ipv6 = 1 net.ipv4.neigh.default.gc_stale_time = 120 net.ipv4.conf.all.rp_filter = 0 net.ipv4.conf.default.rp_filter = 0 net.ipv4.conf.default.arp_announce = 2 net.ipv4.conf.lo.arp_announce = 2 net.ipv4.conf.all.arp_announce = 2 net.ipv4.ip_forward = 1 net.ipv4.tcp_max_tw_buckets = 5000 net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_max_syn_backlog = 1024 net.ipv4.tcp_synack_retries = 2 # è¦æ±‚iptablesä¸å¯¹bridgeçš„æ•°æ®è¿›è¡Œå¤„ç† net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 net.bridge.bridge-nf-call-arptables = 1 net.netfilter.nf_conntrack_max = 2310720 fs.inotify.max_user_watches=89100 fs.may_detach_mounts = 1 fs.file-max = 52706963 fs.nr_open = 52706963 vm.swappiness = 0 vm.overcommit_memory=1 vm.panic_on_oom=0 EOF åŠ è½½å†…æ ¸å‚æ•° [root@k8s-m1 ~]# sysctl -p ipvsé…ç½® [root@k8s-m1 ~]# yum install ipset ipvsadm -y [root@k8s-m1 ~]# cat \u003e/etc/modules-load.d/ipvs.conf\u003c\u003cEOF ip_vs # è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•-æœ€å°‘è¿æ¥ ip_vs_lc # è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•-åŠ æƒæœ€å°‘è¿æ¥ ip_vs_wlc # è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•-è½®è¯¢ ip_vs_rr # è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•-åŠ æƒè½®è¯¢ ip_vs_wrr # æºåœ°å€æ•£åˆ—è°ƒåº¦ç®—æ³• ip_vs_sh nf_conntrack br_netfilter EOF [root@k8s-m1 ~]# systemctl restart systemd-modules-load.service æŸ¥çœ‹åŠ è½½æƒ…å†µ [root@k8s-m1 ~]# lsmod | grep -e ip_vs -e nf_conntrack -e br_netfilter systemctl stop firewalld systemctl disable firewalld setenforce 0 sed -ri '/^SELINUX=/cSELINUX=disabled' /etc/selinux/config æ¢æº sed -e 's|^mirrorlist=|#mirrorlist=|g' \\ -e 's|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.ustc.edu.cn/rocky|g' \\ -i.bak \\ /etc/yum.repos.d/rocky-extras.repo \\ /etc/yum.repos.d/rocky.repo è‡ªç­¾åca [å¯é€‰] mkdir -p /var/lib/rancher/k3s/server/tls cd /var/lib/rancher/k3s/server/tls openssl genrsa -out client-ca.key 2048 openssl genrsa -out server-ca.key 2048 openssl genrsa -out request-header-ca.key 2048 openssl req -x509 -new -nodes -key client-ca.key -sha256 -days 3650 -out client-ca.crt -addext keyUsage=critical,digitalSignature,keyEncipherment,keyCertSign -subj '/CN=k3s-client-ca' openssl req -x509 -new -nodes -key server-ca.key -sha256 -days 3650 -out server-ca.crt -addext keyUsage=critical,digitalSignature,keyEncipherment,keyCertSign -subj '/CN=k3s-server-ca' openssl req -x509 -new -nodes -key request-header-ca.key -sha256 -days 3650 -out request-header-ca.crt -addext keyUsage=critical,digitalSignature,keyEncipherment,keyCertSign -subj '/CN=k3s-request-header-ca' è®¾ç½®k3sç»­ç­¾çš„è¯ä¹¦æœ‰æ•ˆæœŸ echo \"CATTLE_NEW_SIGNED_CERT_EXPIRATION_DAYS=3650\" \u003e /etc/default/k3s # æˆ–è€… #echo \"CATTLE_NEW_SIGNED_CERT_EXPIRATION_DAYS=3650\" \u003e /etc/sysconfig/k3s ","date":"2023-12-16","objectID":"/posts/2023-12-16-k3s/:4:1","tags":["k3s","k8s"],"title":"k3s","uri":"/posts/2023-12-16-k3s/"},{"categories":["DevOps"],"content":"2ã€å®‰è£…kube-vip æ“ä½œè¿‡ç¨‹ï¼šé¦–å…ˆç”Ÿæˆä¸€ä¸ªç”¨äºéƒ¨ç½²åœ¨ K3s é›†ç¾¤ä¸­çš„ kube-vip Manifestï¼Œç„¶åå†å¯åŠ¨ä¸€ä¸ªé«˜å¯ç”¨çš„ K3s é›†ç¾¤ï¼Œå¯åŠ¨ K3s é›†ç¾¤æ—¶ä¼šè‡ªåŠ¨éƒ¨ç½² kube-vip çš„ Manifest æ–‡ä»¶ï¼Œä»è€Œé€šè¿‡ kube-vip å®ç°æ§åˆ¶å¹³é¢çš„é«˜å¯ç”¨ã€‚ # åˆ›å»ºmanifestsç›®å½• mkdir -p /var/lib/rancher/k3s/server/manifests/ # è·å– kube-vip RBAC æ¸…å• # kube-vip åœ¨ K3s ä¸‹ä½œä¸º DaemonSet è¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦ RBAC èµ„æºæ¥ç¡®ä¿ ServiceAccount å­˜åœ¨å¹¶è¿›è¡Œç»‘å®šï¼Œæ¥ç¡®ä¿å®ƒå…·æœ‰ä¸ API æœåŠ¡å™¨é€šä¿¡æ‰€éœ€çš„æƒé™ã€‚ curl https://kube-vip.io/manifests/rbac.yaml \u003e /var/lib/rancher/k3s/server/manifests/kube-vip-rbac.yaml ç”Ÿæˆkube-vip DaemonSet Manifest export VIP=172.16.1.222 # è®¾ç½®è™šæ‹Ÿ IP ç”¨äºè®¿é—®æ§åˆ¶å¹³é¢çš„åœ°å€ export INTERFACE=ens160 # è®¾ç½®æ§åˆ¶å¹³é¢æ‰€åœ¨ä¸»æœºçš„ç½‘å¡åç§° KVVERSION=$(curl -sL https://api.github.com/repos/kube-vip/kube-vip/releases | jq -r \".[0].name\") # è·å– kube-vip ç‰ˆæœ¬ alias kube-vip=\"docker run --network host --rm ghcr.io/kube-vip/kube-vip:$KVVERSION\" # é’ˆå¯¹ docker ç¯å¢ƒè®¾ç½®åˆ«å # åˆ›å»º kube-vip æ¸…å• kube-vip manifest daemonset \\ --interface $INTERFACE \\ --address $VIP \\ --inCluster \\ --taint \\ --controlplane \\ --services \\ --arp \\ --leaderElection \u003e /var/lib/rancher/k3s/server/manifests/kube-vip.yaml æ–‡ä»¶å†…å®¹ apiVersion: v1 kind: ServiceAccount metadata: name: kube-vip namespace: kube-system --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: annotations: rbac.authorization.kubernetes.io/autoupdate: \"true\" name: system:kube-vip-role rules: - apiGroups: [\"\"] resources: [\"services\", \"services/status\", \"nodes\", \"endpoints\"] verbs: [\"list\",\"get\",\"watch\", \"update\"] - apiGroups: [\"coordination.k8s.io\"] resources: [\"leases\"] verbs: [\"list\", \"get\", \"watch\", \"update\", \"create\"] --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: system:kube-vip-binding roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:kube-vip-role subjects: - kind: ServiceAccount name: kube-vip namespace: kube-system --- apiVersion: apps/v1 kind: DaemonSet metadata: creationTimestamp: null name: kube-vip-ds namespace: kube-system spec: selector: matchLabels: name: kube-vip-ds template: metadata: creationTimestamp: null labels: name: kube-vip-ds spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: node-role.kubernetes.io/master operator: Exists - matchExpressions: - key: node-role.kubernetes.io/control-plane operator: Exists containers: - args: - manager env: - name: vip_arp value: \"true\" - name: port value: \"6443\" - name: vip_interface value: ens160 - name: vip_cidr value: \"32\" - name: cp_enable value: \"true\" - name: cp_namespace value: kube-system - name: vip_ddns value: \"false\" - name: svc_enable value: \"true\" - name: vip_leaderelection value: \"true\" - name: vip_leaseduration value: \"5\" - name: vip_renewdeadline value: \"3\" - name: vip_retryperiod value: \"1\" - name: address value: 172.16.1.222 # image: ghcr.io/kube-vip/kube-vip:v0.6.0 image: ghcr.nju.edu.cn/kube-vip/kube-vip:v0.6.0 imagePullPolicy: Always name: kube-vip resources: {} securityContext: capabilities: add: - NET_ADMIN - NET_RAW - SYS_TIME hostNetwork: true serviceAccountName: kube-vip tolerations: - effect: NoSchedule operator: Exists - effect: NoExecute operator: Exists updateStrategy: {} status: currentNumberScheduled: 0 desiredNumberScheduled: 0 numberMisscheduled: 0 numberReady: 0 3ã€å®‰è£…HA K3sé›†ç¾¤ K3s æ”¯æŒå¤šç§ HA å®‰è£…æ–¹å¼ï¼Œæœ¬æ¬¡ç¤ºä¾‹é‡‡ç”¨åµŒå…¥å¼ ETCD çš„æ–¹å¼æ­å»ºé«˜å¯ç”¨çš„ K3s é›†ç¾¤ï¼Œè¿™æ ·é›†ç¾¤ä¸­å°±å­˜åœ¨äº† 3 ä¸ªæ§åˆ¶å¹³é¢ï¼Œç„¶åé€šè¿‡ kube-vip å®ç°è¿™äº›æ§åˆ¶å¹³é¢çš„é«˜å¯ç”¨ã€‚ å®‰è£… K3s æ—¶éœ€è¦æŒ‡å®š --tls-san å‚æ•°ï¼Œè¿™æ · K3s å°±ä¼šä½¿ç”¨ kube-vip è™šæ‹Ÿ IP åœ°å€ç”Ÿæˆ API æœåŠ¡å™¨è¯ä¹¦ã€‚ masterèŠ‚ç‚¹ä¸Š ç¬¬ä¸€ä¸ªserver curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn INSTALL_K3S_EXEC=\" --cluster-init --tls-san 172.16.1.222 --disable=traefik --disable servicelb --kube-proxy-arg proxy-mode=ipvs --write-kubeconfig ~/.kube/config --write-kubeconfig-mode 644 \" sh - # æŸ¥çœ‹token cat /var/lib/rancher/k3s/server/token å…¶ä»–server curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn K3S_TOKEN=K107f47359a4c5125056975c2bb8e4bee90a099366efa61e207092782f19f209abd::server:83a5baabf15d41e9cdf1de4a84b5367f INSTALL_K3S_EXEC=\" --server https://172.16.1.164:6443 --tls-san 172.16.1.2","date":"2023-12-16","objectID":"/posts/2023-12-16-k3s/:4:2","tags":["k3s","k8s"],"title":"k3s","uri":"/posts/2023-12-16-k3s/"},{"categories":["DevOps"],"content":"å››ã€å¤šmasteré«˜å¯ç”¨ç”Ÿäº§çº§åˆ«éƒ¨ç½²â€”ç¦»çº¿ç‰ˆ # download wget https://github.com/k3s-io/k3s/releases/download/v1.28.4%2Bk3s2/k3s-arm64 wget https://github.com/k3s-io/k3s/releases/download/v1.28.4%2Bk3s2/k3s-airgap-images-arm64.tar.gz # ä¸‹è½½rpmåŒ… wget https://github.com/k3s-io/k3s-selinux/releases/download/v1.4.stable.1/k3s-selinux-1.4-1.el9.noarch.rpm yum -y localinstall k3s-selinux-1.4-1.el9.noarch.rpm --downloadonly --downloaddir=./k3s-rpm yum -y install ipvsadm ipset --downloadonly --downloaddir=./k3s-rpm # ä¸‹è½½å®‰è£…è„šæœ¬ # wget https://get.k3s.io -o ./install.sh # wget http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh wget https://raw.githubusercontent.com/k3s-io/k3s/master/install.sh #åˆ†å‘åˆ°æ‰€æœ‰èŠ‚ç‚¹ # set k3s cp ./k3s /usr/local/bin/ chmod 755 /usr/local/bin/k3s # set images tar -xf k3s-airgap-images-$ARCH.tar.gz mkdir -p /var/lib/rancher/k3s/agent/images/ cp ./k3s-airgap-images-$ARCH.tar /var/lib/rancher/k3s/agent/images/ systemctl stop firewalld systemctl disable firewalld setenforce 0 sed -ri '/^SELINUX=/cSELINUX=disabled' /etc/selinux/config # å†…æ ¸å‚æ•°è®¾ç½® cat \u003c\u003cEOF \u003e /etc/sysctl.d/k8s.conf # https://github.com/moby/moby/issues/31208 # ipvsadm -l --timout # ä¿®å¤ipvsæ¨¡å¼ä¸‹é•¿è¿æ¥timeouté—®é¢˜ å°äº900å³å¯ net.ipv4.tcp_keepalive_time = 600 net.ipv4.tcp_keepalive_intvl = 30 net.ipv4.tcp_keepalive_probes = 10 net.ipv6.conf.all.disable_ipv6 = 1 net.ipv6.conf.default.disable_ipv6 = 1 net.ipv6.conf.lo.disable_ipv6 = 1 net.ipv4.neigh.default.gc_stale_time = 120 net.ipv4.conf.all.rp_filter = 0 net.ipv4.conf.default.rp_filter = 0 net.ipv4.conf.default.arp_announce = 2 net.ipv4.conf.lo.arp_announce = 2 net.ipv4.conf.all.arp_announce = 2 net.ipv4.ip_forward = 1 net.ipv4.tcp_max_tw_buckets = 5000 net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_max_syn_backlog = 1024 net.ipv4.tcp_synack_retries = 2 # è¦æ±‚iptablesä¸å¯¹bridgeçš„æ•°æ®è¿›è¡Œå¤„ç† net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 net.bridge.bridge-nf-call-arptables = 1 net.netfilter.nf_conntrack_max = 2310720 fs.inotify.max_user_watches=89100 fs.may_detach_mounts = 1 fs.file-max = 52706963 fs.nr_open = 52706963 vm.swappiness = 0 vm.overcommit_memory=1 vm.panic_on_oom=0 EOF sysctl -p cat \u003e/etc/modules-load.d/ipvs.conf\u003c\u003cEOF ip_vs # è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•-æœ€å°‘è¿æ¥ ip_vs_lc # è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•-åŠ æƒæœ€å°‘è¿æ¥ ip_vs_wlc # è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•-è½®è¯¢ ip_vs_rr # è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•-åŠ æƒè½®è¯¢ ip_vs_wrr # æºåœ°å€æ•£åˆ—è°ƒåº¦ç®—æ³• ip_vs_sh nf_conntrack br_netfilter EOF systemctl restart systemd-modules-load.service lsmod | grep -e ip_vs -e nf_conntrack -e br_netfilter # è®¾ç½®ç»­ç­¾æ—¶é—´ echo \"CATTLE_NEW_SIGNED_CERT_EXPIRATION_DAYS=3650\" \u003e /etc/default/k3s # è®¾ç½®é•œåƒåŠ é€Ÿ mkdir -p /etc/rancher/k3s cat \u003e /etc/rancher/k3s/registries.yaml \u003c\u003cEOF mirrors: docker.io: endpoint: - \"https://docker.mirrors.sjtug.sjtu.edu.cn\" - \"https://docker.nju.edu.cn\" quay.io: endpoint: - \"https://quay.nju.edu.cn\" gcr.io: endpoint: - \"https://gcr.nju.edu.cn\" ghcr.io: endpoint: - \"https://ghcr.nju.edu.cn\" nvcr.io: endpoint: - \"https://ngc.nju.edu.cn\" EOF ç¬¬ä¸€ä¸ªserver # é…ç½®kube-vip mkdir -p /var/lib/rancher/k3s/server/manifests/ cat \u003e kube-vip.yaml \u003c\u003cEOF apiVersion: v1 kind: ServiceAccount metadata: name: kube-vip namespace: kube-system --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: annotations: rbac.authorization.kubernetes.io/autoupdate: \"true\" name: system:kube-vip-role rules: - apiGroups: [\"\"] resources: [\"services\", \"services/status\", \"nodes\", \"endpoints\"] verbs: [\"list\",\"get\",\"watch\", \"update\"] - apiGroups: [\"coordination.k8s.io\"] resources: [\"leases\"] verbs: [\"list\", \"get\", \"watch\", \"update\", \"create\"] --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: system:kube-vip-binding roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:kube-vip-role subjects: - kind: ServiceAccount name: kube-vip namespace: kube-system --- apiVersion: apps/v1 kind: DaemonSet metadata: creationTimestamp: null name: kube-vip-ds namespace: kube-system spec: selector: matchLabels: name: kube-vip-ds template: metadata: creationTimestamp: null labels: name: kube-vip-ds spec: affinity: nodeAffinity: requ","date":"2023-12-16","objectID":"/posts/2023-12-16-k3s/:5:0","tags":["k3s","k8s"],"title":"k3s","uri":"/posts/2023-12-16-k3s/"},{"categories":["DevOps"],"content":"Ansible handbook ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:0:0","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"ä¸€ã€ansibleé…ç½® ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:1:0","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"1ã€ansible.cfg https://ansible-tran.readthedocs.io/en/latest/docs/intro_configuration.html * ANSIBLE_CONFIG (ä¸€ä¸ªç¯å¢ƒå˜é‡) * ansible.cfg (ä½äºå½“å‰ç›®å½•ä¸­) * .ansible.cfg (ä½äºå®¶ç›®å½•ä¸­) * /etc/ansible/ansible.cfg ç”Ÿæˆansibleçš„é…ç½®æ–‡ä»¶ $ ansible-config init --disabled \u003e ~/.ansible.cfg ä½¿ç”¨ç¯å¢ƒå˜é‡å…³é—­KeyéªŒè¯æç¤º $ export ANSIBLE_HOST_KEY_CHECKING=False å¯ä½¿ç”¨çš„æ¨¡æ¿ [defaults] interpreter_python = auto #interpreter_python = /usr/bin/python3 host_key_checking=False #inventory=~/.ansible/hosts private_key_file=/path/to/file.pem remote_user = root sudo_user=root ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:1:1","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"2ã€hosts å†™æ³•ä¸€ node1.ansible.com node2.ansible.com 192.168.1.1 å†™æ³•äºŒ [webserver] 192.168.10.1 192.168.10.2 [dbserver] 192.168.20.1 192.168.20.2 æ³¨æ„ï¼šå¦‚æœä¸»æœºå»ºæœªåšsshäº’ä¿¡ï¼Œåˆ™å¯ä»¥æŒ‰ä»¥ä¸‹å†™æ³• # è¿ç»­IP [test1] name1 ansible_ssh_host=192.168.1.[20:50] ansible_ssh_user=\"root\" ansible_ssh_pass=\"1234\" ansible_ssh_port=22 ansible_ssh_private_key_file=~/.ssh/id_rsa # å¸¦å‚æ•° [test1] name1 ansible_ssh_host=192.168.1.[20:50] [test1:vars] ansible_ssh_user=root ansible_ssh_pass=\"1234\" testvar=\"test\" hostæ–‡ä»¶å¸¸ç”¨å˜é‡ ansible_ssh_host #ç”¨äºæŒ‡å®šè¢«ç®¡ç†çš„ä¸»æœºçš„çœŸå®IP ansible_ssh_port #ç”¨äºæŒ‡å®šè¿æ¥åˆ°è¢«ç®¡ç†ä¸»æœºçš„sshç«¯å£å·ï¼Œé»˜è®¤æ˜¯22 ansible_ssh_user #sshè¿æ¥æ—¶é»˜è®¤ä½¿ç”¨çš„ç”¨æˆ·å ansible_ssh_pass #sshè¿æ¥æ—¶çš„å¯†ç  ansible_sudo_pass #ä½¿ç”¨sudoè¿æ¥ç”¨æˆ·æ—¶çš„å¯†ç  ansible_sudo_exec #å¦‚æœsudoå‘½ä»¤ä¸åœ¨é»˜è®¤è·¯å¾„ï¼Œéœ€è¦æŒ‡å®šsudoå‘½ä»¤è·¯å¾„ ansible_ssh_private_key_file #ç§˜é’¥æ–‡ä»¶è·¯å¾„ï¼Œç§˜é’¥æ–‡ä»¶å¦‚æœä¸æƒ³ä½¿ç”¨ssh-agentç®¡ç†æ—¶å¯ä»¥ä½¿ç”¨æ­¤é€‰é¡¹ ansible_shell_type #ç›®æ ‡ç³»ç»Ÿçš„shellçš„ç±»å‹ï¼Œé»˜è®¤sh ansible_connection #SSH è¿æ¥çš„ç±»å‹ï¼š local , ssh , paramikoï¼Œåœ¨ ansible 1.2 ä¹‹å‰é»˜è®¤æ˜¯ paramiko ï¼Œåæ¥æ™ºèƒ½é€‰æ‹©ï¼Œä¼˜å…ˆä½¿ç”¨åŸºäº ControlPersist çš„ ssh ï¼ˆæ”¯æŒçš„å‰æï¼‰ ansible_python_interpreter #ç”¨æ¥æŒ‡å®špythonè§£é‡Šå™¨çš„è·¯å¾„ï¼Œé»˜è®¤ä¸º/usr/bin/python åŒæ ·å¯ä»¥æŒ‡å®šruby ã€perl çš„è·¯å¾„ ansible_*_interpreter #å…¶ä»–è§£é‡Šå™¨è·¯å¾„ï¼Œç”¨æ³•ä¸ansible_python_interpreterç±»ä¼¼ï¼Œè¿™é‡Œ\"*\"å¯ä»¥æ˜¯rubyæˆ–æ‰perlç­‰ ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:1:2","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"äºŒã€playbookç¤ºä¾‹ - hosts: rocky become: yes become_user: root roles: #- role: serialt.centos_init - role: repo vars: elrepo_install: False - role: serialt.os_init vars: login_info: \" Welcome to local OPS\" fail2ban_ignore_ip: \"\" ssh_key_message: \"t@local.com\" - role: python - role: serialt.docker vars: docker_insecure_registries: [\"repo.local.com\"] # - role: serialt.chrony #- role: serialt.kernel # - role: zabbix-server è¡¥å…… # æœ¬åœ°æ‰§è¡Œ - name: check | å‘å¸ƒæ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚ shell: \"ls {{ deploy_file }}\" connection: local # åˆ¤æ–­ - name: Create software directory. file: path: \"{{ software_files_path }}\" state: directory connection: local when: not go_file_result.stat.exists # ä¸²è¡Œæ‰§è¡Œ - hosts: server1 become: yes gather_facts: yes serial: 1 tasks: - YOUR TASKS HERE - hosts: serialt become: yes become_user: root vars: go_version: \"1.20.2\" tasks: - name: check | å‘å¸ƒæ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚ shell: \"ls {{ deploy_file }}\" connection: local ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:2:0","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"ä¸‰ã€å…¬é’¥å—ä¿¡ ad hoc ansible add-public-key -m authorized_key -a \"user=root state=present key='{{ lookup('file', '/home/root/.ssh/id_rsa.pub') }}'\" playbook - hosts: add-public-key gather_facts: false tasks: - name: Add local public key to remote hosts. authorized_key: user: sugar key: \"{{ lookup('file', '/Users/serialt/.ssh/id_rsa.pub') }}\" state: present hosts [add-public-key] 172.16.78.53 ansible_connection=ssh ansible_ssh_user=\"sugar\" ansible_ssh_pass=\"ubuntu\" ; 172.25.70.2 ansible_connection=ssh ansible_ssh_user=\"root\" ansible_ssh_pass=\"redhat\" ; 172.25.70.3 ansible_connection=ssh ansible_ssh_user=\"sugar\" ansible_ssh_pass=\"redhat\" ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:2:1","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"å››ã€æ¨¡å—ç®€ä»‹ ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:0","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"ping æ£€æµ‹è¢«ç®¡ç†ç«¯æ˜¯å¦åœ¨çº¿ ad-hoc [root@localhost test]# ansible k8s -m ping 192.168.122.100 | SUCCESS =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python\" }, \"changed\": false, \"ping\": \"pong\" } playbook # pingæ¨¡å—æ²¡æœ‰å‚æ•° [root@localhost test]# cat ping.yaml - hosts: k8s user: root gather_facts: false tasks: - name: test ping ping: ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:1","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"shell åœ¨è¢«ç®¡ç†ç«¯æ‰§è¡Œå‘½ä»¤ï¼Œæ”¯æŒé‡å®šå‘å’Œç®¡é“ ad-hoc [root@localhost test]# ansible k8s -m shell -a \" uptime\" 192.168.122.100 | CHANGED | rc=0 \u003e\u003e 11:11:05 up 25 days, 1:14, 2 users, load average: 0.31, 0.44, 0.39 # å‚æ•° chdir=\u003cDirectory\u003e playbook [root@localhost test]# cat shell.yaml - hosts: k8s user: root gather_facts: false tasks: - name: test shell shell: date \u0026\u0026 pwd args: chdir: /tmp/ - name: Run expect to wait for a successful PXE boot via out-of-band CIMC shell: | set timeout 300 spawn ssh admin@{{ cimc_host }} expect \"password:\" send \"{{ cimc_password }}\\n\" expect \"\\n{{ cimc_name }}\" send \"connect host\\n\" expect \"pxeboot.n12\" send \"\\n\" exit 0 args: executable: /usr/bin/expect delegate_to: localhost ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:2","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"copy æ‹·è´ansibleç®¡ç†ç«¯çš„æ–‡ä»¶åˆ°è¿œç¨‹ä¸»æœºçš„æŒ‡å®šä½ç½® å¸¸è§å‚æ•°ï¼š å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ dest string null æŒ‡æ˜æ‹·è´æ–‡ä»¶çš„ç›®æ ‡ç›®å½•ä½ç½®ï¼Œä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œå¦‚æœæºæ˜¯ç›®å½•ï¼Œåˆ™ç›®æ ‡ä¹Ÿè¦æ˜¯ç›®å½•,å¦‚æœç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œä¼šè¦†ç›–åŸæœ‰å†…å®¹ src string null æŒ‡æ˜æœ¬åœ°è·¯å¾„ä¸‹çš„æŸä¸ªæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„ï¼Œæ”¯æŒç›´æ¥æŒ‡å®šç›®å½•ï¼Œå¦‚æœæºæ˜¯ç›®å½•ï¼Œåˆ™ç›®æ ‡ä¹Ÿè¦æ˜¯ç›®å½• mode æƒé™ä½ æ—  æŒ‡æ˜å¤åˆ¶æ—¶ï¼Œç›®æ ‡æ–‡ä»¶çš„æƒé™ owner string null æŒ‡æ˜å¤åˆ¶æ—¶ï¼Œç›®æ ‡æ–‡ä»¶çš„å±ä¸» group string null æŒ‡æ˜å¤åˆ¶æ—¶ï¼Œç›®æ ‡æ–‡ä»¶çš„å±ç»„ content string null æŒ‡æ˜å¤åˆ¶åˆ°ç›®æ ‡ä¸»æœºä¸Šçš„å†…å®¹ï¼Œä¸èƒ½ä¸srcä¸€èµ·ä½¿ç”¨ï¼Œç›¸å½“äºå¤åˆ¶contentæŒ‡æ˜çš„æ•°æ®ï¼Œåˆ°ç›®æ ‡æ–‡ä»¶ä¸­ [root@localhost test]# ansible k8s -m copy -a \"src=/etc/hosts dest=/tmp/\" 192.168.122.100 | CHANGED =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python\" }, \"changed\": true, \"checksum\": \"42d592f8ed1579880187c900197e1edd09688992\", \"dest\": \"/tmp/hosts\", \"gid\": 0, \"group\": \"root\", \"md5sum\": \"f4c82671111086eb6fa6d869e80e1128\", \"mode\": \"0644\", \"owner\": \"root\", \"size\": 803, \"src\": \"/root/.ansible/tmp/ansible-tmp-1608693775.8-22394-277593855767937/source\", \"state\": \"file\", \"uid\": 0 } ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:3","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"fetch ä»è¿œç¨‹ä¸»æœºæ‹‰å–æ–‡ä»¶åˆ°æœ¬åœ°ï¼ˆ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªä¼šä»ä¸€ä¸ªè¿œç¨‹èŠ‚ç‚¹æ‹‰å–æ•°æ®ï¼‰ å¸¸è§å‚æ•°ï¼š å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ dest string null ä»è¿œç¨‹ä¸»æœºä¸Šæ‹‰å–çš„æ–‡ä»¶å­˜æ”¾åœ¨æœ¬åœ°çš„ä½ç½®ï¼Œä¸€èˆ¬åªèƒ½æ˜¯ç›®å½• src string null æŒ‡æ˜è¿œç¨‹ä¸»æœºä¸Šè¦æ‹‰å–çš„æ–‡ä»¶ï¼Œåªèƒ½æ˜¯æ–‡ä»¶ï¼Œä¸èƒ½æ˜¯ç›®å½• [root@master ~]# ansible test -m fetch -a 'src=/etc/passwd dest=/tmp' 192.168.100.102 | SUCCESS =\u003e { \"changed\": true, \"checksum\": \"974b44c114ecbd71bdee11e09a9bc14c9b0395bd\", \"dest\": \"/tmp/192.168.100.102/etc/passwd\", \"md5sum\": \"01d72332a8d9737631212995fe1494f4\", \"remote_checksum\": \"974b44c114ecbd71bdee11e09a9bc14c9b0395bd\", \"remote_md5sum\": null } ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:4","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"cron ç®¡ç†è®¡åˆ’ä»»åŠ¡ å¸¸è§å‚æ•° å‚æ•° å–å€¼ é»˜è®¤å€¼0 è¯´æ˜ minute 0-59, * , * / 2 * æŒ‡æ˜è®¡åˆ’ä»»åŠ¡çš„åˆ†é’Ÿ hour 0-23, * , * / 2 * day 1-31 * month 1-12 * weekday 0-6 * reboot yes | no null æŒ‡æ˜è®¡åˆ’ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´ä¸ºæ¯æ¬¡é‡å¯ä¹‹å name string null ç»™è¯¥è®¡åˆ’ä»»åŠ¡å–ä¸ªåç§°,å¿…é¡»è¦ç»™æ˜ã€‚æ¯ä¸ªä»»åŠ¡çš„åç§°ä¸èƒ½ä¸€æ · job string null æ‰§è¡Œçš„ä»»åŠ¡æ˜¯ä»€ä¹ˆï¼Œå½“state=presentæ—¶æ‰æœ‰æ„ä¹‰ state present | absent present è¡¨ç¤ºè¿™ä¸ªä»»åŠ¡æ˜¯åˆ›å»ºè¿˜æ˜¯åˆ é™¤ï¼Œpresentè¡¨ç¤ºåˆ›å»ºï¼Œabsentè¡¨ç¤ºåˆ é™¤ï¼Œé»˜è®¤æ˜¯present [root@master ~]# ansible test -m cron -a 'minute=*/5 name=Ajob job=\"/usr/sbin/ntpdate 172.16.8.100 \u0026\u003e /dev/null\" state=present' 192.168.100.102 | SUCCESS =\u003e { \"changed\": true, \"envs\": [], \"jobs\": [ \"Ajob\" ] } [root@master ~]# ansible test -m shell -a 'crontab -l' 192.168.100.102 | SUCCESS | rc=0 \u003e\u003e #Ansible: Ajob */5 * * * * /usr/sbin/ntpdate 172.16.8.100 \u0026\u003e /dev/null [root@master ~]# ansible test -m cron -a 'minute=*/5 name=Ajob job=\"/usr/sbin/ntpdate 172.16.8.100 \u0026\u003e /dev/null\" state=absent' 192.168.100.102 | SUCCESS =\u003e { \"changed\": true, \"envs\": [], \"jobs\": [] } ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:5","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"file ç”¨äºè®¾å®šè¿œç¨‹ä¸»æœºä¸Šçš„æ–‡ä»¶å±æ€§ å¸¸è§å‚æ•°: å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ path string null æŒ‡æ˜å¯¹å“ªä¸ªæ–‡ä»¶ä¿®æ”¹å…¶å±æ€§ src string null æŒ‡æ˜path=æŒ‡æ˜çš„æ–‡ä»¶æ˜¯è½¯é“¾æ¥æ–‡ä»¶ï¼Œå…¶å¯¹åº”çš„æºæ–‡ä»¶æ˜¯è°ï¼Œå¿…é¡»è¦åœ¨state=linkæ—¶æ‰æœ‰ç”¨ state directory | link| absent null è¡¨ç¤ºåˆ›å»ºçš„æ–‡ä»¶æ˜¯ç›®å½•è¿˜æ˜¯è½¯é“¾æ¥ owner string null æŒ‡æ˜æ–‡ä»¶çš„å±ä¸» mode æƒé™ä½ æ—  æŒ‡æ˜æ–‡ä»¶çš„æƒé™ ä½¿ç”¨ç¤ºä¾‹ï¼š åˆ›å»ºè½¯é“¾æ¥çš„ç”¨æ³•ï¼š src= path= state=link ä¿®æ”¹æ–‡ä»¶å±æ€§çš„ç”¨æ³•ï¼š path= owner= mode= group= åˆ›å»ºç›®å½•çš„ç”¨æ³•ï¼š path= state=directory åˆ é™¤æ–‡ä»¶ï¼š path= state=absent [root@ansible etc]# ansible testsrv -m file -a \"path=/tmp/1.txt mode=600 owner=root group=nobody\" [root@ansible ~]# ansible testsrv -m file -a \"path=/tmp/bb mode=777 recurse=yes\" åˆ›å»ºè½¯é“¾æ¥ [root@master ~]# ansible test -m file -a 'src=/etc/passwd path=/tmp/passwd.link state=link' 192.168.100.102 | SUCCESS =\u003e { \"changed\": true, \"dest\": \"/tmp/passwd.link\", \"gid\": 0, \"group\": \"root\", \"mode\": \"0777\", \"owner\": \"root\", \"size\": 11, \"src\": \"/etc/passwd\", \"state\": \"link\", \"uid\": 0 } åˆ é™¤æ–‡ä»¶ [root@master ~]# ansible test -m file -a 'path=/tmp/cc.txt state=absent' 192.168.100.102 | SUCCESS =\u003e { \"changed\": true, \"path\": \"/tmp/cc.txt\", \"state\": \"absent\" } ä¿®æ”¹æ–‡ä»¶å±æ€§ [root@master ~]# ansible test -m file -a 'path=/tmp/bb.txt mode=700 owner=root group=nobody' 192.168.100.102 | SUCCESS =\u003e { \"changed\": true, \"gid\": 99, \"group\": \"nobody\", \"mode\": \"0700\", \"owner\": \"root\", \"path\": \"/tmp/bb.txt\", \"size\": 14, \"state\": \"file\", \"uid\": 0 } [root@master ~]# ansible test -m shell -a 'ls -l /tmp/bb.txt' 192.168.100.102 | SUCCESS | rc=0 \u003e\u003e -rwx------ 1 root nobody 14 Dec 2 2016 /tmp/bb.txt åˆ›å»ºç›®å½• [root@master ~]# ansible test -m file -a 'path=/tmp/bj state=directory' 192.168.100.102 | SUCCESS =\u003e { \"changed\": true, \"gid\": 0, \"group\": \"root\", \"mode\": \"0755\", \"owner\": \"root\", \"path\": \"/tmp/bj\", \"size\": 4096, \"state\": \"directory\", \"uid\": 0 } åˆ é™¤ç›®å½• [root@master ~]# ansible test -m file -a 'path=/tmp/bj state=absent' 192.168.100.102 | SUCCESS =\u003e { \"changed\": true, \"path\": \"/tmp/bj\", \"state\": \"absent\" } [root@master ~]# ansible test -m shell -a 'ls -l /tmp' 192.168.100.102 | SUCCESS | rc=0 \u003e\u003e total 16 -rw-r--r-- 1 root root 0 Dec 2 2016 aa.txt drwx------ 2 root root 4096 Dec 2 13:41 ansible_twMJYb -rwx------ 1 root nobody 14 Dec 2 2016 bb.txt -rw-r--r-- 1 root root 158 Dec 2 2016 hosts -rw------- 1 nobody nobody 947 Dec 2 2016 passwd lrwxrwxrwx 1 root root 11 Dec 2 13:35 passwd.link -\u003e /etc/passwd -rw------- 1 root root 0 Dec 2 00:58 yum.log ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:6","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"hostsname ç®¡ç†è¿œç¨‹ä¸»æœºçš„ä¸»æœºå å‚æ•°ï¼š name= æŒ‡æ˜ä¸»æœºå [root@master ~]# ansible test -m shell -a 'hostname' 192.168.100.102 | SUCCESS | rc=0 \u003e\u003e node1.ansible.com [root@master ~]# ansible test -m hostname -a 'name=node2.ansible.com' 192.168.100.102 | SUCCESS =\u003e { \"ansible_facts\": { \"ansible_domain\": \"ansible.com\", \"ansible_fqdn\": \"node2.ansible.com\", \"ansible_hostname\": \"node2\", \"ansible_nodename\": \"node2.ansible.com\" }, \"changed\": true, \"name\": \"node2.ansible.com\" } ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:7","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"yum åŸºäºyumæœºåˆ¶ï¼Œå¯¹è¿œç¨‹ä¸»æœºç®¡ç†ç¨‹åºåŒ… å¸¸ç”¨å‚æ•°ï¼š å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ name string null æŒ‡æ˜ç¨‹åºåŒ…çš„åç§°ï¼Œå¯ä»¥å¸¦ä¸Šç‰ˆæœ¬å·ï¼Œä¸æŒ‡æ˜ç‰ˆæœ¬ï¼Œå°±æ˜¯é»˜è®¤æœ€æ–°ç‰ˆæœ¬ state present|lastest|absent null æŒ‡æ˜å¯¹ç¨‹åºåŒ…æ‰§è¡Œçš„æ“ä½œï¼Œpresentè¡¨ç¤ºå®‰è£…ç¨‹åºåŒ…ï¼Œlatestè¡¨ç¤ºå®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ç¨‹åºåŒ…ï¼Œabsentè¡¨ç¤ºå¸è½½ç¨‹åºåŒ… disablerepo yes|no null åœ¨ç”¨yumå®‰è£…æ—¶ï¼Œä¸´æ—¶ç¦ç”¨æŸä¸ªä»“åº“ï¼Œä»“åº“çš„ID enablerepo yes|no null åœ¨ç”¨yumå®‰è£…æ—¶ï¼Œä¸´æ—¶å¯ç”¨æŸä¸ªä»“åº“,ä»“åº“çš„ID conf_file= string null æŒ‡æ˜yumè¿è¡Œæ—¶é‡‡ç”¨å“ªä¸ªé…ç½®æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„é…ç½®æ–‡ä»¶ disable_gpg_check yes|no null æ˜¯å¦å¯ç”¨gpg-check # å¸è½½è½¯ä»¶åŒ…: [root@master ~]# ansible test -m yum -a 'name=httpd state=absent' [root@master ~]# ansible test -m shell -a 'rpm -q httpd' # å®‰è£…è½¯ä»¶åŒ…: [root@master ~]# ansible test -m yum -a 'name=httpd state=present' [root@ansible ~]# ansible 192.168.122.102 -m yum -a \"name=ftp state=present disablerepo=zabbix\" [root@ansible_server ~]# ansible test_server -m yum -a \"name=zabbix-agent state=present enablerepo=zabbix3.2 disablerepo=zabbix\" # æ›´æ–°è½¯ä»¶ [root@ansible_server ~]# ansible test_server -m yum -a \"name=zabbix-agent state=latest\" palybook - hosts: all tasks: - name: yum yum: name: \"{{ item }}\" state: present with_items: - git - httpd - mysql ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:8","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"yum_repository ç®¡ç†è¿œç¨‹ä¸»æœºä¸Šçš„ yum ä»“åº“ å¸¸ç”¨å‚æ•°ï¼š å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ name string null å¿…é¡»å‚æ•°ï¼Œç”¨äºæŒ‡å®šè¦æ“ä½œçš„å”¯ä¸€çš„ä»“åº“IDï¼Œä¹Ÿå°±æ˜¯â€.repoâ€é…ç½®æ–‡ä»¶ä¸­æ¯ä¸ªä»“åº“å¯¹åº”çš„â€ä¸­æ‹¬å·â€å†…çš„ä»“åº“ID baseurl string null ç”¨äºè®¾ç½® yum ä»“åº“çš„ baseurl description string null ç”¨äºè®¾ç½®ä»“åº“çš„æ³¨é‡Šä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯â€.repoâ€é…ç½®æ–‡ä»¶ä¸­æ¯ä¸ªä»“åº“å¯¹åº”çš„â€nameå­—æ®µâ€å¯¹åº”çš„å†…å®¹ file string null ç”¨äºè®¾ç½®ä»“åº“çš„é…ç½®æ–‡ä»¶åç§°ï¼Œå³è®¾ç½®â€.repoâ€é…ç½®æ–‡ä»¶çš„æ–‡ä»¶åå‰ç¼€ï¼Œåœ¨ä¸ä½¿ç”¨æ­¤å‚æ•°çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤ä»¥ name å‚æ•°çš„ä»“åº“IDä½œä¸ºâ€.repoâ€é…ç½®æ–‡ä»¶çš„æ–‡ä»¶åå‰ç¼€ï¼ŒåŒä¸€ä¸ªâ€.repoâ€ é…ç½®æ–‡ä»¶ä¸­å¯ä»¥å­˜åœ¨å¤šä¸ª yum æº enabled string yes ç”¨äºè®¾ç½®æ˜¯å¦æ¿€æ´»å¯¹åº”çš„ yum æºï¼Œæ­¤å‚æ•°é»˜è®¤å€¼ä¸º yesï¼Œè¡¨ç¤ºå¯ç”¨å¯¹åº”çš„ yum æºï¼Œè®¾ç½®ä¸º no è¡¨ç¤ºä¸å¯ç”¨å¯¹åº”çš„ yum æº gpgcheck string no ç”¨äºè®¾ç½®æ˜¯å¦å¼€å¯ rpm åŒ…éªŒè¯åŠŸèƒ½ï¼Œé»˜è®¤å€¼ä¸º noï¼Œè¡¨ç¤ºä¸å¯ç”¨åŒ…éªŒè¯ï¼Œè®¾ç½®ä¸º yes è¡¨ç¤ºå¼€å¯åŒ…éªŒè¯åŠŸèƒ½ gpgcakey string null å½“ gpgcheck å‚æ•°è®¾ç½®ä¸º yes æ—¶ï¼Œéœ€è¦ä½¿ç”¨æ­¤å‚æ•°æŒ‡å®šéªŒè¯åŒ…æ‰€éœ€çš„å…¬é’¥ state present present å½“å€¼è®¾ç½®ä¸º absent æ—¶ï¼Œè¡¨ç¤ºåˆ é™¤å¯¹åº”çš„ yum æº [root@ansible-manager ~]# ansible ansible-demo3 -m yum_repository -a 'name=aliEpel description=\"alibaba EPEL\" baseurl=https://mirrors.aliyun.com/epel/$releasever\\Server/$basearch/' ansible-demo3 | SUCCESS =\u003e { \"changed\": true, \"repo\": \"aliEpel\", \"state\": \"present\" } é…ç½®postgresql æ¸…åæº [root@localhost test]# cat yum_repo.yaml - hosts: 127.0.0.1 user: root gather_facts: false tasks: - name: config postgresql with tsinghua yum_repository: file: postgresql-10 name: postgresql description: postgresql-10 tsinghua baseurl: https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/10/redhat/rhel-7-x86_64/ enabled: yes gpgcheck: no [root@localhost yum.repos.d]# cat postgresql-10.repo [postgresql] baseurl = https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/10/redhat/rhel-7-x86_64/ enabled = 1 gpgcheck = 0 name = postgresql-10 tsinghua ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:9","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"service ç®¡ç†è¿œç¨‹ä¸»æœºä¸Šçš„æœåŠ¡çš„æ¨¡å— å¸¸ç”¨å‚æ•°ï¼š å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ name string null è¢«ç®¡ç†çš„æœåŠ¡åç§°(/etc/init.d) state started|stopped|restarted started å¯åŠ¨æˆ–å…³é—­æˆ–é‡èµ· enabled yes|no no è®¾å®šè¯¥æœåŠ¡å¼€æœºè‡ªå¯åŠ¨ [root@master ~]# ansible test -m service -a 'name=nginx state=started' 192.168.100.102 | SUCCESS =\u003e { \"changed\": true, \"name\": \"nginx\", \"state\": \"started\" } [root@master ~]# ansible test -m shell -a 'service nginx status' 192.168.100.102 | SUCCESS | rc=0 \u003e\u003e nginx (pid 4054) is running... [root@master ~]# [root@master ~]# ansible test -m service -a 'name=nginx state=stopped' 192.168.100.102 | SUCCESS =\u003e { \"changed\": true, \"name\": \"nginx\", \"state\": \"stopped\" } [root@master ~]# ansible test -m shell -a 'service nginx status' 192.168.100.102 | FAILED | rc=3 \u003e\u003e nginx is stopped [root@master ~]# ansible test -m service -a 'name=nginx state=started enabled=yes runlevel=2345' 192.168.100.102 | SUCCESS =\u003e { \"changed\": true, \"enabled\": true, \"name\": \"nginx\", \"state\": \"started\" } [root@master ~]# ansible test -m shell -a 'chkconfig --list nginx' 192.168.100.102 | SUCCESS | rc=0 \u003e\u003e nginx 0:off 1:off 2:on 3:on 4:on 5:on 6:off ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:10","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"systemd ç®¡ç†è¢«æ§åˆ¶ä¸»æœºçš„systemdæœåŠ¡ å¸¸è§å‚æ•°ï¼š å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ daemon_reload yes|no æ—  é‡å¯å®ˆæŠ¤è¿›ç¨‹ï¼Œä¸å…¶ä»–systemdå‚æ•°æ’æ–¥ name string null è¢«ç®¡ç†çš„æœåŠ¡å enabled yes|no null æœåŠ¡è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ state reloaded|restarted|started|stopped null æœåŠ¡çŠ¶æ€ [root@localhost test]# cat daemon_reload.yaml - hosts: 127.0.0.1 user: root gather_facts: false tasks: - name: daemon reload systemd: daemon_reload: yes [root@localhost test]# cat nginx.yaml - hosts: 127.0.0.1 user: root gather_facts: false tasks: - name: daemon reload systemd: name: nginx enabled: yes state: restarted ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:11","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"git ç®¡ç†gitæœåŠ¡æ¨¡å— å¸¸è§å‚æ•°ï¼š å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ bare yes|no no å»ºç«‹è£¸ä»“åº“ï¼Œç”¨äºæœåŠ¡å™¨ç«¯gitä»“åº“å­˜å‚¨ clone yes|no yes æœ¬åœ°é•œåƒä»“åº“ä¸å­˜åœ¨åˆ™clone depth æ•°å­— null cloneæ—¶å…‹éš†çš„commitæ·±åº¦ï¼Œ1è¡¨ç¤ºåªå…‹éš†æœ€æ–°ä¸€æ¬¡æäº¤ï¼Œé»˜è®¤null dest string null cloneå‡ºçš„ä»“åº“å­˜å‚¨çš„è·¯å¾„ï¼Œä»…å½“clone=noæ—¶ä¸ç”¨è®¾ç½® force yes|no no å¼ºåˆ¶ remote string null è¿œç¨‹ä»“åº“çš„åç§°ï¼Œé»˜è®¤æ˜¯origin repo string null è¿œç¨‹ä»“åº“çš„åœ°å€ version string null checkoutçš„ç‰ˆæœ¬ï¼Œæ”¯æŒåˆ†æ”¯ã€tagã€hash archive string null cloneåçš„å‹ç¼©æ–‡ä»¶å­˜å‚¨æ–‡ä»¶ï¼Œæ”¯æŒæ ¼å¼zipã€tar.gzã€tarã€tgz - hosts: 127.0.0.1 user: root gather_facts: false vars: - GIT_REPO: git@serialt.io:sugars/sugars_backend.git - SRC_HASH: 4949e0b60be3f6a80826d3e02exxxxxxxxxxxx tasks: - name: clone a git repo git: repo: \"{{ item.repo }}\" version: \"{{ item.hash }}\" dest: /tmp/serialt_backend with_items: - {repo: \"{{ GIT_REPO }}\",hash: \"{{ SRC_HASH }}\" } ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:12","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"supervisorctl ç®¡ç†supervisorctlæœåŠ¡ å¸¸è§å‚æ•°ï¼š å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ config string null supervisoré…ç½®æ–‡ä»¶è·¯å¾„ name string null supervisord programçš„åå­—ï¼Œæ”¯æŒprogramå’Œprogramç»„ state string nul å¯é€‰present, started, stopped, restarted, absent, signalled supervisorctl_path string null supervisorctlå‘½ä»¤çš„è·¯å¾„ EXAMPLES: # Manage the state of program to be in 'started' state. - supervisorctl: name: my_app state: started # Manage the state of program group to be in 'started' state. - supervisorctl: name: 'my_apps:' state: started # Restart my_app, reading supervisorctl configuration from a specified file. - supervisorctl: name: my_app state: restarted config: /var/opt/my_project/supervisord.conf # Restart my_app, connecting to supervisord with credentials and server URL. - supervisorctl: name: my_app state: restarted username: test password: testpass server_url: http://localhost:9001 # Send a signal to my_app via supervisorctl - supervisorctl: name: my_app state: signalled signal: USR1 ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:13","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"pip ç®¡ç†pythonåº“ä¾èµ–æ¨¡å— å¸¸è§å‚æ•°ï¼š å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ chdir string null æ‰§è¡Œæ—¶çš„è·¯å¾„ name string null pipå®‰è£…çš„åŒ…å requirements string null å®‰è£…ä¾èµ–çš„åŒ…æ–‡ä»¶ executable string null å®‰è£…ä¾èµ–åŒ…æ—¶ä½¿ç”¨çš„pythonè·¯å¾„ state string present ä¾èµ–åŒ…çš„çŠ¶æ€ï¼Œabsent, forcereinstall, latest, presentï¼Œé»˜è®¤present virtualenv string null æ‰€ä½¿ç”¨çš„è™šæ‹Ÿç¯å¢ƒç›®å½• virtualenv_command string null åˆ›å»ºè™šæ‹Ÿç¯å¢ƒçš„å‘½ä»¤ virtualenv_python string null è™šæ‹Ÿç¯å¢ƒçš„pythonç‰ˆæœ¬ extra_args= string null é™„åŠ å‚æ•°ï¼Œå¯ä»¥ç”¨æ¥æŒ‡å®šæ‰€ä½¿ç”¨çš„å®‰è£…æº [root@localhost test]# cat pip.yaml - hosts: 192.168.100.105 user: root gather_facts: false tasks: - name: install python venv pip: requirements: /tmp/requirements.txt state: present virtualenv: /tmp/serialt_venv/ ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:14","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"archive å‹ç¼©æ–‡ä»¶æ¨¡å— å¸¸ç”¨å‚æ•°ï¼š å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ dest string null æ–‡ä»¶å½’æ¡£åçš„å‹ç¼©åŒ…æ–‡ä»¶åï¼Œå½“ pathä¸­æœ‰å¤šä¸ªæ–‡ä»¶æˆ–ç›®å½•æ—¶ï¼Œéœ€æä¾› dest å‚æ•° exclude_path string null æ’é™¤çš„path format string gz æ”¯æŒbz2, gz, tar, xz, zipï¼Œé»˜è®¤gz path string null è¦å‹ç¼©çš„è·¯å¾„ remove bool False åˆ é™¤æºæ–‡ä»¶ EXAMPLES: - name: Compress directory /path/to/foo/ into /path/to/foo.tgz archive: path: /path/to/foo dest: /path/to/foo.tgz - name: Compress regular file /path/to/foo into /path/to/foo.gz and remove it archive: path: /path/to/foo remove: yes - name: Create a zip archive of /path/to/foo archive: path: /path/to/foo format: zip - name: Create a bz2 archive of multiple files, rooted at /path archive: path: - /path/to/foo - /path/wong/foo dest: /path/file.tar.bz2 format: bz2 - name: Create a bz2 archive of a globbed path, while excluding specific dirnames archive: path: - /path/to/foo/* dest: /path/file.tar.bz2 exclude_path: - /path/to/foo/bar - /path/to/foo/baz format: bz2 - name: Create a bz2 archive of a globbed path, while excluding a glob of dirnames archive: path: - /path/to/foo/* dest: /path/file.tar.bz2 exclude_path: - /path/to/foo/ba* format: bz2 - name: Use gzip to compress a single archive (i.e don't archive it first with tar) archive: path: /path/to/foo/single.file dest: /path/file.gz format: gz - name: Create a tar.gz archive of a single file. archive: path: /path/to/foo/single.file dest: /path/file.tar.gz format: gz force_archive: true RETURN VALUES: - name: Create a zip archive of /path/to/foo archive: path: /path/to/foo format: zip - name: Create a bz2 archive of multiple files, rooted at /path archive: path: - /path/to/foo - /path/wong/foo dest: /path/file.tar.bz2 format: bz2 - name: Create a bz2 archive of a globbed path, while excluding specific dirnames archive: path: - /path/to/foo/* dest: /path/file.tar.bz2 exclude_path: - /path/to/foo/bar - /path/to/foo/baz format: bz2 - name: Create a bz2 archive of a globbed path, while excluding a glob of dirnames archive: path: - /path/to/foo/* dest: /path/file.tar.bz2 exclude_path: - /path/to/foo/ba* format: bz2 - name: Use gzip to compress a single archive (i.e don't archive it first with tar) archive: path: /path/to/foo/single.file dest: /path/file.gz format: gz - name: Create a tar.gz archive of a single file. archive: path: /path/to/foo/single.file dest: /path/file.tar.gz format: gz force_archive: true ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:15","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"unarchive å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ creates string null æ–‡ä»¶åï¼Œå½“å®ƒå·²ç»å­˜åœ¨æ—¶ï¼Œè¿™ä¸ªæ­¥éª¤å°†ä¸ä¼šè¢«è¿è¡Œ copy yes / no yes æ‹·è´çš„æ–‡ä»¶ä»ansibleä¸»æœºå¤åˆ¶åˆ°è¿œç¨‹ä¸»æœºï¼Œnoåœ¨è¿œç¨‹ä¸»æœºä¸Šå¯»æ‰¾srcæºæ–‡ä»¶è§£å‹ src string null taræºè·¯å¾„ï¼Œå¯ä»¥æ˜¯ansibleä¸»æœºä¸Šçš„è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯è¿œç¨‹ä¸»æœºä¸Šçš„è·¯å¾„ï¼Œå¦‚æœæ˜¯è¿œç¨‹ä¸»æœºä¸Šçš„è·¯å¾„ï¼Œåˆ™éœ€è®¾ç½®copy=no dest string null è¿œç¨‹ä¸»æœºä¸Šçš„ç›®æ ‡ç»å¯¹è·¯å¾„ mode æ•°å­— æ—  è®¾ç½®è§£å‹ç¼©åçš„æ–‡ä»¶æƒé™ exec æ—  æ—  åˆ—å‡ºéœ€è¦æ’é™¤çš„ç›®å½•å’Œæ–‡ä»¶ owner string æ—  è§£å‹åæ–‡ä»¶æˆ–ç›®å½•çš„å±ä¸» group srting æ—  è§£å‹åçš„ç›®å½•æˆ–æ–‡ä»¶çš„å±ç»„ EXAMPLES: - name: Extract foo.tgz into /var/lib/foo unarchive: src: foo.tgz dest: /var/lib/foo - name: Unarchive a file that is already on the remote machine unarchive: src: /tmp/foo.zip dest: /usr/local/bin remote_src: yes - name: Unarchive a file that needs to be downloaded (added in 2.0) unarchive: src: https://example.com/example.zip dest: /usr/local/bin remote_src: yes - name: Unarchive a file with extra options unarchive: src: /tmp/foo.zip dest: /usr/local/bin extra_opts: - --transform - s/^xxx/yyy/ ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:16","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"uri ç”¨äºè¯·æ±‚æŸä¸ªç½‘é¡µ å¸¸è§å‚æ•°ï¼š å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ body raw null å½“body_formatè®¾ç½®ä¸ºjsonæ—¶çš„é”®å€¼å¯¹ body_format string raw æ•°æ®æ ¼å¼ï¼Œform-urlencoded, json, raw method string GET æŒ‡æ˜è¯·æ±‚çš„æ–¹æ³•ï¼Œå¦‚GETã€POST, PUT, DELETE, HEAD dest string null ä¸‹è½½æ–‡ä»¶çš„è·¯å¾„ force bool False force_basic_auth headers method æŒ‡æ˜è¯·æ±‚çš„æ–¹æ³•ï¼Œå¦‚GETã€POST, PUT, DELETE, HEAD return_content bool False url string null url_password å¦‚æœè¯·æ±‚çš„urléœ€è¦è®¤è¯ï¼Œåˆ™å¡«å†™è®¤è¯çš„å¯†ç  url_username å¦‚æœè¯·æ±‚çš„urléœ€è¦è®¤è¯ï¼Œåˆ™å¡«å†™ç”¨æˆ·å [root@master ~]# ansible test -m url -a 'url=http://192.168.100.102/index.html' 192.168.100.102 | SUCCESS =\u003e { \"accept_ranges\": \"bytes\", \"changed\": false, \"connection\": \"close\", \"content_length\": \"612\", \"content_type\": \"text/html\", \"date\": \"Fri, 02 Dec 2016 06:31:58 GMT\", \"etag\": \"\\\"571f8501-264\\\"\", \"last_modified\": \"Tue, 26 Apr 2016 15:10:57 GMT\", \"msg\": \"OK (612 bytes)\", \"redirected\": false, \"server\": \"nginx/1.10.0\", \"status\": 200, \"url\": \"http://192.168.100.102/index.html\" } [root@master ~]# EXAMPLES: - name: Check that you can connect (GET) to a page and it returns a status 200 uri: url: http://www.example.com - name: Check that a page returns a status 200 and fail if the word AWESOME is not in the page contents uri: url: http://www.example.com return_content: yes register: this failed_when: \"'AWESOME' not in this.content\" - name: Create a JIRA issue uri: url: https://your.jira.example.com/rest/api/2/issue/ user: your_username password: your_pass method: POST body: \"{{ lookup('file','issue.json') }}\" force_basic_auth: yes status_code: 201 body_format: json - name: Login to a form based webpage, then use the returned cookie to access the app in later tasks uri: url: https://your.form.based.auth.example.com/index.php method: POST body_format: form-urlencoded body: name: your_username password: your_password enter: Sign in status_code: 302 register: login - name: Login to a form based webpage using a list of tuples uri: url: https://your.form.based.auth.example.com/index.php method: POST body_format: form-urlencoded body: - [ name, your_username ] - [ password, your_password ] - [ enter, Sign in ] status_code: 302 register: login - name: Connect to website using a previously stored cookie uri: url: https://your.form.based.auth.example.com/dashboard.php method: GET return_content: yes headers: Cookie: \"{{ login.set_cookie }}\" - name: Queue build of a project in Jenkins uri: url: http://{{ jenkins.host }}/job/{{ jenkins.job }}/build?token={{ jenkins.token }} user: \"{{ jenkins.user }}\" password: \"{{ jenkins.password }}\" method: GET force_basic_auth: yes status_code: 201 - name: POST from contents of local file uri: url: https://httpbin.org/post method: POST src: file.json - name: POST from contents of remote file uri: url: https://httpbin.org/post method: POST src: /path/to/my/file.json remote_src: yes - name: Pause play until a URL is reachable from this host uri: url: \"http://192.0.2.1/some/test\" follow_redirects: none method: GET register: _result until: _result.status == 200 retries: 720 # 720 * 5 seconds = 1hour (60*60/5) delay: 5 # Every 5 seconds # There are issues in a supporting Python library that is discussed in # https://github.com/ansible/ansible/issues/52705 where a proxy is defined # but you want to bypass proxy use on CIDR masks by using no_proxy - name: Work around a python issue that doesn't support no_proxy envvar uri: follow_redirects: none validate_certs: false timeout: 5 url: \"http://{{ ip_address }}:{{ port | default(80) }}\" register: uri_data failed_when: false changed_when: false vars: ip_address: 192.0.2.1 environment: | { {% for no_proxy in (lookup('env', 'no_proxy') | regex_replace('\\s*,\\s*', ' ') ).split() %} {% if no_proxy | regex_search('\\/') and no_proxy | ipaddr('net') != '' and no_proxy | ipaddr('net') != false and ip_address | ipaddr(no_proxy) is not none and ip_address | ipaddr(no_proxy) != false %} 'no_proxy': '{{ ip_address }}' {% elif no_proxy | regex_search(':') != '' and no_proxy | regex_search(':') != false and no_proxy == ip_address + ':' + (port | default(80)) %} 'no_proxy': '{{ ip_address }","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:17","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"group ç”¨æ¥æ·»åŠ æˆ–åˆ é™¤è¿œç«¯ä¸»æœºçš„ç”¨æˆ·ç»„ å¸¸è§å‚æ•°ï¼š å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ name string null state string present gid int null GID system bool False åˆ›å»ºç³»ç»Ÿç”¨æˆ· [root@master ~]# ansible test -m group -a 'name=hr gid=2000 state=present' 192.168.100.102 | SUCCESS =\u003e { \"changed\": true, \"gid\": 2000, \"name\": \"hr\", \"state\": \"present\", \"system\": false } [root@master ~]# ansible test -m shell -a 'tail -1 /etc/group' 192.168.100.102 | SUCCESS | rc=0 \u003e\u003e hrâŒ2000: ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:18","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"user ç®¡ç†è¿œç¨‹ä¸»æœºä¸Šçš„ç”¨æˆ·çš„è´¦å· å¸¸è§å‚æ•°ï¼š å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ name string null æŒ‡æ˜è¦ç®¡ç†çš„è´¦å·åç§° state string present æŒ‡æ˜æ˜¯åˆ›å»ºè´¦å·è¿˜æ˜¯åˆ é™¤è´¦å·ï¼Œpresentè¡¨ç¤ºåˆ›å»ºï¼Œabsentè¡¨ç¤ºåˆ é™¤ system bool False æŒ‡å®šç³»ç»Ÿç”¨æˆ· uid int null ç”¨æˆ·çš„uid shell string null shellç±»å‹ home string null å®¶ç›®å½•ä½ç½® group string null æŒ‡æ˜ç”¨æˆ·çš„åŸºæœ¬ç»„ groups string null æŒ‡æ˜ç”¨æˆ·çš„é™„åŠ ç»„ move_home bool False å½“homeè®¾å®šäº†å®¶ç›®å½•ï¼Œå¦‚æœè¦åˆ›å»ºçš„å®¶ç›®å½•å·²å­˜åœ¨ï¼Œæ˜¯å¦å°†å·²å­˜åœ¨çš„å®¶ç›®å½•è¿›è¡Œç§»åŠ¨ password string null æŒ‡æ˜ç”¨æˆ·çš„å¯†ç ï¼Œæœ€å¥½ä½¿ç”¨åŠ å¯†å¥½çš„å­—ç¬¦ä¸² comment string null æŒ‡æ˜ç”¨æˆ·çš„æ³¨é‡Šä¿¡æ¯ remove bool null å½“state=absentæ—¶ï¼Œä¹Ÿå°±æ˜¯åˆ é™¤ç”¨æˆ·æ—¶ï¼Œæ˜¯å¦è¦åˆ é™¤ç”¨æˆ·çš„è€Œå®¶ç›®å½• [root@master ~]# ansible test -m user -a 'name=martin group=hr groups=shichang uid=500 shell=/bin/bash home=/home/martin comment=\"martin user\"' 192.168.100.102 | SUCCESS =\u003e { \"changed\": true, \"comment\": \"martin user\", \"createhome\": true, \"group\": 2000, \"groups\": \"shichang\", \"home\": \"/home/martin\", \"name\": \"martin\", \"shell\": \"/bin/bash\", \"state\": \"present\", \"system\": false, \"uid\": 500 } [root@master ~]# ansible test -m shell -a 'grep \"martin:\" /etc/passwd' 192.168.100.102 | SUCCESS | rc=0 \u003e\u003e martinâŒ500:2000:martin user:/home/martin:/bin/bash [root@master ~]# ansible test -m user -a 'name=martin state=absent remove=yes' 192.168.100.102 | SUCCESS =\u003e { \"changed\": true, \"force\": false, \"name\": \"martin\", \"remove\": true, \"state\": \"absent\" } EXAMPLES: - name: Add the user 'johnd' with a specific uid and a primary group of 'admin' user: name: johnd comment: John Doe uid: 1040 group: admin - name: Add the user 'james' with a bash shell, appending the group 'admins' and 'developers' to the user's gro user: name: james shell: /bin/bash groups: admins,developers append: yes - name: Remove the user 'johnd' user: name: johnd state: absent remove: yes - name: Create a 2048-bit SSH key for user jsmith in ~jsmith/.ssh/id_rsa user: name: jsmith generate_ssh_key: yes ssh_key_bits: 2048 ssh_key_file: .ssh/id_rsa - name: Added a consultant whose account you want to expire user: name: james18 shell: /bin/zsh groups: developers expires: 1422403387 - name: Starting at Ansible 2.6, modify user, remove expiry time user: name: james18 expires: -1 ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:19","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"script å°†ç®¡ç†ç«¯çš„æŸä¸ªè„šæœ¬ï¼Œç§»åŠ¨åˆ°è¿œç«¯ä¸»æœº(ä¸éœ€è¦æŒ‡æ˜ä¼ é€’åˆ°è¿œç«¯ä¸»æœºçš„å“ªä¸ªè·¯å¾„ä¸‹ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç§»åŠ¨ï¼Œç„¶åæ‰§è¡Œ)ï¼Œ ä¸€èˆ¬æ˜¯è‡ªåŠ¨ç§»åŠ¨åˆ°è¿œç«¯ä¸»æœºçš„/root/.ansible/tmpç›®å½•ä¸‹ï¼Œç„¶åè‡ªåŠ¨ç»™äºˆå…¶æƒé™ï¼Œç„¶åå†å¼€ä¸ªå­shellç„¶åè¿è¡Œè„šæœ¬ï¼Œè¿è¡Œå®Œæˆååˆ é™¤è„šæœ¬ [root@master ~]# ansible test -m script -a '/root/1.sh' 192.168.100.102 | SUCCESS =\u003e { \"changed\": true, \"rc\": 0, \"stderr\": \"\", \"stdout\": \"\", \"stdout_lines\": [] } [root@master ~]# ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:20","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"setup å¯æ”¶é›†è¿œç¨‹ä¸»æœºçš„factså˜é‡çš„ä¿¡æ¯ï¼Œç›¸å½“äºæ”¶é›†äº†ç›®æ ‡ä¸»æœºçš„ç›¸å…³ä¿¡æ¯(å¦‚å†…æ ¸ç‰ˆæœ¬ã€æ“ä½œç³»ç»Ÿä¿¡æ¯ã€cpuã€â€¦)ï¼Œä¿å­˜åœ¨ansibleçš„å†…ç½®å˜é‡ä¸­ï¼Œä¹‹åæˆ‘ä»¬æœ‰éœ€è¦ç”¨åˆ°æ—¶ï¼Œç›´æ¥è°ƒç”¨å˜é‡å³å¯ [root@master ~]# ansible test -m setup 192.168.100.102 | SUCCESS =\u003e { \"ansible_facts\": { \"ansible_all_ipv4_addresses\": [ \"192.168.100.102\" ], \"ansible_all_ipv6_addresses\": [ \"fe80::20c:29ff:fe0c:5ab9\" ], \"ansible_architecture\": \"x86_64\", \"ansible_bios_date\": \"05/20/2014\", \"ansible_bios_version\": \"6.00\", ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:21","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"template åŸºäºæ¨¡æ¿æ–¹å¼ï¼Œç”Ÿæˆä¸€ä¸ªæ¨¡æ¿æ–‡ä»¶ï¼Œå¤åˆ¶åˆ°è¿œç¨‹ä¸»æœºï¼Œè®©è¿œç¨‹ä¸»æœºåŸºäºæ¨¡æ¿ï¼Œç”Ÿæˆç¬¦åˆè¿œç¨‹ä¸»æœºè‡ªèº«çš„æ–‡ä»¶ æ³¨æ„ï¼šæ­¤æ¨¡å—ä¸èƒ½åœ¨å‘½ä»¤è¡Œä½¿ç”¨ï¼Œåªèƒ½ç”¨åœ¨playbookä¸­ å¸¸è§å‚æ•°ï¼š src= æŒ‡æ˜ç®¡ç†ç«¯æœ¬åœ°çš„æ¨¡æ¿æ–‡ä»¶çš„ç›®å½• dest= æŒ‡æ˜å°†æ¨¡æ¿æ–‡ä»¶æ‹·è´åˆ°è¿œç¨‹ä¸»æœºçš„å“ªä¸ªç›®å½•ä¸‹ owner= æŒ‡æ˜æ‹·è´åˆ°è¿œç¨‹ä¸»æœºçš„æ–‡ä»¶çš„å±ä¸» group= æŒ‡æ˜æ‹·è´åˆ°è¿œç¨‹ä¸»æœºçš„æ–‡ä»¶çš„å±ç»„ mode= æŒ‡æ˜æ‹·è´åˆ°è¿œç¨‹ä¸»æœºçš„æ–‡ä»¶çš„æƒé™ [root@master ~]# cat temp.txt this is {{ ansible_hostname }} [root@master ~]# cat test.yml - hosts: 192.168.10.202 remote_user: root tasks: - name: test template template: src=/root/temp.txt dest=/tmp [root@master ~]# ansible-playbook test.yml PLAY [192.168.10.202] ********************************************************** TASK [setup] ******************************************************************* ok: [192.168.10.202] TASK [test template module] **************************************************** changed: [192.168.10.202] PLAY RECAP ********************************************************************* 192.168.10.202 : ok=2 changed=1 unreachable=0 failed=0 [root@master ~]# ansible 192.168.10.202 -m shell -a 'cat /tmp/temp.txt' 192.168.10.202 | SUCCESS | rc=0 \u003e\u003e this is agent202 ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:22","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"script script æ¨¡å—å¯ä»¥åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œ ansible ç®¡ç†ä¸»æœºä¸Šçš„è„šæœ¬ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè„šæœ¬ä¸€ç›´å­˜åœ¨äº ansible ç®¡ç†ä¸»æœºæœ¬åœ°ï¼Œä¸éœ€è¦æ‰‹åŠ¨æ‹·è´åˆ°è¿œç¨‹ä¸»æœºåå†æ‰§è¡Œã€‚ å¸¸ç”¨å‚æ•°ï¼š chdirï¼šæ‰§è¡Œè„šæœ¬æ—¶æ‰€åœ¨çš„ç›®å½• createsï¼šä½¿ç”¨æ­¤å‚æ•°æŒ‡å®šä¸€ä¸ªè¿œç¨‹ä¸»æœºä¸­çš„æ–‡ä»¶ï¼Œå½“æŒ‡å®šçš„æ–‡ä»¶å­˜åœ¨æ—¶ï¼Œå°±ä¸æ‰§è¡Œå¯¹åº”è„šæœ¬ removesï¼šä½¿ç”¨æ­¤å‚æ•°æŒ‡å®šä¸€ä¸ªè¿œç¨‹ä¸»æœºä¸­çš„æ–‡ä»¶ï¼Œå½“æŒ‡å®šçš„æ–‡ä»¶ä¸å­˜åœ¨æ—¶ï¼Œå°±ä¸æ‰§è¡Œå¯¹åº”è„šæœ¬ ç¤ºä¾‹ï¼š - name: Run a script with arguments (free form) script: /some/local/script.sh ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:23","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"lineinfile å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ path string null æ“ä½œçš„æ–‡ä»¶ line string null æ›¿æ¢çš„å†…å®¹ regexp string null åŒ¹é…è¡¨è¾¾å¼ state present|absent present insertafter string æ—  æ’å…¥åˆ°åŒ¹é…è¡Œå insertbefore string æ—  æ’å…¥åŒ¹é…è¡Œå‰ backup yes|no æ—  æ”¹å˜å‰å¤‡ä»½ ç¤ºä¾‹ï¼šå¼€å¯selinux - name: Ensure SELinux is set to enforcing mode lineinfile: path: /etc/selinux/config regexp: '^SELINUX=' line: SELINUX=enforcing - name: Make sure group wheel is not in the sudoers configuration lineinfile: path: /etc/sudoers state: absent regexp: '^%wheel' - name: Replace a localhost entry with our own lineinfile: path: /etc/hosts regexp: '^127\\.0\\.0\\.1' line: 127.0.0.1 localhost owner: root group: root mode: '0644' ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:24","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"fail å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ msg string null æ»¡è¶³æ¡ä»¶æ‰§è¡Œæ—¶è¾“å‡ºçš„ä¿¡æ¯ - fail: msg: The system may not be provisioned according to the CMDB status. when: cmdb_status != \"to-be-staged\" ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:25","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"stat æ£€æŸ¥æ–‡ä»¶æˆ–æ–‡ä»¶ç³»ç»Ÿçš„çŠ¶æ€ï¼Œå¯¹äºWindowsç›®æ ‡ï¼Œåˆ™ä½¿ç”¨win_statæ¨¡å— å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ path string null æ–‡ä»¶æˆ–ç›®å½•çš„è·¯å¾„ï¼Œå¿…é€‰å‚æ•° checksum_algorithm string sha1 è®¡ç®—æ–‡ä»¶çš„ç®—æ³•ï¼Œå¯é€‰md5, sha1, sha224, sha256, sha384, sha512 statæ¨¡å—çš„è¿”å›å€¼ è¿”å›å€¼ å–å€¼ exists bool path str mode str isdir bool islnk bool uid int gid int size int inode int lnk_source str md5 str ä½¿ç”¨ç¤ºä¾‹ - stat: path: /etc/foo.conf register: st - fail: msg: \"Whoops! file ownership has changed\" when: st.stat.pw_name != 'root' - stat: path: /path/to/something register: sym - debug: msg: \"islnk isn't defined (path doesn't exist)\" when: sym.stat.islnk is not defined - debug: msg: \"islnk is defined (path must exist)\" when: sym.stat.islnk is defined - debug: msg: \"Path exists and is a symlink\" when: sym.stat.islnk is defined and sym.stat.islnk - debug: msg: \"Path exists and isn't a symlink\" when: sym.stat.islnk is defined and sym.stat.islnk == False - stat: path: /path/to/something register: p - debug: msg: \"Path exists and is a directory\" when: p.stat.isdir is defined and p.stat.isdir # Don't do checksum - stat: path: /path/to/myhugefile get_checksum: no # Use sha256 to calculate checksum - stat: path: /path/to/something checksum_algorithm: sha256 ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:26","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"pause æš‚åœä¸€æ®µæ—¶é—´ç­‰å¾…ç»ˆç«¯è¾“å…¥ å‚æ•° å–å€¼ é»˜è®¤å€¼ è¯´æ˜ echo bool yes æ˜¯å¦è¾“å‡ºé”®ç›˜çš„è¾“å…¥å€¼ minutes string null æš‚åœå¤šå°‘åˆ†é’Ÿ prompt string null æ‰“å°ä¸€ä¸²ä¿¡æ¯æç¤ºç”¨æˆ·æ“ä½œ seconds string null æš‚åœå¤šå°‘ç§’ pauseæ¨¡å—çš„è¿”å›å€¼ è¿”å›å€¼ å–å€¼ delta string echo bool start string stdout string stop string user_input string ä½¿ç”¨ç¤ºä¾‹ - name: Pause for 5 minutes to build app cache pause: minutes: 5 - name: Pause until you can verify updates to an application were successful pause: - name: A helpful reminder of what to look out for post-update pause: prompt: \"Make sure org.foo.FooOverload exception is not present\" - name: Did you Backup DB pause: prompt=\"Did you commit it? Enter to continue or CTRL-C to quit.\" - name: Pause to get some sensitive input pause: prompt: \"Enter a secret\" echo: no ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:27","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"å…­ã€å˜é‡ # ä½¿ç”¨æ–‡ä»¶è¿›è¡Œä¼ å‚æ•° ansible-playbook site.yml -i hosts -e @env.yaml ","date":"2023-12-04","objectID":"/posts/2023-12-4-ansible-handbook/:3:28","tags":["ansible"],"title":"Ansible handbook","uri":"/posts/2023-12-4-ansible-handbook/"},{"categories":["DevOps"],"content":"Gitlab ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:0:0","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"ç‰ˆæœ¬ä»‹ç» gitlabåˆ†ç¤¾åŒºç‰ˆå’Œä¼ä¸šç‰ˆï¼Œä¸å…¶ä»–ä¼ä¸šç‰ˆè½¯ä»¶ä¸åŒçš„æ˜¯ï¼Œç¤¾åŒºç‰ˆå’Œä¼ä¸šç‰ˆéƒ½ä¸æ”¶è´¹ï¼Œéƒ½å¯ä»¥å…è´¹ä½¿ç”¨ å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.gitlab.com/ ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:1:0","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"æˆæƒæ¨¡å¼ GitLabåŸºäºå¼€æºæ ¸å¿ƒæ¨¡å‹ (open core model)ã€‚å³ä»¥ä¸ºç€Gitlabæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼šç¤¾åŒºç‰ˆCommunity Edition å’Œ ä¼ä¸šç‰ˆEnterprise Editionã€‚ GitLab ç¤¾åŒºç‰ˆæ˜¯MITè®¸å¯çš„open sourceã€‚ GitLab ä¼ä¸šç‰ˆåŸºäºç¤¾åŒºç‰ˆï¼šä½¿ç”¨äº†åŒæ ·çš„å†…æ ¸ï¼Œä½†æ˜¯æ·»åŠ äº†é¢å¤–çš„åŠŸèƒ½ã€ç‰¹æ€§ã€‚ è¿™æ˜¯åœ¨æ‰€æœ‰æƒæˆæƒä¸‹ã€‚ å¯¹äºæ‰€æœ‰çš„ç‰ˆæœ¬ï¼šGitlab æ‰€æœ‰çš„ javascript æºç  éƒ½æ˜¯ open source çš„ã€‚Gtilab å¼€å‘çš„æ‰€æœ‰çš„ javascript code éƒ½æ˜¯ MIT æˆæƒè®¸å¯ã€‚ ä¼ä¸šç‰ˆè™½ç„¶æ˜¯å…è´¹ä½¿ç”¨ï¼Œä½†å…è´¹ä½†åŠŸèƒ½è·Ÿç¤¾åŒºç‰ˆä¸€è‡´ã€‚ ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:1:1","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"ä¸€ã€éƒ¨ç½² ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:2:0","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"1ã€åŒ…éƒ¨ç½² 1ï¼‰ä¸‹è½½å®‰è£…åŒ… æ¸…åæºï¼šhttps://mirrors.tuna.tsinghua.edu.cn/gitlab-ce å—äº¬å¤§å­¦é•œåƒï¼šhttps://mirrors.nju.edu.cn/gitlab-ce/ gitlabå®‰è£…åŒ…æ¯”è¾ƒå¤§ï¼Œå»ºè®®å…ˆä¸‹è½½åˆ°æœ¬åœ°å†å®‰è£… [root@gitlab3 ~]# ls anaconda-ks.cfg gitlab-ce-12.9.7-ce.0.el7.x86_64.rpm [root@gitlab3 ~]# yum -y localinstall gitlab-ce-12.9.7-ce.0.el7.x86_64.rpm 2ï¼‰é…ç½®gitlab gitlabä½¿ç”¨chefè¿›è¡Œå®‰è£…ï¼Œé…ç½®æ–‡ä»¶ä¸º/etc/gitlab/gitlab.rb # é…ç½®è®¿é—®åœ°å€ [root@gitlab3 ~]# vim /etc/gitlab/gitlab.rb 29 external_url 'http://gitlab.example.com' # é…ç½®é€šçŸ¥é‚®ç®± # å®˜æ–¹é‚®ç®±é…ç½®ç¤ºä¾‹ï¼šhttps://docs.gitlab.com/omnibus/settings/smtp.html [root@gitlab1 ~]# vim /etc/gitlab/gitlab.rb gitlab_rails['smtp_enable'] = true gitlab_rails['smtp_address'] = \"smtphz.qiye.163.com\" gitlab_rails['smtp_port'] = 994 gitlab_rails['smtp_user_name'] = \"cccccc@163.com\" gitlab_rails['smtp_password'] = \"xxxxxxxxxx\" gitlab_rails['smtp_domain'] = \"qiye.163.com\" gitlab_rails['smtp_authentication'] = \"login\" gitlab_rails['smtp_enable_starttls_auto'] = true gitlab_rails['smtp_tls'] = true user['git_user_email'] = \"cccc@163.com\" gitlab_rails['gitlab_email_from'] = 'cccc@163.com' gitlab_rails['gitlab_email_reply_to'] = 'cccc@163.com' # é…ç½®é‡å¯æœåŠ¡ [root@gitlab1 ~]# gitlab-ctl stop [root@gitlab1 ~]# gitlab-ctl reconfigure [root@gitlab1 ~]# gitlab-ctl restart # æµ‹è¯•é‚®ä»¶å‘é€ [root@gitlab1 ~]# gitlab-rails console Notify.test_email('t@local.com','gitlab','this is test').deliver_now é‚®ç®± ä¸»é¢˜ å†…å®¹ ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:2:1","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"2ã€dockeréƒ¨ç½² ä½¿ç”¨dockeréƒ¨ç½²æ—¶å»ºè®®å…ˆä¿®æ”¹sshç«¯å£ï¼Œé¢„ç•™22ç»™gitlab docker run \\ -p 443:443 -p 80:80 -p 22:22 \\ --name gitlab \\ --volume /data/gitlab/config:/etc/gitlab \\ --volume /data/gitlab/logs:/var/log/gitlab \\ --volume /data/gitlab/data:/var/opt/gitlab \\ gitlab/gitlab-ce:13.12.9-ce.0 docker-compose version: '3' services: gitlab: image: gitlab/gitlab-ce:13.12.9-ce.0 container_name: gitlab restart: always privileged: true environment: TZ: 'Asia/Shanghai' GITLAB_OMNIBUS_CONFIG: | external_url = \"http://git.local.com\" ports: - '80:80' - '443:443' - '2222:22' volumes: - '/dataDisk/gitlab/config:/etc/gitlab' - '/dataDisk/gitlab/logs:/var/log/gitlab' - '/dataDisk/gitlab/data:/var/opt/gitlab' ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:2:2","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"äºŒã€é…ç½® 1ã€gitlabä¿®æ”¹url ï¼ˆå¦‚æœæ˜¯è¿ç§»æˆ–è€…é‡æ–°é…ç½®ï¼‰ 1ï¼‰ä¿®æ”¹gitlabçš„é…ç½®æ–‡ä»¶ [root@gitlab1 ~]# vim /etc/gitlab/gitlab.rb 30 external_url 'http://192.168.100.103' #ä¿®æ”¹ä¸ºåŸŸåæˆ–è€…IP 2ï¼‰ä¿®æ”¹git cloneçš„è·¯å¾„ æŸ¥çœ‹gitlab.ymlè½¯è¿æ¥çš„è·¯å¾„ [root@gitlab1 ~]# cd /opt/gitlab/embedded/service/gitlab-rails/config lrwxrwxrwx 1 root root 43 Jun 19 15:23 gitlab.yml -\u003e /var/opt/gitlab/gitlab-rails/etc/gitlab.yml [root@gitlab1 config]# vim /var/opt/gitlab/gitlab-rails/etc/gitlab.yml 10 ## GitLab settings 11 gitlab: 12 ## Web server settings (note: host is the FQDN, do not include http://) 13 host: 192.168.100.103 #gitlabç™»é™†åè®¿é—®çš„è·¯å¾„ 14 port: 80 15 https: false 3ï¼‰é‚®ç®±é…ç½® å®˜æ–¹é‚®ç®±é…ç½®ç¤ºä¾‹ï¼šhttps://docs.gitlab.com/omnibus/settings/smtp.html åœæ­¢æœåŠ¡ [root@gitlab1 ~]# gitlab-ctl stop é‡æ–°é…ç½® [root@gitlab1 ~]# gitlab-ctl reconfigure é‡å¯æœåŠ¡ [root@gitlab1 ~]# gitlab-ctl restart æµ‹è¯•é‚®ä»¶å‘é€ [root@gitlab1 ~]# gitlab-rails console Notify.test_email('t@local.com','gitlab','this is test').deliver_now é‚®ç®± ä¸»é¢˜ å†…å®¹ ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:3:0","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"ä¸‰ã€gitlab-runner ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:4:0","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"1ã€åŒ…å®‰è£… 1ï¼‰ä¸‹è½½å’Œå®‰è£… [root@gitlab1 ~]# yum -y install https://mirror.nju.edu.cn/gitlab-runner/yum/el8-x86_64/gitlab-runner-14.8.3-1.x86_64.rpm [root@gitlab1 ~]# yum -y install git 2ï¼‰æ³¨å†Œgitlab-runner [root@gitlab1 ~]# gitlab-runner register \\ --non-interactive \\ --executor \"shell\" \\ --url \"http://192.168.23.100/\" \\ --registration-token \"JRzzw2j1Ji6aBjwvkxAv\" \\ --description \"xxxxx-devops-runner\" \\ --tag-list \"build,deploy,runner-shell,runner\" \\ --run-untagged=\"true\" \\ --locked=\"false\" \\ --access-level=\"not_protected\" ä¼šè¦æ±‚è¾“å…¥gitlabçš„urlå’ŒToken. æŸ¥æ‰¾è¿‡ç¨‹å¦‚ä¸‹ï¼š è¿›å…¥ä»“åº“-\u003esettings-\u003eCI/CDï¼Œæ‰¾åˆ°Runner Settingsè¿™ä¸€é¡¹ï¼Œç‚¹å‡»Expend,å³å¯åœ¨Setup a specific Runner manuallyè¿™é¡¹ä¸­æ‰¾åˆ°ã€‚ æ³¨å†Œå®ŒåæŸ¥çœ‹runnerçŠ¶æ€ è¿›å…¥ä»“åº“-\u003esettings-\u003eCI/CDï¼Œæ‰¾åˆ°Runner Settingsè¿™ä¸€é¡¹ï¼Œç‚¹å‡»Expend,å³å¯çœ‹åˆ°Gitlab-Runenrçš„è¿è¡ŒçŠ¶æ€ ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:4:1","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"2ã€dockerå®‰è£… version: \"3\" services: gitrunner: image: 'gitlab/gitlab-runner:ubuntu-v15.8.3' container_name: \"gitlab-runner\" restart: always command: \"run --user=root --working-directory=/home/gitlab-runner\" volumes: - '/data/gitlab-runner/config:/etc/gitlab-runner' - '/data/gitlab-runner/cache:/tmp/cache' # - '/data/gitlab-runner/ssl:/etc/gitlab-runner/certs/' - '/usr/bin/docker:/usr/bin/docker' - '/var/run/docker.sock:/var/run/docker.sock' æ³¨å†Œ docker exec -it gitlab-runner gitlab-runner register --non-interactive --executor \"shell\" --url \"http://local.com\" --registration-token \"XmWa6cccc-ccccccc\" --description \"runner\" --tag-list \"docker-runner,gitlab-runner-shell,runner\" --run-untagged=\"true\" --locked=\"false\" --access-level=\"not_protected\" runner in docker docker exec -it gitlab-runner gitlab-runner register --non-interactive --executor \"docker\" --docker-image=debian:11 --url \"http://local.com\" --registration-token \"XmWa6cccc-ccccccc\" --description \"docker-runner\" --tag-list \"docker-runner,gitlab-runner-docker\" --run-untagged=\"true\" --locked=\"false\" --access-level=\"not_protected\" ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:4:2","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"3ã€.gitlab-ci.yml æ¨¡ç‰ˆ default: image: 'centos:7' before_script: - echo Hello World after_script: - echo end tags: gitlab-runner-shell # æŒ‡å®šgitlab runner çš„tag cache: paths: [vendor/] DEPLOY_VARIABLE: \"default-deploy\" variables: IMAGE: name/${CI_PROJECT_NAMESPACE}-${CI_PROJECT_NAME} workflow: rules: - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH variables: DEPLOY_VARIABLE: \"deploy-production\" # Override globally-defined DEPLOY_VARIABLE - if: $CI_COMMIT_REF_NAME =~ /feature/ variables: IS_A_FEATURE: \"true\" # Define a new variable. - when: always stages: - test - build - package - deploy - cleanup test_all: image: \"pymicro\" pull_policy: if-not-present stage: test services: - name: my-postgres:11.7 alias: db-postgres pull_policy: if-not-present entrypoint: [\"/usr/local/bin/db-postgres\"] command: [\"start\"] veriables: MYSQL_DATABASE: db MYSQL_ROOT_PASSWORD: password allow_failure: true # job å…è®¸å¤±è´¥ before_script: - 'command -v ssh-agent \u003e/dev/null || ( apt-get update -y \u0026\u0026 apt-get install openssh-client -y )' - eval $(ssh-agent -s) - echo \"$SSH_PRIVATE_KEY\" | tr -d '\\r' | ssh-add - - mkdir -p ~/.ssh - chmod 700 ~/.ssh - echo -e \"Host *\\n\\tStrictHostKeyChecking no\\n\\n\" \u003e ~/.ssh/config' script: - flake8 app - pytest tests after_script: - execute this after my script # æ‰§è¡Œå‘½ä»¤ build_image: image: name docker:17.11 pull_policy: always # if-not-present #entrypoint: [\"echo hellow-world\"] #è¦†ç›– entrypointå‘½ä»¤ # command: [\"start\"] è¦†ç›–commandå‘½ä»¤ stage: build services: - name: my-postgres:11.7 alias: db-postgres entrypoint: [\"/usr/local/bin/db-postgres\"] command: [\"start\"] variables: DOCKER_HOST: tcp://dockerd:2375 # ç¼“å­˜ binaries ä¸­ä»¥ .apk å’Œ .config æ–‡ä»¶ç»“å°¾çš„æ‰€æœ‰æ–‡ä»¶ï¼š cache: key: binaries-cache paths: - binaries/*.apk - .config only: - master tags: - build script: - | docker build -t ${IMAGE_TAG} -f Dockerfile . docker push ${IMAGE_TAG} package_app: stage: build rules: - if: $CI_COMMIT_MESSAGE =~ /build-app-a/ variables: GITLAB_app_NAME: gitea-drone - if: $CI_COMMIT_MESSAGE =~ /build-app-b/ variables: GITLAB_app_NAME: gitea-drone-b - if: '$CI_PIPELINE_SOURCE == \"merge_request_event\"' changes: - Dockerfile when: manual allow_failure: true - if: $CI_PIPELINE_SOURCE == \"merge_request_event\" changes: paths: - Dockerfile - exists: - Dockerfile before_script: - hello script: - echo \"${GITLAB_app_NAME}\" after_script: - echo \"world\" allow_failure: exit_codes: - 137 - 255 # å½“Gemfile.lockæœ‰å˜åŒ–æ—¶å€™ï¼Œé‡æ–°ç”Ÿæˆç¼“å­˜ cache: key: files: - Gemfile.lock - package.json paths: - vendor/ruby - node_modules last-job: stage: .post script: - echo \"This job runs in the .post stage, after all other stages.\" deploy_production: stage: deploy variables: GIT_STRATEGY: none needs: - job: test-job2 optional: true - job: test-job1 # only/except only: # - master - main - /^issue-.*$/ - merge_requests - tags variables: - $RELEASE == \"staging\" refs: - branches changes: - Dockerfile - docker/scripts/ allow_failure: true when: manual tags: - deploy-production script: - kubectl set image deploy/myproject \"app=${IMAGE_TAG}\" --record cache: untracked: true # æ¥ç¼“å­˜ Git ä»“åº“ä¸­æ‰€æœ‰æœªè·Ÿè¸ªçš„æ–‡ä»¶ paths: - binaries/ cleanup_job: stage: cleanup script: - cleanup after jobs when: always å†…ç½®å˜é‡ï¼Œå‚è€ƒåœ°å€ï¼šhttps://docs.gitlab.cn/jh/ci/variables/predefined_variables.html å˜é‡ GitLab Runner æè¿° CHAT_CHANNEL 10.6 all è§¦å‘ ChatOps å‘½ä»¤çš„æºèŠå¤©é¢‘é“ã€‚ CHAT_INPUT 10.6 all ä½¿ç”¨ ChatOps å‘½ä»¤ä¼ é€’çš„é™„åŠ å‚æ•°ã€‚ CHAT_USER_ID 14.4 all è§¦å‘ ChatOps å‘½ä»¤çš„ç”¨æˆ·çš„èŠå¤©æœåŠ¡ç”¨æˆ· IDã€‚ CI all 0.4 é€‚ç”¨äºåœ¨ CI/CD ä¸­æ‰§è¡Œçš„æ‰€æœ‰ä½œä¸šã€‚å¯ç”¨æ—¶ä¸º trueã€‚ CI_API_V4_URL 11.7 all GitLab API v4 æ ¹ URLã€‚ CI_BUILDS_DIR all 11.10 æ‰§è¡Œæ„å»ºçš„é¡¶çº§ç›®å½•ã€‚ CI_COMMIT_AUTHOR 13.11 all Name \u003cemail\u003e æ ¼å¼çš„æäº¤ä½œè€…ã€‚ CI_COMMIT_BEFORE_SHA 11.2 all å‡ºç°åœ¨åˆ†æ”¯æˆ–æ ‡ç­¾ä¸Šçš„ä¸Šä¸€ä¸ªæœ€æ–°æäº¤ã€‚åœ¨åˆå¹¶è¯·æ±‚çš„æµæ°´çº¿ä¸­æ€»æ˜¯ 0000000000000000000000000000000000000000ã€‚ CI_COMMIT_BRANCH 12.6 0.5 æäº¤åˆ†æ”¯åç§°ã€‚åœ¨åˆ†æ”¯æµæ°´çº¿ä¸­å¯ç”¨ï¼ŒåŒ…æ‹¬é»˜è®¤åˆ†æ”¯çš„æµæ°´çº¿ã€‚åœ¨åˆå¹¶è¯·æ±‚æµæ°´çº¿æˆ–æ ‡ç­¾æµæ°´çº¿ä¸­ä¸å¯ç”¨ã€‚ CI_COMMIT_DESCRIPTION 10.8 all æäº¤çš„æè¿°ã€‚å¦‚æœæ ‡é¢˜çŸ­äº 100 ä¸ªå­—ç¬¦ï¼Œåˆ™æ¶ˆæ¯æ²¡æœ‰ç¬¬ä¸€è¡Œã€‚ CI_COMMIT_MESSAGE 10.8 all å®Œæ•´çš„æäº¤æ¶ˆæ¯ã€‚ CI_COMMIT_REF_NAME 9.0 all ä¸ºå…¶æ„å»ºé¡¹ç›®çš„åˆ†æ”¯æˆ–æ ‡ç­¾åç§°ã€‚ CI_COMMIT_REF_PROTECTED 11.11 all å¦‚æœä½œä¸šæ­£åœ¨è¿è¡Œä»¥è·å–å—ä¿æŠ¤çš„ ref ä¸º true ã€‚ CI_COMMIT_REF_SLUG 9.0 all CI_COMMIT_REF_NAME å°å†™ï¼Œç¼©çŸ­ä¸º 63 å­—èŠ‚ï¼Œé™¤äº† 0-9 å’Œ a-z ä¹‹å¤–çš„æ‰€æœ‰å†…å®¹éƒ½æ›¿æ¢ä¸º -ã€‚æ²¡æœ‰å‰","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:4:3","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"å››ã€å¤‡ä»½ä¸æ¢å¤ ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:5:0","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"1ã€å¤‡ä»½ [root@gitlab1 ~]# gitlab-rake gitlab:backup:create ä½¿ç”¨ä»¥ä¸Šå‘½ä»¤ä¼šåœ¨/var/opt/gitlab/backupsç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåç§°ç±»ä¼¼ä¸º1530156812_2018_06_28_10.8.4_gitlab_backup.tarçš„å‹ç¼©åŒ…, è¿™ä¸ªå‹ç¼©åŒ…å°±æ˜¯Gitlabæ•´ä¸ªçš„å®Œæ•´éƒ¨åˆ†, å…¶ä¸­å¼€å¤´çš„1530156812_2018_06_28_10.8.4æ˜¯å¤‡ä»½åˆ›å»ºçš„æ—¥æœŸ ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:5:1","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"2ã€æ•°æ®æ¢å¤ [root@gitlab1 ~]# gitlab-ctl stop unicorn [root@gitlab1 ~]# gitlab-ctl stop sidekiq å¤‡ä»½æ–‡ä»¶å¢åŠ 777æƒé™ï¼Œå¹¶ä¸”æ–‡ä»¶éœ€è¦å­˜æ”¾åœ¨/var/opt/gitlab/backupsé‡Œ [root@gitlab1 ~]# gitlab-rake gitlab:backup:restore BACKUP=1530156812_2018_06_28_10.8.4 # è¾“å…¥ä¸¤æ¬¡yes å¯åŠ¨æœåŠ¡ [root@gitlab1 ~]# gitlab-ctl restart ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:5:2","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"äº”ã€å‡çº§ æ³¨æ„ï¼šç”±äºå‡çº§ä¸èƒ½è·¨è¶Šå¤§ç‰ˆæœ¬å·ï¼Œå› æ­¤åªèƒ½å‡çº§åˆ°å½“å‰å¤§ç‰ˆæœ¬å·åˆ°æœ€é«˜ç‰ˆæœ¬ï¼Œæ–¹å¯å‡çº§åˆ°ä¸‹ä¸€ä¸ªå¤§ç‰ˆæœ¬å·ã€‚ gitlabçš„è·¨ç‰ˆæœ¬å‡çº§éœ€è¦å‡çº§ä¸­é—´å¤šä¸ªå°ç‰ˆæœ¬ï¼Œä¸ºäº†æ–¹ä¾¿å‡çº§ï¼Œå¯ä»¥åŸºäºdockerå‡çº§ã€‚ version: '3' services: gitlab: image: gitlab/gitlab-ce:12.9.7-ce.0 container_name: gitlab restart: always privileged: true environment: TZ: 'Asia/Shanghai' GITLAB_OMNIBUS_CONFIG: | external_url = \"http://git.local.com\" ports: - '80:80' - '443:443' - '2222:22' volumes: - '/dataDisk/gitlab/config:/etc/gitlab' - '/dataDisk/gitlab/logs:/var/log/gitlab' - '/dataDisk/gitlab/data:/var/opt/gitlab' networks: - gitlab networks: gitlab: ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:6:0","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"æ•°æ®å¤‡ä»½ # å¤‡ä»½äº§ç”Ÿç›®å½• /var/opt/gitlab/backups/ gitlab-rake gitlab:backup:create # å®¹å™¨å¤‡ä»½ sudo docker exec -t gitlab gitlab-rake gitlab:backup:create ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:6:1","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"è¿ç§» ### é…ç½®æ–‡ä»¶è¯´æ˜ # åŸæœ¬ï¼š /etc/gitlab/gitlab.rb # å®¹å™¨ï¼š /data/gitlab/config/gitlab.rb # æˆæƒå¤‡ä»½æ–‡ä»¶ scp 1586766848_2020_04_13_10.3.3_gitlab_backup.tar root@10.0.0.2:/var/opt/gitlab/backups/ chown 777 /var/opt/gitlab/backups/1586766848_2020_04_13_10.3.3_gitlab_backup.tar # åŠ è½½å¤‡ä»½è·¯å¾„ é»˜è®¤ /var/opt/gitlab/backups vim /data/gitlab/config/gitlab.rb gitlab_rails['backup_path'] = \"/var/opt/gitlab/backups\" gitlab_rails['backup_archive_permissions'] = 0644 gitlab_rails['backup_keep_time'] = 864000 # é‡è½½é…ç½® docker exec -t gitlab gitlab-ctl reconfigure # åœæ­¢æ•°æ®åº“è¿›ç¨‹ docker exec -t gitlab gitlab-ctl status docker exec -t gitlab gitlab-ctl stop puma docker exec -t gitlab gitlab-ctl stop sidekiq docker exec -t gitlab gitlab-ctl status # æ¢å¤å¤‡ä»½æ–‡ä»¶ ï¼ˆè¾“å…¥ä¸¤æ¬¡yesï¼‰ docker exec -ti gitlab bash docker exec -t gitlab gitlab-rake gitlab:backup:restore BACKUP=1586766848_2020_04_13_10.3.3 gitlab-backup restore BACKUP=11493107454_2018_04_25_10.6.4-ce # é‡å¯ä¸æ£€æµ‹ docker exec -t gitlab gitlab-ctl restart docker exec -t gitlab gitlab-rake gitlab:check SANITIZE=true ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:6:2","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼š å…¬é’¥ä¸å—ä¿¡ä»»ï¼Œè¦ä¹ˆæŒ‰æç¤ºéœ€è¦è¾“å…¥yesï¼Œè¦ä¹ˆæŠŠconfigä¹Ÿè¿›è¡Œè¿ç§» ssh -T git@local.com ç½‘é¡µè®¿é—®502 åœ¨é‡å¯gitlabåè®¿é—®å‡ºç°502 åŸå› æ˜¯nginxç”¨æˆ·æ— æ³•è®¿é—®gitlabç”¨æˆ·çš„socketæ–‡ä»¶ã€‚ é‡å¯gitlabéœ€è¦é‡æ–°æˆæƒ [root@gitlab1 ~]# chmod -R o+x /var/opt/gitlab/gitlab-rails å…³é—­æµè§ˆå™¨å†é‡æ–°è®¿é—® ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:6:3","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["DevOps"],"content":"äº”ã€ç”¨æˆ·å¯†ç ç®¡ç† é‡ç½®ç®¡ç†å‘˜å¯†ç  1ï¼‰gitlab-rails console 2ï¼‰user = User.where(@root).first 3ï¼‰user.password=â€˜imausâ€™ 4ï¼‰user.save! root@9e2af9b54092:/# gitlab-rails console -------------------------------------------------------------------------------- GitLab: 15.1.6 (f1452cd5cf4) FOSS GitLab Shell: 14.7.4 PostgreSQL: 13.6 ------------------------------------------------------------[ booted in 31.01s ] Loading production environment (Rails 6.1.4.7) irb(main):001:0\u003e User.all =\u003e #\u003cActiveRecord::Relation [#\u003cUser id:1 @root\u003e]\u003e irb(main):002:0\u003e user=User.where(id:1).first =\u003e #\u003cUser id:1 @root\u003e irb(main):006:0\u003e user.password='sugar123456' =\u003e \"sugar123456\" irb(main):007:0\u003e user.password_confirmation='sugar123456' =\u003e \"sugar123456\" irb(main):008:0\u003e user.save! =\u003e true å…³é—­ç”¨æˆ·æ³¨å†Œ Admin Area â€”\u003eSettingsâ€”\u003eGeneralâ€”\u003eSign-up restrictions ","date":"2023-12-04","objectID":"/posts/2023-12-4-gitlab/:7:0","tags":["gitlab","git"],"title":"Gitlab","uri":"/posts/2023-12-4-gitlab/"},{"categories":["GoåŸºç¡€"],"content":"é€šé“ channel ","date":"2023-12-01","objectID":"/posts/2023-12-2-go-channel/:0:0","tags":["go-channel","channel"],"title":"Go channel","uri":"/posts/2023-12-2-go-channel/"},{"categories":["GoåŸºç¡€"],"content":"ä»‹ç» ","date":"2023-12-01","objectID":"/posts/2023-12-2-go-channel/:1:0","tags":["go-channel","channel"],"title":"Go channel","uri":"/posts/2023-12-2-go-channel/"},{"categories":["GoåŸºç¡€"],"content":"æ¦‚æ‹¬ Goè¯­è¨€è®¾è®¡å›¢é˜Ÿçš„é¦–ä»»è´Ÿè´£äººRob Pikeå¯¹å¹¶å‘ç¼–ç¨‹çš„ä¸€ä¸ªå»ºè®®æ˜¯ä¸è¦è®©è®¡ç®—é€šè¿‡å…±äº«å†…å­˜æ¥é€šè®¯ï¼Œè€Œåº”è¯¥è®©å®ƒä»¬é€šè¿‡é€šè®¯æ¥å…±äº«å†…å­˜ã€‚ é€šé“æœºåˆ¶å°±æ˜¯è¿™ç§å“²å­¦çš„ä¸€ä¸ªè®¾è®¡ç»“æœã€‚ï¼ˆåœ¨Goç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºä¸€ä¸ªè®¡ç®—å°±æ˜¯ä¸€ä¸ªåç¨‹ã€‚ï¼‰ é€šè¿‡å…±äº«å†…å­˜æ¥é€šè®¯å’Œé€šè¿‡é€šè®¯æ¥å…±äº«å†…å­˜æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­çš„ä¸¤ç§ç¼–ç¨‹é£æ ¼ã€‚ å½“é€šè¿‡å…±äº«å†…å­˜æ¥é€šè®¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›ä¼ ç»Ÿçš„å¹¶å‘åŒæ­¥æŠ€æœ¯ï¼ˆæ¯”å¦‚äº’æ–¥é”ï¼‰æ¥é¿å…æ•°æ®ç«äº‰ã€‚ Goæä¾›äº†ä¸€ç§ç‹¬ç‰¹çš„å¹¶å‘åŒæ­¥æŠ€æœ¯æ¥å®ç°é€šè¿‡é€šè®¯æ¥å…±äº«å†…å­˜ã€‚æ­¤æŠ€æœ¯å³ä¸ºé€šé“ã€‚ æˆ‘ä»¬å¯ä»¥æŠŠä¸€ä¸ªé€šé“çœ‹ä½œæ˜¯åœ¨ä¸€ä¸ªç¨‹åºå†…éƒ¨çš„ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼šfirst in first outï¼‰æ•°æ®é˜Ÿåˆ—ã€‚ ä¸€äº›åç¨‹å¯ä»¥å‘æ­¤é€šé“å‘é€æ•°æ®ï¼Œå¦å¤–ä¸€äº›åç¨‹å¯ä»¥ä»æ­¤é€šé“æ¥æ”¶æ•°æ®ã€‚ éšç€ä¸€ä¸ªæ•°æ®å€¼çš„ä¼ é€’ï¼ˆå‘é€å’Œæ¥æ”¶ï¼‰ï¼Œä¸€äº›æ•°æ®å€¼çš„æ‰€æœ‰æƒä»ä¸€ä¸ªåç¨‹è½¬ç§»åˆ°äº†å¦ä¸€ä¸ªåç¨‹ã€‚ å½“ä¸€ä¸ªåç¨‹å‘é€ä¸€ä¸ªå€¼åˆ°ä¸€ä¸ªé€šé“ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ­¤åç¨‹é‡Šæ”¾äº†ï¼ˆé€šè¿‡æ­¤å‘é€å€¼å¯ä»¥è®¿é—®åˆ°çš„ï¼‰ä¸€äº›å€¼çš„æ‰€æœ‰æƒã€‚ å½“ä¸€ä¸ªåç¨‹ä»ä¸€ä¸ªé€šé“æ¥æ”¶åˆ°ä¸€ä¸ªå€¼ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ­¤åç¨‹è·å–äº†ï¼ˆé€šè¿‡æ­¤æ¥å—å€¼å¯ä»¥è®¿é—®åˆ°çš„ï¼‰ä¸€äº›å€¼çš„æ‰€æœ‰æƒã€‚ å½“ç„¶ï¼Œåœ¨é€šè¿‡é€šé“ä¼ é€’æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰ä»»ä½•æ‰€æœ‰æƒå‘ç”Ÿè½¬ç§»ã€‚ æ‰€æœ‰æƒå‘ç”Ÿè½¬ç§»çš„å€¼å¸¸å¸¸è¢«ä¼ é€’çš„å€¼æ‰€å¼•ç”¨ç€ï¼Œä½†æœ‰æ—¶å€™ä¹Ÿå¹¶éå¦‚æ­¤ã€‚ åœ¨Goä¸­ï¼Œæ•°æ®æ‰€æœ‰æƒçš„è½¬ç§»å¹¶éä½“ç°åœ¨è¯­æ³•ä¸Šï¼Œè€Œæ˜¯ä½“ç°åœ¨é€»è¾‘ä¸Šã€‚ Goé€šé“å¯ä»¥å¸®åŠ©ç¨‹åºå‘˜è½»æ¾åœ°é¿å…æ•°æ®ç«äº‰ï¼Œä½†ä¸ä¼šé˜²æ­¢ç¨‹åºå‘˜å› ä¸ºçŠ¯é”™è€Œå†™å‡ºé”™è¯¯çš„å¹¶å‘ä»£ç çš„æƒ…å†µå‘ç”Ÿã€‚ å°½ç®¡Goä¹Ÿæ”¯æŒå‡ ç§ä¼ ç»Ÿçš„æ•°æ®åŒæ­¥æŠ€æœ¯ï¼Œä½†æ˜¯åªæœ‰é€šé“ä¸ºä¸€ç­‰å…¬æ°‘ã€‚ é€šé“æ˜¯Goä¸­çš„ä¸€ç§ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ— éœ€å¼•è¿›ä»»ä½•ä»£ç åŒ…å°±å¯ä»¥ä½¿ç”¨é€šé“ã€‚ å‡ ç§ä¼ ç»Ÿçš„æ•°æ®åŒæ­¥æŠ€æœ¯æä¾›åœ¨syncå’Œsync/atomicæ ‡å‡†åº“åŒ…ä¸­ã€‚ ","date":"2023-12-01","objectID":"/posts/2023-12-2-go-channel/:1:1","tags":["go-channel","channel"],"title":"Go channel","uri":"/posts/2023-12-2-go-channel/"},{"categories":["GoåŸºç¡€"],"content":"é€šé“ç±»å‹å’Œå€¼ å’Œæ•°ç»„ã€åˆ‡ç‰‡ä»¥åŠæ˜ å°„ç±»å‹ä¸€æ ·ï¼Œæ¯ä¸ªé€šé“ç±»å‹ä¹Ÿæœ‰ä¸€ä¸ªå…ƒç´ ç±»å‹ã€‚ ä¸€ä¸ªé€šé“åªèƒ½ä¼ é€å®ƒçš„ï¼ˆé€šé“ç±»å‹çš„ï¼‰å…ƒç´ ç±»å‹çš„å€¼ã€‚ é€šé“å¯ä»¥æ˜¯åŒå‘çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å•å‘çš„ã€‚ å­—é¢å½¢å¼chan Tè¡¨ç¤ºä¸€ä¸ªå…ƒç´ ç±»å‹ä¸ºTçš„åŒå‘é€šé“ç±»å‹ã€‚ ç¼–è¯‘å™¨å…è®¸ä»æ­¤ç±»å‹çš„å€¼ä¸­æ¥æ”¶å’Œå‘æ­¤ç±»å‹çš„å€¼ä¸­å‘é€æ•°æ®ã€‚ å­—é¢å½¢å¼chan\u003c- Tè¡¨ç¤ºä¸€ä¸ªå…ƒç´ ç±»å‹ä¸ºTçš„å•å‘å‘é€é€šé“ç±»å‹ã€‚ ç¼–è¯‘å™¨ä¸å…è®¸ä»æ­¤ç±»å‹çš„å€¼ä¸­æ¥æ”¶æ•°æ®ã€‚ å­—é¢å½¢å¼\u003c-chan Tè¡¨ç¤ºä¸€ä¸ªå…ƒç´ ç±»å‹ä¸ºTçš„å•å‘æ¥æ”¶é€šé“ç±»å‹ã€‚ ç¼–è¯‘å™¨ä¸å…è®¸å‘æ­¤ç±»å‹çš„å€¼ä¸­å‘é€æ•°æ®ã€‚ åŒå‘é€šé“chan Tçš„å€¼å¯ä»¥è¢«éšå¼è½¬æ¢ä¸ºå•å‘é€šé“ç±»å‹chan\u003c- Tå’Œ\u003c-chan Tï¼Œä½†åä¹‹ä¸è¡Œï¼ˆå³ä½¿æ˜¾å¼ä¹Ÿä¸è¡Œï¼‰ã€‚ ç±»å‹chan\u003c- Tå’Œ\u003c-chan Tçš„å€¼ä¹Ÿä¸èƒ½ç›¸äº’è½¬æ¢ã€‚ é€šé“ç±»å‹çš„é›¶å€¼ä¹Ÿä½¿ç”¨é¢„å£°æ˜çš„nilæ¥è¡¨ç¤ºã€‚ ä¸€ä¸ªéé›¶é€šé“å€¼å¿…é¡»é€šè¿‡å†…ç½®çš„makeå‡½æ•°æ¥åˆ›å»ºã€‚ æ¯”å¦‚make(chan int, 10)å°†åˆ›å»ºä¸€ä¸ªå…ƒç´ ç±»å‹ä¸ºintçš„é€šé“å€¼ã€‚ ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šäº†æ¬²åˆ›å»ºçš„é€šé“çš„å®¹é‡ã€‚æ­¤ç¬¬äºŒä¸ªå®å‚æ˜¯å¯é€‰çš„ï¼Œå®ƒçš„é»˜è®¤å€¼ä¸º0ã€‚ ","date":"2023-12-01","objectID":"/posts/2023-12-2-go-channel/:1:2","tags":["go-channel","channel"],"title":"Go channel","uri":"/posts/2023-12-2-go-channel/"},{"categories":["GoåŸºç¡€"],"content":"é€šé“æ“ä½œ // å®šä¹‰ä¸€ä¸ª channel var ch = make(chan struct{}) // å…³é—­ channel close(ch) // ä¼ å…¥æ•°æ® ch \u003c- struct{}{} // æ¥å—æ•°æ® \u003c-ch msg \u003c-ch // æŸ¥è¯¢ channelå®¹é‡ cap(ch) // æŸ¥è¯¢ channel é•¿åº¦ len(ch) ","date":"2023-12-01","objectID":"/posts/2023-12-2-go-channel/:1:3","tags":["go-channel","channel"],"title":"Go channel","uri":"/posts/2023-12-2-go-channel/"},{"categories":["GoåŸºç¡€"],"content":"æ“ä½œ channel channelæœ‰ä¸‰ç±»ï¼š é›¶å€¼ï¼ˆnilï¼‰é€šé“ï¼› éé›¶å€¼ä½†å·²å…³é—­çš„é€šé“ï¼› éé›¶å€¼å¹¶ä¸”å°šæœªå…³é—­çš„é€šé“ã€‚ ä¸‹è¡¨ç®€å•åœ°æè¿°äº†ä¸‰ç§é€šé“æ“ä½œæ–½åŠ åˆ°ä¸‰ç±»é€šé“çš„ç»“æœã€‚ æ“ä½œ ä¸€ä¸ªé›¶å€¼nilé€šé“ ä¸€ä¸ªéé›¶å€¼ä½†å·²å…³é—­çš„é€šé“ ä¸€ä¸ªéé›¶å€¼ä¸”å°šæœªå…³é—­çš„é€šé“ å…³é—­ äº§ç”Ÿææ…Œ äº§ç”Ÿææ…Œ æˆåŠŸå…³é—­(C) å‘é€æ•°æ® æ°¸ä¹…é˜»å¡ äº§ç”Ÿææ…Œ é˜»å¡æˆ–è€…æˆåŠŸå‘é€(B) æ¥æ”¶æ•°æ® æ°¸ä¹…é˜»å¡ æ°¸ä¸é˜»å¡(D) é˜»å¡æˆ–è€…æˆåŠŸæ¥æ”¶(A) å¯¹äºä¸Šè¡¨ä¸­çš„äº”ç§æœªæ‰“ä¸Šæ ‡çš„æƒ…å½¢ï¼Œè§„åˆ™å¾ˆç®€å•ï¼š å…³é—­ä¸€ä¸ªnilé€šé“æˆ–è€…ä¸€ä¸ªå·²ç»å…³é—­çš„é€šé“å°†äº§ç”Ÿä¸€ä¸ªææ…Œã€‚ å‘ä¸€ä¸ªå·²å…³é—­çš„é€šé“å‘é€æ•°æ®ä¹Ÿå°†å¯¼è‡´ä¸€ä¸ªææ…Œã€‚ å‘ä¸€ä¸ªnilé€šé“å‘é€æ•°æ®æˆ–è€…ä»ä¸€ä¸ªnilé€šé“æ¥æ”¶æ•°æ®å°†ä½¿å½“å‰åç¨‹æ°¸ä¹…é˜»å¡ã€‚ ç¤ºä¾‹ï¼š package main import ( \"fmt\" \"time\" ) func main() { c := make(chan int) // ä¸€ä¸ªéç¼“å†²é€šé“ go func(ch chan\u003c- int, x int) { time.Sleep(time.Second) // \u003c-ch // æ­¤æ“ä½œç¼–è¯‘ä¸é€šè¿‡ ch \u003c- x*x // é˜»å¡åœ¨æ­¤ï¼Œç›´åˆ°å‘é€çš„å€¼è¢«æ¥æ”¶ }(c, 3) done := make(chan struct{}) go func(ch \u003c-chan int) { n := \u003c-ch // é˜»å¡åœ¨æ­¤ï¼Œç›´åˆ°æœ‰å€¼å‘é€åˆ°c fmt.Println(n) // 9 // ch \u003c- 123 // æ­¤æ“ä½œç¼–è¯‘ä¸é€šè¿‡ time.Sleep(time.Second) done \u003c- struct{}{} }(c) \u003c-done // é˜»å¡åœ¨æ­¤ï¼Œç›´åˆ°æœ‰å€¼å‘é€åˆ°done fmt.Println(\"bye\") } ä¸€åœºæ°¸ä¸ä¼‘åœºçš„è¶³çƒæ¯”èµ›ï¼š package main import ( \"fmt\" \"time\" ) func main() { var ball = make(chan string) kickBall := func(playerName string) { for { fmt.Print(\u003c-ball, \"ä¼ çƒ\", \"\\n\") time.Sleep(time.Second) ball \u003c- playerName } } go kickBall(\"å¼ ä¸‰\") go kickBall(\"æå››\") go kickBall(\"ç‹äºŒéº»å­\") go kickBall(\"åˆ˜å¤§\") ball \u003c- \"è£åˆ¤\" // å¼€çƒ var c chan bool // ä¸€ä¸ªé›¶å€¼nilé€šé“ \u003c-c // æ°¸ä¹…é˜»å¡åœ¨æ­¤ } ","date":"2023-12-01","objectID":"/posts/2023-12-2-go-channel/:1:4","tags":["go-channel","channel"],"title":"Go channel","uri":"/posts/2023-12-2-go-channel/"},{"categories":["GoåŸºç¡€"],"content":"é€šé“éå† ","date":"2023-12-01","objectID":"/posts/2023-12-2-go-channel/:2:0","tags":["go-channel","channel"],"title":"Go channel","uri":"/posts/2023-12-2-go-channel/"},{"categories":["GoåŸºç¡€"],"content":"for-range for-rangeå¾ªç¯æ§åˆ¶æµç¨‹ä¹Ÿé€‚ç”¨äºé€šé“ã€‚ æ­¤å¾ªç¯å°†ä¸æ–­åœ°å°è¯•ä»ä¸€ä¸ªé€šé“æ¥æ”¶æ•°æ®ï¼Œç›´åˆ°æ­¤é€šé“å…³é—­å¹¶ä¸”å®ƒçš„ç¼“å†²é˜Ÿåˆ—ä¸ºç©ºä¸ºæ­¢ã€‚ å’Œåº”ç”¨äºæ•°ç»„/åˆ‡ç‰‡/æ˜ å°„çš„for-rangeè¯­æ³•ä¸åŒï¼Œåº”ç”¨äºé€šé“çš„for-rangeè¯­æ³•ä¸­æœ€å¤šåªèƒ½å‡ºç°ä¸€ä¸ªå¾ªç¯å˜é‡ï¼Œæ­¤å¾ªç¯å˜é‡ç”¨æ¥å­˜å‚¨æ¥æ”¶åˆ°çš„å€¼ã€‚ for v := range aChannel { // ä½¿ç”¨v } // ç­‰ä»·äº for { v, ok = \u003c-aChannel if !ok { break } // ä½¿ç”¨v } for x := range c { time.Sleep(time.Second) fmt.Println(x) } ","date":"2023-12-01","objectID":"/posts/2023-12-2-go-channel/:2:1","tags":["go-channel","channel"],"title":"Go channel","uri":"/posts/2023-12-2-go-channel/"},{"categories":["GoåŸºç¡€"],"content":"select-case Goä¸­æœ‰ä¸€ä¸ªä¸“é—¨ä¸ºé€šé“è®¾è®¡çš„select-caseåˆ†æ”¯æµç¨‹æ§åˆ¶è¯­æ³•ã€‚ æ­¤è¯­æ³•å’Œswitch-caseåˆ†æ”¯æµç¨‹æ§åˆ¶è¯­æ³•å¾ˆç›¸ä¼¼ã€‚ æ¯”å¦‚ï¼Œselect-caseæµç¨‹æ§åˆ¶ä»£ç å—ä¸­ä¹Ÿå¯ä»¥æœ‰è‹¥å¹²caseåˆ†æ”¯å’Œæœ€å¤šä¸€ä¸ªdefaultåˆ†æ”¯ã€‚ ä½†æ˜¯ï¼Œè¿™ä¸¤ç§æµç¨‹æ§åˆ¶ä¹Ÿæœ‰å¾ˆå¤šä¸åŒç‚¹ã€‚åœ¨ä¸€ä¸ªselect-caseæµç¨‹æ§åˆ¶ä¸­ï¼Œ selectå…³é”®å­—å’Œ{ä¹‹é—´ä¸å…è®¸å­˜åœ¨ä»»ä½•è¡¨è¾¾å¼å’Œè¯­å¥ã€‚ fallthroughè¯­å¥ä¸èƒ½è¢«ä½¿ç”¨. æ¯ä¸ªcaseå…³é”®å­—åå¿…é¡»è·Ÿéšä¸€ä¸ªé€šé“æ¥æ”¶æ•°æ®æ“ä½œæˆ–è€…ä¸€ä¸ªé€šé“å‘é€æ•°æ®æ“ä½œã€‚ é€šé“æ¥æ”¶æ•°æ®æ“ä½œå¯ä»¥åšä¸ºæºå€¼å‡ºç°åœ¨ä¸€æ¡ç®€å•èµ‹å€¼è¯­å¥ä¸­ã€‚ ä»¥åï¼Œä¸€ä¸ªcaseå…³é”®å­—åè·Ÿéšçš„é€šé“æ“ä½œå°†è¢«ç§°ä¸ºä¸€ä¸ªcaseæ“ä½œã€‚ æ‰€æœ‰çš„éé˜»å¡caseæ“ä½œä¸­å°†æœ‰ä¸€ä¸ªè¢«éšæœºé€‰æ‹©æ‰§è¡Œï¼ˆè€Œä¸æ˜¯æŒ‰ç…§ä»ä¸Šåˆ°ä¸‹çš„é¡ºåºï¼‰ï¼Œç„¶åæ‰§è¡Œæ­¤æ“ä½œå¯¹åº”çš„caseåˆ†æ”¯ä»£ç å—ã€‚ åœ¨æ‰€æœ‰çš„caseæ“ä½œå‡ä¸ºé˜»å¡çš„æƒ…å†µä¸‹ï¼Œå¦‚æœdefaultåˆ†æ”¯å­˜åœ¨ï¼Œåˆ™defaultåˆ†æ”¯ä»£ç å—å°†å¾—åˆ°æ‰§è¡Œï¼› å¦åˆ™ï¼Œå½“å‰åç¨‹å°†è¢«æ¨å…¥æ‰€æœ‰é˜»å¡æ“ä½œä¸­ç›¸å…³çš„é€šé“çš„å‘é€æ•°æ®åç¨‹é˜Ÿåˆ—æˆ–è€…æ¥æ”¶æ•°æ®åç¨‹é˜Ÿåˆ—ä¸­ï¼Œå¹¶è¿›å…¥é˜»å¡çŠ¶æ€ã€‚ æŒ‰ç…§ä¸Šè¿°è§„åˆ™ï¼Œä¸€ä¸ªä¸å«ä»»ä½•åˆ†æ”¯çš„select-caseä»£ç å—select{}å°†ä½¿å½“å‰åç¨‹å¤„äºæ°¸ä¹…é˜»å¡çŠ¶æ€ã€‚ // defaultåˆ†æ”¯å°†é“å®šå¾—åˆ°æ‰§è¡Œï¼Œå› ä¸ºä¸¤ä¸ªcaseåˆ†æ”¯åçš„æ“ä½œå‡ä¸ºé˜»å¡çš„ã€‚ package main import \"fmt\" func main() { var c chan struct{} // nil select { case \u003c-c: // é˜»å¡æ“ä½œ case c \u003c- struct{}{}: // é˜»å¡æ“ä½œ default: fmt.Println(\"Go here.\") } } ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­å®ç°äº†å°è¯•å‘é€ï¼ˆtry-sendï¼‰å’Œå°è¯•æ¥æ”¶ï¼ˆtry-receiveï¼‰ã€‚ å®ƒä»¬éƒ½æ˜¯ç”¨å«æœ‰ä¸€ä¸ªcaseåˆ†æ”¯å’Œä¸€ä¸ªdefaultåˆ†æ”¯çš„select-caseä»£ç å—æ¥å®ç°çš„ã€‚ package main import \"fmt\" func main() { c := make(chan string, 2) trySend := func(v string) { select { case c \u003c- v: default: // å¦‚æœcçš„ç¼“å†²å·²æ»¡ï¼Œåˆ™æ‰§è¡Œé»˜è®¤åˆ†æ”¯ã€‚ } } tryReceive := func() string { select { case v := \u003c-c: return v default: return \"-\" // å¦‚æœcçš„ç¼“å†²ä¸ºç©ºï¼Œåˆ™æ‰§è¡Œé»˜è®¤åˆ†æ”¯ã€‚ } } trySend(\"Hello!\") // å‘é€æˆåŠŸ trySend(\"Hi!\") // å‘é€æˆåŠŸ trySend(\"Bye!\") // å‘é€å¤±è´¥ï¼Œä½†ä¸ä¼šé˜»å¡ã€‚ // ä¸‹é¢è¿™ä¸¤è¡Œå°†æ¥æ”¶æˆåŠŸã€‚ fmt.Println(tryReceive()) // Hello! fmt.Println(tryReceive()) // Hi! // ä¸‹é¢è¿™è¡Œå°†æ¥æ”¶å¤±è´¥ã€‚ fmt.Println(tryReceive()) // - } ","date":"2023-12-01","objectID":"/posts/2023-12-2-go-channel/:2:2","tags":["go-channel","channel"],"title":"Go channel","uri":"/posts/2023-12-2-go-channel/"},{"categories":["GoåŸºç¡€"],"content":"ä½¿ç”¨ç¤ºä¾‹ï¼š ","date":"2023-12-01","objectID":"/posts/2023-12-2-go-channel/:3:0","tags":["go-channel","channel"],"title":"Go channel","uri":"/posts/2023-12-2-go-channel/"},{"categories":["GoåŸºç¡€"],"content":"ä½¿ç”¨é€šé“å®ç°é€šçŸ¥ å‘ä¸€ä¸ªé€šé“å‘é€ä¸€ä¸ªå€¼æ¥å®ç°å•å¯¹å•é€šçŸ¥ package main import ( \"crypto/rand\" \"fmt\" \"os\" \"sort\" ) func main() { values := make([]byte, 32 * 1024 * 1024) if _, err := rand.Read(values); err != nil { fmt.Println(err) os.Exit(1) } done := make(chan struct{}) // ä¹Ÿå¯ä»¥æ˜¯ç¼“å†²çš„ // æ’åºåç¨‹ go func() { sort.Slice(values, func(i, j int) bool { return values[i] \u003c values[j] }) done \u003c- struct{}{} // é€šçŸ¥æ’åºå·²å®Œæˆ }() // å¹¶å‘åœ°åšä¸€äº›å…¶å®ƒäº‹æƒ…... \u003c- done // ç­‰å¾…é€šçŸ¥ fmt.Println(values[0], values[len(values)-1]) } ä»ä¸€ä¸ªé€šé“æ¥æ”¶ä¸€ä¸ªå€¼æ¥å®ç°å•å¯¹å•é€š package main import ( \"fmt\" \"time\" ) func main() { done := make(chan struct{}) // æ­¤ä¿¡å·é€šé“ä¹Ÿå¯ä»¥ç¼“å†²ä¸º1ã€‚å¦‚æœè¿™æ ·ï¼Œåˆ™åœ¨ä¸‹é¢ // è¿™ä¸ªåç¨‹åˆ›å»ºä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»å‘å…¶ä¸­å†™å…¥ä¸€ä¸ªå€¼ã€‚ go func() { fmt.Print(\"Hello\") // æ¨¡æ‹Ÿä¸€ä¸ªå·¥ä½œè´Ÿè½½ã€‚ time.Sleep(time.Second * 2) // ä½¿ç”¨ä¸€ä¸ªæ¥æ”¶æ“ä½œæ¥é€šçŸ¥ä¸»åç¨‹ã€‚ \u003c- done }() done \u003c- struct{}{} // é˜»å¡åœ¨æ­¤ï¼Œç­‰å¾…é€šçŸ¥ fmt.Println(\" world!\") } ","date":"2023-12-01","objectID":"/posts/2023-12-2-go-channel/:3:1","tags":["go-channel","channel"],"title":"Go channel","uri":"/posts/2023-12-2-go-channel/"},{"categories":["GoåŸºç¡€"],"content":"ä½¿å½“å‰åç¨‹æ°¸ä¹…é˜»å¡ å¯ä»¥ç”¨ä¸€ä¸ªæ— åˆ†æ”¯çš„selectæµç¨‹æ§åˆ¶ä»£ç å—ä½¿å½“å‰åç¨‹æ°¸ä¹…å¤„äºé˜»å¡çŠ¶æ€ã€‚ è¿™æ˜¯selectæµç¨‹æ§åˆ¶çš„æœ€ç®€å•çš„åº”ç”¨ã€‚ äº‹å®ä¸Šï¼Œä¸Šé¢å¾ˆå¤šä¾‹å­ä¸­çš„for {time.Sleep(time.Second)}éƒ½å¯ä»¥æ¢ä¸ºselect{}ã€‚ package main import \"runtime\" func DoSomething() { for { // åšç‚¹ä»€ä¹ˆ... runtime.Gosched() // é˜²æ­¢æœ¬åç¨‹éœ¸å CPUä¸æ”¾ } } func main() { go DoSomething() go DoSomething() select{} } ","date":"2023-12-01","objectID":"/posts/2023-12-2-go-channel/:3:2","tags":["go-channel","channel"],"title":"Go channel","uri":"/posts/2023-12-2-go-channel/"},{"categories":["DevOps"],"content":"Shell handbok ","date":"2023-11-24","objectID":"/posts/2023-11-24-shell-handbook/:0:0","tags":["shell","shell-handbook"],"title":"Shell handbook","uri":"/posts/2023-11-24-shell-handbook/"},{"categories":["DevOps"],"content":"ä¸€ã€ç‰¹æ®Šç¬¦å· å‚è€ƒé“¾æ¥: https://blog.csdn.net/jiezi2016/article/details/79649382 https://blog.csdn.net/wangzhaotongalex/article/details/73321766 ä»‹ç»ä¸‹Shellä¸­çš„${}ã€##å’Œ%%ä½¿ç”¨èŒƒä¾‹ï¼Œæœ¬æ–‡ç»™å‡ºäº†ä¸åŒæƒ…å†µä¸‹å¾—åˆ°çš„ç»“æœã€‚ å‡è®¾å®šä¹‰äº†ä¸€ä¸ªå˜é‡ä¸ºï¼š ä»£ç å¦‚ä¸‹: file=/dir1/dir2/dir3/my.file.txt å¯ä»¥ç”¨${ }åˆ†åˆ«æ›¿æ¢å¾—åˆ°ä¸åŒçš„å€¼ï¼š ${file#*/}ï¼šåˆ æ‰ç¬¬ä¸€ä¸ª / åŠå…¶å·¦è¾¹çš„å­—ç¬¦ä¸²ï¼šdir1/dir2/dir3/my.file.txt ${file##*/}ï¼šåˆ æ‰æœ€åä¸€ä¸ª / åŠå…¶å·¦è¾¹çš„å­—ç¬¦ä¸²ï¼šmy.file.txt ${file#*.}ï¼šåˆ æ‰ç¬¬ä¸€ä¸ª . åŠå…¶å·¦è¾¹çš„å­—ç¬¦ä¸²ï¼šfile.txt ${file##*.}ï¼šåˆ æ‰æœ€åä¸€ä¸ª . åŠå…¶å·¦è¾¹çš„å­—ç¬¦ä¸²ï¼štxt ${file%/*}ï¼šåˆ æ‰æœ€åä¸€ä¸ª / åŠå…¶å³è¾¹çš„å­—ç¬¦ä¸²ï¼š/dir1/dir2/dir3 ${file%%/*}ï¼šåˆ æ‰ç¬¬ä¸€ä¸ª / åŠå…¶å³è¾¹çš„å­—ç¬¦ä¸²ï¼š(ç©ºå€¼) ${file%.*}ï¼šåˆ æ‰æœ€åä¸€ä¸ª . åŠå…¶å³è¾¹çš„å­—ç¬¦ä¸²ï¼š/dir1/dir2/dir3/my.file ${file%%.*}ï¼šåˆ æ‰ç¬¬ä¸€ä¸ª . åŠå…¶å³è¾¹çš„å­—ç¬¦ä¸²ï¼š/dir1/dir2/dir3/my è®°å¿†çš„æ–¹æ³•ä¸ºï¼š # æ˜¯ å»æ‰å·¦è¾¹ï¼ˆé”®ç›˜ä¸Š#åœ¨ $ çš„å·¦è¾¹ï¼‰ %æ˜¯å»æ‰å³è¾¹ï¼ˆé”®ç›˜ä¸Š% åœ¨$ çš„å³è¾¹ï¼‰ å•ä¸€ç¬¦å·æ˜¯æœ€å°åŒ¹é…ï¼›ä¸¤ä¸ªç¬¦å·æ˜¯æœ€å¤§åŒ¹é… ${file:0:5}ï¼šæå–æœ€å·¦è¾¹çš„ 5 ä¸ªå­—èŠ‚ï¼š/dir1 ${file:5:5}ï¼šæå–ç¬¬ 5 ä¸ªå­—èŠ‚å³è¾¹çš„è¿ç»­5ä¸ªå­—èŠ‚ï¼š/dir2 ä¹Ÿå¯ä»¥å¯¹å˜é‡å€¼é‡Œçš„å­—ç¬¦ä¸²ä½œæ›¿æ¢ï¼š ${file/dir/path}ï¼šå°†ç¬¬ä¸€ä¸ªdir æ›¿æ¢ä¸ºpathï¼š/path1/dir2/dir3/my.file.txt ${file//dir/path}ï¼šå°†å…¨éƒ¨dir æ›¿æ¢ä¸º pathï¼š/path1/path2/path3/my.file.txt $*ä¸$@ $*å’Œ$@éƒ½è¡¨ç¤ºä¼ é€’ç»™å‡½æ•°æˆ–è„šæœ¬çš„æ‰€æœ‰å‚æ•°ï¼Œä¸è¢«åŒå¼•å·â€œâ€åŒ…å«æ—¶ï¼Œéƒ½ä»¥$1 $2 â€¦$nçš„å½¢å¼è¾“å‡ºæ‰€æœ‰å‚æ•°ã€‚ å½“å®ƒä»¬è¢«åŒå¼•å·â€œâ€åŒ…å«æ—¶ï¼Œâ€œ$*â€ä¼šå°†æ‰€æœ‰çš„å‚æ•°ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œä»¥â€œ$1 $2 â€¦$nâ€çš„å½¢å¼è¾“å‡ºæ‰€æœ‰å‚æ•°ï¼›â€œ$@â€ä¼šå°†å„ä¸ªå‚æ•°åˆ†å¼€ï¼Œä»¥â€œ$1â€ â€œ$2â€â€¦â€$nâ€çš„å½¢å¼è¾“å‡ºæ‰€æœ‰å‚æ•°ã€‚ ","date":"2023-11-24","objectID":"/posts/2023-11-24-shell-handbook/:1:0","tags":["shell","shell-handbook"],"title":"Shell handbook","uri":"/posts/2023-11-24-shell-handbook/"},{"categories":["DevOps"],"content":"äºŒã€é‡å®šå‘ä¸å˜é‡ cat \u003e\u003etest.txt \u003c\u003c EOF 1ã€å®‰è£…kvm 2ã€å¸è½½kvm 3ã€å®‰è£…python EOF $0 shellè„šæœ¬çš„åå­— $n ç¬¬nä¸ªå‚æ•° $# è·å–å‚æ•°çš„ä¸ªæ•° $* æ‰€æœ‰å‚æ•° $@ æ‰€æœ‰å‚æ•° ä¸¤è€…åŒºåˆ«ï¼š \"$*\"ä¼šæŠŠæ‰€æœ‰ä½ç½®å‚æ•°å½“æˆä¸€ä¸ªæ•´ä½“ï¼ˆæˆ–è€…è¯´å½“æˆä¸€ä¸ªå•è¯ï¼‰ï¼Œå¦‚æœæ²¡æœ‰ä½ç½®å‚æ•°ï¼Œåˆ™\"$*\"ä¸ºç©ºï¼Œå¦‚æœæœ‰ä¸¤ä¸ªä½ç½®å‚æ•°å¹¶ä¸”IFSä¸ºç©ºæ ¼æ—¶ï¼Œ\"$*\"ç›¸å½“äº\"$1 $2\" \"$@\" ä¼šæŠŠæ‰€æœ‰ä½ç½®å‚æ•°å½“æˆä¸€ä¸ªå•ç‹¬çš„å­—æ®µï¼Œå¦‚æœæ²¡æœ‰ä½ç½®å‚æ•°ï¼ˆ$#ä¸º0ï¼‰ï¼Œåˆ™\"$@\"å±•å¼€ä¸ºç©ºï¼ˆä¸æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ç©ºåˆ—è¡¨ï¼‰ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªä½ç½®å‚æ•°ï¼Œåˆ™\"$@\"ç›¸å½“äº\"$1\"ï¼Œå¦‚æœæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œåˆ™\"$@\"ç›¸å½“äº\"$1\" \"$2\"ç­‰ç­‰ $? ç”¨äºè®°å½•ä¸Šä¸€æ¡å‘½ä»¤çš„æ‰§è¡ŒçŠ¶æ€ 0---255 0ï¼šæ‰§è¡ŒæˆåŠŸ $$ è·å–å½“å‰æ‰§è¡ŒShellè„šæœ¬çš„è¿›ç¨‹å·ï¼ˆPIDï¼‰ $! è·å–ä¸Šä¸€ä¸ªåœ¨åå°å·¥ä½œçš„è¿›ç¨‹çš„è¿›ç¨‹å· $_ è·å–åœ¨æ­¤ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤æˆ–è„šæœ¬çš„æœ€åä¸€ä¸ªå‚æ•° ç‰¹æ®Šæ‰©å±•å˜é‡ å¯ä»¥man bash å‘½ä»¤ï¼Œç„¶åæœç´¢\"Parameter Expansion\"æ¥æŸ¥æ‰¾ç›¸å…³çš„å†…å®¹å¸®åŠ© ${parameter:-word} å¦‚æœparameterçš„å˜é‡å€¼ä¸ºç©ºæˆ–æ²¡èµ‹å€¼ï¼Œåˆ™è¿”å›wordå­—ç¬¦ä¸²å¹¶ä»£æ›¿å˜é‡çš„å€¼ï¼ˆå˜é‡æ²¡å®šä¹‰ï¼Œè¿”å›å¤‡ç”¨çš„å€¼ï¼Œé˜²æ­¢å˜é‡ä¸ºç©ºæˆ–æ²¡å®šä¹‰æŠ¥é”™ï¼‰ ${parameter:=word} å¦‚æœparameterçš„å˜é‡å€¼ä¸ºç©ºæˆ–æ²¡èµ‹å€¼ï¼Œã€‚ã€‚ã€‚åŒä¸Šï¼Œï¼ˆå˜é‡æ²¡å®šä¹‰ä¸ºé˜²æ­¢å‡ºé”™ï¼Œæ‰¾çš„å¤‡èƒå˜é‡ï¼‰ ${parameter:?word} å¦‚æœparameterçš„å˜é‡å€¼ä¸ºç©ºæˆ–è€…æ²¡èµ‹å€¼ï¼Œwordå­—ç¬¦ä¸²å°±ä½œä¸ºæ ‡å‡†é”™è¯¯è¾“å‡ºï¼Œå¦åˆ™å‡ºä¹¦å˜é‡çš„å€¼ï¼ˆæ•æ‰ç”±äºå˜é‡æœªå®šä¹‰å¯¼è‡´çš„é”™è¯¯ï¼Œå¹¶é€€å‡ºï¼‰ ${parameter:+word} è‹¥æœparameterçš„å˜é‡å€¼ä¸ºç©ºæˆ–è€…æœªèµ‹å€¼ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åšï¼Œå¦åˆ™wordå­—ç¬¦ä¸²å°†ä»£æ›¿å˜é‡çš„å€¼ã€‚ ","date":"2023-11-24","objectID":"/posts/2023-11-24-shell-handbook/:2:0","tags":["shell","shell-handbook"],"title":"Shell handbook","uri":"/posts/2023-11-24-shell-handbook/"},{"categories":["DevOps"],"content":"ä¸‰ã€åˆ¤æ–­ æ¡ä»¶åˆ¤æ–­ -z åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©ºä¸² -n å­—ç¬¦æ®µé•¿åº¦æ˜¯å¦éé›¶çš„ å¦‚æœç»“æœä¸ºçœŸå€¼ è¿”å›å€¼ä¸º0 å¦‚æœç»“æœä¸ºå‡å€¼ -eq ç­‰äº -gt å¤§äº -lt å°äº -ge å¤§äºç­‰äº -le å°äºç­‰äº -ne ä¸ç­‰äº æ ¹æ®æ–‡ä»¶ç±»å‹åˆ¤æ–­ -d æ–‡ä»¶å­˜åœ¨ä¸”å¿…é¡»æ˜¯ç›®å½• -e æ–‡ä»¶å­˜åœ¨ï¼Œä¸åˆ¤æ–­æ–‡ä»¶ç±»å‹ -f æ–‡ä»¶å­˜åœ¨ä¸”æ˜¯æ ‡å‡†æ™®é€šæ–‡ä»¶ -h æ–‡ä»¶å­˜åœ¨ä¸”æ˜¯è½¯è¿æ¥ï¼ŒåŒ -L -r æ–‡ä»¶å­˜åœ¨ä¸”å¯è¯» -w æ–‡ä»¶å­˜åœ¨ä¸”å¯å†™ -x æ–‡ä»¶å­˜åœ¨ä¸”å¯æ‰§è¡Œ -s æ–‡ä»¶å­˜åœ¨ä¸”è‡³å°‘æœ‰ä¸€ä¸ªå­—ç¬¦ åŒç›®è¡¨è¾¾å¼ å•ç›®è¡¨è¾¾å¼ï¼Œ æ‰€æœ‰çš„å•ç›®è¡¨è¾¾å¼éƒ½å¯ä»¥ä½¿ç”¨!è¡¨ç¤ºå–å [ ! -f file_name ] ifæ ‡å‡†å†™æ³• if æ¡ä»¶; then æ“ä½œè¯­å¥ æ“ä½œè¯­å¥ .... else æ“ä½œè¯­å¥ æ“ä½œè¯­å¥ fi [ file1 -ef file2 ] ä¸¤ä¸ªæ–‡ä»¶æœ‰ç›¸åŒçš„è®¾å¤‡ç¼–å·å’Œinodeç¼–å· (åˆ¤æ–­ç¡¬é“¾æ¥) if [ 'a' != 'b'];then echo 'a' fi ä»¥ä¸Šå¯ä»¥ç®€å†™ä¸º: [ 'a' != 'b' ] \u0026\u0026 echo 'a' case è¯­æ³• read -p \"Enter string: \" str_01 case $str_01 in linux|Linux) echo \"CentOS\" ;; windows|Windows) echo \"Microsoft\" ;; *) echo \"Other\" ;; esac for å¾ªç¯ # æ™®é€šå¾ªç¯ sum=0 for i in `seq 100`; do let sum=$sum+$i done echo $sum # ç±»Cå†™æ³• for ((i=1;i\u003c8;i++));do cmd1 done whileå¾ªç¯ while æ¡ä»¶; do æ“ä½œè¯­å¥ æ“ä½œè¯­å¥ å­˜åœ¨ä¸€æ¡å¯ä»¥æ”¹å˜æ¡ä»¶çœŸå‡çš„è¯­å¥ done untilå¾ªç¯ å½“æ¡ä»¶ä¸ºå‡æ—¶æ‰å¾ªç¯ until æ¡ä»¶æµ‹è¯• ;do cmd1 done æ•°ç»„ä¸å¾ªç¯ # ca.crt /etc/openvpn/easy-rsa/pki # server.crt /etc/openvpn/easy-rsa/pki/issued # user.crt /etc/openvpn/easy-rsa/pki/issued # user.key /etc/openvpn/easy-rsa/pki/private # ca.key /etc/openvpn/easy-rsa/pki/private # ta.key /etc/openvpn/easy-rsa # å®šä¹‰ç”¨æˆ· accounts=( client2,ç”¨æˆ·2 client3,ç”¨æˆ·3 client4,ç”¨æˆ·4 ) OPENVPN_DIR=\"/etc/openvpn\" EASY_RSA_DIR=\"/etc/openvpn/easy-rsa\" # åˆ†é…å¥½çš„è¯ä¹¦ OVPN_DIR=\"/tmp/openvpn\" # åˆ›å»ºkey # $1 ç”¨æˆ·è¯ä¹¦å create_key(){ [[ ! -f ${EASY_RSA_DIR}/easyrsa ]] \u0026\u0026 exit 55 cd ${EASY_RSA_DIR}/ \u0026\u0026 ./easyrsa build-client-full $1 nopass } # $1 ç”¨æˆ·å create_ovpn(){ [[ ! -f ${OVPN_DIR} ]] \u0026\u0026 mkdir -p ${OVPN_DIR} cat \u003e ${OVPN_DIR}/$1.ovpn \u003c\u003c EOF client dev tun proto tcp remote vpn.local.com 50000 resolv-retry infinite nobind persist-key persist-tun remote-cert-tls server cipher AES-256-CBC comp-lzo verb 3 EOF } # $1 ç”¨æˆ·å insert_file(){ ca=`cat ${EASY_RSA_DIR}/pki/ca.crt` user_crt=`cat ${EASY_RSA_DIR}/pki/issued/$1.crt` user_key=`cat ${EASY_RSA_DIR}/pki/private/$1.key` ta=`cat ${EASY_RSA_DIR}/ta.key` cat \u003e\u003e ${OVPN_DIR}/$1.ovpn \u003c\u003c EOF \u003cca\u003e ${ca} \u003c/ca\u003e \u003ccert\u003e ${user_crt} \u003c/cert\u003e \u003ckey\u003e ${user_key} \u003c/key\u003e key-direction 1 \u003ctls-auth\u003e ${ta} \u003c/tls-auth\u003e EOF } ## main for aobj in ${accounts[@]} do arr=(${aobj//,/ }) actName=${arr[0]} chineseName=${arr[1]} create_ovpn ${actName} create_key ${actName} insert_file ${actName} done ","date":"2023-11-24","objectID":"/posts/2023-11-24-shell-handbook/:3:0","tags":["shell","shell-handbook"],"title":"Shell handbook","uri":"/posts/2023-11-24-shell-handbook/"},{"categories":["DevOps"],"content":"å››ã€é«˜çº§è¯­æ³• å¯é€‰å‚æ•° while getopts \"ğŸ…°ï¸b:c:\" opt do case $opt in a) echo \"å‚æ•°açš„å€¼$OPTARG\" ;; b) echo \"å‚æ•°bçš„å€¼$OPTARG\" ;; c) echo \"å‚æ•°cçš„å€¼$OPTARG\" ;; ?) echo \"æœªçŸ¥å‚æ•°\" exit 1;; esac done ","date":"2023-11-24","objectID":"/posts/2023-11-24-shell-handbook/:4:0","tags":["shell","shell-handbook"],"title":"Shell handbook","uri":"/posts/2023-11-24-shell-handbook/"},{"categories":["DevOps"],"content":"sed d åˆ é™¤ç¬¦åˆæ¡ä»¶çš„è¡Œ # sed '1,2d' /etc/inittab åˆ é™¤æ–‡ä»¶ä¸­åŒ…å«ootçš„è¡Œ # sed '/oot/d' /etc/fstab åˆ é™¤ç¬¬1è¡ŒåŠå…¶å2è¡Œ # sed '1,+2d' /etc/fstab åˆ é™¤ç¬¬1è¡Œ # sed '1d' /etc/fstab åˆ é™¤ä»¥/å¼€å¤´çš„è¡Œ # sed '/^\\//d' /etc/fstab a \\string åœ¨ç¬¦åˆæ¡ä»¶çš„è¡Œåè¿½åŠ æ–°è¡Œï¼Œstringä¸ºè¿½åŠ çš„å†…å®¹ åœ¨ä»¥/å¼€å¤´çš„è¡Œåé¢è¿½åŠ # hello world # sed '/^\\//a \\# hello world' /etc/fstab åœ¨ä»¥/å¼€å¤´çš„è¡Œåé¢è¿½åŠ ä¸¤è¡Œå†…å®¹ï¼Œåˆ†åˆ«ä¸º# hello worl # hello linux # sed '/^\\//a \\# hello world\\n# hello linux' /etc/fstab i \\string åœ¨ç¬¦åˆæ¡ä»¶çš„è¡Œå‰æ·»åŠ æ–°è¡Œï¼Œstringä¸ºè¿½åŠ çš„å†…å®¹ åœ¨æ–‡ä»¶ç¬¬1è¡Œæ·»åŠ # hello world # sed '1i \\# hello world' /etc/fstab c \\string æ›¿æ¢æŒ‡å®šè¡Œçš„å†…å®¹ å°†æ–‡ä»¶ä¸­æœ€åä¸€è¡Œå†…å®¹æ›¿æ¢ä¸ºEnd Of File # sed '$c \\End Of File' /1.txt # sed '7c \\SELINUX=disabled' /etc/sysconfig/selinux # å½“æœ‰helloçš„è¡Œï¼Œå°†è¢«æ›¿æ¢æˆhello=world # sed -r \"/hello/c \\hello=world\" exmaple.txt ","date":"2023-11-24","objectID":"/posts/2023-11-24-shell-handbook/:4:1","tags":["shell","shell-handbook"],"title":"Shell handbook","uri":"/posts/2023-11-24-shell-handbook/"},{"categories":["DevOps"],"content":"awk # awk -F: '/^r/{print $1}' /etc/passwd ","date":"2023-11-24","objectID":"/posts/2023-11-24-shell-handbook/:4:2","tags":["shell","shell-handbook"],"title":"Shell handbook","uri":"/posts/2023-11-24-shell-handbook/"},{"categories":["DevOps"],"content":"switch-caseè¯­æ³• shell è¯­æ³• case å˜é‡ in å–å€¼1) æ“ä½œè¯­å¥ æ“ä½œè¯­å¥ ;; å–å€¼2) æ“ä½œè¯­å¥ æ“ä½œè¯­å¥ ;; å–å€¼3) æ“ä½œè¯­å¥ æ“ä½œè¯­å¥ ;; *) æ“ä½œè¯­å¥ æ“ä½œè¯­å¥ ;; esac # example read -p \"Enter string: \" str_01 case $str_01 in linux|Linux) echo \"CentOS\" ;; windows|Windows) echo \"Microsoft\" ;; *) echo \"Other\" ;; esac go func testSwitch3() { switch n := 7; n { case 1, 3, 5, 7, 9: fmt.Println(\"å¥‡æ•°\") case 2, 4, 6, 8: fmt.Println(\"å¶æ•°\") default: fmt.Println(n) } } func switchDemo1() { finger := 3 switch finger { case 1: fmt.Println(\"å¤§æ‹‡æŒ‡\") case 4: fmt.Println(\"æ— åæŒ‡\") case 5: fmt.Println(\"å°æ‹‡æŒ‡\") default: fmt.Println(\"æ— æ•ˆçš„è¾“å…¥ï¼\") } } python 3.10åŠä»¥å match term: case pattern-1: action-1 case pattern-2: action-2 case pattern-3: action-3 case _: action-default lang = input(\"What's the programming language you want to learn? \") match lang: case \"Python\": print(\"You can become a Data Scientist\") case \"go\": print(\"You can become a Blockchain developer\") case \"Java\": print(\"You can become a mobile app developer\") case _: print(\"The language doesn't matter, what matters is solving problems.\") ","date":"2023-11-24","objectID":"/posts/2023-11-24-switch-case/:0:0","tags":["switch","case","switch-case"],"title":"switch-case handbook","uri":"/posts/2023-11-24-switch-case/"},{"categories":["DevOps"],"content":"Ansible Module å‚è€ƒé“¾æ¥ï¼šhttps://ansible.leops.cn/dev/modules/ 1ã€è‡ªå®šä¹‰æ¨¡å—å¼€å‘ è¯¥æ¨¡å—çš„ç›®çš„æ˜¯åœ¨è¿œç¨‹ä¸»æœºä¸Šå°†è¿œç¨‹æºæ–‡ä»¶å¤åˆ¶åˆ°è¿œç¨‹ç›®æ ‡æ–‡ä»¶ #!/usr/bin/python # -*- coding: utf-8 -*- # Copyright: (c) 2020, lework # GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt) ANSIBLE_METADATA = {'metadata_version': '1.0', 'status': ['preview'], 'supported_by': 'community'} DOCUMENTATION = ''' --- module: remote_copy short_description: Copy a file on the remote host version_added: \"2.9\" description: - The remote_copy module copies a file on the remote host from a given source to a provided destination. options: source: description: - Path to a file on the source file on the remote host required: true dest: description: - Path to the destination on the remote host for the copy required: true author: - \"Lework\" ''' EXAMPLES = ''' # Example from Ansible Playbooks - name: backup a config file remote_copy: source: /tmp/foo dest: /tmp/bar ''' RETURN = ''' source: description: Path to a file on the source file on the remote host type: str returned: success sample: \"/path/to/file.name\" dest: description: Path to the destination on the remote host for the copy type: string returned: success sample: \"/path/to/destination.file\" ''' import os import shutil from ansible.module_utils.basic import AnsibleModule def main(): module_args = dict( source=dict(required=True, type='str'), dest=dict(required=True, type='str') ) result = dict( changed=False, source='', dest='' ) module = AnsibleModule( argument_spec=module_args, supports_check_mode=True ) if module.check_mode: module.exit_json(**result) if not os.path.isfile(module.params['source']): module.fail_json(msg='The '+ module.params['source'] +' file was not found', **result) try: shutil.copy(module.params['source'], module.params['dest']) except Exception as e: module.fail_json(msg=e, **result) result['source'] = module.params['source'] result['dest'] = module.params['dest'] if os.path.isfile(module.params['dest']): result['changed'] = True remote_facts = {'rc_source': module.params['source'], 'rc_dest': module.params['dest'] } result['ansible_facts'] = remote_facts module.exit_json(**result) if __name__ == '__main__': main() ","date":"2023-11-22","objectID":"/posts/2023-11-22-python-ansible-module/:0:0","tags":["python-ansible","ansible-module"],"title":"Python ansible module","uri":"/posts/2023-11-22-python-ansible-module/"},{"categories":["DevOps"],"content":"Python åŸºç¡€ ","date":"2023-11-22","objectID":"/posts/2023-11-22-python-basic/:0:0","tags":["python","python-basic"],"title":"Python basic","uri":"/posts/2023-11-22-python-basic/"},{"categories":["DevOps"],"content":"ä¸€ã€åŸºç¡€è¯­æ³• ","date":"2023-11-22","objectID":"/posts/2023-11-22-python-basic/:1:0","tags":["python","python-basic"],"title":"Python basic","uri":"/posts/2023-11-22-python-basic/"},{"categories":["DevOps"],"content":"1ã€è¾“å‡ºè¯­å¥çš„ä½¿ç”¨ 1ï¼‰å¼•å·çš„ä½¿ç”¨ \u003e\u003e\u003e print ('hello world') hello world \u003e\u003e\u003e print (\"hello world\") hello world \u003e\u003e\u003e 2ï¼‰ä¸‰å¼•å·: è¾“å‡ºå¤šè¡Œå†…å®¹ \u003e\u003e\u003e print (\"\"\"abc ... cdc ... ddd ... ccc ... fff\"\"\") abc cdc ddd ccc fff æ³¨é‡Šç¬¦ï¼š# python2ä¸python3çš„åŒºåˆ« printè¯­æ³•ä¸åŒï¼Œpython3éœ€è¦åŠ () python2é»˜è®¤ä½¿ç”¨çš„å­—ç¬¦é›†ASCIIç , # encoding: utf8ã€‚python3é»˜è®¤ä½¿ç”¨çš„å­—ç¬¦é›†Unicode 2ï¼‰è¾“å‡ºå˜é‡ username = \"root\" password = \"redhat\" print(username) print(\"my name is \", username, \"my password is\", password) print(\"my name is \" + username + \"my password is \" + password) #åªé€‚ç”¨äºå­—ç¬¦ä¸² 3ï¼‰æ ¼å¼åŒ–è¾“å‡º \u003e\u003e\u003e username = \"root\" \u003e\u003e\u003e password = \"redhat\" \u003e\u003e\u003e print(\"my name is %s\" % username ) my name is root \u003e\u003e\u003e print(\"my name is '%s'\" % username) my name is 'root' \u003e\u003e\u003e print(\"my name is %s, my password is %s\" % (username, password)) my name is root, my password is redhat å¸¸ç”¨çš„æ ¼å¼åŒ–å­—ç¬¦ %s å­—ç¬¦ä¸² é€šç”¨ %d æ•°å­—ï¼Œæ•´æ•° number_01 = 123 number_02 = \"456\" number_03 = 3.9415 print(\"It is %d\" % number_01) print(\"It is %d\" % number_03) %f æµ®ç‚¹æ•°ï¼Œå°æ•° number_01 = 123 number_02 = 3.948915 number_03 = 3.9489151111111111 print(\"It is %f\" % number_01) print(\"It is %f\" % number_02) print(\"It is %f\" % number_03) print(\"It is %.2f\" % number_02) %% è¾“å‡º%æœ¬èº« number = 50 # This is 50% print(\"This is %d%%\" % number) username = \"root\" password = \"redhat\" sql_01 = \"select * from tb01 where username='%s' and password='%s'\" % (username, password) print(sql_01) ","date":"2023-11-22","objectID":"/posts/2023-11-22-python-basic/:1:1","tags":["python","python-basic"],"title":"Python basic","uri":"/posts/2023-11-22-python-basic/"},{"categories":["DevOps"],"content":"2ã€å˜é‡å®šä¹‰ å˜é‡åç§°è§„èŒƒï¼š å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿_ åªèƒ½ä»¥å­—æ¯ã€ä¸‹åˆ’çº¿_å¼€å¤´ ä¸èƒ½ä¸pythonå…³é”®å­—å†²çªã€‚ï¼ˆprint if for while else ï¼‰ #äº¤äº’å¼å˜é‡èµ‹å€¼ username = input(\"è¾“å…¥ç”¨æˆ·åï¼š \") #æ³¨æ„ï¼š #è¿”å›çš„ç»“æœæ˜¯å­—ç¬¦ä¸² print(\"ç”¨æˆ·åï¼š %s\" % username) åˆ é™¤å˜é‡ name = \"Martin\" print(name) del name print(name) pythonå˜é‡ä¸å…¶ä»–è¯­è¨€ä¸åŒä¹‹å¤„ å¼±ç±»å‹ åœ°å€å¼•ç”¨ç±»å‹ number_01 = 10 number_02 = 10 print(id(number_01)) print(id(number_02)) number_01 = 100 number_02 = number_01 print(id(number_01)) print(id(number_02)) å†…ç½®å‡½æ•° id() è¿”å›å˜é‡çš„å†…å­˜åœ°å€ type() è¿”å›å˜é‡çš„ç±»å‹ å†…å­˜ä½¿ç”¨æœºåˆ¶ æ¯ä¸ªå˜é‡å®šä¹‰åï¼Œä¼šåœ¨å†…å­˜ä¸­å¼€è¾Ÿä¸€æ®µç©ºé—´ï¼Œè¿™æ®µç©ºé—´å¯¹åº”å­˜åœ¨ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œå˜é‡è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå¼•ç”¨è®¡æ•°å™¨ä¼šè‡ªåŠ¨å¢åŠ ï¼›å½“pythonè§£é‡Šå™¨æ£€æµ‹åˆ°ä¸€æ®µå†…å­˜çš„å¼•ç”¨è®¡æ•°å™¨ä¸º0åï¼Œä¼šè‡ªåŠ¨æ¸…ç†è¯¥å†…å­˜ ","date":"2023-11-22","objectID":"/posts/2023-11-22-python-basic/:1:2","tags":["python","python-basic"],"title":"Python basic","uri":"/posts/2023-11-22-python-basic/"},{"categories":["DevOps"],"content":"3ã€å˜é‡çš„ç±»å‹ æ•°å­— å­—ç¬¦ä¸² åˆ—è¡¨ å…ƒç»„ å­—å…¸ é›†åˆ Bytes ","date":"2023-11-22","objectID":"/posts/2023-11-22-python-basic/:1:3","tags":["python","python-basic"],"title":"Python basic","uri":"/posts/2023-11-22-python-basic/"},{"categories":["DevOps"],"content":"4ã€è¿ç®— #æ•°å­¦è¿ç®—ç¬¦ \u003e\u003e\u003e a = 10 \u003e\u003e\u003e b = 4 \u003e\u003e\u003e a + b 14 \u003e\u003e\u003e a - b 6 \u003e\u003e\u003e a * b 40 \u003e\u003e\u003e a ** b 10000 \u003e\u003e\u003e \u003e\u003e\u003e a / b 2.5 \u003e\u003e\u003e a // b 2 \u003e\u003e\u003e a % b 2 \u003e\u003e\u003e a = 10 \u003e\u003e\u003e a = a + 1 \u003e\u003e\u003e a 11 \u003e\u003e\u003e a += 1 \u003e\u003e\u003e a 12 \u003e\u003e\u003e #æ¯”è¾ƒè¿ç®—ç¬¦ ==, !=, \u003e, \u003e=, \u003c=, \u003c é€»è¾‘è¿ç®—ç¬¦ and, or, not \u003e\u003e\u003e a = 10 \u003e\u003e\u003e \u003e\u003e\u003e \u003e\u003e\u003e a \u003e 20 and 1 \u003c 2 False \u003e\u003e\u003e \u003e\u003e\u003e a \u003e 20 or 1 \u003c 2 True \u003e\u003e\u003e \u003e\u003e\u003e not a \u003e 20 True \u003e\u003e\u003e æ•°åˆ¶è½¬æ¢ \u003e\u003e\u003e a = 10 \u003e\u003e\u003e bin(a) '0b1010' \u003e\u003e\u003e oct(a) '0o12' \u003e\u003e\u003e hex(a) '0xa' \u003e\u003e\u003e #ç”Ÿæˆéšæœºæ•°çš„æ¨¡å— \u003e\u003e\u003e import random \u003e\u003e\u003e random.randint(0, 10) 7 \u003e\u003e\u003e random.randint(0, 10) 9 \u003e\u003e\u003e random.randint(0, 10) 2 \u003e\u003e\u003e random.randint(0, 10) 3 \u003e\u003e\u003e random.randint(0, 10) 6 ç¤ºä¾‹ï¼šå››åˆ™è¿ç®— number_01 = int(input(\"è¾“å…¥ç¬¬1ä¸ªæ•°å­—ï¼š \")) number_02 = int(input(\"è¾“å…¥ç¬¬2ä¸ªæ•°å­—ï¼š \")) print(\"%s + %s = %s\" % (number_01, number_02, number_01 + number_02)) print(\"%s - %s = %s\" % (number_01, number_02, number_01 - number_02)) print(\"%s * %s = %s\" % (number_01, number_02, number_01 * number_02)) print(\"%s / %s = %s\" % (number_01, number_02, number_01 / number_02)) print(\"%s // %s = %s\" % (number_01, number_02, number_01 // number_02)) ","date":"2023-11-22","objectID":"/posts/2023-11-22-python-basic/:1:4","tags":["python","python-basic"],"title":"Python basic","uri":"/posts/2023-11-22-python-basic/"},{"categories":["DevOps"],"content":"5ã€é€»è¾‘æ§åˆ¶è¯­å¥ åŒçº§ä»£ç è¦æœ‰ç›¸åŒç¼©è¿›ï¼Œé»˜è®¤4ä¸ªç©ºæ ¼ æ¡ä»¶åˆ¤æ–­ â€” if if æ¡ä»¶: æ“ä½œè¯­å¥ æ“ä½œè¯­å¥ if 1 \u003c 2: print(\"AAA\") print(\"BBB\") # åªè¦æ•°å­—ä¸ç­‰äº0ï¼Œæ¡ä»¶ä¸ºçœŸ number = 10 if number: print(\"AAA\") print(\"BBB\") number = 10 if not number: print(\"AAA\") print(\"BBB\") # True, False é¦–å­—æ¯å…¨æ˜¯å¤§å†™ if True: print(\"AAA\") if â€¦. else number = 100 if number \u003c 20: print(\"AAAA\") else: print(\"BBBB\") if â€¦ elif â€¦ elif â€¦. else number = int(input(\"Enter number: \")) if number \u003e 10: print(\"AAA\") elif number \u003e 30: print(\"BBBB\") elif number \u003e 40: print(\"CCCC\") else: print(\"DDDD\") åµŒå¥—if age = int(input(\"è¾“å…¥ä½ çš„å¹´é¾„ï¼š \")) if age \u003c= 18: gender = input(\"è¾“å…¥ä½ çš„æ€§åˆ«ï¼š \") if gender == \"M\": print(\"å‡†å¤‡å…¥é˜Ÿ\") else: print(\"ç¡å§\") else: print(\"å›å®¶æ´—æ´—ç¡å§\") å¾ªç¯ for while forå¾ªç¯ï¼š for å˜é‡ in å–å€¼: æ“ä½œè¯­å¥ æ“ä½œè¯­å¥ for i in range(5): print(\"ç¬¬%sæ¬¡å¾ªç¯å¼€å§‹\" % i) print(\"ç¬¬%sæ¬¡å¾ªç¯ç»“æŸ\" % i) print(\"-----------------\") ä¸­æ–­å¾ªç¯ï¼š #break ä¸­æ–­æ•´ä½“å¾ªç¯ for i in range(5): print(\"ç¬¬%sæ¬¡å¾ªç¯å¼€å§‹\" % i) if i == 3: break print(\"ç¬¬%sæ¬¡å¾ªç¯ç»“æŸ\" % i) print(\"-----------------\") continue ä¸­æ–­æœ¬æ¬¡å¾ªç¯ for i in range(5): print(\"ç¬¬%sæ¬¡å¾ªç¯å¼€å§‹\" % i) if i == 3: continue print(\"ç¬¬%sæ¬¡å¾ªç¯ç»“æŸ\" % i) print(\"-----------------\") ç¤ºä¾‹ï¼šæ–æ³¢é‚£å¥‘æ•°åˆ— length=int(input(\"input length:\")) i=0 j=1 tmp=1 for n in range(length): print( tmp,\" \",end=) tmp = i + j i = j j = tmp print() whileå¾ªç¯ while æ¡ä»¶: æ“ä½œè¯­å¥ æ“ä½œè¯­å¥ i = 1 while i \u003c= 4: print(\"ç¬¬%sæ¬¡å¾ªç¯å¼€å§‹\" % i) print(\"ç¬¬%sæ¬¡å¾ªç¯ç»“æŸ\" % i) print(\"-----------------\") i += 1 while True: æ“ä½œè¯­å¥ æ“ä½œè¯­å¥ ç¤ºä¾‹ï¼š å®ç°æ•°åˆ¶è½¬æ¢ import sys number = int(input(\"è¾“å…¥æ•°å­—ï¼š \")) menu = \"\"\" 1ã€äºŒè¿›åˆ¶ 2ã€å…«è¿›åˆ¶ 3ã€åå…­è¿›åˆ¶ 4ã€é€€å‡º è¾“å…¥ä½ çš„é€‰æ‹©ï¼šd \"\"\" ''' å¾ªç¯åˆ¤æ–­ç”¨æˆ·çš„é€‰æ‹©ï¼Œæ ¹æ®ä¸åŒçš„é€‰æ‹©åšä¸åŒçš„å“åº” ''' while True: choice = int(input(menu)) if choice == 1: print(\"æ•°å­—%sçš„äºŒè¿›åˆ¶å½¢å¼ï¼š%s\" % (number, bin(number))) elif choice == 2: print(\"æ•°å­—%sçš„å…«è¿›åˆ¶å½¢å¼ï¼š%s\" % (number, oct(number))) elif choice == 3: print(\"æ•°å­—%sçš„åå…­è¿›åˆ¶å½¢å¼ï¼š%s\" % (number, hex(number))) else: print(\"è°¢è°¢\") sys.exit() pass: å ä½ç¬¦ #!/usr/bin/python import time for i in range(5): print i if i == 1: pass ---- ä»£ç æ¡© ifä¹‹é—´ä¸èƒ½ç©ºä»£ç å¯ä»¥ç”¨passå ä½ if i == 2: continue if i == 3: break print \"#\"*10 else: print \"END\" for j in range(2): print \"---\u003e\",j [root@server python]# python dic.py 0 ########## 1 ########## 2 3 ---\u003e 0 ---\u003e 1 ç»“æŸæ‰§è¡Œ [root@server python]# cat dic.py #!/usr/bin/python for i in range(10): print i if i == 5: exit() [root@server python]# python dic.py 0 1 2 3 4 5 switchè¯­å¥ switchè¯­å¥ç”¨äºç¼–å†™å¤šåˆ†æ”¯ç»“æ„çš„ç¨‹åº,ç±»ä¼¼ä¸ifâ€¦ elifâ€¦ elseè¯­å¥ switchè¯­å¥è¡¨è¾¾çš„åˆ†æ”¯ç»“æ„æ¯”ifâ€¦ elifâ€¦ elseè¯­å¥è¡¨è¾¾çš„æ›´æ¸…æ™°,ä»£ç å¯è¯»æ€§æ›´é«˜ï¼Œä½†æ˜¯pythonå¹¶æ²¡æœ‰æä¾›switchè¯­å¥ pythonå¯ä»¥é€šè¿‡å­—å…¸å®ç°switchè¯­å¥çš„åŠŸèƒ½ å®ç°æ–¹æ³•åˆ†ä¸ºä¸¤æ­¥ é¦–å…ˆï¼šå®šä¹‰ä¸€ä¸ªå­—å…¸ï¼Œå…¶æ¬¡,è°ƒç”¨å­—å…¸çš„get()è·å–ç›¸åº”çš„è¡¨è¾¾å¼xxxxxxxxxx [root@www python]# cat test.py #!/usr/bin/bash #coding:utf8 from __future__ import division def jia(x,y): return x+y def jian(x,y): return x-y def cheng(x,y): return x*y def chu(x,y): return x/y def operator(x,o,y): if o == \"+\": print jia(x,y) elif o == \"-\": print jian(x,y) elif o == \"*\": print cheng(x,y) elif o == \"/\": print chu(x,y) else: pass operator(2,\"/\",4) #!/usr/bin/bash #coding:utf8 from __future__ import division def jia(x,y): return x+y def jian(x,y): return x-y def cheng(x,y): return x*y def chu(x,y): return x/y operator = {\"+\":jia,\"-\":jian,\"*\":cheng,\"/\":chu} print operator [\"/\"](3,2) ç¤ºä¾‹ï¼š å†™ä¸€ä¸ªå–æ°´æœçš„èœå•(æœ‰èœå•),å†å°†ä»–è½¬æ¢ä¸ºswitchæ ¼å¼ menu=\"\"\" 1ã€apple 2ã€banala 3ã€orange \"\"\" fuirt={1:['apple',5],2:['banala',3],3:['orange',7]} print(fuirt[1]) while True: print(menu) tmp=int(input(\"è¯·è¾“å…¥è¦æŸ¥è¯¢ä»·æ ¼çš„æ°´æœ:\")) print(\"%sçš„ä»·æ ¼æ˜¯ %s å…ƒ/æ–¤\"%(fuirt[tmp][0],fuirt[tmp][1])) ","date":"2023-11-22","objectID":"/posts/2023-11-22-python-basic/:1:5","tags":["python","python-basic"],"title":"Python basic","uri":"/posts/2023-11-22-python-basic/"},{"categories":["DevOps"],"content":"å…­ã€å‡½æ•° 1ã€æ ¼å¼ æœªå®šä¹‰è¿”å›å€¼ \u003e\u003e\u003e def fun(): ... print (\"a\") \u003e\u003e\u003e var=fun() a \u003e\u003e\u003e print (var) None å®šä¹‰è¿”å›å€¼ \u003e\u003e\u003e def fun(): ... return \"ok\" ... ... \u003e\u003e\u003e var=fun() \u003e\u003e\u003e print (var) ok 2ã€é»˜è®¤å€¼ #!/usr/bin/python # -*- coding: UTF-8 -*- #å¯å†™å‡½æ•°è¯´æ˜ def printinfo( name, age = 35 ): \"æ‰“å°ä»»ä½•ä¼ å…¥çš„å­—ç¬¦ä¸²\" print \"Name: \", name print \"Age \", age return #è°ƒç”¨printinfoå‡½æ•° printinfo( age=50, name=\"miki\" ) printinfo( name=\"miki\" ) 3ã€ä¸å®šé•¿å‚æ•° #!/usr/bin/python # -*- coding: UTF-8 -*- # å¯å†™å‡½æ•°è¯´æ˜ def printinfo( arg1, *vartuple ): \"æ‰“å°ä»»ä½•ä¼ å…¥çš„å‚æ•°\" print \"è¾“å‡º: \" print arg1 for var in vartuple: print var return # è°ƒç”¨printinfo å‡½æ•° printinfo( 10 ) printinfo( 70, 60, 50 ) ","date":"2023-11-22","objectID":"/posts/2023-11-22-python-basic/:1:6","tags":["python","python-basic"],"title":"Python basic","uri":"/posts/2023-11-22-python-basic/"},{"categories":["DevOps"],"content":"ä¸ƒã€æ¨¡å— æœç´¢è·¯å¾„æ˜¯ä¸€ä¸ªè§£é‡Šå™¨ä¼šå…ˆè¿›è¡Œæœç´¢çš„æ‰€æœ‰ç›®å½•çš„åˆ—è¡¨ã€‚å¦‚æƒ³è¦å¯¼å…¥æ¨¡å— support.pyï¼Œéœ€è¦æŠŠå‘½ä»¤æ”¾åœ¨è„šæœ¬çš„é¡¶ç«¯ï¼š # support.py def print_func( par ): print \"Hello : \", par return # test.py #!/usr/bin/python # -*- coding: UTF-8 -*- # å¯¼å…¥æ¨¡å— import support # ç°åœ¨å¯ä»¥è°ƒç”¨æ¨¡å—é‡ŒåŒ…å«çš„å‡½æ•°äº† support.print_func(\"sugar\") Python çš„ from è¯­å¥è®©ä½ ä»æ¨¡å—ä¸­å¯¼å…¥ä¸€ä¸ªæŒ‡å®šçš„éƒ¨åˆ†åˆ°å½“å‰å‘½åç©ºé—´ä¸­ã€‚è¯­æ³•å¦‚ä¸‹ï¼š import module_a #å¯¼å…¥æ•´ä¸ªæ¨¡å—åŠŸèƒ½ module_a.xxx #è°ƒç”¨ from module import xx # å¯¼å…¥æŸä¸ªæ¨¡å—ä¸‹çš„æŸä¸ªæ–¹æ³• or å­æ¨¡å— from module.xx.xx import xx as rename #å¯¼å…¥åä¸€ä¸ªæ–¹æ³•åé‡å‘½ä»¤ from module.xx.xx import * #å¯¼å…¥ä¸€ä¸ªæ¨¡å—ä¸‹çš„æ‰€æœ‰æ–¹æ³•ï¼Œä¸å»ºè®®ä½¿ç”¨ ","date":"2023-11-22","objectID":"/posts/2023-11-22-python-basic/:1:7","tags":["python","python-basic"],"title":"Python basic","uri":"/posts/2023-11-22-python-basic/"},{"categories":["DevOps"],"content":"å…«ã€é¢å‘å¯¹è±¡ å®šä¹‰ç±»ä¸å®ä¾‹åŒ– class Ren: name = \"äºº\" def run(self): print(\"è·‘æ­¥\") cmd = Ren() print(cmd) ç§æœ‰å±æ€§ä¸æ–¹æ³• åœ¨å±æ€§æˆ–è€…æ–¹æ³•å‰åŠ __çš„ï¼Œå³è¡¨ç¤ºè¯¥æ–¹æ³•å’Œå±æ€§ä¸ºç§æœ‰ç±»å¤–ä¸å¯è°ƒç”¨ #!/usr/bin/python # -*- coding: UTF-8 -*- class Employee: 'æ‰€æœ‰å‘˜å·¥çš„åŸºç±»' empCount = 0 def __init__(self, name, salary): self.name = name self.salary = salary Employee.empCount += 1 def displayCount(self): print \"Total Employee %d\" % Employee.empCount def displayEmployee(self): print \"Name : \", self.name, \", Salary: \", self.salary ç±»çš„ç»§æ‰¿ #!/usr/bin/python # -*- coding: UTF-8 -*- class Parent: # å®šä¹‰çˆ¶ç±» parentAttr = 100 def __init__(self): print \"è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°\" def parentMethod(self): print 'è°ƒç”¨çˆ¶ç±»æ–¹æ³•' def setAttr(self, attr): Parent.parentAttr = attr def getAttr(self): print \"çˆ¶ç±»å±æ€§ :\", Parent.parentAttr class Child(Parent): # å®šä¹‰å­ç±» def __init__(self): print \"è°ƒç”¨å­ç±»æ„é€ æ–¹æ³•\" def childMethod(self): print 'è°ƒç”¨å­ç±»æ–¹æ³•' c = Child() # å®ä¾‹åŒ–å­ç±» c.childMethod() # è°ƒç”¨å­ç±»çš„æ–¹æ³• c.parentMethod() # è°ƒç”¨çˆ¶ç±»æ–¹æ³• c.setAttr(200) # å†æ¬¡è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³• - è®¾ç½®å±æ€§å€¼ c.getAttr() # å†æ¬¡è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³• - è·å–å±æ€§å€¼ æ–¹æ³•é‡å†™ #!/usr/bin/python # -*- coding: UTF-8 -*- class Parent: # å®šä¹‰çˆ¶ç±» def myMethod(self): print 'è°ƒç”¨çˆ¶ç±»æ–¹æ³•' class Child(Parent): # å®šä¹‰å­ç±» def myMethod(self): print 'è°ƒç”¨å­ç±»æ–¹æ³•' c = Child() # å­ç±»å®ä¾‹ c.myMethod() # å­ç±»è°ƒç”¨é‡å†™æ–¹æ³• ","date":"2023-11-22","objectID":"/posts/2023-11-22-python-basic/:1:8","tags":["python","python-basic"],"title":"Python basic","uri":"/posts/2023-11-22-python-basic/"},{"categories":["DevOps"],"content":"è¿›é˜¶ 1ã€*args å’Œ*kwargs *args å’Œ **kwargs ä¸»è¦ç”¨äºå‡½æ•°å®šä¹‰ã€‚ ä½ å¯ä»¥å°†ä¸å®šæ•°é‡çš„å‚æ•°ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°ã€‚ä½¿ç”¨çš„åœºæ™¯ä¸åŒï¼Œ*args æ˜¯ç”¨æ¥å‘é€ä¸€ä¸ªéé”®å€¼å¯¹çš„å¯å˜æ•°é‡çš„å‚æ•°åˆ—è¡¨ç»™ä¸€ä¸ªå‡½æ•°ï¼Œ**kwargs å…è®¸ä½ å°†ä¸å®šé•¿åº¦çš„é”®å€¼å¯¹ä½œä¸ºå‚æ•°ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°ã€‚ # *args def test_var_args(f_arg, *argv): print(\"first normal arg:\", f_arg) for arg in argv: print(\"another arg through *argv:\", arg) test_var_args('yasoob', 'python', 'eggs', 'test') first normal arg: yasoob another arg through *argv: python another arg through *argv: eggs another arg through *argv: test # *kwargs def greet_me(**kwargs): for key, value in kwargs.items(): print(\"{0} == {1}\".format(key, value)) \u003e\u003e\u003e greet_me(name=\"yasoob\") name == yasoob 2ã€filter filterè¿‡æ»¤åˆ—è¡¨ä¸­çš„å…ƒç´ ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªç”±æ‰€æœ‰ç¬¦åˆè¦æ±‚çš„å…ƒç´ æ‰€æ„æˆçš„åˆ—è¡¨ number_list = range(-5, 5) less_than_zero = filter(lambda x: x \u003c 0, number_list) print(list(less_than_zero)) # è¯‘è€…æ³¨ï¼šä¸Šé¢printæ—¶ï¼ŒåŠ äº†listè½¬æ¢ï¼Œæ˜¯ä¸ºäº†python2/3çš„å…¼å®¹æ€§ # åœ¨python2ä¸­filterç›´æ¥è¿”å›åˆ—è¡¨ï¼Œä½†åœ¨python3ä¸­è¿”å›è¿­ä»£å™¨ # å› æ­¤ä¸ºäº†å…¼å®¹python3, éœ€è¦listè½¬æ¢ä¸€ä¸‹ # Output: [-5, -4, -3, -2, -1] 3ã€é›†åˆ some_list = ['a', 'b', 'c', 'b', 'd', 'm', 'n', 'n'] duplicates = set([x for x in some_list if some_list.count(x) \u003e 1]) print(duplicates) ### è¾“å‡º: set(['b', 'n']) # å–äº¤é›† valid = set(['yellow', 'red', 'blue', 'green', 'black']) input_set = set(['red', 'brown']) print(input_set.intersection(valid)) ### è¾“å‡º: set(['red']) # å·®é›† valid = set(['yellow', 'red', 'blue', 'green', 'black']) input_set = set(['red', 'brown']) print(input_set.difference(valid)) ### è¾“å‡º: set(['brown']) #ä¹Ÿå¯ä»¥ç”¨{}ç¬¦å·æ¥åˆ›å»ºé›†åˆï¼Œå¦‚ï¼š a_set = {'red', 'blue', 'green'} print(type(a_set)) ### è¾“å‡º: \u003ctype 'set'\u003e 4ã€ä¸‰å…ƒè¿ç®— #å¦‚æœæ¡ä»¶ä¸ºçœŸï¼Œè¿”å›çœŸ å¦åˆ™è¿”å›å‡ condition_is_true if condition else condition_is_false is_fat = True state = \"fat\" if is_fat else \"not fat\" 5ã€å¼‚å¸¸å¤„ç† def cccc(): pass # è·å–æ‰€æœ‰ç±»å‹çš„å¼‚å¸¸ä¿¡æ¯ try: cccc print(\"æˆåŠŸ\") except Exception as e: print(e) print(\"å¼‚å¸¸\") ","date":"2023-11-22","objectID":"/posts/2023-11-22-python-basic/:1:9","tags":["python","python-basic"],"title":"Python basic","uri":"/posts/2023-11-22-python-basic/"},{"categories":["DevOps"],"content":"è¡¥å…… # æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œä¸¤ç§æ–¹å¼ \u003e\u003e\u003e year=2019 \u003e\u003e\u003e month=6 \u003e\u003e\u003e day=18 \u003e\u003e\u003e f\"Today is {year} {month} {day}\" 'Today is 2019 6 18' \u003e\u003e\u003e \"a{}{}\".format(\"b\",\"c\") 'abc' python æœ¬åœ°åŒ…å¯¼å…¥ #filepath # addons/book/book.py # pythonçš„åŒ…æ˜¯ä»¥ç›®å½•+æ–‡ä»¶å+æ–‡ä»¶åé‡Œçš„å¯¹è±¡å½¢å¼ä½¿ç”¨ from addons.book.book import book_bp è£…é¥°å™¨ è£…é¥°å™¨æ˜¯ä¸€ç§ç”¨äºä¿®æ”¹å‡½æ•°æˆ–æ–¹æ³•è¡Œä¸ºçš„é«˜çº§åŠŸèƒ½ã€‚è£…é¥°å™¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ¥å—å‡½æ•°ä½œä¸ºå‚æ•°çš„å‡½æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°æˆ–æ–¹æ³•ã€‚å®ƒä»¬é€šå¸¸ç”¨äºæ—¥å¿—è®°å½•ã€è®¿é—®æ§åˆ¶ã€ç¼“å­˜ç»“æœã€è®¡æ—¶å‡½æ•°æ‰§è¡Œç­‰åœºæ™¯ã€‚ def my_decorator(func): def action(): print(\"Something is happening before the function is called.\") func() print(\"Something is happening after the function is called.\") return action @my_decorator def say_hello(): print(\"Hello!\") say_hello() ","date":"2023-11-22","objectID":"/posts/2023-11-22-python-basic/:2:0","tags":["python","python-basic"],"title":"Python basic","uri":"/posts/2023-11-22-python-basic/"},{"categories":["DevOps"],"content":"Terraform handbook å‚è€ƒé“¾æ¥ï¼šhttps://blog.gmem.cc/terraform ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:0:0","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"ä¸€ã€ç®€ä»‹ Terraformç”¨äºå®ç°åŸºç¡€è®¾æ–½å³ä»£ç ï¼ˆinfrastructure as codeï¼‰â€”â€” é€šè¿‡ä»£ç ï¼ˆé…ç½®æ–‡ä»¶ï¼‰æ¥æè¿°åŸºç¡€è®¾æ–½çš„æ‹“æ‰‘ç»“æ„ï¼Œå¹¶ç¡®ä¿äº‘ä¸Šèµ„æºå’Œæ­¤ç»“æ„å®Œå…¨å¯¹åº”ã€‚Terraformæœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨Terraform CLIã€‚ Terraform CLIä¸»è¦åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š å‘½ä»¤è¡Œå‰ç«¯ Terraform Languageï¼ˆä»¥ä¸‹ç®€ç§°TLï¼Œè¡ç”Ÿè‡ªHashiCorpé…ç½®è¯­è¨€HCLï¼‰ç¼–å†™çš„ã€æè¿°åŸºç¡€è®¾æ–½æ‹“æ‰‘ç»“æ„çš„é…ç½®æ–‡ä»¶ã€‚é…ç½®æ–‡ä»¶çš„ç»„ç»‡æ–¹å¼æ˜¯æ¨¡å—ã€‚æœ¬æ–‡ä½¿ç”¨æœ¯è¯­â€œé…ç½®â€ï¼ˆConfigurationï¼‰æ¥è¡¨ç¤ºä¸€æ•´å¥—æè¿°åŸºç¡€è®¾æ–½çš„Terraformé…ç½®æ–‡ä»¶ é’ˆå¯¹å„ç§äº‘æœåŠ¡å•†çš„é©±åŠ¨ï¼ˆProviderï¼‰ï¼Œå®ç°äº‘èµ„æºçš„åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤ äº‘ä¸Šèµ„æºä¸å•å•åŒ…æ‹¬åŸºç¡€çš„IaaSèµ„æºï¼Œè¿˜å¯ä»¥æ˜¯DNSæ¡ç›®ã€SaaSèµ„æºã€‚äº‹å®ä¸Šï¼Œé€šè¿‡å¼€å‘Providerï¼Œä½ å¯ä»¥ç”¨Terraformç®¡ç†ä»»ä½•èµ„æºã€‚ Terraformä¼šæ£€æŸ¥é…ç½®æ–‡ä»¶ï¼Œå¹¶ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ã€‚è®¡åˆ’æè¿°äº†é‚£äº›èµ„æºéœ€è¦è¢«åˆ›å»ºã€ä¿®æ”¹æˆ–åˆ é™¤ï¼Œä»¥åŠè¿™äº›èµ„æºä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚Terraformä¼šå°½å¯èƒ½å¹¶è¡Œçš„å¯¹èµ„æºè¿›è¡Œå˜æ›´ã€‚å½“ä½ æ›´æ–°äº†é…ç½®æ–‡ä»¶åï¼ŒTerraformä¼šç”Ÿæˆå¢é‡çš„æ‰§è¡Œè®¡åˆ’ã€‚ ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:1:0","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"äºŒã€å‘½ä»¤è¡Œ ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:2:0","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"1ã€å®‰è£…å‘½ä»¤è¡Œ ç›´æ¥åˆ°https://www.terraform.io/downloads.htmlä¸‹è½½ï¼Œå­˜æ”¾åˆ°$PATHä¸‹å³å¯ã€‚ ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:2:1","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"2ã€åŸºæœ¬ç‰¹æ€§ 1ï¼‰åˆ‡æ¢å·¥ä½œç›®å½• ä½¿ç”¨é€‰é¡¹ -chdir=DIR 2ï¼‰Shellè‡ªåŠ¨è¡¥å…¨ ä½¿ç”¨ terraform -install-autocompleteå®‰è£…è‡ªåŠ¨å®Œæˆè„šæœ¬ï¼Œä½¿ç”¨ terraform -uninstall-autocompleteåˆ é™¤è‡ªåŠ¨å®Œæˆè„šæœ¬ã€‚ ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:2:2","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"3ã€èµ„æºåœ°å€ å¾ˆå¤šå­å‘½ä»¤æ¥å—èµ„æºåœ°å€å‚æ•°ï¼Œä¸‹é¢æ˜¯ä¸€äº›ä¾‹å­ï¼š # èµ„æºç±»å‹.èµ„æºå aws_instance.foo # èµ„æºç±»å‹.èµ„æºåˆ—è¡¨å[ç´¢å¼•] aws_instance.bar[1] # å­æ¨¡å—fooçš„å­æ¨¡å—barä¸­çš„ module.foo.module.bar.aws_instance.baz ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:2:3","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"4ã€é…ç½®æ–‡ä»¶ é…ç½®æ–‡ä»¶çš„è·¯å¾„å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡ TF_CLI_CONFIG_FILEè®¾ç½®ã€‚éWindowsç³»ç»Ÿä¸­ï¼Œ $HOME/.terraformrcä¸ºé»˜è®¤é…ç½®æ–‡ä»¶è·¯å¾„ã€‚é…ç½®æ–‡ä»¶è¯­æ³•ç±»ä¼¼äºTFæ–‡ä»¶ï¼š # providerç¼“å­˜ç›®å½• plugin_cache_dir = \"$HOME/.terraform.d/plugin-cache\" # disable_checkpoint = true # å­˜æ”¾å‡­è¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¨¡å—ä»“åº“ã€æ”¯æŒè¿œç¨‹æ“ä½œçš„ç³»ç»Ÿçš„å‡­è¯ credentials \"app.terraform.io\" { token = \"xxxxxx.atlasv1.zzzzzzzzzzzzz\" } # æ”¹å˜é»˜è®¤å®‰è£…é€»è¾‘ provider_installation { # ä¸ºexample.comæä¾›æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿé•œåƒï¼Œè¿™æ ·å®‰è£…example.com/*/*çš„provideræ—¶å°±ä¸ä¼šå»ç½‘ç»œä¸Šè¯·æ±‚ # é»˜è®¤è·¯å¾„æ˜¯ï¼š # ~/.terraform.d/plugins/${host_name}/${namespace}/${type}/${version}/${target} # ä¾‹å¦‚ï¼š # ~/.terraform.d/plugins/hashicorp.com/edu/hashicups/0.3.1/linux_amd64/terraform-provider-hashicups_v0.3.1 filesystem_mirror { path = \"/usr/share/terraform/providers\" include = [\"example.com/*/*\"] } direct { exclude = [\"example.com/*/*\"] } # Terraformä¼šåœ¨terraform initçš„æ—¶å€™ï¼Œæ ¡éªŒProviderçš„ç‰ˆæœ¬å’Œchecksumã€‚Providerä»Registryæˆ–è€…æœ¬åœ° # ç›®å½•ä¸‹è½½Providerã€‚å½“æˆ‘ä»¬å¼€å‘Providerçš„æ—¶å€™ï¼Œå¸¸å¸¸éœ€è¦æ–¹ä¾¿çš„æµ‹è¯•ä¸´æ—¶Providerç‰ˆæœ¬ï¼Œè¿™ç§Providerè¿˜ # æ²¡æœ‰å…³è”ç‰ˆæœ¬å·ï¼Œä¹Ÿæ²¡æœ‰åœ¨Registryä¸­æ³¨å†ŒChencksum # ä¸ºäº†ç®€åŒ–å¼€å‘ï¼Œå¯ä»¥é…ç½®dev_overridesï¼Œå®ƒèƒ½è¦†ç›–æ‰€æœ‰é…ç½®çš„å®‰è£…æ–¹æ³• dev_overrides { \"hashicorp.com/edu/hashicups-pf\" = \"$(go env GOBIN)\" } } ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:2:4","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"5ã€init é…ç½®å·¥ä½œç›®å½•ï¼Œä¸ºä½¿ç”¨å…¶å®ƒå‘½ä»¤åšå¥½å‡†å¤‡ã€‚ Terraformå‘½ä»¤éœ€è¦åœ¨ä¸€ä¸ªç¼–å†™äº†Terraformé…ç½®æ–‡ä»¶çš„ç›®å½•ï¼ˆé…ç½®æ ¹ç›®å½•ï¼‰ä¸‹æ‰§è¡Œï¼Œå®ƒä¼šåœ¨æ­¤ç›®å½•ä¸‹å­˜å‚¨è®¾ç½®ã€ç¼“å­˜æ’ä»¶/æ¨¡å—ï¼Œä»¥åŠï¼ˆé»˜è®¤ä½¿ç”¨Localåç«¯æ—¶ï¼‰å­˜å‚¨çŠ¶æ€æ•°æ®ã€‚æ­¤ç›®å½•å¿…é¡»è¿›è¡Œåˆå§‹åŒ–ã€‚ åˆå§‹åŒ–åï¼Œä¼šç”Ÿæˆä»¥ä¸‹é¢å¤–ç›®å½•/æ–‡ä»¶ï¼š .terraformç›®å½•ï¼Œç”¨äºç¼“å­˜providerå’Œæ¨¡å— å¦‚æœä½¿ç”¨Localåç«¯ï¼Œä¿å­˜çŠ¶æ€çš„terraform.tfstateæ–‡ä»¶ã€‚å¦‚æœä½¿ç”¨å¤šå·¥ä½œåŒºï¼Œåˆ™æ˜¯terraform.tfstate.dç›®å½•ã€‚ å¯¹é…ç½®çš„æŸäº›å˜æ›´ï¼Œéœ€è¦é‡æ–°è¿è¡Œåˆå§‹åŒ–ï¼ŒåŒ…æ‹¬provideréœ€æ±‚çš„å˜æ›´ã€æ¨¡å—æº/ç‰ˆæœ¬çº¦æŸçš„å˜æ›´ã€åç«¯é…ç½®çš„å˜æ›´ã€‚éœ€è¦é‡æ–°åˆå§‹åŒ–æ—¶ï¼Œå…¶å®ƒå‘½ä»¤å¯èƒ½ä¼šæ— æ³•æ‰§è¡Œå¹¶æç¤ºä½ è¿›è¡Œåˆå§‹åŒ–ã€‚ å‘½ä»¤ terraform getå¯ä»¥ä»…ä»…ä¸‹è½½ä¾èµ–çš„æ¨¡å—ï¼Œè€Œä¸æ‰§è¡Œå…¶å®ƒinitå­ä»»åŠ¡ã€‚ è¿è¡Œ terraform init -upgradeä¼šå¼ºåˆ¶æ‹‰å–æœ€æ–°çš„ã€åŒ¹é…çº¦æŸçš„ç‰ˆæœ¬å¹¶æ›´æ–°ä¾èµ–é”æ–‡ä»¶ã€‚ ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:2:5","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"6ã€validate æ ¡éªŒé…ç½®æ˜¯å¦åˆæ³•ã€‚ ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:2:6","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"7ã€plan æ˜¾ç¤ºæ‰§è¡Œè®¡åˆ’ï¼Œå³å½“å‰é…ç½®å°†è¯·æ±‚ï¼ˆç»“åˆstateï¼‰å“ªäº›å˜æ›´ã€‚Terraformçš„æ ¸å¿ƒåŠŸèƒ½æ—¶åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤åŸºç¡€è®¾æ–½å¯¹è±¡ï¼Œä½¿åŸºç¡€è®¾æ–½çš„çŠ¶æ€å’Œå½“å‰é…ç½®åŒ¹é…ã€‚å½“æˆ‘ä»¬è¯´è¿è¡ŒTerraformæ—¶ï¼Œä¸»è¦æ˜¯æŒ‡plan/apply/destroyè¿™å‡ ä¸ªå‘½ä»¤ã€‚ terraform planå‘½ä»¤è¯„ä¼°å½“å‰é…ç½®ï¼Œç¡®å®šå…¶å£°æ˜çš„æ‰€æœ‰èµ„æºçš„æœŸæœ›çŠ¶æ€ã€‚ç„¶åæ¯”è¾ƒæ­¤æœŸæœ›çŠ¶æ€å’ŒçœŸå®åŸºç¡€è®¾æ–½çš„å½“å‰çŠ¶æ€ã€‚å®ƒä½¿ç”¨stateæ¥ç¡®å®šå“ªäº›çœŸå®åŸºç¡€è®¾æ–½å¯¹è±¡å’Œå£°æ˜èµ„æºçš„å¯¹åº”å…³ç³»ï¼Œå¹¶ä¸”ä½¿ç”¨providerçš„APIæŸ¥è¯¢æ¯ä¸ªèµ„æºçš„å½“å‰çŠ¶æ€ã€‚å½“ç¡®å®šåˆ°è¾¾æœŸæœ›çŠ¶æ€éœ€è¦æ‰§è¡Œå“ªäº›å˜æ›´åï¼ŒTerraformå°†å…¶æ‰“å°åˆ°æ§åˆ¶å°ï¼Œå®ƒå¹¶ä¸ä¼šæ‰§è¡Œä»»ä½•å®é™…çš„å˜æ›´æ“ä½œã€‚ è®¡åˆ’æ¨¡å¼ planå‘½ä»¤æ”¯æŒä¸¤ç§å¤‡é€‰çš„å·¥ä½œæ¨¡å¼ï¼š é”€æ¯æ¨¡å¼ï¼šåˆ›å»ºä¸€ä¸ªè®¡åˆ’ï¼Œå…¶ç›®æ ‡æ˜¯é”€æ¯æ‰€æœ‰å½“å‰å­˜åœ¨äºé…ç½®ä¸­çš„è¿œç¨‹å¯¹è±¡ï¼Œç•™ä¸‹ä¸€ä¸ªç©ºç™½çš„stateã€‚å¯¹åº”é€‰é¡¹ -destroy ä»…åˆ·æ–°æ¨¡å¼ï¼šåˆ›å»ºä¸€ä¸ªè®¡åˆ’ï¼Œå…¶ç›®æ ‡ä»…ä»…æ˜¯æ›´æ–°stateå’Œæ ¹æ¨¡å—çš„è¾“å‡ºå€¼ï¼Œä»¥ä¾¿å’Œä»Terraformä¹‹å¤–å¯¹åŸºç¡€è®¾æ–½å¯¹è±¡çš„å˜æ›´åŒ¹é…ã€‚å¯¹åº”é€‰é¡¹ -refresh-only æŒ‡å®šè¾“å…¥å˜é‡ ä½¿ç”¨é€‰é¡¹ -var â€˜NAME=VALUEâ€™å¯ä»¥æŒ‡å®šè¾“å…¥å˜é‡ï¼Œè¯¥é€‰é¡¹å¯ä»¥ä½¿ç”¨å¤šæ¬¡ã€‚ ä½¿ç”¨é€‰é¡¹ -var-file=FILENAMEå¯ä»¥ä»æ–‡ä»¶è¯»å–è¾“å…¥å˜é‡ï¼ŒæŸäº›æ–‡ä»¶ä¼šè‡ªåŠ¨è¯»å– ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:2:7","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"8ã€apply åº”ç”¨æ‰§è¡Œè®¡åˆ’ï¼Œåˆ›å»ºã€æ›´æ–°è®¾æ–½å¯¹è±¡ã€‚ applyä¼šåšplançš„ä»»ä½•äº‹æƒ…ï¼Œå¹¶åœ¨å…¶åŸºç¡€ä¸Šï¼Œç›´æ¥æ‰§è¡Œå˜æ›´æ“ä½œã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œapplyå³å¸­çš„æ‰§è¡Œä¸€æ¬¡planï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨å·²ä¿å­˜çš„plan å‘½ä»¤æ ¼å¼ï¼š terraform apply [options] [plan file] è‡ªåŠ¨ç¡®è®¤ é€‰é¡¹ -auto-approveå¯ä»¥è‡ªåŠ¨ç¡®è®¤å¹¶æ‰§è¡Œæ‰€éœ€æ“ä½œï¼Œä¸éœ€è¦äººå·¥ç¡®è®¤ã€‚ ä½¿ç”¨å·²æœ‰è®¡åˆ’ å¦‚æœæŒ‡å®šplan fileå‚æ•°ï¼Œåˆ™è¯»å–å…ˆå‰ä¿å­˜çš„è®¡åˆ’å¹¶æ‰§è¡Œã€‚ è®¡åˆ’æ¨¡å¼ æ”¯æŒplanå‘½ä»¤ä¸­å…³äºè®¡åˆ’æ¨¡å¼çš„é€‰é¡¹ã€‚ ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:2:8","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"ä¸‰ã€TFè¯­è¨€ ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:3:0","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"1ã€å— é…ç½®æ–‡ä»¶ç”±è‹¥å¹²å—ï¼ˆBlockï¼‰ç»„æˆï¼Œå—çš„è¯­æ³•å¦‚ä¸‹ï¼š # Block header, which identifies a block \u003cBLOCK TYPE\u003e \"\u003cBLOCK LABEL\u003e\" \"\u003cBLOCK LABEL\u003e\" \"...\" { # Block body \u003cIDENTIFIER\u003e = \u003cEXPRESSION\u003e # Argument } å—æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå®ƒçš„ä½œç”¨å–å†³äºå—çš„ç±»å‹ã€‚å—å¸¸å¸¸ç”¨æ¥æè¿°æŸä¸ªèµ„æºçš„é…ç½®ã€‚ å–å†³äºå—çš„ç±»å‹ï¼Œæ ‡ç­¾çš„æ•°é‡å¯ä»¥æ˜¯0-Nä¸ªã€‚å¯¹äºresourceå—ï¼Œæ ‡ç­¾æ•°é‡ä¸ºä¸¤ä¸ªã€‚æŸäº›ç‰¹æ®Šçš„å—ï¼Œå¯èƒ½æ”¯æŒä»»æ„æ•°é‡çš„æ ‡ç­¾ã€‚æŸäº›å†…åµŒçš„å—ï¼Œä¾‹å¦‚network_interfaceï¼Œåˆ™ä¸æ”¯æŒæ ‡ç­¾ã€‚ å—ä½“ä¸­å¯ä»¥åŒ…å«è‹¥å¹²å‚æ•°ï¼ˆArgumentï¼‰ï¼Œæˆ–è€…å…¶å®ƒå†…åµŒçš„å—ã€‚å‚æ•°ç”¨äºå°†ä¸€ä¸ªè¡¨è¾¾å¼åˆ†é…åˆ°ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œå¸¸å¸¸å¯¹åº”æŸä¸ªèµ„æºçš„ä¸€æ¡å±æ€§ã€‚è¡¨è¾¾å¼å¯ä»¥æ˜¯å­—é¢å€¼ï¼Œæˆ–è€…å¼•ç”¨å…¶å®ƒçš„å€¼ï¼Œæ­£æ˜¯è¿™ç§å¼•ç”¨è®©Terraformèƒ½å¤Ÿè¯†åˆ«èµ„æºä¾èµ–å…³ç³»ã€‚ ç›´æ¥ä½äºé…ç½®æ–‡ä»¶æœ€å¤–å±‚çš„å—ï¼Œå«åšé¡¶çº§å—ï¼ˆTop-level Blockï¼‰ï¼ŒTerraformæ”¯æŒæœ‰é™ç§ç±»çš„é¡¶çº§å—ã€‚å¤§éƒ¨åˆ†Terraformç‰¹æ€§ï¼Œä¾‹å¦‚resourceï¼ŒåŸºäºé¡¶çº§å—å®ç°ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š resource \"aws_vpc\" \"main\" { cidr_block = var.base_cidr_block } ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:3:1","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"2ã€æ•°æ®ç±»å‹ ç±»å‹ è¯´æ˜ string Unicodeå­—ç¬¦åºåˆ—ï¼ŒåŸºæœ¬å½¢å¼ â€œhelloâ€ number æ•°å­—ï¼Œå½¢å¼ 6.02 bool trueæˆ– false list/tuple ä¸€ç³»åˆ—çš„å€¼ï¼Œå½¢å¼ [â€œus-west-1aâ€, â€œus-west-1câ€] map/object é”®å€¼å¯¹ï¼Œå½¢å¼ {name = â€œMabelâ€, age = 52} ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:3:2","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"3ã€ç©ºå€¼ ç©ºå€¼ä½¿ç”¨ nullè¡¨ç¤ºã€‚ 4ã€å­—ç¬¦ä¸²å’Œæ¨¡æ¿ è½¬ä¹‰å­—ç¬¦ \\n æ¢è¡Œ \\r å›è½¦ \\t åˆ¶è¡¨ \\\" å¼•å· \\\\ åæ–œæ  \\uNNNN Unicodeå­—ç¬¦ \\UNNNNNNNN Unicodeå­—ç¬¦ æ³¨æ„ï¼Œåœ¨Heredocä¸­åæ–œæ ä¸ç”¨äºè½¬ä¹‰ï¼Œå¯ä»¥ä½¿ç”¨ï¼š $${ å­—ç¬¦ä¸²æ’å€¼æ ‡è®°${ %%{ æ¨¡æ¿æŒ‡ä»¤æ ‡è®°%{ æ”¯æŒunixé£æ ¼çš„å­—ç¬¦ä¸² block { value = \u003c\u003cEOT hello world EOT } block { value = \u003c\u003c-EOT hello world EOT } è¦å°†å¯¹è±¡è½¬æ¢ä¸ºJSONæˆ–YAMLï¼Œå¯ä»¥è°ƒç”¨å‡½æ•°ï¼š example = jsonencode({ a = 1 b = \"hello\" }) ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:3:3","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"5ã€æ“ä½œç¬¦ é€»è¾‘æ“ä½œç¬¦ï¼š ! \u0026\u0026 || ç®—æ•°æ“ä½œç¬¦ï¼š * / % + - æ¯”è¾ƒæ“ä½œç¬¦ï¼š \u003e, \u003e=, \u003c, \u003c= ==, != æ¡ä»¶è¡¨è¾¾å¼ condition ? true_val : false_val var.a != \"\" ? var.a : \"default-a\" forè¡¨è¾¾å¼ ä½¿ç”¨forè¡¨è¾¾å¼å¯ä»¥é€šè¿‡è½¬æ¢ä¸€ç§å¤æ‚ç±»å‹è¾“å‡ºï¼Œç”Ÿæˆå¦ä¸€ä¸ªå¤æ‚ç±»å‹ç»“æœã€‚è¾“å…¥ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œå¯ä»¥å¯¹åº”ç»“æœçš„0-1ä¸ªå…ƒç´ ã€‚ä»»ä½•è¡¨è¾¾å¼å¯ä»¥ç”¨äºè½¬æ¢ï¼Œä¸‹é¢æ˜¯ä½¿ç”¨upperå‡½æ•°å°†åˆ—è¡¨è½¬æ¢ä¸ºå¤§å†™ï¼š [for s in var.list : upper(s)] è¾“å…¥ç±»å‹ ä½œä¸ºforè¡¨è¾¾å¼çš„è¾“å…¥çš„ç±»å‹å¯ä»¥æ˜¯list / set / tuple / map / objectã€‚å¯ä»¥ä¸ºforå£°æ˜ä¸¤ä¸ªä¸´æ—¶ç¬¦å·ï¼Œå‰ä¸€ä¸ªè¡¨ç¤ºindexæˆ–keyï¼š [for k, v in var.map : length(k) + length(v)] ç»“æœç±»å‹ ç»“æœçš„ç±»å‹å–å†³äºåŒ…å›´forè¡¨è¾¾å¼çš„å®šç•Œç¬¦ï¼š [] è¡¨ç¤ºç”Ÿæˆçš„ç»“æœæ˜¯å…ƒç»„ {} è¡¨ç¤ºç”Ÿæˆçš„ç»“æœæ˜¯objectï¼Œä½ å¿…é¡»ä½¿ç”¨ =\u003eç¬¦å·ï¼š {for s in var.list : s =\u003e upper(s)} è¾“å…¥è¿‡æ»¤ åŒ…å«ä¸€ä¸ªå¯é€‰çš„ifå­å¥å¯ä»¥å¯¹è¾“å…¥å…ƒç´ è¿›è¡Œè¿‡æ»¤ï¼š [for s in var.list : upper(s) if s != \"\"] ç¤ºä¾‹ï¼š variable \"users\" { type = map(object({ is_admin = boolean })) } locals { admin_users = { for name, user in var.users : name =\u003e user if user.is_admin } } splatè¡¨è¾¾å¼ splatè¡¨è¾¾å¼æä¾›äº†æ›´ç®€å•è¯­æ³•ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä»£æ›¿forè¡¨è¾¾å¼ï¼š [for o in var.list : o.id] # ç­‰ä»·äº var.list[*].id [for o in var.list : o.interfaces[0].name] # ç­‰ä»·äº var.list[*].interfaces[0].name å¯é€‰objectå±æ€§ variable \"with_optional_attribute\" { type = object({ a = string # å¿…é¡»å±æ€§ b = optional(string) # å¯é€‰å±æ€§ }) } ç‰ˆæœ¬çº¦æŸ ç‰ˆæœ¬çº¦æŸæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å­—ç¬¦ä¸²å€¼ï¼Œåœ¨å¼•ç”¨moduleã€ä½¿ç”¨provideræ—¶ï¼Œæˆ–è€…é€šè¿‡terraformå—çš„required_versionæ—¶ï¼Œéœ€è¦ç”¨åˆ°ç‰ˆæœ¬çº¦æŸï¼š # ç‰ˆæœ¬èŒƒå›´åŒºé—´ version = \"\u003e= 1.2.0, \u003c 2.0.0\" # æ“ä½œç¬¦ = ç­‰ä»·äºæ— æ“ä½œç¬¦ï¼Œé™å®šç‰¹å®šç‰ˆæœ¬ != æ’é™¤ç‰¹å®šç‰ˆæœ¬ \u003e \u003e= \u003c \u003c= é™åˆ¶ç‰ˆæœ¬èŒƒå›´ ~\u003e å…è®¸æœ€å³ä¾§çš„ç‰ˆæœ¬å·ç‰‡æ®µçš„å˜åŒ– depends_on è¯¥å…ƒå‚æ•°ç”¨äºå¤„ç†éšå«çš„èµ„æº/æ¨¡å—ä¾èµ–ï¼Œè¿™äº›ä¾èµ–æ— æ³•é€šè¿‡åˆ†æTerraformé…ç½®æ–‡ä»¶å¾—åˆ°ã€‚ä»0.13ç‰ˆæœ¬å¼€å§‹ï¼Œè¯¥å…ƒå‚æ•°å¯ç”¨äºæ¨¡å—ã€‚ä¹‹å‰çš„ç‰ˆæœ¬ä»…ä»…ç”¨äºèµ„æºã€‚ depends_onçš„å€¼æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œå…¶å…ƒç´ å…·å¿…é¡»æ˜¯å…¶å®ƒèµ„æºçš„å¼•ç”¨ï¼Œä¸æ”¯æŒä»»æ„è¡¨è¾¾å¼ã€‚ depends_onåº”å½“ä»…ä»…ç”¨ä½œæœ€åæ‰‹æ®µï¼Œé¿å…æ»¥ç”¨ã€‚ resource \"aws_iam_role\" \"example\" { name = \"example\" assume_role_policy = \"...\" } # è¿™ä¸ªç­–ç•¥å…è®¸è¿è¡Œåœ¨EC2ä¸­çš„å®ä¾‹è®¿é—®S3 API resource \"aws_iam_role_policy\" \"example\" { name = \"example\" role = aws_iam_role.example.name policy = jsonencode({ \"Statement\" = [{ \"Action\" = \"s3:*\", \"Effect\" = \"Allow\", }], }) } resource \"aws_iam_instance_profile\" \"example\" { # è¿™æ˜¯å¯ä»¥è‡ªåŠ¨åˆ†æå‡ºçš„ä¾èµ– role = aws_iam_role.example.name } resource \"aws_instance\" \"example\" { ami = \"ami-a1b2c3d4\" instance_type = \"t2.micro\" # è¿™æ˜¯å¯ä»¥è‡ªåŠ¨åˆ†æå‡ºçš„ä¾èµ–ï¼ŒåŒ…æ‹¬ä¼ é€’æ€§ä¾èµ– iam_instance_profile = aws_iam_instance_profile.example # å¦‚æœè¿™ä¸ªå®ä¾‹ä¸­çš„ç¨‹åºéœ€è¦è®¿é—®S3æ¥å£ï¼Œæˆ‘ä»¬éœ€è¦ç”¨å…ƒå‚æ•°æ˜¾å¼çš„å£°æ˜ä¾èµ– # ä»è€Œåˆ†é…ç­–ç•¥ depends_on = [ aws_iam_role_policy.example, ] } count é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªresourceå—ä»£è¡¨å•ä¸ªäº‘ä¸ŠåŸºç¡€è®¾æ–½å¯¹è±¡ã€‚å¦‚æœä½ æƒ³ç”¨ä¸€ä¸ªresourceå—ç”Ÿæˆå¤šä¸ªç±»ä¼¼çš„èµ„æºï¼Œå¯ä»¥ç”¨countæˆ–for_eachå‚æ•°ã€‚ è®¾ç½®äº†æ­¤å…ƒå‚æ•°çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå¯ä»¥è®¿é—®åä¸º countçš„å˜é‡ï¼Œå®ƒå…·æœ‰å±æ€§ indexï¼Œä¸ºä»0å¼€å§‹è®¡æ•°çš„èµ„æºå®ä¾‹ç´¢å¼•ã€‚ ç¤ºä¾‹ï¼š resource \"aws_instance\" \"server\" { # åˆ›å»º4ä¸ªç±»ä¼¼çš„å®ä¾‹ count = 4 ami = \"ami-a1b2c3d4\" instance_type = \"t2.micro\" tags = { # å®ä¾‹çš„ç´¢å¼•ä½œä¸ºtagçš„ä¸€éƒ¨åˆ† Name = \"Server ${count.index}\" } } ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:3:4","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"for_each å¦‚æœèµ„æºçš„è§„æ ¼å‡ ä¹å®Œå…¨ä¸€è‡´ï¼Œå¯ä»¥ç”¨countï¼Œå¦åˆ™ï¼Œéœ€è¦ä½¿ç”¨æ›´åŠ çµæ´»çš„for_eachå…ƒå‚æ•°ã€‚ for_eachçš„å€¼å¿…é¡»æ˜¯ä¸€ä¸ªæ˜ å°„æˆ–set(string)ï¼Œä½ å¯ä»¥åœ¨ä¸Šä¸‹æ–‡ä¸­è®¿é—® eachå¯¹è±¡ï¼Œ å®ƒå…·æœ‰ keyå’Œ valueä¸¤ä¸ªå±æ€§ï¼Œå¦‚æœfor_eachçš„å€¼æ˜¯é›†åˆï¼Œåˆ™keyå’Œvalueç›¸ç­‰ã€‚ç¤ºä¾‹ï¼š resource \"azurerm_resource_group\" \"rg\" { for_each = { a_group = \"eastus\" another_group = \"westus2\" } # å¯¹äºæ¯ä¸ªé”®å€¼å¯¹éƒ½ä¼šç”Ÿæˆazurerm_resource_groupèµ„æº name = each.key location = each.value } resource \"aws_iam_user\" \"the-accounts\" { # æ•°ç»„è½¬æ¢ä¸ºé›†åˆ for_each = toset( [\"Todd\", \"James\", \"Alice\", \"Dottie\"] ) name = each.key } variable \"vpcs\" { # è¿™é‡Œå®šä¹‰äº†mapç±»å‹çš„å˜é‡ï¼Œå¹¶ä¸”é™å®šäº†mapå…·æœ‰çš„é”® type = map(object({ cidr_block = string })) } # åˆ›å»ºå¤šä¸ªVPCèµ„æº resource \"aws_vpc\" \"example\" { for_each = var.vpcs cidr_block = each.value.cidr_block } # ä¸Šè¿°èµ„æºä½œä¸ºä¸‹é¢é‚£ä¸ªfor_eachçš„å€¼ # åˆ›å»ºå¯¹åº”æ•°é‡çš„ç½‘å…³èµ„æº resource \"aws_internet_gateway\" \"example\" { # ä¸ºæ¯ä¸ªVPCåˆ›å»ºä¸€ä¸ªç½‘å…³ # èµ„æºä½œä¸ºå€¼ for_each = aws_vpc.example # æ˜ å°„çš„å€¼ï¼Œåœ¨è¿™é‡Œæ˜¯å®Œæ•´çš„VPCå¯¹è±¡ vpc_id = each.value.id } # è¾“å‡ºæ‰€æœ‰VPC ID output \"vpc_ids\" { value = { for k, v in aws_vpc.example : k =\u003e v.id } # æ˜¾å¼ä¾èµ–ç½‘å…³èµ„æºï¼Œç¡®ä¿ç½‘å…³åˆ›å»ºåï¼Œè¾“å‡ºæ‰å¯ç”¨ depends_on = [aws_internet_gateway.example] } ","date":"2023-11-22","objectID":"/posts/2023-11-22-terraform-handbook/:3:5","tags":["tf","terraform"],"title":"Terraform handbook","uri":"/posts/2023-11-22-terraform-handbook/"},{"categories":["DevOps"],"content":"Timezone å‚è€ƒé“¾æ¥ï¼š https://bbs.huaweicloud.com/blogs/detail/243151 http://www.timeofdate.com/timezone/abbr/all ","date":"2023-11-20","objectID":"/posts/2023-11-20-timezone/:0:0","tags":["timezone","tz"],"title":"Timezone","uri":"/posts/2023-11-20-timezone/"},{"categories":["DevOps"],"content":"ä¸€ã€è®¾ç½®æ—¶åŒº timedatectl set-timezone Asia/Shanghai ","date":"2023-11-20","objectID":"/posts/2023-11-20-timezone/:1:0","tags":["timezone","tz"],"title":"Timezone","uri":"/posts/2023-11-20-timezone/"},{"categories":["DevOps"],"content":"äºŒã€æ—¶åŒºè¯¦ç»† ","date":"2023-11-20","objectID":"/posts/2023-11-20-timezone/:2:0","tags":["timezone","tz"],"title":"Timezone","uri":"/posts/2023-11-20-timezone/"},{"categories":["DevOps"],"content":"1ã€æ¦‚å¿µ â€‹ åœ¨ä»¥å‰å…¨çƒå›½å®¶éƒ½å¤„äºå†œä¸šç¤¾ä¼šçš„æ—¶å€™ï¼Œäººä»¬é€šè¿‡æ¯å¤©è§‚å¯Ÿå¤ªé˜³çš„ä½ç½®æ¥å†³å®šæ—¶é—´ï¼Œè¿™å°±ä½¿å¾—ä¸åŒç»åº¦çš„åœ°æ–¹æœ‰ä¸åŒçš„æ—¶é—´ã€‚å½“æ—¶äººä»¬æ—…è¡Œä¸»è¦é èµ°å’Œé©¬åŒ¹ï¼Œä¸åŒåœ°æ–¹æ—¶é—´ä¸ä¸€è‡´çš„é—®é¢˜æ²¡æœ‰é‚£ä¹ˆçªå‡ºã€‚ä½†æ˜¯åˆ°äº†åä¹ä¸–çºªéšç€ç«è½¦çš„å‘æ˜ï¼Œäººä»¬ä¸€å¤©æ—…è¡Œçš„è·ç¦»ä¸€ä¸‹å­å»¶é•¿äº†å¾ˆå¤šï¼Œåˆ°ä¸åŒçš„åœ°æ–¹å› æ­¤è¿«åˆ‡éœ€è¦ä¸€ä¸ªé€šç”¨çš„æ–¹æ³•æŠŠå„ä¸ªåœ°æ–¹çš„æ—¶é—´ç»Ÿä¸€èµ·æ¥ã€‚1853å¹´8æœˆ12æ—¥ï¼Œç¾å›½ä¸œéƒ¨ç½—å¾·å²›å·ï¼Œä¸¤è¾†ç«è½¦è¿å¤´ç›¸æ’ï¼Œ14äººå› æ­¤æ­»äº¡ã€‚äº‹æ•…çš„åŸå› åœ¨ä»Šå¤©çœ‹æ¥éš¾ä»¥ç½®ä¿¡â€”â€”ä¸¤è½¦å·¥ç¨‹å¸ˆçš„æ‰‹è¡¨å·®äº†2åˆ†é’Ÿã€‚ 1863å¹´ï¼Œé¦–æ¬¡ä½¿ç”¨æ—¶åŒºçš„æ¦‚å¿µã€‚æ—¶åŒºé€šè¿‡è®¾ç«‹ä¸€ä¸ªåŒºåŸŸçš„æ ‡å‡†æ—¶é—´éƒ¨åˆ†åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚ 1870å¹´ä»£åŠ æ‹¿å¤§é“è·¯å·¥ç¨‹å¸ˆå¼—è±æ˜é¦–æ¬¡æå‡ºå…¨ä¸–ç•ŒæŒ‰ç»Ÿä¸€æ ‡å‡†åˆ’åˆ†æ—¶åŒºã€‚ 1883å¹´11æœˆ18æ—¥ï¼Œç¾å›½é“è·¯éƒ¨é—¨æ­£å¼å®æ–½äº”ä¸ªæ—¶åŒºã€‚ 1884å¹´åç››é¡¿å­åˆçº¿å›½é™…ä¼šè®®æ­£å¼é€šè¿‡é‡‡çº³è¿™ç§æ—¶åŒºåˆ’åˆ†ï¼Œç§°ä¸ºä¸–ç•Œæ ‡å‡†æ—¶åˆ¶åº¦ã€‚å› æ­¤ï¼Œä¸–ç•Œæ ‡å‡†æ—¶åŒºçš„è¯ç”ŸåŒå…¶å®ƒå…¨çƒæ ‡å‡†ä¸€æ ·ä¹Ÿæ˜¯æœ‰ä¸€ä¸ªç¼“æ…¢çš„å‘å±•è¿‡ç¨‹ã€‚ ","date":"2023-11-20","objectID":"/posts/2023-11-20-timezone/:2:1","tags":["timezone","tz"],"title":"Timezone","uri":"/posts/2023-11-20-timezone/"},{"categories":["DevOps"],"content":"2ã€é€šç”¨åè¯è§£é‡Š æ—¶åŒº ï¼šæ—¶åŒºæ˜¯åœ°çƒä¸Šçš„åŒºåŸŸä½¿ç”¨åŒä¸€ä¸ªæ—¶é—´å®šä¹‰ã€‚ä»¥å‰ï¼Œäººä»¬é€šè¿‡è§‚å¯Ÿå¤ªé˜³çš„ä½ç½®ï¼ˆæ—¶è§’ï¼‰å†³å®šæ—¶é—´ï¼Œè¿™å°±ä½¿å¾—ä¸åŒç»åº¦çš„åœ°æ–¹çš„æ—¶é—´æœ‰æ‰€ä¸åŒï¼ˆåœ°æ–¹æ—¶ï¼‰ã€‚1863å¹´ï¼Œé¦–æ¬¡ä½¿ç”¨æ—¶åŒºçš„æ¦‚å¿µã€‚æ—¶åŒºé€šè¿‡è®¾ç«‹ä¸€ä¸ªåŒºåŸŸçš„æ ‡å‡†æ—¶é—´éƒ¨åˆ†åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚ä¸–ç•Œå„ä¸ªå›½å®¶ä½äºåœ°çƒä¸åŒä½ç½®ä¸Šï¼Œå› æ­¤ä¸åŒå›½å®¶ï¼Œç‰¹åˆ«æ˜¯ä¸œè¥¿è·¨åº¦å¤§çš„å›½å®¶æ—¥å‡ºã€æ—¥è½æ—¶é—´å¿…å®šæœ‰æ‰€åå·®ã€‚è¿™äº›åå·®å°±æ˜¯æ‰€è°“çš„æ—¶å·®ã€‚ æ ¼æ—å°¼æ²»æ ‡å‡†æ—¶é—´ï¼š GMTï¼ˆGreenwich Mean Timeï¼‰æ˜¯æŒ‡ä½äºè‹±å›½ä¼¦æ•¦éƒŠåŒºçš„çš‡å®¶æ ¼æ—å°¼æ²»å¤©æ–‡å°çš„æ ‡å‡†æ—¶é—´ï¼Œå› ä¸ºæœ¬åˆå­åˆçº¿è¢«å®šä¹‰ä¸ºåœ¨é‚£é‡Œé€šè¿‡çš„ç»çº¿ã€‚ç”±äºåœ°çƒåœ¨å®ƒçš„æ¤­åœ†è½¨é“é‡Œçš„è¿åŠ¨é€Ÿåº¦ä¸å‡åŒ€ï¼Œåœ°çƒæ¯å¤©çš„è‡ªè½¬æ˜¯æœ‰äº›ä¸è§„åˆ™çš„ï¼Œè€Œä¸”æ­£åœ¨ç¼“æ…¢å‡é€Ÿã€‚æ‰€ä»¥ï¼Œæ ¼æ—å°¼æ²»æ—¶é—´å·²ç»ä¸å†è¢«ä½œä¸ºæ ‡å‡†æ—¶é—´ä½¿ç”¨ã€‚ ä¸–ç•Œåè°ƒæ—¶é—´ ï¼šUTCï¼ˆCoordinated Universal Timeï¼‰æ˜¯ç»è¿‡å¹³å‡å¤ªé˜³æ—¶(ä»¥æ ¼æ—å¨æ²»æ—¶é—´GMTä¸ºå‡†)ã€åœ°è½´è¿åŠ¨ä¿®æ­£åçš„æ–°æ—¶æ ‡ä»¥åŠä»¥ã€Œç§’ã€ä¸ºå•ä½çš„å›½é™…åŸå­æ—¶æ‰€ç»¼åˆç²¾ç®—è€Œæˆçš„æ—¶é—´ã€‚UTCæ¯”GMTæ¥å¾—æ›´åŠ ç²¾å‡†ã€‚å¯¹äºç°è¡Œè¡¨æ¬¾æ¥è¯´ï¼ŒGMTä¸UTCçš„åŠŸèƒ½ä¸ç²¾ç¡®åº¦æ˜¯æ²¡æœ‰å·®åˆ«çš„ã€‚ å¤æ—¥èŠ‚çº¦æ—¶é—´ ï¼šDSTï¼ˆDaylight Saving Timeï¼‰åˆç§°æ—¥å…‰èŠ‚çº¦æ—¶åˆ¶ï¼Œåœ¨è‹±å›½ç§°ä¸ºå¤ä»¤æ—¶é—´(Summer Time)ã€‚æ˜¯ä¸€ç§ä¸ºèŠ‚çº¦èƒ½æºè€Œäººä¸ºè§„å®šåœ°æ–¹æ—¶é—´çš„åˆ¶åº¦ï¼Œåœ¨è¿™ä¸€åˆ¶åº¦å®è¡ŒæœŸé—´æ‰€é‡‡ç”¨çš„ç»Ÿä¸€æ—¶é—´ç§°ä¸ºâ€œå¤ä»¤æ—¶é—´â€ã€‚ä¸€èˆ¬åœ¨å¤©äº®è¾ƒæ—©çš„å¤å­£äººä¸ºå°†æ—¶é—´è°ƒå¿«ä¸€å°æ—¶ï¼Œå¯ä»¥ä½¿äººæ—©èµ·æ—©ç¡ï¼Œå‡å°‘ç…§æ˜é‡ï¼Œä»¥å……åˆ†åˆ©ç”¨å…‰ç…§èµ„æºï¼Œä»è€ŒèŠ‚çº¦ç…§æ˜ç”¨ç”µã€‚å„ä¸ªé‡‡çº³å¤æ—¶åˆ¶çš„å›½å®¶è§„å®šä¸åŒã€‚ æ—¶åŒºè¡¨ç¤ºæ³• å¦‚æœæ—¶é—´æ˜¯ä»¥åè°ƒä¸–ç•Œæ—¶ï¼ˆUTCï¼‰è¡¨ç¤ºï¼Œåˆ™åœ¨æ—¶é—´åé¢ç›´æ¥åŠ ä¸Šä¸€ä¸ªâ€œZâ€ï¼ˆä¸åŠ ç©ºæ ¼ï¼‰ã€‚â€œZâ€æ˜¯åè°ƒä¸–ç•Œæ—¶ä¸­0æ—¶åŒºçš„æ ‡å¿—ã€‚å› æ­¤ï¼Œâ€œ09:30 UTCâ€å°±å†™ä½œâ€œ09:30Zâ€æˆ–æ˜¯â€œ0930Zâ€ã€‚â€œ14:45:15 UTCâ€åˆ™ä¸ºâ€œ14:45:15Zâ€æˆ–â€œ144515Zâ€ã€‚UTCæ—¶é—´ä¹Ÿè¢«å«åšç¥–é²æ—¶é—´ï¼Œå› ä¸ºåœ¨åŒ—çº¦éŸ³æ ‡å­—æ¯ä¸­ç”¨â€œZuluâ€è¡¨ç¤ºâ€œZâ€ã€‚ UTCåç§»é‡ ï¼šUTCåç§»é‡æ˜¯åè°ƒä¸–ç•Œæ—¶ï¼ˆUTCï¼‰å’Œç‰¹å®šåœ°ç‚¹çš„æ—¥æœŸä¸æ—¶é—´å·®å¼‚ï¼Œå…¶å•ä½ä¸ºå°æ—¶å’Œåˆ†é’Ÿã€‚å®ƒé€šå¸¸ä»¥ Â±[hh]:[mm]ã€Â±[hh][mm]ã€æˆ– Â±[hh]çš„æ ¼å¼æ˜¾ç¤ºã€‚æ‰€ä»¥ï¼Œå¦‚æœè¢«æè¿°çš„æ—¶é—´æ¯”UTCæ—©ä¸€å°æ—¶ï¼ˆä¾‹å¦‚æŸæ—çš„å†¬å­£æ—¶é—´ï¼‰ï¼ŒUTCçš„åç§»é‡å°†æ˜¯â€+01:00â€ã€â€+0100â€ã€æˆ–ç®€å•æ˜¾ç¤ºä¸ºâ€+01â€ã€‚ ","date":"2023-11-20","objectID":"/posts/2023-11-20-timezone/:2:2","tags":["timezone","tz"],"title":"Timezone","uri":"/posts/2023-11-20-timezone/"},{"categories":["DevOps"],"content":"3ã€linuxæ—¶åŒºå­˜å‚¨ä½ç½® ä¸ºäº†é¿å…å› å›½å®¶æˆ–åœ°åŒºé—®é¢˜ï¼Œä¸€èˆ¬æ—¶åŒºè®¾ç½®æ˜¯ä»¥åŸå¸‚ä¸ºæ ‡å‡† [root@sugar2 Asia]# pwd /usr/share/zoneinfo/Asia [root@sugar2 Asia]# ls Aden Baku Colombo Ho_Chi_Minh Kashgar Magadan Pyongyang Singapore Ujung_Pandang Almaty Bangkok Dacca Hong_Kong Kathmandu Makassar Qatar Srednekolymsk Ulaanbaatar Amman Barnaul Damascus Hovd Katmandu Manila Qostanay Taipei Ulan_Bator Anadyr Beirut Dhaka Irkutsk Khandyga Muscat Qyzylorda Tashkent Urumqi Aqtau Bishkek Dili Istanbul Kolkata Nicosia Rangoon Tbilisi Ust-Nera Aqtobe Brunei Dubai Jakarta Krasnoyarsk Novokuznetsk Riyadh Tehran Vientiane Ashgabat Calcutta Dushanbe Jayapura Kuala_Lumpur Novosibirsk Saigon Tel_Aviv Vladivostok Ashkhabad Chita Famagusta Jerusalem Kuching Omsk Sakhalin Thimbu Yakutsk Atyrau Choibalsan Gaza Kabul Kuwait Oral Samarkand Thimphu Yangon Baghdad Chongqing Harbin Kamchatka Macao Phnom_Penh Seoul Tokyo Yekaterinburg Bahrain Chungking Hebron Karachi Macau Pontianak Shanghai Tomsk Yerevan ","date":"2023-11-20","objectID":"/posts/2023-11-20-timezone/:2:3","tags":["timezone","tz"],"title":"Timezone","uri":"/posts/2023-11-20-timezone/"},{"categories":["DevOps"],"content":"ä¸‰ã€æ—¶åŒºç®€å†™ UTC GMT SGT æ–°åŠ å¡æ—¶é—´ Singaporeï¼ˆCSTæ—¶é—´æœ‰å¤šä¸ªåœ°åŒºç›¸åŒçš„åå­—ï¼‰ HKT é¦™æ¸¯æ—¶é—´ Hongkong Asia/Hong_Kong ","date":"2023-11-20","objectID":"/posts/2023-11-20-timezone/:3:0","tags":["timezone","tz"],"title":"Timezone","uri":"/posts/2023-11-20-timezone/"},{"categories":["Other"],"content":"ç”µè„‘ä¸€é”®æ¢å¤ï¼š Dellï¼š F12 â€“\u003e Supportassist OS Recovery MSIï¼šF3 Huawei: F10 Mac: é•¿æŒ‰ç”µæºé”®ç›´åˆ°Optionå‡ºç°ï¼ˆmç³»åˆ—macï¼‰ è”æƒ³ï¼šhttps://robotrs.lenovo.com.cn/ZmptY2NtYW5hZ2Vy/p4data/Rdata/Rfiles/OKR.html ","date":"2023-11-20","objectID":"/posts/2023-11-20-pc/:0:0","tags":["recovery","pc"],"title":"Recovery","uri":"/posts/2023-11-20-pc/"},{"categories":["Other"],"content":"ventoy ","date":"2023-11-20","objectID":"/posts/2023-11-20-pc/:1:0","tags":["recovery","pc"],"title":"Recovery","uri":"/posts/2023-11-20-pc/"},{"categories":["Other"],"content":"1ã€ä½¿ç”¨è¯´æ˜ ventoyä¸‹è½½é“¾æ¥ï¼š å®˜æ–¹ï¼šhttps://www.ventoy.net/cn/download.html å›½å†…é•œåƒï¼šhttps://mirror.nju.edu.cn/github-release/ventoy/Ventoy/ ä¸‹è½½è§£å‹åæ‰§è¡ŒVentoy2Disk https://www.ventoy.net/cn/doc_secure.html ","date":"2023-11-20","objectID":"/posts/2023-11-20-pc/:1:1","tags":["recovery","pc"],"title":"Recovery","uri":"/posts/2023-11-20-pc/"},{"categories":["DevOps"],"content":"Gitä½¿ç”¨è§„èŒƒ ä¸€ã€commit \u003ctype\u003e(scope): \u003csubject\u003e Header \u003cBLANK LINE\u003e \u003cbody\u003e Body \u003cBALNK LINE\u003e \u003cfooter\u003e Footer commit messageåŒ…å«Headerã€Bodyã€Footerä¸‰ä¸ªéƒ¨åˆ†ï¼Œå…¶ä¸­Headeræ˜¯å¿…é¡»çš„ Header ç”¨äºè¯´æ˜commitçš„ç±»å‹ featï¼šæ–°åŠŸèƒ½ fixï¼šBUGä¿®å¤ docsï¼šå¯¹æ–‡æ¡£æˆ–è¯´æ˜çš„æ”¹å˜ revertï¼šrevertä¹‹å‰çš„commit ","date":"2023-11-19","objectID":"/posts/2023-11-19-git-to-use/:0:0","tags":["git-branch","branch","dev"],"title":"Git-to-use","uri":"/posts/2023-11-19-git-to-use/"},{"categories":["DevOps"],"content":"äºŒã€åˆ†æ”¯å‘½åè§„èŒƒ masterï¼šé•¿æœŸåˆ†æ”¯ï¼Œä¸ç”Ÿäº§ç¯å¢ƒå‘å¸ƒçš„ä»£ç ä¿æŒåŒæ­¥ï¼Œæ¯ä¸ªcommitå°±æ˜¯ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬ developï¼šé•¿æœŸåˆ†æ”¯ï¼Œç”¨äºæ±‡æ€»å„åˆ†æ”¯ä»£ç  release-*ï¼šçŸ­æœŸåˆ†æ”¯ï¼Œæ¯ä¸ªç‰ˆæœ¬çš„æµ‹è¯•é˜¶æ®µå’Œå‘å¸ƒé˜¶æ®µæ—¶ä½¿ç”¨çš„åˆ†æ”¯ hotfix-*ï¼šçŸ­æœŸåˆ†æ”¯ï¼Œç”¨äºç”Ÿäº§ç¯å¢ƒå‘ç”Ÿé—®é¢˜æ—¶ï¼Œç”¨æ¥è§£å†³é—®é¢˜è€Œæ‹‰å–çš„åˆ†æ”¯ï¼Œè¿›è¡Œä¿®æ”¹bug feature-*ï¼šçŸ­æœŸåˆ†æ”¯ï¼Œç”¨äºå¼€å‘æ–°åŠŸèƒ½ æ ¼å¼ä¸ºï¼š release-6.5.0 hotfix-6.5.0 feature-6.5.0 feature-somesymbol ","date":"2023-11-19","objectID":"/posts/2023-11-19-git-to-use/:0:1","tags":["git-branch","branch","dev"],"title":"Git-to-use","uri":"/posts/2023-11-19-git-to-use/"},{"categories":["DevOps"],"content":"ä¸‰ã€ä¿æŠ¤åˆ†æ”¯ 1ã€masterå’Œdevelopä¸ºä¿æŠ¤åˆ†æ”¯ï¼ˆprotect branchï¼‰åªæœ‰ç®¡ç†å‘˜æœ‰æƒæ“ä½œã€‚ masteråˆ†æ”¯çš„æ¯ä¸€ä¸ªcommitå¯¹åº”ä¸€ä¸ªtagï¼ˆå‘å¸ƒçš„ç‰ˆæœ¬ï¼‰ 2ã€release-*åˆ†æ”¯æ—¶åœ¨developåˆå¹¶featureåˆ†æ”¯åï¼Œæ‹‰å‡ºçš„æ–°åˆ†æ”¯ï¼Œreleaseåˆ†æ”¯ä¸€å®šæ˜¯è¦ä»developæ‹‰å‡ºçš„æ–°åˆ†æ”¯ï¼Œç”¨æˆ·æµ‹è¯•ä»¥åŠpreä¸Šçº¿ï¼ŒæœŸé—´äº§ç”Ÿçš„bugéƒ½åœ¨releaseåˆ†æ”¯ä¸Šæäº¤ï¼Œåœ¨preä¸Šæµ‹è¯•é€šè¿‡åå†å‘å¸ƒç”Ÿäº§ç¯å¢ƒï¼Œç„¶åå†å°†releaseåˆ†æ”¯åˆå¹¶åˆ°developå’Œmasteråˆ†æ”¯ï¼Œå¹¶åœ¨masterä¸Šæ–°å»ºtag 3ã€hotfixåˆ†æ”¯æ˜¯ç”Ÿäº§ç¯å¢ƒå‘ç”Ÿé—®é¢˜ï¼Œä»masterçš„commitæˆ–tagä¸­æ‹‰å‡ºçš„åˆ†æ”¯ï¼Œç»è¿‡æµ‹è¯•å’Œå‘å¸ƒååˆ†åˆ«åˆåˆ°developå’Œmasteråˆ†æ”¯ã€‚ ","date":"2023-11-19","objectID":"/posts/2023-11-19-git-to-use/:0:2","tags":["git-branch","branch","dev"],"title":"Git-to-use","uri":"/posts/2023-11-19-git-to-use/"},{"categories":["DevOps"],"content":"SVN ","date":"2023-11-18","objectID":"/posts/2023-11-18-svn/:1:0","tags":["svn","vcs","dev"],"title":"svn","uri":"/posts/2023-11-18-svn/"},{"categories":["DevOps"],"content":"ä»‹ç»ï¼š ä»£ç ç‰ˆæœ¬ç®¡ç†å·¥å…· èƒ½è®°ä½æœ¬ç‰ˆä¿®æ”¹çš„æƒ…å†µ æŸ¥çœ‹æ‰€æœ‰çš„ä¿®æ”¹è®°å½• æ¢å¤åˆ°ä»»ä½•å†å²ç‰ˆæœ¬ æ¢å¤å·²ç»åˆ é™¤çš„æ–‡ä»¶ svnä¸gitç›¸æ¯”çš„ä¼˜åŠ¿: ä½¿ç”¨ç®€å•ã€ä¸Šæ‰‹å¿« ç›®å½•æƒé™æ§åˆ¶ï¼Œä¼ä¸šå®‰å…¨å¿…å¤‡ å­ç›®å½•checkoutï¼Œå‡å°‘ä¸å¿…è¦çš„æ–‡ä»¶æ£€å‡º ç¼ºç‚¹ï¼š svcæ˜¯é›†ä¸­åˆ°ç‰ˆæœ¬åº“æ§åˆ¶ï¼Œéœ€è¦ä¾èµ–äºä¸­å¤®ç‰ˆæœ¬æ§åˆ¶æœåŠ¡ï¼Œgitæ˜¯åˆ†å¸ƒå¼çš„ï¼Œå¯ä»¥ç‹¬ç«‹å·¥ä½œ ä¸»è¦åº”ç”¨: å¼€å‘äººå‘˜ä»£ç ç‰ˆæœ¬ç®¡ç† é‡è¦æ–‡ä»¶çš„å­˜å‚¨ å…³ç³»å†…éƒ¨æ–‡ä»¶å…±äº« windowså®¢æˆ·ç«¯ï¼šTortoiseSVN ","date":"2023-11-18","objectID":"/posts/2023-11-18-svn/:1:1","tags":["svn","vcs","dev"],"title":"svn","uri":"/posts/2023-11-18-svn/"},{"categories":["DevOps"],"content":"å®‰è£… åŸºäºcentos7 1ã€å®‰è£…svn [root@localhost ~]# yum -y install svn 2ã€åˆ›å»ºsvnç‰ˆæœ¬åº“ åˆ›å»ºç‰ˆæœ¬åº“ç›®å½• [root@localhost /]# mkdir -p /svn/repos [root@localhost /]# svnadmin create /svn/repos 3ã€é…ç½®svn [root@localhost repos]# ll total 8 drwxr-xr-x 2 root root 54 Jun 13 21:47 conf drwxr-sr-x 6 root root 233 Jun 13 21:47 db -r--r--r-- 1 root root 2 Jun 13 21:47 format drwxr-xr-x 2 root root 231 Jun 13 21:47 hooks drwxr-xr-x 2 root root 41 Jun 13 21:47 locks -rw-r--r-- 1 root root 229 Jun 13 21:47 README.txt 1ï¼‰confç›®å½• [root@localhost conf]# ll total 12 -rw-r--r-- 1 root root 1080 Jun 13 21:47 authz -rw-r--r-- 1 root root 309 Jun 13 21:47 passwd -rw-r--r-- 1 root root 3090 Jun 13 21:47 svnserve.conf authzï¼šè´Ÿè´£è´¦å·æƒé™çš„ç®¡ç†ï¼Œæ§åˆ¶è´¦å·æ˜¯å¦è¯»å†™æƒé™ passwdï¼šè´Ÿè´£è´¦å·å’Œå¯†ç çš„ç”¨æˆ·åå•ç®¡ç† svnserve.confï¼šsvnæœåŠ¡å™¨é…ç½®æ–‡ä»¶ 2ï¼‰authzé…ç½®æ–‡ä»¶ [root@localhost conf]# vim authz [repos:/] # / è¡¨ç¤ºæ ¹ç›®å½• ï¼Œæ—¢/svn/repos cccc = rw # rwè¡¨ç¤ºseialtç”¨æˆ·æ‹¥æœ‰è¯»å†™æƒé™ abc = rw # ç»„è®¾ç½® [groups] # harry_and_sally = harry,sally # harry_sally_and_joe = harry,sally,\u0026joe iso = zhang,wang test = li # [/foo/bar] # harry = rw # \u0026joe = r # * = [repos:/iso] jk = rw [repos:/data] @iso = rw # [repository:/baz/fuz] # @harry_and_sally = rw # * = r [repos:/] cccc = rw abc = rw 3ï¼‰passwdæ–‡ä»¶ [root@localhost conf]# vim passwd [users] # harry = harryssecret # sally = sallyssecret cccc = 123456 abc = 123 4ï¼‰svnserve.confæ–‡ä»¶ [root@localhost conf]# vim svnserve.conf [root@localhost conf]# vim svnserve.conf 19 anon-access = none 20 auth-access = write 27 password-db = passwd 34 authz-db = authz 39 realm = cccc anon-access = noneï¼šè¡¨ç¤ºç¦æ­¢åŒ¿åç”¨æˆ·è®¿é—®ã€‚ auth-access = writeï¼šè¡¨ç¤ºæˆæƒç”¨æˆ·æ‹¥æœ‰è¯»å†™æƒé™ã€‚ password-db = passswdï¼šæŒ‡å®šç”¨æˆ·åå£ä»¤æ–‡ä»¶ï¼Œå³ passwd æ–‡ä»¶ã€‚ authz-db = authzï¼šæŒ‡å®šæƒé™é…ç½®æ–‡ä»¶ï¼Œå³ authz æ–‡ä»¶ã€‚ realm = ccccï¼šæŒ‡å®šè®¤è¯åŸŸï¼Œå³/svn/reposç›®å½•ã€‚ 4ã€å¯åŠ¨svn [root@localhost conf]# svnserve -d -r /svn [root@localhost conf]# ps -ef | grep svn root 10923 1 0 22:49 ? 00:00:00 svnserve -d -r /repo root 10925 1396 0 22:49 pts/0 00:00:00 grep --color=auto svn [root@localhost conf]# ss -anpl | grep svn tcp LISTEN 0 7 *:3690 *:* users:((\"svnserve\",pid=10923,fd=3)) [root@localhost conf]# 5ã€è¿æ¥ [root@localhost conf]# svn co svn://127.0.0.1/repos Authentication realm: \u003csvn://127.0.0.1:3690\u003e /repos Password for 'root': Authentication realm: \u003csvn://127.0.0.1:3690\u003e /repos Username: cccc Password for 'cccc': ----------------------------------------------------------------------- ATTENTION! Your password for authentication realm: \u003csvn://127.0.0.1:3690\u003e /repos can only be stored to disk unencrypted! You are advised to configure your system so that Subversion can store passwords encrypted, if possible. See the documentation for details. You can avoid future appearances of this warning by setting the value of the 'store-plaintext-passwords' option to either 'yes' or 'no' in '/root/.subversion/servers'. ----------------------------------------------------------------------- Store password unencrypted (yes/no)? yes Checked out revision 0. [root@localhost conf]# 6ã€ä½¿ç”¨sasldbåŠ å¯†å¯†ç æ–‡ä»¶ è¯´æ˜ï¼šLinuxä¸‹ä½¿ç”¨svnserveçš„SASLè®¤è¯èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œsubversion1.5ä»¥ä¸Šçš„ç‰ˆæœ¬é»˜è®¤è£…äº†saslè®¤è¯ï¼Œè§£å†³svnserveå¯†ç æ–‡ä»¶passwdæ˜¯æ˜æ–‡çš„é—®é¢˜ï¼Œç”Ÿæˆä¸€ä¸ªsaslè®¤è¯çš„å¯†ç æ–‡ä»¶sasldbã€‚ 1ï¼‰ä¿®æ”¹conf/svnserve.confæ–‡ä»¶ [sasl] use-sasl = true min-encryption = 128 max-encryption = 256 æ³¨é‡Šï¼š# password-db = passwdè¿™è¡Œä¿æŒæ³¨é‡Šæ‰çš„çŠ¶æ€ï¼Œä¸ä½¿ç”¨passwdæ–‡ä»¶ã€‚å˜é‡ min-encryption å’Œ max-encryption æ§åˆ¶æœåŠ¡å™¨æ‰€éœ€è¦çš„åŠ å¯†å¼ºåº¦ã€‚è¦å®Œå…¨ç¦ç”¨åŠ å¯†ï¼Œå°±å°†è¿™ 2 ä¸ªå˜é‡çš„å€¼éƒ½è®¾ä¸º 0ã€‚è¦å¯ç”¨ç®€å•çš„æ•°æ®æ ¡éªŒ(ä¾‹å¦‚ï¼Œä¸ºäº†é˜²æ­¢ç¯¡æ”¹å’Œä¿è¯æ•°æ®çš„å®Œæ•´ï¼Œä¸åŠ å¯†)ï¼Œå°±å°†è¿™ 2 ä¸ªå€¼éƒ½è®¾ä¸º 1ã€‚å¦‚æœä½ æƒ³å…è®¸(ä½†ä¸å¼ºåˆ¶)åŠ å¯†ï¼Œå°†æœ€å°å€¼è®¾ä¸º 0ï¼Œæœ€å¤§å€¼è®¾ä¸ºä»»æ„ä½æ•°ã€‚è¦å¼ºåˆ¶åŠ å¯†ï¼Œå°†è¿™ 2 ä¸ªå€¼è®¾ä¸ºå¤§äº 1 çš„æ•°å­—ã€‚åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬è¦æ±‚å®¢æˆ·ç«¯è‡³å°‘è¿›è¡Œ 128 ä½åŠ å¯†ï¼Œä½†æ˜¯ä¸å¤§äº 256 ä½åŠ å¯†ã€‚ 2ï¼‰æ–°å»ºsvn.confæ–‡ä»¶ ä¸€èˆ¬æ”¾åœ¨/usr/Lib/sasl2æˆ–è€…/etc/sasl2ï¼Œå†…å®¹å¦‚ä¸‹ pwcheck_method: auxprop auxprop_plugin: sasldb sasldb_path: /svn/repo/cccc/sasldb mech_list: DIGEST-MD5 æ³¨é‡Šï¼špwcheck_methodæŒ‡æ˜æ£€æŸ¥çš„æ–¹æ³•ï¼Œè¿™é‡Œæ˜¯â€œauxprop â€ï¼Œè¿™ä¸ªpwcheck_methodè¿˜å¯¹åº”äº†å¦‚å¯åŠ¨ä¸€ä¸ªä»£ç†ä½œä¸ºè®¤è¯æœåŠ¡ç­‰æ–¹å¼ï¼Œè€Œç°åœ¨çš„æ„æ€å°±æ˜¯ä½¿ç”¨æœ¬æ–‡ä»¶è¯´çš„æ–¹å¼å»æ£€æŸ¥ã€‚ç„¶åæˆ‘ä»¬æŒ‡æ˜auxprop_pluginä¸ºsasldbï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶å­˜æ”¾ç”¨æˆ·åå¯†ç ï¼Œä¹Ÿå°±æ˜¯/home/svn/svnjiami/sasldb,å…¶å®ƒçš„è®¤è¯ä¿¡æ¯å­˜æ”¾pluginè¿˜æœ‰sqlå’Œldapdbã€‚è€Œmech_listæŒ‡æ˜äº†è®¤è¯ä¿¡æ¯ä¼ é€’æœºåˆ¶ã€‚ 3ï¼‰é‡å¯svn å¦‚æœ svnserve å·²ç»åœ¨è¿è¡Œï¼Œä½ éœ€è¦é‡å¯æœåŠ¡ï¼Œå¹¶ç¡®ä¿å®ƒè¯»å–äº†æ›´æ–°åçš„é…ç½®å‚æ•° killall svnserve //åœæ­¢svnserveæœåŠ¡ svnserve â€“d â€“r /svn/repos //å¯åŠ¨svnserveæœåŠ¡ 4ï¼‰åˆ›å»ºåŠ å¯†åçš„ç”¨æˆ·å’Œå¯†ç  saslpasswd2 -c -f /svn/repo/cccc/sasldb -u cccc cccc # â€“u [svnserve.confé‡Œé¢é…ç½®çš„realmåå­—] [username] -p \u003cpw //æ–°å»ºç”¨æˆ·ï¼Œå¯ä¿®æ”¹ç”¨æˆ·ç”¨","date":"2023-11-18","objectID":"/posts/2023-11-18-svn/:1:2","tags":["svn","vcs","dev"],"title":"svn","uri":"/posts/2023-11-18-svn/"},{"categories":["DevOps"],"content":"Git ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:0:0","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"ä¸€ã€gitåŸºæœ¬ä½¿ç”¨ ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:1:0","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"1ã€commit [root@node01 project]# git add 1.txt [root@node01 project]# git commit -m \"create new 1.txt\" [master (root-commit) 3e8ce87] create new 1.txt 1 file changed, 0 insertions(+), 0 deletions(-) create mode 100644 1.txt ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:1:1","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"2ã€diffæ–‡ä»¶ [root@node01 project]# git diff 1.txt diff --git a/1.txt b/1.txt index e69de29..21d56a0 100644 --- a/1.txt +++ b/1.txt @@ -0,0 +1 @@ +1111111111111111 ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:1:2","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"3ã€ç‰ˆæœ¬å›é€€ åœ¨è¿›è¡Œç‰ˆæœ¬å›é€€æ—¶ï¼Œä½¿ç”¨HEADä»£è¡¨å½“å‰ç‰ˆæœ¬ï¼ŒHEAD^ ä»£è¡¨ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼ŒHEAD^^ä»£è¡¨ä¸Šä¸Šä¸ªç‰ˆæœ¬ï¼Œè¿˜å¯ä»¥ä½¿ç”¨HEAD~10ä»£è¡¨å‰10ä¸ªç‰ˆæœ¬ [root@node01 project]# git reset --hard HEAD^ HEAD is now at fdf9d68 add new 1111 [root@node01 project]# [root@node01 project]# cat 1.txt 1111111111111111 [root@node01 project]# ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ ¼å¼: [root@node01 project] git reset --hard \u003ccommit_id\u003e [root@node01 project]# git reflog 1.txt fdf9d68 HEAD@{0}: reset: moving to HEAD^ 996cc77 HEAD@{1}: commit: add new 222 fdf9d68 HEAD@{2}: commit: add new 1111 3e8ce87 HEAD@{3}: commit (initial): create new 1.txt [root@node01 project]# [root@node01 project]# git reset --hard 996cc77 ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:1:3","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"4ã€æ’¤é”€æ›´æ”¹ 1ï¼‰å¯¹äºå°šæœªæ·»åŠ åˆ°æš‚å­˜åŒºçš„ä¿®æ”¹ï¼Œå¯ç›´æ¥é€šè¿‡ç¼–è¾‘åŸæ–‡ä»¶æˆ–è€…ä½¿ç”¨git checkout -- \u003cfile\u003eçš„æ–¹å¼è¿›è¡Œæ’¤é”€ [root@node01 project]# git checkout -- 1.txt [root@node01 project]# git status # On branch master nothing to commit, working directory clean 2ï¼‰å¯¹äºå·²ç»æ·»åŠ åˆ°æš‚å­˜åŒºï¼Œä½†è¿˜æ²¡æœ‰git commitçš„ä¿®æ”¹ï¼Œå¯ä½¿ç”¨git reset HEAD \u003cfile\u003eçš„æ–¹å¼æ’¤é”€ [root@node01 project]# vim 1.txt [root@node01 project]# git add 1.txt [root@node01 project]# git status # On branch master # Changes to be committed: # (use \"git reset HEAD \u003cfile\u003e...\" to unstage) # # modified: 1.txt # [root@node01 project]# git reset HEAD 1.txt Unstaged changes after reset: M 1.txt [root@node01 project]# git status # On branch master # Changes not staged for commit: # (use \"git add \u003cfile\u003e...\" to update what will be committed) # (use \"git checkout -- \u003cfile\u003e...\" to discard changes in working directory) # # modified: 1.txt # no changes added to commit (use \"git add\" and/or \"git commit -a\") [root@node01 project]# git checkout -- 1.txt [root@node01 project]# git status # On branch master nothing to commit, working directory clean [root@node01 project]# cat 1.txt 1111111111111111 22222222222222222 3333333333333 3ï¼‰å¯¹äºå·²ç»æ·»åŠ åˆ°æš‚å­˜åŒºï¼Œå¹¶å·²ç»æäº¤çš„ä¿®æ”¹å¯é€šè¿‡git reset â€“hard \u003ccommit_id\u003eçš„æ–¹å¼è¿›è¡Œæ’¤é”€ [root@node01 project]# vim 1.txt [root@node01 project]# git add 1.txt [root@node01 project]# git commit -m \"add new 44444444\" [master 240af53] add new 44444444 1 file changed, 1 insertion(+) [root@node01 project]# git reflog 1.txt 240af53 HEAD@{0}: commit: add new 44444444 5424335 HEAD@{1}: commit: add new 333333 996cc77 HEAD@{2}: reset: moving to 996cc77 3e8ce87 HEAD@{3}: reset: moving to 3e8ce87 996cc77 HEAD@{4}: reset: moving to 996cc77 fdf9d68 HEAD@{5}: reset: moving to HEAD^ 996cc77 HEAD@{6}: commit: add new 222 fdf9d68 HEAD@{7}: commit: add new 1111 3e8ce87 HEAD@{8}: commit (initial): create new 1.txt [root@node01 project]# [root@node01 project]# [root@node01 project]# git reset --hard 5424335 HEAD is now at 5424335 add new 333333 ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:1:4","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"äºŒã€gité…ç½® ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:2:0","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"1ã€é…ç½®åŸºæœ¬ä¿¡æ¯ [root@localhost srv]# git config --global user.name 'sugar' [root@localhost srv]# git config --global user.email 't@local.com' [root@localhost srv]# git config --global color.ui true #é…ç½®æ˜¾ç¤ºçš„é¢œè‰²ï¼Œæ–¹ä¾¿çœ‹åˆ°æ›´æ”¹çš„ä¿¡æ¯ [root@localhost srv]# git config --global core.ignorecase false # é…ç½®å¤§å°å†™æ•æ„Ÿï¼Œgité»˜è®¤å¤§å°å†™ä¸æ•æ„Ÿ ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:2:1","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"2ã€gitconfigé…ç½®æ–‡ä»¶ [user] name = sugar email = t@local.com # signingkey = DCE96Cxxxxxxxxxxxxxxxxxxxxxxxx #[commit] # gpgsign = true # ~/github/ ç›®å½•ä¸‹çš„é¡¹ç›®ä½¿ç”¨~/github/.gitconfigä¸‹çš„gitconfigé…ç½®æ–‡ä»¶ [includeIf \"gitdir:~/github/\"] path = ~/github/.gitconfig [includeIf \"gitdir:~/my-prod/\"] path = ~/my-prod/.gitconfig [init] defaultBranch = main [color] ui = true [alias] lg = log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)\u003c%an\u003e%Creset' --abbrev-commit [alias] # status st = status ss = status --short --branch # stash sh = stash shp = stash pop shl = stash list shs = stash save sha = stash apply std = stash drop # branch br = branch bra = branch -a brm = branch -m co = checkout cob = checkout -b sw = switch swc = switch -c # remote ra = remote add rao = remote add origin ru = remote set-url ruo = remote set-url origin rv = remote -v # fetch fe = fetch fep = fetch -p fo = fetch origin fop = fetch origin -p # merge mr = merge mnc = merge --no-commit # msq = merge --squash # commit cm = commit -m # config user and mail user = config user.name mail = config user.email [url \"git@github.com:username\"] insteadOf = https://github.com/username # å¼ºåˆ¶httpsè½¬sshåè®® [url \"ssh://git@local.com/\"] insteadOf = https://local.com/ [core] excludesfile = ~/.gitignore_global autocrlf = input quotepath = false ignorecase = false editor = vim # sshCommand = ssh -i ~/.ssh/id_rsa -o IdentitiesOnly=yes -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no [i18n \"commit\"] encoding = utf-8 [i18n] logoutputencoding = utf-8 [http \"https://github.com\"] proxy = socks5://127.0.0.1:8888 [http] proxy = http://127.0.0.1:8889 [https] proxy = http://127.0.0.1:8889 ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:2:2","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"3ã€windowsä¸Šç»ˆç«¯æ‰“å¼€å‡ºç°ä¹±ç  cmdé…ç½® git config --global core.quotepath false git config --global gui.encoding utf-8 git config --global i18n.commit.encoding utf-8 git config --global i18n.logoutputencoding utf-8 # bash ç¯å¢ƒä¸‹ export LESSCHARSET=utf-8 # cmdç¯å¢ƒä¸‹ï¼š set LESSCHARSET=utf-8 powershellé…ç½® git config --global core.quotepath false git config --global gui.encoding utf-8 git config --global i18n.commit.encoding utf-8 git config --global i18n.logoutputencoding utf-8 $env:LESSCHARSET='utf-8' git bash sugar@sugar MINGW64 /e/Desktop/company/github (master) $ cat /etc/bash.bashrc alias ls='ls -F --color --show-control-chars' NOW_DIR=\"E:\\Desktop\" cd ${NOW_DIR} export LESSCHARSET=utf-8 ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:2:3","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"ä¸‰ã€åˆ†æ”¯ç®¡ç† gitç‰ˆæœ¬åº“æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯è¿è¡Œåœ¨åˆ†æ”¯ä¸Šï¼Œgitä»“åº“åˆ›å»ºæ—¶ä¼šå»ºç«‹é»˜è®¤çš„åˆ†æ”¯ï¼Œåç§°ä¸ºmasterï¼›æ‰€æœ‰çš„æ“ä½œéƒ½åœ¨masteråˆ†æ”¯ä¸Šè¿›è¡Œ åœ¨å¯¹ç‰ˆæœ¬åº“ä¸­çš„æ–‡ä»¶è¿›è¡Œæ“ä½œæ—¶ï¼Œå¯ä»¥åˆ›å»ºä¸åŒçš„åˆ†æ”¯ï¼Œä¸åŒçš„æ“ä½œè¿è¡Œåœ¨ä¸åŒçš„åˆ†æ”¯ä¸Šï¼Œä¸åŒåˆ†æ”¯ä¸Šçš„æ“ä½œä¸ä¼šç›¸äº’å¹²æ‰°ï¼Œæ“ä½œè¿›è¡Œå®Œæˆåï¼Œå¯ä»¥åˆå¹¶ä¸åŒåˆ†æ”¯ä¸Šçš„æ“ä½œ ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:3:0","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"1ã€åˆ›å»ºåˆ†æ”¯ [root@node01 project]# git checkout -b game Switched to a new branch 'game' [root@node01 project]# [root@node01 project]# git branch dev * game master 1ï¼‰è¿œç¨‹chekoutåˆ°æœ¬åœ° [root@node01 project]# git checkout origin/develop -b develop 2ï¼‰åˆ é™¤åˆ†æ”¯ # åˆ é™¤æœ¬åœ°åˆ†æ”¯ [root@node01 project]# git branch -d release-1.1.0 # å¼ºåˆ¶åˆ é™¤ [root@node01 project]# git branch -D release-1.1.0 # åˆ é™¤è¿œç¨‹åˆ†æ”¯ [root@node01 project]# git push origin --delete release-1.1.0 æˆ–è€… [root@node01 project]# git push origin :release-1.1.0 3ï¼‰æ ¹æ®hashå€¼è¿›è¡Œcheckout git checkout d21a8c517ca3xxxxxxxxxxxxxxxxxxxxxxxxxxx 4ï¼‰åˆ†æ”¯åˆå¹¶ åˆ‡æ¢åˆ°å‡†å¤‡åˆå¹¶åçš„åˆ†æ”¯ï¼Œåˆå¹¶å…¶ä»–åˆ†æ”¯åˆ°å½“å‰åˆ†æ”¯ [root@node01 project]# git merge dev Updating bb6fb7a..d83dae8 Fast-forward 1.txt | 2 ++ 1 file changed, 2 insertions(+) ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:3:1","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"å››ã€tagç®¡ç† æ‰“æ ‡ç­¾ï¼Œç”¨äºä»“åº“æŸä¸ªæäº¤æ‰“ä¸Šæ ‡ç­¾ï¼Œä»¥è¡¨ç¤ºå…¶ç‰¹æ®Šæ€§ã€‚æ¯”è¾ƒæœ‰ä»£è¡¨æ€§çš„æ˜¯äººä»¬ä¼šä½¿ç”¨è¿™ä¸ªåŠŸèƒ½æ¥æ ‡è®°å‘å¸ƒç»“ç‚¹ï¼ˆ v1.0 ã€ v2.0 ç­‰ç­‰ï¼‰ 1ã€æŸ¥çœ‹æœ¬åœ°å·²æœ‰æ ‡ç­¾ [root@localhost github_web]# git tag 4.101.0 4.103.0 4.103.1 åˆ—å‡ºæ‰€æœ‰æ ‡ç­¾ -læˆ–è€…--listï¼ŒæŒ‡å®šæŸäº›æäº¤ä¿¡æ¯-l \"v4.4*\" 2ã€åˆ›å»ºtag Git æ”¯æŒä¸¤ç§æ ‡ç­¾ï¼š è½»é‡æ ‡ç­¾ï¼ˆlightweightï¼‰ é™„æ³¨æ ‡ç­¾ï¼ˆannotatedï¼‰ã€‚ è½»é‡æ ‡ç­¾å¾ˆåƒä¸€ä¸ªä¸ä¼šæ”¹å˜çš„åˆ†æ”¯â€”â€”å®ƒåªæ˜¯æŸä¸ªç‰¹å®šæäº¤çš„å¼•ç”¨ã€‚ è€Œé™„æ³¨æ ‡ç­¾æ˜¯å­˜å‚¨åœ¨ Git æ•°æ®åº“ä¸­çš„ä¸€ä¸ªå®Œæ•´å¯¹è±¡ï¼Œ å®ƒä»¬æ˜¯å¯ä»¥è¢«æ ¡éªŒçš„ï¼Œå…¶ä¸­åŒ…å«æ‰“æ ‡ç­¾è€…çš„åå­—ã€ç”µå­é‚®ä»¶åœ°å€ã€æ—¥æœŸæ—¶é—´ï¼Œ æ­¤å¤–è¿˜æœ‰ä¸€ä¸ªæ ‡ç­¾ä¿¡æ¯ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ GNU Privacy Guard ï¼ˆGPGï¼‰ç­¾åå¹¶éªŒè¯ã€‚ é€šå¸¸ä¼šå»ºè®®åˆ›å»ºé™„æ³¨æ ‡ç­¾ï¼Œè¿™æ ·ä½ å¯ä»¥æ‹¥æœ‰ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ã€‚ä½†æ˜¯å¦‚æœä½ åªæ˜¯æƒ³ç”¨ä¸€ä¸ªä¸´æ—¶çš„æ ‡ç­¾ï¼Œ æˆ–è€…å› ä¸ºæŸäº›åŸå› ä¸æƒ³è¦ä¿å­˜è¿™äº›ä¿¡æ¯ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ç”¨è½»é‡æ ‡ç­¾ã€‚ é™„å±æ ‡ç­¾ï¼š git tag -a v1.4 -m \"my version 1.4\" æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ git show v1.4 è¾“å‡ºæ˜¾ç¤ºäº†æ‰“æ ‡ç­¾è€…çš„ä¿¡æ¯ã€æ‰“æ ‡ç­¾çš„æ—¥æœŸæ—¶é—´ã€é™„æ³¨ä¿¡æ¯ï¼Œç„¶åæ˜¾ç¤ºå…·ä½“çš„æäº¤ä¿¡æ¯ã€‚ è½»é‡æ ‡ç­¾: å¦ä¸€ç§ç»™æäº¤æ‰“æ ‡ç­¾çš„æ–¹å¼æ˜¯ä½¿ç”¨è½»é‡æ ‡ç­¾ã€‚ è½»é‡æ ‡ç­¾æœ¬è´¨ä¸Šæ˜¯å°†æäº¤æ ¡éªŒå’Œå­˜å‚¨åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­â€”â€”æ²¡æœ‰ä¿å­˜ä»»ä½•å…¶ä»–ä¿¡æ¯ã€‚ åˆ›å»ºè½»é‡æ ‡ç­¾ï¼Œä¸éœ€è¦ä½¿ç”¨ -aã€-s æˆ– -m é€‰é¡¹ï¼Œåªéœ€è¦æä¾›æ ‡ç­¾åå­—ï¼š $ git tag v1.4-lw $ git tag v0.1 v1.3 v1.4 è¿™æ—¶ï¼Œå¦‚æœåœ¨æ ‡ç­¾ä¸Šè¿è¡Œ git showï¼Œä½ ä¸ä¼šçœ‹åˆ°é¢å¤–çš„æ ‡ç­¾ä¿¡æ¯ã€‚ å‘½ä»¤åªä¼šæ˜¾ç¤ºå‡ºæäº¤ä¿¡æ¯ï¼š $ git show v1.4-lw commit ca82a6dff817ec66f44342007202690a93763949 Author: Scott Chacon \u003ct@local.com\u003e Date: Mon Mar 17 21:52:11 2008 -0700 changed the version number åæœŸæ‰“æ ‡ç­¾ git tag -a v1.2 9fceb02 å…±äº«æ ‡ç­¾ é»˜è®¤æƒ…å†µä¸‹ï¼Œgit push å‘½ä»¤å¹¶ä¸ä¼šä¼ é€æ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“æœåŠ¡å™¨ä¸Šã€‚ åœ¨åˆ›å»ºå®Œæ ‡ç­¾åä½ å¿…é¡»æ˜¾å¼åœ°æ¨é€æ ‡ç­¾åˆ°å…±äº«æœåŠ¡å™¨ä¸Šã€‚ è¿™ä¸ªè¿‡ç¨‹å°±åƒå…±äº«è¿œç¨‹åˆ†æ”¯ä¸€æ ·â€”â€”ä½ å¯ä»¥è¿è¡Œ git push origin \u003ctagname\u003eã€‚ $ git push origin v1.5 Counting objects: 14, done. Delta compression using up to 8 threads. Compressing objects: 100% (12/12), done. Writing objects: 100% (14/14), 2.05 KiB | 0 bytes/s, done. Total 14 (delta 3), reused 0 (delta 0) To git@github.com:schacon/simplegit.git * [new tag] v1.5 -\u003e v1.5 å¦‚æœæƒ³è¦ä¸€æ¬¡æ€§æ¨é€å¾ˆå¤šæ ‡ç­¾ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¸¦æœ‰ --tags é€‰é¡¹çš„ git push å‘½ä»¤ã€‚ è¿™å°†ä¼šæŠŠæ‰€æœ‰ä¸åœ¨è¿œç¨‹ä»“åº“æœåŠ¡å™¨ä¸Šçš„æ ‡ç­¾å…¨éƒ¨ä¼ é€åˆ°é‚£é‡Œã€‚ $ git push origin --tags Counting objects: 1, done. Writing objects: 100% (1/1), 160 bytes | 0 bytes/s, done. Total 1 (delta 0), reused 0 (delta 0) To git@github.com:schacon/simplegit.git * [new tag] v1.4 -\u003e v1.4 * [new tag] v1.4-lw -\u003e v1.4-lw 3ã€åˆ é™¤æ ‡ç­¾ è¦åˆ é™¤æ‰ä½ æœ¬åœ°ä»“åº“ä¸Šçš„æ ‡ç­¾ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ git tag -d \u003ctagname\u003eã€‚ ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ é™¤ä¸€ä¸ªè½»é‡æ ‡ç­¾ï¼š $ git tag -d v1.4-lw Deleted tag 'v1.4-lw' (was e7d5add) æ³¨æ„ä¸Šè¿°å‘½ä»¤å¹¶ä¸ä¼šä»ä»»ä½•è¿œç¨‹ä»“åº“ä¸­ç§»é™¤è¿™ä¸ªæ ‡ç­¾ï¼Œä½ å¿…é¡»ç”¨ git push \u003cremote\u003e :refs/tags/\u003ctagname\u003e æ¥æ›´æ–°ä½ çš„è¿œç¨‹ä»“åº“ï¼š æ–¹æ³•ä¸€ï¼šgit push \u003cremote\u003e :refs/tags/\u003ctagname\u003e $ git push origin :refs/tags/v1.4-lw To /git@github.com:username/project.git - [deleted] v1.4-lw ä¸Šé¢è¿™ç§æ“ä½œçš„å«ä¹‰æ˜¯ï¼Œå°†å†’å·å‰é¢çš„ç©ºå€¼æ¨é€åˆ°è¿œç¨‹æ ‡ç­¾åï¼Œä»è€Œé«˜æ•ˆåœ°åˆ é™¤å®ƒã€‚ æ–¹æ³•äºŒï¼šç›´æ¥åˆ é™¤è¿œç¨‹æ ‡ç­¾ $ git push origin --delete \u003ctagname\u003e 4ã€æ£€å‡ºæ ‡ç­¾ æ£€å‡ºæ ‡ç­¾ä¸ºä¸€ä¸ªåˆ†æ”¯ï¼Œæ ¼å¼ä¸ºgit checkout -b branch_name tag_name git checkout -b version2 v2.0.0 5ã€.git ç›®å½• â”œâ”€â”€ HEAD â”œâ”€â”€ branches â”œâ”€â”€ config â”œâ”€â”€ description â”œâ”€â”€ hooks â”‚ â”œâ”€â”€ pre-commit.sample â”‚ â”œâ”€â”€ pre-push.sample â”‚ â””â”€â”€ ... â”œâ”€â”€ info â”‚ â””â”€â”€ exclude â”œâ”€â”€ objects â”‚ â”œâ”€â”€ info â”‚ â””â”€â”€ pack â””â”€â”€ refs â”œâ”€â”€ heads â””â”€â”€ tags config ï¼ˆé…ç½®ï¼‰è¯¥æ–‡ä»¶åŒ…å«ä½ çš„ä»“åº“é…ç½®ï¼Œæ¯”å¦‚è¿œç¨‹çš„ url ï¼Œä½ çš„é‚®ç®±å’Œç”¨æˆ·åç­‰ã€‚æ¯æ¬¡ä½ åœ¨æ§åˆ¶å°ä½¿ç”¨ git configâ€¦ éƒ½ä¼šå¯¹è¿™é‡Œäº§ç”Ÿå½±å“ã€‚ descriptionï¼ˆæè¿°ï¼‰ä¾› gitweb ( github çš„ä¸€ç§å‰èº«) ä½¿ç”¨ï¼Œæ˜¾ç¤ºä»“åº“çš„æè¿°ã€‚ hooks (é’©å­)è¿™æ˜¯ä¸€ä¸ªæœ‰è¶£çš„ç‰¹æ€§ã€‚ Git æä¾›äº†ä¸€å¥—è„šæœ¬ï¼Œå¯ä»¥åœ¨æ¯ä¸ªæœ‰æ„ä¹‰çš„ Git é˜¶æ®µè‡ªåŠ¨è¿è¡Œã€‚è¿™äº›è¢«ç§°ä¸ºé’©å­çš„è„šæœ¬å¯ä»¥åœ¨æäº¤ (commit)ã€å˜åŸº (rebase)ã€æ‹‰å– ( pull ) æ“ä½œçš„å‰åè¿è¡Œã€‚è„šæœ¬å‘½é¢„ç¤ºç€å®ƒçš„æ‰§è¡Œæ—¶æœºã€‚å¦‚æˆ‘ä»¬å¯ä»¥ç¼–å†™ pre-push çš„ä½œä¸ºé’©å­ï¼Œè¿›è¡Œæ¨é€ä»£ç å‰çš„æ£€æŸ¥ã€‚ info (ä¿¡æ¯)ä½ å¯ä»¥å°†ä¸æƒ³è¢« git ç®¡ç†çš„æ–‡ä»¶è®°å½•åˆ° .gitignore æ–‡ä»¶ä¸­ã€‚æ’é™¤æ–‡ä»¶çš„æ„æ€æ˜¯ä¸æƒ³å…±äº«è¿™ä¸ªæ–‡ä»¶ã€‚ä¾‹å¦‚ä½ ä¸æƒ³å…±äº«ä½ çš„ IDE è‡ªå®šä¹‰é…ç½®ï¼Œå°†å…¶æ·»åŠ åˆ° .gitignore æ–‡ä»¶ä¸­å³å¯ã€‚ ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:4:0","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"äº”ã€cherry-pick å‚è€ƒï¼šhttps://www.ruanyifeng.com/blog/2020/04/git-cherry-pick.html å¯¹äºå¤šåˆ†æ”¯çš„ä»£ç åº“ï¼Œå°†ä»£ç ä»ä¸€ä¸ªåˆ†æ”¯è½¬ç§»åˆ°å¦ä¸€ä¸ªåˆ†æ”¯æ˜¯å¸¸è§éœ€æ±‚ã€‚ è¿™æ—¶åˆ†ä¸¤ç§æƒ…å†µã€‚ä¸€ç§æƒ…å†µæ˜¯ï¼Œä½ éœ€è¦å¦ä¸€ä¸ªåˆ†æ”¯çš„æ‰€æœ‰ä»£ç å˜åŠ¨ï¼Œé‚£ä¹ˆå°±é‡‡ç”¨åˆå¹¶ï¼ˆgit mergeï¼‰ã€‚å¦ä¸€ç§æƒ…å†µæ˜¯ï¼Œä½ åªéœ€è¦éƒ¨åˆ†ä»£ç å˜åŠ¨ï¼ˆæŸå‡ ä¸ªæäº¤ï¼‰ï¼Œè¿™æ—¶å¯ä»¥é‡‡ç”¨ Cherry pickã€‚ 1ã€åŸºæœ¬è¯­æ³• git cherry-pickå‘½ä»¤çš„ä½œç”¨ï¼Œå°±æ˜¯å°†æŒ‡å®šçš„æäº¤ï¼ˆcommitï¼‰åº”ç”¨äºå…¶ä»–åˆ†æ”¯ã€‚ $ git cherry-pick \u003ccommitHash\u003e ä¸Šé¢å‘½ä»¤å°±ä¼šå°†æŒ‡å®šçš„æäº¤commitHashï¼Œåº”ç”¨äºå½“å‰åˆ†æ”¯ã€‚è¿™ä¼šåœ¨å½“å‰åˆ†æ”¯äº§ç”Ÿä¸€ä¸ªæ–°çš„æäº¤ï¼Œå½“ç„¶å®ƒä»¬çš„å“ˆå¸Œå€¼ä¼šä¸ä¸€æ ·ã€‚ ä¸¾ä¾‹æ¥è¯´ï¼Œä»£ç ä»“åº“æœ‰masterå’Œfeatureä¸¤ä¸ªåˆ†æ”¯ã€‚ a - b - c - d Master \\ e - f - g Feature ç°åœ¨å°†æäº¤fåº”ç”¨åˆ°masteråˆ†æ”¯ã€‚ # åˆ‡æ¢åˆ° master åˆ†æ”¯ $ git checkout master # Cherry pick æ“ä½œ $ git cherry-pick f ä¸Šé¢çš„æ“ä½œå®Œæˆä»¥åï¼Œä»£ç åº“å°±å˜æˆäº†ä¸‹é¢çš„æ ·å­ã€‚ a - b - c - d - f Master \\ e - f - g Feature ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œmasteråˆ†æ”¯çš„æœ«å°¾å¢åŠ äº†ä¸€ä¸ªæäº¤fã€‚ git cherry-pickå‘½ä»¤çš„å‚æ•°ï¼Œä¸ä¸€å®šæ˜¯æäº¤çš„å“ˆå¸Œå€¼ï¼Œåˆ†æ”¯åä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¡¨ç¤ºè½¬ç§»è¯¥åˆ†æ”¯çš„æœ€æ–°æäº¤ã€‚ $ git cherry-pick feature ä¸Šé¢ä»£ç è¡¨ç¤ºå°†featureåˆ†æ”¯çš„æœ€è¿‘ä¸€æ¬¡æäº¤ï¼Œè½¬ç§»åˆ°å½“å‰åˆ†æ”¯ã€‚ æ“ä½œç¤ºä¾‹ï¼š [sugar@centos-7 git-test]$ git log -1 commit dcf3a215fd6ba3288ad21584d2112bdab5a713b4 Author: sugar \u003ccccc@gmail.com\u003e Date: Sun Sep 12 14:29:26 2021 +0800 feat: v1 version 1s add [sugar@centos-7 git-test]$ git checkout master Switched to branch 'master' [sugar@centos-7 git-test]$ git log commit 31da420cc2d2ae6094f88e368a72f0353541d89f Author: sugar \u003ccccc@gmail.com\u003e Date: Sun Sep 12 14:25:43 2021 +0800 feat: ç¬¬ä¸€æ­¤å¢åŠ  [sugar@centos-7 git-test]$ git cherry-pick dcf3a215fd6ba3288ad21584d2112bdab5a713b4 [master fa78bb0] feat: v1 version 1s add 1 file changed, 2 insertions(+), 1 deletion(-) [sugar@centos-7 git-test]$ ls cccc.txt [sugar@centos-7 git-test]$ git log -1 commit fa78bb090d3221ba2ff9cae59efa1f8691677115 Author: sugar \u003ccccc@gmail.com\u003e Date: Sun Sep 12 14:29:26 2021 +0800 feat: v1 version 1s add 2ã€è½¬ç§»å¤šä¸ªcommit Cherry pick æ”¯æŒä¸€æ¬¡è½¬ç§»å¤šä¸ªæäº¤ [sugar@centos-7 git-test]$ git cherry-pick \u003cHashA\u003e \u003cHashB\u003e è¿ç»­æäº¤å¤šä¸ªcommit # æäº¤Aåˆ°Bçš„commitï¼Œä½†ä¸åŒ…å«Aï¼›æäº¤Aå¿…é¡»æ—©äºæäº¤Bï¼Œå¦åˆ™å‘½ä»¤å°†å¤±è´¥ï¼Œä½†ä¸ä¼šæŠ¥é”™ã€‚ [sugar@centos-7 git-test]$ git cherry-pick A..B # æäº¤Aåˆ°Bçš„commitï¼ŒåŒ…å«A [sugar@centos-7 git-test]$ git cherry-pick A^..B 3ã€å‚æ•° git cherry-pickå‘½ä»¤çš„å¸¸ç”¨é…ç½®é¡¹å¦‚ä¸‹ã€‚ ï¼ˆ1ï¼‰-eï¼Œ--edit æ‰“å¼€å¤–éƒ¨ç¼–è¾‘å™¨ï¼Œç¼–è¾‘æäº¤ä¿¡æ¯ã€‚ ï¼ˆ2ï¼‰-nï¼Œ--no-commit åªæ›´æ–°å·¥ä½œåŒºå’Œæš‚å­˜åŒºï¼Œä¸äº§ç”Ÿæ–°çš„æäº¤ã€‚ ï¼ˆ3ï¼‰-x åœ¨æäº¤ä¿¡æ¯çš„æœ«å°¾è¿½åŠ ä¸€è¡Œ(cherry picked from commit ...)ï¼Œæ–¹ä¾¿ä»¥åæŸ¥åˆ°è¿™ä¸ªæäº¤æ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚ ï¼ˆ4ï¼‰-sï¼Œ--signoff åœ¨æäº¤ä¿¡æ¯çš„æœ«å°¾è¿½åŠ ä¸€è¡Œæ“ä½œè€…çš„ç­¾åï¼Œè¡¨ç¤ºæ˜¯è°è¿›è¡Œäº†è¿™ä¸ªæ“ä½œã€‚ ï¼ˆ5ï¼‰-m parent-numberï¼Œ--mainline parent-number å¦‚æœåŸå§‹æäº¤æ˜¯ä¸€ä¸ªåˆå¹¶èŠ‚ç‚¹ï¼Œæ¥è‡ªäºä¸¤ä¸ªåˆ†æ”¯çš„åˆå¹¶ï¼Œé‚£ä¹ˆ Cherry pick é»˜è®¤å°†å¤±è´¥ï¼Œå› ä¸ºå®ƒä¸çŸ¥é“åº”è¯¥é‡‡ç”¨å“ªä¸ªåˆ†æ”¯çš„ä»£ç å˜åŠ¨ã€‚ -mé…ç½®é¡¹å‘Šè¯‰ Gitï¼Œåº”è¯¥é‡‡ç”¨å“ªä¸ªåˆ†æ”¯çš„å˜åŠ¨ã€‚å®ƒçš„å‚æ•°parent-numberæ˜¯ä¸€ä¸ªä»1å¼€å§‹çš„æ•´æ•°ï¼Œä»£è¡¨åŸå§‹æäº¤çš„çˆ¶åˆ†æ”¯ç¼–å·ã€‚ $ git cherry-pick -m 1 \u003ccommitHash\u003e ä¸Šé¢å‘½ä»¤è¡¨ç¤ºï¼ŒCherry pick é‡‡ç”¨æäº¤commitHashæ¥è‡ªç¼–å·1çš„çˆ¶åˆ†æ”¯çš„å˜åŠ¨ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œ1å·çˆ¶åˆ†æ”¯æ˜¯æ¥å—å˜åŠ¨çš„åˆ†æ”¯ï¼ˆthe branch being merged intoï¼‰ï¼Œ2å·çˆ¶åˆ†æ”¯æ˜¯ä½œä¸ºå˜åŠ¨æ¥æºçš„åˆ†æ”¯ï¼ˆthe branch being merged fromï¼‰ã€‚ 4ã€ä»£ç å†²çª å¦‚æœæ“ä½œè¿‡ç¨‹ä¸­å‘ç”Ÿä»£ç å†²çªï¼ŒCherry pick ä¼šåœä¸‹æ¥ï¼Œè®©ç”¨æˆ·å†³å®šå¦‚ä½•ç»§ç»­æ“ä½œã€‚ 1ï¼‰--contine ç”¨æˆ·è§£å†³ä»£ç å†²çªåï¼Œç¬¬ä¸€æ­¥å°†ä¿®æ”¹çš„æ–‡ä»¶é‡æ–°åŠ å…¥æš‚å­˜åŒºï¼ˆgit add .ï¼‰ï¼Œç¬¬äºŒæ­¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œè®© Cherry pick è¿‡ç¨‹ç»§ç»­æ‰§è¡Œã€‚ $ git cherry-pick --continue 2ï¼‰--abort å‘ç”Ÿä»£ç å†²çªåï¼Œæ”¾å¼ƒåˆå¹¶ï¼Œå›åˆ°æ“ä½œå‰çš„æ ·å­ã€‚ 3ï¼‰--quit å‘ç”Ÿä»£ç å†²çªåï¼Œé€€å‡º Cherry pickï¼Œä½†æ˜¯ä¸å›åˆ°æ“ä½œå‰çš„æ ·å­ã€‚ 5ã€è½¬ç§»åˆ°å¦å¤–ä¸€ä¸ªä»“åº“ Cherry pick ä¹Ÿæ”¯æŒè½¬ç§»å¦ä¸€ä¸ªä»£ç åº“çš„æäº¤ï¼Œæ–¹æ³•æ˜¯å…ˆå°†è¯¥åº“åŠ ä¸ºè¿œç¨‹ä»“åº“ã€‚ # æ·»åŠ ä¸€ä¸ªè¿œç¨‹ä»“åº“ $ git remote add target git://gitUrl # å°†è¿œç¨‹ä»“åº“çš„ä»£ç æŠ“å–åˆ°æœ¬åœ° $ git fetch target # æ£€æŸ¥ä¸€ä¸‹è¦ä»è¿œç¨‹ä»“åº“è½¬ç§»çš„æäº¤ï¼Œè·å–å®ƒçš„å“ˆå¸Œå€¼ $ git log target/master # ä½¿ç”¨git cherry-pickå‘½ä»¤è½¬ç§»æäº¤ $ git cherry-pick \u003ccommitHash\u003e ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:5:0","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"å…­ã€åˆå¹¶commit åœ¨ä½¿ç”¨ Git ä½œä¸ºç‰ˆæœ¬æ§åˆ¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç”±äºå„ç§å„æ ·çš„åŸå› æäº¤äº†è®¸å¤šä¸´æ—¶çš„ commitï¼Œè€Œè¿™äº› commit æ‹¼æ¥èµ·æ¥æ‰æ˜¯å®Œæ•´çš„ä»»åŠ¡ã€‚é‚£ä¹ˆæˆ‘ä»¬ä¸ºäº†é¿å…å¤ªå¤šçš„ commit è€Œé€ æˆç‰ˆæœ¬æ§åˆ¶çš„æ··ä¹±ï¼Œé€šå¸¸æˆ‘ä»¬æ¨èå°†è¿™äº› commit åˆå¹¶æˆä¸€ä¸ªã€‚ ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:6:0","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"1ã€æŸ¥çœ‹æäº¤å†å² $ git log commit 3ca6ec340edc66df13423f36f52919dfa3...... commit 1b4056686d1b494a5c86757f9eaed844...... commit 53f244ac8730d33b353bee3b24210b07...... commit 3a4226b4a0b6fa68783b07f1cee7b688....... ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:6:1","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"2ã€git rebase æƒ³è¦åˆå¹¶1-3æ¡ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ³• 1ï¼‰ä»HEADç‰ˆæœ¬å¼€å§‹å¾€è¿‡å»æ•°3ä¸ªç‰ˆæœ¬ $ git rebase -i HEAD~3 2ï¼‰æŒ‡åè¦åˆå¹¶çš„ç‰ˆæœ¬ä¹‹å‰çš„ç‰ˆæœ¬å· $ git rebase -i 3a4226b è¯·æ³¨æ„3a4226bè¿™ä¸ªç‰ˆæœ¬æ˜¯ä¸å‚ä¸åˆå¹¶çš„ï¼Œåªæ˜¯æŠŠå®ƒå½“åšä¸€ä¸ªåæ ‡ ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:6:2","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"3ã€é€‰æ‹©è¦åˆå¹¶çš„æäº¤ pæ˜¯ä¿ç•™ï¼Œsæ˜¯åˆå¹¶ 1ï¼‰æ‰§è¡Œäº†rebaseå‘½ä»¤ä¹‹åï¼Œä¼šå¼¹å‡ºä¸€ä¸ªçª—å£ï¼Œå¤´å‡ è¡Œå¦‚ä¸‹ï¼š pick 3ca6ec3 'æ³¨é‡Š**********' pick 1b40566 'æ³¨é‡Š*********' pick 53f244a 'æ³¨é‡Š**********' 2ï¼‰å°†pickæ”¹ä¸ºsquashæˆ–è€…s,ä¹‹åä¿å­˜å¹¶å…³é—­æ–‡æœ¬ç¼–è¾‘çª—å£å³å¯ã€‚æ”¹å®Œä¹‹åæ–‡æœ¬å†…å®¹å¦‚ä¸‹ï¼š pick 3ca6ec3 'æ³¨é‡Š**********' s 1b40566 'æ³¨é‡Š*********' s 53f244a 'æ³¨é‡Š**********' 3ï¼‰ç„¶åä¿å­˜é€€å‡ºï¼ŒGitä¼šå‹ç¼©æäº¤å†å²ï¼Œå¦‚æœæœ‰å†²çªï¼Œéœ€è¦ä¿®æ”¹ï¼Œä¿®æ”¹çš„æ—¶å€™è¦æ³¨æ„ï¼Œä¿ç•™æœ€æ–°çš„å†å²ï¼Œä¸ç„¶æˆ‘ä»¬çš„ä¿®æ”¹å°±ä¸¢å¼ƒäº†ã€‚ä¿®æ”¹ä»¥åè¦è®°å¾—æ•²ä¸‹é¢çš„å‘½ä»¤ï¼š pick 3ca6ec3 'æ³¨é‡Š**********' s 1b40566 'æ³¨é‡Š*********' s 53f244a 'æ³¨é‡Š**********' ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:6:3","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"4ï¼‰å†²çªè§£å†³ ç„¶åä¿å­˜é€€å‡ºï¼ŒGitä¼šå‹ç¼©æäº¤å†å²ï¼Œå¦‚æœæœ‰å†²çªï¼Œéœ€è¦ä¿®æ”¹ï¼Œä¿®æ”¹çš„æ—¶å€™è¦æ³¨æ„ï¼Œä¿ç•™æœ€æ–°çš„å†å² git add . # ç»§ç»­åˆå¹¶ git rebase --continue # æ”¾å¼ƒåˆå¹¶ git rebase --abort å¦‚æœæ²¡æœ‰å†²çªï¼Œæˆ–è€…å†²çªå·²ç»è§£å†³ï¼Œåˆ™ä¼šå‡ºç°å¦‚ä¸‹çš„ç¼–è¾‘çª—å£ï¼š # This is a combination of 4 commits. #The first commitâ€™s message is: æ³¨é‡Š...... # The 2nd commitâ€™s message is: æ³¨é‡Š...... # The 3rd commitâ€™s message is: æ³¨é‡Š...... # Please enter the commit message for your changes. Lines starting # with â€˜#â€™ will be ignored, and an empty message aborts the commit. ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:6:4","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"5ï¼‰æ£€æŸ¥ git logæŸ¥çœ‹ commit å†å²ä¿¡æ¯ï¼ŒæŸ¥è¯¢commitçš„ä¿¡æ¯ ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:6:5","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"ä¸ƒã€Git Hook Git Hook ä¹Ÿåˆ†ä¸ºä¸¤ä¸ªç«¯: å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ã€‚ å®¢æˆ·ç«¯çš„ Git Hook å°±æ˜¯å·¥ä½œåœ¨æˆ‘ä»¬æœ¬åœ°æœºå™¨çš„ï¼ŒæœåŠ¡ç«¯çš„ Git Hook åˆ™æ˜¯å·¥ä½œåœ¨æˆ‘ä»¬æäº¤åˆ°è¿œç¨‹çš„æœåŠ¡å™¨ä»“åº“ä¸­ã€‚ å®¢æˆ·ç«¯ Git Hook: pre-commit: æ‰§è¡Œgit commitå‘½ä»¤æ—¶è§¦å‘ï¼Œå¸¸ç”¨äºæ£€æŸ¥ä»£ç é£æ ¼ prepare-commit-msg: è§¦å‘äº commit message ç¼–è¾‘å™¨å‘¼èµ·å‰ ,default commit messageåˆ›å»ºå,å¸¸ç”¨äºç”Ÿæˆé»˜è®¤çš„æ ‡å‡†åŒ–çš„æäº¤è¯´æ˜ commit-msg: å¼€å‘è€…ç¼–å†™å®Œå¹¶ç¡®è®¤commit messageåè§¦å‘ï¼Œå¸¸ç”¨äºæ ¡éªŒæäº¤è¯´æ˜æ˜¯å¦æ ‡å‡† post-commit: æ•´ä¸ªgit commitå®Œæˆåè§¦å‘ï¼Œå¸¸ç”¨äºé‚®ä»¶é€šçŸ¥ã€æé†’ applypatch-msg: æ‰§è¡Œgit amå‘½ä»¤æ—¶è§¦å‘ï¼Œå¸¸ç”¨äºæ£€æŸ¥å‘½ä»¤æå–å‡ºæ¥çš„æäº¤ä¿¡æ¯æ˜¯å¦ç¬¦åˆç‰¹å®šæ ¼å¼ pre-applypatch: git amæå–å‡ºè¡¥ä¸å¹¶åº”ç”¨äºå½“å‰åˆ†æ”¯åï¼Œå‡†å¤‡æäº¤å‰è§¦å‘ï¼Œå¸¸ç”¨äºæ‰§è¡Œæµ‹è¯•ç”¨ä¾‹æˆ–æ£€æŸ¥ç¼“å†²åŒºä»£ç  post-applypatch: git amæäº¤åè§¦å‘ï¼Œå¸¸ç”¨äºé€šçŸ¥ã€æˆ–è¡¥ä¸é‚®ä»¶å›å¤ï¼ˆæ­¤é’©å­ä¸èƒ½åœæ­¢git amè¿‡ç¨‹ï¼‰ pre-rebase: æ‰§è¡Œgit rebaseå‘½ä»¤æ—¶è§¦å‘ post-rewrite: æ‰§è¡Œä¼šæ›¿æ¢commitçš„å‘½ä»¤æ—¶è§¦å‘ï¼Œæ¯”å¦‚git rebaseæˆ–git commit â€“amend post-checkout: æ‰§è¡Œgit checkoutå‘½ä»¤æˆåŠŸåè§¦å‘ï¼Œå¯ç”¨äºç”Ÿæˆç‰¹å®šæ–‡æ¡£ï¼Œå¤„ç†å¤§äºŒè¿›åˆ¶æ–‡ä»¶ç­‰ post-merge: æˆåŠŸå®Œæˆä¸€æ¬¡ mergeè¡Œä¸ºåè§¦å‘ pre-push: æ‰§è¡Œgit pushå‘½ä»¤æ—¶è§¦å‘ï¼Œå¯ç”¨äºæ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ pre-auto-gc: æ‰§è¡Œåƒåœ¾å›æ”¶å‰è§¦å‘ æœåŠ¡ç«¯ Git Hook: pre-receive: å½“æœåŠ¡ç«¯æ”¶åˆ°ä¸€ä¸ª push æ“ä½œè¯·æ±‚æ—¶è§¦å‘ï¼Œå¯ç”¨äºæ£€æµ‹ push çš„å†…å®¹ update: update è„šæœ¬å’Œ pre-receive è„šæœ¬ååˆ†ç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºå®ƒä¼šä¸ºæ¯ä¸€ä¸ªå‡†å¤‡æ›´æ–°çš„åˆ†æ”¯å„è¿è¡Œä¸€æ¬¡ã€‚ å‡å¦‚æ¨é€è€…åŒæ—¶å‘å¤šä¸ªåˆ†æ”¯æ¨é€å†…å®¹ï¼Œpre-receive åªè¿è¡Œä¸€æ¬¡ï¼Œç›¸æ¯”ä¹‹ä¸‹ update åˆ™ä¼šä¸ºæ¯ä¸€ä¸ªè¢«æ¨é€çš„åˆ†æ”¯å„è¿è¡Œä¸€æ¬¡ã€‚ post-receive: post-receive æŒ‚é’©åœ¨æ•´ä¸ªè¿‡ç¨‹å®Œç»“ä»¥åè¿è¡Œï¼Œå¯ä»¥ç”¨æ¥æ›´æ–°å…¶ä»–ç³»ç»ŸæœåŠ¡æˆ–è€…é€šçŸ¥ç”¨æˆ·ã€‚å®ƒçš„ç”¨é€”åŒ…æ‹¬ç»™æŸä¸ªé‚®ä»¶åˆ—è¡¨å‘ä¿¡ï¼Œé€šçŸ¥æŒç»­é›†æˆï¼ˆcontinous integrationï¼‰çš„æœåŠ¡å™¨ï¼Œæˆ–è€…æ›´æ–°é—®é¢˜è¿½è¸ªç³»ç»Ÿï¼ˆticket-tracking systemï¼‰ â€”â€” ç”šè‡³å¯ä»¥é€šè¿‡åˆ†ææäº¤ä¿¡æ¯æ¥å†³å®šæŸä¸ªé—®é¢˜ï¼ˆticketï¼‰æ˜¯å¦åº”è¯¥è¢«å¼€å¯ï¼Œä¿®æ”¹æˆ–è€…å…³é—­ã€‚ ä½¿ç”¨git hook Git Hook æœ¬èº«è‡ªå¸¦æœ‰è„šæœ¬ï¼Œä¼šå­˜æ”¾åœ¨ä»“åº“ .git/hooks æ–‡ä»¶å¤¹ä¸­ï¼Œç›®å½•ä¸€èˆ¬æ˜¯è¿™æ ·çš„: - YourGitRepo |- .git |- hooks |- hooks--commit-msg.sample |- hooks--post-update.sample ... æ³¨æ„å¦‚æœæ˜¯ sample æ–‡ä»¶ï¼Œè¦å»æ‰ .sample åç¼€ï¼Œå˜æˆå‰é¢ Git Hook åˆ†ç±» ä¸­æåˆ°å¯¹åº”çš„æ“ä½œæ¥ä½œä¸ºæ–‡ä»¶åã€‚ æ¯”å¦‚æˆ‘è¦åšçš„æ ¡éªŒ commit çš„æäº¤ä¿¡æ¯ï¼Œé‚£ä¹ˆä½¿ç”¨çš„ Git Hook è„šæœ¬ååº”è¯¥ä¸º commit-msg. åœ¨ hooks--commit-msg.sample é‡Œçš„å†…å®¹ä¸º: #!/bin/sh # # An example hook script to check the commit log message. # Called by \"git commit\" with one argument, the name of the file # that has the commit message. The hook should exit with non-zero # status after issuing an appropriate message if it wants to stop the # commit. The hook is allowed to edit the commit message file. # # To enable this hook, rename this file to \"commit-msg\". # Uncomment the below to add a Signed-off-by line to the message. # Doing this in a hook is a bad idea in general, but the prepare-commit-msg # hook is more suited to it. # # SOB=$(git var GIT_AUTHOR_IDENT | sed -n 's/^\\(.*\u003e\\).*$/Signed-off-by: \\1/p') # grep -qs \"^$SOB\" \"$1\" || echo \"$SOB\" \u003e\u003e \"$1\" # This example catches duplicate Signed-off-by lines. test \"\" = \"$(grep '^Signed-off-by: ' \"$1\" | sort | uniq -c | sed -e '/^[ ]*1[ ]/d')\" || { echo \u003e\u00262 Duplicate Signed-off-by lines. exit 1 } ä¸Šé¢è¯´æ˜é‡Œæœ‰ä¸€äº›åŸºæœ¬è¯´æ˜, è¿™é‡Œè·å¾—çš„ $1 å‚æ•°ï¼Œå…¶å®æ˜¯å­˜æ”¾ commit msg å†…å®¹çš„æ–‡ä»¶è·¯å¾„ï¼Œä¸º .git/COMMIT_EDITMSG. åˆ©ç”¨å‘½ä»¤: msg=$(cat $1) å°±èƒ½å–åˆ° commit çš„ä¿¡æ¯ï¼Œç¨ä½œä¿®æ”¹ï¼Œå°±èƒ½è¾¾åˆ°æˆ‘è¯´çš„ï¼Œæ ¡éªŒå›¢é˜Ÿ commit ä¿¡æ¯çš„è§„èŒƒçš„ç›®çš„äº†ã€‚ Git Hook ä¸ç”Ÿæ•ˆ å¦‚æœé‡åˆ°ä¸èµ·ä½œç”¨çš„ï¼Œå¯èƒ½è„šæœ¬æ²¡æœ‰æ‰“å¼€æ‰§è¡Œæƒé™ï¼Œå¯¼è‡´æ²¡åŠæ³•æ‰§è¡Œã€‚æˆ‘å°±æ˜¯è¿™æ ·çš„æƒ…å†µã€‚ cd åˆ° .git/hooks ç›®å½•ä¸‹,æ‰§è¡Œ chmod 777 å‘½ä»¤å³å¯,å¦‚ï¼š chmod 777 commit-msg ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:7:0","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"å…«ã€Git GC æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶å¹¶ä¼˜åŒ–æœ¬åœ°å­˜å‚¨åº“ å‚è€ƒé“¾æ¥ï¼šGit - ç®¡ç† | Administration - git gc - å¼€å‘è€…æ‰‹å†Œ - äº‘+ç¤¾åŒº - è…¾è®¯äº‘ (tencent.com) Gitçš„åº•å±‚å¹¶æ²¡æœ‰é‡‡ç”¨ CVSã€SVN åº•å±‚æ‰€é‡‡ç”¨çš„é‚£å¥—å¢é‡å¼æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œæ˜¯é‡‡ç”¨ä¸€å¥—è‡ªè¡Œç»´æŠ¤çš„å­˜å‚¨æ–‡ä»¶ç³»ç»Ÿã€‚å½“æ–‡ä»¶å˜åŠ¨å‘ç”Ÿæäº¤æ—¶ï¼Œè¯¥æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨çš„ä¸æ˜¯æ–‡ä»¶çš„å·®å¼‚ä¿¡æ¯ï¼Œè€Œæ˜¯æ–‡ä»¶å¿«ç…§ï¼Œå³æ•´ä¸ªæ–‡ä»¶å†…å®¹ï¼Œå¹¶ä¿å­˜æŒ‡å‘å¿«ç…§çš„ç´¢å¼•ã€‚è¿™ç§åšæ³•ï¼Œæé«˜ Git åˆ†æ”¯çš„ä½¿ç”¨æ•ˆç‡ï¼›ä½†ä¹Ÿå®¹æ˜“å¯¼è‡´ä»£ç ä»“åº“ä¸­å†…å®¹é‡å¤ç¨‹åº¦è¿‡é«˜ï¼Œä»è€Œä»“åº“ä½“ç§¯è¿‡å¤§ã€‚å½“é‡åˆ°è¿™ç§æƒ…å†µæ—¶ï¼Œæˆ–è€…éœ€è¦å°†ä»“åº“æ¨é€åˆ°è¿œç¨‹ä¸»æœºæ—¶ï¼Œå°±éœ€è¦Gitä¸­çš„gcï¼ˆgarbage collectï¼‰åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯åƒåœ¾å›æ”¶åŠŸèƒ½ã€‚ å¤§ä½“æ¥è¯´ï¼Œå½“è¿è¡Œ â€œgit gcâ€ å‘½ä»¤æ—¶ï¼ŒGitä¼šæ”¶é›†æ‰€æœ‰æ¾æ•£å¯¹è±¡å¹¶å°†å®ƒä»¬å­˜å…¥ packfileï¼Œåˆå¹¶è¿™äº› packfile è¿›ä¸€ä¸ªå¤§çš„ packfileï¼Œç„¶åå°†ä¸è¢«ä»»ä½• commit å¼•ç”¨å¹¶ä¸”å·²å­˜åœ¨ä¸€æ®µæ—¶é—´ (æ•°æœˆ) çš„å¯¹è±¡åˆ é™¤ã€‚ æ­¤å¤–ï¼ŒGitè¿˜ä¼šå°†æ‰€æœ‰å¼•ç”¨ (references) å¹¶å…¥ä¸€ä¸ªå•ç‹¬æ–‡ä»¶ã€‚ å°±ç»†èŠ‚è€Œè¨€ï¼ŒGitåšäº†è¿™å‡ ä»¶äº‹ï¼š pack_refs è¿‡ç¨‹ reflog expire è¿‡ç¨‹ repack è¿‡ç¨‹ prune è¿‡ç¨‹ rerere è¿‡ç¨‹ æ¦‚è¦ï¼š git gc [--aggressive] [--auto] [--quiet] [--prune=\u003cdate\u003e | --no-prune] [--force] æè¿°ï¼š åœ¨å½“å‰å­˜å‚¨åº“ä¸­è¿è¡Œè®¸å¤šå†…åŠ¡å¤„ç†ä»»åŠ¡ï¼Œä¾‹å¦‚å‹ç¼©æ–‡ä»¶ä¿®è®¢ï¼ˆä»¥å‡å°‘ç£ç›˜ç©ºé—´å¹¶æé«˜æ€§èƒ½ï¼‰å¹¶ç§»é™¤å¯èƒ½ç”±ä¹‹å‰git addè°ƒç”¨åˆ›å»ºçš„ä¸å¯è¾¾å¯¹è±¡ã€‚ é¼“åŠ±ç”¨æˆ·åœ¨æ¯ä¸ªå­˜å‚¨åº“ä¸­å®šæœŸè¿è¡Œæ­¤ä»»åŠ¡ï¼Œä»¥ä¿æŒè‰¯å¥½çš„ç£ç›˜ç©ºé—´åˆ©ç”¨ç‡å’Œè‰¯å¥½çš„æ“ä½œæ€§èƒ½ã€‚ ä¸€äº›gitå‘½ä»¤å¯èƒ½ä¼šè‡ªåŠ¨è¿è¡Œgit gc; --autoè¯¦ç»†ä¿¡æ¯è¯·å‚é˜…ä¸‹é¢çš„æ ‡å¿—ã€‚å¦‚æœæ‚¨çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆï¼Œå¹¶ä¸”æ‰€æœ‰æ‚¨æƒ³è¦çš„éƒ½æ˜¯æ°¸ä¹…ç¦ç”¨æ­¤è¡Œä¸ºè€Œæ— éœ€è¿›ä¸€æ­¥è€ƒè™‘ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š $ git config --global gc.auto 0 é€‰é¡¹ï¼š â€“aggressive é€šå¸¸git gcè¿è¡Œé€Ÿåº¦å¾ˆå¿«ï¼ŒåŒæ—¶æä¾›è‰¯å¥½çš„ç£ç›˜ç©ºé—´åˆ©ç”¨ç‡å’Œæ€§èƒ½ æ­¤é€‰é¡¹å°†å¯¼è‡´git gcæ›´ç§¯æåœ°ä¼˜åŒ–å­˜å‚¨åº“ï¼Œä½†èŠ±è´¹æ›´å¤šæ—¶é—´ã€‚è¿™ç§ä¼˜åŒ–çš„æ•ˆæœæ˜¯æŒä¹…çš„ï¼Œæ‰€ä»¥è¿™ä¸ªé€‰é¡¹åªéœ€è¦å¶å°”ä½¿ç”¨; æ¯éš”å‡ ç™¾ä¸ªå˜æ›´é›†å·¦å³ã€‚ â€“auto ä½¿ç”¨æ­¤é€‰é¡¹ï¼Œgit gcæ£€æŸ¥æ˜¯å¦éœ€è¦è¿›è¡Œä»»ä½•æ¸…æ´å·¥ä½œ; å¦‚æœæ²¡æœ‰ï¼Œå®ƒä¼šé€€å‡ºè€Œä¸æ‰§è¡Œä»»ä½•å·¥ä½œã€‚ä¸€äº›gitå‘½ä»¤git gc --autoåœ¨æ‰§è¡Œå¯èƒ½ä¼šäº§ç”Ÿè®¸å¤šæ¾æ•£å¯¹è±¡çš„æ“ä½œä¹‹åè¿è¡Œã€‚ å¦‚æœå­˜å‚¨åº“ä¸­çš„æ¾æ•£å¯¹è±¡å¤ªå¤šæˆ–åŒ…è£…å¤ªå¤šï¼Œåˆ™éœ€è¦è¿›è¡Œå†…åŠ¡å¤„ç†ã€‚å¦‚æœæ¾æ•£å¯¹è±¡çš„æ•°é‡è¶…è¿‡äº†gc.autoé…ç½®å˜é‡çš„å€¼ï¼Œåˆ™æ‰€æœ‰æ¾æ•£å¯¹è±¡éƒ½å°†ä½¿ç”¨ç»„åˆåˆ°ä¸€ä¸ªåŒ…ä¸­git repack -d -lã€‚å°†å€¼è®¾ç½®gc.autoä¸º0å°†ç¦ç”¨è‡ªåŠ¨å¡«å……æ¾æ•£ç‰©ä½“ã€‚ å¦‚æœåŒ…è£…æ•°é‡è¶…è¿‡äº†ä»·å€¼gc.autoPackLimitï¼Œé‚£ä¹ˆç°æœ‰åŒ…è£…ï¼ˆæ ‡æœ‰.keepæ–‡ä»¶çš„åŒ…è£…é™¤å¤–ï¼‰å°†é€šè¿‡ä½¿ç”¨-Aé€‰é¡¹åˆå¹¶åˆ°ä¸€ä¸ªåŒ…è£…ä¸­git repackã€‚è®¾ç½®gc.autoPackLimitä¸º0å°†ç¦ç”¨è‡ªåŠ¨åˆå¹¶åŒ…è£…ã€‚ â€“prune= ä¿®å‰ªæ¯”æ—¥æœŸæ›´æ—§çš„æ¾æ•£å¯¹è±¡ï¼ˆé»˜è®¤ä¸º2å‘¨å‰ï¼Œå¯ç”±é…ç½®å˜é‡è¦†ç›–gc.pruneExpireï¼‰ã€‚â€“prune =ä¸ç®¡å¹´é¾„å¤§å°ï¼Œéƒ½ä¿®å‰ªæ¾æ•£çš„ç‰©ä½“ï¼Œå¹¶ä¸”å¦‚æœå¦ä¸€ä¸ªè¿›ç¨‹åŒæ—¶å†™å…¥å­˜å‚¨åº“ï¼Œåˆ™ä¼šå¢åŠ è…è´¥é£é™©; è¯·å‚é˜…ä¸‹é¢çš„â€œæ³¨æ„äº‹é¡¹â€ã€‚â€“pruneé»˜è®¤æ‰“å¼€ã€‚ â€“no-prune ä¸è¦ä¿®å‰ªä»»ä½•æ¾åŠ¨çš„ç‰©ä½“ã€‚ â€“quiet å–æ¶ˆæ‰€æœ‰è¿›åº¦æŠ¥å‘Šã€‚ â€“force git gcå³ä½¿å¯èƒ½æœ‰å¦ä¸€ä¸ªgit gcå®ä¾‹åœ¨æ­¤å­˜å‚¨åº“ä¸Šè¿è¡Œï¼Œä¹Ÿå¼ºåˆ¶è¿è¡Œã€‚ æ³¨æ„ï¼š git gcå°½é‡ä¸è¦åˆ é™¤åœ¨å­˜å‚¨åº“ä¸­ä»»ä½•ä½ç½®å¼•ç”¨çš„å¯¹è±¡ã€‚ç‰¹åˆ«æ˜¯ï¼Œå®ƒä¸ä»…ä¼šä¿å­˜å½“å‰ä¸€ç»„åˆ†æ”¯å’Œæ ‡è®°æ‰€å¼•ç”¨çš„å¯¹è±¡ï¼Œè¿˜ä¼šä¿ç•™ç”±ç´¢å¼•å¼•ç”¨çš„å¯¹è±¡ï¼Œè¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ï¼Œgit filter-branchrefs / original /ä¸­ä¿å­˜çš„å¼•ç”¨æˆ–reflogsï¼ˆå¯å¼•ç”¨åˆ†æ”¯ä¸­çš„æäº¤åæ¥ä¿®æ”¹æˆ–å€’å¸¦ï¼‰ã€‚å¦‚æœæ‚¨å¸Œæœ›æŸäº›å¯¹è±¡è¢«åˆ é™¤è€Œä¸æ˜¯ï¼Œè¯·æ£€æŸ¥æ‰€æœ‰è¿™äº›ä½ç½®ï¼Œå¹¶å†³å®šåœ¨æ‚¨çš„æƒ…å†µä¸‹åˆ é™¤è¿™äº›å¼•ç”¨æ˜¯å¦æœ‰æ„ä¹‰ã€‚ å¦ä¸€æ–¹é¢ï¼Œå½“git gcä¸å¦ä¸€ä¸ªè¿›ç¨‹åŒæ—¶è¿è¡Œæ—¶ï¼Œå¯èƒ½ä¼šåˆ é™¤å¦ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨ä½¿ç”¨ä½†å°šæœªåˆ›å»ºå¼•ç”¨çš„å¯¹è±¡ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´å…¶ä»–è¿›ç¨‹å¤±è´¥æˆ–è€…å¯èƒ½ä¼šæŸåå­˜å‚¨åº“ï¼Œå¦‚æœå…¶ä»–è¿›ç¨‹ç¨åæ·»åŠ å¯¹å·²åˆ é™¤å¯¹è±¡çš„å¼•ç”¨ã€‚Gitæœ‰ä¸¤ä¸ªåŠŸèƒ½å¯ä»¥æ˜¾ç€ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼š --pruneä¿ç•™ä¿®æ”¹æ—¶é—´æ¯”æ—¥æœŸæ›´æ–°çš„ä»»ä½•å¯¹è±¡ä»¥åŠå¯ä»å…¶è®¿é—®çš„æ‰€æœ‰å¯¹è±¡ã€‚ å°†å¯¹è±¡æ·»åŠ åˆ°æ•°æ®åº“çš„å¤§å¤šæ•°æ“ä½œéƒ½ä¼šæ›´æ–°å¯¹è±¡çš„ä¿®æ”¹æ—¶é—´ï¼ˆå¦‚æœè¯¥å¯¹è±¡å·²å­˜åœ¨ï¼Œä»¥ä¾¿åº”ç”¨ï¼ƒ1ï¼‰ã€‚ ç„¶è€Œï¼Œè¿™äº›åŠŸèƒ½å¹¶ä¸èƒ½æä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œå› æ­¤ï¼ŒåŒæ—¶è¿è¡Œå‘½ä»¤çš„ç”¨æˆ·å¿…é¡»å¿å—ä¸€äº›è…è´¥é£é™©ï¼ˆå®è·µä¸­ä¼¼ä¹å¾ˆä½ï¼‰ï¼Œé™¤éä»–ä»¬å…³é—­è‡ªåŠ¨åƒåœ¾æ”¶é›†git config gc.auto 0 ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:8:0","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"ä¹ã€Git gpgç­¾å # æŸ¥çœ‹gpgå¯†é’¥ [root@local ~]# gpg --list-key /root/.gnupg/pubring.kbx ------------------------ pub rsa4096 2021-08-23 [SC] C40EA42A60xxxxxxxxxxxxxxxxxx uid [ ç»å¯¹ ] cccc (local) \u003ct@local.com\u003e sub rsa4096 2021-08-23 [E] pub rsa4096 2021-08-23 [SC] 3CB22116355xxxxxxxxxxxxxxxxxx uid [ ç»å¯¹ ] tom (github) \u003ct@local.cc\u003e sub rsa4096 2021-08-23 [E] é…ç½®ä½¿ç”¨gpgç­¾å # git é…ç½®ä½¿ç”¨gpgç­¾å git config --global user.signingkey \u003cgpg-key-id\u003e # æäº¤æ˜¯å¦å¼ºåˆ¶ GPGï¼Œå¸¦ä¸Š--global æ˜¯ä½œç”¨å…¨å±€ï¼Œå±€éƒ¨çš„å»é™¤--global [root@sugar2 ~]# git config --global commit.gpgsign true # commit æäº¤è®¾ç½®GPGç­¾åï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®å¼ºåˆ¶ï¼Œåˆ™éœ€è¦åŠ ä¸Š-S [root@sugar2 ~]# git commit -S -m â€œcommit message\" # åœ¨githubä¸Šç­¾åçš„æäº¤å°†æ˜¾ç¤ºåŒ…å«â€œ Verifiedâ€ é—®é¢˜ï¼š [root@sugar ssl]# git commit -m \"init repo\" error: gpg æ•°æ®ç­¾åå¤±è´¥ fatal: å†™æäº¤å¯¹è±¡å¤±è´¥ å‚è€ƒé“¾æ¥ï¼šhttps://zhuanlan.zhihu.com/p/97984430 è§£å†³åŠæ³•ï¼šexport GPG_TTY=$(tty) åœ¨ç¯å¢ƒå˜é‡é‡Œå¢åŠ ä¸€é¡¹GPG_TTY ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:9:0","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["DevOps"],"content":"åã€é…ç½®http git æ‹‰å–ä»£ç ä½¿ç”¨çš„åè®®æ˜¯sshï¼Œä½†ä¹Ÿå¯ä»¥ä½¿ç”¨http é…ç½®ï¼š [root@Krab ~]ğŸ³ git config --global credential.helper store # é…ç½®å~/.gitconfig æ–‡ä»¶ä¼šå¢åŠ é…ç½® [credential] helper = store # åœ¨ç¬¬ä¸€æ¬¡è®¿é—®gitæœåŠ¡çš„æ—¶å€™ï¼Œå¯†é’¥ä¼šè¢«è®°å½•åœ¨ ~/.git-credentials æ–‡ä»¶ä¸­ # é…ç½®å†å²é¡¹ç›®æ”¹æˆä½¿ç”¨http(æ­¤æ–¹æ³•é€‚ç”¨httpè½¬sshæˆ–è€…sshè½¬httpï¼Œæˆ–è€…æ›´æ¢æŒ‡å®šgitæœåŠ¡å™¨) [url \"http://local.io/\"] insteadOf = git@local.io: é…ç½®github ssh èµ°ä»£ç† [root@Krab ~]ğŸ³ cat ~/.ssh/config Host github.com User git ProxyCommand nc -v -x 127.0.0.1:5888 %h %p ","date":"2023-11-18","objectID":"/posts/2023-11-18-git/:10:0","tags":["git","vcs","dev"],"title":"Git","uri":"/posts/2023-11-18-git/"},{"categories":["Database"],"content":"SQLite SQLiteæ˜¯ä¸€ç§å¼€æºï¼Œé›¶é…ç½®ï¼Œç‹¬ç«‹çš„ï¼Œç‹¬ç«‹çš„ï¼Œäº‹åŠ¡å…³ç³»æ•°æ®åº“å¼•æ“ï¼Œæ—¨åœ¨åµŒå…¥åˆ°åº”ç”¨ç¨‹åºä¸­ã€‚ ","date":"2023-11-12","objectID":"/posts/2023-11-12-sqlite3/:0:0","tags":["sqlite","sqlite3","db"],"title":"sqlite3","uri":"/posts/2023-11-12-sqlite3/"},{"categories":["Database"],"content":"ä¸€ã€å®‰è£…sqlite SQLiteä»¥å…¶é›¶é…ç½®è€Œé—»åï¼Œæ‰€ä»¥ä¸éœ€è¦å¤æ‚çš„è®¾ç½®æˆ–ç®¡ç†ã€‚ # rpm yum -y install sqlite3 # apt apt install sqlite3 ","date":"2023-11-12","objectID":"/posts/2023-11-12-sqlite3/:1:0","tags":["sqlite","sqlite3","db"],"title":"sqlite3","uri":"/posts/2023-11-12-sqlite3/"},{"categories":["Database"],"content":"äºŒã€sqliteå‘½ä»¤ ","date":"2023-11-12","objectID":"/posts/2023-11-12-sqlite3/:2:0","tags":["sqlite","sqlite3","db"],"title":"sqlite3","uri":"/posts/2023-11-12-sqlite3/"},{"categories":["Database"],"content":"è¿›å…¥sqlite [sugar@MacBook-Pro ~]$ sqlite3 SQLite version 3.32.3 2020-06-18 14:16:19 Enter \".help\" for usage hints. Connected to a transient in-memory database. Use \".open FILENAME\" to reopen on a persistent database. sqlite\u003e .exit å¦‚éœ€è·å–å¯ç”¨çš„ç‚¹å‘½ä»¤çš„æ¸…å•ï¼Œå¯ä»¥åœ¨ä»»ä½•æ—¶å€™è¾“å…¥ â€œ.helpâ€ sqlite\u003e .help .auth ON|OFF Show authorizer callbacks .backup ?DB? FILE Backup DB (default \"main\") to FILE .bail on|off Stop after hitting an error. Default OFF .binary on|off Turn binary output on or off. Default OFF .cd DIRECTORY Change the working directory to DIRECTORY .changes on|off Show number of rows changed by SQL .check GLOB Fail if output since .testcase does not match .clone NEWDB Clone data into NEWDB from the existing database .databases List names and files of attached databases .dbconfig ?op? ?val? List or change sqlite3_db_config() options .dbinfo ?DB? Show status information about the database .dump ?TABLE? Render database content as SQL .echo on|off Turn command echo on or off ä¸Šé¢çš„å‘½ä»¤ä¼šæ˜¾ç¤ºå„ç§é‡è¦çš„ SQLite ç‚¹å‘½ä»¤çš„åˆ—è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å‘½ä»¤ æè¿° .backup ? DB? FILE å¤‡ä»½ DB æ•°æ®åº“ï¼ˆé»˜è®¤æ˜¯ â€œmainâ€ï¼‰åˆ° FILE æ–‡ä»¶ã€‚ .bail ON|OFF å‘ç”Ÿé”™è¯¯ååœæ­¢ã€‚é»˜è®¤ä¸º OFFã€‚ .databases åˆ—å‡ºæ•°æ®åº“çš„åç§°åŠå…¶æ‰€ä¾é™„çš„æ–‡ä»¶ã€‚ .dump ?TABLE? ä»¥ SQL æ–‡æœ¬æ ¼å¼è½¬å‚¨æ•°æ®åº“ã€‚å¦‚æœæŒ‡å®šäº† TABLE è¡¨ï¼Œåˆ™åªè½¬å‚¨åŒ¹é… LIKE æ¨¡å¼çš„ TABLE è¡¨ã€‚ .echo ON|OFF å¼€å¯æˆ–å…³é—­ echo å‘½ä»¤ã€‚ .exit é€€å‡º SQLite æç¤ºç¬¦ã€‚ .explain ON|OFF å¼€å¯æˆ–å…³é—­é€‚åˆäº EXPLAIN çš„è¾“å‡ºæ¨¡å¼ã€‚å¦‚æœæ²¡æœ‰å¸¦å‚æ•°ï¼Œåˆ™ä¸º EXPLAIN onï¼Œå³å¼€å¯ EXPLAINã€‚ .header(s) ON|OFF å¼€å¯æˆ–å…³é—­å¤´éƒ¨æ˜¾ç¤ºã€‚ .help æ˜¾ç¤ºæ¶ˆæ¯ã€‚ .import FILE TABLE å¯¼å…¥æ¥è‡ª FILE æ–‡ä»¶çš„æ•°æ®åˆ° TABLE è¡¨ä¸­ã€‚ .indices ?TABLE? æ˜¾ç¤ºæ‰€æœ‰ç´¢å¼•çš„åç§°ã€‚å¦‚æœæŒ‡å®šäº† TABLE è¡¨ï¼Œåˆ™åªæ˜¾ç¤ºåŒ¹é… LIKE æ¨¡å¼çš„ TABLE è¡¨çš„ç´¢å¼•ã€‚ .load FILE ?ENTRY? åŠ è½½ä¸€ä¸ªæ‰©å±•åº“ã€‚ .log FILE|off å¼€å¯æˆ–å…³é—­æ—¥å¿—ã€‚FILE æ–‡ä»¶å¯ä»¥æ˜¯ stderrï¼ˆæ ‡å‡†é”™è¯¯ï¼‰/stdoutï¼ˆæ ‡å‡†è¾“å‡ºï¼‰ã€‚ .mode MODE è®¾ç½®è¾“å‡ºæ¨¡å¼ï¼ŒMODE å¯ä»¥æ˜¯ä¸‹åˆ—ä¹‹ä¸€ï¼šcsv é€—å·åˆ†éš”çš„å€¼column å·¦å¯¹é½çš„åˆ—html HTML çš„ ä»£ç insert TABLE è¡¨çš„ SQL æ’å…¥ï¼ˆinsertï¼‰è¯­å¥line æ¯è¡Œä¸€ä¸ªå€¼list ç”± .separator å­—ç¬¦ä¸²åˆ†éš”çš„å€¼tabs ç”± Tab åˆ†éš”çš„å€¼tcl TCL åˆ—è¡¨å…ƒç´  .nullvalue STRING åœ¨ NULL å€¼çš„åœ°æ–¹è¾“å‡º STRING å­—ç¬¦ä¸²ã€‚ .output FILENAME å‘é€è¾“å‡ºåˆ° FILENAME æ–‡ä»¶ã€‚ .output stdout å‘é€è¾“å‡ºåˆ°å±å¹•ã€‚ .print STRINGâ€¦ é€å­—åœ°è¾“å‡º STRING å­—ç¬¦ä¸²ã€‚ .prompt MAIN CONTINUE æ›¿æ¢æ ‡å‡†æç¤ºç¬¦ã€‚ .quit é€€å‡º SQLite æç¤ºç¬¦ã€‚ .read FILENAME æ‰§è¡Œ FILENAME æ–‡ä»¶ä¸­çš„ SQLã€‚ .schema ?TABLE? æ˜¾ç¤º CREATE è¯­å¥ã€‚å¦‚æœæŒ‡å®šäº† TABLE è¡¨ï¼Œåˆ™åªæ˜¾ç¤ºåŒ¹é… LIKE æ¨¡å¼çš„ TABLE è¡¨ã€‚ .separator STRING æ”¹å˜è¾“å‡ºæ¨¡å¼å’Œ .import æ‰€ä½¿ç”¨çš„åˆ†éš”ç¬¦ã€‚ .show æ˜¾ç¤ºå„ç§è®¾ç½®çš„å½“å‰å€¼ã€‚ .stats ON|OFF å¼€å¯æˆ–å…³é—­ç»Ÿè®¡ã€‚ .tables ?PATTERN? åˆ—å‡ºåŒ¹é… LIKE æ¨¡å¼çš„è¡¨çš„åç§°ã€‚ .timeout MS å°è¯•æ‰“å¼€é”å®šçš„è¡¨ MS æ¯«ç§’ã€‚ .width NUM NUM ä¸º â€œcolumnâ€ æ¨¡å¼è®¾ç½®åˆ—å®½åº¦ã€‚ .timer ON|OFF å¼€å¯æˆ–å…³é—­ CPU å®šæ—¶å™¨ã€‚ ç”¨.showå‘½ä»¤æ¥æŸ¥çœ‹ SQLite å‘½ä»¤æç¤ºç¬¦çš„é»˜è®¤è®¾ç½® sqlite\u003e .show echo: off eqp: off explain: auto headers: off mode: list nullvalue: \"\" output: stdout colseparator: \"|\" rowseparator: \"\\n\" stats: off width: filename: :memory: sqlite\u003e ","date":"2023-11-12","objectID":"/posts/2023-11-12-sqlite3/:2:1","tags":["sqlite","sqlite3","db"],"title":"sqlite3","uri":"/posts/2023-11-12-sqlite3/"},{"categories":["Database"],"content":"æ ¼å¼åŒ–è¾“å‡º .header on .mode column .timer on .changes on è¿™æ ·è®¾ç½®åªæ˜¯åœ¨å½“å‰ç»ˆç«¯ä¸­è®¾ç½®äº†æ ¼å¼åŒ–è¾“å‡ºï¼Œå½“å†æ¬¡æ‰“å¼€æ—¶åˆ™éœ€è¦å†æ¬¡è®¾ç½®ï¼Œå¯ä»¥æŠŠsqliteçš„é…ç½®å†™å…¥åˆ°~/.sqliter [sugar@localhost domain]$ cat ~/.sqliterc .header on .mode column .timer on [sugar@localhost domain]$ sqlite3 domain.db -- Loading resources from /Users/sugar/.sqliterc SQLite version 3.37.0 2021-12-09 01:34:53 Enter \".help\" for usage hints. sqlite\u003e .tables ssls sqlite\u003e select * from ssls; id created_at updated_at deleted_at status web -- -------------------------------- -------------------------------- ---------- ------ ----------------- 1 2022-10-14 23:31:24.473488+08:00 2022-10-14 23:31:24.473488+08:00 1 https://gitea.com Run Time: real 0.001 user 0.000178 sys 0.000250 ","date":"2023-11-12","objectID":"/posts/2023-11-12-sqlite3/:2:2","tags":["sqlite","sqlite3","db"],"title":"sqlite3","uri":"/posts/2023-11-12-sqlite3/"},{"categories":["Database"],"content":"ä¸‰ã€sqlæ“ä½œ åˆ›å»ºæ•°æ®åº“ $ sqlite3 cccc.db SQLite version 3.32.3 2020-06-18 14:16:19 Enter \".help\" for usage hints. sqlite\u003e ä¸Šé¢çš„å‘½ä»¤å°†åœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ cccc.dbã€‚è¯¥æ–‡ä»¶å°†è¢« SQLite å¼•æ“ç”¨ä½œæ•°æ®åº“ã€‚å¦‚æœæ‚¨å·²ç»æ³¨æ„åˆ° sqlite3 å‘½ä»¤åœ¨æˆåŠŸåˆ›å»ºæ•°æ®åº“æ–‡ä»¶ä¹‹åï¼Œå°†æä¾›ä¸€ä¸ª sqlite\u003e æç¤ºç¬¦ã€‚ ä¸€æ—¦æ•°æ®åº“è¢«åˆ›å»ºï¼Œæ‚¨å°±å¯ä»¥ä½¿ç”¨ SQLite çš„ .databases å‘½ä»¤æ¥æ£€æŸ¥å®ƒæ˜¯å¦åœ¨æ•°æ®åº“åˆ—è¡¨ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š sqlite\u003e .database main: /Users/sugar/Desktop/workspace/cccc.db sqlite\u003e æ•°æ®åº“å¤‡ä»½ sqlite3 cccc.db .dump \u003e cccc.sql æ¢å¤æ•°æ®åº“ sqlite3 cccc.db \u003c cccc.sql æŸ¥çœ‹è¡¨è¯¦ç»†ä¿¡æ¯ .schema éäº¤äº’å¼æ‰§è¡Œsql [sugar@Sugar sqlite]$ sqlite3 cccc.db \"select * from msg;\" -- Loading resources from /Users/sugar/.sqliterc age id --- ---- 19 1001 ","date":"2023-11-12","objectID":"/posts/2023-11-12-sqlite3/:3:0","tags":["sqlite","sqlite3","db"],"title":"sqlite3","uri":"/posts/2023-11-12-sqlite3/"},{"categories":["Database"],"content":"å››ã€sqlè¯­æ³• å¤§å°å†™ SQLiteä¸åŒºåˆ†å¤§å°å†™ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€äº›åŒºåˆ†å¤§å°å†™çš„å‘½ä»¤ã€‚ä¾‹å¦‚ï¼šGLOBå’Œglobåœ¨SQLiteè¯­å¥ä¸­æœ‰ä¸åŒçš„å«ä¹‰ã€‚ æ³¨é‡Šï¼š æ³¨é‡Šç”¨äºåœ¨SQLiteä»£ç ä¸­å¢åŠ ä»£ç çš„å¯è¯»æ€§ã€‚ æ³¨é‡Šä¸èƒ½åµŒå¥—ã€‚ æ³¨é‡Šä»¥ä¸¤ä¸ªè¿ç»­çš„â€œ - â€å­—ç¬¦ã€‚ ä¹Ÿå¯ä½¿ç”¨â€œ/*â€å­—ç¬¦å¼€å§‹ï¼Œå¹¶å»¶ä¼¸è‡³ä¸‹ä¸€ä¸ªâ€œ*/â€å­—ç¬¦å¯¹æ‰€åŒ…æ‹¬çš„å†…å®¹è§†ä¸ºæ³¨é‡Šã€‚ 1ã€è¡¨æ“ä½œ åˆ—çš„æ•°æ®ç±»å‹ NULL â€”è¯¥å€¼ä¸º NULL å€¼ INTEGER â€”æœ‰ç¬¦å·æ•´æ•° REAL â€”æµ®ç‚¹å€¼ TEXT-æ–‡æœ¬å­—ç¬¦ä¸² BLOB â€”æ•°æ®å— -- åˆ›å»ºè¡¨ sqlite\u003e CREATE TABLE Testing(Id INTEGER); Run Time: real 0.002 user 0.000269 sys 0.001006 changes: 0 total_changes: 0 sqlite\u003e -- æŸ¥çœ‹è¡¨ç»“æ„ sqlite\u003e .schema CREATE TABLE Testing(Id INTEGER); sqlite\u003e .schema Testing CREATE TABLE Testing(Id INTEGER); sqlite\u003e -- å¦‚æœå­˜åœ¨åˆ™ä¸åˆ›å»º CREATE TABLE IF NOT EXISTS Testing(Id INTEGER); -- å¤åˆ¶è¡¨ CREATE TABLE Cars2 AS SELECT * FROM Cars; -- æŸ¥çœ‹æ‰€æœ‰è¡¨ sqlite\u003e .tables Testing -- é€šç”¨è¯­æ³• sqlite\u003e select * from sqlite_master; type name tbl_name rootpage sql ----- ------- -------- -------- -------------------------------- table Testing Testing 2 CREATE TABLE Testing(Id INTEGER) Run Time: real 0.001 user 0.000111 sys 0.000102 changes: 0 total_changes: 0 sqlite\u003e -- åˆ é™¤è¡¨ sqlite\u003e DROP TABLE Testing; sqlite\u003e DROP TABLE IF EXISTS Testing; -- é‡å‘½åæ•°è¡¨ sqlite\u003e CREATE TABLE Names(Id INTEGER, Name TEXT); sqlite\u003e ALTER TABLE Names RENAME TO NamesOfFriends; sqlite\u003e .schema NamesOfFriends 2ã€æ•°æ®æ“ä½œ sqlite\u003e CREATE TABLE Cars(Id INTEGER PRIMARY KEY, Name TEXT,Price INTEGER DEFAULT 'Not available'); -- æ’å…¥æ•°æ® sqlite\u003e INSERT INTO Cars(Id, Name, Price) VALUES(1, 'Audi', 52642); -- åˆ é™¤æ•°æ® sqlite\u003e DELETE FROM Cars2 WHERE Id=1; -- åˆ é™¤è¡¨æ‰€æœ‰æ•°æ® sqlite\u003e DELETE FROM Cars2; -- æ›´æ–°æ•°æ® sqlite\u003e UPDATE Cars SET Name='Skoda Octavia' WHERE Id=3; 3ã€çº¦æŸ # éç©º NOT NULL # å”¯ä¸€ UNIQUE # ä¸»é”® PRIMARY KEY # å¤–é”® FOREIGN KEY # é»˜è®¤å€¼ sqlite\u003e CREATE TABLE Hotels(Id INTEGER PRIMARY KEY, Name TEXT,City TEXT DEFAULT 'not available'); æ‰€æœ‰çš„SQLiteè¯­å¥éƒ½æ˜¯ä»¥å…³é”®å­—(å¦‚ï¼šSELECTï¼ŒINSERTï¼ŒUPDATEï¼ŒDELETEï¼ŒALTERï¼ŒDROPç­‰)å¼€å§‹çš„ã€‚æ‰€æœ‰è¯­å¥éƒ½ä»¥åˆ†å·(;)ç»“å°¾ã€‚ ANALYZEè¯­å¥çš„è¯­æ³•ï¼š ANALYZE; -- or ANALYZE database_name; -- or ANALYZE database_name.table_name; AND/ORå­å¥çš„è¯­æ³•ï¼š SELECT column1, column2....columnN FROM table_name WHERE CONDITION-1 {AND|OR} CONDITION-2; ALTER TABLEè¯­å¥çš„è¯­æ³• ALTER TABLE table_name ADD COLUMN column_def...; ALTER TABLEè¯­å¥(Rename)è¯­å¥çš„è¯­æ³• ALTER TABLE table_name RENAME TO new_table_name; ATTACH DATABASEè¯­å¥çš„è¯­æ³•ï¼š ATTACH DATABASE 'DatabaseName' As 'Alias-Name'; BEGIN TRANSACTIONè¯­å¥çš„è¯­æ³•ï¼š BEGIN; -- or BEGIN EXCLUSIVE TRANSACTION; BETWEENè¯­å¥çš„è¯­æ³•ï¼š SELECT column1, column2....columnN FROM table_name WHERE column_name BETWEEN val-1 AND val-2; SQLite COMMIT Statement: COMMIT; CREATE INDEXè¯­å¥çš„è¯­æ³•ï¼š CREATE INDEX index_name ON table_name ( column_name COLLATE NOCASE ); CREATE UNIQUE INDEXè¯­å¥çš„è¯­æ³•ï¼š CREATE UNIQUE INDEX index_name ON table_name ( column1, column2,...columnN); CREATE TABLEè¯­å¥çš„è¯­æ³•ï¼š CREATE TABLE table_name( column1 datatype, column2 datatype, column3 datatype, ..... columnN datatype, PRIMARY KEY( one or more columns )); CREATE TRIGGERè¯­å¥çš„è¯­æ³•ï¼š CREATE TRIGGER database_name.trigger_name BEFORE INSERT ON table_name FOR EACH ROW BEGIN stmt1; stmt2; .... END; CREATE VIEWè¯­å¥çš„è¯­æ³•ï¼š CREATE VIEW database_name.view_name AS SELECT statement....; CREATE VIRTUAL TABLEè¯­å¥çš„è¯­æ³•ï¼š CREATE VIRTUAL TABLE database_name.table_name USING weblog( access.log ); -- or CREATE VIRTUAL TABLE database_name.table_name USING fts3( ); COMMIT TRANSACTIONè¯­å¥çš„è¯­æ³•ï¼š COMMIT; COUNTè¯­å¥çš„è¯­æ³•ï¼š SELECT COUNT(column_name) FROM table_name WHERE CONDITION; DELETEè¯­å¥çš„è¯­æ³•ï¼š DELETE FROM table_name WHERE {CONDITION}; DETACH DATABASEè¯­å¥çš„è¯­æ³•ï¼š DETACH DATABASE 'Alias-Name'; DISTINCTè¯­å¥çš„è¯­æ³•ï¼š SELECT DISTINCT column1, column2....columnN FROM table_name; DROP INDEXè¯­å¥çš„è¯­æ³•ï¼š DROP INDEX database_name.index_name; DROP TABLEè¯­å¥çš„è¯­æ³•ï¼š DROP TABLE database_name.table_name; DROP VIEWè¯­å¥çš„è¯­æ³•ï¼š DROP INDEX database_name.view_name; SQLite DROP TRIGGER è¯­å¥çš„è¯­æ³•ï¼š DROP INDEX database_name.trigger_name; SQLite EXISTSè¯­å¥çš„è¯­æ³•ï¼š SELECT column1, column2....columnN FROM table_name WHERE column_name EXISTS (SELECT * FROM table_name ); EXPLAINè¯­å¥çš„è¯­æ³•ï¼š EXPLAIN INSERT statement...; -- or EXPLAIN QUERY PLAN SELECT statement...; GLOBè¯­å¥çš„è¯­æ³•ï¼š SELECT column1, column2....columnN FROM table_name WHERE column_name GLOB { PATTERN }; GROUP BYè¯­å¥çš„è¯­æ³•ï¼š SELECT SUM(column_name) FROM table_name WHERE CONDITION GROUP BY column_name; HAVINGè¯­å¥çš„è¯­æ³•ï¼š SELEC","date":"2023-11-12","objectID":"/posts/2023-11-12-sqlite3/:4:0","tags":["sqlite","sqlite3","db"],"title":"sqlite3","uri":"/posts/2023-11-12-sqlite3/"},{"categories":["DevOps"],"content":"é’‰é’‰æœºå™¨äºº ","date":"2023-11-11","objectID":"/posts/2023-11-11-dingbot/:0:0","tags":["dingbot"],"title":"dingbot","uri":"/posts/2023-11-11-dingbot/"},{"categories":["DevOps"],"content":"ä¸€ã€shellè„šæœ¬ ","date":"2023-11-11","objectID":"/posts/2023-11-11-dingbot/:1:0","tags":["dingbot"],"title":"dingbot","uri":"/posts/2023-11-11-dingbot/"},{"categories":["DevOps"],"content":"1ã€åŸºäºå…³é”®å­—æˆ–è€… ip ç‰ˆ å‘é€txtæ ¼å¼æ¶ˆæ¯ info='hello' logFile='/var/log/dingbot.log' #å‘é€æ¶ˆæ¯ sendMsg() { token='1e18ffe069052b56f5a0f8fe9b6c058373e7df7ef4xxxxxxxxxxxxxxx' result=$(curl -s \"https://oapi.dingtalk.com/robot/send?access_token=$token\" \\ -H 'Content-Type: application/json' \\ -d \"{'msgtype': 'text','text': {'content': 'msg:\\n$*'}}\") [ $(echo $result | grep \"errmsg.*ok\") ] \u0026\u0026 echo 'send succees!' echo \"$(date +'%Y-%m-%d %H:%M.%S') state: $result msg: $*\" \u003e\u003e$logFile } sendMsg $info å‘é€ markdown æ ¼å¼æ¶ˆæ¯ logFile='/var/log/DingBot.log' token='1e18ffe069052b56f5a0f8fe9b6c058373xxxxxxxxxxxxxx' #å‘é€æ¶ˆæ¯ sendMsg() { local info=$* result=$(curl -s \"https://oapi.dingtalk.com/robot/send?access_token=$token\" \\ -H 'Content-Type: application/json' \\ -d \"{'msgtype': 'text', 'text': { 'content': '$info' } }\") [ $(echo $result | grep \"errmsg.*ok\") ] \u0026\u0026 echo 'send succees!' echo \"$(date +'%Y-%m-%d %H:%M.%S') state: $result MessagesType: text [ text: $* ]\" \u003e\u003e$logFile } SendMsgByMD() { local info=$1 # $info markdownçš„æ ‡é¢˜ local infoMsg=$2 # $infoMsg å†…å®¹ # token='1e18ffe069052b56f5a0f8fe9b6c058373e7df7xxxxxxxxxxxxxx' result=$(curl -s \"https://oapi.dingtalk.com/robot/send?access_token=$token\" \\ -H 'Content-Type: application/json' \\ -d \"{ 'msgtype': 'markdown', 'markdown': { 'title':'$info', 'text': '$infoMsg' }, 'at': { 'atMobiles': [ '156xxxx8827', '189xxxx8325' ], 'isAtAll': true } }\") [ $(echo $result | grep \"errmsg.*ok\") ] \u0026\u0026 echo 'send succees!' echo \"$(date +'%Y-%m-%d %H:%M.%S') state: $result MessagesType: markdown [ title: $info text: $infoMsg ]\" \u003e\u003e$logFile } #main() (sendMsg 'zabbix') \u0026 (SendMsgByMD 'zabbix' '# send msg') \u0026 ","date":"2023-11-11","objectID":"/posts/2023-11-11-dingbot/:1:1","tags":["dingbot"],"title":"dingbot","uri":"/posts/2023-11-11-dingbot/"},{"categories":["DevOps"],"content":"2ã€ç­¾åè®¡ç®—ç‰ˆ è®¡ç®—ç­¾åæ˜¯ä½¿ç”¨çš„dateæ˜¯linuxç‰ˆçš„ï¼Œè€Œmacä¸Šçš„dateæ˜¯unixç‰ˆçš„ï¼Œåœ¨macä¸Šéœ€è¦æ›¿æ¢ä¸ºlinuxç‰ˆçš„dateæ‰èƒ½æ­£å¸¸è®¡ç®—ç­¾åã€‚ ## é’‰é’‰æœºå™¨äººé…ç½® dingbot_secret='SECa87axxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx' dingbot_url='https://oapi.dingtalk.com/robot/send?access_token=cd3xxxxxxxxxxxxx' ## secret_type keywords || sign ding_secret_type='sign' ## éœ€è¦è‰¾ç‰¹çš„äººçš„æ‰‹æœºå·ç ï¼Œä»¥ç©ºæ ¼éš”å¼€ atMobiles=(13346123456 13346123457) ## encode url function url_encode() { t=\"${1}\" if [[ -n \"${1}\" \u0026\u0026 -n \"${2}\" ]];then if ! echo 'xX' | grep -q \"${t}\";then t='x' fi echo -n \"${2}\" | od -t d1 | awk -v a=\"${t}\" '{for (i = 2; i \u003c= NF; i++) {printf(($i\u003e=48 \u0026\u0026 $i\u003c=57) || ($i\u003e=65 \u0026\u0026$i\u003c=90) || ($i\u003e=97 \u0026\u0026 $i\u003c=122) ||$i==45 || $i==46 || $i==95 || $i==126 ?\"%c\" : \"%%%02\"a, $i)}}' else echo -e '$1 and $2 can not empty\\n$1 ==\u003e 'x' or 'X', x ==\u003e lower, X ==\u003e toupper.\\n$2 ==\u003e Strings need to url encode' fi } ## Dingbot function dingbot(){ send_strs=\"${1}\" new_url=\"${dingbot_url}\" at_who='' for i in ${atMobiles[*]} do if [ -n \"${at_who}\" ];then at_who=\"${at_who},\\\"${i}\\\"\" else at_who=\"\\\"${i}\\\"\" fi done if [ \"${ding_secret_type}\" == 'keywords' ];then curl -s -X POST -H 'Content-Type: application/json' \"${new_url}\" \\ -d \"{\\\"at\\\":{\\\"atMobiles\\\":[${at_who}]},\\\"msgtype\\\":\\\"text\\\",\\\"text\\\":{\\\"content\\\":\\\"${send_strs}\\\"}}\" elif [ \"${ding_secret_type}\" == 'sign' ];then timestamp=$(date \"+%s%3N\") dingbot_sign=$(echo -ne \"${timestamp}\\n${dingbot_secret}\" | openssl dgst -sha256 -hmac \"${dingbot_secret}\" -binary | base64) dingbot_sign=$(url_encode 'X' \"${dingbot_sign}\") post_url=\"${dingbot_url}\u0026timestamp=${timestamp}\u0026sign=${dingbot_sign}\" curl -s -X POST -H 'Content-Type: application/json' \"${post_url}\" \\ -d \"{\\\"at\\\":{\\\"atMobiles\\\":[${at_who}]},\\\"msgtype\\\":\\\"text\\\",\\\"text\\\":{\\\"content\\\":\\\"${send_strs}\\\"}}\" else echo \"secret_type æœªçŸ¥ï¼Œè¯·æ£€æŸ¥é…ç½®\" fi } dingbot \"hello\" ","date":"2023-11-11","objectID":"/posts/2023-11-11-dingbot/:1:2","tags":["dingbot"],"title":"dingbot","uri":"/posts/2023-11-11-dingbot/"},{"categories":["DevOps"],"content":"äºŒã€pythonç‰ˆ ","date":"2023-11-11","objectID":"/posts/2023-11-11-dingbot/:2:0","tags":["dingbot"],"title":"dingbot","uri":"/posts/2023-11-11-dingbot/"},{"categories":["DevOps"],"content":"1ã€åŸºäºå…³é”®å­—æˆ–è€… ip #!/usr/bin/python3 # encoding: utf-8 import requests import json def dingmsg(): #é’‰é’‰æœºå™¨äººçš„url ding_url = 'https://oapi.dingtalk.com/robot/send?access_token=' #é’‰é’‰æœºå™¨äººçš„token token = 'ba9b7c169caebb1048a66845fa8344348b3e8fdaefxxxxxxxxxxx' #è¯·æ±‚çš„urlï¼Œwebhookçš„åœ°å€ webhook = ding_url+token #æ„å»ºè¯·æ±‚çš„å¤´éƒ¨ header = { \"Content-Type\": \"application/json\", \"Charset\": \"UTF-8\" } #æ„å»ºè¯·æ±‚æ•°æ® text = \"this is first python to test dingding\" msg = { \"msgtype\": \"text\", \"text\": { \"content\": text, } } #å¯¹è¯·æ±‚çš„æ•°æ®è¿›è¡Œå°è£… msg_json = json.dumps(msg) #å‘èµ·è¯·æ±‚ info = requests.post(url=webhook,data=msg_json,headers=header) #æ‰“å°è¿”å›çš„ç»“æœ print(info.text) if __name__ == \"__main__\": dingmsg() ","date":"2023-11-11","objectID":"/posts/2023-11-11-dingbot/:2:1","tags":["dingbot"],"title":"dingbot","uri":"/posts/2023-11-11-dingbot/"},{"categories":["DevOps"],"content":"2ã€åŸºäºåŠ ç­¾è®¡ç®— #!/usr/bin/python3 # encoding: utf-8 import requests import json import time import hmac import hashlib import base64 import urllib.parse class dingRobot: def __init__(self): self.dingUrl = 'https://oapi.dingtalk.com/robot/send?access_token=' self.__secret = 'SECc95942d1139feaefcdef6abf33e6497eb3d0120b4ca3dxxxxxxxxxx' self.__token = 'ba9b7c169caebb1048a66845fa8344348b3e8fdaef264e6exxxxxxxxxxxdc' self.__sign = '' self.__timestamp = '' def createTimestampSign(self): self.__timestamp = str(round(time.time() * 1000)) secret_enc = self.__secret.encode('utf-8') string_to_sign = '{}\\n{}'.format(self.__timestamp, self.__secret) string_to_sign_enc = string_to_sign.encode('utf-8') hmac_code = hmac.new(secret_enc, string_to_sign_enc, digestmod=hashlib.sha256).digest() self.__sign = urllib.parse.quote_plus(base64.b64encode(hmac_code)) def sendMsg(self,text): self.createTimestampSign() # è¯·æ±‚çš„urlï¼Œwebhookçš„åœ°å€ webhook = self.dingUrl + self.__token + '\u0026timestamp=' + self.__timestamp + '\u0026sign=' + self.__sign # æ„å»ºè¯·æ±‚çš„å¤´éƒ¨ header = { \"Content-Type\": \"application/json\", \"Charset\": \"UTF-8\" } # æ„å»ºè¯·æ±‚æ•°æ® # text = \"this is first python to test dingding\" msg = { \"msgtype\": \"text\", \"text\": { \"content\": text, } } # å¯¹è¯·æ±‚çš„æ•°æ®è¿›è¡Œå°è£… msg_json = json.dumps(msg) # å‘èµ·è¯·æ±‚ info = requests.post(url=webhook, data=msg_json, headers=header) return info if __name__ == \"__main__\": robot = dingRobot() result = robot.sendMsg('åªæ˜¯ç”¨äºæµ‹è¯•') if json.loads(result.text)['errcode'] == 0: print(\"å‘é€æ¶ˆæ¯æˆåŠŸ\") else: print(\"å‘é€æ¶ˆæ¯å¤±è´¥\") ","date":"2023-11-11","objectID":"/posts/2023-11-11-dingbot/:2:2","tags":["dingbot"],"title":"dingbot","uri":"/posts/2023-11-11-dingbot/"},{"categories":["linux åŸºç¡€"],"content":"æœåŠ¡å™¨ä¸­æœ‰å…³å¸¸ç”¨ç«¯å£çš„ä¿¡æ¯åœ¨/etc/servicesæ–‡ä»¶ä¸­è®°å½• [root@localhost ~]# vim /etc/services åè®® ç«¯å£ è¯´æ˜ FTP 21 FTPæœåŠ¡ä¸Šä¼ å’Œä¸‹è½½æ–‡ä»¶ã€‚ SSH 22 è¿œç¨‹è¿æ¥Linuxå¼¹æ€§äº‘æœåŠ¡å™¨æˆ–è€…SFTPã€‚ Telnet 23 ä½¿ç”¨Telnetåè®®è®¿é—®ç½‘ç«™ã€‚ HTTP 80 ä½¿ç”¨HTTPåè®®è®¿é—®ç½‘ç«™ã€‚ POP3 110 ä½¿ç”¨POP3åè®®æ¥å—é‚®ä»¶ã€‚ IMAP 143 ä½¿ç”¨IMAPåè®®æ¥å—é‚®ä»¶ã€‚ LDAP 389 LDAPç«¯å£ HTTPS 443 ä½¿ç”¨HTTPSåè®®è®¿é—®ç½‘ç«™ã€‚ LDAPS 636 LDAP over SSL SQL Server 1433 SQL Serverçš„TCPç«¯å£ï¼Œç”¨äºä¾›SQL Serverå¯¹å¤–æä¾›æœåŠ¡ã€‚ SQL Server 1434 SQL Serverçš„TCPç«¯å£ï¼Œç”¨äºè¿”å›SQLServerä½¿ç”¨äº†å“ªä¸ªTCP/IPç«¯å£ã€‚ Oracle 1521 Oracleé€šä¿¡ç«¯å£ï¼Œå¼¹æ€§äº‘æœåŠ¡å™¨ä¸Šéƒ¨ç½²äº†Oracle SQLéœ€è¦æ”¾è¡Œçš„ç«¯å£ã€‚ MySQL 3306 MySQLæ•°æ®åº“å¯¹å¤–æä¾›æœåŠ¡çš„ç«¯å£ã€‚ Windows Server Remote Desktop Services 3389 Windowsè¿œç¨‹æ¡Œé¢æœåŠ¡ç«¯å£ï¼Œé€šè¿‡è¿™ä¸ªç«¯å£å¯ä»¥è¿æ¥Windowså¼¹æ€§äº‘æœåŠ¡å™¨ã€‚ Postgresql 5432 Postgresqlæ•°æ®åº“å¯¹å¤–æä¾›æœåŠ¡ç«¯å£ Redis 6379 Rediså¯¹å¤–æä¾›æœåŠ¡ç«¯å£ RabbitMQ 5672/15672 5672æ˜¯rabbitmqå¯¹å¤–æä¾›æœåŠ¡ç«¯å£ï¼Œ15672æ˜¯rabbitmq managementå¯¹å¤–æä¾›æœåŠ¡ç«¯å£ ä»£ç† 8080 8080ç«¯å£å¸¸ç”¨äºWWWä»£ç†æœåŠ¡ï¼Œå®ç°ç½‘é¡µæµè§ˆï¼Œå®ç°ç½‘é¡µæµè§ˆã€‚å¦‚æœæ‚¨ä½¿ç”¨8080ç«¯å£ï¼Œè®¿é—®ç½‘ç«™æˆ–ä½¿ç”¨ä»£ç†æœåŠ¡å™¨æ—¶ï¼Œéœ€è¦åœ¨IPåœ°å€åé¢åŠ ä¸Šï¼š8080ã€‚å®‰è£…Apache TomcatæœåŠ¡åï¼Œé»˜è®¤æœåŠ¡ç«¯å£ä¸º8080ã€‚ NetBIOS 137ã€138ã€139 NetBIOSåè®®å¸¸è¢«ç”¨äºWindowsæ–‡ä»¶ã€æ‰“å°æœºå…±äº«å’ŒSambaã€‚Â·137ã€138:UDPç«¯å£ï¼Œé€šè¿‡ç½‘ä¸Šé‚»å±…ä¼ è¾“æ–‡ä»¶æ—¶ä½¿ç”¨çš„ç«¯å£ã€‚Â·139:é€šè¿‡è¿™ä¸ªç«¯å£è¿›å…¥çš„è¿æ¥è¯•å›¾è·å¾—NetBIOS/SMBæœåŠ¡ã€‚ æ— æ³•è®¿é—®å…¬æœ‰äº‘æŸäº›ç«¯å£ 1ï¼‰é—®é¢˜ç°è±¡ï¼š è®¿é—®å…¬æœ‰äº‘ç‰¹å®šç«¯å£ï¼Œåœ¨éƒ¨åˆ†åœ°åŒºéƒ¨åˆ†è¿è¥å•†æ— æ³•è®¿é—®ï¼Œè€Œå…¶å®ƒç«¯å£è®¿é—®æ­£å¸¸ã€‚ 2ï¼‰é—®é¢˜åˆ†æï¼š éƒ¨åˆ†è¿è¥å•†åˆ¤æ–­å¦‚ä¸‹è¡¨çš„ç«¯å£ä¸ºé«˜å±ç«¯å£ï¼Œé»˜è®¤è¢«å±è”½ã€‚ é«˜å±ç«¯å£ åè®® ç«¯å£ TCP 42 135 138 139 444 445 593 1025 1068 1434 3127 3128 3129 3130 UDP 135ï½139 1026 1027 1028 è§£å†³æ–¹æ¡ˆï¼š å»ºè®®æ‚¨ä¿®æ”¹æ•æ„Ÿç«¯å£ä¸ºå…¶å®ƒéé«˜å±ç«¯å£æ¥æ‰¿è½½ä¸šåŠ¡ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-port/:0:0","tags":["port"],"title":"port","uri":"/posts/2023-11-11-port/"},{"categories":["DevOps"],"content":"flatpak ","date":"2023-11-11","objectID":"/posts/2023-11-11-flatpak/:0:0","tags":["flatpak"],"title":"flatpak","uri":"/posts/2023-11-11-flatpak/"},{"categories":["DevOps"],"content":"ç®€ä»‹ Flatpak æ˜¯ä¸€ç§æ–°çš„é€šç”¨åŒ…è£…æ ¼å¼ã€‚å¯ç”¨ Flatpak å°†ä½¿æ‚¨èƒ½å¤Ÿè½»æ¾å®‰è£…è®¸å¤š Linux åº”ç”¨ç¨‹åºã€‚è¿™æ˜¯åœ¨ Ubuntu å’Œå…¶ä»– Linux å‘è¡Œç‰ˆä¸­ä½¿ç”¨ Flatpak çš„æ–¹æ³•ã€‚ åœ¨ Linux ä¸­å®‰è£…åº”ç”¨ç¨‹åºå°±åƒæ‰“å¼€è½¯ä»¶ä¸­å¿ƒã€æœç´¢å’Œå®‰è£…ä¸€æ ·ç®€å•ã€‚App Store ä¸­æ²¡æœ‰çš„åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡ DEB æˆ– RPM åŒ…å®‰è£…ã€‚å…¶ä¸­ä¸€äº›å¯é€šè¿‡ PPAï¼ˆç”¨äºåŸºäº Debian çš„å‘è¡Œç‰ˆï¼‰è·å¾—ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå¯ä»¥ä»æºä»£ç æ„å»ºã€‚ è™½ç„¶æœ‰ä¸€äº›é™åˆ¶ã€‚App Store é€šå¸¸æ²¡æœ‰æœ€æ–°ç‰ˆæœ¬çš„åº”ç”¨ç¨‹åºï¼Œå¤„ç†ä¾èµ–é¡¹å¯èƒ½å¾ˆçƒ¦äººï¼Œè€Œä¸” PPA å¯èƒ½å¹¶ä¸æ€»æ˜¯å®‰å…¨çš„ï¼è€Œä¸”ï¼Œä»æºå¤´æ„å»ºéœ€è¦ä¸€äº›ç»ˆç«¯åŠ¨æ‰‹æ“ä½œã€‚ å¯¹äºå¤šä¸ª Linux å‘è¡Œç‰ˆå’ŒåŒ…ç®¡ç†ç³»ç»Ÿï¼Œéœ€è¦ä¸€ä¸ªé€šç”¨æ‰“åŒ…ç³»ç»Ÿï¼Œå®ƒå¯ä»¥è¿è¡Œåº”ç”¨ç¨‹åºï¼Œè€Œä¸ç®¡æ‚¨ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆ Linux å‘è¡Œç‰ˆã€‚Canonical æƒ³åˆ°äº†å®ƒå¹¶åˆ›å»ºäº†Snapsã€‚è¿˜æœ‰ä¸€ä¸ªåä¸ºAppImageçš„ç‹¬ç«‹é€šç”¨è½¯ä»¶åŒ… ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­ä¸‹è½½åº”ç”¨ç¨‹åºå¹¶è¿è¡Œå®ƒï¼Œè€Œæ— éœ€å®é™…å®‰è£…åº”ç”¨ç¨‹åºã€‚ é™¤äº† Snaps å’ŒAppImageä¹‹å¤–ï¼Œè¿˜æœ‰å¦ä¸€ä¸ªåä¸ºFlatpakçš„é€šç”¨åŒ…ç³»ç»Ÿã€‚æˆ‘ä»¬å°†äº†è§£å¦‚ä½•åœ¨å¤§å¤šæ•° Linux å‘è¡Œç‰ˆä¸Šå®‰è£…å’Œä½¿ç”¨ Flatpak åŠå…¶ä¼˜åŠ¿ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-flatpak/:0:1","tags":["flatpak"],"title":"flatpak","uri":"/posts/2023-11-11-flatpak/"},{"categories":["DevOps"],"content":"ä»€ä¹ˆæ˜¯ Flatpakï¼Ÿ FlatpakåŸºæœ¬ä¸Šæ˜¯ Linux ä¸Šçš„åº”ç”¨ç¨‹åºæ¡†æ¶ã€‚ç”±äºä¸åŒçš„å‘è¡Œç‰ˆæ›´å–œæ¬¢è‡ªå·±çš„åŒ…ç®¡ç†ï¼ŒFlatpak æ—¨åœ¨æä¾›å…·æœ‰å…¶ä»–ä¼˜åŠ¿çš„è·¨å¹³å°è§£å†³æ–¹æ¡ˆã€‚å®ƒä½¿å¼€å‘äººå‘˜çš„å·¥ä½œæ›´åŠ è½»æ¾ã€‚å‡ ä¹æ‰€æœ‰ Linux å‘è¡Œç‰ˆï¼ˆæ”¯æŒ Flatpakï¼‰éƒ½å¯ä»¥ä½¿ç”¨å•ä¸ªåº”ç”¨ç¨‹åºæ„å»ºï¼Œè€Œæ— éœ€å¯¹æ†ç»‘åŒ…è¿›è¡Œä»»ä½•ä¿®æ”¹ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-flatpak/:1:0","tags":["flatpak"],"title":"flatpak","uri":"/posts/2023-11-11-flatpak/"},{"categories":["DevOps"],"content":"Flatpak çš„ä¸»è¦ä¼˜åŠ¿ é™¤äº†ä¸ºä¸åŒçš„ Linux å‘è¡Œç‰ˆæä¾›å•ä¸ªæ†ç»‘åŒ…ä¹‹å¤–ï¼ŒFlatpak è¿˜æä¾›ä¸ Linux æ¡Œé¢çš„é›†æˆï¼Œä»è€Œæ›´å®¹æ˜“æµè§ˆã€å®‰è£…å’Œä½¿ç”¨ Flatpak åº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚ Gnome è½¯ä»¶ä¸­å¿ƒå¯ç”¨äºå®‰è£… Flatpakã€‚ Flatpak æ˜¯å‘å‰å…¼å®¹çš„ï¼Œå³ç›¸åŒçš„ Flatpak åº”ç”¨ç¨‹åºå¯ä»¥åœ¨å‘è¡Œç‰ˆçš„ä¸‹ä¸€ä¸ªç‰ˆæœ¬ä¸Šè¿è¡Œè€Œæ— éœ€æ›´æ”¹ã€‚ ç»´æŠ¤å¯ä»¥ç”±åº”ç”¨ç¨‹åºä½¿ç”¨çš„è¿è¡Œæ—¶ä¾èµ–é¡¹ã€‚ç¼ºå°‘çš„å¯ä»¥ä½œä¸ºåº”ç”¨ç¨‹åºçš„ä¸€éƒ¨åˆ†æ·»åŠ ã€‚ è™½ç„¶ Flatpak æä¾›äº†åº”ç”¨åˆ†å‘çš„ä¸­å¿ƒåŒ–æœåŠ¡ï¼Œä½†å®ƒå®Œå…¨æ”¯æŒåº”ç”¨çš„å»ä¸­å¿ƒåŒ–åˆ†å‘ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-flatpak/:1:1","tags":["flatpak"],"title":"flatpak","uri":"/posts/2023-11-11-flatpak/"},{"categories":["DevOps"],"content":"ä½¿ç”¨ # æŸ¥çœ‹å½“å‰çš„remote [root@sugar ~]# flatpak remotes # æœ€æ–¹ä¾¿çš„æ–¹å¼æ·»åŠ è¿œç¨‹ä»“åº“æ˜¯ä½¿ç”¨ .flatpakrepo æ–‡ä»¶ï¼Œå®ƒåŒ…å«è¿œç¨‹ä»“åº“çš„ä¿¡æ¯å’ŒGPGç§˜é’¥ï¼š [root@sugar ~]# flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo # ç§»é™¤è¿œç¨‹ä»“åº“ [root@sugar ~]# flatpak remote-delete flathub # æŸ¥è¯¢è½¯ä»¶ flatpak search gimp # å®‰è£…è½¯ä»¶ flatpak install flathub org.gimp.GIMP ä½¿ç”¨å›½å†…é•œåƒ $ flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo $ flatpak remote-modify flathub --url=https://mirror.sjtu.edu.cn/flathub # æˆ–è€… $ flatpak remote-add --if-not-exists sjtu https://mirror.sjtu.edu.cn/flathub/flathub.flatpakrepo # å¦‚æœæ‚¨ä¸­æ–­äº†æŸæ¬¡å®‰è£…ï¼Œé‡æ–°ä¸‹è½½å¯èƒ½ä¼šå‡ºç°æ‰¾ä¸åˆ°æ–‡ä»¶çš„é—®é¢˜ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ flatpak repair è§£å†³ç›¸å…³çš„é—®é¢˜ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-flatpak/:1:2","tags":["flatpak"],"title":"flatpak","uri":"/posts/2023-11-11-flatpak/"},{"categories":["DevOps"],"content":"Daemon å®ˆæŠ¤è¿›ç¨‹æœåŠ¡ systemd supervisor launchd ","date":"2023-11-11","objectID":"/posts/2023-11-11-daemon/:0:0","tags":["daemon","systemd","supervisor","launchd"],"title":"daemon","uri":"/posts/2023-11-11-daemon/"},{"categories":["DevOps"],"content":"ä¸€ã€supervisor â€‹ æ˜¯ç”¨Pythonå¼€å‘çš„ä¸€å¥—é€šç”¨çš„è¿›ç¨‹ç®¡ç†ç¨‹åºï¼Œèƒ½å°†ä¸€ä¸ªæ™®é€šçš„å‘½ä»¤è¡Œè¿›ç¨‹å˜ä¸ºåå°daemonï¼Œå¹¶ç›‘æ§è¿›ç¨‹çŠ¶æ€ï¼Œå¼‚å¸¸é€€å‡ºæ—¶èƒ½è‡ªåŠ¨é‡å¯ã€‚å®ƒæ˜¯é€šè¿‡fork/execçš„æ–¹å¼æŠŠè¿™äº›è¢«ç®¡ç†çš„è¿›ç¨‹å½“ä½œsupervisorçš„å­è¿›ç¨‹æ¥å¯åŠ¨ï¼Œè¿™æ ·åªè¦åœ¨supervisorçš„é…ç½®æ–‡ä»¶ä¸­ï¼ŒæŠŠè¦ç®¡ç†çš„è¿›ç¨‹çš„å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„å†™è¿›å»å³å¯ã€‚ä¹Ÿå®ç°å½“å­è¿›ç¨‹æŒ‚æ‰çš„æ—¶å€™ï¼Œçˆ¶è¿›ç¨‹å¯ä»¥å‡†ç¡®è·å–å­è¿›ç¨‹æŒ‚æ‰çš„ä¿¡æ¯çš„ï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦è‡ªå·±å¯åŠ¨å’ŒæŠ¥è­¦ã€‚supervisorè¿˜æä¾›äº†ä¸€ä¸ªåŠŸèƒ½ï¼Œå¯ä»¥ä¸ºsupervisordæˆ–è€…æ¯ä¸ªå­è¿›ç¨‹ï¼Œè®¾ç½®ä¸€ä¸ªérootçš„userï¼Œè¿™ä¸ªuserå°±å¯ä»¥ç®¡ç†å®ƒå¯¹åº”çš„è¿›ç¨‹ supervisorå®˜ç½‘ï¼šsupervisord.org ","date":"2023-11-11","objectID":"/posts/2023-11-11-daemon/:1:0","tags":["daemon","systemd","supervisor","launchd"],"title":"daemon","uri":"/posts/2023-11-11-daemon/"},{"categories":["DevOps"],"content":"å®‰è£…supervisor supervisoræ˜¯ç”¨pythonå¼€å‘çš„ï¼Œæ”¯æŒyumå’Œpipå®‰è£… [root@localhost ~]# yum install supervisor [root@localhost ~]# pip3 install supervisor ","date":"2023-11-11","objectID":"/posts/2023-11-11-daemon/:1:1","tags":["daemon","systemd","supervisor","launchd"],"title":"daemon","uri":"/posts/2023-11-11-daemon/"},{"categories":["DevOps"],"content":"é…ç½®æ–‡ä»¶ è‹¥æ²¡æœ‰é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥ç”Ÿæˆä¸»é…ç½®æ–‡ä»¶æ¨¡æ¿ [root@localhost ~]# echo_supervisord_conf \u003e /etc/supervisord.conf # å‚è€ƒé“¾æ¥ http://supervisord.org/configuration.html é…ç½®æ¨¡æ¿ # å‚æ•°å¯ä»¥æ ¹æ®éœ€æ±‚è¿›è¡Œè°ƒæ•´ [program:pock] directory=/home/sugars/pock/backend command=/home/sugars/pock/pock_venv/bin/python3 /home/sugars/pock/backend/sugars.py autostart=true autorestart=true startsecs=7 user = sugars stderr_logfile=/var/log/supervisor/pock-err.log stdout_logfile=/var/log/supervisor/pock.log redirect_stderr = true stdout_logfile_maxbytes = 50MB stdout_logfile_backups = 3 stopasgroup=true killasgroup=true é…ç½®æ–‡ä»¶è¯»å–ç›®å½•äºé¡ºåº # é…ç½®æ–‡ä»¶æ˜åä¸ºsupervisor.comf,å¦‚æœä¸ä½¿ç”¨`-c` æŒ‡å®šæ–‡ä»¶åï¼Œåˆ™è‡ªåŠ¨åŒ¹é…çš„æ–‡ä»¶è·¯å¾„ä¸º 1) ../etc/supervisord.conf 2) ../supervisord.conf 3) $CWD/supervisord.conf 4) $CWD/etc/supervisord.conf 5) /etc/supervisord.conf 6) /etc/supervisor/supervisord.conf systemctl start supervisord ","date":"2023-11-11","objectID":"/posts/2023-11-11-daemon/:1:2","tags":["daemon","systemd","supervisor","launchd"],"title":"daemon","uri":"/posts/2023-11-11-daemon/"},{"categories":["DevOps"],"content":"supervisorå‘½ä»¤è¯´æ˜ supervisorctl status æŸ¥çœ‹è¿›ç¨‹è¿è¡ŒçŠ¶æ€ supervisorctl start g_name å¯åŠ¨è¿›ç¨‹ supervisorctl stop g_name å…³é—­è¿›ç¨‹ supervisorctl restart g_name é‡å¯è¿›ç¨‹ supervisorctl update é‡æ–°è½½å…¥é…ç½®æ–‡ä»¶(é…ç½®æ–‡ä»¶ä¿®æ”¹åä½¿ç”¨è¯¥å‘½ä»¤åŠ è½½æ–°çš„é…ç½®) supervisorctl shutdown å…³é—­ supervisord supervisorctl clear g_name æ¸…ç©ºè¿›ç¨‹æ—¥å¿— supervisorctl è¿›å…¥åˆ°äº¤äº’æ¨¡å¼ä¸‹ã€‚ä½¿ç”¨helpæŸ¥çœ‹æ‰€æœ‰å‘½ä»¤ã€‚ supervisorctl start/stop/restart + all è¡¨ç¤ºå¯åŠ¨ï¼Œå…³é—­ï¼Œé‡å¯æ‰€æœ‰è¿›ç¨‹ supervisorctl reload //é‡æ–°å¯åŠ¨é…ç½®ä¸­çš„æ‰€æœ‰ç¨‹åº æ–°æ·»åŠ ä¸€ä¸ªprogramåçš„æ“ä½œ root@serialt:~# supervisorctl update sugar åœæ­¢sugaræœåŠ¡ root@serialt:~# supervisorctl stop sugar å¯åŠ¨sugaræœåŠ¡ root@serialt:~# supervisorctl start sugar é‡å¯sugaræœåŠ¡ root@serialt:~# supervisorctl restart sugar ","date":"2023-11-11","objectID":"/posts/2023-11-11-daemon/:1:3","tags":["daemon","systemd","supervisor","launchd"],"title":"daemon","uri":"/posts/2023-11-11-daemon/"},{"categories":["DevOps"],"content":"æ—¥å¿—ç®¡ç† åœ¨rhelä¸­ï¼Œsupervisordçš„æ—¥å¿—è½®è½¬ç®¡ç†æ˜¯é€šè¿‡è°ƒç”¨logrotateæ¥å®ç°çš„ï¼Œå…¶é…ç½®æ–‡ä»¶å†…å®¹æ˜¯ [root@serialt ~]# cat /etc/logrotate.d/supervisor /var/log/supervisor/*.log { missingok weekly notifempty nocompress } ä¼šè‡ªåŠ¨è½®è½¬/var/log/supervisor/*.logçš„æ–‡ä»¶ï¼Œè‹¥æŠŠç”¨supervisorç®¡ç†çš„æ—¥å¿—ä¹Ÿè¾“å…¥åˆ°/var/log/supervisor/é‡Œä¼šå¯¼è‡´æ—¥å¿—æ–‡ä»¶è¢«è½®è½¬æˆå¸¦æ—¶é—´æˆ³çš„æ ¼å¼ sugar.log sugar.log-20211019 sugar.log-20211026 sugar.log.1 sugar.log.2 sugar.log.3 ä¸¤ç§è§£å†³åŠæ³•ï¼š 1ï¼‰ä¿®æ”¹supervisordçš„æ—¥å¿—è®°å½•æ–‡ä»¶ï¼ŒåŒæ—¶ä¿®æ”¹supervisordçš„logrotateé…ç½®æ–‡ä»¶ 2ï¼‰supervisordç®¡ç†çš„è¿›ç¨‹çš„æ—¥å¿—ä¸è¾“å‡ºåˆ°/var/log/supervisoré‡Œ æ—¥å¿—å‹ç¼© supervisordæœ¬èº«æ—¥å¿—åªèƒ½è½®è½¬ï¼Œä¸èƒ½ç”¨äºå‹ç¼©ï¼Œè¦å®ç°æ—¥å¿—å‹ç¼©è®ºè¯ï¼Œéœ€è¦å€Ÿç”¨logrotate [root@tc ~]# cat /etc/logrotate.d/sugar /var/log/sugar/*.log { missingok daily notifempty create 0664 nobody root #dateext #dateformat .%Y%m%d rotate 20 compress delaycompress copytruncate size 10K } ","date":"2023-11-11","objectID":"/posts/2023-11-11-daemon/:1:4","tags":["daemon","systemd","supervisor","launchd"],"title":"daemon","uri":"/posts/2023-11-11-daemon/"},{"categories":["DevOps"],"content":"äºŒã€systemd å¸¸ç”¨å‘½ä»¤ systemctl restart foo systemctl stop foo systemctl start foo systemctl status foo systemctl cat foo systemctl daemon-reload é…ç½®æ¨¡æ¿ [Unit] Description=Gins After=network-online.target Documentation=https://serialt.github.io/ Documentation=https://serialt.github.io on-failure always [Service] Type=simple WorkingDirectory=/usr/local/gin KillSignal=SIGTERM ExecStart=/usr/local/gins/bin/gins start ExecStop=/bin/kill -SIGTERM $MAINPID Restart=on-failure RestartSec=3 TimeoutSec=50 User=gins Group=gins [Install] WantedBy=multi-user.target systemd 236ä¹‹åçš„ç‰ˆæœ¬å¯ä»¥ç›´æ¥åœ¨systemdçš„unitæ–‡ä»¶é‡Œé¢é…ç½®StandardOutputå’ŒStandardErrorä¸¤ä¸ªå‚æ•°æ¥å°†ç›¸å…³è¿è¡Œæ—¥å¿—è¾“å‡ºåˆ°æŒ‡å®šçš„æ–‡ä»¶ä¸­ã€‚ [Unit] Description=Gins After=network.target Documentation=https://serialt.github.io/ Documentation=https://serialt.github.io on-failure always [Service] Type=simple WorkingDirectory=/usr/local/gin KillSignal=SIGTERM ExecStart=/usr/local/gins/bin/gins start ExecStop=/bin/kill -SIGTERM $MAINPID # appendç±»å‹å¯ä»¥åœ¨åŸæœ‰æ–‡ä»¶æœ«å°¾ç»§ç»­è¿½åŠ å†…å®¹ï¼Œè€Œfileç±»å‹åˆ™æ˜¯é‡æ–°æ‰“å¼€ä¸€ä¸ªæ–°æ–‡ä»¶ # ä¸¤è€…çš„åŒºåˆ«ç±»ä¼¼äº echo \u003e\u003e å’Œ echo \u003e StandardOutput=append:/home/coredns/logs/coredns.log StandardError=append:/home/coredns/logs/coredns_error.log Restart=on-failure RestartSec=3 TimeoutSec=50 User=gins Group=gins [Install] WantedBy=multi-user.target ","date":"2023-11-11","objectID":"/posts/2023-11-11-daemon/:2:0","tags":["daemon","systemd","supervisor","launchd"],"title":"daemon","uri":"/posts/2023-11-11-daemon/"},{"categories":["DevOps"],"content":"ä¸‰ã€launchdæœåŠ¡ https://www.fythonfang.com/blog/2021/4/19/mac-launchd-daemons-and-agents-tutorial ","date":"2023-11-11","objectID":"/posts/2023-11-11-daemon/:3:0","tags":["daemon","systemd","supervisor","launchd"],"title":"daemon","uri":"/posts/2023-11-11-daemon/"},{"categories":["DevOps"],"content":"åŸºæœ¬æ¦‚å¿µ launchd æ˜¯ MacOS ä¸Šç”¨äºç®¡ç†ç³»ç»Ÿçº§æˆ–è€…ç”¨æˆ·çº§åå°æœåŠ¡è¿›ç¨‹çš„ç®¡ç†å·¥å…·ã€‚ä¹Ÿæ˜¯å®˜æ–¹æ¨èçš„ç³»ç»Ÿåå°è¿›ç¨‹ç®¡ç†å·¥å…·ï¼Œå°±å¥½åƒåœ¨ Linux ç³»ç»Ÿé‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ systemd å»ç®¡ç†åå°æœåŠ¡è¿›ç¨‹ä¸€æ ·ã€‚ launchd æ˜¯ä¸€ä¸ªç¨‹åºï¼Œä»¥ç³»ç»Ÿå¸¸é©»è¿›ç¨‹çš„å½¢æ€è¿è½¬ï¼Œæ˜¯ MacOS ç³»ç»Ÿå¯åŠ¨åçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œåœ¨ Terminal ç»ˆç«¯ï¼Œé”®å…¥å‘½ä»¤ ps aux å¯ä»¥çœ‹åˆ°ï¼Œlaunchd çš„è¿›ç¨‹IDï¼ˆPIDï¼‰æ˜¯ 1ã€‚ä¹Ÿå³è¿™æ˜¯ç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ã€‚ ä¸ launchd äº¤äº’çš„å·¥å…·ï¼Œå« launchctlã€‚å¯ä»¥è®¤ä¸ºæ˜¯å®ƒçš„ç®¡ç†å®¢æˆ·ç«¯ç¨‹åºã€‚é€šè¿‡è¯¥å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥å‘é€æŒ‡ä»¤ç»™ launchd å®Œæˆå¯¹ç³»ç»ŸæœåŠ¡æˆ–åå°è¿›ç¨‹çš„ç®¡ç†ã€‚ launchd çš„ç®¡ç†å¯¹è±¡éƒ½æ˜¯åå°è¿›ç¨‹ï¼Œè¿™äº›åå°è¿›ç¨‹ä½¿ç”¨ä¸€ç§ç‰¹å®šæ ¼å¼çš„é…ç½®æ–‡ä»¶å« launchd.plist æ¥æè¿°è¢«ç®¡ç†çš„å¯¹è±¡ã€‚è¿™ç§æ–‡ä»¶æ˜¯ XML æ ¼å¼çš„ï¼Œæ ¹æ®ä¸åŒçš„è¿è¡Œæƒé™ï¼Œæ”¾åœ¨ä¸åŒçš„ç›®å½•é‡Œé¢ï¼Œè¯·çœ‹ä¸‹é¢çš„è¡¨æ ¼ã€‚ ç›®å½• è¯´æ˜ ~/Library/LaunchAgents ç”¨æˆ·è‡ªå·±æä¾›çš„ç”¨æˆ·çº§ Agentã€‚ /Library/LaunchAgents ç®¡ç†å‘˜æä¾›çš„ç”¨æˆ·çº§ Agentã€‚ /Library/LaunchDaemons ç®¡ç†å‘˜æä¾›çš„ç³»ç»Ÿçº§ Daemonã€‚ /System/Library/LaunchAgents è‹¹æœå®˜æ–¹æä¾›çš„ç”¨æˆ·çº§ Agentã€‚ /System/Library/LaunchDaemons è‹¹æœå®˜æ–¹æä¾›çš„ç³»ç»Ÿçº§ Daemonã€‚ å­˜æ”¾ launchd é…ç½®æ–‡ä»¶çš„å¸¸ç”¨ç›®å½• é€šè¿‡ launchd ç®¡ç†çš„è¿›ç¨‹ï¼Œäººä¸ºè¢«åˆ†ä¸ºäº†å‡ ä¸ªç§ç±»ï¼š æœåŠ¡ï¼ˆServicesï¼‰â€”â€” åœ¨åå°è¿è¡Œï¼Œç”¨ä»¥æ”¯æŒå›¾å½¢ç•Œé¢åº”ç”¨ï¼ˆGUI Appï¼‰è¿è¡Œçš„æœåŠ¡è¿›ç¨‹ï¼Œæ¯”å¦‚å“åº”ç³»ç»Ÿå…¨å±€å¿«æ·é”®ï¼Œæˆ–è€…è¿›è¡Œç½‘ç»œé€šä¿¡ç­‰ï¼› å®ˆæŠ¤è¿›ç¨‹ï¼ˆDaemonsï¼‰â€”â€” ç†è®ºä¸Šï¼Œä¸å±äºæœåŠ¡çš„åå°è¿›ç¨‹ï¼Œéƒ½å½’ä¸ºå®ˆæŠ¤è¿›ç¨‹ä¸€ç±»ï¼Œä¸è¿‡è¿™é‡Œç‰¹æŒ‡è¿è¡Œåœ¨åå°ï¼Œä¸”ä¸èƒ½ä¸ç”¨æˆ·äº¤äº’å›¾å½¢ç•Œé¢äº§ç”Ÿè”ç³»çš„è¿›ç¨‹ï¼› ä»£ç†ï¼ˆAgentsï¼‰â€”â€” ä»¥ç”¨æˆ·çš„åä¹‰ï¼Œåœ¨åå°è¿è¡Œçš„è¿›ç¨‹ï¼Œå¯ä»¥å’Œç”¨æˆ·å›¾å½¢ç•Œé¢äº§ç”Ÿè”ç³»ï¼Œæ¯”å¦‚å‘¼èµ·ä¸€ä¸ªè½¯ä»¶çš„ç•Œé¢ï¼Œä¸è¿‡å®˜æ–¹ä¸æ¨èè¿™ä¹ˆç”¨ã€‚ ä¸€èˆ¬æ–‡ä»¶åéƒ½ä»¥com.domain.programName.plistæ ¼å¼å‘½åï¼Œä¸ç®¡æ˜¯ Daemons è¿˜æ˜¯ Agents æ ¼å¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å­˜æ”¾ä½ç½®ä¸åŒã€‚çœ‹ä¸‹é¢ä¸€ä¸ª hello world çš„ä¾‹å­ ~/Library/LaunchAgents/com.example.hello.plist \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e \u003cplist version=\"1.0\"\u003e \u003cdict\u003e \u003ckey\u003eLabel\u003c/key\u003e \u003cstring\u003ecom.example.hello\u003c/string\u003e \u003ckey\u003eProgramArguments\u003c/key\u003e \u003carray\u003e \u003cstring\u003e/bin/echo\u003c/string\u003e \u003cstring\u003ehello world\u003c/string\u003e \u003c/array\u003e \u003c/dict\u003e \u003c/plist\u003e ä¸Šé¢å®šä¹‰äº†ä¸€ä¸ªæœ€ç®€å•çš„ä»»åŠ¡åªä½¿ç”¨äº†Labelå’ŒProgramAgrumentsä¸¤ä¸ªé”® Labelè¿™æ˜¯ä¸ªå¿…é¡»çš„é”®ï¼ŒæŒ‡å®šè¿™ä¸ªä»»åŠ¡å ProgramArgumentsæ˜¯å¸¦å‚æ•°çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸Šé¢ç­‰åŒäºè¿è¡Œ/bin/echo hello worldå‘½ä»¤ï¼Œå¦‚æœæ‰§è¡Œçš„ç¨‹åºä¸å¸¦å‚æ•°å¯ä»¥ä½¿ç”¨Programé”®ï¼Œä½†ä¸€ä¸ªä»»åŠ¡ä¸­å¿…é¡»åŒ…å«è¿™ä¸¤ä¸ªä¸­çš„å…¶ä¸­ä¸€ä¸ªé”® è¿˜æœ‰ä¸€äº›å¸¸ç”¨çš„é”®åï¼Œæ‰€æœ‰çš„é”®å¯å‚è€ƒman 5 launchd.plistæˆ–è€…è¿™é‡Œ Keys Description EnvironmentVariables è®¾ç½®è¿è¡Œç¯å¢ƒå˜é‡ StandardOutPath æ ‡å‡†è¾“å‡ºåˆ°æ–‡ä»¶ StandardErrorPath æ ‡å‡†é”™è¯¯åˆ°æ–‡ä»¶ RunAtLoad æ˜¯å¦å†åŠ è½½çš„æ—¶å€™å°±è¿è¡Œ StartInterval è®¾ç½®ç¨‹åºæ¯éš”å¤šå°‘ç§’è¿è¡Œä¸€æ¬¡ KeepAlive æ˜¯å¦è®¾ç½®ç¨‹åºæ˜¯ä¸€ç›´å­˜æ´»ç€ å¦‚æœé€€å‡ºå°±é‡å¯ UserName è®¾ç½®ç”¨æˆ·ååªåœ¨ Daemons å¯ç”¨ WorkingDirectory è®¾ç½®å·¥ä½œç›®å½• # æ£€æŸ¥é…ç½® $ plutil ~/Library/LaunchAgents/com.example.hello.plist /Users/fython/Library/LaunchAgents/com.example.hello.plist: OK # åŠ è½½é…ç½®æ–‡ä»¶ $ launchctl load ~/Library/LaunchAgents/com.example.hello.plist # å¯åŠ¨æœåŠ¡ $ launchctl start com.example.hello $ cat /tmp/hello.log hello world $ launchctl list | grep hello - 0 com.example.hello $ launchctl remove com.example.hello # remove jobs ä¸€ä¸ªä»»åŠ¡é¦–å…ˆéœ€è¦è¢«åŠ è½½(load)ï¼Œç„¶åå¯åŠ¨(start)æ­£å¸¸è¿è¡Œå®Œé€€å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬æŸ¥çœ‹/tmpç›®å½•ä¸‹ä¼šæœ‰æ—¥å¿—è¾“å‡º â€‹ 1ï¼‰ä»»åŠ¡ä¸€èˆ¬éƒ½è¦æ‰‹åŠ¨å¯åŠ¨(start)ï¼Œå¦‚æœè®¾ç½®äº†RunAtLoadæˆ–è€…KeepAliveåˆ™åœ¨launchctl loadæ—¶å°±å¯åŠ¨ â€‹ 2ï¼‰ä½¿ç”¨launchctl liståˆ—å‡ºå½“å‰åŠ è½½çš„ä»»åŠ¡ï¼Œç¬¬ä¸€åˆ—ä»£è¡¨è¿›ç¨‹idï¼Œå› ä¸ºä¸Šé¢çš„ç¨‹åºè¿è¡Œä¸€æ¬¡å°±é€€å‡ºäº†æ‰€ä»¥æ˜¾ç¤º-ï¼Œç¬¬äºŒåˆ—æ˜¯ç¨‹åºä¸Šæ¬¡è¿è¡Œé€€å‡ºçš„codeï¼Œ0ä»£è¡¨æ­£å¸¸é€€å‡ºï¼Œå¦‚æœæ˜¯æ­£æ•°ä»£è¡¨é€€å‡ºçš„æ—¶å€™æ˜¯æœ‰é”™è¯¯çš„ï¼Œè´Ÿæ•°ä»£è¡¨æ˜¯æ¥æ”¶åˆ°ä¿¡å·è¢«ç»ˆæ­¢çš„ â€‹ 3ï¼‰launchctl stop \u003cservice_name\u003eå¯ä»¥ç»ˆæ­¢ä¸€ä¸ªåœ¨è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œlaunchctl unload \u003cpath\u003eæŒ‡å®šè·¯å¾„å¸è½½ä¸€ä¸ªä»»åŠ¡ï¼Œlaunchctl remove \u003cservice_name\u003eé€šè¿‡æœåŠ¡åå¸è½½ä»»åŠ¡ â€‹ 4ï¼‰launchctl load \u003cpath\u003eåªä¼šåŠ è½½æ²¡æœ‰è¢«disableçš„ä»»åŠ¡ï¼Œå¯ä»¥åŠ -wå‚æ•° launchctl load -w \u003cpath\u003eè¦†ç›–å¦‚æœè®¾ç½®äº†disableçš„ï¼Œä¸‹æ¬¡å¼€æœºå¯åŠ¨ä¸€å®šä¼šèµ·æ¥ã€‚launchctl unload \u003cpath\u003eåªä¼šåœæ­¢å’Œå¸è½½è¿™ä¸ªä»»åŠ¡ï¼Œä½†ä¸‹æ¬¡å¯åŠ¨è¿˜ä¼šåŠ è½½ï¼Œå¯ä»¥ä½¿ç”¨-wå‚æ•°launchctl unload -w \u003cpath\u003eåœæ­¢ä»»åŠ¡ï¼Œä¸‹æ¬¡å¯åŠ¨ä¹Ÿä¸ä¼šèµ·æ¥ï¼Œä¹Ÿå°±æ˜¯æ ‡è®°äº†disable â€‹ 5ï¼‰è°ƒè¯•ä¸€ä¸ªä»»åŠ¡å¯ä»¥é…åˆä½¿ç”¨plutilå‘½ä»¤æ£€æŸ¥è¯­æ³•ï¼Œè®¾ç½®StandardOutPathã€StandardErrorPathã€Debugé”®ï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹è‹¹æœè‡ªå¸¦çš„Console.appåº”ç”¨ä¸­çš„system.log ","date":"2023-11-11","objectID":"/posts/2023-11-11-daemon/:3:1","tags":["daemon","systemd","supervisor","launchd"],"title":"daemon","uri":"/posts/2023-11-11-daemon/"},{"categories":["DevOps"],"content":"åŸºæœ¬æ“ä½œ # ç½—åˆ—ç³»ç»Ÿå½“å‰è¿è¡Œçš„è¿›ç¨‹æ¸…å• launchctl list # æŸ¥çœ‹ç‰¹å®šæœåŠ¡çš„é…ç½®ä¿¡æ¯ launchctl list com.adobe.AdobeCreativeCloud # åŠ è½½ç‰¹å®šçš„æœåŠ¡é…ç½® launchctl load \u003cfile_path\u003e # å¸è½½ç‰¹å®šçš„æœåŠ¡é…ç½® launchctl unload -w /Library/LaunchAgents/com.adobe.AdobeCreativeCloud.plist # ç‰¹æ­¤è¯´æ˜ï¼Œ-w å‚æ•°çš„ä½œç”¨æ˜¯ï¼Œå¦‚æœè‡ªåŠ¨æ‰§è¡Œäº† load å‘½ä»¤å°è¯•å»æ¢å¤æœåŠ¡æ³¨å†Œï¼Œåˆ™è®©å…¶æ— æ•ˆ plist æ–‡ä»¶é…ç½® www.launchd.info ","date":"2023-11-11","objectID":"/posts/2023-11-11-daemon/:3:2","tags":["daemon","systemd","supervisor","launchd"],"title":"daemon","uri":"/posts/2023-11-11-daemon/"},{"categories":["DevOps"],"content":"é…ç½®å‚æ•° 1ï¼‰é…ç½®jobå \u003ckey\u003eLabel\u003c/key\u003e \u003cstring\u003ecom.local.cmd\u003c/string\u003e 2ï¼‰cmdå¯åŠ¨é…ç½® \u003ckey\u003eProgramArguments\u003c/key\u003e \u003carray\u003e \u003cstring\u003e/usr/bin/rsync\u003c/string\u003e \u003cstring\u003e--archive\u003c/string\u003e \u003cstring\u003e--compress-level=9\u003c/string\u003e \u003cstring\u003e/Volumes/Macintosh HD\u003c/string\u003e \u003cstring\u003e/Volumes/Backup\u003c/string\u003e \u003c/array\u003e æ‰§è¡Œåå‘½ä»¤ /usr/bin/rsync --archive --compress-level=9 \"/Volumes/Macintosh HD\" \"/Volumes/Backup\" 3ï¼‰ç¯å¢ƒå˜é‡è®¾ç½® \u003ckey\u003eEnvironmentVariables\u003c/key\u003e \u003cdict\u003e \u003ckey\u003ePATH\u003c/key\u003e \u003cstring\u003e/bin:/usr/bin:/usr/local/bin\u003c/string\u003e \u003c/dict\u003e 3ï¼‰è®¾ç½®å·¥ä½œç›®å½• \u003ckey\u003eWorkingDirectory\u003c/key\u003e \u003cstring\u003e/tmp\u003c/string\u003e 4ï¼‰èµ„æºé™åˆ¶ \u003ckey\u003eHardResourceLimits\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eFileSize\u003c/key\u003e \u003cinteger\u003e1048576\u003c/integer\u003e \u003c/dict\u003e \u003ckey\u003eSoftResourceLimits\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eFileSize\u003c/key\u003e \u003cinteger\u003e524288\u003c/integer\u003e \u003c/dict\u003e 5ï¼‰å…¶ä»– RunAtLoad \u003ckey\u003eRunAtLoad\u003c/key\u003e \u003ctrue/\u003e æ¯éš”å¤šå°‘ç§’æ‰§è¡Œ å•ä½ ç§’ \u003ckey\u003eStartInterval\u003c/key\u003e \u003cinteger\u003e3600\u003c/integer\u003e å®šæ—¶æ‰§è¡Œ \u003ckey\u003eStartCalendarInterval\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eHour\u003c/key\u003e \u003cinteger\u003e3\u003c/integer\u003e \u003ckey\u003eMinute\u003c/key\u003e \u003cinteger\u003e0\u003c/integer\u003e \u003c/dict\u003e å¯ç”¨å‚æ•° Month Integer Month of year (1..12, 1 being January) Day Integer Day of month (1..31) Weekday Integer Day of week (0..7, 0 and 7 being Sunday) Hour Integer Hour of day (0..23) Minute Integer Minute of hour (0..59) ç¤ºä¾‹1ï¼š /Library/LaunchDaemons/com.fython.clash.plist \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e \u003cplist version=\"1.0\"\u003e \u003cdict\u003e \u003ckey\u003eLabel\u003c/key\u003e \u003cstring\u003ecom.fython.clash\u003c/string\u003e \u003ckey\u003eRunAtLoad\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003eUserName\u003c/key\u003e \u003cstring\u003eroot\u003c/string\u003e \u003ckey\u003eStandardErrorPath\u003c/key\u003e \u003cstring\u003e/Users/fython/bin/clash/stderr.log\u003c/string\u003e \u003ckey\u003eStandardOutPath\u003c/key\u003e \u003cstring\u003e/Users/fython/bin/clash/stdout.log\u003c/string\u003e \u003ckey\u003eWorkingDirectory\u003c/key\u003e \u003cstring\u003e/Users/fython/bin/clash\u003c/string\u003e \u003ckey\u003eProgramArguments\u003c/key\u003e \u003carray\u003e \u003cstring\u003e/Users/fython/bin/clash/clash\u003c/string\u003e \u003cstring\u003e-f\u003c/string\u003e \u003cstring\u003econfig.yaml\u003c/string\u003e \u003cstring\u003e-d\u003c/string\u003e \u003cstring\u003e/Users/fython/bin/clash\u003c/string\u003e \u003c/array\u003e \u003ckey\u003eKeepAlive\u003c/key\u003e \u003ctrue/\u003e \u003c/dict\u003e \u003c/plist\u003e ","date":"2023-11-11","objectID":"/posts/2023-11-11-daemon/:3:3","tags":["daemon","systemd","supervisor","launchd"],"title":"daemon","uri":"/posts/2023-11-11-daemon/"},{"categories":["DNS"],"content":"CoreDNS åœ¨å†…ç½‘æœåŠ¡ä¸­ï¼Œéœ€è¦éƒ¨ç½²å†…éƒ¨çš„ dnsï¼Œç”¨äºå„ç§æœåŠ¡çš„ dns è§£æã€‚å¸¸è§çš„ dns server æœ‰ bindï¼Œdnsmasqï¼Œcoredns ç­‰ã€‚coredns å‡ºåäºç”¨äº kubernetes ä¸­ service åˆ° ip çš„è§£æï¼Œç”±äºæ˜¯ä½¿ç”¨ go å¼€å‘çš„ï¼Œæ„å»ºçš„äºŒè¿›åˆ¶å¾ˆå‘å¸ƒéƒ¨ç½²ä½¿ç”¨ï¼ŒåŒæ—¶ coredns ä¹Ÿå…¼å®¹ bind çš„åŸŸåè§£æé…ç½®æ–‡ä»¶ã€‚ å®˜ç½‘ï¼šhttps://coredns.io/ å‚è€ƒé“¾æ¥ï¼šhttps://blog.gmem.cc/coredns-study-note ","date":"2023-11-11","objectID":"/posts/2023-11-11-coredns/:0:0","tags":["dns","coredns"],"title":"coredns","uri":"/posts/2023-11-11-coredns/"},{"categories":["DNS"],"content":"ä¸€ã€åŸºæœ¬ä½¿ç”¨ å¸¸ç”¨æ’ä»¶ bind æŒ‡å®šæœåŠ¡å™¨ç›‘å¬çš„ç½‘ç»œæ¥å£ï¼ˆIPåœ°å€ï¼‰ï¼š bind ADDRESS â€¦ . { bind 127.0.0.1 ::1 } . { bind 127.0.0.1 bind ::1 } autopath å…è®¸æœåŠ¡å™¨ç«¯è¿›è¡Œçš„æœç´¢åç¼€ï¼ˆsearch domainï¼‰è¡¥å…¨ã€‚å¦‚æœæ’ä»¶å‘ç°å®¢æˆ·ç«¯æŸ¥è¯¢çš„åç§°ï¼ŒåŒ¹é…search pathçš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œåˆ™è‡ªåŠ¨éå†search pathä¸­çš„domainé“¾ï¼Œå¹¶è¿”å›ç¬¬ä¸€ä¸ªéNXDOMAINç»“æœã€‚å¦‚æœå‡ºç°å¤±è´¥ï¼Œåˆ™è¿”å›åŸå§‹æŸ¥è¯¢çš„åº”ç­”ã€‚ ç”±äºautopathçš„åº”ç­”ä¸­çš„åç§°ï¼Œå’ŒåŸå§‹é—®é¢˜ä¸åŒ¹é…ï¼Œå› æ­¤ä»–ä¼šåœ¨CoreDNSä¸­æ·»åŠ ä¸€ä¸ªCNAMEï¼Œä»åŸå§‹åç§°æŒ‡å‘åº”ç­”ä¸­çš„åç§°ã€‚ # ZONE autopathæƒå¨è´Ÿè´£çš„Zone # RESOLV-CONF åŒ…å«search domainçš„é…ç½®æ–‡ä»¶ã€‚æˆ–è€…æŒ‡å‘å…¶å®ƒæ’ä»¶ï¼Œä¾‹å¦‚@kubernetesï¼Œè¿™æ—¶ä»å…¶å®ƒæ’ä»¶è¯»å–search domain # é…ç½®æ–‡ä»¶ä¸­å¿…é¡»æœ‰ search domain1 domain2 ... è¿™æ ·çš„è¡Œ autopath [ZONE...] RESOLV-CONF cache å®ç°å‰ç«¯ç¼“å­˜ï¼Œç”¨äºæŸ¥è¯¢åç«¯ï¼ˆUpstreamã€Databaseâ€¦ï¼‰æˆæœ¬è¾ƒé«˜çš„åœºæ™¯ã€‚å¯ç”¨æ­¤æ’ä»¶åï¼Œé™¤äº†Zone transfers / Metadataä»¥å¤–çš„è®°å½•ä¼šè¢«ç¼“å­˜é»˜è®¤3600sã€‚ # TTL ç¼“å­˜æœ‰æ•ˆæœŸï¼Œå•ä½ç§’ï¼Œé»˜è®¤3600 # ZONES å“ªäº›Zoneæ”¯æŒç¼“å­˜ cache [TTL] [ZONES...] { # æˆåŠŸçš„DNSåº”ç­”çš„ç¼“å­˜é…ç½® success CAPACITY [TTL] [MINTTL] # Denial of existenceåº”ç­”çš„ç¼“å­˜é…ç½® denial CAPACITY [TTL] [MINTTL] prefetch AMOUNT [[DURATION] [PERCENTAGE%]] } loop èƒ½å¤Ÿæ£€æµ‹ç®€å•çš„forwardingå¾ªç¯å¹¶ç»ˆæ­¢æœåŠ¡å™¨ã€‚ debug èƒ½å¤Ÿä»Panicä¸­æ¢å¤ï¼Œç”¨äºè°ƒè¯•ç”¨é€” errors å¯ç”¨é”™è¯¯æ—¥å¿—è®°å½•ï¼Œæ ¼å¼ï¼š errors { # åœ¨DURATIONæœŸé—´æŠ“å–åŒ¹é…REGEXPçš„é”™è¯¯æ—¥å¿—ï¼Œèšåˆä¸ºå•æ¡æ—¥å¿— consolidate DURATION REGEXP } . { errors { consolidate 5m \".* i/o timeout$\" consolidate 30s \"^Failed to .+\" } } forward å°†DNSè¯·æ±‚è½¬å‘ç»™ä¸Šæ¸¸DNSæœåŠ¡å™¨ï¼Œæ”¯æŒDNS / TCP / DNS over TLSã€‚è¯¥æ’ä»¶ä»£æ›¿åŸå…ˆçš„proxyæ’ä»¶ã€‚ # FROM åŒ¹é…æ­¤åç¼€çš„DNSæŸ¥è¯¢ä¼šè¢«è½¬å‘ # TO ä¸Šæ¸¸æœåŠ¡å™¨çš„ç«¯ç‚¹ï¼Œæ”¯æŒæŒ‡å®šåè®®ï¼Œä¾‹å¦‚tls://9.9.9.9 forward FROM TO... { # ç©ºæ ¼åˆ†éš”çš„ï¼Œä¸è¿›è¡Œè½¬å‘çš„åŸŸååˆ—è¡¨ except IGNORED_NAMES... # å¼ºåˆ¶åŸºäºTCPåè®® force_tcp # ä¼˜å…ˆä½¿ç”¨UDP prefer_udp # å¤šä¹…åä¸¢å¼ƒè¿æ¥ï¼Œ expire DURATION # åˆ¤å®šä¸ºä¸å¥åº·éœ€è¦çš„è¿ç»­å¤±è´¥è¾ä¹¦ max_fails INTEGER # DNS over TLSé…ç½® tls CERT KEY CA tls_servername NAME # é€‰å–ä¸Šæ¸¸æœåŠ¡å™¨çš„ç®—æ³•ï¼Œé»˜è®¤random policy random|round_robin|sequential # å¥åº·æ£€æŸ¥å‘¨æœŸ health_check DURATION } ç›´æ¥è½¬å‘ï¼Œç”¨äºå…œåº•çš„ç¤ºä¾‹ï¼š forward . 223.5.5.5 1.1.1.1 ä½¿ç”¨TLSçš„ç¤ºä¾‹ï¼š forward . tls://9.9.9.9 { tls_servername dns.quad9.net health_check 5s } å¼ºåˆ¶TCPè½¬å‘ï¼š svc.k8s.gmem.cc { forward . 127.0.0.1:5353 { force_tcp } } ä»æ–‡ä»¶ä¸­è¯»å–ä¸Šæ¸¸DNSï¼š forward . /etc/resolv.conf å¦‚æœCoreDNSè¿è¡Œåœ¨K8Sä¸­ï¼Œåˆ™CoreDNSçš„Podçš„/etc/resolv.confå†…å®¹çš„åŸºç¡€ï¼Œå–å†³äºkubeletçš„â€“resolv-confé…ç½®ï¼Œé»˜è®¤å€¼æŒ‡å‘å®¿ä¸»æœºçš„/etc/resolv.confæ–‡ä»¶ã€‚ ä¸Šæ¸¸å¥åº·æ£€æŸ¥ é¦–æ¬¡è½¬å‘ï¼Œéšæœºé€‰å–ä¸€ä¸ªä¸Šæ¸¸æœåŠ¡å™¨ï¼Œåç»­ä¸€ç›´ä½¿ç”¨ï¼Œç›´åˆ°å®ƒä¸å¥åº·äº†ã€‚ å½“å‡ºç°ä¸€ä¸ªé”™è¯¯ â€”â€” ä»»ä½•DNSå“åº”éƒ½ä¸çœ‹ä½œé”™è¯¯ï¼ˆREFUSED, NOTIMPL, SERVFAIL â€¦ ï¼‰â€”â€” åˆ™CoreDNSå¯åŠ¨å¥åº·æ£€æŸ¥å¾ªç¯ï¼ˆé»˜è®¤0.5sä¸€æ¬¡ï¼‰ï¼Œç›´åˆ°ä¸Šæ¸¸æœåŠ¡å™¨æ¢å¤å¥åº·ã€‚ å¦‚æœmax_failsè®¾ç½®ä¸º0åˆ™ä¸è¿›è¡Œå¥åº·æ£€æŸ¥ï¼Œæ€»æ˜¯è®¤ä¸ºä¸Šæ¸¸æœåŠ¡å™¨æ˜¯å¥åº·çš„ã€‚ CoreDNSä¸å‘ä¸å¥åº·çš„ä¸Šæ¸¸æœåŠ¡å™¨è½¬å‘è¯·æ±‚ï¼Œå¦‚æœæ‰€æœ‰ä¸Šæ¸¸æœåŠ¡å™¨éƒ½ä¸å¥åº·ï¼Œåˆ™éšæœºé€‰å–ä¸€ä¸ªè½¬å‘ã€‚ health å¯ç”¨è¿›ç¨‹çº§åˆ«çš„ç›‘æ§æ£€æŸ¥ã€‚ç¤ºä¾‹ï¼š health :8080ï¼Œä½ å¯ä»¥è®¿é—®:8080/healthè·å–å¥åº·çŠ¶æ€ã€‚ ready æä¾›readinessæ¢é’ˆã€‚ç¤ºä¾‹ï¼š ready localhost:8091 hosts ä»¥/etc/hostsé£æ ¼æä¾›Zoneæ•°æ®ï¼Œæ ¼å¼ï¼š # FILE ä»æ–‡ä»¶ä¸­è¯»å–Zoneæ•°æ®ï¼Œé»˜è®¤ä»/etc/hostsè¯»å– # ZONES æ­¤æ’ä»¶çš„æƒå¨Zone hosts [FILE [ZONES...]] { # å†…è”çš„HOSTSæ¡ç›® [INLINE] # ä¿®æ”¹ç”Ÿæˆçš„DNSè®°å½•çš„DNS TTL ttl SECONDS # ç¦æ­¢è‡ªåŠ¨ç”Ÿæˆin-addr.arpaæˆ–ip6.arpaæ¡ç›® no_reverse # é‡æ–°è½½å…¥æ–‡ä»¶çš„é—´éš”ï¼Œä¾‹å¦‚ 300ms 1.5h 2h45m reload DURATION # å¯¹äºåŒ¹é…çš„ZONESï¼Œå¦‚æœæ­¤æ’ä»¶æ²¡æœ‰è®°å½•ï¼Œåˆ™ç”±ä¸‹ä¸€ä¸ªæ’ä»¶å¤„ç† fallthrough [ZONES...] } hosts { 172.21.0.1 kdc-1 fallthrough } import è¯¥æ’ä»¶æœ‰ä¸¤ä¸ªç”¨é€”ï¼š å¯¼å…¥å…¶å®ƒé…ç½®æ–‡ä»¶åˆ°ä¸»é…ç½®æ–‡ä»¶ å¯¼å…¥é…ç½®ç‰‡æ®µ æ ¼å¼ï¼š import PATTERN log è®°å½•æŸ¥è¯¢æ—¥å¿—ï¼Œæ ¼å¼ï¼š # NAMES åŒ¹é…çš„DNSæŸ¥è¯¢è¢«è®°å½• # FORMAT æ—¥å¿—æ ¼å¼ï¼Œ log [NAMES...] [FORMAT] log [NAMES...] [FORMAT] { class CLASSES... } CLASSES æŒ‡å®šå“ªäº›RCodeä¼šè¢«è®°å½• å–å€¼ è¯´æ˜ success è®°å½•æˆåŠŸçš„è¯·æ±‚ denial è®°å½•NXDOMAINçš„è¯·æ±‚ã€NOERRORä½†æ˜¯æ²¡æœ‰æ•°æ®çš„ï¼ˆnodataï¼ŒåŸŸåå­˜åœ¨ï¼Œä½†æ˜¯è¯·æ±‚çš„è®°å½•ç±»å‹æ²¡æœ‰ï¼‰ error è®°å½•SERVFAILã€NOTIMPã€REFUSEDç­‰ç­‰ï¼Œä»»ä½•æç¤ºè¿œç¨‹æœåŠ¡å™¨ä¸æ„¿æ„è§£æè¯·æ±‚çš„åº”ç­”éƒ½åŒ…å«åœ¨å†… all é»˜è®¤ï¼Œè®°å½•æ‰€æœ‰è¯·æ±‚ rewrite æ‰§è¡Œå†…éƒ¨çš„æ¶ˆæ¯é‡å†™ã€‚æ ¼å¼ # FIELD è¯·æ±‚/åº”ç­”çš„ä»€ä¹ˆå­—æ®µéœ€è¦è¢«é‡å†™ # type è¯·æ±‚çš„TYPEå­—æ®µ # class æ¶ˆæ¯çš„ç±»å‹ # name è¯·æ±‚ä¸­çš„DNSåç§° # answer name åº”ç­”ä¸­çš„DNSåç§° # ttl TTLå€¼ rewrite [continue|stop] FIELD [FROM TO|FROM TTL] è¦é‡å†™DNSè¯·æ±‚ä¸­çš„åç§°ï¼Œä½¿ç”¨æ ¼å¼ï¼š rewrite [continue|stop] name [exact|prefix|suffix|substring|regex] STRING STRING ç¤ºä¾‹ï¼š rewrite name substring k8s.gmem.cc k8s.gmem.site rewrite name regex (.*)\\.gmem\\.cc {1}.gmem.site rewrite name suffix .gmem.cc. .gmem.site. è¦é‡å†™DNSå“åº”ä¸­çš„åç§°ï¼Œå‚è€ƒï¼š rewrite stop { name regex (.*)\\.gmem\\.site {1}.gmem.site answer name (.*)\\.gmem\\.site {1}.gmem.site } template æä¾›ä¸€ä¸ªæ¨¡æ¿ï¼ŒåŸºäºè¯·æ±‚æ¥åŠ¨æ€çš„ç”Ÿæˆå“åº”ã€‚æ ¼å¼ # CLASS æŸ¥è¯¢åˆ†ç±»ï¼ŒINæˆ–ANY # TYPE æŸ¥è¯¢ç±»å‹ï¼ŒAã€PTR... ANYåŒ¹é…æ‰€æœ‰ç±»å‹ # ZONE æ­¤æ¨¡æ¿çš„Zone template CLASS TYPE [ZONE...] { # åŒ¹é…è¯·æ±‚DNSåç§°çš„æ­£åˆ™å¼ match REGEX... # DNSåº”ç­” answer RR additional RR authority RR rcode CODE # ç”¨äºè§£æCNAMEsçš„ä¸Šæœ‰é›†ç¾¤ upstream fallthrough [ZONE...] } æ³›åŸŸå ä½¿ç”¨templateæ’ä»¶å¯ä»¥å®ç°æ³›åŸŸåè§£æï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š template IN A mesh.gmem.cc { match .*\\.mesh\\.gmem\\.cc answer \"{{ .Name }} 60 IN A 10.0.11.11\" fallthrough } å½“å‰ç‰ˆæœ¬æœ‰ä¸€ä¸ªå¥‡æ€ªçš„è¡Œä¸ºï¼š ä¸Šè¿°é…ç½®å¯¼è‡´hostsæ’ä»¶æŒ‡å®šçš„10.0.11.1 mesh.gmem.ccæ¡ç›®å¤±æ•ˆï¼Œå¿…é¡»æŒ‡å®šfallthroughæ‰èƒ½é¿å…æ­¤é—®é¢˜ã€‚ å¯åŠ¨æœåŠ¡ docker run -d --restart=always --name coredns-srv -p 53:53/udp -v `pwd`/conf:/Conf coredns/c","date":"2023-11-11","objectID":"/posts/2023-11-11-coredns/:1:0","tags":["dns","coredns"],"title":"coredns","uri":"/posts/2023-11-11-coredns/"},{"categories":["DNS"],"content":"å¯è¡Œçš„é…ç½® å‚è€ƒé“¾æ¥ï¼šhttps://segmentfault.com/a/1190000022179401 Corefile .:53 { health { lameduck 5s } auto { directory ./zones reload 1m } hosts { 127.0.0.1 local.io ttl 120 reload 1m fallthrough } #chaos CoreDNS-001 info@coredns.io # prometheus 0.0.0.0:0153 log #cache 120 loop errors forward . 114.114.114.114:53 8.8.8.8:53 [2400:3200::1]:53 loadbalance } db.local.com $TTL 3600 ; è®°å½•è¶…æ—¶æ—¶é—´ $ORIGIN local.com. ; æŒ‡å®š originï¼Œä¸‹é¢çš„@ç¬¦å·å¯ä»¥ä½œä¸ºä»–çš„åˆ«åï¼Œæ³¨æ„åé¢çš„. ; SOA æ ¼å¼ [domain_name] IN SOA [åŸŸä¸»æœåŠ¡å™¨æˆ–ä¸»DNSæœåŠ¡å™¨å] [ç®¡ç†å‘˜email] (æ—¶é—´ä¿¡æ¯) @ IN SOA ns1.local.com. admin.local.com. ( 2019071601 ; Serial 4H ; Refresh 1H ; Retry 7D ; Expire 4H ) ; Negative Cache TTL ; é…ç½® DNS è®°å½•ï¼ŒæŒ‡å‘ ns1.local.com @ IN NS ns1 ; é…ç½® ns1.local.com çš„ A è®°å½•, æŒ‡å‘corednsæ‰€åœ¨çš„æœºå™¨ ns1 IN A 192.168.78.51 ; é…ç½® local.com çš„ A è®°å½•ï¼ŒæŒ‡å‘ç½‘ç«™æˆ–å…¶ä»–ç”¨é€”çš„æœºå™¨ @ IN A 192.168.78.51 git IN A 192.168.78.51 drone IN A 192.168.78.51 drone-runner IN A 192.168.78.51 www IN A 192.168.78.51 ccc IN A 192.168.78.51 ; é…ç½®æ³›åŸŸåï¼Œæ²¡æœ‰å‡†ç¡®çš„ä¸‰çº§å­åŸŸåçš„åŸŸåå…¨éƒ¨æŒ‡å‘æ­¤IPV4åœ°å€ * IN A 192.168.78.50 å¯åŠ¨æœåŠ¡ docker run -tid -p 53:53/udp -v /yaml/coredns/Corefile:/Corefile -v /yaml/coredns/zones:/zones --name=coredns coredns/coredns ","date":"2023-11-11","objectID":"/posts/2023-11-11-coredns/:1:1","tags":["dns","coredns"],"title":"coredns","uri":"/posts/2023-11-11-coredns/"},{"categories":["DNS"],"content":"äºŒã€å¢åŠ å’Œç¼–è¯‘æ’ä»¶ ç¼–è¯‘å®‰è£…corednsï¼š corednså®˜æ–¹å¯¹äºæ’ä»¶çš„åˆ†ç±»åŸºæœ¬å¯ä»¥åˆ†ä¸ºä¸‰ç§ï¼šPluginsã€External Pluginså’Œå…¶ä»–ã€‚å…¶ä¸­Pluginsä¸€èˆ¬éƒ½ä¼šè¢«é»˜è®¤ç¼–è¯‘åˆ°corednsçš„é¢„ç¼–è¯‘ç‰ˆæœ¬ä¸­ï¼Œè€ŒExternal Pluginsåˆ™ä¸ä¼šã€‚å®˜æ–¹çš„æ–‡æ¡£å¯¹å¤–éƒ¨æ’ä»¶çš„å®šä¹‰æœ‰ç€æ˜ç¡®çš„è§£é‡Šï¼Œä¸»è¦è¦æ±‚å¤§æ¦‚æ˜¯æœ‰ç”¨ã€é«˜æ•ˆã€ç¬¦åˆæ ‡å‡†ã€æ–‡æ¡£é½å…¨ã€é€šè¿‡æµ‹è¯•ç­‰ã€‚ å®˜æ–¹ç»™å‡ºäº†ä¸€ä¸ªè¯¦ç»†çš„æ–‡æ¡£è¯´æ˜ï¼Œç¼–è¯‘æ’ä»¶åŸºæœ¬å¯ä»¥åˆ†ä¸ºä¿®æ”¹æºç å’Œä¿®æ”¹ç¼–è¯‘çš„é…ç½®æ–‡ä»¶è¿™ä¸¤ç§æ–¹å¼ï¼Œè¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ç®€å•é«˜æ•ˆçš„ä¿®æ”¹é…ç½®æ–‡ä»¶çš„æ–¹å¼è¿›è¡Œæµ‹è¯•ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-coredns/:2:0","tags":["dns","coredns"],"title":"coredns","uri":"/posts/2023-11-11-coredns/"},{"categories":["DNS"],"content":"1ã€ç¼–è¯‘ ä¸‹è½½æºç ï¼šhttps://github.com/coredns/coredns.git åœ¨æˆ‘ä»¬å‰é¢ä¸‹è½½çš„å®˜æ–¹æºç ä¸­ï¼Œæœ‰ä¸€ä¸ªpluginçš„ç›®å½•ï¼Œé‡Œé¢æ˜¯å„ç§æ’ä»¶çš„å®‰è£…åŒ…ï¼ŒåŒæ—¶è¿˜æœ‰ä¸€ä¸ªplugin.cfgçš„æ–‡ä»¶ï¼Œé‡Œé¢åˆ—å‡ºäº†ä¼šç¼–è¯‘åˆ°corednsä¸­çš„æ’ä»¶ï¼Œ [root@sugar2 coredns]# tail plugin.cfg secondary:secondary etcd:etcd loop:loop forward:forward grpc:grpc erratic:erratic whoami:whoami on:github.com/coredns/caddy/onevent sign:sign git:github.com/miekg/coredns-git æ·»åŠ ä¸€ä¸ªgitæ’ä»¶ git:github.com/miekg/coredns-git å¯¹äºåœ¨pluginç›®å½•ä¸‹å·²ç»å­˜åœ¨çš„æ’ä»¶ï¼Œåˆ™å¯ä»¥ç›´æ¥å†™æˆpluginä¸­çš„ç›®å½•åï¼Œä¸åœ¨çš„åˆ™å†™æ’ä»¶çš„ä»“åº“ï¼Œå¯ä»¥ä½¿ç”¨go getä¸‹è½½ï¼š sign:sign ä¸‹è½½æ’ä»¶ï¼š go get github.com/miekg/coredns-git ç„¶åæˆ‘ä»¬å¼€å§‹ç¼–è¯‘ [root@sugar2 coredns]# make ","date":"2023-11-11","objectID":"/posts/2023-11-11-coredns/:2:1","tags":["dns","coredns"],"title":"coredns","uri":"/posts/2023-11-11-coredns/"},{"categories":["DNS"],"content":"2ã€éªŒè¯æ’ä»¶ å¯ä»¥ä½¿ç”¨-pluginsè¾“å‡ºåŒ…å«çš„æ’ä»¶ [root@sugar2 coredns]# ./coredns -plugins Server types: dns Caddyfile loaders: flag default Other plugins: dns.acl dns.any dns.auto dns.autopath dns.azure dns.bind dns.bufsize dns.cache dns.cancel dns.chaos dns.clouddns dns.debug dns.dns64 dns.dnssec dns.dnstap dns.erratic dns.errors dns.etcd dns.file dns.forward dns.geoip dns.git dns.grpc dns.header dns.health dns.hosts dns.k8s_external dns.kubernetes dns.loadbalance dns.local dns.log dns.loop dns.metadata dns.minimal dns.nsid dns.pprof dns.prometheus dns.ready dns.reload dns.rewrite dns.root dns.route53 dns.secondary dns.sign dns.template dns.tls dns.trace dns.transfer dns.whoami on 1ï¼‰ä½¿ç”¨gitæ’ä»¶ å»ºç«‹å­˜å‚¨zonesæ–‡ä»¶çš„çš„gitä»“åº“ï¼šgit@local.io:sugar/coredns_zone.git é…ç½®æ–‡ä»¶æ¨¡æ¿ .:53 { health { lameduck 5s } auto { directory /usr/local/coredns/zones reload 1m } hosts { ttl 120 reload 1m fallthrough } #chaos CoreDNS-001 info@coredns.io prometheus 0.0.0.0:9153 log cache 300 loop errors forward . 114.114.114.114:53 8.8.8.8:53 [2400:3200::1]:53 loadbalance git git@local.io:sugar/coredns_zone.git /usr/local/coredns/zones { branch master interval 3000 # pullçš„æ—¶é—´é—´éš” args --depth=1 pull_args --force } } supervisord [root@ftp coredns]# cat /etc/supervisord.d/coredns.ini [program:coredns] directory=/usr/local/coredns command=/usr/local/coredns/coredns -conf /usr/local/coredns/Corefile autostart=true autorestart=true startsecs=7 user = root stderr_logfile=/var/log/coredns/coredns-err.log stdout_logfile=/var/log/coredns/coredns.log redirect_stderr = true stdout_logfile_maxbytes = 100MB stdout_logfile_backups = 4 stopasgroup=true killasgroup=true ","date":"2023-11-11","objectID":"/posts/2023-11-11-coredns/:2:2","tags":["dns","coredns"],"title":"coredns","uri":"/posts/2023-11-11-coredns/"},{"categories":["è™šæ‹ŸåŒ–"],"content":"â€‹ Multipass æ˜¯ä¸€ä¸ªè½»é‡è™šæ‹Ÿæœºç®¡ç†å™¨ï¼Œæ˜¯ç”± Ubuntu è¿è¥å…¬å¸ Canonical æ‰€æ¨å‡ºçš„å¼€æºé¡¹ç›®ã€‚è¿è¡Œç¯å¢ƒæ”¯æŒ Linuxã€Windowsã€macOSã€‚åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šï¼Œä½¿ç”¨çš„æ˜¯ä¸åŒçš„è™šæ‹ŸåŒ–æŠ€æœ¯ã€‚åœ¨ Linux ä¸Šä½¿ç”¨çš„æ˜¯ KVMã€Window ä¸Šä½¿ç”¨ Hyper-Vã€macOS ä¸­ä½¿ç”¨ HyperKit ä»¥æœ€å°å¼€é”€è¿è¡ŒVMï¼Œæ”¯æŒåœ¨ç¬”è®°æœ¬æ¨¡æ‹Ÿå°å‹äº‘ã€‚Multipasså”¯ä¸€çš„é—æ†¾æ˜¯æ”¯æŒLinuxç‰ˆæœ¬åªæœ‰Ubuntuã€‚ åŒæ—¶ï¼ŒMultipass æä¾›äº†ä¸€ä¸ªå‘½ä»¤è¡Œç•Œé¢æ¥å¯åŠ¨å’Œç®¡ç† Linux å®ä¾‹ã€‚ä¸‹è½½ä¸€ä¸ªå…¨æ–°çš„é•œåƒéœ€è¦å‡ ç§’é’Ÿçš„æ—¶é—´ï¼Œå¹¶ä¸”åœ¨å‡ åˆ†é’Ÿå†…å°±å¯ä»¥å¯åŠ¨å¹¶è¿è¡Œ VMã€‚ githubåœ°å€ï¼šhttps://github.com/canonical/multipass å®˜ç½‘ï¼šhttps://multipass.run/ ","date":"2023-11-11","objectID":"/posts/2023-11-11-multipass/:0:0","tags":["multipass","vm"],"title":"multipass","uri":"/posts/2023-11-11-multipass/"},{"categories":["è™šæ‹ŸåŒ–"],"content":"å®‰è£… Macï¼š # 1ï¼‰brew å®‰è£… brew install --cask multipass # 2)githubæˆ–è€…å®˜ç½‘ä¸‹äºŒè¿›åˆ¶å®‰è£… Linuxï¼š ubuntuå®˜æ–¹åªreleaseäº†snapå®‰è£…ç‰ˆæœ¬ sudo snap install multipass Windowsï¼š githubä¸‹è½½å®‰è£…åŒ… ","date":"2023-11-11","objectID":"/posts/2023-11-11-multipass/:0:1","tags":["multipass","vm"],"title":"multipass","uri":"/posts/2023-11-11-multipass/"},{"categories":["è™šæ‹ŸåŒ–"],"content":"ä½¿ç”¨ 1ï¼‰æŸ¥æ‰¾å¯ä»¥ä¸‹è½½çš„ubuntué•œåƒï¼ˆmultipasså®˜æ–¹é•œåƒåªæœ‰ubuntuï¼‰ [root@sugar ~]$ multipass find Image Aliases Version Description 18.04 bionic 20221014 Ubuntu 18.04 LTS 20.04 focal 20221018 Ubuntu 20.04 LTS 22.04 jammy,lts 20221101.1 Ubuntu 22.04 LTS anbox-cloud-appliance latest Anbox Cloud Appliance charm-dev latest A development and testing environment for charmers docker latest A Docker environment with Portainer and related tools jellyfin latest Jellyfin is a Free Software Media System that puts you in control of managing and streaming your media. minikube latest minikube is local Kubernetes 2ï¼‰åˆ›å»ºè™šæ‹Ÿæœº å‚æ•°ï¼š -n, --name: åç§° -c, --cpus: cpuæ ¸å¿ƒæ•°, é»˜è®¤: 1 -m, --mem: å†…å­˜å¤§å°, é»˜è®¤: 1G -d, --disk: ç¡¬ç›˜å¤§å°, é»˜è®¤: 5G åˆ›å»ºè™šæ‹Ÿæœºæ—¶éœ€è¦è”ç½‘ä¸‹è½½é•œåƒ # ä½¿ç”¨æœ€æ–°ç‰ˆLTSé•œåƒ [root@sugar ~]$ multipass launch -n vm01 -c 1 -m 1G -d 10G # è®¾ç½®ä½¿ç”¨çš„é•œåƒ [root@sugar ~]$ multipass launch focal -n vm01 -c 1 -m 1G -d 10G # è®¾ç½®ç½‘ç»œ # name ç½‘å¡å # mode dhcpæ–¹å¼ï¼Œautoæˆ–è€…manualï¼Œé»˜è®¤auto # mac è®¾ç½®macåœ°å€ [root@sugar ~]$ multipass launch --network en0 --network name=bridge0,mode=manual ä¿®æ”¹é…ç½® [root@sugar ~]$ multipass set local.\u003cinstance-name\u003e.(cpus|disk|memory) xxx 3ï¼‰ä¸è™šæ‹Ÿæœºäº¤äº’ # é»˜è®¤æ˜¯ä»¥ubuntuç”¨æˆ·è¿›å…¥ [root@sugar ~]$ multipass shell vm01 # åœ¨è™šæ‹Ÿæœºå¤–æ‰§è¡Œå‘½ä»¤ [root@sugar ~]$ multipass exec vm01 -- pwd 4ï¼‰å¯åŠ¨ä¸å…³é—­ [root@sugar ~]$ multipass start vm01 [root@sugar ~]$ multipass start vm01 vm02 [root@sugar ~]$ multipass start --all [root@sugar ~]$ multipass suspend vm01 [root@sugar ~]$ multipass suspend --all [root@sugar ~]$ multipass stop vm01 [root@sugar ~]$ multipass stop --all [root@sugar ~]$ multipass delete vm01 [root@sugar ~]$ multipass delete --all # ä»ä¸€ä¸ªåˆ é™¤çš„å®ä¾‹ä¸­æ¢å¤ [root@sugar ~]$ multipass recover keen-yak # ç§»é™¤ä¸€ä¸ªå®ä¾‹ [root@sugar ~]$ multipass delete keen-yak [root@sugar ~]$ multipass purge [root@sugar ~]$ multipass list No instances found. # æˆ–è€… [root@sugar ~]$$ multipass delete --purge keen-yak 5ï¼‰æ•°æ®å…±äº« mount $ multipass mount $HOME keen-yak $ multipass info keen-yak â€¦ Mounts: /home/michal =\u003e /home/michal # æŒ‚è½½æŒ‡å®šè·¯å¾„ $ multipass mount $HOME keen-yak:/some/path # æŸ¥çœ‹ä¿¡æ¯ $ multipass info keen-yak # å¸è½½ $ multipass umount keen-yak ä¼ è¾“æ–‡ä»¶ $ multipass transfer keen-yak:/etc/crontab keen-yak:/etc/fstab /home/michal $ ls -l /home/michal/crontab /home/michal/fstab -rw-r--r-- 1 michal michal 722 Oct 18 12:13 /home/michal/crontab -rw-r--r-- 1 michal michal 82 Oct 18 12:13 /home/michal/fstab $ multipass transfer /home/michal/crontab /home/michal/fstab keen-yak: $ multipass exec keen-yak -- ls -l crontab fstab -rw-rw-r-- 1 ubuntu ubuntu 722 Oct 18 12:14 crontab -rw-rw-r-- 1 ubuntu ubuntu 82 Oct 18 12:14 fstab 6ï¼‰å®¹å™¨è‡ªåŠ¨åŒ– ä¸ºäº†ä¿æŒå¼€å‘ç¯å¢ƒå’Œçº¿ä¸Šç¯å¢ƒä¸€è‡´æ€§ åŒæ—¶èŠ‚çœéƒ¨ç½²æ—¶é—´ multipass ç»™æˆ‘ä»¬æä¾›äº† â€“cloud-init é€‰é¡¹è¿›è¡Œå®¹å™¨å¯åŠ¨åˆå§‹åŒ–é…ç½®: multipass launch --name ubuntu --cloud-init config.yaml ä¸Šé¢ config.yaml åˆ™æ˜¯å®¹å™¨çš„åˆå§‹åŒ–é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬æƒ³åœ¨åˆå§‹åŒ–å®¹å™¨çš„æ—¶å€™ï¼Œè‡ªåŠ¨ä¸‹è½½å®‰è£… Node.jsï¼Œå†…å®¹å¦‚ä¸‹ï¼š #cloud-config runcmd: - curl -sL https://deb.nodesource.com/setup_12.x | sudo -E bash - - sudo apt-get install -y nodejs runcmd å¯ä»¥æŒ‡å®šå®¹å™¨ é¦–æ¬¡å¯åŠ¨ æ—¶è¿è¡Œçš„å‘½ä»¤ å‡¡æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„cloud-initçš„é…ç½®æ–‡ä»¶,å¿…é¡»ä»¥#cloud-configå¼€å¤´ï¼Œè¿™æ˜¯cloud-initè¯†åˆ«å®ƒçš„æ–¹å¼ã€‚ yaml é…ç½®æ–‡ä»¶å‚è€ƒé“¾æ¥ï¼šhttps://cloudinit.readthedocs.io/en/latest/topics/examples.html?highlight=lock-passwd#including-users-and-groups ","date":"2023-11-11","objectID":"/posts/2023-11-11-multipass/:0:2","tags":["multipass","vm"],"title":"multipass","uri":"/posts/2023-11-11-multipass/"},{"categories":["mac"],"content":"Mac ä¼˜åŒ– ","date":"2023-11-11","objectID":"/posts/2023-11-11-mac/:0:0","tags":["mac"],"title":"mac","uri":"/posts/2023-11-11-mac/"},{"categories":["mac"],"content":"ä¿®æ”¹é»˜è®¤çš„shell # shells è®°å½•äº†å¯è®¾ç½®çš„shellï¼Œéœ€è¦/opt/homebrew/bin/bashåŠ åˆ°æ–‡ä»¶ä¸­ cat /etc/shells # List of acceptable shells for chpass(1). # Ftpd will not allow users to connect who are not using # one of these shells. /bin/bash /bin/csh /bin/dash /bin/ksh /bin/sh /bin/tcsh /bin/zsh /opt/homebrew/bin/bash # åˆ‡æ¢shell chsh -s /opt/homebrew/bin/bash # é€€å‡ºé‡æ–°ç™»å½• ","date":"2023-11-11","objectID":"/posts/2023-11-11-mac/:0:1","tags":["mac"],"title":"mac","uri":"/posts/2023-11-11-mac/"},{"categories":["mac"],"content":"macç»ˆç«¯å¢åŠ é¢œè‰²ï¼Œå‚è€ƒcentos7 eval \"$(/opt/homebrew/bin/brew shellenv)\" # Setting PATH for Python 3.9 # The original version is saved in .bash_profile.pysave PATH=\"/Library/Frameworks/Python.framework/Versions/3.9/bin:${PATH}\" export PG_HOME=/opt/homebrew/Cellar/postgresql@10/10.17 export PATH export GOPROXY=https://goproxy.cn,direct export GOPATH=/Users/sugar/go export GO111MODULE=\"on\" export GOBIN=$GOPATH/bin export PATH=$PATH:$GOROOT/bin:$GOBIN:$PG_HOME/bin # å‚è€ƒRHEL console export PS1=\"[\\u@\\h \\W]\\\\$ \" export CLICOLOR=1 export LSCOLORS=ExGxFxdaCxDaDahbadeche export LC_ALL=en_US.UTF-8 export LANG=en_US.UTF-8 ","date":"2023-11-11","objectID":"/posts/2023-11-11-mac/:1:0","tags":["mac"],"title":"mac","uri":"/posts/2023-11-11-mac/"},{"categories":["mac"],"content":"å®‰è£…homebrew å‚è€ƒï¼šhttp://mirrors.ustc.edu.cn/help/brew.git.html é…ç½®ç¯å¢ƒå˜é‡ [sugar@localhost ~]$ cat ~/.bash_profile # brew å®‰è£…å…¶ä»–ç›®å½•ä¸‹æ‰éœ€è¦è®¾ç½® #eval \"$(/opt/homebrew/bin/brew shellenv)\" export HOMEBREW_BREW_GIT_REMOTE=\"https://mirrors.ustc.edu.cn/brew.git\" export HOMEBREW_CORE_GIT_REMOTE=\"https://mirrors.ustc.edu.cn/homebrew-core.git\" export HOMEBREW_BOTTLE_DOMAIN=\"https://mirrors.ustc.edu.cn/homebrew-bottles\" å®‰è£… /bin/bash -c \"$(curl -fsSL https://cdn.jsdelivr.net/gh/Homebrew/install@HEAD/install.sh)\" 3ã€å»é™¤è‡ªåŠ¨ç”Ÿæˆ.DS_Storeæ–‡ä»¶ .DS_Storeæ˜¯Mac OSä¿å­˜æ–‡ä»¶å¤¹çš„è‡ªå®šä¹‰å±æ€§çš„éšè—æ–‡ä»¶ï¼Œå¦‚æ–‡ä»¶çš„å›¾æ ‡ä½ç½®æˆ–èƒŒæ™¯è‰²ï¼Œç›¸å½“äºWindowsçš„desktop.ini 1ï¼‰ç¦æ­¢.DS_Storeæ–‡ä»¶çš„ç”Ÿæˆï¼š defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool TRUE 2ï¼‰æ¢å¤.DS_Storeæ–‡ä»¶çš„ç”Ÿæˆ defaults delete com.apple.desktopservices DSDontWriteNetworkStores 3ï¼‰åˆ é™¤ç£ç›˜ä¸Šçš„ .DS_Store,åˆ é™¤å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸‹çš„æ‰€æœ‰.DS_Store æ–‡ä»¶: sudo find . -name '*.DS_Store' -type f -delete æœ€åé‡å¯ç”µè„‘å³å¯ç”Ÿæ•ˆï¼ ","date":"2023-11-11","objectID":"/posts/2023-11-11-mac/:2:0","tags":["mac"],"title":"mac","uri":"/posts/2023-11-11-mac/"},{"categories":["mac"],"content":"ç¯å¢ƒå˜é‡ eval \"$(/opt/homebrew/bin/brew shellenv)\" export HOMEBREW_BREW_GIT_REMOTE=\"https://mirrors.ustc.edu.cn/brew.git\" export HOMEBREW_BOTTLE_DOMAIN=\"https://mirrors.ustc.edu.cn/homebrew-bottles\" export HOMEBREW_CORE_GIT_REMOTE=\"https://mirrors.ustc.edu.cn/homebrew-core.git\" export PG_HOME=/opt/homebrew/Cellar/postgresql@10/10.17 export GOPROXY=https://goproxy.cn,direct export GOPATH=/Users/sugar/go export GO111MODULE=\"on\" export GOBIN=$GOPATH/bin export PATH=$PATH:$GOROOT/bin:$GOBIN:$PG_HOME/bin export GOPRIVATE=\"local.com,gitee.com/cccccc\" export GOINSECURE=\"local.com\" #export CGO_ENABLED=\"0\" #export PS1='[\\u@\\h \\W]\\$ ' export PS1=\"[\\u@\\h \\W]\\\\$ \" export CLICOLOR=1 export LSCOLORS=ExGxFxdaCxDaDahbadeche export LC_ALL=en_US.UTF-8 export LANG=en_US.UTF-8 function k8s-local(){ unset KUBECONFIG export KUBECONFIG=~/.kube/kubeconfig-local.json kubectl cluster-info kubectl get namespace } function k8s-1(){ unset KUBECONFIG export KUBECONFIG=~/.kube/kubeconfig-1.json kubectl cluster-info kubectl get namespace } alias ll='ls -l' alias lh='ls -lh' #UserIP=$(who -u am i | cut -d\"(\" -f 2 | sed -e \"s/[()]//g\") export HISTTIMEFORMAT=\"[%F %T] [`whoami`] \" export HISTSIZE=99999 export HISTFILESIZE=550 # socket5 proxy(){ export http_proxy=\"http://127.0.0.1:5559\" export https_proxy=\"http://127.0.0.1:5559\" # è®¾ç½®ä»£ç† networksetup -setwebproxy Wi-Fi 127.0.0.1 5559 networksetup -setsecurewebproxy Wi-Fi 127.0.0.1 5559 networksetup -setsocksfirewallproxy Wi-Fi 127.0.0.1 5558 # æ‰“å¼€ç³»ç»Ÿä»£ç† networksetup -setwebproxystate Wi-Fi on networksetup -setsecurewebproxystate Wi-Fi on networksetup -setsocksfirewallproxystate Wi-Fi on ~/Desktop/v2cc/proxy } # å–æ¶ˆè®¾ç½®çš„ä»£ç† noproxy(){ unset http_proxy unset https_proxy networksetup -setwebproxystate Wi-Fi off networksetup -setsecurewebproxystate Wi-Fi off networksetup -setsocksfirewallproxystate Wi-Fi off } export PATH=\"/opt/homebrew/opt/icu4c/bin:$PATH\" export PATH=\"/opt/homebrew/opt/icu4c/sbin:$PATH\" #For compilers to find icu4c you may need to set: export LDFLAGS=\"-L/opt/homebrew/opt/icu4c/lib\" export CPPFLAGS=\"-I/opt/homebrew/opt/icu4c/include\" #For pkg-config to find icu4c you may need to set: export PKG_CONFIG_PATH=\"/opt/homebrew/opt/icu4c/lib/pkgconfig\" export PATH=\"/opt/homebrew/opt/node@14/bin:$PATH\" export LDFLAGS=\"-L/opt/homebrew/opt/node@14/lib\" export CPPFLAGS=\"-I/opt/homebrew/opt/node@14/include\" 5ã€ä½¿ç”¨bash-completionè¡¥å…¨ bash-completionéƒ¨åˆ†å·²ç»ä¸å…¼å®¹ï¼Œéœ€è¦ä½¿ç”¨v2ç‰ˆ brew install bash-completion@2 vim ~/.bash_profile # use bash-completion export BASH_COMPLETION_COMPAT_DIR=\"/opt/homebrew/etc/bash_completion.d\" [[ -r \"/opt/homebrew/etc/profile.d/bash_completion.sh\" ]] \u0026\u0026 . \"/opt/homebrew/etc/profile.d/bash_completion.sh\" 6ã€kubectlå‘½ä»¤è¡¥é½ vim ~/.bash_profile kubectl completion bash \u003e /opt/homebrew/etc/bash_completion.d/kubectl # è®¾ç½®åˆ«å echo 'alias k=kubectl' \u003e\u003e~/.bash_profile echo 'complete -o default -F __start_kubectl k' \u003e\u003e~/.bash_profile 7ã€åº”ç”¨ä¸‹è½½ç½‘ç«™ http://mac-torrent-download.net/ https://www.torrentmac.net/ https://mac-torrents.io/ 8 ã€è½¯ä»¶å‡ºç° ã€xxxxxå°†å¯¹æ‚¨çš„ç”µè„‘é€ æˆä¼¤å®³ï¼Œæ‚¨åº”è¯¥å°†å®ƒç§»åŠ¨åˆ°åºŸçº¸ç¯“ã€‘ # åˆ‡æ¢åˆ°è½¯ä»¶æˆ–è€…cmdæ‰€åœ¨çš„ç›®å½• codesign -f -s - --deep xxxx_app_name # ä¾‹å¦‚ codesign -f -s - --deep terraform 9ã€å®‰è£…â€œChromiumâ€å·²æŸåï¼Œæ— æ³•æ‰“å¼€ã€‚ æ‚¨åº”è¯¥å°†å®ƒç§»åˆ°åºŸçº¸ç¯“ã€‚ # å› ä¸ºç­¾åä¸é€ æˆçš„ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ sudo xattr -cr /Applications/Chromium.app 10ã€é…ç½®githubä»£ç† # http || https # Host github.com # User git # ProxyCommand nc -v -x 127.0.0.1:5559 %h %p Host github.com User git ProxyCommand nc -v -x 127.0.0.1:5558 %h %p ","date":"2023-11-11","objectID":"/posts/2023-11-11-mac/:3:0","tags":["mac"],"title":"mac","uri":"/posts/2023-11-11-mac/"},{"categories":["linux åŸºç¡€"],"content":"ubuntu åŸºç¡€ ","date":"2023-11-11","objectID":"/posts/2023-11-11-ubuntu/:0:0","tags":["ubuntu","linux"],"title":"ubuntu basic","uri":"/posts/2023-11-11-ubuntu/"},{"categories":["linux åŸºç¡€"],"content":"ä¸€ã€aptæº ä¿®æ”¹aptæºä¸ºå›½å†…æºï¼Œä¸»é…ç½®æ–‡ä»¶ï¼š/etc/apt/sources.listï¼Œé…ç½®æ–‡ä»¶ç›®å½•ï¼š/etc/apt/sources.dï¼Œä»¥1804ä¸ºä¾‹ã€‚ # ä¿®æ”¹ /etc/apt/sources.list deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse ä¿®æ”¹å‘½ä»¤ sudo sed -i \"s@http://.*archive.ubuntu.com@http://repo.huaweicloud.com@g\" /etc/apt/sources.list sudo sed -i \"s@http://.*security.ubuntu.com@http://repo.huaweicloud.com@g\" /etc/apt/sources.list ","date":"2023-11-11","objectID":"/posts/2023-11-11-ubuntu/:1:0","tags":["ubuntu","linux"],"title":"ubuntu basic","uri":"/posts/2023-11-11-ubuntu/"},{"categories":["linux åŸºç¡€"],"content":"apt ä½¿ç”¨é—®é¢˜ 1ï¼‰apt-getå®‰è£…ä¸­çš„E: Sub-process /usr/bin/dpkg returned an error code (1)é—®é¢˜ å‚è€ƒç½‘å€ï¼šhttps://www.cnblogs.com/orzs/p/10844869.html cd /var/lib/dpkg/ sudo mv info/ info_bak # ç°å°†infoæ–‡ä»¶å¤¹æ›´å sudo mkdir info # å†æ–°å»ºä¸€ä¸ªæ–°çš„infoæ–‡ä»¶å¤¹ sudo apt-get update # æ›´æ–° sudo apt-get -f install # ä¿®å¤ sudo mv info/* info_bak/ # æ‰§è¡Œå®Œä¸Šä¸€æ­¥æ“ä½œåä¼šåœ¨æ–°çš„infoæ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆä¸€äº›æ–‡ä»¶ï¼Œç°å°†è¿™äº›æ–‡ä»¶å…¨éƒ¨ç§»åˆ°info_bakæ–‡ä»¶å¤¹ä¸‹ sudo rm -rf info # æŠŠè‡ªå·±æ–°å»ºçš„infoæ–‡ä»¶å¤¹åˆ æ‰ sudo mv info_bak info # æŠŠä»¥å‰çš„infoæ–‡ä»¶å¤¹é‡æ–°æ”¹å›å 2ï¼‰Unable to acquire the dpkg frontend lock (/var/lib/dpkg/lock-frontend) è§£å†³åŠæ³•ï¼š ç¬¬ä¸€ç§æƒ…å†µï¼š è¿›ç¨‹ä¸­å­˜åœ¨ä¸aptç›¸å…³çš„æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼š é¦–å…ˆæ£€æŸ¥æ˜¯å¦åœ¨è¿è¡Œapt,apt-getç›¸å…³çš„è¿›ç¨‹ ps aux | grep -i apt å¦‚æœå­˜åœ¨ä¸aptç›¸å…³çš„æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œkillæ‰è¿›ç¨‹ï¼› sudo kill -9 \u003cprocess id\u003e æˆ–è€…ç›´æ¥ç®€å•ç²—æš´çš„ï¼š sudo killall apt apt-get å¦‚æœè¿›è¡Œå®Œä¸Šé¢çš„æ­¥éª¤è¿˜æ˜¯æ— æ³•é¡ºåˆ©æ‰§è¡Œapt-get æ“ä½œï¼Œåˆ™å±äºç¬¬äºŒç§æƒ…å†µï¼š ç¬¬äºŒç§æƒ…å†µï¼š è¿›ç¨‹åˆ—è¡¨ä¸­å·²ç»æ²¡æœ‰ä¸apt,apt-getç›¸å…³çš„è¿›ç¨‹åœ¨è¿è¡Œï¼Œä½†ä¾ç„¶æŠ¥é”™ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œäº§ç”Ÿé”™è¯¯çš„æ ¹æœ¬åŸå› æ˜¯lock fileã€‚ loack fileç”¨äºé˜²æ­¢ä¸¤ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹ä½¿ç”¨ç›¸åŒçš„æ•°æ®ã€‚ å½“è¿è¡Œaptæˆ–apt-commandsæ—¶ï¼Œå®ƒä¼šåœ¨å‡ ä¸ªåœ°æ–¹åˆ›å»ºlock filesã€‚ å½“å‰ä¸€ä¸ªaptå‘½ä»¤æœªæ­£ç¡®ç»ˆæ­¢æ—¶ï¼Œlock fileæœªè¢«åˆ é™¤ï¼Œå› æ­¤å®ƒä»¬ä¼šé˜»æ­¢ä»»ä½•æ–°çš„apt / apt-getå‘½ä»¤å®ä¾‹ï¼Œæ¯”å¦‚æ­£åœ¨æ‰§è¡Œapt-get upgradeï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç›´æ¥ctrl+cå–æ¶ˆäº†è¯¥æ“ä½œï¼Œå¾ˆæœ‰å¯èƒ½å°±ä¼šé€ æˆè¿™ç§æƒ…å†µã€‚ è¦è§£å†³æ­¤é—®é¢˜ï¼Œé¦–å…ˆè¦åˆ é™¤lock fileã€‚ ä½¿ç”¨lsofå‘½ä»¤è·å–æŒæœ‰lock fileçš„è¿›ç¨‹çš„è¿›ç¨‹ID,ä¾æ¬¡è¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š lsof /var/lib/dpkg/lock lsof /var/lib/apt/lists/lock lsof /var/cache/apt/archives/lock éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»¥ä¸Šå‘½ä»¤æ‰§è¡Œç»“æœå¦‚æœæ— è¿”å›ï¼Œè¯´æ˜æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼›å¦‚æœè¿”å›äº†ç›¸åº”çš„è¿›ç¨‹ï¼Œéœ€è¦killæ‰ã€‚ åˆ é™¤æ‰€æœ‰çš„lock file sudo rm /var/lib/apt/lists/lock sudo rm /var/cache/apt/archives/lock sudo rm /var/lib/dpkg/lock æœ€åé‡æ–°é…ç½®ä¸€ä¸‹dpkgï¼š sudo dpkg --configure -a å¦‚æœä¸Šè¿°å‘½ä»¤ä¸å‡ºä»»ä½•é”™è¯¯ï¼Œå°±ä¸‡äº‹å¤§å‰äº†ã€‚ï¼ˆæˆ‘æ˜¯åˆ°è¿™é‡Œé—®é¢˜å°±è§£å†³äº†ï¼‰ ä½†æ˜¯æœ‰æ—¶å€™ï¼Œç”Ÿæ´»æ€»æ˜¯å«Œä½ ä¸å¤Ÿæƒ¨ï¼Œæ‰§è¡Œé…ç½®å‘½ä»¤æ—¶å¯èƒ½ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š dpkg: error: dpkg frontend is locked by another process è¿™éœ€è¦æˆ‘ä»¬é¢å¤–è¿›è¡Œä¸€äº›æ“ä½œï¼š æ‰¾å‡ºæ­£åœ¨é”å®šlock fileçš„è¿›ç¨‹ï¼š lsof /var/lib/dpkg/lock-frontend killæ‰è¾“å‡ºçš„è¿›ç¨‹ï¼ˆå¦‚æœè¾“å‡ºä¸ºç©ºåˆ™å¿½ç•¥ï¼‰ sudo kill -9 PID åˆ é™¤lock fileå¹¶é‡æ–°é…ç½®dpkg: sudo rm /var/lib/dpkg/lock-frontend sudo dpkg --configure -a ","date":"2023-11-11","objectID":"/posts/2023-11-11-ubuntu/:1:1","tags":["ubuntu","linux"],"title":"ubuntu basic","uri":"/posts/2023-11-11-ubuntu/"},{"categories":["linux åŸºç¡€"],"content":"å‡çº§ç³»ç»Ÿ ubuntu 1804 å‡çº§åˆ°2004 1ï¼‰åˆ‡æ¢aptæº deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse 2ï¼‰æ›´æ–°å’Œé‡å¯ç³»ç»Ÿ apt update apt upgrade reboot 3ï¼‰æ›´æ–°ç³»ç»Ÿ do-release-upgrade Reading cache Checking package manager Continue running under SSH? This session appears to be running under ssh. It is not recommended to perform a upgrade over ssh currently because in case of failure it is harder to recover. If you continue, an additional ssh daemon will be started at port '1022'. Do you want to continue? Continue [yN] y Starting additional sshd To make recovery in case of failure easier, an additional sshd will be started on port '1022'. If anything goes wrong with the running ssh you can still connect to the additional one. If you run a firewall, you may need to temporarily open this port. As this is potentially dangerous it's not done automatically. You can open the port with e.g.: 'iptables -I INPUT -p tcp --dport 1022 -j ACCEPT' ","date":"2023-11-11","objectID":"/posts/2023-11-11-ubuntu/:1:2","tags":["ubuntu","linux"],"title":"ubuntu basic","uri":"/posts/2023-11-11-ubuntu/"},{"categories":["linux åŸºç¡€"],"content":"äºŒã€å®‰è£… docker ubuntuä¸çº¢å¸½ç³»åˆ—ç³»ç»Ÿä¸åŒï¼Œåœ¨é…ç½®aptæºæ—¶éœ€è¦å…ˆé…ç½®è¦æ·»åŠ çš„å¯†é’¥çš„è¯ä¹¦ root@harbor:~# curl -fsSL https://mirrors.huaweicloud.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add - root@harbor:~# sudo apt-get install software-properties-common root@harbor:~# add-apt-repository \"deb [arch=amd64] https://mirrors.huaweicloud.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable\" root@harbor:~# apt-get update root@harbor:~# apt-get install docker-ce ","date":"2023-11-11","objectID":"/posts/2023-11-11-ubuntu/:2:0","tags":["ubuntu","linux"],"title":"ubuntu basic","uri":"/posts/2023-11-11-ubuntu/"},{"categories":["linux åŸºç¡€"],"content":"ä¸‰ã€vim è®¾ç½® ubuntuä¸Šé»˜è®¤çš„è®¸å¤šæ–‡ä»¶çš„ç¼–è¾‘å™¨æ˜¯nanoï¼Œå…¶ä½¿ç”¨éå¸¸ä¸å‹å¥½ï¼Œå¯ä»¥ä¿®æ”¹ä¸ºvim root@ubuntu:~# sudo select-editor Select an editor. To change later, run 'select-editor'. 1. /bin/nano \u003c---- easiest 2. /usr/bin/vim.basic 3. /usr/bin/vim.tiny 4. /bin/ed Choose 1-4 [1]: 2 # å…ˆæ‹©vim.basicï¼Œè®¾ç½®å¥½åå°±å¯ä»¥åœ¨ç¼–è¾‘ä¸€äº›æ–‡ä»¶æˆ–æœåŠ¡æ—¶ä½¿ç”¨vim ","date":"2023-11-11","objectID":"/posts/2023-11-11-ubuntu/:3:0","tags":["ubuntu","linux"],"title":"ubuntu basic","uri":"/posts/2023-11-11-ubuntu/"},{"categories":["linux åŸºç¡€"],"content":"å››ã€exsi é…ç½® exsi å®‰è£…ubuntu2004 æŠ¥é”™ multipathd[651]: sda: add missing path multipathd[651]: sda: failed to get udev uid: Invalid argument multipathd[651]: sda: failed to get sysfs uid: Invalid argument multipathd[651]: sda: failed to get sgio uid: No such file or directory multipathd[651]: sda: add missing path multipathd[651]: sda: failed to get udev uid: Invalid argument multipathd[651]: sda: failed to get sysfs uid: Invalid argument multipathd[651]: sda: failed to get sgio uid: No such file or directory è§£å†³åŠæ³•ï¼š https://askubuntu.com/questions/1242731/ubuntu-20-04-multipath-configuration æ–¹æ³•ä¸€ï¼š exsiè™šæ‹Ÿæœºé…ç½®æ–‡ä»¶ä¸­å¢åŠ  disk.EnableUUID = \"TRUE\" æ–¹æ³•äºŒï¼š # vim defaults { user_friendly_names yes } blacklist { device { vendor \"VMware\" product \"Virtual disk\" } } # é‡å¯ /etc/init.d/multipath-tools restart # æˆ–è€… systemctl restart multipathd defaults { user_friendly_names yes } blacklist { devnode \"^(ram|raw|loop|fd|md|dm-|sr|scd|st|sda)[0-9]*\" } ","date":"2023-11-11","objectID":"/posts/2023-11-11-ubuntu/:4:0","tags":["ubuntu","linux"],"title":"ubuntu basic","uri":"/posts/2023-11-11-ubuntu/"},{"categories":["linux åŸºç¡€"],"content":"äº”ã€networké…ç½® é™æ€IP 1ã€é…ç½®é™æ€ip root@ubuntu:/etc/netplan# pwd /etc/netplan root@ubuntu:/etc/netplan# vim 50-cloud-init.yaml network: version: 2 renderer: networkd ethernets: ens160: dpch4: no addresses: - 192.168.100.17/24 gateway4: 192.168.100.1 nameservers: addresses: - 223.5.5.5 æˆ–è€… network: ethernets: ens3: dhcp4: no addresses: [192.168.100.141/24] gateway4: 192.168.100.1 nameservers: addresses: [114.114.114.114,8.8.8.8] version: 2 2204å¼€å§‹ network: version: 2 ethernets: ens3: dhcp4: false addresses: [192.168.100.141/24] routes: - to: default via: 192.168.100.1 nameservers: addresses: [114.114.114.114,8.8.8.8] 2ã€åŠ è½½é…ç½® root@ubuntu:~# netplan apply #æµ‹è¯•ç½‘ç»œ root@ubuntu:~# ping baidu.com 3ã€è¿æ¥wifi network: version: 2 wifis: wlan0: dhcp4: true access-points: \"sugar\": # ssid name password: \"password\" ","date":"2023-11-11","objectID":"/posts/2023-11-11-ubuntu/:5:0","tags":["ubuntu","linux"],"title":"ubuntu basic","uri":"/posts/2023-11-11-ubuntu/"},{"categories":["linux åŸºç¡€"],"content":"å…­ã€rc.local è®¾ç½® [root@tc ~]# cat /etc/systemd/system/rc-local.service [Unit] Description=/etc/rc.local Compatibility Documentation=man:systemd-rc-local-generator(8) ConditionFileIsExecutable=/etc/rc.local After=network.target [Service] Type=forking ExecStart=/etc/rc.local TimeoutStartSec=0 TimeoutStopSec=30 RemainAfterExit=yes GuessMainPID=no [Install] WantedBy=multi-user.target [root@tc rc.d]# cat rc.local #!/bin/bash date \u003e\u003e /tmp/data.txt exit 0 ","date":"2023-11-11","objectID":"/posts/2023-11-11-ubuntu/:6:0","tags":["ubuntu","linux"],"title":"ubuntu basic","uri":"/posts/2023-11-11-ubuntu/"},{"categories":["linux åŸºç¡€"],"content":"ä¸ƒã€ssh æœåŠ¡é…ç½® ubuntué»˜è®¤ä¸å®‰è£…openssh-server 1ã€å®‰è£…openssl-server root@ubuntu:~# apt-get install openssh-sevrer root@ubuntu:~# systemctl start ssh root@ubuntu:~# systemctl enable ssh # æŸ¥è¯¢å¯å®‰è£…çš„åŒ…æ‰€æœ‰ç‰ˆæœ¬ apt list -a ssh Listing... Done ssh/jammy-updates,jammy-security 1:8.9p1-3ubuntu0.6 all ssh/jammy 1:8.9p1-3 all apt install ssh=1:8.9p1-3 all 2ã€å…è®¸rootç”¨æˆ·è¿œç¨‹ç™»é™† ubuntué»˜è®¤ä¸å…è®¸rootç”¨æˆ·è¿œç¨‹ç™»é™† root@ubuntu:~# vim /etc/ssh/sshd_config 32 #PermitRootLogin prohibit-password ä¿®æ”¹ä¸º 33 PermitRootLogin yes æ‰“å¼€å¯†é’¥è®¤è¯ 56 #PasswordAuthentication yes ä¿®æ”¹ä¸º 57 PasswordAuthentication yes ä¸ºrootç”¨æˆ·è®¾ç½®å¯†ç  root@ubuntu:~# passwd root é‡å¯sshæœåŠ¡ root@ubuntu:~# systemctl restart ssh ","date":"2023-11-11","objectID":"/posts/2023-11-11-ubuntu/:7:0","tags":["ubuntu","linux"],"title":"ubuntu basic","uri":"/posts/2023-11-11-ubuntu/"},{"categories":["linux åŸºç¡€"],"content":"å…«ã€unsnapd ubuntu ç³»ç»Ÿå¸è½½snap åœæ­¢å¼€æœºè‡ªå¯ sudo systemctl disable snapd.service sudo systemctl disable snapd.socket sudo systemctl disable snapd.seeded.service å¸è½½snapå®‰è£…çš„è½¯ä»¶ # æŸ¥è¯¢å½“å‰ç³»ç»Ÿä¸Šsnapå®‰è£…äº†å“ªäº›app snap list # å¸è½½ sudo snap remove xxxxx_app ç¦æ­¢é‡æ–°å®‰è£…snap sudo vim /etc/apt/preferences.d/nosnap.pref Package: snapd Pin: release a=* Pin-Priority: -10 ","date":"2023-11-11","objectID":"/posts/2023-11-11-ubuntu/:8:0","tags":["ubuntu","linux"],"title":"ubuntu basic","uri":"/posts/2023-11-11-ubuntu/"},{"categories":["linux åŸºç¡€"],"content":"ä¹ã€ç”¨æˆ·ç®¡ç† 1ã€ç”¨æˆ· Ubuntuç³»ç»Ÿä¸­å­˜åœ¨çš„æ˜¯nobodyå’Œnogroup åœ¨ä½¿ç”¨useraddå‘½ä»¤åˆ›å»ºç”¨æˆ·çš„æ—¶å€™ï¼Œubuntuä¸ä¼šä¸ºä¸»åŠ¨ä¸ºç”¨æˆ·åˆ›å»ºå®¶ç›®å½•ï¼Œå…¶é»˜è®¤çš„shellä¹Ÿä¸æ˜¯bash åˆ›å»ºä¸€ä¸ªå…·æœ‰å®¶ç›®å½•çš„ç”¨æˆ·ï¼Œå…¶shellä¸ºbash root@ubuntu:~# useradd -m test3 -s /bin/bash # è‹¥æ²¡æœ‰æŒ‡å®šshellï¼Œå¯ä»¥è¿›è¡Œä¿®æ”¹ root@ubuntu:~# chsh -s /bin/bash test1 2ã€åˆ›å»ºç”¨æˆ·ï¼Œéäº¤äº’å¼æ›´æ”¹å¯†ç  root@ubuntu:~# useradd tom root@ubuntu:~# echo tom:jerry | chpasswd æ ¼å¼ï¼šecho username:password | chpasswd 3ã€sudoæƒé™å…å¯† root@ubuntu:~# vim /etc/sudoers ops_serialt ALL=(ALL) NOPASSWD: ALL 4ã€ubuntu 2004é‡ç½®å¯†ç  å‚è€ƒé“¾æ¥ï¼šhttps://blog.51cto.com/u_15169172/2793265 1ï¼‰é‡å¯æœåŠ¡å™¨åæŒ‰eè¿›å…¥grubèœå• 2ï¼‰åœ¨linuxçš„ä¸€è¡Œçš„æœ€åä¿®æ”¹ä¸ºrw init=/bin/bash 3ï¼‰æŒ‰ctrl + xå¯åŠ¨ç³»ç»Ÿ æŒ‰ä¸‹Ctrl+cå¯ä»¥æ’¤é”€ç™»å½• 4ï¼‰æŸ¥çœ‹æ ¹ç›®å½•æ˜¯å¦æœ‰å†™çš„æƒé™ï¼šmount | grep -w / 5ï¼‰é‡ç½®å¯†ç  ç¡®è®¤æ ¹ç›®å½•æ­£å¤„äºrwçŠ¶æ€åï¼Œé‚£å°±å¯ä»¥ç›´æ¥é‡ç½®æˆ–ç ´è§£Ubuntu 20.04ä»»ä½•ç”¨æˆ·çš„å¯†ç äº†ã€‚ é‡ç½®rootå¯†ç ï¼š passwd root 6ï¼‰é‡å¯ å®Œæˆé‡ç½®å¯†ç æˆ–è€…ç ´è§£å¯†ç çš„å·¥ä½œåï¼Œé‡å¯Ubuntu 20.04ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤é‡å¯æœåŠ¡å™¨ï¼š exec /sbin/init ","date":"2023-11-11","objectID":"/posts/2023-11-11-ubuntu/:9:0","tags":["ubuntu","linux"],"title":"ubuntu basic","uri":"/posts/2023-11-11-ubuntu/"},{"categories":["DevOps"],"content":"WSL2 windowsä¸Šåˆ°linux(windows sub system for linux ) ","date":"2023-11-11","objectID":"/posts/2023-11-11-wsl/:1:0","tags":["wsl","wsl-2","wsl-windows"],"title":"wsl","uri":"/posts/2023-11-11-wsl/"},{"categories":["DevOps"],"content":"ä¸€ã€å®‰è£… wsl 2 å¦‚æœç³»ç»Ÿä¸­å¸¦æœ‰ wslï¼Œåˆ™éœ€è¦å‡çº§åˆ° wsl 2ã€‚ ä»¥ç®¡ç†å‘˜èº«ä»½æ‰“å¼€ PowerShellï¼ˆâ€œå¼€å§‹â€èœå• \u003eâ€œPowerShellâ€\u003e å•å‡»å³é”® \u003eâ€œä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œâ€ï¼‰ï¼Œç„¶åè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart å¯åŠ¨è™šæ‹ŸåŒ–åŠŸèƒ½ï¼Œç„¶åé‡å¯windows dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart ä¸‹è½½ linux å†…æ ¸æ›´æ–°åŒ… https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi ä¿®æ”¹ wsl 2 ä¸ºé»˜è®¤çš„ç‰ˆæœ¬ wsl --set-default-version 2 ä¸‹è½½ linux å‘è¡Œç‰ˆ Ubuntu 20.04 Ubuntu 20.04 ARM Ubuntu 18.04 Ubuntu 18.04 ARM Ubuntu 16.04 Debian GNU/Linux Kali Linux SUSE Linux Enterprise Server 12 SUSE Linux Enterprise Server 15 SP2 openSUSE Leap 15.2 Fedora Remix for WSL å°†è·å¾— \u003cdistro\u003e.appx åŒ… å¯¼å…¥ç³»ç»Ÿ app-name æ˜¯ Linux å‘è¡Œç‰ˆ .appx æ–‡ä»¶çš„åç§°ã€‚ Add-AppxPackage .\\app_name.appx ","date":"2023-11-11","objectID":"/posts/2023-11-11-wsl/:1:1","tags":["wsl","wsl-2","wsl-windows"],"title":"wsl","uri":"/posts/2023-11-11-wsl/"},{"categories":["DevOps"],"content":"äºŒã€wsl åŸºæœ¬å‘½ä»¤ wsl å¸¸ç”¨å‘½ä»¤ # å®‰è£…ç‰¹å®šçš„linuxå‘è¡Œç‰ˆ wsl -d \u003cDistribution Name\u003e # åˆ—å‡ºå¯ç”¨çš„ Linux å‘è¡Œç‰ˆ wsl -l -o # åˆ—å‡ºå·²å®‰è£…çš„ Linux å‘è¡Œç‰ˆ wsl --list --verbose # å°† WSL ç‰ˆæœ¬è®¾ç½®ä¸º 1 æˆ– 2 wsl --set-version 2 # è®¾ç½®é»˜è®¤ WSL ç‰ˆæœ¬ wsl --set-default-version \u003cVersion\u003e wsl --set-default-version 2 # è®¾ç½®é»˜è®¤ Linux å‘è¡Œç‰ˆ wsl --set-default \u003cDistribution Name\u003e # å°†ç›®å½•æ›´æ”¹ä¸ºä¸»é¡µ wsl ~ # é€šè¿‡ PowerShell æˆ– CMD è¿è¡Œç‰¹å®šçš„ Linux å‘è¡Œç‰ˆ wsl --distribution \u003cDistribution Name\u003e --user \u003cUser Name\u003e # å¯åŠ¨ä¸€ä¸ªå‘è¡Œç‰ˆ wsl -d Ubuntu-20.04 -u root æ›´æ–° WSL wsl --update å›æ»šwslç‰ˆæœ¬ wsl --update rollback æ£€æŸ¥ WSL çŠ¶æ€ wsl --status ä»¥ç‰¹å®šç”¨æˆ·çš„èº«ä»½è¿è¡Œ wsl -u \u003cUsername\u003e æ›´æ”¹å‘è¡Œç‰ˆçš„é»˜è®¤ç”¨æˆ· \u003cDistributionName\u003e config --default-user \u003cUsername\u003e # ubuntu config --default-user johndoe ä¼šå°† Ubuntu å‘è¡Œç‰ˆçš„é»˜è®¤ç”¨æˆ·æ›´æ”¹ä¸ºâ€œjohndoeâ€ç”¨æˆ·ã€‚ å…³é—­ wsl --shutdown å†…å­˜é™åˆ¶ .wslconfig æ–‡ä»¶ å…³é—­ä¸€ä¸ªå‘è¡Œç‰ˆ wsl --terminate \u003cDistribution Name\u003e å°†å‘è¡Œç‰ˆå¯¼å‡ºåˆ° TAR æ–‡ä»¶ wsl --export \u003cDistribution Name\u003e \u003cFileName\u003e å¯¼å…¥æ–°å‘è¡Œç‰ˆ wsl --import \u003cDistribution Name\u003e \u003cInstallLocation\u003e \u003cFileName\u003e æ³¨é”€æˆ–å¸è½½ Linux å‘è¡Œç‰ˆï¼Œæ³¨é”€åå°±è¢«åˆ é™¤ï¼Œæ³¨æ„ï¼ï¼ï¼ wsl --unregister \u003cDistributionName\u003e è£…è½½ç£ç›˜æˆ–è®¾å¤‡ wsl --mount \u003cDiskPath\u003e å®‰è£…ç‰¹å®šçš„linuxå‘è¡Œç‰ˆ wsl -d \u003cDistribution Name\u003e wsl é…ç½®æ–‡ä»¶ https://docs.microsoft.com/zh-cn/windows/wsl/wsl-config ","date":"2023-11-11","objectID":"/posts/2023-11-11-wsl/:1:2","tags":["wsl","wsl-2","wsl-windows"],"title":"wsl","uri":"/posts/2023-11-11-wsl/"},{"categories":["DevOps"],"content":"ä¸‰ã€å‘è¡Œç‰ˆç»´æŠ¤ 1ã€è¿ç§»å·¥ä½œç›®å½• wsl é»˜è®¤å®‰è£…cç›˜é‡Œï¼Œcç›˜å› ä¸ºç¡¬ç›˜åˆ†åŒºçš„é—®é¢˜ï¼Œå¯èƒ½åˆ†é…ç©ºé—´æ¯”è¾ƒå°ï¼Œå› æ­¤å¯èƒ½å­˜åœ¨éœ€è¦è¿ç§»çš„æ“ä½œã€‚ 1ï¼‰å…³é—­è¿è¡Œçš„ç³»ç»Ÿ PS C:\\Users\\serialt\u003e PS C:\\Users\\serialt\u003e wsl -l -v NAME STATE VERSION * Ubuntu-20.04 Running 2 docker-desktop Stopped 2 docker-desktop-data Stopped 2 PS C:\\Users\\serialt\u003e wsl --shutdown PS C:\\Users\\serialt\u003e wsl -l -v NAME STATE VERSION * Ubuntu-20.04 Stopped 2 docker-desktop Stopped 2 docker-desktop-data Stopped 2 PS C:\\Users\\serialt\u003e 2ï¼‰å¯¼å‡ºä¸å¯¼å…¥å‘è¡Œç‰ˆ wsl --export docker-desktop-data \"E:\\wsl\\docker-data\\docker-desktop-data.tar\" wsl --unregister docker-desktop-data wsl --import docker-desktop-data D:\\docker\\desktop \"E:\\wsl\\docker-data\\docker-desktop-data.tar\" --version 2 wsl --export docker-desktop \"E:\\wsl\\docker-data\\docker-desktop.tar\" wsl --unregister docker-desktop wsl --import docker-desktop D:\\docker\\desktop \"E:\\wsl\\docker-data\\docker-desktop.tar\" --version 2 ","date":"2023-11-11","objectID":"/posts/2023-11-11-wsl/:1:3","tags":["wsl","wsl-2","wsl-windows"],"title":"wsl","uri":"/posts/2023-11-11-wsl/"},{"categories":["DevOps"],"content":"å››ã€è‡ªå®šä¹‰å‘è¡Œç‰ˆ å‚è€ƒé“¾æ¥ï¼šhttps://docs.microsoft.com/zh-cn/windows/wsl/use-custom-distro é€šè¿‡ä½¿ç”¨ tar æ–‡ä»¶å¯¼å…¥ä»»ä½• Linux å‘è¡Œç‰ˆï¼Œå¯åœ¨é€‚ç”¨äº Linux çš„ Windows å­ç³»ç»Ÿ (WSL) ä¸­ä½¿ç”¨è¯¥å‘è¡Œç‰ˆï¼ˆå³ä½¿å®ƒä¸åœ¨ Microsoft Store ä¸­æä¾›ï¼‰ã€‚ æœ¬æ–‡æ¼”ç¤ºäº†å¦‚ä½•é€šè¿‡ä½¿ç”¨ Docker å®¹å™¨è·å– Linux å‘è¡Œç‰ˆ CentOS çš„ tar æ–‡ä»¶æ¥å°†å®ƒå¯¼å…¥ï¼Œä»¥ä¾¿ä¸ WSL ä¸€èµ·ä½¿ç”¨ã€‚ æ­¤è¿‡ç¨‹å¯åº”ç”¨äºå¯¼å…¥ä»»ä½• Linux å‘è¡Œç‰ˆã€‚ 1ã€è·å–å‘è¡Œç‰ˆçš„taræ–‡ä»¶ é¦–å…ˆï¼Œéœ€è¦è·å–ä¸€ä¸ª tar æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«å‘è¡Œç‰ˆçš„æ‰€æœ‰ Linux äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ å¯é€šè¿‡å¤šç§æ–¹å¼è·å– tar æ–‡ä»¶ï¼Œå…¶ä¸­ä¸¤ç§æ–¹å¼åŒ…æ‹¬ï¼š ä¸‹è½½æä¾›çš„ tar æ–‡ä»¶ã€‚ å¯åœ¨ Alpine Linux ä¸‹è½½ç«™ç‚¹çš„â€œå¾®å‹æ ¹æ–‡ä»¶ç³»ç»Ÿâ€éƒ¨åˆ†æ‰¾åˆ° Alpine çš„ç¤ºä¾‹ã€‚ æŸ¥æ‰¾ Linux å‘è¡Œç‰ˆå®¹å™¨ï¼Œå°†å®ä¾‹å¯¼å‡ºä¸º tar æ–‡ä»¶ã€‚ ä»¥ä¸‹ç¤ºä¾‹å°†ä½¿ç”¨ CentOS å®¹å™¨æ¼”ç¤ºæ­¤è¿‡ç¨‹ã€‚ è·å–CentOSçš„taræ–‡ä»¶ ä»å®¹å™¨ä¸­å¯¼å‡ºtaræ–‡ä»¶ [root@tc tabby]# docker pull rockylinux Using default tag: latest latest: Pulling from library/rockylinux 72a2451028f1: Pull complete Digest: sha256:5fed5497b568bcf7a90a00965987fc099edbcf44b1179a5ef6d4b47758281ca5 Status: Downloaded newer image for rockylinux:latest docker.io/library/rockylinux:latest [root@tc tabby]# docker run -tid --name=rocky rockylinux 38b201fca776cc1aadf029cbf5a1d6a1fb57ff62f5d71d4ed0416d870b407550 [root@tc tabby]# docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 38b201fca776 rockylinux \"/bin/bash\" 4 seconds ago Up 2 seconds rocky [root@tc tabby]# [root@tc tabby]# dockerContainerID=$(docker container ls -a | grep -i rocky | awk '{print $1}') [root@tc tabby]# docker export $dockerContainerID \u003e /mnt/e/rocky.tar [root@tc tabby]# du -sh /mnt/e/rocky.tar 202M /mnt/e/rocky.tar 2ã€å¯¼å…¥åˆ°wslä¸­ å‡†å¤‡å¥½ tar æ–‡ä»¶åï¼Œå¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯¼å…¥å®ƒï¼šwsl --import \u003cDistro\u003e \u003cInstallLocation\u003e \u003cFileName\u003eã€‚ # åˆ›å»ºå¥½å­˜å‚¨å‘è¡Œç‰ˆçš„ç›®å½• cd E:\\wsl2 mkdir E:\\wsl2\\Rocky # å¯¼å…¥taræ–‡ä»¶ PS E:\\wsl2\u003e wsl --import Rocky E:\\wsl2\\Rocky ..\\rocky.tar PS E:\\wsl2\u003e wsl -l -v NAME STATE VERSION * docker-desktop-data Stopped 2 Rocky Stopped 2 docker-desktop Stopped 2 Ubuntu-20.04 Running 2 PS E:\\wsl2\u003e 3ã€å¯åŠ¨ wsl -d Rocky -u root è‡ªå®šä¹‰çš„å‘è¡Œç‰ˆå¯èƒ½å­˜åœ¨å› ä½¿ç”¨systemç®¡ç†æœåŠ¡è€Œæ— æ³•ä½¿ç”¨serviceå»ç®¡ç†æœåŠ¡ ","date":"2023-11-11","objectID":"/posts/2023-11-11-wsl/:1:4","tags":["wsl","wsl-2","wsl-windows"],"title":"wsl","uri":"/posts/2023-11-11-wsl/"},{"categories":["DevOps"],"content":"äº”ã€wsl é…ç½®æ–‡ä»¶ 1ã€wsl.conf â€‹```toml [root@tc tcs]# cat /etc/wsl.conf # Automatically mount Windows drive when the distribution is launched [automount] # Set to true will automount fixed drives (C:/ or D:/) with DrvFs under the root directory set above. Set to false means drives won't be mounted automatically, but need to be mounted manually or with fstab. enabled = true # Sets the directory where fixed drives will be automatically mounted. This example changes the mount location, so your C-drive would be /c, rather than the default /mnt/c. #root = /mnt/d/serialt/ # DrvFs-specific options can be specified. options = \"metadata,uid=1003,gid=1003,umask=077,fmask=11,case=off\" # Sets the `/etc/fstab` file to be processed when a WSL distribution is launched. mountFsTab = true # Network host settings that enable the DNS server used by WSL 2. This example changes the hostname, sets generateHosts to false, preventing WSL from the default behavior of auto-generating /etc/hosts, and sets generateResolvConf to false, preventing WSL from auto-generating /etc/resolv.conf, so that you can create your own (ie. nameserver 1.1.1.1). [network] hostname = tc generateHosts = true generateResolvConf = true # Set whether WSL supports interop process like launching Windows apps and adding path variables. Setting these to false will block the launch of Windows processes and block adding $PATH environment variables. [interop] enabled = false appendWindowsPath = true # Set the user when launching a distribution with WSL. [user] default = root # Set a command to run when a new WSL instance launches. This example starts the Docker container service. [boot] command = service docker start [root@tc tcs]# â€‹``` ","date":"2023-11-11","objectID":"/posts/2023-11-11-wsl/:1:5","tags":["wsl","wsl-2","wsl-windows"],"title":"wsl","uri":"/posts/2023-11-11-wsl/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"gopsutil åº“ å‚è€ƒé“¾æ¥ï¼šhttps://segmentfault.com/a/1190000022281174 ","date":"2023-11-11","objectID":"/posts/2023-11-11-gopsutil/:1:0","tags":["Go","gopsutil"],"title":"Go gopsutil","uri":"/posts/2023-11-11-gopsutil/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"ç®€ä»‹ gopsutilæ˜¯ Python å·¥å…·åº“psutil çš„ Golang ç§»æ¤ç‰ˆï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ–¹ä¾¿åœ°è·å–å„ç§ç³»ç»Ÿå’Œç¡¬ä»¶ä¿¡æ¯ã€‚gopsutilä¸ºæˆ‘ä»¬å±è”½äº†å„ä¸ªç³»ç»Ÿä¹‹é—´çš„å·®å¼‚ï¼Œå…·æœ‰éå¸¸å¼ºæ‚çš„å¯ç§»æ¤æ€§ã€‚æœ‰äº†gopsutilï¼Œæˆ‘ä»¬ä¸å†éœ€è¦é’ˆå¯¹ä¸åŒçš„ç³»ç»Ÿä½¿ç”¨syscallè°ƒç”¨å¯¹åº”çš„ç³»ç»Ÿæ–¹æ³•ã€‚æ›´æ£’çš„æ˜¯gopsutilçš„å®ç°ä¸­æ²¡æœ‰ä»»ä½•cgoçš„ä»£ç ï¼Œä½¿å¾—äº¤å‰ç¼–è¯‘æˆä¸ºå¯èƒ½ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-gopsutil/:1:1","tags":["Go","gopsutil"],"title":"Go gopsutil","uri":"/posts/2023-11-11-gopsutil/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å¿«é€Ÿä½¿ç”¨ å®‰è£… go get github.com/shirou/gopsutil ä½¿ç”¨ package main import ( \"fmt\" \"github.com/shirou/gopsutil/mem\" ) func main() { v, _ := mem.VirtualMemory() fmt.Printf(\"Total: %v, Available: %v, UsedPercent:%f%%\\n\", v.Total, v.Available, v.UsedPercent) fmt.Println(v) } gopsutilå°†ä¸åŒçš„åŠŸèƒ½åˆ’åˆ†åˆ°ä¸åŒçš„å­åŒ…ä¸­ï¼š cpuï¼šCPU ç›¸å…³ï¼› diskï¼šç£ç›˜ç›¸å…³ï¼› dockerï¼šdocker ç›¸å…³ï¼› hostï¼šä¸»æœºç›¸å…³ï¼› memï¼šå†…å­˜ç›¸å…³ï¼› netï¼šç½‘ç»œç›¸å…³ï¼› processï¼šè¿›ç¨‹ç›¸å…³ï¼› winservicesï¼šWindows æœåŠ¡ç›¸å…³ã€‚ æƒ³è¦ä½¿ç”¨å¯¹åº”çš„åŠŸèƒ½ï¼Œè¦å¯¼å…¥å¯¹åº”çš„å­åŒ…ã€‚ä¾‹å¦‚ï¼Œä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬è¦è·å–å†…å­˜ä¿¡æ¯ï¼Œå¯¼å…¥çš„æ˜¯memå­åŒ…ã€‚mem.VirtualMemory()æ–¹æ³•è¿”å›å†…å­˜ä¿¡æ¯ç»“æ„mem.VirtualMemoryStatï¼Œè¯¥ç»“æ„æœ‰ä¸°å¯Œçš„å­—æ®µï¼Œæˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„æ— å¤–ä¹Totalï¼ˆæ€»å†…å­˜ï¼‰ã€Availableï¼ˆå¯ç”¨å†…å­˜ï¼‰ã€Usedï¼ˆå·²ä½¿ç”¨å†…å­˜ï¼‰å’ŒUsedPercentï¼ˆå†…å­˜ä½¿ç”¨ç™¾åˆ†æ¯”ï¼‰ã€‚mem.VirtualMemoryStatè¿˜å®ç°äº†fmt.Stringeræ¥å£ï¼Œä»¥ JSON æ ¼å¼è¿”å›å†…å­˜ä¿¡æ¯ã€‚è¯­å¥fmt.Println(v)ä¼šè‡ªåŠ¨è°ƒç”¨v.String()ï¼Œå°†è¿”å›ä¿¡æ¯è¾“å‡ºã€‚ç¨‹åºè¾“å‡ºï¼š Total: 8526921728, Available: 3768975360, UsedPercent:55.000000% {\"total\":8526921728,\"available\":3768975360,\"used\":4757946368,\"usedPercent\":55,\"free\":0,\"active\":0,\"inactive\":0,\"wired\":0,\"laundry\":0,\"buffers\":0,\"cached\":0,\"writeback\":0,\"dirty\":0,\"writebacktmp\":0,\"shared\":0,\"slab\":0,\"sreclaimable\":0,\"sunreclaim\":0,\"pagetables\":0,\"swapcached\":0,\"commitlimit\":0,\"committedas\":0,\"hightotal\":0,\"highfree\":0,\"lowtotal\":0,\"lowfree\":0,\"swaptotal\":0,\"swapfree\":0,\"mapped\":0,\"vmalloctotal\":0,\"vmallocused\":0,\"vmallocchunk\":0,\"hugepagestotal\":0,\"hugepagesfree\":0,\"hugepagesize\":0} å•ä½ä¸ºå­—èŠ‚ï¼Œæˆ‘çš„ç”µè„‘å†…å­˜ 8GBï¼Œå½“å‰ä½¿ç”¨ç™¾åˆ†æ¯”ä¸º 55%ï¼Œå¯ç”¨å†…å­˜ 3768975360Bï¼ˆå³ 3.51GBï¼‰ã€‚ CPU æˆ‘ä»¬çŸ¥é“ CPU çš„æ ¸æ•°æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ç‰©ç†æ ¸æ•°ï¼Œä¸€ç§æ˜¯é€»è¾‘æ ¸æ•°ã€‚ç‰©ç†æ ¸æ•°å°±æ˜¯ä¸»æ¿ä¸Šå®é™…æœ‰å¤šå°‘ä¸ª CPUï¼Œä¸€ä¸ªç‰©ç† CPU ä¸Šå¯ä»¥æœ‰å¤šä¸ªæ ¸å¿ƒï¼Œè¿™äº›æ ¸å¿ƒè¢«ç§°ä¸ºé€»è¾‘æ ¸ã€‚gopsutilä¸­ CPU ç›¸å…³åŠŸèƒ½åœ¨cpuå­åŒ…ä¸­ï¼Œcpuå­åŒ…æä¾›äº†è·å–ç‰©ç†å’Œé€»è¾‘æ ¸æ•°ã€CPU ä½¿ç”¨ç‡çš„æ¥å£ï¼š Counts(logical bool)ï¼šä¼ å…¥falseï¼Œè¿”å›ç‰©ç†æ ¸æ•°ï¼Œä¼ å…¥trueï¼Œè¿”å›é€»è¾‘æ ¸æ•°ï¼› Percent(interval time.Duration, percpu bool)ï¼šè¡¨ç¤ºè·å–intervalæ—¶é—´é—´éš”å†…çš„ CPU ä½¿ç”¨ç‡ï¼Œpercpuä¸ºfalseæ—¶ï¼Œè·å–æ€»çš„ CPU ä½¿ç”¨ç‡ï¼Œpercpuä¸ºtrueæ—¶ï¼Œåˆ†åˆ«è·å–æ¯ä¸ª CPU çš„ä½¿ç”¨ç‡ï¼Œè¿”å›ä¸€ä¸ª[]float64ç±»å‹çš„å€¼ã€‚ ä¾‹å¦‚ï¼š func main() { physicalCnt, _ := cpu.Counts(false) logicalCnt, _ := cpu.Counts(true) fmt.Printf(\"physical count:%d logical count:%d\\n\", physicalCnt, logicalCnt) totalPercent, _ := cpu.Percent(3*time.Second, false) perPercents, _ := cpu.Percent(3*time.Second, true) fmt.Printf(\"total percent:%v per percents:%v\", totalPercent, perPercents) } ä¸Šé¢ä»£ç è·å–ç‰©ç†æ ¸æ•°å’Œé€»è¾‘æ ¸æ•°ï¼Œå¹¶è·å– 3s å†…çš„æ€» CPU ä½¿ç”¨ç‡å’Œæ¯ä¸ª CPU å„è‡ªçš„ä½¿ç”¨ç‡ï¼Œç¨‹åºè¾“å‡ºï¼ˆæ³¨æ„æ¯æ¬¡è¿è¡Œè¾“å‡ºå¯èƒ½éƒ½ä¸ç›¸åŒï¼‰ï¼š physical count:4 logical count:8 total percent:[30.729166666666668] per percents:[32.64248704663213 26.94300518134715 44.559585492227974 23.958333333333336 36.787564766839374 20.3125 38.54166666666667 28.125] è¯¦ç»†ä¿¡æ¯è°ƒç”¨cpu.Info()å¯è·å– CPU çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¿”å›[]cpu.InfoStatï¼š func main() { infos, _ := cpu.Info() for _, info := range infos { data, _ := json.MarshalIndent(info, \"\", \" \") fmt.Print(string(data)) } } ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹ï¼Œæˆ‘ä½¿ç”¨ JSON è¾“å‡ºç»“æœï¼š { \"cpu\": 0, \"vendorId\": \"GenuineIntel\", \"family\": \"198\", \"model\": \"\", \"stepping\": 0, \"physicalId\": \"BFEBFBFF000906E9\", \"coreId\": \"\", \"cores\": 8, \"modelName\": \"Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz\", \"mhz\": 3601, \"cacheSize\": 0, \"flags\": [], \"microcode\": \"\" } ç”±ç»“æœå¯ä»¥çœ‹å‡ºï¼ŒCPU æ˜¯ Intel çš„ i7-7700 ç³»åˆ—ï¼Œé¢‘ç‡ 3.60GHzã€‚ä¸Šé¢æ˜¯æˆ‘åœ¨ Windows ä¸Šè¿è¡Œçš„è¿”å›ç»“æœï¼Œå†…éƒ¨ä½¿ç”¨äº†github.com/StackExchange/wmiåº“ã€‚åœ¨ Linux ä¸‹æ¯ä¸ªé€»è¾‘ CPU éƒ½ä¼šè¿”å›ä¸€ä¸ªInfoStatç»“æ„ã€‚ æ—¶é—´å ç”¨ è°ƒç”¨cpu.Times(percpu bool)å¯ä»¥è·å–ä»å¼€æœºç®—èµ·ï¼Œæ€» CPU å’Œ æ¯ä¸ªå•ç‹¬çš„ CPU æ—¶é—´å ç”¨æƒ…å†µã€‚ä¼ å…¥percpu=falseè¿”å›æ€»çš„ï¼Œä¼ å…¥percpu=trueè¿”å›å•ä¸ªçš„ã€‚æ¯ä¸ª CPU æ—¶é—´å ç”¨æƒ…å†µæ˜¯ä¸€ä¸ªTimeStatç»“æ„ï¼š // src/github.com/shirou/gopsutil/cpu/cpu.go type TimesStat struct { CPU string `json:\"cpu\"` User float64 `json:\"user\"` System float64 `json:\"system\"` Idle float64 `json:\"idle\"` Nice float64 `json:\"nice\"` Iowait float64 `json:\"iowait\"` Irq float64 `json:\"irq\"` Softirq float64 `json:\"softirq\"` Steal float64 `json:\"steal\"` Guest float64 `json:\"guest\"` GuestNice float64 `json:\"guestNice\"` } CPUï¼šCPU æ ‡è¯†ï¼Œå¦‚æœæ˜¯æ€»çš„ï¼Œè¯¥å­—æ®µä¸ºcpu-totalï¼Œå¦åˆ™ä¸ºcpu0ã€cpu1â€¦ï¼› Userï¼šç”¨æˆ·æ—¶é—´å ç”¨ï¼ˆç”¨æˆ·æ€ï¼‰ï¼› Systemï¼šç³»ç»Ÿæ—¶é—´å ç”¨ï¼ˆå†…æ ¸æ€ï¼‰ï¼› Idleï¼šç©ºé—²æ—¶é—´ï¼› â€¦ ä¾‹å¦‚ï¼š func main() { infos, _ := cpu.Times(true) for _, info := range infos { data, _ := json.MarshalIndent(info, \"\", \" \") fmt.Print(string(data)) } } ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹ï¼Œæˆ‘ç”¨ JSON è¾“å‡ºç»“æœï¼Œä¸‹é¢æ˜¯å…¶ä¸­ä¸€ä¸ªè¾“å‡ºï¼š { \"cpu\": \"cpu0\", \"user\": 674.46875, \"system\": 1184.984375, \"idle\": 7497.1875, \"nice\": 0, \"iowait\": 0, \"irq\": 75.578125, \"softirq\": 0, \"steal\": 0, \"guest\": 0, \"guestNice\": 0 } ç£ç›˜ å­åŒ…diskç”¨äºè·å–ç£ç›˜ä¿¡æ¯ã€‚diskå¯è·å– IO ç»Ÿè®¡ã€åˆ†åŒºå’Œä½¿ç”¨ç‡ä¿¡æ¯ã€‚ä¸‹é¢ä¾æ¬¡ä»‹ç»ã€‚ IO ç»Ÿè®¡ è°ƒç”¨disk.IOCounters()å‡½æ•°ï¼Œè¿”å›çš„ IO ç»Ÿè®¡ä¿¡æ¯ç”¨map[string]IOCountersStatç±»å‹è¡¨ç¤ºã€‚æ¯ä¸ªåˆ†åŒºä¸€ä¸ªç»“æ„ï¼Œé”®ä¸ºåˆ†åŒºåï¼Œå€¼ä¸ºç»Ÿè®¡ä¿¡æ¯ã€‚è¿™é‡Œæ‘˜å–ç»Ÿè®¡","date":"2023-11-11","objectID":"/posts/2023-11-11-gopsutil/:1:2","tags":["Go","gopsutil"],"title":"Go gopsutil","uri":"/posts/2023-11-11-gopsutil/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go è¯»å–yamlæ ¼å¼é…ç½®æ–‡ä»¶ package config import ( \"fmt\" \"io/ioutil\" \"gopkg.in/yaml.v3\" ) type Service struct { Host string `json:\"host\" yaml:\"host\"` Port string `json:\"port\" yaml:\"port\"` } type MyConfig struct { Service Service `json:\"service\" yaml:\"service\"` } var Config *MyConfig func LoadConfig(filepath string) { if filepath == \"\" { return } // è¯»yamlæ–‡ä»¶ config, err := ioutil.ReadFile(filepath) if err != nil { fmt.Printf(\"read config failed, please check the path: %v , err: %v\", filepath, err) } err = yaml.Unmarshal(config, \u0026Config) if err != nil { fmt.Printf(\"Unmarshal to struct, err: %v\", err) } fmt.Printf(\"LoadConfig: %v\", Config) } // å†™yamlæ–‡ä»¶ data, err := yaml.Marshal(SkopeoData) if err != nil { slog.Error(\"yaml marshal failed\", \"err\", err) return } err = os.WriteFile(config.AutoSyncfile, data, 0644) if err != nil { slog.Error(\"Write auto sync data to file failed\", \"err\", err) } ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-yaml/:1:0","tags":["Go","yaml"],"title":"Go yaml","uri":"/posts/2023-11-11-go-yaml/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Goè¯­è¨€å†…ç½®åŒ…ä¹‹strconv Goè¯­è¨€ä¸­strconvåŒ…å®ç°äº†åŸºæœ¬æ•°æ®ç±»å‹å’Œå…¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„ç›¸äº’è½¬æ¢ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-strconv/:0:0","tags":["Go","strconv"],"title":"Go strconv","uri":"/posts/2023-11-11-go-strconv/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"strconvåŒ… strconvåŒ…å®ç°äº†åŸºæœ¬æ•°æ®ç±»å‹ä¸å…¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„è½¬æ¢ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å¸¸ç”¨å‡½æ•°ï¼š Atoi()ã€Itia()ã€parseç³»åˆ—ã€formatç³»åˆ—ã€appendç³»åˆ—ã€‚ æ›´å¤šå‡½æ•°è¯·æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-strconv/:0:1","tags":["Go","strconv"],"title":"Go strconv","uri":"/posts/2023-11-11-go-strconv/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"stringä¸intç±»å‹è½¬æ¢ è¿™ä¸€ç»„å‡½æ•°æ˜¯æˆ‘ä»¬å¹³æ—¶ç¼–ç¨‹ä¸­ç”¨çš„æœ€å¤šçš„ã€‚ Atoi() Atoi()å‡½æ•°ç”¨äºå°†å­—ç¬¦ä¸²ç±»å‹çš„æ•´æ•°è½¬æ¢ä¸ºintç±»å‹ï¼Œå‡½æ•°ç­¾åå¦‚ä¸‹ã€‚ func Atoi(s string) (i int, err error) å¦‚æœä¼ å…¥çš„å­—ç¬¦ä¸²å‚æ•°æ— æ³•è½¬æ¢ä¸ºintç±»å‹ï¼Œå°±ä¼šè¿”å›é”™è¯¯ã€‚ s1 := \"100\" i1, err := strconv.Atoi(s1) if err != nil { fmt.Println(\"can't convert to int\") } else { fmt.Printf(\"type:%T value:%#v\\n\", i1, i1) //type:int value:100 } Itoa() Itoa()å‡½æ•°ç”¨äºå°†intç±»å‹æ•°æ®è½¬æ¢ä¸ºå¯¹åº”çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œå…·ä½“çš„å‡½æ•°ç­¾åå¦‚ä¸‹ã€‚ func Itoa(i int) string ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š i2 := 200 s2 := strconv.Itoa(i2) fmt.Printf(\"type:%T value:%#v\\n\", s2, s2) //type:string value:\"200\" açš„å…¸æ•… ã€æ‰©å±•é˜…è¯»ã€‘è¿™æ˜¯Cè¯­è¨€é—ç•™ä¸‹çš„å…¸æ•…ã€‚Cè¯­è¨€ä¸­æ²¡æœ‰stringç±»å‹è€Œæ˜¯ç”¨å­—ç¬¦æ•°ç»„(array)è¡¨ç¤ºå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥Itoaå¯¹å¾ˆå¤šCç³»çš„ç¨‹åºå‘˜å¾ˆå¥½ç†è§£ã€‚ Parseç³»åˆ—å‡½æ•° Parseç±»å‡½æ•°ç”¨äºè½¬æ¢å­—ç¬¦ä¸²ä¸ºç»™å®šç±»å‹çš„å€¼ï¼šParseBool()ã€ParseFloat()ã€ParseInt()ã€ParseUint()ã€‚ ParseBool() func ParseBool(str string) (value bool, err error) è¿”å›å­—ç¬¦ä¸²è¡¨ç¤ºçš„boolå€¼ã€‚å®ƒæ¥å—1ã€0ã€tã€fã€Tã€Fã€trueã€falseã€Trueã€Falseã€TRUEã€FALSEï¼›å¦åˆ™è¿”å›é”™è¯¯ã€‚ ParseInt() func ParseInt(s string, base int, bitSize int) (i int64, err error) è¿”å›å­—ç¬¦ä¸²è¡¨ç¤ºçš„æ•´æ•°å€¼ï¼Œæ¥å—æ­£è´Ÿå·ã€‚ baseæŒ‡å®šè¿›åˆ¶ï¼ˆ2åˆ°36ï¼‰ï¼Œå¦‚æœbaseä¸º0ï¼Œåˆ™ä¼šä»å­—ç¬¦ä¸²å‰ç½®åˆ¤æ–­ï¼Œâ€0xâ€æ˜¯16è¿›åˆ¶ï¼Œâ€0â€æ˜¯8è¿›åˆ¶ï¼Œå¦åˆ™æ˜¯10è¿›åˆ¶ï¼› bitSizeæŒ‡å®šç»“æœå¿…é¡»èƒ½æ— æº¢å‡ºèµ‹å€¼çš„æ•´æ•°ç±»å‹ï¼Œ0ã€8ã€16ã€32ã€64 åˆ†åˆ«ä»£è¡¨ intã€int8ã€int16ã€int32ã€int64ï¼› è¿”å›çš„erræ˜¯*NumErrç±»å‹çš„ï¼Œå¦‚æœè¯­æ³•æœ‰è¯¯ï¼Œerr.Error = ErrSyntaxï¼›å¦‚æœç»“æœè¶…å‡ºç±»å‹èŒƒå›´err.Error = ErrRangeã€‚ ParseUnit() func ParseUint(s string, base int, bitSize int) (n uint64, err error) ParseUintç±»ä¼¼ParseIntä½†ä¸æ¥å—æ­£è´Ÿå·ï¼Œç”¨äºæ— ç¬¦å·æ•´å‹ã€‚ ParseFloat() func ParseFloat(s string, bitSize int) (f float64, err error) è§£æä¸€ä¸ªè¡¨ç¤ºæµ®ç‚¹æ•°çš„å­—ç¬¦ä¸²å¹¶è¿”å›å…¶å€¼ã€‚ å¦‚æœsåˆä¹è¯­æ³•è§„åˆ™ï¼Œå‡½æ•°ä¼šè¿”å›æœ€ä¸ºæ¥è¿‘sè¡¨ç¤ºå€¼çš„ä¸€ä¸ªæµ®ç‚¹æ•°ï¼ˆä½¿ç”¨IEEE754è§„èŒƒèˆå…¥ï¼‰ã€‚ bitSizeæŒ‡å®šäº†æœŸæœ›çš„æ¥æ”¶ç±»å‹ï¼Œ32æ˜¯float32ï¼ˆè¿”å›å€¼å¯ä»¥ä¸æ”¹å˜ç²¾ç¡®å€¼çš„èµ‹å€¼ç»™float32ï¼‰ï¼Œ64æ˜¯float64ï¼› è¿”å›å€¼erræ˜¯*NumErrç±»å‹çš„ï¼Œè¯­æ³•æœ‰è¯¯çš„ï¼Œerr.Error=ErrSyntaxï¼›ç»“æœè¶…å‡ºè¡¨ç¤ºèŒƒå›´çš„ï¼Œè¿”å›å€¼fä¸ºÂ±Infï¼Œerr.Error= ErrRangeã€‚ ä»£ç ç¤ºä¾‹ b, err := strconv.ParseBool(\"true\") f, err := strconv.ParseFloat(\"3.1415\", 64) i, err := strconv.ParseInt(\"-2\", 10, 64) u, err := strconv.ParseUint(\"2\", 10, 64) è¿™äº›å‡½æ•°éƒ½æœ‰ä¸¤ä¸ªè¿”å›å€¼ï¼Œç¬¬ä¸€ä¸ªè¿”å›å€¼æ˜¯è½¬æ¢åçš„å€¼ï¼Œç¬¬äºŒä¸ªè¿”å›å€¼ä¸ºè½¬åŒ–å¤±è´¥çš„é”™è¯¯ä¿¡æ¯ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-strconv/:0:2","tags":["Go","strconv"],"title":"Go strconv","uri":"/posts/2023-11-11-go-strconv/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Formatç³»åˆ—å‡½æ•° Formatç³»åˆ—å‡½æ•°å®ç°äº†å°†ç»™å®šç±»å‹æ•°æ®æ ¼å¼åŒ–ä¸ºstringç±»å‹æ•°æ®çš„åŠŸèƒ½ã€‚ FormatBool() func FormatBool(b bool) string æ ¹æ®bçš„å€¼è¿”å›â€trueâ€æˆ–â€falseâ€ã€‚ FormatInt() func FormatInt(i int64, base int) string è¿”å›içš„baseè¿›åˆ¶çš„å­—ç¬¦ä¸²è¡¨ç¤ºã€‚base å¿…é¡»åœ¨2åˆ°36ä¹‹é—´ï¼Œç»“æœä¸­ä¼šä½¿ç”¨å°å†™å­—æ¯â€™aâ€™åˆ°â€™zâ€™è¡¨ç¤ºå¤§äº10çš„æ•°å­—ã€‚ FormatUint() func FormatUint(i uint64, base int) string æ˜¯FormatIntçš„æ— ç¬¦å·æ•´æ•°ç‰ˆæœ¬ã€‚ FormatFloat() func FormatFloat(f float64, fmt byte, prec, bitSize int) string å‡½æ•°å°†æµ®ç‚¹æ•°è¡¨ç¤ºä¸ºå­—ç¬¦ä¸²å¹¶è¿”å›ã€‚ bitSizeè¡¨ç¤ºfçš„æ¥æºç±»å‹ï¼ˆ32ï¼šfloat32ã€64ï¼šfloat64ï¼‰ï¼Œä¼šæ®æ­¤è¿›è¡Œèˆå…¥ã€‚ fmtè¡¨ç¤ºæ ¼å¼ï¼šâ€™fâ€™ï¼ˆ-ddd.ddddï¼‰ã€â€™bâ€™ï¼ˆ-ddddpÂ±dddï¼ŒæŒ‡æ•°ä¸ºäºŒè¿›åˆ¶ï¼‰ã€â€™eâ€™ï¼ˆ-d.ddddeÂ±ddï¼Œåè¿›åˆ¶æŒ‡æ•°ï¼‰ã€â€™Eâ€™ï¼ˆ-d.ddddEÂ±ddï¼Œåè¿›åˆ¶æŒ‡æ•°ï¼‰ã€â€™gâ€™ï¼ˆæŒ‡æ•°å¾ˆå¤§æ—¶ç”¨â€™eâ€™æ ¼å¼ï¼Œå¦åˆ™â€™fâ€™æ ¼å¼ï¼‰ã€â€™Gâ€™ï¼ˆæŒ‡æ•°å¾ˆå¤§æ—¶ç”¨â€™Eâ€™æ ¼å¼ï¼Œå¦åˆ™â€™fâ€™æ ¼å¼ï¼‰ã€‚ precæ§åˆ¶ç²¾åº¦ï¼ˆæ’é™¤æŒ‡æ•°éƒ¨åˆ†ï¼‰ï¼šå¯¹â€™fâ€™ã€â€™eâ€™ã€â€™Eâ€™ï¼Œå®ƒè¡¨ç¤ºå°æ•°ç‚¹åçš„æ•°å­—ä¸ªæ•°ï¼›å¯¹â€™gâ€™ã€â€™Gâ€™ï¼Œå®ƒæ§åˆ¶æ€»çš„æ•°å­—ä¸ªæ•°ã€‚å¦‚æœprec ä¸º-1ï¼Œåˆ™ä»£è¡¨ä½¿ç”¨æœ€å°‘æ•°é‡çš„ã€ä½†åˆå¿…éœ€çš„æ•°å­—æ¥è¡¨ç¤ºfã€‚ ä»£ç ç¤ºä¾‹ s1 := strconv.FormatBool(true) s2 := strconv.FormatFloat(3.1415, 'E', -1, 64) s3 := strconv.FormatInt(-2, 16) s4 := strconv.FormatUint(2, 16) ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-strconv/:0:3","tags":["Go","strconv"],"title":"Go strconv","uri":"/posts/2023-11-11-go-strconv/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å…¶ä»– isPrint() func IsPrint(r rune) bool è¿”å›ä¸€ä¸ªå­—ç¬¦æ˜¯å¦æ˜¯å¯æ‰“å°çš„ï¼Œå’Œunicode.IsPrintä¸€æ ·ï¼Œrå¿…é¡»æ˜¯ï¼šå­—æ¯ï¼ˆå¹¿ä¹‰ï¼‰ã€æ•°å­—ã€æ ‡ç‚¹ã€ç¬¦å·ã€ASCIIç©ºæ ¼ã€‚ CanBackquote() func CanBackquote(s string) bool è¿”å›å­—ç¬¦ä¸²sæ˜¯å¦å¯ä»¥ä¸è¢«ä¿®æ”¹çš„è¡¨ç¤ºä¸ºä¸€ä¸ªå•è¡Œçš„ã€æ²¡æœ‰ç©ºæ ¼å’Œtabä¹‹å¤–æ§åˆ¶å­—ç¬¦çš„åå¼•å·å­—ç¬¦ä¸²ã€‚ å…¶ä»– é™¤ä¸Šæ–‡åˆ—å‡ºçš„å‡½æ•°å¤–ï¼ŒstrconvåŒ…ä¸­è¿˜æœ‰Appendç³»åˆ—ã€Quoteç³»åˆ—ç­‰å‡½æ•°ã€‚å…·ä½“ç”¨æ³•å¯æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-strconv/:0:4","tags":["Go","strconv"],"title":"Go strconv","uri":"/posts/2023-11-11-go-strconv/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go tailåº“ å®æ—¶è¯»å–æ–‡ä»¶å†…å®¹ go get github.com/hpcloud/tail ç¤ºä¾‹ï¼š package main import ( \"fmt\" \"time\" \"github.com/hpcloud/tail\" ) func main() { fileName := \"./my.log\" config := tail.Config{ ReOpen: true, // é‡æ–°æ‰“å¼€ Follow: true, // æ˜¯å¦è·Ÿéš Location: \u0026tail.SeekInfo{Offset: 0, Whence: 2}, // ä»æ–‡ä»¶çš„å“ªä¸ªåœ°æ–¹å¼€å§‹è¯» MustExist: false, // æ–‡ä»¶ä¸å­˜åœ¨ä¸æŠ¥é”™ Poll: true, } tails, err := tail.TailFile(fileName, config) if err != nil { fmt.Println(\"tail file failed, err:\", err) return } var ( line *tail.Line ok bool ) for { line, ok = \u003c-tails.Lines if !ok { fmt.Printf(\"tail file close reopen, filename:%s\\n\", tails.Filename) time.Sleep(time.Second) continue } fmt.Println(\"line:\", line.Text) } } ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-tail/:1:0","tags":["Go","tail"],"title":"Go tail","uri":"/posts/2023-11-11-go-tail/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Goè¯­è¨€æ ‡å‡†åº“netåŒ…ä»‹ç» ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-net/:1:0","tags":["Go","net"],"title":"Go net","uri":"/posts/2023-11-11-go-net/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"ä¸€ã€åŸŸåè§£æ DNS è®°å½•æ˜¯ä¸ DNS æœåŠ¡å™¨å…³è”çš„æ˜ å°„æ–‡ä»¶ï¼Œæ— è®ºæ¯ä¸ªåŸŸåä¸å“ªä¸ª IP åœ°å€å…³è”ï¼Œå®ƒä»¬éƒ½èƒ½å¤„ç†å‘é€åˆ°æ¯ä¸ªåŸŸåçš„è¯·æ±‚ã€‚net åŒ…åŒ…å«å„ç§æ–¹æ³•æ¥æŸ¥æ‰¾ DNS è®°å½•çš„ç»†èŠ‚ã€‚è®©æˆ‘ä»¬è¿è¡Œä¸€äº›ç¤ºä¾‹ï¼Œæ”¶é›†æœ‰å…³ DNS æœåŠ¡å™¨çš„ä¿¡æ¯ä»¥åŠç›®æ ‡åŸŸåçš„ç›¸åº”è®°å½•ï¼š æœ¬æ–‡æ˜¯ Goè¯­è¨€ä¸­æ–‡ç½‘ç»„ç»‡çš„ GCTT ç¿»è¯‘ï¼Œå‘å¸ƒåœ¨ Goè¯­è¨€ä¸­æ–‡ç½‘å…¬ä¼—å·ï¼Œè½¬è½½è¯·è”ç³»æˆ‘ä»¬æˆæƒã€‚ 1ã€Go ç¨‹åºæŸ¥æ‰¾åŸŸåçš„ A è®°å½• net.LookupIP() å‡½æ•°æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆdomain-nameï¼‰å¹¶è¿”å›ä¸€ä¸ªåŒ…å«ä¸»æœºçš„ IPv4 å’Œ IPv6 åœ°å€çš„ net.IP å¯¹è±¡åˆ‡ç‰‡ã€‚ package main import ( \"fmt\" \"net\" ) func main() { iprecords, _ := net.LookupIP(\"facebook.com\") for _, ip := range iprecords { fmt.Println(ip) } } ä¸Šè¿°ç¨‹åºçš„è¾“å‡ºåˆ—å‡ºäº†ä»¥ IPv4 å’Œ IPv6 æ ¼å¼è¿”å›çš„ facebook.com çš„ A è®°å½•ã€‚ C:\\golang\\dns\u003e Go run example1.go 2a03:2880:f12f:83:face:b00c:0:25de 31.13.79.35 2ã€Go ç¨‹åºæŸ¥æ‰¾åŸŸåçš„ CNAME è®°å½• CNAME æ˜¯è§„èŒƒåç§°çš„ç¼©å†™ã€‚CNAME æœ¬è´¨ä¸Šæ˜¯ç»‘å®šè·¯å¾„çš„åŸŸåå’Œå­åŸŸåçš„æ–‡æœ¬åˆ«åã€‚net.LookupCNAME() å‡½æ•°æ¥å—ä¸»æœºåŸŸåï¼ˆm.facebook.comï¼‰ä½œä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶è¿”å›ç»™å®šä¸»æœºçš„å•ä¸ªè§„èŒƒåŸŸå package main import ( \"fmt\" \"net\" ) func main() { cname, _ := net.LookupCNAME(\"m.facebook.com\") fmt.Println(cname) } m.facebook.com åŸŸåè¿”å›çš„ CNAME è®°å½•å¦‚ä¸‹æ‰€ç¤ºï¼š C:\\golang\\dns\u003e Go run example2.go star-mini.c10r.facebook.comã€‚ 3ã€Go ç¨‹åºæŸ¥æ‰¾åŸŸåçš„ PTR æŒ‡é’ˆè®°å½• è¿™äº›è®°å½•æä¾›ä»åœ°å€åˆ°åç§°çš„åå‘ç»‘å®šã€‚PTR è®°å½•åº”ä¸æ­£å‘è®°å½•å®Œå…¨åŒ¹é…ã€‚net.LookupAddr() å‡½æ•°å¯¹åœ°å€æ‰§è¡Œåå‘æŸ¥æ‰¾ï¼Œå¹¶è¿”å›æ˜ å°„åˆ°ç»™å®šåœ°å€çš„åç§°åˆ—è¡¨ã€‚ package main import ( \"fmt\" \"net\" ) func main() { ptr, _ := net.LookupAddr(\"6.8.8.8\") for _, ptrvalue := range ptr { fmt.Println(ptrvalue) } } å¯¹äºç»™å®šçš„åœ°å€ï¼Œä¸Šè¿°ç¨‹åºè¿”å›å•ä¸ªåå‘è®°å½•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š C:\\golang\\dns\u003ego run example3.go tms_server.yuma.army.mil. 4ã€Go ç¨‹åºæŸ¥æ‰¾åŸŸåçš„åç§°æœåŠ¡å™¨ï¼ˆNSï¼‰è®°å½• NS è®°å½•æè¿°äº†åŒºåŸŸçš„æˆæƒåç§°æœåŠ¡å™¨ã€‚NS è¿˜å°†å­åŸŸåå§”æ‰˜ç»™åŒºåŸŸæ–‡ä»¶ä¸Šçš„å…¶ä»–ç»„ç»‡ã€‚net.LookupNS() å‡½æ•°å°†åŸŸåï¼ˆfacebook.comï¼‰ä½œä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶è¿”å› DNS-NS è®°å½•ä½œä¸º NS ç»“æ„çš„åˆ‡ç‰‡ã€‚ package main import ( \"fmt\" \"net\" ) func main() { nameserver, _ := net.LookupNS(\"facebook.com\") for _, ns := range nameserver { fmt.Println(ns) } } æ”¯æŒè¯¥åŸŸåçš„ NS è®°å½•å¦‚ä¸‹æ‰€ç¤ºï¼š C:\\golang\\dns\u003ego run example4.go \u0026{a.ns.facebook.com.} \u0026{b.ns.facebook.com.} 5ã€Go ç¨‹åºæŸ¥æ‰¾åŸŸçš„ MX è®°å½• è¿™äº›è®°å½•ç”¨æ¥è®°å½•å¯ä»¥äº¤æ¢ç”µå­é‚®ä»¶çš„æœåŠ¡å™¨ã€‚net.LookupMX() å‡½æ•°å°†åŸŸåä½œä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶è¿”å›æŒ‰é¦–é€‰é¡¹æ’åºçš„ MX ç»“æ„åˆ‡ç‰‡ã€‚MX ç»“æ„ç”±ç±»å‹ä¸ºå­—ç¬¦ä¸²çš„ HOST å’Œ ç±»å‹ä¸º uint16 çš„ Pref ç»„æˆã€‚ package main import ( \"fmt\" \"net\" ) func main() { mxrecords, _ := net.LookupMX(\"facebook.com\") for _, mx := range mxrecords { fmt.Println(mx.Host, mx.Pref) } } åŸŸåï¼ˆfacebook.comï¼‰çš„è¾“å‡ºåˆ—è¡¨ MX è®°å½•ã€‚ C:\\golang\\dns\u003ego run example5.go msgin.vvv.facebook.com. 10 6ã€Go ç¨‹åºæŸ¥æ‰¾åŸŸåçš„ SRV æœåŠ¡è®°å½• LookupSRV å‡½æ•°å°è¯•è§£æç»™å®šæœåŠ¡ï¼Œåè®®å’ŒåŸŸåçš„ SRV æŸ¥è¯¢ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯ â€œtcpâ€ æˆ– â€œudpâ€ã€‚è¿”å›çš„è®°å½•æŒ‰ä¼˜å…ˆçº§æ’åºï¼Œå¹¶æŒ‰ç…§æƒé‡éšæœºåŒ–ã€‚ package main import ( \"fmt\" \"net\" ) func main() { cname, srvs, err := net.LookupSRV(\"xmpp-server\", \"tcp\", \"golang.org\") if err != nil { panic(err) } fmt.Printf(\"\\ncname: %s \\n\\n\", cname) for _, srv := range srvs { fmt.Printf(\"%v:%v:%d:%d\\n\", srv.Target, srv.Port, srv.Priority, srv.Weight) } } ä¸‹é¢çš„è¾“å‡ºæ¼”ç¤ºäº† CNAME è¿”å›ï¼Œåè·Ÿç”±å†’å·åˆ†éš”çš„ SRV è®°å½•çš„ç›®æ ‡ï¼Œç«¯å£ï¼Œä¼˜å…ˆçº§å’Œæƒé‡ã€‚ C:\\golang\\dns\u003ego run example6.go cname: _xmpp-server._tcp.golang.org. 7ã€Go ç¨‹åºæŸ¥æ‰¾åŸŸåçš„ TXT è®°å½• TXT è®°å½•å­˜å‚¨æœ‰å…³ SPF çš„ä¿¡æ¯ï¼Œè¯¥ä¿¡æ¯å¯ä»¥è¯†åˆ«æˆæƒæœåŠ¡å™¨ä»¥ä»£è¡¨æ‚¨çš„ç»„ç»‡å‘é€ç”µå­é‚®ä»¶ã€‚net.LookupTXT() å‡½æ•°å°†åŸŸåï¼ˆfacebook.comï¼‰ä½œä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶è¿”å› DNS TXT è®°å½•çš„å­—ç¬¦ä¸²åˆ‡ç‰‡ã€‚ package main import ( \"fmt\" \"net\" ) func main() { txtrecords, _ := net.LookupTXT(\"facebook.com\") for _, txt := range txtrecords { fmt.Println(txt) } } gmail.com çš„å•ä¸ª TXT è®°å½•å¦‚ä¸‹æ‰€ç¤ºã€‚ C:\\golang\\dns\u003ego run example7.go v=spf1 redirect=_spf.facebook.com via: http://www.golangprograms.com/find-dns-records-programmatically.html ä½œè€…ï¼šgolangprograms[1]è¯‘è€…ï¼šlovechuck[2]æ ¡å¯¹ï¼špolaris1119[3] ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-net/:1:1","tags":["Go","net"],"title":"Go net","uri":"/posts/2023-11-11-go-net/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å‚è€ƒèµ„æ–™ [1]golangprograms: http://www.golangprograms.com [2]lovechuck: https://github.com/lovechuck [3]polaris1119: https://github.com/polaris1119 [4]GCTT: https://github.com/studygolang/GCTT [5]Go ä¸­æ–‡ç½‘: https://studygolang.com/ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-net/:1:2","tags":["Go","net"],"title":"Go net","uri":"/posts/2023-11-11-go-net/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"mapstructure è½¬æ¢åº“ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-mapstructure/:1:0","tags":["Go","mapstructure"],"title":"Go mapstructure","uri":"/posts/2023-11-11-go-mapstructure/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"ç®€ä»‹ mapstructureç”¨äºå°†é€šç”¨çš„map[string]interface{}è§£ç åˆ°å¯¹åº”çš„ Go ç»“æ„ä½“ä¸­ï¼Œæˆ–è€…æ‰§è¡Œç›¸åçš„æ“ä½œã€‚å¾ˆå¤šæ—¶å€™ï¼Œè§£ææ¥è‡ªå¤šç§æºå¤´çš„æ•°æ®æµæ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬äº‹å…ˆå¹¶ä¸çŸ¥é“ä»–ä»¬å¯¹åº”çš„å…·ä½“ç±»å‹ã€‚åªæœ‰è¯»å–åˆ°ä¸€äº›å­—æ®µä¹‹åæ‰èƒ½åšå‡ºåˆ¤æ–­ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä½¿ç”¨æ ‡å‡†çš„encoding/jsonåº“å°†æ•°æ®è§£ç ä¸ºmap[string]interface{}ç±»å‹ï¼Œç„¶åæ ¹æ®æ ‡è¯†å­—æ®µåˆ©ç”¨mapstructureåº“è½¬ä¸ºç›¸åº”çš„ Go ç»“æ„ä½“ä»¥ä¾¿ä½¿ç”¨ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-mapstructure/:1:1","tags":["Go","mapstructure"],"title":"Go mapstructure","uri":"/posts/2023-11-11-go-mapstructure/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å¿«é€Ÿä½¿ç”¨ æœ¬æ–‡ä»£ç é‡‡ç”¨ Go Modulesã€‚ é¦–å…ˆåˆ›å»ºç›®å½•å¹¶åˆå§‹åŒ–ï¼š $ mkdir mapstructure \u0026\u0026 cd mapstructure $ go mod init github.com/darjun/go-daily-lib/mapstructure ä¸‹è½½mapstructureåº“ï¼š $ go get github.com/mitchellh/mapstructure ä½¿ç”¨ï¼š package main import ( \"encoding/json\" \"fmt\" \"log\" \"github.com/mitchellh/mapstructure\" ) type Person struct { Name string Age int Job string } type Cat struct { Name string Age int Breed string } func main() { datas := []string{` { \"type\": \"person\", \"name\":\"dj\", \"age\":18, \"job\": \"programmer\" } `, ` { \"type\": \"cat\", \"name\": \"kitty\", \"age\": 1, \"breed\": \"Ragdoll\" } `, } for _, data := range datas { var m map[string]interface{} err := json.Unmarshal([]byte(data), \u0026m) if err != nil { log.Fatal(err) } switch m[\"type\"].(string) { case \"person\": var p Person mapstructure.Decode(m, \u0026p) fmt.Println(\"person\", p) case \"cat\": var cat Cat mapstructure.Decode(m, \u0026cat) fmt.Println(\"cat\", cat) } } } è¿è¡Œç»“æœï¼š $ go run main.go person {dj 18 programmer} cat {kitty 1 Ragdoll} æˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªç»“æ„ä½“Personå’ŒCatï¼Œä»–ä»¬çš„å­—æ®µæœ‰äº›è®¸ä¸åŒã€‚ç°åœ¨ï¼Œæˆ‘ä»¬çº¦å®šé€šä¿¡çš„ JSON ä¸²ä¸­æœ‰ä¸€ä¸ªtypeå­—æ®µã€‚å½“typeçš„å€¼ä¸ºpersonæ—¶ï¼Œè¯¥ JSON ä¸²è¡¨ç¤ºçš„æ˜¯Personç±»å‹çš„æ•°æ®ã€‚å½“typeçš„å€¼ä¸ºcatæ—¶ï¼Œè¯¥ JSON ä¸²è¡¨ç¤ºçš„æ˜¯Catç±»å‹çš„æ•°æ®ã€‚ ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬å…ˆç”¨json.Unmarshalå°†å­—èŠ‚æµè§£ç ä¸ºmap[string]interface{}ç±»å‹ã€‚ç„¶åè¯»å–é‡Œé¢çš„typeå­—æ®µã€‚æ ¹æ®typeå­—æ®µçš„å€¼ï¼Œå†ä½¿ç”¨mapstructure.Decodeå°†è¯¥ JSON ä¸²åˆ†åˆ«è§£ç ä¸ºPersonå’ŒCatç±»å‹çš„å€¼ï¼Œå¹¶è¾“å‡ºã€‚ å®é™…ä¸Šï¼ŒGoogle Protobuf é€šå¸¸ä¹Ÿä½¿ç”¨è¿™ç§æ–¹å¼ã€‚åœ¨åè®®ä¸­æ·»åŠ æ¶ˆæ¯ ID æˆ–å…¨é™å®šæ¶ˆæ¯åã€‚æ¥æ”¶æ–¹æ”¶åˆ°æ•°æ®åï¼Œå…ˆè¯»å–åè®® ID æˆ–å…¨é™å®šæ¶ˆæ¯åã€‚ç„¶åè°ƒç”¨ Protobuf çš„è§£ç æ–¹æ³•å°†å…¶è§£ç ä¸ºå¯¹åº”çš„Messageç»“æ„ã€‚ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œmapstructureä¹Ÿå¯ä»¥ç”¨äºç½‘ç»œæ¶ˆæ¯è§£ç ï¼Œå¦‚æœä½ ä¸è€ƒè™‘æ€§èƒ½çš„è¯ğŸ˜„ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-mapstructure/:1:2","tags":["Go","mapstructure"],"title":"Go mapstructure","uri":"/posts/2023-11-11-go-mapstructure/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å­—æ®µæ ‡ç­¾ é»˜è®¤æƒ…å†µä¸‹ï¼Œmapstructureä½¿ç”¨ç»“æ„ä½“ä¸­å­—æ®µçš„åç§°åšè¿™ä¸ªæ˜ å°„ï¼Œä¾‹å¦‚æˆ‘ä»¬çš„ç»“æ„ä½“æœ‰ä¸€ä¸ªNameå­—æ®µï¼Œmapstructureè§£ç æ—¶ä¼šåœ¨map[string]interface{}ä¸­æŸ¥æ‰¾é”®ånameã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„nameæ˜¯å¤§å°å†™ä¸æ•æ„Ÿçš„ï¼ type Person struct { Name string } å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‡å®šæ˜ å°„çš„å­—æ®µåã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå­—æ®µè®¾ç½®mapstructureæ ‡ç­¾ã€‚ä¾‹å¦‚ä¸‹é¢ä½¿ç”¨usernameä»£æ›¿ä¸Šä¾‹ä¸­çš„nameï¼š type Person struct { Name string `mapstructure:\"username\"` } çœ‹ç¤ºä¾‹ï¼š type Person struct { Name string `mapstructure:\"username\"` Age int Job string } type Cat struct { Name string Age int Breed string } func main() { datas := []string{` { \"type\": \"person\", \"username\":\"dj\", \"age\":18, \"job\": \"programmer\" } `, ` { \"type\": \"cat\", \"name\": \"kitty\", \"Age\": 1, \"breed\": \"Ragdoll\" } `, ` { \"type\": \"cat\", \"Name\": \"rooooose\", \"age\": 2, \"breed\": \"shorthair\" } `, } for _, data := range datas { var m map[string]interface{} err := json.Unmarshal([]byte(data), \u0026m) if err != nil { log.Fatal(err) } switch m[\"type\"].(string) { case \"person\": var p Person mapstructure.Decode(m, \u0026p) fmt.Println(\"person\", p) case \"cat\": var cat Cat mapstructure.Decode(m, \u0026cat) fmt.Println(\"cat\", cat) } } } ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ ‡ç­¾mapstructure:\"username\"å°†Personçš„Nameå­—æ®µæ˜ å°„ä¸ºusernameï¼Œåœ¨ JSON ä¸²ä¸­æˆ‘ä»¬éœ€è¦è®¾ç½®usernameæ‰èƒ½æ­£ç¡®è§£æã€‚å¦å¤–ï¼Œæ³¨æ„åˆ°ï¼Œæˆ‘ä»¬å°†ç¬¬äºŒä¸ª JSON ä¸²ä¸­çš„Ageå’Œç¬¬ä¸‰ä¸ª JSON ä¸²ä¸­çš„Nameé¦–å­—æ¯å¤§å†™äº†ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å½±å“è§£ç ç»“æœã€‚mapstructureå¤„ç†å­—æ®µæ˜ å°„æ˜¯å¤§å°å†™ä¸æ•æ„Ÿçš„ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-mapstructure/:1:3","tags":["Go","mapstructure"],"title":"Go mapstructure","uri":"/posts/2023-11-11-go-mapstructure/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å†…åµŒç»“æ„ ç»“æ„ä½“å¯ä»¥ä»»æ„åµŒå¥—ï¼ŒåµŒå¥—çš„ç»“æ„è¢«è®¤ä¸ºæ˜¯æ‹¥æœ‰è¯¥ç»“æ„ä½“åå­—çš„å¦ä¸€ä¸ªå­—æ®µã€‚ä¾‹å¦‚ï¼Œä¸‹é¢ä¸¤ç§Friendçš„å®šä¹‰æ–¹å¼å¯¹äºmapstructureæ˜¯ä¸€æ ·çš„ï¼š type Person struct { Name string } // æ–¹å¼ä¸€ type Friend struct { Person } // æ–¹å¼äºŒ type Friend struct { Person Person } ä¸ºäº†æ­£ç¡®è§£ç ï¼ŒPersonç»“æ„çš„æ•°æ®è¦åœ¨personé”®ä¸‹ï¼š map[string]interface{} { \"person\": map[string]interface{}{\"name\": \"dj\"}, } æˆ‘ä»¬ä¹Ÿå¯ä»¥è®¾ç½®mapstructure:\",squash\"å°†è¯¥ç»“æ„ä½“çš„å­—æ®µæåˆ°çˆ¶ç»“æ„ä¸­ï¼š type Friend struct { Person `mapstructure:\",squash\"` } è¿™æ ·åªéœ€è¦è¿™æ ·çš„ JSON ä¸²ï¼Œæ— æ•ˆåµŒå¥—personé”®ï¼š map[string]interface{}{ \"name\": \"dj\", } çœ‹ç¤ºä¾‹ï¼š type Person struct { Name string } type Friend1 struct { Person } type Friend2 struct { Person `mapstructure:\",squash\"` } func main() { datas := []string{` { \"type\": \"friend1\", \"person\": { \"name\":\"dj\" } } `, ` { \"type\": \"friend2\", \"name\": \"dj2\" } `, } for _, data := range datas { var m map[string]interface{} err := json.Unmarshal([]byte(data), \u0026m) if err != nil { log.Fatal(err) } switch m[\"type\"].(string) { case \"friend1\": var f1 Friend1 mapstructure.Decode(m, \u0026f1) fmt.Println(\"friend1\", f1) case \"friend2\": var f2 Friend2 mapstructure.Decode(m, \u0026f2) fmt.Println(\"friend2\", f2) } } } æ³¨æ„å¯¹æ¯”Friend1å’ŒFriend2ä½¿ç”¨çš„ JSON ä¸²çš„ä¸åŒã€‚ å¦å¤–éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œå¦‚æœçˆ¶ç»“æ„ä½“ä¸­æœ‰åŒåçš„å­—æ®µï¼Œé‚£ä¹ˆmapstructureä¼šå°†JSON ä¸­å¯¹åº”çš„å€¼åŒæ—¶è®¾ç½®åˆ°è¿™ä¸¤ä¸ªå­—æ®µä¸­ï¼Œå³è¿™ä¸¤ä¸ªå­—æ®µæœ‰ç›¸åŒçš„å€¼ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-mapstructure/:1:4","tags":["Go","mapstructure"],"title":"Go mapstructure","uri":"/posts/2023-11-11-go-mapstructure/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æœªæ˜ å°„çš„å€¼ å¦‚æœæºæ•°æ®ä¸­æœ‰æœªæ˜ å°„çš„å€¼ï¼ˆå³ç»“æ„ä½“ä¸­æ— å¯¹åº”çš„å­—æ®µï¼‰ï¼Œmapstructureé»˜è®¤ä¼šå¿½ç•¥å®ƒã€‚ æˆ‘ä»¬å¯ä»¥åœ¨ç»“æ„ä½“ä¸­å®šä¹‰ä¸€ä¸ªå­—æ®µï¼Œä¸ºå…¶è®¾ç½®mapstructure:\",remain\"æ ‡ç­¾ã€‚è¿™æ ·æœªæ˜ å°„çš„å€¼å°±ä¼šæ·»åŠ åˆ°è¿™ä¸ªå­—æ®µä¸­ã€‚æ³¨æ„ï¼Œè¿™ä¸ªå­—æ®µçš„ç±»å‹åªèƒ½ä¸ºmap[string]interface{}æˆ–map[interface{}]interface{}ã€‚ çœ‹ç¤ºä¾‹ï¼š type Person struct { Name string Age int Job string Other map[string]interface{} `mapstructure:\",remain\"` } func main() { data := ` { \"name\": \"dj\", \"age\":18, \"job\":\"programmer\", \"height\":\"1.8m\", \"handsome\": true } ` var m map[string]interface{} err := json.Unmarshal([]byte(data), \u0026m) if err != nil { log.Fatal(err) } var p Person mapstructure.Decode(m, \u0026p) fmt.Println(\"other\", p.Other) } ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¸ºç»“æ„ä½“å®šä¹‰äº†ä¸€ä¸ªOtherå­—æ®µï¼Œç”¨äºä¿å­˜æœªæ˜ å°„çš„é”®å€¼ã€‚è¾“å‡ºç»“æœï¼š other map[handsome:true height:1.8m] ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-mapstructure/:1:5","tags":["Go","mapstructure"],"title":"Go mapstructure","uri":"/posts/2023-11-11-go-mapstructure/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"é€†å‘è½¬æ¢ å‰é¢æˆ‘ä»¬éƒ½æ˜¯å°†map[string]interface{}è§£ç åˆ° Go ç»“æ„ä½“ä¸­ã€‚mapstructureå½“ç„¶ä¹Ÿå¯ä»¥å°† Go ç»“æ„ä½“åå‘è§£ç ä¸ºmap[string]interface{}ã€‚åœ¨åå‘è§£ç æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæŸäº›å­—æ®µè®¾ç½®mapstructure:\",omitempty\"ã€‚è¿™æ ·å½“è¿™äº›å­—æ®µä¸ºé»˜è®¤å€¼æ—¶ï¼Œå°±ä¸ä¼šå‡ºç°åœ¨ç»“æ„çš„map[string]interface{}ä¸­ï¼š type Person struct { Name string Age int Job string `mapstructure:\",omitempty\"` } func main() { p := \u0026Person{ Name: \"dj\", Age: 18, } var m map[string]interface{} mapstructure.Decode(p, \u0026m) data, _ := json.Marshal(m) fmt.Println(string(data)) } ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¸ºJobå­—æ®µè®¾ç½®äº†mapstructure:\",omitempty\"ï¼Œä¸”å¯¹è±¡pçš„Jobå­—æ®µæœªè®¾ç½®ã€‚è¿è¡Œç»“æœï¼š $ go run main.go {\"Age\":18,\"Name\":\"dj\"} ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-mapstructure/:1:6","tags":["Go","mapstructure"],"title":"Go mapstructure","uri":"/posts/2023-11-11-go-mapstructure/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Metadata è§£ç æ—¶ä¼šäº§ç”Ÿä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ï¼Œmapstructureå¯ä»¥ä½¿ç”¨Metadataæ”¶é›†è¿™äº›ä¿¡æ¯ã€‚Metadataç»“æ„å¦‚ä¸‹ï¼š // mapstructure.go type Metadata struct { Keys []string Unused []string } Metadataåªæœ‰ä¸¤ä¸ªå¯¼å‡ºå­—æ®µï¼š Keysï¼šè§£ç æˆåŠŸçš„é”®åï¼› Unusedï¼šåœ¨æºæ•°æ®ä¸­å­˜åœ¨ï¼Œä½†æ˜¯ç›®æ ‡ç»“æ„ä¸­ä¸å­˜åœ¨çš„é”®åã€‚ ä¸ºäº†æ”¶é›†è¿™äº›æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨DecodeMetadataæ¥ä»£æ›¿Decodeæ–¹æ³•ï¼š type Person struct { Name string Age int } func main() { m := map[string]interface{}{ \"name\": \"dj\", \"age\": 18, \"job\": \"programmer\", } var p Person var metadata mapstructure.Metadata mapstructure.DecodeMetadata(m, \u0026p, \u0026metadata) fmt.Printf(\"keys:%#v unused:%#v\\n\", metadata.Keys, metadata.Unused) } å…ˆå®šä¹‰ä¸€ä¸ªMetadataç»“æ„ï¼Œä¼ å…¥DecodeMetadataæ”¶é›†è§£ç çš„ä¿¡æ¯ã€‚è¿è¡Œç»“æœï¼š $ go run main.go keys:[]string{\"Name\", \"Age\"} unused:[]string{\"job\"} ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-mapstructure/:1:7","tags":["Go","mapstructure"],"title":"Go mapstructure","uri":"/posts/2023-11-11-go-mapstructure/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"é”™è¯¯å¤„ç† mapstructureæ‰§è¡Œè½¬æ¢çš„è¿‡ç¨‹ä¸­ä¸å¯é¿å…åœ°ä¼šäº§ç”Ÿé”™è¯¯ï¼Œä¾‹å¦‚ JSON ä¸­æŸä¸ªé”®çš„ç±»å‹ä¸å¯¹åº” Go ç»“æ„ä½“ä¸­çš„å­—æ®µç±»å‹ä¸ä¸€è‡´ã€‚Decode/DecodeMetadataä¼šè¿”å›è¿™äº›é”™è¯¯ï¼š type Person struct { Name string Age int Emails []string } func main() { m := map[string]interface{}{ \"name\": 123, \"age\": \"bad value\", \"emails\": []int{1, 2, 3}, } var p Person err := mapstructure.Decode(m, \u0026p) if err != nil { fmt.Println(err.Error()) } } ä¸Šé¢ä»£ç ä¸­ï¼Œç»“æ„ä½“ä¸­Personä¸­å­—æ®µNameä¸ºstringç±»å‹ï¼Œä½†è¾“å…¥ä¸­nameä¸ºintç±»å‹ï¼›å­—æ®µAgeä¸ºintç±»å‹ï¼Œä½†è¾“å…¥ä¸­ageä¸ºstringç±»å‹ï¼›å­—æ®µEmailsä¸º[]stringç±»å‹ï¼Œä½†è¾“å…¥ä¸­emailsä¸º[]intç±»å‹ã€‚æ•…Decodeè¿”å›é”™è¯¯ã€‚è¿è¡Œç»“æœï¼š $ go run main.go 5 error(s) decoding: * 'Age' expected type 'int', got unconvertible type 'string' * 'Emails[0]' expected type 'string', got unconvertible type 'int' * 'Emails[1]' expected type 'string', got unconvertible type 'int' * 'Emails[2]' expected type 'string', got unconvertible type 'int' * 'Name' expected type 'string', got unconvertible type 'int' ä»é”™è¯¯ä¿¡æ¯ä¸­å¾ˆå®¹æ˜“çœ‹å‡ºå“ªé‡Œå‡ºé”™äº†ã€‚ å¼±ç±»å‹è¾“å…¥ æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸æƒ³å¯¹ç»“æ„ä½“å­—æ®µç±»å‹å’Œmap[string]interface{}çš„å¯¹åº”é”®å€¼åšå¼ºç±»å‹ä¸€è‡´çš„æ ¡éªŒã€‚è¿™æ—¶å¯ä»¥ä½¿ç”¨WeakDecode/WeakDecodeMetadataæ–¹æ³•ï¼Œå®ƒä»¬ä¼šå°è¯•åšç±»å‹è½¬æ¢ï¼š type Person struct { Name string Age int Emails []string } func main() { m := map[string]interface{}{ \"name\": 123, \"age\": \"18\", \"emails\": []int{1, 2, 3}, } var p Person err := mapstructure.WeakDecode(m, \u0026p) if err == nil { fmt.Println(\"person:\", p) } else { fmt.Println(err.Error()) } } è™½ç„¶é”®nameå¯¹åº”çš„å€¼123æ˜¯intç±»å‹ï¼Œä½†æ˜¯åœ¨WeakDecodeä¸­ä¼šå°†å…¶è½¬æ¢ä¸ºstringç±»å‹ä»¥åŒ¹é…Person.Nameå­—æ®µçš„ç±»å‹ã€‚åŒæ ·çš„ï¼Œageçš„å€¼\"18\"æ˜¯stringç±»å‹ï¼Œåœ¨WeakDecodeä¸­ä¼šå°†å…¶è½¬æ¢ä¸ºintç±»å‹ä»¥åŒ¹é…Person.Ageå­—æ®µçš„ç±»å‹ã€‚ éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œå¦‚æœç±»å‹è½¬æ¢å¤±è´¥äº†ï¼ŒWeakDecodeåŒæ ·ä¼šè¿”å›é”™è¯¯ã€‚ä¾‹å¦‚å°†ä¸Šä¾‹ä¸­çš„ageè®¾ç½®ä¸º\"bad value\"ï¼Œå®ƒå°±ä¸èƒ½è½¬ä¸ºintç±»å‹ï¼Œæ•…è€Œè¿”å›é”™è¯¯ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-mapstructure/:1:8","tags":["Go","mapstructure"],"title":"Go mapstructure","uri":"/posts/2023-11-11-go-mapstructure/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"è§£ç å™¨ é™¤äº†ä¸Šé¢ä»‹ç»çš„æ–¹æ³•å¤–ï¼Œmapstructureè¿˜æä¾›äº†æ›´çµæ´»çš„è§£ç å™¨ï¼ˆDecoderï¼‰ã€‚å¯ä»¥é€šè¿‡é…ç½®DecoderConfigå®ç°ä¸Šé¢ä»‹ç»çš„ä»»ä½•åŠŸèƒ½ï¼š // mapstructure.go type DecoderConfig struct { ErrorUnused bool ZeroFields bool WeaklyTypedInput bool Metadata *Metadata Result interface{} TagName string } å„ä¸ªå­—æ®µå«ä¹‰å¦‚ä¸‹ï¼š ErrorUnusedï¼šä¸ºtrueæ—¶ï¼Œå¦‚æœè¾“å…¥ä¸­çš„é”®å€¼æ²¡æœ‰ä¸ä¹‹å¯¹åº”çš„å­—æ®µå°±è¿”å›é”™è¯¯ï¼› ZeroFieldsï¼šä¸ºtrueæ—¶ï¼Œåœ¨Decodeå‰æ¸…ç©ºç›®æ ‡mapã€‚ä¸ºfalseæ—¶ï¼Œåˆ™æ‰§è¡Œçš„æ˜¯mapçš„åˆå¹¶ã€‚ç”¨åœ¨structåˆ°mapçš„è½¬æ¢ä¸­ï¼› WeaklyTypedInputï¼šå®ç°WeakDecode/WeakDecodeMetadataçš„åŠŸèƒ½ï¼› Metadataï¼šä¸ä¸ºnilæ—¶ï¼Œæ”¶é›†Metadataæ•°æ®ï¼› Resultï¼šä¸ºç»“æœå¯¹è±¡ï¼Œåœ¨mapåˆ°structçš„è½¬æ¢ä¸­ï¼ŒResultä¸ºstructç±»å‹ã€‚åœ¨structåˆ°mapçš„è½¬æ¢ä¸­ï¼ŒResultä¸ºmapç±»å‹ï¼› TagNameï¼šé»˜è®¤ä½¿ç”¨mapstructureä½œä¸ºç»“æ„ä½“çš„æ ‡ç­¾åï¼Œå¯ä»¥é€šè¿‡è¯¥å­—æ®µè®¾ç½®ã€‚ çœ‹ç¤ºä¾‹ï¼š type Person struct { Name string Age int } func main() { m := map[string]interface{}{ \"name\": 123, \"age\": \"18\", \"job\": \"programmer\", } var p Person var metadata mapstructure.Metadata decoder, err := mapstructure.NewDecoder(\u0026mapstructure.DecoderConfig{ WeaklyTypedInput: true, Result: \u0026p, Metadata: \u0026metadata, }) if err != nil { log.Fatal(err) } err = decoder.Decode(m) if err == nil { fmt.Println(\"person:\", p) fmt.Printf(\"keys:%#v, unused:%#v\\n\", metadata.Keys, metadata.Unused) } else { fmt.Println(err.Error()) } } è¿™é‡Œç”¨Decoderçš„æ–¹å¼å®ç°äº†å‰é¢å¼±ç±»å‹è¾“å…¥å°èŠ‚ä¸­çš„ç¤ºä¾‹ä»£ç ã€‚å®é™…ä¸ŠWeakDecodeå†…éƒ¨å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼å®ç°çš„ï¼Œä¸‹é¢æ˜¯WeakDecodeçš„æºç ï¼š // mapstructure.go func WeakDecode(input, output interface{}) error { config := \u0026DecoderConfig{ Metadata: nil, Result: output, WeaklyTypedInput: true, } decoder, err := NewDecoder(config) if err != nil { return err } return decoder.Decode(input) } å†å®é™…ä¸Šï¼ŒDecode/DecodeMetadata/WeakDecodeMetadataå†…éƒ¨éƒ½æ˜¯å…ˆè®¾ç½®DecoderConfigçš„å¯¹åº”å­—æ®µï¼Œç„¶ååˆ›å»ºDecoderå¯¹è±¡ï¼Œæœ€åè°ƒç”¨å…¶Decodeæ–¹æ³•å®ç°çš„ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-mapstructure/:1:9","tags":["Go","mapstructure"],"title":"Go mapstructure","uri":"/posts/2023-11-11-go-mapstructure/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go leveldbåº“ githubåœ°å€ï¼šhttps://github.com/syndtr/goleveldb å®‰è£…ï¼š go get github.com/syndtr/goleveldb/leveldb ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-leveldb/:1:0","tags":["Go","leveldb"],"title":"Go leveldb","uri":"/posts/2023-11-11-go-leveldb/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"ç®€ä»‹ï¼š levelDBåœ¨åŒºå—é“¾ä¸­æ¯”è¾ƒå¸¸ç”¨ï¼Œå…¶æ˜¯Googleå¼€æºçš„æŒä¹…åŒ–å•æœºKey-Valueæ–‡ä»¶æ•°æ®åº“ï¼Œå…¶æ”¯æŒæŒ‰ç…§æ–‡ä»¶å¤§å°åˆ‡åˆ†æ–‡ä»¶çš„åŠŸèƒ½ã€‚levelDBå…·æœ‰å¾ˆé«˜çš„éšæœºå†™ï¼Œé¡ºåºè¯»/å†™æ€§èƒ½ï¼Œä½†æ˜¯éšæœºè¯»çš„æ€§èƒ½å¾ˆä¸€èˆ¬ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒlevelDBå¾ˆé€‚åˆåº”ç”¨åœ¨æŸ¥è¯¢è¾ƒå°‘ï¼Œè€Œå†™å¾ˆå¤šçš„åœºæ™¯ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-leveldb/:1:1","tags":["Go","leveldb"],"title":"Go leveldb","uri":"/posts/2023-11-11-go-leveldb/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"LevelDBç‰¹ç‚¹ 1ï¼‰keyå’Œvalueéƒ½æ˜¯ä»»æ„é•¿åº¦çš„å­—èŠ‚æ•°ç»„ï¼› 2ï¼‰entryï¼ˆå³ä¸€æ¡k-vè®°å½•ï¼‰é»˜è®¤æ˜¯æŒ‰ç…§keyçš„å­—å…¸é¡ºåºå­˜å‚¨çš„ï¼Œå¼€å‘è€…ä¹Ÿå¯ä»¥é‡å†™è¿™ä¸ªæ–¹æ³•ï¼› 3ï¼‰æä¾›äº†åŸºæœ¬çš„å¢åˆ æ”¹æŸ¥æ¥å£ï¼› 4ï¼‰æ”¯æŒæ‰¹é‡æ“ä½œä»¥åŸå­æ“ä½œè¿›è¡Œï¼› 5ï¼‰å¼€æºåˆ›å»ºæ•°æ®å…¨æ™¯çš„snapshotï¼ˆå¿«ç…§ï¼‰ï¼Œå¹¶å…è®¸åœ¨å¿«ç…§ä¸­æŸ¥è¯¢ï¼› 6ï¼‰å¼€æºé€šè¿‡å‘å‰ï¼ˆåï¼‰è¿­ä»£å™¨éå†æ•°æ®ï¼ˆè¿­ä»£å™¨éšå«çš„åˆ›å»ºäº†ä¸€ä¸ªsnapshotï¼‰ï¼› 7ï¼‰è‡ªåŠ¨ä½¿ç”¨Snappyå‹ç¼©æ•°æ®ï¼› 8ï¼‰å¯ç§»æ¤æ€§ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-leveldb/:1:2","tags":["Go","leveldb"],"title":"Go leveldb","uri":"/posts/2023-11-11-go-leveldb/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"levelDBé™åˆ¶ 1ï¼‰NoSQLï¼Œä¸æ”¯æŒsqlè¯­å¥ï¼Œä¹Ÿä¸æ”¯æŒç´¢å¼•ï¼› 2ï¼‰ä¸€æ¬¡åªå…è®¸ä¸€ä¸ªè¿›ç¨‹è®¿é—®ä¸€ä¸ªç‰¹å®šçš„æ•°æ®åº“ï¼› 3ï¼‰æ²¡æœ‰å†…ç½®çš„C/Sæ¶æ„ï¼Œå¼€å‘è€…éœ€è¦ä½¿ç”¨levelDBåº“è‡ªå·±å°è£…ä¸€ä¸ªserverï¼› ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-leveldb/:1:3","tags":["Go","leveldb"],"title":"Go leveldb","uri":"/posts/2023-11-11-go-leveldb/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"ä½¿ç”¨ï¼š 1ï¼‰æ‰“å¼€ã€åˆ›å»ºæ•°æ®åº“ db, err := leveldb.OpenFile(\"./block.db\", nil) 2ï¼‰å†™å…¥keyæ•°æ® err = db.Put([]byte(\"hello\"), []byte(\"world\"), nil) 3ï¼‰è¯»å–keyæ•°æ® data, _ := db.Get([]byte(\"hello\"), nil) 4ï¼‰éå†æ•°æ®åº“ iter := db.NewIterator(nil, nil) for iter.Next() { logger.Debug(iter.Key() + iter.Value()) } 5ï¼‰è¯»å–æŸä¸ªå‰ç¼€çš„æ‰€æœ‰KEYæ•°æ® è¯»å‡ºæ¥çš„æ•°æ®ä¼šè¢«æ”¾è¿›ä¸€ä¸ªIteratorä¸­ã€‚åŠ å…¥æ•°æ®åº“ç°åœ¨æœ‰key-$numä¸ºå¤´çš„æ•°æ¡æ•°æ® iter := db.NewIterator(dbUtil.BytesPrefix([]byte(\"key-\")), nil) éå†è¯»å–è¿™äº›æ•°æ® for iter.Next() { logger.Debug(string(iter.Key()) + string(iter.Value())) } è¯»å–æœ€åä¸€æ¡æ•°æ® if iter.Last() { logger.Debug(iter.Key() + iter.Value()) } 6ï¼‰åˆ é™¤æŸä¸ªKEY err = db.Delete([]byte(\"key-3\"), nil) 7ï¼‰æ‰¹é‡å†™ batch := new(leveldb.Batch) batch.Put([]byte(\"foo\"), []byte(\"value\")) batch.Put([]byte(\"bar\"), []byte(\"another value\")) batch.Delete([]byte(\"baz\")) err = db.Write(batch, nil) ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-leveldb/:1:4","tags":["Go","leveldb"],"title":"Go leveldb","uri":"/posts/2023-11-11-go-leveldb/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go iniåº“ å‚è€ƒï¼šhttps://juejin.cn/post/6844904048764649479 ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-ini/:1:0","tags":["Go","ini"],"title":"Go ini","uri":"/posts/2023-11-11-go-ini/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"ç®€ä»‹ ini æ˜¯ Windows ä¸Šå¸¸ç”¨çš„é…ç½®æ–‡ä»¶æ ¼å¼ã€‚MySQL çš„ Windows ç‰ˆå°±æ˜¯ä½¿ç”¨ ini æ ¼å¼å­˜å‚¨é…ç½®çš„ã€‚ go-iniæ˜¯ Go è¯­è¨€ä¸­ç”¨äºæ“ä½œ ini æ–‡ä»¶çš„ç¬¬ä¸‰æ–¹åº“ã€‚ æœ¬æ–‡ä»‹ç»go-iniåº“çš„ä½¿ç”¨ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-ini/:1:1","tags":["Go","ini"],"title":"Go ini","uri":"/posts/2023-11-11-go-ini/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å¿«é€Ÿä½¿ç”¨ go-ini æ˜¯ç¬¬ä¸‰æ–¹åº“ï¼Œä½¿ç”¨å‰éœ€è¦å®‰è£…ï¼š $ go get gopkg.in/ini.v1 ä¹Ÿå¯ä»¥ä½¿ç”¨ GitHub ä¸Šçš„ä»“åº“ï¼š $ go get github.com/go-ini/ini é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªmy.inié…ç½®æ–‡ä»¶ï¼š app_name = awesome web # possible values: DEBUG, INFO, WARNING, ERROR, FATAL log_level = DEBUG [mysql] ip = 127.0.0.1 port = 3306 user = dj password = 123456 database = awesome [redis] ip = 127.0.0.1 port = 6381 ä½¿ç”¨ go-ini åº“è¯»å–ï¼š package main import ( \"fmt\" \"log\" \"gopkg.in/ini.v1\" ) func main() { cfg, err := ini.Load(\"my.ini\") if err != nil { log.Fatal(\"Fail to read file: \", err) } fmt.Println(\"App Name:\", cfg.Section(\"\").Key(\"app_name\").String()) fmt.Println(\"Log Level:\", cfg.Section(\"\").Key(\"log_level\").String()) fmt.Println(\"MySQL IP:\", cfg.Section(\"mysql\").Key(\"ip\").String()) mysqlPort, err := cfg.Section(\"mysql\").Key(\"port\").Int() if err != nil { log.Fatal(err) } fmt.Println(\"MySQL Port:\", mysqlPort) fmt.Println(\"MySQL User:\", cfg.Section(\"mysql\").Key(\"user\").String()) fmt.Println(\"MySQL Password:\", cfg.Section(\"mysql\").Key(\"password\").String()) fmt.Println(\"MySQL Database:\", cfg.Section(\"mysql\").Key(\"database\").String()) fmt.Println(\"Redis IP:\", cfg.Section(\"redis\").Key(\"ip\").String()) redisPort, err := cfg.Section(\"redis\").Key(\"port\").Int() if err != nil { log.Fatal(err) } fmt.Println(\"Redis Port:\", redisPort) } åœ¨ ini æ–‡ä»¶ä¸­ï¼Œæ¯ä¸ªé”®å€¼å¯¹å ç”¨ä¸€è¡Œï¼Œä¸­é—´ä½¿ç”¨=éš”å¼€ã€‚ä»¥#å¼€å¤´çš„å†…å®¹ä¸ºæ³¨é‡Šã€‚ini æ–‡ä»¶æ˜¯ä»¥åˆ†åŒºï¼ˆsectionï¼‰ç»„ç»‡çš„ã€‚ åˆ†åŒºä»¥[name]å¼€å§‹ï¼Œåœ¨ä¸‹ä¸€ä¸ªåˆ†åŒºå‰ç»“æŸã€‚æ‰€æœ‰åˆ†åŒºå‰çš„å†…å®¹å±äºé»˜è®¤åˆ†åŒºï¼Œå¦‚my.iniæ–‡ä»¶ä¸­çš„app_nameå’Œlog_levelã€‚ ä½¿ç”¨go-iniè¯»å–é…ç½®æ–‡ä»¶çš„æ­¥éª¤å¦‚ä¸‹ï¼š é¦–å…ˆè°ƒç”¨ini.LoadåŠ è½½æ–‡ä»¶ï¼Œå¾—åˆ°é…ç½®å¯¹è±¡cfgï¼› ç„¶åä»¥åˆ†åŒºåè°ƒç”¨é…ç½®å¯¹è±¡çš„Sectionæ–¹æ³•å¾—åˆ°å¯¹åº”çš„åˆ†åŒºå¯¹è±¡sectionï¼Œé»˜è®¤åˆ†åŒºçš„åå­—ä¸º\"\"ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ini.DefaultSectionï¼› ä»¥é”®åè°ƒç”¨åˆ†åŒºå¯¹è±¡çš„Keyæ–¹æ³•å¾—åˆ°å¯¹åº”çš„é…ç½®é¡¹keyå¯¹è±¡ï¼› ç”±äºæ–‡ä»¶ä¸­è¯»å–å‡ºæ¥çš„éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œkeyå¯¹è±¡éœ€æ ¹æ®ç±»å‹è°ƒç”¨å¯¹åº”çš„æ–¹æ³•è¿”å›å…·ä½“ç±»å‹çš„å€¼ä½¿ç”¨ï¼Œå¦‚ä¸Šé¢çš„Stringã€MustIntæ–¹æ³•ã€‚ è¿è¡Œä»¥ä¸‹ç¨‹åºï¼Œå¾—åˆ°è¾“å‡ºï¼š App Name: awesome web Log Level: DEBUG MySQL IP: 127.0.0.1 MySQL Port: 3306 MySQL User: dj MySQL Password: 123456 MySQL Database: awesome Redis IP: 127.0.0.1 Redis Port: 6381 é…ç½®æ–‡ä»¶ä¸­å­˜å‚¨çš„éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ç±»å‹ä¸ºå­—ç¬¦ä¸²çš„é…ç½®é¡¹ä¸ä¼šå‡ºç°ç±»å‹è½¬æ¢å¤±è´¥çš„ï¼Œæ•…String()æ–¹æ³•åªè¿”å›ä¸€ä¸ªå€¼ã€‚ ä½†å¦‚æœç±»å‹ä¸ºInt/Uint/Float64è¿™äº›æ—¶ï¼Œè½¬æ¢å¯èƒ½å¤±è´¥ã€‚æ‰€ä»¥Int()/Uint()/Float64()è¿”å›ä¸€ä¸ªå€¼å’Œä¸€ä¸ªé”™è¯¯ã€‚ è¦ç•™æ„è¿™ç§ä¸ä¸€è‡´ï¼å¦‚æœæˆ‘ä»¬å°†é…ç½®ä¸­ redis ç«¯å£æ”¹æˆéæ³•çš„æ•°å­— x6381ï¼Œé‚£ä¹ˆè¿è¡Œç¨‹åºå°†æŠ¥é”™ï¼š 2020/01/14 22:43:13 strconv.ParseInt: parsing \"x6381\": invalid syntax å¤åˆ¶ä»£ç  ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-ini/:1:2","tags":["Go","ini"],"title":"Go ini","uri":"/posts/2023-11-11-go-ini/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Must*ä¾¿æ·æ–¹æ³• å¦‚æœæ¯æ¬¡å–å€¼éƒ½éœ€è¦è¿›è¡Œé”™è¯¯åˆ¤æ–­ï¼Œé‚£ä¹ˆä»£ç å†™èµ·æ¥ä¼šéå¸¸ç¹çã€‚ä¸ºæ­¤ï¼Œgo-iniä¹Ÿæä¾›å¯¹åº”çš„MustTypeï¼ˆType ä¸ºInit/Uint/Float64ç­‰ï¼‰æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åªè¿”å›ä¸€ä¸ªå€¼ã€‚ åŒæ—¶å®ƒæ¥å—å¯å˜å‚æ•°ï¼Œå¦‚æœç±»å‹æ— æ³•è½¬æ¢ï¼Œå–å‚æ•°ä¸­ç¬¬ä¸€ä¸ªå€¼è¿”å›ï¼Œå¹¶ä¸”è¯¥å‚æ•°è®¾ç½®ä¸ºè¿™ä¸ªé…ç½®çš„å€¼ï¼Œä¸‹æ¬¡è°ƒç”¨è¿”å›è¿™ä¸ªå€¼ï¼š package main import ( \"fmt\" \"log\" \"gopkg.in/ini.v1\" ) func main() { cfg, err := ini.Load(\"my.ini\") if err != nil { log.Fatal(\"Fail to read file: \", err) } redisPort, err := cfg.Section(\"redis\").Key(\"port\").Int() if err != nil { fmt.Println(\"before must, get redis port error:\", err) } else { fmt.Println(\"before must, get redis port:\", redisPort) } fmt.Println(\"redis Port:\", cfg.Section(\"redis\").Key(\"port\").MustInt(6381)) redisPort, err = cfg.Section(\"redis\").Key(\"port\").Int() if err != nil { fmt.Println(\"after must, get redis port error:\", err) } else { fmt.Println(\"after must, get redis port:\", redisPort) } } é…ç½®æ–‡ä»¶è¿˜æ˜¯ redis ç«¯å£ä¸ºéæ•°å­— x6381 æ—¶çš„çŠ¶æ€ï¼Œè¿è¡Œç¨‹åºï¼š before must, get redis port error: strconv.ParseInt: parsing \"x6381\": invalid syntax redis Port: 6381 after must, get redis port: 6381 å¤åˆ¶ä»£ç  æˆ‘ä»¬çœ‹åˆ°ç¬¬ä¸€æ¬¡è°ƒç”¨Intè¿”å›é”™è¯¯ï¼Œä»¥ 6381 ä¸ºå‚æ•°è°ƒç”¨MustIntä¹‹åï¼Œå†æ¬¡è°ƒç”¨Intï¼ŒæˆåŠŸè¿”å› 6381ã€‚MustIntæºç ä¹Ÿæ¯”è¾ƒç®€å•ï¼š // gopkg.in/ini.v1/key.go func (k *Key) MustInt(defaultVal ...int) int { val, err := k.Int() if len(defaultVal) \u003e 0 \u0026\u0026 err != nil { k.value = strconv.FormatInt(int64(defaultVal[0]), 10) return defaultVal[0] } return val } å¤åˆ¶ä»£ç  ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-ini/:1:3","tags":["Go","ini"],"title":"Go ini","uri":"/posts/2023-11-11-go-ini/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"åˆ†åŒºæ“ä½œ è·å–ä¿¡æ¯ åœ¨åŠ è½½é…ç½®ä¹‹åï¼Œå¯ä»¥é€šè¿‡Sectionsæ–¹æ³•è·å–æ‰€æœ‰åˆ†åŒºï¼ŒSectionStrings()æ–¹æ³•è·å–æ‰€æœ‰åˆ†åŒºåã€‚ sections := cfg.Sections() names := cfg.SectionStrings() fmt.Println(\"sections: \", sections) fmt.Println(\"names: \", names) å¤åˆ¶ä»£ç  è¿è¡Œè¾“å‡º 3 ä¸ªåˆ†åŒºï¼š [DEFAULT mysql redis] å¤åˆ¶ä»£ç  è°ƒç”¨Section(name)è·å–åä¸ºnameçš„åˆ†åŒºï¼Œå¦‚æœè¯¥åˆ†åŒºä¸å­˜åœ¨ï¼Œåˆ™è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåˆ†åŒºè¿”å›ï¼š newSection := cfg.Section(\"new\") fmt.Println(\"new section: \", newSection) fmt.Println(\"names: \", cfg.SectionStrings()) åˆ›å»ºä¹‹åè°ƒç”¨SectionStringsæ–¹æ³•ï¼Œæ–°åˆ†åŒºä¹Ÿä¼šè¿”å›ï¼š names: [DEFAULT mysql redis new] ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªæ–°åˆ†åŒºï¼Œå¦‚æœåˆ†åŒºå·²å­˜åœ¨ï¼Œåˆ™è¿”å›é”™è¯¯ï¼š err := cfg.NewSection(\"new\") çˆ¶å­åˆ†åŒº åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å ä½ç¬¦%(name)sè¡¨ç¤ºç”¨ä¹‹å‰å·²å®šä¹‰çš„é”®nameçš„å€¼æ¥æ›¿æ¢ï¼Œè¿™é‡Œçš„sè¡¨ç¤ºå€¼ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼š NAME = ini VERSION = v1 IMPORT_PATH = gopkg.in/%(NAME)s.%(VERSION)s [package] CLONE_URL = https://%(IMPORT_PATH)s [package.sub] ä¸Šé¢åœ¨é»˜è®¤åˆ†åŒºä¸­è®¾ç½®IMPORT_PATHçš„å€¼æ—¶ï¼Œä½¿ç”¨äº†å‰é¢å®šä¹‰çš„NAMEå’ŒVERSIONã€‚ åœ¨packageåˆ†åŒºä¸­è®¾ç½®CLONE_URLçš„å€¼æ—¶ï¼Œä½¿ç”¨äº†é»˜è®¤åˆ†åŒºä¸­å®šä¹‰çš„IMPORT_PATHã€‚ æˆ‘ä»¬è¿˜å¯ä»¥åœ¨åˆ†åŒºåä¸­ä½¿ç”¨.è¡¨ç¤ºä¸¤ä¸ªæˆ–å¤šä¸ªåˆ†åŒºä¹‹é—´çš„çˆ¶å­å…³ç³»ï¼Œä¾‹å¦‚package.subçš„çˆ¶åˆ†åŒºä¸ºpackageï¼Œpackageçš„çˆ¶åˆ†åŒºä¸ºé»˜è®¤åˆ†åŒºã€‚ å¦‚æœæŸä¸ªé”®åœ¨å­åˆ†åŒºä¸­ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåœ¨å®ƒçš„çˆ¶åˆ†åŒºä¸­å†æ¬¡æŸ¥æ‰¾ï¼Œç›´åˆ°æ²¡æœ‰çˆ¶åˆ†åŒºä¸ºæ­¢ï¼š cfg, err := ini.Load(\"parent_child.ini\") if err != nil { fmt.Println(\"Fail to read file: \", err) return } fmt.Println(\"Clone url from package.sub:\", cfg.Section(\"package.sub\").Key(\"CLONE_URL\").String()) è¿è¡Œç¨‹åºè¾“å‡ºï¼š Clone url from package.sub: https://gopkg.in/ini.v1 å­åˆ†åŒºä¸­package.subä¸­æ²¡æœ‰é”®CLONE_URLï¼Œè¿”å›äº†çˆ¶åˆ†åŒºpackageä¸­çš„å€¼ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-ini/:1:4","tags":["Go","ini"],"title":"Go ini","uri":"/posts/2023-11-11-go-ini/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"ä¿å­˜é…ç½® æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å°†ç”Ÿæˆçš„é…ç½®å†™åˆ°æ–‡ä»¶ä¸­ã€‚ä¾‹å¦‚åœ¨å†™å·¥å…·çš„æ—¶å€™ã€‚ä¿å­˜æœ‰ä¸¤ç§ç±»å‹çš„æ¥å£ï¼Œä¸€ç§ç›´æ¥ä¿å­˜åˆ°æ–‡ä»¶ï¼Œå¦ä¸€ç§å†™å…¥åˆ°io.Writerä¸­ï¼š err = cfg.SaveTo(\"my.ini\") err = cfg.SaveToIndent(\"my.ini\", \"\\t\") cfg.WriteTo(writer) cfg.WriteToIndent(writer, \"\\t\") ä¸‹é¢æˆ‘ä»¬é€šè¿‡ç¨‹åºç”Ÿæˆå‰é¢ä½¿ç”¨çš„é…ç½®æ–‡ä»¶my.iniå¹¶ä¿å­˜ï¼š package main import ( \"fmt\" \"os\" \"gopkg.in/ini.v1\" ) func main() { cfg := ini.Empty() defaultSection := cfg.Section(\"\") defaultSection.NewKey(\"app_name\", \"awesome web\") defaultSection.NewKey(\"log_level\", \"DEBUG\") mysqlSection, err := cfg.NewSection(\"mysql\") if err != nil { fmt.Println(\"new mysql section failed:\", err) return } mysqlSection.NewKey(\"ip\", \"127.0.0.1\") mysqlSection.NewKey(\"port\", \"3306\") mysqlSection.NewKey(\"user\", \"root\") mysqlSection.NewKey(\"password\", \"123456\") mysqlSection.NewKey(\"database\", \"awesome\") redisSection, err := cfg.NewSection(\"redis\") if err != nil { fmt.Println(\"new redis section failed:\", err) return } redisSection.NewKey(\"ip\", \"127.0.0.1\") redisSection.NewKey(\"port\", \"6381\") err = cfg.SaveTo(\"my.ini\") if err != nil { fmt.Println(\"SaveTo failed: \", err) } err = cfg.SaveToIndent(\"my-pretty.ini\", \"\\t\") if err != nil { fmt.Println(\"SaveToIndent failed: \", err) } cfg.WriteTo(os.Stdout) fmt.Println() cfg.WriteToIndent(os.Stdout, \"\\t\") } è¿è¡Œç¨‹åºï¼Œç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶my.iniå’Œmy-pretty.iniï¼ŒåŒæ—¶æ§åˆ¶å°è¾“å‡ºæ–‡ä»¶å†…å®¹ã€‚ my.iniï¼š app_name = awesome web log_level = DEBUG [mysql] ip = 127.0.0.1 port = 3306 user = root password = 123456 database = awesome [redis] ip = 127.0.0.1 port = 6381 my-pretty.iniï¼š app_name = awesome web log_level = DEBUG [mysql] ip = 127.0.0.1 port = 3306 user = root password = 123456 database = awesome [redis] ip = 127.0.0.1 port = 6381 *Indentæ–¹æ³•ä¼šå¯¹å­åˆ†åŒºä¸‹çš„é”®å¢åŠ ç¼©è¿›ï¼Œçœ‹èµ·æ¥ç¾è§‚ä¸€ç‚¹ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-ini/:1:5","tags":["Go","ini"],"title":"Go ini","uri":"/posts/2023-11-11-go-ini/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"åˆ†åŒºä¸ç»“æ„ä½“å­—æ®µæ˜ å°„ å®šä¹‰ç»“æ„å˜é‡ï¼ŒåŠ è½½å®Œé…ç½®æ–‡ä»¶åï¼Œè°ƒç”¨MapToå°†é…ç½®é¡¹èµ‹å€¼åˆ°ç»“æ„å˜é‡çš„å¯¹åº”å­—æ®µä¸­ã€‚ package main import ( \"fmt\" \"gopkg.in/ini.v1\" ) type Config struct { AppName string `ini:\"app_name\"` LogLevel string `ini:\"log_level\"` MySQL MySQLConfig `ini:\"mysql\"` Redis RedisConfig `ini:\"redis\"` } type MySQLConfig struct { IP string `ini:\"ip\"` Port int `ini:\"port\"` User string `ini:\"user\"` Password string `ini:\"password\"` Database string `ini:\"database\"` } type RedisConfig struct { IP string `ini:\"ip\"` Port int `ini:\"port\"` } func main() { cfg, err := ini.Load(\"my.ini\") if err != nil { fmt.Println(\"load my.ini failed: \", err) } c := Config{} cfg.MapTo(\u0026c) fmt.Println(c) } MapToå†…éƒ¨ä½¿ç”¨äº†åå°„ï¼Œæ‰€ä»¥ç»“æ„ä½“å­—æ®µå¿…é¡»éƒ½æ˜¯å¯¼å‡ºçš„ã€‚å¦‚æœé”®åä¸å­—æ®µåä¸ç›¸åŒï¼Œé‚£ä¹ˆéœ€è¦åœ¨ç»“æ„æ ‡ç­¾ä¸­æŒ‡å®šå¯¹åº”çš„é”®åã€‚ è¿™ä¸€ç‚¹ä¸ Go æ ‡å‡†åº“encoding/jsonå’Œencoding/xmlä¸åŒã€‚æ ‡å‡†åº“json/xmlè§£ææ—¶å¯ä»¥å°†é”®åapp_nameå¯¹åº”åˆ°å­—æ®µåAppNameã€‚ æˆ–è®¸è¿™æ˜¯go-iniåº“å¯ä»¥ä¼˜åŒ–çš„ç‚¹ï¼Ÿ å…ˆåŠ è½½ï¼Œå†æ˜ å°„æœ‰ç‚¹ç¹çï¼Œç›´æ¥ä½¿ç”¨ini.MapToå°†ä¸¤æ­¥åˆå¹¶ï¼š err = ini.MapTo(\u0026c, \"my.ini\") å¤åˆ¶ä»£ç  ä¹Ÿå¯ä»¥åªæ˜ å°„ä¸€ä¸ªåˆ†åŒºï¼š mysqlCfg := MySQLConfig{} err = cfg.Section(\"mysql\").MapTo(\u0026mysqlCfg) è¿˜å¯ä»¥é€šè¿‡ç»“æ„ä½“ç”Ÿæˆé…ç½®ï¼š cfg := ini.Empty() c := Config { AppName: \"awesome web\", LogLevel: \"DEBUG\", MySQL: MySQLConfig { IP: \"127.0.0.1\", Port: 3306, User: \"root\", Password:\"123456\", Database:\"awesome\", }, Redis: RedisConfig { IP: \"127.0.0.1\", Port: 6381, }, } err := ini.ReflectFrom(cfg, \u0026c) if err != nil { fmt.Println(\"ReflectFrom failed: \", err) return } err = cfg.SaveTo(\"my-copy.ini\") if err != nil { fmt.Println(\"SaveTo failed: \", err) return } ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-ini/:1:6","tags":["Go","ini"],"title":"Go ini","uri":"/posts/2023-11-11-go-ini/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æ€»ç»“ æœ¬æ–‡ä»‹ç»äº†go-iniåº“çš„åŸºæœ¬ç”¨æ³•å’Œä¸€äº›æœ‰è¶£çš„ç‰¹æ€§ã€‚ç¤ºä¾‹ä»£ç å·²ä¸Šä¼ GitHubã€‚ å…¶å®go-iniè¿˜æœ‰å¾ˆå¤šé«˜çº§ç‰¹æ€§ã€‚å®˜æ–¹æ–‡æ¡£éå¸¸è¯¦ç»†ï¼Œæ¨èå»çœ‹ï¼Œè€Œä¸”æœ‰ä¸­æ–‡å“Ÿ~ ä½œè€…æ— é—»ï¼Œç›¸ä¿¡åš Go å¼€å‘çš„éƒ½ä¸é™Œç”Ÿã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-ini/:1:7","tags":["Go","ini"],"title":"Go ini","uri":"/posts/2023-11-11-go-ini/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å‚è€ƒ go-ini GitHub ä»“åº“ go-ini å®˜æ–¹æ–‡æ¡£ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-ini/:1:8","tags":["Go","ini"],"title":"Go ini","uri":"/posts/2023-11-11-go-ini/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"homedirå®¶ç›®å½• GitHubåœ°å€ï¼šhttps://github.com/mitchellh/go-homedir ä½¿ç”¨os/userè·å–ç”¨æˆ·å®¶ç›®å½•ï¼š package main import ( \"fmt\" \"log\" \"os/user\" ) func main() { u, err := user.Current() if err != nil { log.Fatal(err) } fmt.Println(\"Home dir:\", u.HomeDir) } é‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜è¦go-homediråº“ï¼Ÿ åœ¨ Darwin ç³»ç»Ÿä¸Šï¼Œæ ‡å‡†åº“os/userçš„ä½¿ç”¨éœ€è¦ cgoã€‚æ‰€ä»¥ï¼Œä»»ä½•ä½¿ç”¨os/userçš„ä»£ç éƒ½ä¸èƒ½äº¤å‰ç¼–è¯‘ã€‚ ä½†æ˜¯ï¼Œå¤§å¤šæ•°äººä½¿ç”¨os/userçš„ç›®çš„ä»…ä»…åªæ˜¯æƒ³è·å–ä¸»ç›®å½•ã€‚å› æ­¤ï¼Œgo-homediråº“å‡ºç°äº†ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-homedir/:1:0","tags":["Go","homedir"],"title":"Go homedir","uri":"/posts/2023-11-11-go-homedir/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å¿«é€Ÿä½¿ç”¨ go-homediræ˜¯ç¬¬ä¸‰æ–¹åŒ…ï¼Œä½¿ç”¨å‰éœ€è¦å…ˆå®‰è£…ï¼š $ go get github.com/mitchellh/go-homedir ä½¿ç”¨éå¸¸ç®€å•ï¼š package main import ( \"fmt\" \"log\" \"github.com/mitchellh/go-homedir\" ) func main() { dir, err := homedir.Dir() if err != nil { log.Fatal(err) } fmt.Println(\"Home dir:\", dir) dir = \"~/golang/src\" expandedDir, err := homedir.Expand(dir) if err != nil { log.Fatal(err) } fmt.Printf(\"Expand of %s is: %s\\n\", dir, expandedDir) } go-homediræœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼š Dirï¼šè·å–ç”¨æˆ·ä¸»ç›®å½•ï¼› Expandï¼šå°†è·¯å¾„ä¸­çš„ç¬¬ä¸€ä¸ª~æ‰©å±•æˆç”¨æˆ·ä¸»ç›®å½•ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-homedir/:1:1","tags":["Go","homedir"],"title":"Go homedir","uri":"/posts/2023-11-11-go-homedir/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"é«˜çº§ç”¨æ³• ç”±äºDirçš„è°ƒç”¨å¯èƒ½æ¶‰åŠä¸€äº›ç³»ç»Ÿè°ƒç”¨å’Œå¤–éƒ¨æ‰§è¡Œå‘½ä»¤ï¼Œå¤šæ¬¡è°ƒç”¨è´¹æ€§èƒ½ã€‚æ‰€ä»¥go-homediræä¾›äº†ç¼“å­˜çš„åŠŸèƒ½ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç¼“å­˜æ˜¯å¼€å¯çš„ã€‚ æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†DisableCacheè®¾ç½®ä¸ºfalseæ¥å…³é—­å®ƒã€‚ package main import ( \"fmt\" \"log\" \"github.com/mitchellh/go-homedir\" ) func main() { homedir.DisableCache = false dir, err := homedir.Dir() if err != nil { log.Fatal(err) } fmt.Println(\"Home dir:\", dir) } ä½¿ç”¨ç¼“å­˜æ—¶ï¼Œå¦‚æœç¨‹åºè¿è¡Œä¸­ä¿®æ”¹äº†ä¸»ç›®å½•ï¼Œå†æ¬¡è°ƒç”¨Dirè¿˜æ˜¯è¿”å›ä¹‹å‰çš„ç›®å½•ã€‚å¦‚æœéœ€è¦è·å–æœ€æ–°çš„ä¸»ç›®å½•ï¼Œå¯ä»¥å…ˆè°ƒç”¨Resetæ¸…é™¤ç¼“å­˜ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-homedir/:1:2","tags":["Go","homedir"],"title":"Go homedir","uri":"/posts/2023-11-11-go-homedir/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å®ç° go-homediræºç åªæœ‰ä¸€ä¸ªæ–‡ä»¶homedir.goï¼Œä»Šå¤©æˆ‘ä»¬å¤§æ¦‚çœ‹ä¸€ä¸‹Dirçš„å®ç°ï¼Œå»æ‰ç¼“å­˜ç›¸å…³ä»£ç ï¼š func Dir() (string, error) { var result string var err error if runtime.GOOS == \"windows\" { result, err = dirWindows() } else { // Unix-like system, so just assume Unix result, err = dirUnix() } if err != nil { return \"\", err } return result, nil } åˆ¤æ–­å½“å‰çš„ç³»ç»Ÿæ˜¯windowsè¿˜æ˜¯ç±» Unixï¼Œåˆ†åˆ«è°ƒç”¨ä¸åŒçš„æ–¹æ³•ã€‚å…ˆçœ‹ windows çš„ï¼Œæ¯”è¾ƒç®€å•ï¼š func dirWindows() (string, error) { // First prefer the HOME environmental variable if home := os.Getenv(\"HOME\"); home != \"\" { return home, nil } // Prefer standard environment variable USERPROFILE if home := os.Getenv(\"USERPROFILE\"); home != \"\" { return home, nil } drive := os.Getenv(\"HOMEDRIVE\") path := os.Getenv(\"HOMEPATH\") home := drive + path if drive == \"\" || path == \"\" { return \"\", errors.New(\"HOMEDRIVE, HOMEPATH, or USERPROFILE are blank\") } return home, nil } æµç¨‹å¦‚ä¸‹ï¼š è¯»å–ç¯å¢ƒå˜é‡HOMEï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œè¿”å›è¿™ä¸ªå€¼ï¼› è¯»å–ç¯å¢ƒå˜é‡USERPROFILEï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œè¿”å›è¿™ä¸ªå€¼ï¼› è¯»å–ç¯å¢ƒå˜é‡HOMEDRIVEå’ŒHOMEPATHï¼Œå¦‚æœä¸¤è€…éƒ½ä¸ä¸ºç©ºï¼Œæ‹¼æ¥è¿™ä¸¤ä¸ªå€¼è¿”å›ã€‚ ç±» Unix ç³»ç»Ÿçš„å®ç°ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼š func dirUnix() (string, error) { homeEnv := \"HOME\" if runtime.GOOS == \"plan9\" { // On plan9, env vars are lowercase. homeEnv = \"home\" } // First prefer the HOME environmental variable if home := os.Getenv(homeEnv); home != \"\" { return home, nil } var stdout bytes.Buffer // If that fails, try OS specific commands if runtime.GOOS == \"darwin\" { cmd := exec.Command(\"sh\", \"-c\", `dscl -q . -read /Users/\"$(whoami)\" NFSHomeDirectory | sed 's/^[^ ]*: //'`) cmd.Stdout = \u0026stdout if err := cmd.Run(); err == nil { result := strings.TrimSpace(stdout.String()) if result != \"\" { return result, nil } } } else { cmd := exec.Command(\"getent\", \"passwd\", strconv.Itoa(os.Getuid())) cmd.Stdout = \u0026stdout if err := cmd.Run(); err != nil { // If the error is ErrNotFound, we ignore it. Otherwise, return it. if err != exec.ErrNotFound { return \"\", err } } else { if passwd := strings.TrimSpace(stdout.String()); passwd != \"\" { // username:password:uid:gid:gecos:home:shell passwdParts := strings.SplitN(passwd, \":\", 7) if len(passwdParts) \u003e 5 { return passwdParts[5], nil } } } } // If all else fails, try the shell stdout.Reset() cmd := exec.Command(\"sh\", \"-c\", \"cd \u0026\u0026 pwd\") cmd.Stdout = \u0026stdout if err := cmd.Run(); err != nil { return \"\", err } result := strings.TrimSpace(stdout.String()) if result == \"\" { return \"\", errors.New(\"blank output when reading home directory\") } return result, nil } æµç¨‹å¦‚ä¸‹ï¼š å…ˆè¯»å–ç¯å¢ƒå˜é‡HOMEï¼ˆæ³¨æ„ plan9 ç³»ç»Ÿä¸Šä¸ºhomeï¼‰ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œè¿”å›è¿™ä¸ªå€¼ï¼› ä½¿ç”¨getnetå‘½ä»¤æŸ¥çœ‹ç³»ç»Ÿçš„æ•°æ®åº“ä¸­çš„ç›¸å…³è®°å½•ï¼Œæˆ‘ä»¬çŸ¥é“passwdæ–‡ä»¶ä¸­å­˜å‚¨äº†ç”¨æˆ·ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç”¨æˆ·çš„ä¸»ç›®å½•ã€‚ä½¿ç”¨getentå‘½ä»¤æŸ¥çœ‹passwdä¸­å½“å‰ç”¨æˆ·çš„é‚£æ¡è®°å½•ï¼Œç„¶åä»ä¸­æ‰¾åˆ°ä¸»ç›®å½•éƒ¨åˆ†è¿”å›ï¼› å¦‚æœä¸Šä¸€ä¸ªæ­¥éª¤å¤±è´¥äº†ï¼Œæˆ‘ä»¬çŸ¥é“cdåä¸åŠ å‚æ•°æ˜¯ç›´æ¥åˆ‡æ¢åˆ°ç”¨æˆ·ä¸»ç›®å½•çš„ï¼Œè€Œpwdå¯ä»¥æ˜¾ç¤ºå½“å‰ç›®å½•ã€‚é‚£ä¹ˆå°±å¯ä»¥ç»“åˆè¿™ä¸¤ä¸ªå‘½ä»¤è¿”å›ä¸»ç›®å½•ã€‚ è¿™é‡Œåˆ†ææºç å¹¶ä¸æ˜¯è¡¨ç¤ºä½¿ç”¨ä»»ä½•åº“éƒ½è¦ç†Ÿæ‚‰å®ƒçš„æºç ï¼Œæ¯•ç«Ÿä½¿ç”¨åº“å°±æ˜¯ä¸ºäº†æ–¹ä¾¿å¼€å‘ã€‚ ä½†æ˜¯æºç æ˜¯æˆ‘ä»¬å­¦ä¹ å’Œæé«˜çš„ä¸€ä¸ªéå¸¸é‡è¦çš„é€”å¾„ã€‚æˆ‘ä»¬åœ¨ä½¿ç”¨åº“é‡åˆ°é—®é¢˜çš„æ—¶å€™ä¹Ÿè¦æœ‰èƒ½åŠ›ä»æ–‡æ¡£æˆ–ç”šè‡³æºç ä¸­æŸ¥æ‰¾åŸå› ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-homedir/:1:3","tags":["Go","homedir"],"title":"Go homedir","uri":"/posts/2023-11-11-go-homedir/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go Fsnotifyåº“ å®˜æ–¹ä»“åº“ï¼šgithub.com/fsnotify/fsnotify ç”¨äºç›‘æ§æ–‡ä»¶æˆ–ç›®å½•çš„æ”¹å˜ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-fsnotify/:1:0","tags":["Go","fsnotify"],"title":"Go fsnotify","uri":"/posts/2023-11-11-go-fsnotify/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"1ã€å®˜ç½‘ç¤ºä¾‹ package main import ( \"log\" \"github.com/fsnotify/fsnotify\" ) func main() { watcher, err := fsnotify.NewWatcher() if err != nil { log.Fatal(err) } defer watcher.Close() done := make(chan bool) go func() { for { select { case event := \u003c-watcher.Events: log.Println(\"event:\", event) if event.Op\u0026fsnotify.Write == fsnotify.Write { log.Println(\"modified file:\", event.Name) } case err := \u003c-watcher.Errors: log.Println(\"error:\", err) } } }() err = watcher.Add(\"/tmp/foo\") if err != nil { log.Fatal(err) } \u003c-done } fsnotifyçš„ä½¿ç”¨æ¯”è¾ƒç®€å•: å…ˆæ¡ç”¨NewWatcheråˆ›å»ºä¸€ä¸ªç›‘å¬å™¨ ç„¶åæ¡ç”¨ç›‘å¬å™¨çš„Addç›‘å¬æ–‡ä»¶æˆ–ç›®å½• å¦‚æœç›®å½•æˆ–æ–‡ä»¶æœ‰äº‹ä»¶å‘ç”Ÿï¼Œç›‘å¬å™¨çš„é€šé“Eventså¯ä»¥å–å‡ºäº‹ä»¶ã€‚å¦‚æœå‡ºç°é”™è¯¯ï¼Œç›‘å¬å™¨ä¸­çš„é€šé“Errorså¯ä»¥å–å‡ºé”™è¯¯ä¿¡æ¯ã€‚ å…¶å®ï¼Œé‡å‘½åæ—¶ä¼šäº§ç”Ÿä¸¤ä¸ªäº‹ä»¶ï¼Œä¸€ä¸ªæ˜¯åŸæ–‡ä»¶çš„RENAMEäº‹ä»¶ï¼Œä¸€ä¸ªæ˜¯æ–°æ–‡ä»¶çš„CREATEäº‹ä»¶ã€‚ æ³¨æ„ï¼Œfsnotifyä½¿ç”¨äº†æ“ä½œç³»ç»Ÿæ¥å£ï¼Œç›‘å¬å™¨ä¸­ä¿å­˜äº†ç³»ç»Ÿèµ„æºçš„å¥æŸ„ï¼Œæ‰€ä»¥ä½¿ç”¨åéœ€è¦å…³é—­ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-fsnotify/:1:1","tags":["Go","fsnotify"],"title":"Go fsnotify","uri":"/posts/2023-11-11-go-fsnotify/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"2ã€äº‹ä»¶ ä¸Šé¢ç¤ºä¾‹ä¸­çš„äº‹ä»¶æ˜¯fsnotify.Eventç±»å‹ï¼š // fsnotify/fsnotify.go type Event struct { Name string Op Op } äº‹ä»¶åªæœ‰ä¸¤ä¸ªå­—æ®µï¼ŒNameè¡¨ç¤ºå‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶æˆ–ç›®å½•åï¼ŒOpè¡¨ç¤ºå…·ä½“çš„å˜åŒ–ã€‚Opæœ‰ 5 ä¸­å–å€¼ï¼š // fsnotify/fsnotify.go type Op uint32 const ( Create Op = 1 \u003c\u003c iota Write Remove Rename Chmod ) 3ã€ç›‘æ§ç›®å½• å‚è€ƒé“¾æ¥ï¼šhttps://blog.csdn.net/finghting321/article/details/102852746 package main; import ( \"github.com/fsnotify/fsnotify\" \"fmt\" \"path/filepath\" \"os\" ) type NotifyFile struct { watch *fsnotify.Watcher } func NewNotifyFile() *NotifyFile { w := new(NotifyFile) w.watch, _ = fsnotify.NewWatcher() return w } //ç›‘æ§ç›®å½• func (this *NotifyFile) WatchDir(dir string) { //é€šè¿‡Walkæ¥éå†ç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½• filepath.Walk(dir, func(path string, info os.FileInfo, err error) error { //åˆ¤æ–­æ˜¯å¦ä¸ºç›®å½•ï¼Œç›‘æ§ç›®å½•,ç›®å½•ä¸‹æ–‡ä»¶ä¹Ÿåœ¨ç›‘æ§èŒƒå›´å†…ï¼Œä¸éœ€è¦åŠ  if info.IsDir() { path, err := filepath.Abs(path) if err != nil { return err } err = this.watch.Add(path) if err != nil { return err } fmt.Println(\"ç›‘æ§ : \", path) } return nil }) go this.WatchEvent() //åç¨‹ } func (this *NotifyFile) WatchEvent() { for { select { case ev := \u003c-this.watch.Events: { if ev.Op\u0026fsnotify.Create == fsnotify.Create { fmt.Println(\"åˆ›å»ºæ–‡ä»¶ : \", ev.Name) //è·å–æ–°åˆ›å»ºæ–‡ä»¶çš„ä¿¡æ¯ï¼Œå¦‚æœæ˜¯ç›®å½•ï¼Œåˆ™åŠ å…¥ç›‘æ§ä¸­ file, err := os.Stat(ev.Name) if err == nil \u0026\u0026 file.IsDir() { this.watch.Add(ev.Name) fmt.Println(\"æ·»åŠ ç›‘æ§ : \", ev.Name) } } if ev.Op\u0026fsnotify.Write == fsnotify.Write { //fmt.Println(\"å†™å…¥æ–‡ä»¶ : \", ev.Name) } if ev.Op\u0026fsnotify.Remove == fsnotify.Remove { fmt.Println(\"åˆ é™¤æ–‡ä»¶ : \", ev.Name) //å¦‚æœåˆ é™¤æ–‡ä»¶æ˜¯ç›®å½•ï¼Œåˆ™ç§»é™¤ç›‘æ§ fi, err := os.Stat(ev.Name) if err == nil \u0026\u0026 fi.IsDir() { this.watch.Remove(ev.Name) fmt.Println(\"åˆ é™¤ç›‘æ§ : \", ev.Name) } } if ev.Op\u0026fsnotify.Rename == fsnotify.Rename { //å¦‚æœé‡å‘½åæ–‡ä»¶æ˜¯ç›®å½•ï¼Œåˆ™ç§»é™¤ç›‘æ§ ,æ³¨æ„è¿™é‡Œæ— æ³•ä½¿ç”¨os.Statæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ç›®å½•äº† //å› ä¸ºé‡å‘½ååï¼Œgoå·²ç»æ— æ³•æ‰¾åˆ°åŸæ–‡ä»¶æ¥è·å–ä¿¡æ¯äº†,æ‰€ä»¥ç®€å•ç²—çˆ†ç›´æ¥remove fmt.Println(\"é‡å‘½åæ–‡ä»¶ : \", ev.Name) this.watch.Remove(ev.Name) } if ev.Op\u0026fsnotify.Chmod == fsnotify.Chmod { fmt.Println(\"ä¿®æ”¹æƒé™ : \", ev.Name) } } case err := \u003c-this.watch.Errors: { fmt.Println(\"error : \", err) return } } } func main() { watch := FSNotify.NewNotifyFile() watch.WatchDir(\"G:\\\\Ferry\") select {} return } ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-fsnotify/:1:2","tags":["Go","fsnotify"],"title":"Go fsnotify","uri":"/posts/2023-11-11-go-fsnotify/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go fmtæ¨¡å— å‚è€ƒé“¾æ¥ï¼šhttps://www.liwenzhou.com/posts/Go/go_fmt/ fmt fmtåŒ…å®ç°äº†ç±»ä¼¼Cè¯­è¨€printfå’Œscanfçš„æ ¼å¼åŒ–I/Oã€‚ä¸»è¦åˆ†ä¸ºå‘å¤–è¾“å‡ºå†…å®¹å’Œè·å–è¾“å…¥å†…å®¹ä¸¤å¤§éƒ¨åˆ†ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-fmt/:1:0","tags":["Go","fmt"],"title":"Go fmt","uri":"/posts/2023-11-11-go-fmt/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å‘å¤–è¾“å‡º æ ‡å‡†åº“fmtæä¾›äº†ä»¥ä¸‹å‡ ç§è¾“å‡ºç›¸å…³å‡½æ•°ã€‚ Print Printç³»åˆ—å‡½æ•°ä¼šå°†å†…å®¹è¾“å‡ºåˆ°ç³»ç»Ÿçš„æ ‡å‡†è¾“å‡ºï¼ŒåŒºåˆ«åœ¨äºPrintå‡½æ•°ç›´æ¥è¾“å‡ºå†…å®¹ï¼ŒPrintfå‡½æ•°æ”¯æŒæ ¼å¼åŒ–è¾“å‡ºå­—ç¬¦ä¸²ï¼ŒPrintlnå‡½æ•°ä¼šåœ¨è¾“å‡ºå†…å®¹çš„ç»“å°¾æ·»åŠ ä¸€ä¸ªæ¢è¡Œç¬¦ã€‚ func Print(a ...interface{}) (n int, err error) func Printf(format string, a ...interface{}) (n int, err error) func Println(a ...interface{}) (n int, err error) ä¾‹å¦‚ï¼š func main() { fmt.Print(\"åœ¨ç»ˆç«¯æ‰“å°è¯¥ä¿¡æ¯ã€‚\") name := \"æ²™æ²³å°ç‹å­\" fmt.Printf(\"æˆ‘æ˜¯ï¼š%s\\n\", name) fmt.Println(\"åœ¨ç»ˆç«¯æ‰“å°å•ç‹¬ä¸€è¡Œæ˜¾ç¤º\") } è¾“å‡ºç»“æœï¼š åœ¨ç»ˆç«¯æ‰“å°è¯¥ä¿¡æ¯ã€‚æˆ‘æ˜¯ï¼šæ²™æ²³å°ç‹å­ åœ¨ç»ˆç«¯æ‰“å°å•ç‹¬ä¸€è¡Œæ˜¾ç¤º Fprint Fprintç³»åˆ—å‡½æ•°ä¼šå°†å†…å®¹è¾“å‡ºåˆ°ä¸€ä¸ªio.Writeræ¥å£ç±»å‹çš„å˜é‡wä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ç”¨è¿™ä¸ªå‡½æ•°å¾€æ–‡ä»¶ä¸­å†™å…¥å†…å®¹ã€‚ func Fprint(w io.Writer, a ...interface{}) (n int, err error) func Fprintf(w io.Writer, format string, a ...interface{}) (n int, err error) func Fprintln(w io.Writer, a ...interface{}) (n int, err error) ä¾‹å¦‚ï¼š // å‘æ ‡å‡†è¾“å‡ºå†™å…¥å†…å®¹ fmt.Fprintln(os.Stdout, \"å‘æ ‡å‡†è¾“å‡ºå†™å…¥å†…å®¹\") fileObj, err := os.OpenFile(\"./xx.txt\", os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0644) if err != nil { fmt.Println(\"æ‰“å¼€æ–‡ä»¶å‡ºé”™ï¼Œerr:\", err) return } name := \"æ²™æ²³å°ç‹å­\" // å‘æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„ä¸­å†™å…¥å†…å®¹ fmt.Fprintf(fileObj, \"å¾€æ–‡ä»¶ä¸­å†™å¦‚ä¿¡æ¯ï¼š%s\", name) Sprint Sprintç³»åˆ—å‡½æ•°ä¼šæŠŠä¼ å…¥çš„æ•°æ®ç”Ÿæˆå¹¶è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚ func Sprint(a ...interface{}) string func Sprintf(format string, a ...interface{}) string func Sprintln(a ...interface{}) string ç¤ºä¾‹ï¼š s1 := fmt.Sprint(\"æ²™æ²³å°ç‹å­\") name := \"æ²™æ²³å°ç‹å­\" age := 18 s2 := fmt.Sprintf(\"name:%s,age:%d\", name, age) s3 := fmt.Sprintln(\"æ²™æ²³å°ç‹å­\") fmt.Println(s1, s2, s3) Errorf Errorfå‡½æ•°æ ¹æ®formatå‚æ•°ç”Ÿæˆæ ¼å¼åŒ–å­—ç¬¦ä¸²å¹¶è¿”å›ä¸€ä¸ªåŒ…å«è¯¥å­—ç¬¦ä¸²çš„é”™è¯¯ã€‚ func Errorf(format string, a ...interface{}) error é€šå¸¸ä½¿ç”¨è¿™ç§æ–¹å¼æ¥è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼Œä¾‹å¦‚ï¼š err := fmt.Errorf(\"è¿™æ˜¯ä¸€ä¸ªé”™è¯¯\") Go1.13ç‰ˆæœ¬ä¸ºfmt.Errorfå‡½æ•°æ–°åŠ äº†ä¸€ä¸ª%wå ä½ç¬¦ç”¨æ¥ç”Ÿæˆä¸€ä¸ªå¯ä»¥åŒ…è£¹Errorçš„Wrapping Errorã€‚ e := errors.New(\"åŸå§‹é”™è¯¯e\") w := fmt.Errorf(\"Wrapäº†ä¸€ä¸ªé”™è¯¯%w\", e) ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-fmt/:1:1","tags":["Go","fmt"],"title":"Go fmt","uri":"/posts/2023-11-11-go-fmt/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æ ¼å¼åŒ–å ä½ç¬¦ *printfç³»åˆ—å‡½æ•°éƒ½æ”¯æŒformatæ ¼å¼åŒ–å‚æ•°ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æŒ‰ç…§å ä½ç¬¦å°†è¢«æ›¿æ¢çš„å˜é‡ç±»å‹åˆ’åˆ†ï¼Œæ–¹ä¾¿æŸ¥è¯¢å’Œè®°å¿†ã€‚ é€šç”¨å ä½ç¬¦ å ä½ç¬¦ è¯´æ˜ %v å€¼çš„é»˜è®¤æ ¼å¼è¡¨ç¤º %+v ç±»ä¼¼%vï¼Œä½†è¾“å‡ºç»“æ„ä½“æ—¶ä¼šæ·»åŠ å­—æ®µå %#v å€¼çš„Goè¯­æ³•è¡¨ç¤º %T æ‰“å°å€¼çš„ç±»å‹ %% ç™¾åˆ†å· ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š fmt.Printf(\"%v\\n\", 100) fmt.Printf(\"%v\\n\", false) o := struct{ name string }{\"å°ç‹å­\"} fmt.Printf(\"%v\\n\", o) fmt.Printf(\"%#v\\n\", o) fmt.Printf(\"%T\\n\", o) fmt.Printf(\"100%%\\n\") è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š 100 false {å°ç‹å­} struct { name string }{name:\"å°ç‹å­\"} struct { name string } 100% å¸ƒå°”å‹ å ä½ç¬¦ è¯´æ˜ %t trueæˆ–false æ•´å‹ å ä½ç¬¦ è¯´æ˜ %b è¡¨ç¤ºä¸ºäºŒè¿›åˆ¶ %c è¯¥å€¼å¯¹åº”çš„unicodeç å€¼ %d è¡¨ç¤ºä¸ºåè¿›åˆ¶ %o è¡¨ç¤ºä¸ºå…«è¿›åˆ¶ %x è¡¨ç¤ºä¸ºåå…­è¿›åˆ¶ï¼Œä½¿ç”¨a-f %X è¡¨ç¤ºä¸ºåå…­è¿›åˆ¶ï¼Œä½¿ç”¨A-F %U è¡¨ç¤ºä¸ºUnicodeæ ¼å¼ï¼šU+1234ï¼Œç­‰ä»·äºâ€U+%04Xâ€ %q è¯¥å€¼å¯¹åº”çš„å•å¼•å·æ‹¬èµ·æ¥çš„goè¯­æ³•å­—ç¬¦å­—é¢å€¼ï¼Œå¿…è¦æ—¶ä¼šé‡‡ç”¨å®‰å…¨çš„è½¬ä¹‰è¡¨ç¤º ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š n := 65 fmt.Printf(\"%b\\n\", n) fmt.Printf(\"%c\\n\", n) fmt.Printf(\"%d\\n\", n) fmt.Printf(\"%o\\n\", n) fmt.Printf(\"%x\\n\", n) fmt.Printf(\"%X\\n\", n) è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š 1000001 A 65 101 41 41 æµ®ç‚¹æ•°ä¸å¤æ•° å ä½ç¬¦ è¯´æ˜ %b æ— å°æ•°éƒ¨åˆ†ã€äºŒè¿›åˆ¶æŒ‡æ•°çš„ç§‘å­¦è®¡æ•°æ³•ï¼Œå¦‚-123456p-78 %e ç§‘å­¦è®¡æ•°æ³•ï¼Œå¦‚-1234.456e+78 %E ç§‘å­¦è®¡æ•°æ³•ï¼Œå¦‚-1234.456E+78 %f æœ‰å°æ•°éƒ¨åˆ†ä½†æ— æŒ‡æ•°éƒ¨åˆ†ï¼Œå¦‚123.456 %F ç­‰ä»·äº%f %g æ ¹æ®å®é™…æƒ…å†µé‡‡ç”¨%eæˆ–%fæ ¼å¼ï¼ˆä»¥è·å¾—æ›´ç®€æ´ã€å‡†ç¡®çš„è¾“å‡ºï¼‰ %G æ ¹æ®å®é™…æƒ…å†µé‡‡ç”¨%Eæˆ–%Fæ ¼å¼ï¼ˆä»¥è·å¾—æ›´ç®€æ´ã€å‡†ç¡®çš„è¾“å‡ºï¼‰ ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š f := 12.34 fmt.Printf(\"%b\\n\", f) fmt.Printf(\"%e\\n\", f) fmt.Printf(\"%E\\n\", f) fmt.Printf(\"%f\\n\", f) fmt.Printf(\"%g\\n\", f) fmt.Printf(\"%G\\n\", f) è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š 6946802425218990p-49 1.234000e+01 1.234000E+01 12.340000 12.34 12.34 å­—ç¬¦ä¸²å’Œ[]byte å ä½ç¬¦ è¯´æ˜ %s ç›´æ¥è¾“å‡ºå­—ç¬¦ä¸²æˆ–è€…[]byte %q è¯¥å€¼å¯¹åº”çš„åŒå¼•å·æ‹¬èµ·æ¥çš„goè¯­æ³•å­—ç¬¦ä¸²å­—é¢å€¼ï¼Œå¿…è¦æ—¶ä¼šé‡‡ç”¨å®‰å…¨çš„è½¬ä¹‰è¡¨ç¤º %x æ¯ä¸ªå­—èŠ‚ç”¨ä¸¤å­—ç¬¦åå…­è¿›åˆ¶æ•°è¡¨ç¤ºï¼ˆä½¿ç”¨a-f %X æ¯ä¸ªå­—èŠ‚ç”¨ä¸¤å­—ç¬¦åå…­è¿›åˆ¶æ•°è¡¨ç¤ºï¼ˆä½¿ç”¨A-Fï¼‰ ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š s := \"å°ç‹å­\" fmt.Printf(\"%s\\n\", s) fmt.Printf(\"%q\\n\", s) fmt.Printf(\"%x\\n\", s) fmt.Printf(\"%X\\n\", s) è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š å°ç‹å­ \"å°ç‹å­\" e5b08fe78e8be5ad90 E5B08FE78E8BE5AD90 æŒ‡é’ˆ å ä½ç¬¦ è¯´æ˜ %p è¡¨ç¤ºä¸ºåå…­è¿›åˆ¶ï¼Œå¹¶åŠ ä¸Šå‰å¯¼çš„0x ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š a := 10 fmt.Printf(\"%p\\n\", \u0026a) fmt.Printf(\"%#p\\n\", \u0026a) è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š 0xc000094000 c000094000 å®½åº¦æ ‡è¯†ç¬¦ å®½åº¦é€šè¿‡ä¸€ä¸ªç´§è·Ÿåœ¨ç™¾åˆ†å·åé¢çš„åè¿›åˆ¶æ•°æŒ‡å®šï¼Œå¦‚æœæœªæŒ‡å®šå®½åº¦ï¼Œåˆ™è¡¨ç¤ºå€¼æ—¶é™¤å¿…éœ€ä¹‹å¤–ä¸ä½œå¡«å……ã€‚ç²¾åº¦é€šè¿‡ï¼ˆå¯é€‰çš„ï¼‰å®½åº¦åè·Ÿç‚¹å·åè·Ÿçš„åè¿›åˆ¶æ•°æŒ‡å®šã€‚å¦‚æœæœªæŒ‡å®šç²¾åº¦ï¼Œä¼šä½¿ç”¨é»˜è®¤ç²¾åº¦ï¼›å¦‚æœç‚¹å·åæ²¡æœ‰è·Ÿæ•°å­—ï¼Œè¡¨ç¤ºç²¾åº¦ä¸º0ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š å ä½ç¬¦ è¯´æ˜ %f é»˜è®¤å®½åº¦ï¼Œé»˜è®¤ç²¾åº¦ %9f å®½åº¦9ï¼Œé»˜è®¤ç²¾åº¦ %.2f é»˜è®¤å®½åº¦ï¼Œç²¾åº¦2 %9.2f å®½åº¦9ï¼Œç²¾åº¦2 %9.f å®½åº¦9ï¼Œç²¾åº¦0 ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š n := 12.34 fmt.Printf(\"%f\\n\", n) fmt.Printf(\"%9f\\n\", n) fmt.Printf(\"%.2f\\n\", n) fmt.Printf(\"%9.2f\\n\", n) fmt.Printf(\"%9.f\\n\", n) è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š 12.340000 12.340000 12.34 12.34 12 å…¶ä»–falg å ä½ç¬¦ è¯´æ˜ â€™+â€™ æ€»æ˜¯è¾“å‡ºæ•°å€¼çš„æ­£è´Ÿå·ï¼›å¯¹%qï¼ˆ%+qï¼‰ä¼šç”Ÿæˆå…¨éƒ¨æ˜¯ASCIIå­—ç¬¦çš„è¾“å‡ºï¼ˆé€šè¿‡è½¬ä¹‰ï¼‰ï¼› â€™ â€˜ å¯¹æ•°å€¼ï¼Œæ­£æ•°å‰åŠ ç©ºæ ¼è€Œè´Ÿæ•°å‰åŠ è´Ÿå·ï¼›å¯¹å­—ç¬¦ä¸²é‡‡ç”¨%xæˆ–%Xæ—¶ï¼ˆ% xæˆ–% Xï¼‰ä¼šç»™å„æ‰“å°çš„å­—èŠ‚ä¹‹é—´åŠ ç©ºæ ¼ â€™-â€™ åœ¨è¾“å‡ºå³è¾¹å¡«å……ç©ºç™½è€Œä¸æ˜¯é»˜è®¤çš„å·¦è¾¹ï¼ˆå³ä»é»˜è®¤çš„å³å¯¹é½åˆ‡æ¢ä¸ºå·¦å¯¹é½ï¼‰ï¼› â€™#â€™ å…«è¿›åˆ¶æ•°å‰åŠ 0ï¼ˆ%#oï¼‰ï¼Œåå…­è¿›åˆ¶æ•°å‰åŠ 0xï¼ˆ%#xï¼‰æˆ–0Xï¼ˆ%#Xï¼‰ï¼ŒæŒ‡é’ˆå»æ‰å‰é¢çš„0xï¼ˆ%#pï¼‰å¯¹%qï¼ˆ%#qï¼‰ï¼Œå¯¹%Uï¼ˆ%#Uï¼‰ä¼šè¾“å‡ºç©ºæ ¼å’Œå•å¼•å·æ‹¬èµ·æ¥çš„goå­—é¢å€¼ï¼› â€˜0â€™ ä½¿ç”¨0è€Œä¸æ˜¯ç©ºæ ¼å¡«å……ï¼Œå¯¹äºæ•°å€¼ç±»å‹ä¼šæŠŠå¡«å……çš„0æ”¾åœ¨æ­£è´Ÿå·åé¢ï¼› ä¸¾ä¸ªä¾‹å­ï¼š s := \"å°ç‹å­\" fmt.Printf(\"%s\\n\", s) fmt.Printf(\"%5s\\n\", s) fmt.Printf(\"%-5s\\n\", s) fmt.Printf(\"%5.7s\\n\", s) fmt.Printf(\"%-5.7s\\n\", s) fmt.Printf(\"%5.2s\\n\", s) fmt.Printf(\"%05s\\n\", s) è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š å°ç‹å­ å°ç‹å­ å°ç‹å­ å°ç‹å­ å°ç‹å­ å°ç‹ 00å°ç‹å­ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-fmt/:1:2","tags":["Go","fmt"],"title":"Go fmt","uri":"/posts/2023-11-11-go-fmt/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"è·å–è¾“å…¥ Goè¯­è¨€fmtåŒ…ä¸‹æœ‰fmt.Scanã€fmt.Scanfã€fmt.Scanlnä¸‰ä¸ªå‡½æ•°ï¼Œå¯ä»¥åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ä»æ ‡å‡†è¾“å…¥è·å–ç”¨æˆ·çš„è¾“å…¥ã€‚ fmt.Scan å‡½æ•°å®šç­¾åå¦‚ä¸‹ï¼š func Scan(a ...interface{}) (n int, err error) Scanä»æ ‡å‡†è¾“å…¥æ‰«ææ–‡æœ¬ï¼Œè¯»å–ç”±ç©ºç™½ç¬¦åˆ†éš”çš„å€¼ä¿å­˜åˆ°ä¼ é€’ç»™æœ¬å‡½æ•°çš„å‚æ•°ä¸­ï¼Œæ¢è¡Œç¬¦è§†ä¸ºç©ºç™½ç¬¦ã€‚ æœ¬å‡½æ•°è¿”å›æˆåŠŸæ‰«æçš„æ•°æ®ä¸ªæ•°å’Œé‡åˆ°çš„ä»»ä½•é”™è¯¯ã€‚å¦‚æœè¯»å–çš„æ•°æ®ä¸ªæ•°æ¯”æä¾›çš„å‚æ•°å°‘ï¼Œä¼šè¿”å›ä¸€ä¸ªé”™è¯¯æŠ¥å‘ŠåŸå› ã€‚ å…·ä½“ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š func main() { var ( name string age int married bool ) fmt.Scan(\u0026name, \u0026age, \u0026married) fmt.Printf(\"æ‰«æç»“æœ name:%s age:%d married:%t \\n\", name, age, married) } å°†ä¸Šé¢çš„ä»£ç ç¼–è¯‘ååœ¨ç»ˆç«¯æ‰§è¡Œï¼Œåœ¨ç»ˆç«¯ä¾æ¬¡è¾“å…¥å°ç‹å­ã€28å’Œfalseä½¿ç”¨ç©ºæ ¼åˆ†éš”ã€‚ $ ./scan_demo å°ç‹å­ 28 false æ‰«æç»“æœ name:å°ç‹å­ age:28 married:false fmt.Scanä»æ ‡å‡†è¾“å…¥ä¸­æ‰«æç”¨æˆ·è¾“å…¥çš„æ•°æ®ï¼Œå°†ä»¥ç©ºç™½ç¬¦åˆ†éš”çš„æ•°æ®åˆ†åˆ«å­˜å…¥æŒ‡å®šçš„å‚æ•°ã€‚ fmt.Scanf å‡½æ•°ç­¾åå¦‚ä¸‹ï¼š func Scanf(format string, a ...interface{}) (n int, err error) Scanfä»æ ‡å‡†è¾“å…¥æ‰«ææ–‡æœ¬ï¼Œæ ¹æ®formatå‚æ•°æŒ‡å®šçš„æ ¼å¼å»è¯»å–ç”±ç©ºç™½ç¬¦åˆ†éš”çš„å€¼ä¿å­˜åˆ°ä¼ é€’ç»™æœ¬å‡½æ•°çš„å‚æ•°ä¸­ã€‚ æœ¬å‡½æ•°è¿”å›æˆåŠŸæ‰«æçš„æ•°æ®ä¸ªæ•°å’Œé‡åˆ°çš„ä»»ä½•é”™è¯¯ã€‚ ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š func main() { var ( name string age int married bool ) fmt.Scanf(\"1:%s 2:%d 3:%t\", \u0026name, \u0026age, \u0026married) fmt.Printf(\"æ‰«æç»“æœ name:%s age:%d married:%t \\n\", name, age, married) } å°†ä¸Šé¢çš„ä»£ç ç¼–è¯‘ååœ¨ç»ˆç«¯æ‰§è¡Œï¼Œåœ¨ç»ˆç«¯æŒ‰ç…§æŒ‡å®šçš„æ ¼å¼ä¾æ¬¡è¾“å…¥å°ç‹å­ã€28å’Œfalseã€‚ $ ./scan_demo 1:å°ç‹å­ 2:28 3:false æ‰«æç»“æœ name:å°ç‹å­ age:28 married:false fmt.Scanfä¸åŒäºfmt.Scanç®€å•çš„ä»¥ç©ºæ ¼ä½œä¸ºè¾“å…¥æ•°æ®çš„åˆ†éš”ç¬¦ï¼Œfmt.Scanfä¸ºè¾“å…¥æ•°æ®æŒ‡å®šäº†å…·ä½“çš„è¾“å…¥å†…å®¹æ ¼å¼ï¼Œåªæœ‰æŒ‰ç…§æ ¼å¼è¾“å…¥æ•°æ®æ‰ä¼šè¢«æ‰«æå¹¶å­˜å…¥å¯¹åº”å˜é‡ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¿˜æ˜¯æŒ‰ç…§ä¸Šä¸ªç¤ºä¾‹ä¸­ä»¥ç©ºæ ¼åˆ†éš”çš„æ–¹å¼è¾“å…¥ï¼Œfmt.Scanfå°±ä¸èƒ½æ­£ç¡®æ‰«æåˆ°è¾“å…¥çš„æ•°æ®ã€‚ $ ./scan_demo å°ç‹å­ 28 false æ‰«æç»“æœ name: age:0 married:false fmt.Scanln å‡½æ•°ç­¾åå¦‚ä¸‹ï¼š func Scanln(a ...interface{}) (n int, err error) Scanlnç±»ä¼¼Scanï¼Œå®ƒåœ¨é‡åˆ°æ¢è¡Œæ—¶æ‰åœæ­¢æ‰«æã€‚æœ€åä¸€ä¸ªæ•°æ®åé¢å¿…é¡»æœ‰æ¢è¡Œæˆ–è€…åˆ°è¾¾ç»“æŸä½ç½®ã€‚ æœ¬å‡½æ•°è¿”å›æˆåŠŸæ‰«æçš„æ•°æ®ä¸ªæ•°å’Œé‡åˆ°çš„ä»»ä½•é”™è¯¯ã€‚ å…·ä½“ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š func main() { var ( name string age int married bool ) fmt.Scanln(\u0026name, \u0026age, \u0026married) fmt.Printf(\"æ‰«æç»“æœ name:%s age:%d married:%t \\n\", name, age, married) } å°†ä¸Šé¢çš„ä»£ç ç¼–è¯‘ååœ¨ç»ˆç«¯æ‰§è¡Œï¼Œåœ¨ç»ˆç«¯ä¾æ¬¡è¾“å…¥å°ç‹å­ã€28å’Œfalseä½¿ç”¨ç©ºæ ¼åˆ†éš”ã€‚ $ ./scan_demo å°ç‹å­ 28 false æ‰«æç»“æœ name:å°ç‹å­ age:28 married:false fmt.Scanlné‡åˆ°å›è½¦å°±ç»“æŸæ‰«æäº†ï¼Œè¿™ä¸ªæ¯”è¾ƒå¸¸ç”¨ã€‚ bufio.NewReader æœ‰æ—¶å€™æˆ‘ä»¬æƒ³å®Œæ•´è·å–è¾“å…¥çš„å†…å®¹ï¼Œè€Œè¾“å…¥çš„å†…å®¹å¯èƒ½åŒ…å«ç©ºæ ¼ï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨bufioåŒ…æ¥å®ç°ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š func bufioDemo() { reader := bufio.NewReader(os.Stdin) // ä»æ ‡å‡†è¾“å…¥ç”Ÿæˆè¯»å¯¹è±¡ fmt.Print(\"è¯·è¾“å…¥å†…å®¹ï¼š\") text, _ := reader.ReadString('\\n') // è¯»åˆ°æ¢è¡Œ text = strings.TrimSpace(text) fmt.Printf(\"%#v\\n\", text) } Fscanç³»åˆ— è¿™å‡ ä¸ªå‡½æ•°åŠŸèƒ½åˆ†åˆ«ç±»ä¼¼äºfmt.Scanã€fmt.Scanfã€fmt.Scanlnä¸‰ä¸ªå‡½æ•°ï¼Œåªä¸è¿‡å®ƒä»¬ä¸æ˜¯ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–æ•°æ®è€Œæ˜¯ä»io.Readerä¸­è¯»å–æ•°æ®ã€‚ func Fscan(r io.Reader, a ...interface{}) (n int, err error) func Fscanln(r io.Reader, a ...interface{}) (n int, err error) func Fscanf(r io.Reader, format string, a ...interface{}) (n int, err error) Sscanç³»åˆ— è¿™å‡ ä¸ªå‡½æ•°åŠŸèƒ½åˆ†åˆ«ç±»ä¼¼äºfmt.Scanã€fmt.Scanfã€fmt.Scanlnä¸‰ä¸ªå‡½æ•°ï¼Œåªä¸è¿‡å®ƒä»¬ä¸æ˜¯ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–æ•°æ®è€Œæ˜¯ä»æŒ‡å®šå­—ç¬¦ä¸²ä¸­è¯»å–æ•°æ®ã€‚ func Sscan(str string, a ...interface{}) (n int, err error) func Sscanln(str string, a ...interface{}) (n int, err error) func Sscanf(str string, format string, a ...interface{}) (n int, err error) ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-fmt/:1:3","tags":["Go","fmt"],"title":"Go fmt","uri":"/posts/2023-11-11-go-fmt/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Goæ–‡ä»¶æ“ä½œ å‚è€ƒé“¾æ¥ï¼šhttps://www.liwenzhou.com/posts/Go/go_file/ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-file/:1:0","tags":["Go","file"],"title":"Go file","uri":"/posts/2023-11-11-go-file/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æ–‡ä»¶ è®¡ç®—æœºä¸­çš„æ–‡ä»¶æ˜¯å­˜å‚¨åœ¨å¤–éƒ¨ä»‹è´¨ï¼ˆé€šå¸¸æ˜¯ç£ç›˜ï¼‰ä¸Šçš„æ•°æ®é›†åˆï¼Œæ–‡ä»¶åˆ†ä¸ºæ–‡æœ¬æ–‡ä»¶å’ŒäºŒè¿›åˆ¶æ–‡ä»¶ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-file/:1:1","tags":["Go","file"],"title":"Go file","uri":"/posts/2023-11-11-go-file/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æ–‡ä»¶æ‰“å¼€å’Œå…³é—­ os.Open()å‡½æ•°èƒ½å¤Ÿæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ª*Fileå’Œä¸€ä¸ªerrã€‚å¯¹å¾—åˆ°çš„æ–‡ä»¶å®ä¾‹è°ƒç”¨close()æ–¹æ³•èƒ½å¤Ÿå…³é—­æ–‡ä»¶ã€‚ package main import ( \"fmt\" \"os\" ) func main() { // åªè¯»æ–¹å¼æ‰“å¼€å½“å‰ç›®å½•ä¸‹çš„main.goæ–‡ä»¶ file, err := os.Open(\"./main.go\") if err != nil { fmt.Println(\"open file failed!, err:\", err) return } // å…³é—­æ–‡ä»¶ file.Close() } ä¸ºäº†é˜²æ­¢æ–‡ä»¶å¿˜è®°å…³é—­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨deferæ³¨å†Œæ–‡ä»¶å…³é—­è¯­å¥ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-file/:1:2","tags":["Go","file"],"title":"Go file","uri":"/posts/2023-11-11-go-file/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"è¯»å–æ–‡ä»¶ file.Read() åŸºæœ¬ä½¿ç”¨ Readæ–¹æ³•çš„å®šä¹‰å¦‚ä¸‹ï¼š func (f *File) Read(b []byte) (n int, err error) å®ƒæ¥æ”¶ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡ï¼Œè¿”å›è¯»å–çš„å­—èŠ‚æ•°å’Œå¯èƒ½çš„å…·ä½“é”™è¯¯ï¼Œè¯»åˆ°æ–‡ä»¶æœ«å°¾æ—¶ä¼šè¿”å›0å’Œio.EOFã€‚ ä¸¾ä¸ªä¾‹å­ï¼š func main() { // åªè¯»æ–¹å¼æ‰“å¼€å½“å‰ç›®å½•ä¸‹çš„main.goæ–‡ä»¶ file, err := os.Open(\"./main.go\") if err != nil { fmt.Println(\"open file failed!, err:\", err) return } defer file.Close() // ä½¿ç”¨Readæ–¹æ³•è¯»å–æ•°æ® var tmp = make([]byte, 128) n, err := file.Read(tmp) if err == io.EOF { fmt.Println(\"æ–‡ä»¶è¯»å®Œäº†\") return } if err != nil { fmt.Println(\"read file failed, err:\", err) return } fmt.Printf(\"è¯»å–äº†%då­—èŠ‚æ•°æ®\\n\", n) fmt.Println(string(tmp[:n])) } å¾ªç¯è¯»å– ä½¿ç”¨forå¾ªç¯è¯»å–æ–‡ä»¶ä¸­æ‰€æœ‰çš„æ•°æ® func main() { // åªè¯»æ–¹å¼æ‰“å¼€å½“å‰ç›®å½•ä¸‹çš„main.goæ–‡ä»¶ file, err := os.Open(\"./main.go\") if err != nil { fmt.Println(\"open file failed!, err:\", err) return } defer file.Close() // å¾ªç¯è¯»å–æ–‡ä»¶ var content []byte var tmp = make([]byte, 128) for { n, err := file.Read(tmp) if err == io.EOF { fmt.Println(\"æ–‡ä»¶è¯»å®Œäº†\") break } if err != nil { fmt.Println(\"read file failed, err:\", err) return } content = append(content, tmp[:n]...) } fmt.Println(string(content)) } bufioè¯»å–æ–‡ä»¶ bufioæ˜¯åœ¨fileçš„åŸºç¡€ä¸Šå°è£…äº†ä¸€å±‚APIï¼Œæ”¯æŒæ›´å¤šçš„åŠŸèƒ½ã€‚ package main import ( \"bufio\" \"fmt\" \"io\" \"os\" ) // bufioæŒ‰è¡Œè¯»å–ç¤ºä¾‹ func main() { file, err := os.Open(\"./xx.txt\") if err != nil { fmt.Println(\"open file failed, err:\", err) return } defer file.Close() reader := bufio.NewReader(file) for { line, err := reader.ReadString('\\n') //æ³¨æ„æ˜¯å­—ç¬¦ if err == io.EOF { if len(line) != 0 { fmt.Println(line) } fmt.Println(\"æ–‡ä»¶è¯»å®Œäº†\") break } if err != nil { fmt.Println(\"read file failed, err:\", err) return } fmt.Print(line) } } ioutilè¯»å–æ•´ä¸ªæ–‡ä»¶ io/ioutilåŒ…çš„ReadFileæ–¹æ³•èƒ½å¤Ÿè¯»å–å®Œæ•´çš„æ–‡ä»¶ï¼Œåªéœ€è¦å°†æ–‡ä»¶åä½œä¸ºå‚æ•°ä¼ å…¥ã€‚ package main import ( \"fmt\" \"io/ioutil\" ) // ioutil.ReadFileè¯»å–æ•´ä¸ªæ–‡ä»¶ func main() { content, err := ioutil.ReadFile(\"./main.go\") if err != nil { fmt.Println(\"read file failed, err:\", err) return } fmt.Println(string(content)) } ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-file/:1:3","tags":["Go","file"],"title":"Go file","uri":"/posts/2023-11-11-go-file/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æ–‡ä»¶å†™å…¥ os.OpenFile()å‡½æ•°èƒ½å¤Ÿä»¥æŒ‡å®šæ¨¡å¼æ‰“å¼€æ–‡ä»¶ï¼Œä»è€Œå®ç°æ–‡ä»¶å†™å…¥ç›¸å…³åŠŸèƒ½ã€‚ func OpenFile(name string, flag int, perm FileMode) (*File, error) { ... } å…¶ä¸­ï¼š nameï¼šè¦æ‰“å¼€çš„æ–‡ä»¶å flagï¼šæ‰“å¼€æ–‡ä»¶çš„æ¨¡å¼ã€‚ æ¨¡å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š æ¨¡å¼ å«ä¹‰ os.O_WRONLY åªå†™ os.O_CREATE åˆ›å»ºæ–‡ä»¶ os.O_RDONLY åªè¯» os.O_RDWR è¯»å†™ os.O_TRUNC æ¸…ç©º os.O_APPEND è¿½åŠ  permï¼šæ–‡ä»¶æƒé™ï¼Œä¸€ä¸ªå…«è¿›åˆ¶æ•°ã€‚rï¼ˆè¯»ï¼‰4ï¼Œwï¼ˆå†™ï¼‰2ï¼Œxï¼ˆæ‰§è¡Œï¼‰1ã€‚ Writeå’ŒWriteString func main() { file, err := os.OpenFile(\"xx.txt\", os.O_CREATE|os.O_TRUNC|os.O_WRONLY, 0666) if err != nil { fmt.Println(\"open file failed, err:\", err) return } defer file.Close() str := \"hello æ²™æ²³\" file.Write([]byte(str)) //å†™å…¥å­—èŠ‚åˆ‡ç‰‡æ•°æ® file.WriteString(\"hello å°ç‹å­\") //ç›´æ¥å†™å…¥å­—ç¬¦ä¸²æ•°æ® } bufio.NewWriter func main() { file, err := os.OpenFile(\"xx.txt\", os.O_CREATE|os.O_TRUNC|os.O_WRONLY, 0666) if err != nil { fmt.Println(\"open file failed, err:\", err) return } defer file.Close() writer := bufio.NewWriter(file) for i := 0; i \u003c 10; i++ { writer.WriteString(\"helloæ²™æ²³\\n\") //å°†æ•°æ®å…ˆå†™å…¥ç¼“å­˜ } writer.Flush() //å°†ç¼“å­˜ä¸­çš„å†…å®¹å†™å…¥æ–‡ä»¶ } ioutil.WriteFile func main() { str := \"hello æ²™æ²³\" err := ioutil.WriteFile(\"./xx.txt\", []byte(str), 0666) if err != nil { fmt.Println(\"write file failed, err:\", err) return } } ç»ƒä¹ ï¼š 1ã€å®ç°cpå‘½ä»¤ å€ŸåŠ©io.Copy()å®ç°ä¸€ä¸ªæ‹·è´æ–‡ä»¶å‡½æ•°ã€‚ // CopyFile æ‹·è´æ–‡ä»¶å‡½æ•° func CopyFile(dstName, srcName string) (written int64, err error) { // ä»¥è¯»æ–¹å¼æ‰“å¼€æºæ–‡ä»¶ src, err := os.Open(srcName) if err != nil { fmt.Printf(\"open %s failed, err:%v.\\n\", srcName, err) return } defer src.Close() // ä»¥å†™|åˆ›å»ºçš„æ–¹å¼æ‰“å¼€ç›®æ ‡æ–‡ä»¶ dst, err := os.OpenFile(dstName, os.O_WRONLY|os.O_CREATE, 0644) if err != nil { fmt.Printf(\"open %s failed, err:%v.\\n\", dstName, err) return } defer dst.Close() return io.Copy(dst, src) //è°ƒç”¨io.Copy()æ‹·è´å†…å®¹ } func main() { _, err := CopyFile(\"dst.txt\", \"src.txt\") if err != nil { fmt.Println(\"copy file failed, err:\", err) return } fmt.Println(\"copy done!\") } 2ã€å®ç°catå‘½ä»¤ ä½¿ç”¨æ–‡ä»¶æ“ä½œç›¸å…³çŸ¥è¯†ï¼Œæ¨¡æ‹Ÿå®ç°linuxå¹³å°catå‘½ä»¤çš„åŠŸèƒ½ package main import ( \"bufio\" \"flag\" \"fmt\" \"io\" \"os\" ) // catå‘½ä»¤å®ç° func cat(r *bufio.Reader) { for { buf, err := r.ReadBytes('\\n') //æ³¨æ„æ˜¯å­—ç¬¦ if err == io.EOF { // é€€å‡ºä¹‹å‰å°†å·²è¯»åˆ°çš„å†…å®¹è¾“å‡º fmt.Fprintf(os.Stdout, \"%s\", buf) break } fmt.Fprintf(os.Stdout, \"%s\", buf) } } func main() { flag.Parse() // è§£æå‘½ä»¤è¡Œå‚æ•° if flag.NArg() == 0 { // å¦‚æœæ²¡æœ‰å‚æ•°é»˜è®¤ä»æ ‡å‡†è¾“å…¥è¯»å–å†…å®¹ cat(bufio.NewReader(os.Stdin)) } // ä¾æ¬¡è¯»å–æ¯ä¸ªæŒ‡å®šæ–‡ä»¶çš„å†…å®¹å¹¶æ‰“å°åˆ°ç»ˆç«¯ for i := 0; i \u003c flag.NArg(); i++ { f, err := os.Open(flag.Arg(i)) if err != nil { fmt.Fprintf(os.Stdout, \"reading from %s failed, err:%v\\n\", flag.Arg(i), err) continue } cat(bufio.NewReader(f)) } } ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-file/:1:4","tags":["Go","file"],"title":"Go file","uri":"/posts/2023-11-11-go-file/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Excelåº“excelize å‚è€ƒé“¾æ¥ï¼š[Go è¯­è¨€è¯»å†™ Excel - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/33417413#:~:text=Excelize æ˜¯ Go è¯­è¨€ç¼–å†™çš„ç”¨äºæ“ä½œ Office Excel æ–‡æ¡£ç±»åº“ï¼ŒåŸºäº ECMA-376,æ ‡å‡†ã€‚ å¯ä»¥ä½¿ç”¨å®ƒæ¥è¯»å–ã€å†™å…¥ç”± Microsoft Excelâ„¢ 2007 åŠä»¥ä¸Šç‰ˆæœ¬åˆ›å»ºçš„ XLSX æ–‡æ¡£ã€‚) Excelize æ˜¯ Go è¯­è¨€ç¼–å†™çš„ç”¨äºæ“ä½œ Office Excel æ–‡æ¡£ç±»åº“ï¼ŒåŸºäº ECMA-376 Office OpenXML æ ‡å‡†ã€‚å¯ä»¥ä½¿ç”¨å®ƒæ¥è¯»å–ã€å†™å…¥ç”± Microsoft Excelâ„¢ 2007 åŠä»¥ä¸Šç‰ˆæœ¬åˆ›å»ºçš„ XLSX æ–‡æ¡£ã€‚ç›¸æ¯”è¾ƒå…¶ä»–çš„å¼€æºç±»åº“ï¼ŒExcelize æ”¯æŒå†™å…¥åŸæœ¬å¸¦æœ‰å›¾ç‰‡(è¡¨)ã€é€è§†è¡¨å’Œåˆ‡ç‰‡å™¨ç­‰å¤æ‚æ ·å¼çš„æ–‡æ¡£ï¼Œè¿˜æ”¯æŒå‘ Excel æ–‡æ¡£ä¸­æ’å…¥å›¾ç‰‡ä¸å›¾è¡¨ï¼Œå¹¶ä¸”åœ¨ä¿å­˜åä¸ä¼šä¸¢å¤±æ–‡æ¡£åŸæœ‰æ ·å¼ï¼Œå¯ä»¥åº”ç”¨äºå„ç±»æŠ¥è¡¨ç³»ç»Ÿä¸­ã€‚ä½¿ç”¨æœ¬ç±»åº“è¦æ±‚ä½¿ç”¨çš„ Go è¯­è¨€ä¸º 1.8 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œå®Œæ•´çš„ API ä½¿ç”¨æ–‡æ¡£è¯·è®¿é—® godoc.org æˆ–æŸ¥çœ‹å‚è€ƒæ–‡æ¡£ã€‚ GitHub: excelize å®˜æ–¹æ–‡æ¡£ï¼šhttps://xuri.me/excelize ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-excelize/:1:0","tags":["Go","excelize","xls","xlsx"],"title":"Go excelize","uri":"/posts/2023-11-11-go-excelize/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"1ã€ç®€å•ä½¿ç”¨ å®‰è£… go get github.com/xuri/excelize/v2 1ï¼‰åˆ›å»ºXLSX package main import \"github.com/360EntSecGroup-Skylar/excelize\" func main() { f := excelize.NewFile() // åˆ›å»ºä¸€ä¸ªå·¥ä½œè¡¨ index := f.NewSheet(\"Sheet2\") // è®¾ç½®å•å…ƒæ ¼çš„å€¼ f.SetCellValue(\"Sheet1\", \"A2\", \"Hello world.\") f.SetCellValue(\"Sheet1\", \"B2\", 100) f.SetCellValue(\"Sheet1\", \"B3\", \"github\") // è®¾ç½®å·¥ä½œç°¿çš„é»˜è®¤å·¥ä½œè¡¨ f.SetActiveSheet(index) // æ ¹æ®æŒ‡å®šè·¯å¾„ä¿å­˜æ–‡ä»¶ if err := f.SaveAs(\"Book1.xlsx\"); err != nil { println(err.Error()) } } ç»“æœï¼š SetCellValueå‡½æ•°è§£é‡Š f.SetCellValue(sheet string, axis string, value interface{}) f.SetCellValue(\"Sheet1\", \"B3\", \"github\") sheetï¼šæ˜¯sheetè¡¨æ ¼çš„çš„åå­—ã€‚ axisï¼šåŒ…å«ä¸¤éƒ¨åˆ†ï¼Œå­—æ¯è¡¨ç¤ºåˆ—ï¼Œæ•°å­—è¡¨ç¤ºè¡Œã€‚ valueï¼šè¡¨ç¤ºå€¼ã€‚ 2ï¼‰è¯»å–xlsx func ReadXlsx() { filename := \"Book1.xlsx\" f, err := excelize.OpenFile(filename) if err != nil { fmt.Printf(\"æ— æ³•æ‰“å¼€xlsxï¼š%v é”™è¯¯åŸå› ï¼š%v\", filename, err) return } // è·å–å·¥ä½œè¡¨ä¸­æŒ‡å®šå•å…ƒæ ¼çš„å€¼ cell, err := f.GetCellValue(\"Sheet1\", \"B3\") if err != nil { fmt.Printf(\"è·å– %v çš„%vçš„ å€¼ å¤±è´¥,å¤±è´¥åŸå› ï¼š%v\", \"Sheet1\", \"B3\", err) } fmt.Printf(\"è¯»å–çš„å†…å®¹ä¸ºï¼š%v\", cell) // è·å– Sheet1 ä¸Šæ‰€æœ‰å•å…ƒæ ¼ rows, err := f.GetRows(\"Sheet1\") if err != nil { fmt.Printf(\"è·å– %vçš„å•å…ƒæ ¼å¤±è´¥,å¤±è´¥åŸå› ï¼š%v\", \"Sheet1\", err) } for _, row := range rows { for _, colCell := range row { print(colCell, \"\\t\") } println() } } 3ï¼‰æ’å…¥ä¸€è¡Œæ•°æ® func (exa *ExcelService) ParseInfoList2Excel(infoList []system.SysBaseMenu, filePath string) error { excel := excelize.NewFile() excel.SetSheetRow(\"Sheet1\", \"A1\", \u0026[]string{\"ID\", \"è·¯ç”±Name\", \"è·¯ç”±Path\", \"æ˜¯å¦éšè—\", \"çˆ¶èŠ‚ç‚¹\", \"æ’åº\", \"æ–‡ä»¶åç§°\"}) for i, menu := range infoList { axis := fmt.Sprintf(\"A%d\", i+2) excel.SetSheetRow(\"Sheet1\", axis, \u0026[]interface{}{ menu.ID, menu.Name, menu.Path, menu.Hidden, menu.ParentId, menu.Sort, menu.Component, }) } err := excel.SaveAs(filePath) return err } 4ï¼‰ä»è¡¨æ ¼ä¸­å¯¼å…¥æ•°æ® func PasreExcel2List(filepath string, fileHeader []string, skipHeader bool) (data [][]string, err error) { file, err := excelize.OpenFile(filepath) if err != nil { return } defer file.Close() rows, err := file.GetRows(\"Sheet1\") if err != nil { return } if skipHeader { if ForEqualStringSlice(rows[0], fileHeader) { rows = rows[1:] } else { err = errors.New(\"FileHeader not Equal.\") return } } data = rows return } func (exa *ExcelService) ParseExcel2InfoList() ([]system.SysBaseMenu, error) { skipHeader := true fixedHeader := []string{\"ID\", \"è·¯ç”±Name\", \"è·¯ç”±Path\", \"æ˜¯å¦éšè—\", \"çˆ¶èŠ‚ç‚¹\", \"æ’åº\", \"æ–‡ä»¶åç§°\"} file, err := excelize.OpenFile(global.GVA_CONFIG.Excel.Dir + \"ExcelImport.xlsx\") if err != nil { return nil, err } menus := make([]system.SysBaseMenu, 0) rows, err := file.Rows(\"Sheet1\") if err != nil { return nil, err } for rows.Next() { row, err := rows.Columns() if err != nil { return nil, err } if skipHeader { if exa.compareStrSlice(row, fixedHeader) { skipHeader = false continue } else { return nil, errors.New(\"Excelæ ¼å¼é”™è¯¯\") } } if len(row) != len(fixedHeader) { continue } id, _ := strconv.Atoi(row[0]) hidden, _ := strconv.ParseBool(row[3]) sort, _ := strconv.Atoi(row[5]) menu := system.SysBaseMenu{ GVA_MODEL: global.GVA_MODEL{ ID: uint(id), }, Name: row[1], Path: row[2], Hidden: hidden, ParentId: row[4], Sort: sort, Component: row[6], } menus = append(menus, menu) } return menus, nil } func (exa *ExcelService) compareStrSlice(a, b []string) bool { if len(a) != len(b) { return false } if (b == nil) != (a == nil) { return false } for key, value := range a { if value != b[key] { return false } } return true } ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-excelize/:1:1","tags":["Go","excelize","xls","xlsx"],"title":"Go excelize","uri":"/posts/2023-11-11-go-excelize/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"cronå®šæ—¶ä»»åŠ¡ å‚è€ƒé“¾æ¥ï¼šhttps://segmentfault.com/a/1190000023029219 ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-cron/:1:0","tags":["Go","cron"],"title":"Go cron","uri":"/posts/2023-11-11-go-cron/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"ç®€ä»‹ cronä¸€ä¸ªç”¨äºç®¡ç†å®šæ—¶ä»»åŠ¡çš„åº“ï¼Œç”¨ Go å®ç° Linux ä¸­crontabè¿™ä¸ªå‘½ä»¤çš„æ•ˆæœã€‚ä¹‹å‰æˆ‘ä»¬ä¹Ÿä»‹ç»è¿‡ä¸€ä¸ªç±»ä¼¼çš„ Go åº“â€”â€”gronã€‚gronä»£ç å°å·§ï¼Œç”¨äºå­¦ä¹ æ˜¯æ¯”è¾ƒå¥½çš„ã€‚ä½†æ˜¯å®ƒåŠŸèƒ½ç›¸å¯¹ç®€å•äº›ï¼Œå¹¶ä¸”å·²ç»ä¸ç»´æŠ¤äº†ã€‚å¦‚æœæœ‰å®šæ—¶ä»»åŠ¡éœ€æ±‚ï¼Œè¿˜æ˜¯å»ºè®®ä½¿ç”¨cronã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-cron/:1:1","tags":["Go","cron"],"title":"Go cron","uri":"/posts/2023-11-11-go-cron/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å¿«é€Ÿä½¿ç”¨ å®‰è£…cronï¼Œç›®å‰æœ€æ–°ç¨³å®šç‰ˆæœ¬ä¸º v3ï¼š $ go get github.com/robfig/cron/v3 ä½¿ç”¨ package main import ( \"fmt\" \"time\" \"github.com/robfig/cron/v3\" ) func main() { c := cron.New() c.AddFunc(\"@every 1s\", func() { fmt.Println(\"tick every 1 second\") }) c.Start() time.Sleep(time.Second * 5) } ä½¿ç”¨éå¸¸ç®€å•ï¼Œåˆ›å»ºcronå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ç”¨äºç®¡ç†å®šæ—¶ä»»åŠ¡ã€‚ è°ƒç”¨cronå¯¹è±¡çš„AddFunc()æ–¹æ³•å‘ç®¡ç†å™¨ä¸­æ·»åŠ å®šæ—¶ä»»åŠ¡ã€‚AddFunc()æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œå‚æ•° 1 ä»¥å­—ç¬¦ä¸²å½¢å¼æŒ‡å®šè§¦å‘æ—¶é—´è§„åˆ™ï¼Œå‚æ•° 2 æ˜¯ä¸€ä¸ªæ— å‚çš„å‡½æ•°ï¼Œæ¯æ¬¡è§¦å‘æ—¶è°ƒç”¨ã€‚@every 1sè¡¨ç¤ºæ¯ç§’è§¦å‘ä¸€æ¬¡ï¼Œ@everyååŠ ä¸€ä¸ªæ—¶é—´é—´éš”ï¼Œè¡¨ç¤ºæ¯éš”å¤šé•¿æ—¶é—´è§¦å‘ä¸€æ¬¡ã€‚ä¾‹å¦‚@every 1hè¡¨ç¤ºæ¯å°æ—¶è§¦å‘ä¸€æ¬¡ï¼Œ@every 1m2sè¡¨ç¤ºæ¯éš” 1 åˆ† 2 ç§’è§¦å‘ä¸€æ¬¡ã€‚time.ParseDuration()æ”¯æŒçš„æ ¼å¼éƒ½å¯ä»¥ç”¨åœ¨è¿™é‡Œã€‚ è°ƒç”¨c.Start()å¯åŠ¨å®šæ—¶å¾ªç¯ã€‚ æ³¨æ„ä¸€ç‚¹ï¼Œå› ä¸ºc.Start()å¯åŠ¨ä¸€ä¸ªæ–°çš„ goroutine åšå¾ªç¯æ£€æµ‹ï¼Œæˆ‘ä»¬åœ¨ä»£ç æœ€ååŠ äº†ä¸€è¡Œtime.Sleep(time.Second * 5)é˜²æ­¢ä¸» goroutine é€€å‡ºã€‚ è¿è¡Œæ•ˆæœï¼Œæ¯éš” 1s è¾“å‡ºä¸€è¡Œå­—ç¬¦ä¸²ï¼š $ go run main.go tick every 1 second tick every 1 second tick every 1 second tick every 1 second tick every 1 second ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-cron/:1:2","tags":["Go","cron"],"title":"Go cron","uri":"/posts/2023-11-11-go-cron/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æ—¶é—´æ ¼å¼ ä¸Linux ä¸­crontabå‘½ä»¤ç›¸ä¼¼ï¼Œcronåº“æ”¯æŒç”¨ 5 ä¸ªç©ºæ ¼åˆ†éš”çš„åŸŸæ¥è¡¨ç¤ºæ—¶é—´ã€‚è¿™ 5 ä¸ªåŸŸå«ä¹‰ä¾æ¬¡ä¸ºï¼š Minutesï¼šåˆ†é’Ÿï¼Œå–å€¼èŒƒå›´[0-59]ï¼Œæ”¯æŒç‰¹æ®Šå­—ç¬¦* / , -ï¼› Hoursï¼šå°æ—¶ï¼Œå–å€¼èŒƒå›´[0-23]ï¼Œæ”¯æŒç‰¹æ®Šå­—ç¬¦* / , -ï¼› Day of monthï¼šæ¯æœˆçš„ç¬¬å‡ å¤©ï¼Œå–å€¼èŒƒå›´[1-31]ï¼Œæ”¯æŒç‰¹æ®Šå­—ç¬¦* / , - ?ï¼› Monthï¼šæœˆï¼Œå–å€¼èŒƒå›´[1-12]æˆ–è€…ä½¿ç”¨æœˆä»½åå­—ç¼©å†™[JAN-DEC]ï¼Œæ”¯æŒç‰¹æ®Šå­—ç¬¦* / , -ï¼› Day of weekï¼šå‘¨å†ï¼Œå–å€¼èŒƒå›´[0-6]æˆ–åå­—ç¼©å†™[JUN-SAT]ï¼Œæ”¯æŒç‰¹æ®Šå­—ç¬¦* / , - ?ã€‚ æ³¨æ„ï¼Œæœˆä»½å’Œå‘¨å†åç§°éƒ½æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„ï¼Œä¹Ÿå°±æ˜¯è¯´SUN/Sun/sunè¡¨ç¤ºåŒæ ·çš„å«ä¹‰ï¼ˆéƒ½æ˜¯å‘¨æ—¥ï¼‰ã€‚ ç‰¹æ®Šå­—ç¬¦å«ä¹‰å¦‚ä¸‹ï¼š *ï¼šä½¿ç”¨*çš„åŸŸå¯ä»¥åŒ¹é…ä»»ä½•å€¼ï¼Œä¾‹å¦‚å°†æœˆä»½åŸŸï¼ˆç¬¬ 4 ä¸ªï¼‰è®¾ç½®ä¸º*ï¼Œè¡¨ç¤ºæ¯ä¸ªæœˆï¼› /ï¼šç”¨æ¥æŒ‡å®šèŒƒå›´çš„æ­¥é•¿ï¼Œä¾‹å¦‚å°†å°æ—¶åŸŸï¼ˆç¬¬ 2 ä¸ªï¼‰è®¾ç½®ä¸º3-59/15è¡¨ç¤ºç¬¬ 3 åˆ†é’Ÿè§¦å‘ï¼Œä»¥åæ¯éš” 15 åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ï¼Œå› æ­¤ç¬¬ 2 æ¬¡è§¦å‘ä¸ºç¬¬ 18 åˆ†é’Ÿï¼Œç¬¬ 3 æ¬¡ä¸º 33 åˆ†é’Ÿã€‚ã€‚ã€‚ç›´åˆ°åˆ†é’Ÿå¤§äº 59ï¼› ,ï¼šç”¨æ¥åˆ—ä¸¾ä¸€äº›ç¦»æ•£çš„å€¼å’Œå¤šä¸ªèŒƒå›´ï¼Œä¾‹å¦‚å°†å‘¨å†çš„åŸŸï¼ˆç¬¬ 5 ä¸ªï¼‰è®¾ç½®ä¸ºMON,WED,FRIè¡¨ç¤ºå‘¨ä¸€ã€ä¸‰å’Œäº”ï¼› -ï¼šç”¨æ¥è¡¨ç¤ºèŒƒå›´ï¼Œä¾‹å¦‚å°†å°æ—¶çš„åŸŸï¼ˆç¬¬ 1 ä¸ªï¼‰è®¾ç½®ä¸º9-17è¡¨ç¤ºä¸Šåˆ 9 ç‚¹åˆ°ä¸‹åˆ 17 ç‚¹ï¼ˆåŒ…æ‹¬ 9 å’Œ 17ï¼‰ï¼› ?ï¼šåªèƒ½ç”¨åœ¨æœˆå†å’Œå‘¨å†çš„åŸŸä¸­ï¼Œç”¨æ¥ä»£æ›¿*ï¼Œè¡¨ç¤ºæ¯æœˆ/å‘¨çš„ä»»æ„ä¸€å¤©ã€‚ äº†è§£è§„åˆ™ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä»»æ„æ—¶é—´ï¼š 30 * * * *ï¼šåˆ†é’ŸåŸŸä¸º 30ï¼Œå…¶ä»–åŸŸéƒ½æ˜¯*è¡¨ç¤ºä»»æ„ã€‚æ¯å°æ—¶çš„ 30 åˆ†è§¦å‘ï¼› 30 3-6,20-23 * * *ï¼šåˆ†é’ŸåŸŸä¸º 30ï¼Œå°æ—¶åŸŸçš„3-6,20-23è¡¨ç¤º 3 ç‚¹åˆ° 6 ç‚¹å’Œ 20 ç‚¹åˆ° 23 ç‚¹ã€‚3,4,5,6,20,21,22,23 æ—¶çš„ 30 åˆ†è§¦å‘ï¼› 0 0 1 1 *ï¼š1ï¼ˆç¬¬ 4 ä¸ªï¼‰ æœˆ 1ï¼ˆç¬¬ 3 ä¸ªï¼‰ å·çš„ 0ï¼ˆç¬¬ 2 ä¸ªï¼‰ æ—¶ 0ï¼ˆç¬¬ 1 ä¸ªï¼‰ åˆ†è§¦å‘ã€‚ è®°ç†Ÿäº†è¿™å‡ ä¸ªåŸŸçš„é¡ºåºï¼Œå†å¤šç»ƒä¹ å‡ æ¬¡å¾ˆå®¹æ˜“å°±èƒ½æŒæ¡æ ¼å¼ã€‚ç†Ÿæ‚‰è§„åˆ™äº†ä¹‹åï¼Œå°±èƒ½ç†Ÿç»ƒä½¿ç”¨crontabå‘½ä»¤äº†ã€‚ func main() { c := cron.New() c.AddFunc(\"30 * * * *\", func() { fmt.Println(\"Every hour on the half hour\") }) c.AddFunc(\"30 3-6,20-23 * * *\", func() { fmt.Println(\"On the half hour of 3-6am, 8-11pm\") }) c.AddFunc(\"0 0 1 1 *\", func() { fmt.Println(\"Jun 1 every year\") }) c.Start() for { time.Sleep(time.Second) } } é¢„å®šä¹‰æ—¶é—´è§„åˆ™ ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œcroné¢„å®šä¹‰äº†ä¸€äº›æ—¶é—´è§„åˆ™ï¼š @yearlyï¼šä¹Ÿå¯ä»¥å†™ä½œ@annuallyï¼Œè¡¨ç¤ºæ¯å¹´ç¬¬ä¸€å¤©çš„ 0 ç‚¹ã€‚ç­‰ä»·äº0 0 1 1 *ï¼› @monthlyï¼šè¡¨ç¤ºæ¯æœˆç¬¬ä¸€å¤©çš„ 0 ç‚¹ã€‚ç­‰ä»·äº0 0 1 * *ï¼› @weeklyï¼šè¡¨ç¤ºæ¯å‘¨ç¬¬ä¸€å¤©çš„ 0 ç‚¹ï¼Œæ³¨æ„ç¬¬ä¸€å¤©ä¸ºå‘¨æ—¥ï¼Œå³å‘¨å…­ç»“æŸï¼Œå‘¨æ—¥å¼€å§‹çš„é‚£ä¸ª 0 ç‚¹ã€‚ç­‰ä»·äº0 0 * * 0ï¼› @dailyï¼šä¹Ÿå¯ä»¥å†™ä½œ@midnightï¼Œè¡¨ç¤ºæ¯å¤© 0 ç‚¹ã€‚ç­‰ä»·äº0 0 * * *ï¼› @hourlyï¼šè¡¨ç¤ºæ¯å°æ—¶çš„å¼€å§‹ã€‚ç­‰ä»·äº0 * * * *ã€‚ ä¾‹å¦‚ï¼š func main() { c := cron.New() c.AddFunc(\"@hourly\", func() { fmt.Println(\"Every hour\") }) c.AddFunc(\"@daily\", func() { fmt.Println(\"Every day on midnight\") }) c.AddFunc(\"@weekly\", func() { fmt.Println(\"Every week\") }) c.Start() for { time.Sleep(time.Second) } } ä¸Šé¢ä»£ç åªæ˜¯æ¼”ç¤ºç”¨æ³•ï¼Œå®é™…è¿è¡Œå¯èƒ½è¦ç­‰å¾…éå¸¸é•¿çš„æ—¶é—´æ‰èƒ½æœ‰è¾“å‡ºã€‚ å›ºå®šæ—¶é—´é—´éš” cronæ”¯æŒå›ºå®šæ—¶é—´é—´éš”ï¼Œæ ¼å¼ä¸ºï¼š @every \u003cduration\u003e å«ä¹‰ä¸ºæ¯éš”durationè§¦å‘ä¸€æ¬¡ã€‚``ä¼šè°ƒç”¨time.ParseDuration()å‡½æ•°è§£æï¼Œæ‰€ä»¥ParseDurationæ”¯æŒçš„æ ¼å¼éƒ½å¯ä»¥ã€‚ä¾‹å¦‚1h30m10sã€‚åœ¨å¿«é€Ÿå¼€å§‹éƒ¨åˆ†ï¼Œæˆ‘ä»¬å·²ç»æ¼”ç¤ºäº†@everyçš„ç”¨æ³•äº†ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-cron/:1:3","tags":["Go","cron"],"title":"Go cron","uri":"/posts/2023-11-11-go-cron/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"æ—¶åŒº é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æ—¶é—´éƒ½æ˜¯åŸºäºå½“å‰æ—¶åŒºçš„ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‡å®šæ—¶åŒºï¼Œæœ‰ 2 ä¸¤ç§æ–¹å¼ï¼š åœ¨æ—¶é—´å­—ç¬¦ä¸²å‰é¢æ·»åŠ ä¸€ä¸ªCRON_TZ= + å…·ä½“æ—¶åŒºï¼Œå…·ä½“æ—¶åŒºçš„æ ¼å¼åœ¨ä¹‹å‰carbonçš„æ–‡ç« ä¸­æœ‰è¯¦ç»†ä»‹ç»ã€‚ä¸œäº¬æ—¶åŒºä¸ºAsia/Tokyoï¼Œçº½çº¦æ—¶åŒºä¸ºAmerica/New_Yorkï¼› åˆ›å»ºcronå¯¹è±¡æ—¶å¢åŠ ä¸€ä¸ªæ—¶åŒºé€‰é¡¹cron.WithLocation(location)ï¼Œlocationä¸ºtime.LoadLocation(zone)åŠ è½½çš„æ—¶åŒºå¯¹è±¡ï¼Œzoneä¸ºå…·ä½“çš„æ—¶åŒºæ ¼å¼ã€‚æˆ–è€…è°ƒç”¨å·²åˆ›å»ºå¥½çš„cronå¯¹è±¡çš„SetLocation()æ–¹æ³•è®¾ç½®æ—¶åŒºã€‚ ç¤ºä¾‹ï¼š func main() { nyc, _ := time.LoadLocation(\"America/New_York\") c := cron.New(cron.WithLocation(nyc)) c.AddFunc(\"0 6 * * ?\", func() { fmt.Println(\"Every 6 o'clock at New York\") }) c.AddFunc(\"CRON_TZ=Asia/Tokyo 0 6 * * ?\", func() { fmt.Println(\"Every 6 o'clock at Tokyo\") }) c.Start() for { time.Sleep(time.Second) } } ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-cron/:1:4","tags":["Go","cron"],"title":"Go cron","uri":"/posts/2023-11-11-go-cron/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Jobæ¥å£ é™¤äº†ç›´æ¥å°†æ— å‚å‡½æ•°ä½œä¸ºå›è°ƒå¤–ï¼Œcronè¿˜æ”¯æŒJobæ¥å£ï¼š // cron.go type Job interface { Run() } æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå®ç°æ¥å£Jobçš„ç»“æ„ï¼š type GreetingJob struct { Name string } func (g GreetingJob) Run() { fmt.Println(\"Hello \", g.Name) } è°ƒç”¨cronå¯¹è±¡çš„AddJob()æ–¹æ³•å°†GreetingJobå¯¹è±¡æ·»åŠ åˆ°å®šæ—¶ç®¡ç†å™¨ä¸­ï¼š func main() { c := cron.New() c.AddJob(\"@every 1s\", GreetingJob{\"dj\"}) c.Start() time.Sleep(5 * time.Second) } è¿è¡Œæ•ˆæœï¼š $ go run main.go Hello dj Hello dj Hello dj Hello dj Hello dj ä½¿ç”¨è‡ªå®šä¹‰çš„ç»“æ„å¯ä»¥è®©ä»»åŠ¡æºå¸¦çŠ¶æ€ï¼ˆNameå­—æ®µï¼‰ã€‚ å®é™…ä¸ŠAddFunc()æ–¹æ³•å†…éƒ¨ä¹Ÿè°ƒç”¨äº†AddJob()æ–¹æ³•ã€‚é¦–å…ˆï¼ŒcronåŸºäºfunc()ç±»å‹å®šä¹‰ä¸€ä¸ªæ–°çš„ç±»å‹FuncJobï¼š // cron.go type FuncJob func() ç„¶åè®©FuncJobå®ç°Jobæ¥å£ï¼š // cron.go func (f FuncJob) Run() { f() } åœ¨AddFunc()æ–¹æ³•ä¸­ï¼Œå°†ä¼ å…¥çš„å›è°ƒè½¬ä¸ºFuncJobç±»å‹ï¼Œç„¶åè°ƒç”¨AddJob()æ–¹æ³•ï¼š func (c *Cron) AddFunc(spec string, cmd func()) (EntryID, error) { return c.AddJob(spec, FuncJob(cmd)) } ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-cron/:1:5","tags":["Go","cron"],"title":"Go cron","uri":"/posts/2023-11-11-go-cron/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"çº¿ç¨‹å®‰å…¨ cronä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ goroutine æ¥æ‰§è¡Œè§¦å‘å›è°ƒã€‚å¦‚æœè¿™äº›å›è°ƒéœ€è¦å¹¶å‘è®¿é—®ä¸€äº›èµ„æºã€æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦æ˜¾å¼åœ°åšåŒæ­¥ã€‚ ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-cron/:1:6","tags":["Go","cron"],"title":"Go cron","uri":"/posts/2023-11-11-go-cron/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"è‡ªå®šä¹‰æ—¶é—´æ ¼å¼ cronæ”¯æŒçµæ´»çš„æ—¶é—´æ ¼å¼ï¼Œå¦‚æœé»˜è®¤çš„æ ¼å¼ä¸èƒ½æ»¡è¶³è¦æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å®šä¹‰æ—¶é—´æ ¼å¼ã€‚æ—¶é—´è§„åˆ™å­—ç¬¦ä¸²éœ€è¦cron.Parserå¯¹è±¡æ¥è§£æã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹é»˜è®¤çš„è§£æå™¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ é¦–å…ˆå®šä¹‰å„ä¸ªåŸŸï¼š // parser.go const ( Second ParseOption = 1 \u003c\u003c iota SecondOptional Minute Hour Dom Month Dow DowOptional Descriptor ) é™¤äº†Minute/Hour/Dom(Day of month)/Month/Dow(Day of week)å¤–ï¼Œè¿˜å¯ä»¥æ”¯æŒSecondã€‚ç›¸å¯¹é¡ºåºéƒ½æ˜¯å›ºå®šçš„ï¼š // parser.go var places = []ParseOption{ Second, Minute, Hour, Dom, Month, Dow, } var defaults = []string{ \"0\", \"0\", \"0\", \"*\", \"*\", \"*\", } é»˜è®¤çš„æ—¶é—´æ ¼å¼ä½¿ç”¨ 5 ä¸ªåŸŸã€‚ æˆ‘ä»¬å¯ä»¥è°ƒç”¨cron.NewParser()åˆ›å»ºè‡ªå·±çš„Parserå¯¹è±¡ï¼Œä»¥ä½æ ¼å¼ä¼ å…¥ä½¿ç”¨å“ªäº›åŸŸï¼Œä¾‹å¦‚ä¸‹é¢çš„Parserä½¿ç”¨ 6 ä¸ªåŸŸï¼Œæ”¯æŒSecondï¼ˆç§’ï¼‰ï¼š parser := cron.NewParser( cron.Second | cron.Minute | cron.Hour | cron.Dom | cron.Month | cron.Dow | cron.Descriptor, ) è°ƒç”¨cron.WithParser(parser)åˆ›å»ºä¸€ä¸ªé€‰é¡¹ä¼ å…¥æ„é€ å‡½æ•°cron.New()ï¼Œä½¿ç”¨æ—¶å°±å¯ä»¥æŒ‡å®šç§’äº†ï¼š c := cron.New(cron.WithParser(parser)) c.AddFunc(\"1 * * * * *\", func () { fmt.Println(\"every 1 second\") }) c.Start() è¿™é‡Œæ—¶é—´æ ¼å¼å¿…é¡»ä½¿ç”¨ 6 ä¸ªåŸŸï¼Œé¡ºåºä¸ä¸Šé¢çš„constå®šä¹‰ä¸€è‡´ã€‚ å› ä¸ºä¸Šé¢çš„æ—¶é—´æ ¼å¼å¤ªå¸¸è§äº†ï¼Œcronå®šä¹‰äº†ä¸€ä¸ªä¾¿æ·çš„å‡½æ•°ï¼š // option.go func WithSeconds() Option { return WithParser(NewParser( Second | Minute | Hour | Dom | Month | Dow | Descriptor, )) } æ³¨æ„Descriptorè¡¨ç¤ºå¯¹@every/@hourç­‰çš„æ”¯æŒã€‚æœ‰äº†WithSeconds()ï¼Œæˆ‘ä»¬ä¸ç”¨æ‰‹åŠ¨åˆ›å»ºParserå¯¹è±¡äº†ï¼š c := cron.New(cron.WithSeconds()) ","date":"2023-11-11","objectID":"/posts/2023-11-11-go-cron/:1:7","tags":["Go","cron"],"title":"Go cron","uri":"/posts/2023-11-11-go-cron/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"é€‰é¡¹ cronå¯¹è±¡åˆ›å»ºä½¿ç”¨äº†é€‰é¡¹æ¨¡å¼ï¼Œæˆ‘ä»¬å‰é¢å·²ç»ä»‹ç»äº† 3 ä¸ªé€‰é¡¹ï¼š WithLocationï¼šæŒ‡å®šæ—¶åŒºï¼› WithParserï¼šä½¿ç”¨è‡ªå®šä¹‰çš„è§£æå™¨ï¼› WithSecondsï¼šè®©æ—¶é—´æ ¼å¼æ”¯æŒç§’ï¼Œå®é™…ä¸Šå†…éƒ¨è°ƒç”¨äº†WithParserã€‚ cronè¿˜æä¾›äº†å¦å¤–ä¸¤ç§é€‰é¡¹ï¼š WithLoggerï¼šè‡ªå®šä¹‰Loggerï¼› WithChainï¼šJob åŒ…è£…å™¨ã€‚ WithLogger WithLoggerå¯ä»¥è®¾ç½®cronå†…éƒ¨ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„Loggerï¼š func main() { c := cron.New( cron.WithLogger( cron.VerbosePrintfLogger(log.New(os.Stdout, \"cron: \", log.LstdFlags)))) c.AddFunc(\"@every 1s\", func() { fmt.Println(\"hello world\") }) c.Start() time.Sleep(5 * time.Second) } ä¸Šé¢è°ƒç”¨cron.VerbosPrintfLogger()åŒ…è£…log.Loggerï¼Œè¿™ä¸ªloggerä¼šè¯¦ç»†è®°å½•cronå†…éƒ¨çš„è°ƒåº¦è¿‡ç¨‹ï¼š $ go run main.go cron: 2020/06/26 07:09:14 start cron: 2020/06/26 07:09:14 schedule, now=2020-06-26T07:09:14+08:00, entry=1, next=2020-06-26T07:09:15+08:00 cron: 2020/06/26 07:09:15 wake, now=2020-06-26T07:09:15+08:00 cron: 2020/06/26 07:09:15 run, now=2020-06-26T07:09:15+08:00, entry=1, next=2020-06-26T07:09:16+08:00 hello world cron: 2020/06/26 07:09:16 wake, now=2020-06-26T07:09:16+08:00 cron: 2020/06/26 07:09:16 run, now=2020-06-26T07:09:16+08:00, entry=1, next=2020-06-26T07:09:17+08:00 hello world cron: 2020/06/26 07:09:17 wake, now=2020-06-26T07:09:17+08:00 cron: 2020/06/26 07:09:17 run, now=2020-06-26T07:09:17+08:00, entry=1, next=2020-06-26T07:09:18+08:00 hello world cron: 2020/06/26 07:09:18 wake, now=2020-06-26T07:09:18+08:00 hello world cron: 2020/06/26 07:09:18 run, now=2020-06-26T07:09:18+08:00, entry=1, next=2020-06-26T07:09:19+08:00 cron: 2020/06/26 07:09:19 wake, now=2020-06-26T07:09:19+08:00 hello world cron: 2020/06/26 07:09:19 run, now=2020-06-26T07:09:19+08:00, entry=1, next=2020-06-26T07:09:20+08:0 æˆ‘ä»¬çœ‹çœ‹é»˜è®¤çš„Loggeræ˜¯ä»€ä¹ˆæ ·çš„ï¼š // logger.go var DefaultLogger Logger = PrintfLogger(log.New(os.Stdout, \"cron: \", log.LstdFlags)) func PrintfLogger(l interface{ Printf(string, ...interface{}) }) Logger { return printfLogger{l, false} } func VerbosePrintfLogger(l interface{ Printf(string, ...interface{}) }) Logger { return printfLogger{l, true} } type printfLogger struct { logger interface{ Printf(string, ...interface{}) } logInfo bool } WithChain Job åŒ…è£…å™¨å¯ä»¥åœ¨æ‰§è¡Œå®é™…çš„Jobå‰åæ·»åŠ ä¸€äº›é€»è¾‘ï¼š æ•è·panicï¼› å¦‚æœJobä¸Šæ¬¡è¿è¡Œè¿˜æœªç»“æŸï¼Œæ¨è¿Ÿæœ¬æ¬¡æ‰§è¡Œ; å¦‚æœJobä¸Šæ¬¡è¿è¡Œè¿˜æœªä»‹ç»ï¼Œè·³è¿‡æœ¬æ¬¡æ‰§è¡Œï¼› è®°å½•æ¯ä¸ªJobçš„æ‰§è¡Œæƒ…å†µã€‚ æˆ‘ä»¬å¯ä»¥å°†Chainç±»æ¯”ä¸º Web å¤„ç†å™¨çš„ä¸­é—´ä»¶ã€‚å®é™…ä¸Šå°±æ˜¯åœ¨Jobçš„æ‰§è¡Œé€»è¾‘å¤–åœ¨å°è£…ä¸€å±‚é€»è¾‘ã€‚æˆ‘ä»¬çš„å°è£…é€»è¾‘éœ€è¦å†™æˆä¸€ä¸ªå‡½æ•°ï¼Œä¼ å…¥ä¸€ä¸ªJobç±»å‹ï¼Œè¿”å›å°è£…åçš„Jobã€‚cronä¸ºè¿™ç§å‡½æ•°å®šä¹‰äº†ä¸€ä¸ªç±»å‹JobWrapperï¼š // chain.go type JobWrapper func(Job) Job ç„¶åä½¿ç”¨ä¸€ä¸ªChainå¯¹è±¡å°†è¿™äº›JobWrapperç»„åˆåˆ°ä¸€èµ·ï¼š type Chain struct { wrappers []JobWrapper } func NewChain(c ...JobWrapper) Chain { return Chain{c} } è°ƒç”¨Chainå¯¹è±¡çš„Then(job)æ–¹æ³•åº”ç”¨è¿™äº›JobWrapperï¼Œè¿”å›æœ€ç»ˆçš„`Jobï¼š func (c Chain) Then(j Job) Job { for i := range c.wrappers { j = c.wrappers[len(c.wrappers)-i-1](j) } return j } æ³¨æ„åº”ç”¨JobWrapperçš„é¡ºåºã€‚ å†…ç½®JobWrapper cronå†…ç½®äº† 3 ä¸ªç”¨å¾—æ¯”è¾ƒå¤šçš„JobWrapperï¼š Recoverï¼šæ•è·å†…éƒ¨Jobäº§ç”Ÿçš„ panicï¼› DelayIfStillRunningï¼šè§¦å‘æ—¶ï¼Œå¦‚æœä¸Šä¸€æ¬¡ä»»åŠ¡è¿˜æœªæ‰§è¡Œå®Œæˆï¼ˆè€—æ—¶å¤ªé•¿ï¼‰ï¼Œåˆ™ç­‰å¾…ä¸Šä¸€æ¬¡ä»»åŠ¡å®Œæˆä¹‹åå†æ‰§è¡Œï¼› SkipIfStillRunningï¼šè§¦å‘æ—¶ï¼Œå¦‚æœä¸Šä¸€æ¬¡ä»»åŠ¡è¿˜æœªå®Œæˆï¼Œåˆ™è·³è¿‡æ­¤æ¬¡æ‰§è¡Œã€‚ ä¸‹é¢åˆ†åˆ«ä»‹ç»ã€‚ Recover å…ˆçœ‹çœ‹å¦‚ä½•ä½¿ç”¨ï¼š type panicJob struct { count int } func (p *panicJob) Run() { p.count++ if p.count == 1 { panic(\"oooooooooooooops!!!\") } fmt.Println(\"hello world\") } func main() { c := cron.New() c.AddJob(\"@every 1s\", cron.NewChain(cron.Recover(cron.DefaultLogger)).Then(\u0026panicJob{})) c.Start() time.Sleep(5 * time.Second) } panicJobåœ¨ç¬¬ä¸€æ¬¡è§¦å‘æ—¶ï¼Œè§¦å‘äº†panicã€‚å› ä¸ºæœ‰cron.Recover()ä¿æŠ¤ï¼Œåç»­ä»»åŠ¡è¿˜èƒ½æ‰§è¡Œï¼š go run main.go cron: 2020/06/27 14:02:00 panic, error=oooooooooooooops!!!, stack=... goroutine 18 [running]: github.com/robfig/cron/v3.Recover.func1.1.1(0x514ee0, 0xc0000044a0) D:/code/golang/pkg/mod/github.com/robfig/cron/v3@v3.0.1/chain.go:45 +0xbc panic(0x4cf380, 0x513280) C:/Go/src/runtime/panic.go:969 +0x174 main.(*panicJob).Run(0xc0000140e8) D:/code/golang/src/github.com/darjun/go-daily-lib/cron/recover/main.go:17 +0xba github.com/robfig/cron/v3.Recover.func1.1() D:/code/golang/pkg/mod/github.com/robfig/cron/v3@v3.0.1/chain.go:53 +0x6f github.com/robfig/cron/v3.FuncJob.Run(0xc000070390) D:/code/golang/pkg/mod/github.com/robfig/cron/v3@v3.0.1/cron.go:136 +0x2c github.com/robfig/cron/v3.(*Cron).startJob.func1(0xc00005c0a0, 0x514d20, 0xc000070390) D:/code/golang/pkg/mod/github.com/robfig/cron/v3@v3.0.1/cron.go:312 +0x68 created by github.com/robfig/cron/v3.(*Cron).startJob D:","date":"2023-11-11","objectID":"/posts/2023-11-11-go-cron/:1:8","tags":["Go","cron"],"title":"Go cron","uri":"/posts/2023-11-11-go-cron/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go gophåº“ é“¾æ¥åœ°å€ï¼š github.com/melbahja/goph github.com/serialt/goph (æ–¹ä¾¿æŒ‡å®šç«¯å£) ","date":"2023-11-10","objectID":"/posts/go-goth/:0:0","tags":["Go","goph","ssh","sftp"],"title":"Go goph","uri":"/posts/go-goth/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"ç‰¹æ€§ æ˜“äºä½¿ç”¨ï¼Œç®€åŒ– ssh apiã€‚ æ”¯æŒssh å¯†ç ã€ç§é’¥ï¼Œå¸¦å¯†ç çš„ç§é’¥ã€‚ æ”¯æŒä»æœ¬åœ°ä¸Šä¼ æ–‡ä»¶å’Œä»è¿œç¨‹ä¸‹è½½æ–‡ä»¶ã€‚ æ”¯æŒ ssh ä½¿ç”¨ ssh-agent è¿æ¥ä¼šè¯ã€‚ æ”¯æŒå¢åŠ ä¸»æœºåˆ° known_hosts æ–‡ä»¶ã€‚ ","date":"2023-11-10","objectID":"/posts/go-goth/:1:0","tags":["Go","goph","ssh","sftp"],"title":"Go goph","uri":"/posts/go-goth/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å®‰è£… go get github.com/serialt/goph ","date":"2023-11-10","objectID":"/posts/go-goth/:2:0","tags":["Go","goph","ssh","sftp"],"title":"Go goph","uri":"/posts/go-goth/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"ä½¿ç”¨ç¤ºä¾‹ ","date":"2023-11-10","objectID":"/posts/go-goth/:3:0","tags":["Go","goph","ssh","sftp"],"title":"Go goph","uri":"/posts/go-goth/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"1ã€ä½¿ç”¨æ‰§è¡Œå‘½ä»¤ package main import ( \"fmt\" \"log\" \"github.com/serialt/goph\" ) var Client *goph.Client func init() { auth, err := goph.Key(os.Getenv(\"HOME\")+\"/.ssh/id_rsa\", \"\") if err != nil { log.Fatalf(\"cat read the ssh private key: %v\", err) } client, err := goph.New(\"root\", \"10.10.16.10\", 22, auth) if err != nil { log.Fatalf(\"ssh link faild: %v\", err) } Client = client } func main() { result, err := Client.Run(\"date\") fmt.Printf(\"result: %v\\nerr: %v\", string(result), err) defer Client.Close() } ","date":"2023-11-10","objectID":"/posts/go-goth/:3:1","tags":["Go","goph","ssh","sftp"],"title":"Go goph","uri":"/posts/go-goth/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"2ã€ä»å­—ç¬¦ä¸²ä¸­è¯»å–ç§é’¥ package main import ( \"fmt\" \"log\" \"github.com/serialt/goph\" ) var Client *goph.Client var sshkey = ` -----BEGIN OPENSSH PRIVATE KEY----- NeY6rItzuvwtiPa5etNiAAAAGnNlcmlhbHQgdHNlcmlhbHRAZ21haWwuY29tAQID NeY6rItzuvwtiPa5etNiAAAAGnNlcmlhbHQgdHNlcmlhbHRAZ21haWwuY29tAQID NeY6rItzuvwtiPa5etNiAAAAGnNlcmlhbHQgdHNlcmlhbHRAZ21haWwuY29tAQID AAAECptYaTKFA2Omsb67+FN2SPr3daBAA0IxpVwv5KYJ1QKWR98JYVP7/WAqffRO NeY6rItzuvwtiPa5etNiAAAAGnNlcmlhbHQgdHNlcmlhbHRAZ21haWwuY29tAQID -----END OPENSSH PRIVATE KEY----- ` func init() { auth, err := goph.RawKey(sshkey, \"\") if err != nil { log.Fatalf(\"cat read the ssh private key: %v\", err) } client, err := goph.New(\"root\", \"10.10.16.10\", 22, auth) if err != nil { log.Fatalf(\"ssh link faild: %v\", err) } Client = client } func main() { result, err := Client.Run(\"date\") fmt.Printf(\"result: %v\\nerr: %v\", string(result), err) defer Client.Close() } ","date":"2023-11-10","objectID":"/posts/go-goth/:3:2","tags":["Go","goph","ssh","sftp"],"title":"Go goph","uri":"/posts/go-goth/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"3ã€å¯†é’¥å¸¦å¯†ç  auth, err := goph.Key(os.Getenv(\"HOME\")+\"/.ssh/id_rsa\", \"you_passphrase_here\") if err != nil { // handle error } client, err := goph.New(\"root\", \"192.1.1.3\", auth) ","date":"2023-11-10","objectID":"/posts/go-goth/:3:3","tags":["Go","goph","ssh","sftp"],"title":"Go goph","uri":"/posts/go-goth/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"4ã€ä½¿ç”¨å¯†ç  auth, err := goph.UseAgent() if err != nil { // handle error } client, err := goph.New(\"root\", \"192.1.1.1\", auth) ","date":"2023-11-10","objectID":"/posts/go-goth/:3:4","tags":["Go","goph","ssh","sftp"],"title":"Go goph","uri":"/posts/go-goth/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"5ã€ä¸Šä¼ å’Œä¸‹è½½æ–‡ä»¶ // upload local file to remote err := client.Upload(\"/path/to/local/file\", \"/path/to/remote/file\") // download remote file to local err := client.Download(\"/path/to/remote/file\", \"/path/to/local/file\") ","date":"2023-11-10","objectID":"/posts/go-goth/:3:5","tags":["Go","goph","ssh","sftp"],"title":"Go goph","uri":"/posts/go-goth/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"6ã€æ‰§è¡Œshellå‘½ä»¤ // execute bash commands out, err := client.Run(\"bash -c 'printenv'\") // execute bash command whith timeout context, cancel := context.WithTimeout(ctx, time.Second) defer cancel() // will send SIGINT and return error after 1 second out, err := client.RunContext(ctx, \"sleep 5\") // execute bash command whith env variables out, err := client.Run(`env MYVAR=\"MY VALUE\" bash -c 'echo $MYVAR;'`) ","date":"2023-11-10","objectID":"/posts/go-goth/:3:6","tags":["Go","goph","ssh","sftp"],"title":"Go goph","uri":"/posts/go-goth/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"7ã€ä½¿ç”¨goph cmd Goph.Cmd struct is like the Go standard os/exec.Cmd. // Get new `Goph.Cmd` cmd, err := client.Command(\"ls\", \"-alh\", \"/tmp\") // or with context: // cmd, err := client.CommandContext(ctx, \"ls\", \"-alh\", \"/tmp\") if err != nil { // handle the error! } // You can set env vars, but the server must be configured to `AcceptEnv line`. cmd.Env = []string{\"MY_VAR=MYVALUE\"} // Run you command. err = cmd.Run() ust like os/exec.Cmd you can run CombinedOutput, Output, Start, Wait, and ssh.Session methods like Signalâ€¦ ","date":"2023-11-10","objectID":"/posts/go-goth/:3:7","tags":["Go","goph","ssh","sftp"],"title":"Go goph","uri":"/posts/go-goth/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"8ã€ä½¿ç”¨sftpæ“ä½œæ–‡ä»¶ç³»ç»Ÿ sftp, err := client.NewSftp() if err != nil { // handle the error! } file, err := sftp.Create(\"/tmp/remote_file\") file.Write([]byte(`Hello world`)) file.Close() For more file operations see SFTP Docs. ","date":"2023-11-10","objectID":"/posts/go-goth/:3:8","tags":["Go","goph","ssh","sftp"],"title":"Go goph","uri":"/posts/go-goth/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"å®˜æ–¹ç¤ºä¾‹ package main import ( \"bufio\" \"context\" \"errors\" \"flag\" \"fmt\" \"log\" \"net\" \"os\" osuser \"os/user\" \"path/filepath\" \"strings\" \"time\" \"github.com/pkg/sftp\" \"github.com/serialt/goph\" \"golang.org/x/crypto/ssh\" \"golang.org/x/crypto/ssh/terminal\" ) // // Run command and auth via password: // \u003e go run main.go --ip 192.168.122.102 --pass --cmd ls // // Run command and auth via private key: // \u003e go run main.go --ip 192.168.122.102 --cmd ls // Or: // \u003e go run main.go --ip 192.168.122.102 --key /path/to/private_key --cmd ls // // Run command and auth with private key and passphrase: // \u003e go run main.go --ip 192.168.122.102 --passphrase --cmd ls // // Run a command and interrupt it after 1 second: // \u003e go run main.go --ip 192.168.122.102 --cmd \"sleep 10\" --timeout=1s // // You can test with the interactive mode without passing --cmd flag. // var ( err error auth goph.Auth client *goph.Client addr string user string port uint key string cmd string pass bool passphrase bool timeout time.Duration agent bool sftpc *sftp.Client ) func init() { usr, err := osuser.Current() if err != nil { fmt.Println(\"couldn't determine current user. defaulting to 'root'\") usr.Username = \"root\" } flag.StringVar(\u0026addr, \"ip\", \"127.0.0.1\", \"machine ip address.\") flag.StringVar(\u0026user, \"user\", usr.Username, \"ssh user.\") flag.UintVar(\u0026port, \"port\", 22, \"ssh port number.\") flag.StringVar(\u0026key, \"key\", filepath.Join(os.Getenv(\"HOME\"), \".ssh\", \"id_rsa\"), \"private key path.\") flag.StringVar(\u0026cmd, \"cmd\", \"\", \"command to run.\") flag.BoolVar(\u0026pass, \"pass\", false, \"ask for ssh password instead of private key.\") flag.BoolVar(\u0026agent, \"agent\", false, \"use ssh agent for authentication (unix systems only).\") flag.BoolVar(\u0026passphrase, \"passphrase\", false, \"ask for private key passphrase.\") flag.DurationVar(\u0026timeout, \"timeout\", 0, \"interrupt a command with SIGINT after a given timeout (0 means no timeout)\") } func VerifyHost(host string, remote net.Addr, key ssh.PublicKey) error { // // If you want to connect to new hosts. // here your should check new connections public keys // if the key not trusted you shuld return an error // // hostFound: is host in known hosts file. // err: error if key not in known hosts file OR host in known hosts file but key changed! hostFound, err := goph.CheckKnownHost(host, remote, key, \"\") // Host in known hosts but key mismatch! // Maybe because of MAN IN THE MIDDLE ATTACK! if hostFound \u0026\u0026 err != nil { return err } // handshake because public key already exists. if hostFound \u0026\u0026 err == nil { return nil } // Ask user to check if he trust the host public key. if askIsHostTrusted(host, key) == false { // Make sure to return error on non trusted keys. return errors.New(\"you typed no, aborted!\") } // Add the new host to known hosts file. return goph.AddKnownHost(host, remote, key, \"\") } func main() { flag.Parse() var err error if agent || goph.HasAgent() { auth, err = goph.UseAgent() } else if pass { auth = goph.Password(askPass(\"Enter SSH Password: \")) } else { auth, err = goph.Key(key, getPassphrase(passphrase)) } if err != nil { panic(err) } client, err = goph.NewConn(\u0026goph.Config{ User: user, Addr: addr, Port: port, Auth: auth, Callback: VerifyHost, }) if err != nil { panic(err) } // Close client net connection defer client.Close() // If the cmd flag exists if cmd != \"\" { ctx := context.Background() // create a context with timeout, if supplied in the argumetns if timeout \u003e 0 { var cancel context.CancelFunc ctx, cancel = context.WithTimeout(ctx, timeout) defer cancel() } out, err := client.RunContext(ctx, cmd) fmt.Println(string(out), err) return } // else open interactive mode. playWithSSHJustForTestingThisProgram(client) } func askPass(msg string) string { fmt.Print(msg) pass, err := terminal.ReadPassword(0) if err != nil { panic(err) } fmt.Println(\"\") return strings.TrimSpace(string(pass)) } func getPassphrase(ask bool) string { if ask { return askPass(\"Enter Private Key Passphrase: \") } return \"\" } func askIsHostTrusted(host string, key ssh.Public","date":"2023-11-10","objectID":"/posts/go-goth/:4:0","tags":["Go","goph","ssh","sftp"],"title":"Go goph","uri":"/posts/go-goth/"},{"categories":["morseç¼–ç "],"content":"Morse Code äºŒå‰æ ‘è®°å¿†æ³• start E T I A N M S U R W D K G O H V F L P J B X C Y Z Q . - E T .. .- -. -- I A N M ... ..- .-. ..- -.. -.- --. --- S U R W D K G O .... ...- ..-. .-.. .--. .--- -... -..- -.-. -.-- --.. --.- H v F L P J B X C Y Z Q ","date":"2023-11-08","objectID":"/posts/morse-code/:1:0","tags":["morse","morse-code"],"title":"Morse Code","uri":"/posts/morse-code/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"req Goè¯­è¨€äººæ€§åŒ–HTTPè¯·æ±‚åº“ ç‰¹æ€§ è½»é‡çº§ ç®€å• å®¹æ˜“æ“ä½œJSONå’ŒXML å®¹æ˜“è°ƒè¯•å’Œæ—¥å¿—è®°å½• å®¹æ˜“ä¸Šä¼ å’Œä¸‹è½½æ–‡ä»¶ å®¹æ˜“ç®¡ç†Cookie å®¹æ˜“è®¾ç½®ä»£ç† å®¹æ˜“è®¾ç½®è¶…æ—¶ å®¹æ˜“è‡ªå®šä¹‰HTTPå®¢æˆ·ç«¯ å®‰è£… go get github.com/serialt/req æ¦‚è¦ req åŸºäºæ ‡å‡†åº“ net/http å®ç°äº†ä¸€ä¸ªå‹å¥½çš„API. Req å’Œ Resp æ˜¯ä¸¤ä¸ªæœ€é‡è¦çš„ç»“æ„ä½“, ä½ å¯ä»¥æŠŠ Req çœ‹ä½œå®¢æˆ·ç«¯ï¼Œ æŠŠResp çœ‹ä½œå­˜æ”¾è¯·æ±‚åŠå…¶å“åº”çš„å®¹å™¨ï¼Œå®ƒä»¬éƒ½æä¾›è®¸å¤šç®€æ´æ–¹ä¾¿çš„APIï¼Œè®©ä½ å¯ä»¥å¾ˆè½»æ¾åšå¾ˆå¤šå¾ˆå¤šäº‹æƒ…ã€‚ func (r *Req) Post(url string, v ...interface{}) (*Resp, error) å¤§å¤šæƒ…å†µä¸‹ï¼Œå‘èµ·è¯·æ±‚åªæœ‰urlæ˜¯å¿…é€‰å‚æ•°ï¼Œå…¶å®ƒéƒ½å¯é€‰ï¼Œæ¯”å¦‚è¯·æ±‚å¤´ã€è¯·æ±‚å‚æ•°ã€æ–‡ä»¶æˆ–è¯·æ±‚ä½“ç­‰ã€‚ åŒ…ä¸­å«ä¸€ä¸ªé»˜è®¤çš„ Req å¯¹è±¡, å®ƒæ‰€æœ‰çš„å…¬æœ‰æ–¹æ³•éƒ½è¢«reqåŒ…å¯¹åº”çš„å…¬æœ‰æ–¹æ³•åŒ…è£…äº†ï¼Œæ‰€ä»¥å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ ç›´æ¥å¯ä»¥æŠŠreqåŒ…çœ‹ä½œä¸€ä¸ªReqå¯¹è±¡æ¥ä½¿ç”¨ã€‚ // åˆ›å»ºReqå¯¹è±¡æ¥å‘èµ·è¯·æ±‚ r := req.New() r.Get(url) // ç›´æ¥ä½¿ç”¨reqåŒ…å‘èµ·è¯·æ±‚ req.Get(url) ä½ å¯ä»¥ä½¿ç”¨ req.New() æ–¹æ³•æ¥åˆ›å»º *Req ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„å®¢æˆ·ç«¯ ä¾‹å­ åŸºç¡€ç”¨æ³• è®¾ç½®è¯·æ±‚å¤´ è®¾ç½®è¯·æ±‚å‚æ•° è®¾ç½®è¯·æ±‚ä½“ è°ƒè¯• è¾“å‡ºæ ¼å¼ ToJSON \u0026 ToXML è·å– *http.Response ä¸Šä¼  ä¸‹è½½ Cookie è®¾ç½®è¶…æ—¶ è®¾ç½®ä»£ç† è‡ªå®šä¹‰ http.Client ","date":"2023-10-09","objectID":"/posts/req/:0:0","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"åŸºç¡€ç”¨æ³• header := req.Header{ \"Accept\": \"application/json\", \"Authorization\": \"Basic YWRtaW46YWRtaW4=\", } param := req.Param{ \"name\": \"imroc\", \"cmd\": \"add\", } // åªæœ‰urlå¿…é€‰ï¼Œå…¶å®ƒå‚æ•°éƒ½æ˜¯å¯é€‰ r, err = req.Post(\"http://foo.bar/api\", header, param) if err != nil { log.Fatal(err) } r.ToJSON(\u0026foo) // å“åº”ä½“è½¬æˆå¯¹è±¡ log.Printf(\"%+v\", r) // æ‰“å°è¯¦ç»†ä¿¡æ¯ ","date":"2023-10-09","objectID":"/posts/req/:1:0","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"è®¾ç½®è¯·æ±‚å¤´ ä½¿ç”¨ req.Header (å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ª map[string]string) authHeader := req.Header{ \"Accept\": \"application/json\", \"Authorization\": \"Basic YWRtaW46YWRtaW4=\", } req.Get(\"https://www.baidu.com\", authHeader, req.Header{\"User-Agent\": \"V1.1\"}) ä½¿ç”¨ http.Header header := make(http.Header) header.Set(\"Accept\", \"application/json\") req.Get(\"https://www.baidu.com\", header) ä½ å¯ä»¥ä½¿ç”¨ struct æ¥è®¾ç½®è¯·æ±‚å¤´ï¼Œç”¨ HeaderFromStruct è¿™ä¸ªå‡½æ•°æ¥è§£æä½ çš„ struct type HeaderStruct struct { UserAgent string `json:\"User-Agent\"` Authorization string `json:\"Authorization\"` } func main(){ h := HeaderStruct{ \"V1.0.0\", \"roc\", } authHeader := req.HeaderFromStruct(h) req.Get(\"https://www.baidu.com\", authHeader, req.Header{\"User-Agent\": \"V1.1\"}) } æ³¨ï¼šè¯·ç»™ä½ çš„ struct åŠ ä¸Š json tag. ","date":"2023-10-09","objectID":"/posts/req/:2:0","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"è®¾ç½®è¯·æ±‚å‚æ•° Use req.Param (å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ª map[string]interface{}) param := req.Param{ \"id\": \"imroc\", \"pwd\": \"roc\", } req.Get(\"http://foo.bar/api\", param) // http://foo.bar/api?id=imroc\u0026pwd=roc req.Post(url, param) // è¯·æ±‚ä½“ =\u003e id=imroc\u0026pwd=roc ä½¿ç”¨ req.QueryParam å¼ºåˆ¶å°†è¯·æ±‚å‚æ•°æ‹¼åœ¨urlåé¢ (å®ƒå®é™…ä¸Šä¹Ÿæ˜¯ä¸€ä¸ª map[string]interface{}) req.Post(\"http://foo.bar/api\", req.Param{\"name\": \"roc\", \"age\": \"22\"}, req.QueryParam{\"access_token\": \"fedledGF9Hg9ehTU\"}) /* POST /api?access_token=fedledGF9Hg9ehTU HTTP/1.1 Host: foo.bar User-Agent: Go-http-client/1.1 Content-Length: 15 Content-Type: application/x-www-form-urlencoded;charset=UTF-8 Accept-Encoding: gzip age=22\u0026name=roc */ ","date":"2023-10-09","objectID":"/posts/req/:3:0","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"è®¾ç½®è¯·æ±‚ä½“ Put string, []byte and io.Reader as body directly. req.Post(url, \"id=roc\u0026cmd=query\") å°†å¯¹è±¡ä½œä¸ºJSONæˆ–XMLè¯·æ±‚ä½“ï¼ˆè‡ªåŠ¨æ·»åŠ  Content-Type è¯·æ±‚å¤´ï¼‰ req.Post(url, req.BodyJSON(\u0026foo)) req.Post(url, req.BodyXML(\u0026bar)) ","date":"2023-10-09","objectID":"/posts/req/:4:0","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"è°ƒè¯• å°†å…¨å±€å˜é‡ req.Debug è®¾ç½®ä¸ºtrueï¼Œå°†ä¼šæŠŠæ‰€æœ‰è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯æ‰“å°åœ¨æ ‡å‡†è¾“å‡ºã€‚ req.Debug = true req.Post(\"http://localhost/test\" \"hi\") ","date":"2023-10-09","objectID":"/posts/req/:5:0","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"è¾“å‡ºæ ¼å¼ æ‚¨å¯ä»¥ä½¿ç”¨æŒ‡å®šç±»å‹çš„è¾“å‡ºæ ¼å¼åœ¨æ—¥å¿—æ–‡ä»¶ä¸­è®°å½•è¯·æ±‚å’Œå“åº”çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œåœ¨å¼€å‘é˜¶æ®µä½¿ç”¨ï¼…+væ ¼å¼ï¼Œå¯ä»¥è®©ä½ è§‚å¯Ÿè¯·æ±‚å’Œå“åº”çš„ç»†èŠ‚ä¿¡æ¯ã€‚ åœ¨ç”Ÿäº§é˜¶æ®µä½¿ç”¨ï¼…væˆ–ï¼…-vè¾“å‡ºæ ¼å¼ï¼Œåªè®°å½•æ‰€éœ€è¦çš„ä¿¡æ¯ã€‚ ","date":"2023-10-09","objectID":"/posts/req/:6:0","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"%+v æˆ– %+s è¯¦ç»†è¾“å‡º r, _ := req.Post(url, header, param) log.Printf(\"%+v\", r) // è¾“å‡ºæ ¼å¼å’ŒDebugå¼€å¯æ—¶çš„æ ¼å¼ä¸€æ · ","date":"2023-10-09","objectID":"/posts/req/:6:1","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"%v æˆ– %s ç®€å•è¾“å‡ºï¼ˆé»˜è®¤æ ¼å¼ï¼‰ r, _ := req.Get(url, param) log.Printf(\"%v\\n\", r) // GET http://foo.bar/api?name=roc\u0026cmd=add {\"code\":\"0\",\"msg\":\"success\"} log.Prinln(r) // å’Œä¸Šé¢ä¸€æ · ","date":"2023-10-09","objectID":"/posts/req/:6:2","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"%-v æˆ– %-s ç®€å•è¾“å‡ºå¹¶ä¿æŒæ‰€æœ‰å†…å®¹åœ¨ä¸€è¡Œå†…ï¼ˆè¯·æ±‚ä½“æˆ–å“åº”ä½“å¯èƒ½åŒ…å«å¤šè¡Œï¼Œè¿™ç§æ ¼å¼ä¼šå°†æ‰€æœ‰æ¢è¡Œã€å›è½¦æ›¿æ¢æˆ\" \", è¿™åœ¨ä¼šè®©ä½ åœ¨æŸ¥æ—¥å¿—çš„æ—¶å€™éå¸¸æœ‰ç”¨ï¼‰ ","date":"2023-10-09","objectID":"/posts/req/:6:3","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"Flag ä½ å¯ä»¥è°ƒç”¨ SetFlags æ§åˆ¶è¾“å‡ºå†…å®¹ï¼Œå†³å®šå“ªäº›éƒ¨åˆ†èƒ½å¤Ÿè¢«è¾“å‡ºã€‚ const ( LreqHead = 1 \u003c\u003c iota // è¾“å‡ºè¯·æ±‚é¦–éƒ¨ï¼ˆåŒ…å«è¯·æ±‚è¡Œå’Œè¯·æ±‚å¤´ï¼‰ LreqBody // è¾“å‡ºè¯·æ±‚ä½“ LrespHead // è¾“å‡ºå“åº”é¦–éƒ¨ï¼ˆåŒ…å«å“åº”è¡Œå’Œå“åº”å¤´ï¼‰ LrespBody // è¾“å‡ºå“åº”ä½“ Lcost // è¾“å‡ºè¯·æ±‚æ‰€æ¶ˆè€—æ‰æ—¶é•¿ LstdFlags = LreqHead | LreqBody | LrespHead | LrespBody ) req.SetFlags(req.LreqHead | req.LreqBody | req.LrespHead) ","date":"2023-10-09","objectID":"/posts/req/:6:4","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"ç›‘æ§è¯·æ±‚è€—æ—¶ req.SetFlags(req.LstdFlags | req.Lcost) // è¾“å‡ºæ ¼å¼æ˜¾ç¤ºè¯·æ±‚è€—æ—¶ r,_ := req.Get(url) log.Println(r) // http://foo.bar/api 3.260802ms {\"code\":0 \"msg\":\"success\"} if r.Cost() \u003e 3 * time.Second { // æ£€æŸ¥è€—æ—¶ log.Println(\"WARN: slow request:\", r) } ","date":"2023-10-09","objectID":"/posts/req/:6:5","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"ToJSON \u0026 ToXML r, _ := req.Get(url) r.ToJSON(\u0026foo) r, _ = req.Post(url, req.BodyXML(\u0026bar)) r.ToXML(\u0026baz) ","date":"2023-10-09","objectID":"/posts/req/:7:0","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"è·å– *http.Response // func (r *Req) Response() *http.Response r, _ := req.Get(url) resp := r.Response() fmt.Println(resp.StatusCode) ","date":"2023-10-09","objectID":"/posts/req/:8:0","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"ä¸Šä¼  ä½¿ç”¨ req.File åŒ¹é…æ–‡ä»¶ req.Post(url, req.File(\"imroc.png\"), req.File(\"/Users/roc/Pictures/*.png\")) ä½¿ç”¨ req.FileUpload ç»†ç²’åº¦æ§åˆ¶ä¸Šä¼  file, _ := os.Open(\"imroc.png\") req.Post(url, req.FileUpload{ File: file, FieldName: \"file\", // FieldName æ˜¯è¡¨å•å­—æ®µå FileName: \"avatar.png\", // Filename æ˜¯è¦ä¸Šä¼ çš„æ–‡ä»¶çš„åç§°ï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒæ¥çŒœæµ‹mimetypeï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Š }) ä½¿ç”¨req.UploadProgressç›‘å¬ä¸Šä¼ è¿›åº¦ progress := func(current, total int64) { fmt.Println(float32(current)/float32(total)*100, \"%\") } req.Post(url, req.File(\"/Users/roc/Pictures/*.png\"), req.UploadProgress(progress)) fmt.Println(\"upload complete\") ","date":"2023-10-09","objectID":"/posts/req/:9:0","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"ä¸‹è½½ r, _ := req.Get(url) r.ToFile(\"imroc.png\") ä½¿ç”¨req.DownloadProgressç›‘å¬ä¸‹è½½è¿›åº¦ progress := func(current, total int64) { fmt.Println(float32(current)/float32(total)*100, \"%\") } r, _ := req.Get(url, req.DownloadProgress(progress)) r.ToFile(\"hello.mp4\") fmt.Println(\"download complete\") ","date":"2023-10-09","objectID":"/posts/req/:10:0","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"Cookie é»˜è®¤æƒ…å†µä¸‹ï¼Œåº•å±‚çš„ *http.Client ä¼šè‡ªåŠ¨ç®¡ç†ä½ çš„cookieï¼ˆå¦‚æœæœåŠ¡å™¨ç»™ä½ å‘äº†cookieï¼Œä¹‹åçš„è¯·æ±‚å®ƒä¼šè‡ªåŠ¨å¸¦ä¸Šcookieè¯·æ±‚å¤´ç»™æœåŠ¡å™¨ï¼‰, ä½ å¯ä»¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•å–æ¶ˆè‡ªåŠ¨ç®¡ç†ï¼š req.EnableCookie(false) ä½ è¿˜å¯ä»¥åœ¨å‘é€è¯·æ±‚çš„æ—¶å€™è‡ªå·±ä¼ å…¥ *http.Cookie cookie := new(http.Cookie) // ...... req.Get(url, cookie) ","date":"2023-10-09","objectID":"/posts/req/:11:0","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"è®¾ç½®è¶…æ—¶ req.SetTimeout(50 * time.Second) ","date":"2023-10-09","objectID":"/posts/req/:12:0","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"è®¾ç½®ä»£ç† é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœç³»ç»Ÿç¯å¢ƒå˜é‡æœ‰ http_proxy æˆ– https_proxy ï¼Œreqä¼šè®²å¯¹åº”çš„åœ°å€ä½œä¸ºå¯¹åº”åè®®çš„ä»£ç†ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰è®¾ç½®ä»£ç†ï¼Œæˆ–è€…å°†å…¶ç½®ä¸ºnilï¼Œå³å–æ¶ˆä»£ç†ã€‚ req.SetProxy(func(r *http.Request) (*url.URL, error) { if strings.Contains(r.URL.Hostname(), \"google\") { return url.Parse(\"http://my.vpn.com:23456\") } return nil, nil }) è®¾ç½®ç®€å•ä»£ç†ï¼ˆå°†æ‰€æœ‰è¯·æ±‚éƒ½è½¬å‘åˆ°æŒ‡å®šä»£ç†urlåœ°å€ä¸Šï¼‰ req.SetProxyUrl(\"http://my.proxy.com:23456\") ","date":"2023-10-09","objectID":"/posts/req/:13:0","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go req åº“æ–‡æ¡£"],"content":"è‡ªå®šä¹‰HTTPå®¢æˆ·ç«¯ ä½¿ç”¨ SetClient æ”¹å˜åº•å±‚çš„ *http.Client req.SetClient(client) ç»™æŸä¸ªè¯·æ±‚åˆ¶å®šç‰¹å®šçš„ *http.Client client := \u0026http.Client{Timeout: 30 * time.Second} req.Get(url, client) æ”¹å˜åº•å±‚ *http.Client çš„æŸäº›å±æ€§ req.Client().Jar, _ = cookiejar.New(nil) trans, _ := req.Client().Transport.(*http.Transport) trans.MaxIdleConns = 20 trans.TLSHandshakeTimeout = 20 * time.Second trans.DisableKeepAlives = true trans.TLSClientConfig = \u0026tls.Config{InsecureSkipVerify: true} ","date":"2023-10-09","objectID":"/posts/req/:14:0","tags":["Go","http","req"],"title":"Go Http Client","uri":"/posts/req/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"Go åŸç”Ÿhttpåº“ Goè¯­è¨€å†…ç½®çš„net/httpåŒ…ååˆ†çš„ä¼˜ç§€ï¼Œæä¾›äº†HTTPå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„å®ç°ã€‚ ","date":"2023-10-09","objectID":"/posts/go-http/:0:0","tags":["Go","http"],"title":"Go Http","uri":"/posts/go-http/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"ä¸€ã€net/httpä»‹ç» Goè¯­è¨€å†…ç½®çš„net/httpåŒ…æä¾›äº†HTTPå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„å®ç°ã€‚ HTTPåè®® è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼ˆHTTPï¼ŒHyperText Transfer Protocol)æ˜¯äº’è”ç½‘ä¸Šåº”ç”¨æœ€ä¸ºå¹¿æ³›çš„ä¸€ç§ç½‘ç»œä¼ è¾“åè®®ï¼Œæ‰€æœ‰çš„WWWæ–‡ä»¶éƒ½å¿…é¡»éµå®ˆè¿™ä¸ªæ ‡å‡†ã€‚è®¾è®¡HTTPæœ€åˆçš„ç›®çš„æ˜¯ä¸ºäº†æä¾›ä¸€ç§å‘å¸ƒå’Œæ¥æ”¶HTMLé¡µé¢çš„æ–¹æ³•ã€‚ ","date":"2023-10-09","objectID":"/posts/go-http/:1:0","tags":["Go","http"],"title":"Go Http","uri":"/posts/go-http/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"äºŒã€HTTPå®¢æˆ·ç«¯ Getã€Headã€Postå’ŒPostFormå‡½æ•°å‘å‡ºHTTP/HTTPSè¯·æ±‚ã€‚ resp, err := http.Get(\"http://example.com/\") ... resp, err := http.Post(\"http://example.com/upload\", \"image/jpeg\", \u0026buf) ... resp, err := http.PostForm(\"http://example.com/form\", url.Values{\"key\": {\"Value\"}, \"id\": {\"123\"}}) ç¨‹åºåœ¨ä½¿ç”¨å®Œresponseåå¿…é¡»å…³é—­å›å¤çš„ä¸»ä½“ã€‚ resp, err := http.Get(\"http://example.com/\") if err != nil { // handle error } defer resp.Body.Close() body, err := ioutil.ReadAll(resp.Body) // ... ","date":"2023-10-09","objectID":"/posts/go-http/:2:0","tags":["Go","http"],"title":"Go Http","uri":"/posts/go-http/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"GETè¯·æ±‚ç¤ºä¾‹ package main import ( \"fmt\" \"io\" \"net/http\" ) func main() { resp, err := http.Get(\"https://httpbin.org/uuid\") if err != nil { fmt.Printf(\"get failed, err:%v\\n\", err) return } defer resp.Body.Close() body, err := io.ReadAll(resp.Body) if err != nil { fmt.Printf(\"read from resp.Body failed, err:%v\\n\", err) return } fmt.Print(string(body)) } è‡ªå®šä¹‰è¯·æ±‚ package main import ( \"encoding/json\" \"fmt\" \"io\" \"net/http\" \"net/url\" ) type UUID struct { Uuid string `json:\"uuid\"` } func main() { apiURL := \"https://httpbin.org/uuid\" query := url.Values{} query.Add(\"q\", \"golang\") query.Add(\"page\", \"1\") ApiURL, _ := url.ParseRequestURI(apiURL) ApiURL.RawQuery = query.Encode() req, _ := http.NewRequest(\"GET\", ApiURL.String(), nil) req.Header.Add(\"Accept\", \"*/*\") client := \u0026http.Client{} resp, err := client.Do(req) if err != nil { return } defer resp.Body.Close() var uuid UUID body, err := io.ReadAll(resp.Body) if err != nil { fmt.Printf(\"read from resp.Body failed, err:%v\\n\", err) return } json.Unmarshal(body, \u0026uuid) fmt.Println(uuid.Uuid) } ","date":"2023-10-09","objectID":"/posts/go-http/:2:1","tags":["Go","http"],"title":"Go Http","uri":"/posts/go-http/"},{"categories":["Go åº“æ–‡æ¡£"],"content":"POST è¯·æ±‚ç¤ºä¾‹ package main import ( \"encoding/json\" \"io\" \"net/http\" \"net/url\" ) type dockerToken struct { Token string `json:\"token\"` } func main() { apiUrl := \"https://hub.docker.com/v2/users/login\" data := url.Values{} data.Set(\"username\", \"username\") data.Set(\"password\", \"password\") resp, err := http.PostForm(apiUrl, data) if err != nil { return } defer resp.Body.Close() _data, _ := io.ReadAll(resp.Body) var tmpT dockerToken json.Unmarshal(_data, \u0026tmpT) } package main import ( \"bytes\" \"io\" \"net/http\" \"net/url\" \"strings\" \"log/slog\" ) func POST1() { apiURL := \"https://httpbin.org/post\" form := url.Values{} form.Add(\"ln\", \"ln222\") form.Add(\"ip\", \"1.1.1.1\") form.Add(\"ua\", \"ua123\") client := \u0026http.Client{} req, _ := http.NewRequest(\"POST\", apiURL, strings.NewReader(form.Encode())) req.Header.Set(\"User-Agent\", \"test\") req.Header.Set(\"Content-Type\", \"application/x-www-form-urlencoded\") // å‘é€è¯·æ±‚ resp, err := client.Do(req) if err != nil { slog.Error(\"POST request failed\", \"err\", err) return } defer resp.Body.Close() // è¯»å–å†…å®¹ body, err := io.ReadAll(resp.Body) if err != nil { slog.Error(\"POST request\", \"err\", err) } else { slog.Info(string(body)) } } func POSTJson() { apiURL := \"https://httpbin.org/post\" var jsonStr = []byte(`{\"title\":\"this is a title\", \"cate\": 1}`) client := \u0026http.Client{} req, _ := http.NewRequest(\"POST\", apiURL, bytes.NewBuffer(jsonStr)) req.Header.Set(\"User-Agent\", \"test\") req.Header.Set(\"Content-Type\", \"application/x-www-form-urlencoded\") // å‘é€è¯·æ±‚ resp, err := client.Do(req) if err != nil { slog.Error(\"POST request failed\", \"err\", err) return } defer resp.Body.Close() // è¯»å–å†…å®¹ body, err := io.ReadAll(resp.Body) if err != nil { slog.Error(\"POST request\", \"err\", err) } else { slog.Info(string(body)) } } func main() { // POST1() POSTJson() } ","date":"2023-10-09","objectID":"/posts/go-http/:2:2","tags":["Go","http"],"title":"Go Http","uri":"/posts/go-http/"},{"categories":["Kubernetes","DevOps"],"content":"Dev in kubernetes â€‹ ä¼ ç»Ÿçš„å¼€å‘æ¨¡å¼ä¸­ï¼Œæ˜¯ä»£ç å­˜æ”¾åœ¨æœ¬åœ°ï¼Œä½¿ç”¨ IDE è¿›è¡Œç¼–è¾‘å’Œ debug ã€‚ä½†éšç€å®¹å™¨åŒ–ç«äº†ä¹‹åï¼Œå¾ˆå¤šå•ä¸€æœåŠ¡éƒ½è¿›è¡Œäº†æ‹†åˆ†ï¼Œå¾®æœåŠ¡åŒ–ã€‚åœ¨å¼€å‘é˜¶æ®µï¼Œéœ€è¦æœ¬åœ°åŒæ—¶å¯åŠ¨å¤šä¸ªæœåŠ¡ï¼Œè¿™ä½¿å¾—æœ¬åœ°å¼€å‘è°ƒè¯•å˜å¾—è¶Šæ¥è¶Šå›°éš¾ã€‚Okteto æ˜¯ä¸€ä¸ªé€šè¿‡åœ¨ Kubernetes ä¸­æ¥å¼€å‘å’Œæµ‹è¯•ä»£ç çš„åº”ç”¨ç¨‹åºå¼€å‘å·¥å…·ã€‚å¯ä»¥é€šè¿‡ Okteto åœ¨ Kubernetes ä¸­ä¸€é”®ä¸ºæˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªå¼€å‘ç¯å¢ƒï¼Œéå¸¸ç®€å•æ–¹ä¾¿ã€‚Google æ¨å‡ºçš„ Skaffold åªæ˜¯æŠŠ CICD é›†æˆåˆ°æœ¬åœ°ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿæ¯”è¾ƒå›°éš¾ã€‚Okteto çš„å·¥ä½œåŸç†æ˜¯åœ¨ kubernetes ä¸­å¯åŠ¨ä¸€ä¸ªæœåŠ¡ï¼ŒæŠŠæœ¬åœ°ä»£ç åŒæ­¥åˆ° pod ä¸­ï¼Œç„¶åæ‰§è¡Œå‘½ä»¤è®©æœåŠ¡è¿è¡Œèµ·æ¥ï¼ŒOkteto å¯ä»¥è¿›è¡Œç«¯å£çš„è½¬å‘ï¼Œè½¬å‘podé‡ŒæœåŠ¡çš„ç«¯å£åˆ°æœ¬åœ°ï¼Œåœ¨è¿›è¡Œ debug çš„æ—¶å€™ï¼Œpodé‡Œå¯åŠ¨çš„ç«¯å£å¯ä»¥è¢« kubernetes å†…çš„å…¶ä»–æœåŠ¡æ‰€è®¿é—®ï¼Œæœ¬åœ°è½¬å‘çš„ç«¯å£å¯ä»¥è¢«æœ¬åœ°çš„å·¥å…·ï¼ˆä¾‹å¦‚ postman ï¼‰è®¿é—®ã€‚ oktetoå®˜ç½‘æ–‡æ¡£ï¼šhttps://www.okteto.com/docs Go é…ç½®æ–‡æ¡£ï¼šhttps://www.okteto.com/docs/samples/golang/ ç¤ºä¾‹ç¯å¢ƒï¼š vscode 1.82.1(éœ€è¦å®‰è£… Remote - Kubernetes æ’ä»¶ï¼Œæ’ä»¶codeï¼šokteto.remote-kubernetes) k3d mac ","date":"2023-09-26","objectID":"/posts/okteto/:0:0","tags":["okteto","kubernetes","vscode","dev"],"title":"Okteto","uri":"/posts/okteto/"},{"categories":["Kubernetes","DevOps"],"content":"å®‰è£…ä¸é…ç½® ä¸‹è½½oktetoï¼šhttps://github.com/okteto/okteto/releases [crab@Sugar ~]ğŸ³ wget https://ghproxy.com/https://github.com/okteto/okteto/releases/download/2.20.0/okteto-Darwin-arm64 [crab@Sugar ~]ğŸ³ chmod +x okteto-Darwin-arm64 [crab@Sugar ~]ğŸ³ sudo mv okteto-Darwin-arm64 /usr/local/bin/okteto ","date":"2023-09-26","objectID":"/posts/okteto/:1:0","tags":["okteto","kubernetes","vscode","dev"],"title":"Okteto","uri":"/posts/okteto/"},{"categories":["Kubernetes","DevOps"],"content":"ä¸‹è½½ç¤ºä¾‹ä»£ç  [crab@Sugar ~]ğŸ³ git clone https://github.com/okteto/go-getting-started go-okteto [crab@Sugar ~]ğŸ³ cd go-okteto ","date":"2023-09-26","objectID":"/posts/okteto/:1:1","tags":["okteto","kubernetes","vscode","dev"],"title":"Okteto","uri":"/posts/okteto/"},{"categories":["Kubernetes","DevOps"],"content":"é…ç½®port-forwardç«¯å£ éœ€è¦è½¬å‘ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯æœåŠ¡çš„ç«¯å£ï¼Œå¦ä¸€ä¸ªæ˜¯debugä½¿ç”¨çš„ç«¯å£ okteto.yaml build: hello-world: image: serialt/go-hello-world:1.0.0 context: . deploy: - kubectl apply -f k8s.yml dev: hello-world: # è¢«æ›¿æ¢çš„æœåŠ¡å image: okteto/golang:1 command: bash sync: - .:/usr/src/app volumes: - /go - /root/.cache securityContext: capabilities: add: - SYS_PTRACE forward: - 2345:2345 - 8080:8080 # \u003c---- å¢åŠ 8080æœåŠ¡ç«¯å£è½¬å‘ è®¾ç½®okteto contextï¼Œokteto é»˜è®¤ä¼šä¼˜å…ˆä½¿ç”¨KUBECONFIGç¯å¢ƒå˜é‡çš„é…ç½®æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä½¿ç”¨ ~/.kube/configæ–‡ä»¶ [crab@Sugar go-okteto]ğŸ³ okteto context âœ“ Context 'k3d-mycluster' selected âœ“ Using dev @ k3d-mycluster ","date":"2023-09-26","objectID":"/posts/okteto/:1:2","tags":["okteto","kubernetes","vscode","dev"],"title":"Okteto","uri":"/posts/okteto/"},{"categories":["Kubernetes","DevOps"],"content":"å¯åŠ¨æœåŠ¡ [crab@Sugar go-okteto]ğŸ³ okteto up i Using dev @ k3d-mycluster as context i 'go-getting-started' was already deployed. To redeploy run 'okteto deploy' or 'okteto up --deploy' i Images were already built. To rebuild your images run 'okteto build' or 'okteto deploy --build' âœ“ Images successfully pulled âœ“ Files synchronized Context: k3d-mycluster Namespace: dev Name: hello-world Forward: 2345 -\u003e 2345 8080 -\u003e 8080 Welcome to your development container. Happy coding! dev:hello-world app\u003e dev:hello-world app\u003e ls Dockerfile LICENSE Makefile README.md bashrc go.mod k8s.yml main.go okteto.yml ","date":"2023-09-26","objectID":"/posts/okteto/:1:3","tags":["okteto","kubernetes","vscode","dev"],"title":"Okteto","uri":"/posts/okteto/"},{"categories":["Kubernetes","DevOps"],"content":"è¿œç¨‹å¼€å‘ # oktetoç»ˆç«¯ dev:hello-world app\u003e go run main.go Starting hello-world server... # ç»ˆç«¯æµ‹è¯• [crab@Sugar ~]ğŸ³ curl 127.0.0.1:8080 Hello world! ","date":"2023-09-26","objectID":"/posts/okteto/:1:4","tags":["okteto","kubernetes","vscode","dev"],"title":"Okteto","uri":"/posts/okteto/"},{"categories":["Kubernetes","DevOps"],"content":"è¿œç¨‹è°ƒè¯• # oktetoç»ˆç«¯, æ‰§è¡Œdlvå‘½ä»¤ dev:hello-world app\u003e dlv debug --headless --listen=:2345 --log --api-version=2 API server listening at: [::]:2345 2023-09-26T13:40:51Z warning layer=rpc Listening for remote connections (connections are not authenticated nor encrypted) 2023-09-26T13:40:51Z info layer=debugger launching process with args: [./__debug_bin3213431902] 2023-09-26T13:40:51Z debug layer=debugger Adding target 575 \"/usr/src/app/__debug_bin3213431902\" # main.go æ‰“ä¸Šdebugæ ‡è®° func helloServer(w http.ResponseWriter, r *http.Request) { fmt.Fprint(w, \"Hello world from Okteto!, k3d is great! \") fmt.Println(\"okteto ccccccc\") # æ ‡è®°æ­¤è¡Œ } åœ¨vscode debugä¸­ç‚¹å‡»å¼€å§‹debug ä½¿ç”¨å‘½ä»¤è¯·æ±‚ http://127.0.0.1:8080ï¼Œå³å¯debugåˆ°æ ‡è®°ç‚¹ [sugar@Sugar go-okteto]ğŸ³ curl http://127.0.0.1:8080 Hello world from Okteto!, k3d is great! ","date":"2023-09-26","objectID":"/posts/okteto/:1:5","tags":["okteto","kubernetes","vscode","dev"],"title":"Okteto","uri":"/posts/okteto/"},{"categories":["DevOps"],"content":"æ¸…åé•œåƒç½‘é¡µæ­å»ºé•œåƒç«™ tuna mirror-webåœ°å€ï¼šhttps://github.com/tuna/mirror-web.git tuna mirror-webåŸºäºjekyllå¼€å‘ï¼Œç”±äºrubyç¯å¢ƒå®‰è£…å¤æ‚ï¼Œå› æ­¤é‡‡ç”¨dockerç¼–è¯‘ï¼Œä½†åœ¨buildé•œåƒçš„æ—¶å€™ï¼Œå‡ºç°å®‰è£…åŒ…ä¾èµ–å®‰è£…å¤±è´¥ï¼Œåœ¨å¤šæ¬¡æµ‹è¯•åï¼Œæ— æ³•buildæˆé•œåƒã€‚å‰æ®µæ—¶é—´ï¼Œåœ¨æŸ¥çœ‹mirror-webæ®µissuesæ—¶ï¼Œæœ‰äººè¯¢é—®mirror-webæ®µREADME.mdæ–‡æ¡£çš„ä¸‹ä¸€æ­¥ï¼Œå®˜æ–¹ç»™äº†ä¸€ç‚¹æç¤ºï¼Œæœ‰å…³äºåŸºäºnginxçš„ç¬¬ä¸‰æ–¹æ¨¡å—æ¥å®ç°ç›®å½•ç¬¬æ¸²æŸ“çš„æç¤ºè¯´æ˜ï¼Œå†æ¬¡å°è¯•åï¼Œç»å†å„ç§å›°éš¾å’ŒæŠ˜ç£¨ï¼Œç»ˆäºæ‘¸ç´¢å‡ºã€‚ ","date":"2023-09-24","objectID":"/posts/tuna-web/:1:0","tags":["mirrors"],"title":"Tuna Web","uri":"/posts/tuna-web/"},{"categories":["DevOps"],"content":"1ã€ä¸‹è½½mirror-webçš„jekyllç¼–è¯‘ç¯å¢ƒ tunaçš„ç¼–è¯‘é•œåƒï¼štunathu/mirror-web åœ¨ä¸‹è½½tunathu/mirror-webæ—¶å‘ç”Ÿäº†ä¸€ä¸ªå°é—®é¢˜ï¼Œç”±äºåœ¨å›½å†…ä½¿ç”¨çš„dockeré•œåƒåŠ é€Ÿï¼Œä¸‹è½½çš„é•œåƒæ˜¯æ—§ç‰ˆæœ¬çš„ï¼Œä½†å¢ƒå¤–çš„æœåŠ¡å™¨ä¸‹è½½çš„é•œåƒæ˜¯æœ€æ–°çš„ï¼Œåœ¨è¸©å‘åæœæ–­æ¨åˆ°è‡ªå·±çš„dockerhubä¸Šï¼Œæ–°çš„ä¸‹è½½åœ°å€ï¼šserialt/tuna-mirror-webã€‚ ","date":"2023-09-24","objectID":"/posts/tuna-web/:1:1","tags":["mirrors"],"title":"Tuna Web","uri":"/posts/tuna-web/"},{"categories":["DevOps"],"content":"2ã€ä¸‹è½½githubä»“åº“ git clone https://github.com/tuna/mirror-web.git /opt/mirror-web ","date":"2023-09-24","objectID":"/posts/tuna-web/:1:2","tags":["mirrors"],"title":"Tuna Web","uri":"/posts/tuna-web/"},{"categories":["DevOps"],"content":"3ã€ä¸‹è½½é¢å¤–èµ„æºå’Œç¼–è¯‘ cd /opt/mirror-web wget https://mirrors.tuna.tsinghua.edu.cn/static/tunasync.json -O static/tunasync.json wget https://mirrors.tuna.tsinghua.edu.cn/static/tunet.json -O static/tunet.json mkdir -p static/status wget https://mirrors.tuna.tsinghua.edu.cn/static/status/isoinfo.json -O static/status/isoinfo.json docker run -it -v /opt/mirror-web/:/data serialt/tuna-mirror-web:20211006 ç¼–è¯‘çš„åé™æ€æ–‡ä»¶åœ¨_siteé‡Œ ","date":"2023-09-24","objectID":"/posts/tuna-web/:1:3","tags":["mirrors"],"title":"Tuna Web","uri":"/posts/tuna-web/"},{"categories":["DevOps"],"content":"4ã€ç¼–è¯‘nginx éœ€è¦å®‰è£…ç¬¬ä¸‰æ–¹æ¨¡å— modules/ngx_http_js_module.so modules/ngx_http_fancyindex_module.so [root@serialt nginx]# ll æ€»ç”¨é‡ 1068 drwxr-xr-x 9 sonar sonar 186 10æœˆ 5 22:27 nginx-1.20.1 -rw-r--r-- 1 root root 1061461 5æœˆ 25 23:34 nginx-1.20.1.tar.gz drwxrwxr-x 3 root root 217 10æœˆ 27 2020 ngx-fancyindex-0.5.1 -rw-r--r-- 1 root root 25148 10æœˆ 27 2020 ngx-fancyindex-0.5.1.tar.xz drwxr-xr-x 10 root root 228 10æœˆ 6 15:49 njs # njsä¸‹è½½ git clone https://github.com/nginx/njs # ngx-fancyindex ä¸‹è½½ wget https://github.com/aperezdc/ngx-fancyindex/releases/download/v0.5.1/ngx-fancyindex-0.5.1.tar.xz ç¼–è¯‘ï¼š [root@serialt nginx]# ls nginx-1.20.1 nginx-1.20.1.tar.gz ngx-fancyindex-0.5.1 ngx-fancyindex-0.5.1.tar.xz njs [root@serialt nginx]# cd nginx-1.20.1/ [root@serialt nginx-1.20.1]# ./configure --prefix=/usr/local/nginx --with-pcre --with-http_auth_request_module --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_stub_status_module --with-mail --with-mail_ssl_module --with-stream --with-stream_ssl_module --with-stream_realip_module --add-dynamic-module=/root/nginx/ngx-fancyindex-0.5.1 --add-dynamic-module=/root/nginx/njs/nginx # add m 3997 [2022-02-25 00:49:21] [root] [10.5.0.10] ./configure --with-compat --add-dynamic-module=/root/github/tuna-mirror-web/njs-0.6.2/nginx 3998 [2022-02-25 00:49:31] [root] [10.5.0.10] make modules nginxé…ç½®æ–‡ä»¶å†…å®¹ [root@serialt mirrors]# cat /usr/local/nginx/conf/nginx.conf #user nobody; worker_processes 1; #error_log logs/error.log; #error_log logs/error.log notice; #error_log logs/error.log info; #pid logs/nginx.pid; load_module modules/ngx_http_js_module.so; load_module modules/ngx_http_fancyindex_module.so; events { worker_connections 1024; } http { include mime.types; default_type application/octet-stream; #log_format main '$remote_addr - $remote_user [$time_local] \"$request\" ' # '$status $body_bytes_sent \"$http_referer\" ' # '\"$http_user_agent\" \"$http_x_forwarded_for\"'; #access_log logs/access.log main; sendfile on; #tcp_nopush on; #keepalive_timeout 0; keepalive_timeout 65; #gzip on; map $http_user_agent $isbrowser { default 0; \"~*validation server\" 0; \"~*mozilla\" 1; } js_path /opt/mirror-web/_site/static/njs; js_include /opt/mirror-web/_site/static/njs/all.njs; #js_path /opt/mirror-web/static/njs; #js_include /opt/mirror-web/static/njs/all.njs; server { listen 8007; server_name localhost; #charset koi8-r; #access_log logs/host.access.log main; #root /opt/mirror-web/_site; fancyindex_header /fancy-index/before; fancyindex_footer /fancy-index/after; fancyindex_exact_size off; fancyindex_time_format \"%d %b %Y %H:%M:%S +0000\"; fancyindex_name_length 256; error_page 404 /404.html; location /fancy-index { internal; root /opt/mirror-web/_site; subrequest_output_buffer_size 100k; location = /fancy-index/before { js_content fancyIndexBeforeRender; } location = /fancy-index/after { js_content fancyIndexAfterRender; } } location / { root /opt/mirror-web/_site; index index.html index.htm; #try_files /_site/$uri $uri/ /_site/$uri; fancyindex on; } # location / { # root html; # index index.html index.htm; # } #error_page 404 /404.html; # redirect server error pages to the static page /50x.html # error_page 500 502 503 504 /50x.html; location = /50x.html { root html; } } } [root@serialt mirrors]# ","date":"2023-09-24","objectID":"/posts/tuna-web/:1:4","tags":["mirrors"],"title":"Tuna Web","uri":"/posts/tuna-web/"},{"categories":["DevOps"],"content":"5ã€é•œåƒèµ„æºæš´éœ² æ–¹æ³•1ï¼šä»¥è½¯é“¾æ¥å½¢å¼å­˜æ”¾åœ¨/opt/mirror-web/_siteä¸­ [root@serialt _site]# pwd /opt/mirror-web/_site [root@serialt _site]# ll æ€»ç”¨é‡ 160 -rw-r--r-- 1 root root 16415 10æœˆ 6 15:37 404.html drwxr-xr-x 2 root root 6 10æœˆ 6 17:14 cc drwxr-xr-x 2 root root 19 10æœˆ 6 17:14 centos drwxr-xr-x 2 root root 94 10æœˆ 6 09:25 fancy-index -rw-r--r-- 1 root root 36650 10æœˆ 6 15:37 feed.xml drwxr-xr-x 103 root root 4096 10æœˆ 6 09:25 help -rw-r--r-- 1 root root 27679 10æœˆ 6 15:37 index.html -rw-r--r-- 1 root root 20728 10æœˆ 6 15:37 legacy_index.html -rw-r--r-- 1 root root 18092 10æœˆ 6 15:37 LICENSE drwxr-xr-x 47 root root 4096 10æœˆ 6 09:25 news -rw-r--r-- 1 root root 58 10æœˆ 6 15:37 robots.txt -rw-r--r-- 1 root root 19134 10æœˆ 6 15:37 sitemap.xml drwxr-xr-x 8 root root 115 10æœˆ 6 15:37 static drwxr-xr-x 2 root root 24 10æœˆ 6 09:25 status æ–¹æ³•äºŒï¼šæŠŠ/opt/mirror-web/_siteé‡Œçš„æ–‡ä»¶ä»¥è½¯é“¾æ¥çš„æ–¹å¼é“¾æ¥åˆ°é•œåƒçš„è·Ÿç›®å½•ï¼ˆå»ºè®®ä½¿ç”¨ï¼‰ ln -snf /opt/mirror-web/_site/* /opt/imau ç›®å½•æè¿°æ–‡ä»¶ï¼š_data/options.yml ç«™ç‚¹èµ„æºæ˜¾ç¤ºæ§åˆ¶ï¼šstatic/tunasync.json tunasync.json [ { \"name\": \"ant\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"book\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"centos\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"dev\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"frp\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"git\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"go\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"grafana\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"iso\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"jdk\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"jmeter\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"kubernetes\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"mac\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"monitor\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"node\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"root-ca\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"other\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"printer\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"prometheus\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"pycharm\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"python\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"repo\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"script\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"test\", \"is_master\": true, \"status\": \"success\" }, { \"name\": \"tool\", \"is_master\": true, \"status\": \"success\" } ] \"last_update\": \"2022-01-11 16:39:37 +0800\", \"last_update_ts\": 1641890377, \"last_started\": \"2022-01-11 16:39:21 +0800\", \"last_started_ts\": 1641890361, \"last_ended\": \"2022-01-11 16:39:37 +0800\", \"last_ended_ts\": 1641890377, \"next_schedule\": \"2022-01-11 22:39:37 +0800\", \"next_schedule_ts\": 1641911977, \"upstream\": \"rsync://msync.centos.org/CentOS/\", - status: 'success' last_update: '-' name: \"AUR\" url: 'https://aur.tuna.tsinghua.edu.cn/' upstream: 'https://aur.archlinux.org/' is_master: true options.yml # Content Related mirror_desc: - name: git desc: git äºŒè¿›åˆ¶ç¼–è¯‘ç‰ˆæœ¬ - name: go desc: golang å¼€å‘ç¯å¢ƒ - name: grafana desc: grafana çš„å®‰è£…åŒ… - name: helm desc: helm çš„äºŒè¿›åˆ¶å‘è¡ŒåŒ… - name: ios desc: é•œåƒæ–‡ä»¶ï¼Œå¦‚centos, ubuntu, rockyç­‰ - name: jdk desc: java å¼€å‘ç¯å¢ƒå®‰è£…åŒ… new_mirrors: - hugging-face-models - endeavouros - ubuntukylin - putty - postmarketOS - postmarketOS-images - obs-studio - stellarium unlisted_mirrors: - status: 'success' last_update: '-' name: \"AUR\" url: 'https://aur.tuna.tsinghua.edu.cn/' upstream: 'https://aur.archlinux.org/' is_master: true - link_to: 'osdn' name: \"manjaro-cd\" url: '/osdn/storage/g/m/ma/manjaro/' - link_to: 'osdn' name: \"manjaro-arm-cd\" url: '/osdn/storage/g/m/ma/manjaro-arm/' - link_to: 'osdn' name: \"mxlinux-isos\" url: '/osdn/storage/g/m/mx/mx-linux/ISOs/' - link_to: 'osdn' name: \"garuda-linux\" url: '/osdn/storage/g/g/ga/garuda-linux/' - link_to: 'osdn' name: \"linuxlite-cd\" url: '/osdn/storage/g/l/li/linuxlite/' - link_to: 'github-release' name: \"prometheus\" url: '/github-rele","date":"2023-09-24","objectID":"/posts/tuna-web/:1:5","tags":["mirrors"],"title":"Tuna Web","uri":"/posts/tuna-web/"},{"categories":["DevOps"],"content":"6ã€dockeré•œåƒä½¿ç”¨ é™æ€æ–‡ä»¶ç¼–è¯‘ æ„å»º Jekyll çš„ docker é•œåƒç¯å¢ƒå¤æ‚ï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨å®˜æ–¹æˆ–è€…å·²ç»å­˜åœ¨çš„é•œåƒtunathu/mirror-webæˆ–è€…serialt/tuna-mirror-web [root@tc ~]# docker run -it -v /path/to/mirror-web/:/data serialt/tuna-mirror-web ä¸€äº›åŠ¨æ€æ•°æ®å·²ç»ä¸‹è½½ï¼Œè‹¥éœ€è¦æœ€æ–°çš„ï¼Œå¯ä»¥å°±è¡Œä»¥ä¸‹æ“ä½œ,ç„¶ååœ¨æ„å»º ä¸‹è½½æœ€æ–°çš„åŠ¨æ€æ•°æ®æ–‡ä»¶ wget https://mirrors.tuna.tsinghua.edu.cn/static/tunasync.json -O static/tunasync.json wget https://mirrors.tuna.tsinghua.edu.cn/static/tunet.json -O static/tunet.json mkdir -p static/status wget https://mirrors.tuna.tsinghua.edu.cn/static/status/isoinfo.json -O static/status/isoinfo.json è¿è¡ŒæœåŠ¡ dockeré•œåƒç½‘é¡µæ ¹ç›®å½•: /opt/mirror-web é•œåƒç«™èµ„æºæ ¹ç›®å½•: /opt/mirror å¯åŠ¨æœåŠ¡ docker run -tid -v /opt/tuna-mirror-web/_site:/opt/mirror-web -v /opt/mirror:/opt/mirror -p 8099:80 --name=tuna-mirror-nginx serialt/tuna-mirror-web-nginx:7b0c89d version: \"3\" networks: tuna-mirror-nginx: external: false services: tuna-mirror-nginx: image: serialt/tuna-mirror-web-nginx:latest container_name: mirror-nginx hostname: mirror-nginx restart: always networks: - tuna-mirror-nginx volumes: - \"/etc/localtime:/etc/localtime:ro\" - \"/opt/mirror-web/_site:/opt/mirror-web\" - \"/opt/mirror:/opt/mirror\" ports: - \"80:80\" dns: - 223.5.5.5 - 223.6.6.6 ","date":"2023-09-24","objectID":"/posts/tuna-web/:1:6","tags":["mirrors"],"title":"Tuna Web","uri":"/posts/tuna-web/"},{"categories":["DevOps"],"content":"æ–°é•œåƒç«™ç‰ˆæœ¬å‘å¸ƒ docker run -it --rm -v /opt/tuna-mirror-web:/data serialt/tuna-mirror-web docker restart tuna-mirror-nginx ","date":"2023-09-24","objectID":"/posts/tuna-web/:1:7","tags":["mirrors"],"title":"Tuna Web","uri":"/posts/tuna-web/"},{"categories":["DevOps"],"content":"ç¼–å†™è¯´æ˜ _data/options.yml: æ˜¯æ˜¾ç¤ºåœ¨é•œåƒç«™ä¸»é¡µå¯¹å„ä¸ªç›®å½•çš„è¯´æ˜ static/tunasync.json: æ˜¯å¯¹å½“å‰repoçš„åŒæ­¥ä¿¡æ¯çš„æè¿°ï¼Œå¯ä»¥è‡ªè¡Œç¼–è¾‘ï¼Œä¹Ÿå¯ä»¥ä»tunaä¸Šä¸‹è½½ help: helpç›®å½•é‡Œå­˜æœ‰å„ä¸ªrepoçš„å¸®åŠ©ä¿¡æ¯ï¼Œåœ¨ä¸»é¡µä¸Šä¼šæ˜¾ç¤ºæœ‰ä¸ª\"?\" news: é•œåƒç«™çš„æ–°é—»ä¿¡æ¯ ","date":"2023-09-24","objectID":"/posts/tuna-web/:1:8","tags":["mirrors"],"title":"Tuna Web","uri":"/posts/tuna-web/"},{"categories":["DevOps"],"content":"help è¯´æ˜ permalink æ˜¯è¡¨ç¤ºhelpçš„é¦–é¡µçš„è·¯å¾„ï¼Œå¿…é¡»è¦æœ‰ --- layout: help category: help mirrorid: app permalink: /help/app/ --- ","date":"2023-09-24","objectID":"/posts/tuna-web/:1:9","tags":["mirrors"],"title":"Tuna Web","uri":"/posts/tuna-web/"},{"categories":["Kubernetes","DevOps"],"content":"helm oci ","date":"2023-09-24","objectID":"/posts/helm-migrate-oci/:1:0","tags":["helm"],"title":"Helm Migrate OCI","uri":"/posts/helm-migrate-oci/"},{"categories":["Kubernetes","DevOps"],"content":"ç¼˜ç”± Helm 3.8 ç‰ˆæœ¬å¼€å§‹ï¼Œæ”¯æŒä½¿ç”¨ociè¿›è¡Œå­˜å‚¨chartã€‚é•œåƒå­˜å‚¨å¸¸ç”¨çš„Harboråœ¨v1.6ç‰ˆæœ¬å¼€å§‹æ”¯æŒHelm Chartä»“åº“åŠŸèƒ½ï¼Œ chartä»“åº“ç”±chartmuseumä»¥æ’ä»¶çš„æ–¹å¼æä¾›ã€‚éšç€å…¼å®¹OCIè§„èŒƒçš„Helm Chartåœ¨ç¤¾åŒºä¸Šè¢«æ›´å¹¿æ³›åœ°æ¥å—ï¼ŒHelm Chartèƒ½ä»¥Artifactçš„å½¢å¼åœ¨Harborä¸­å­˜å‚¨å’Œç®¡ç†ï¼Œä¸å†ä¾èµ–ChartMuseumï¼Œå› æ­¤Harboråœ¨v2.8.0ç‰ˆæœ¬ä¸­ï¼Œç§»é™¤å¯¹ChartMuseumçš„æ”¯æŒã€‚ ","date":"2023-09-24","objectID":"/posts/helm-migrate-oci/:1:1","tags":["helm"],"title":"Helm Migrate OCI","uri":"/posts/helm-migrate-oci/"},{"categories":["Kubernetes","DevOps"],"content":"registry ä»“åº“ä½¿ç”¨ åŸºæœ¬ä½¿ç”¨ ### registry # ç™»å½• helm registry login -u serialt docker.io # æ³¨é”€ helm registry logout docker.io # pull chart helm fetch oci://docker.io/serialt/loki-stack --version=2.9.11 # push chart helm push loki-stack-2.9.11.tgz oci://docker.io/serialt ociæ”¯æŒçš„å…¶ä»–å‘½ä»¤ helm pull helm show helm template helm install helm upgrade $ helm pull oci://localhost:5000/helm-charts/mychart --version 0.1.0 Pulled: localhost:5000/helm-charts/mychart:0.1.0 Digest: sha256:0be7ec9fb7b962b46d81e4bb74fdcdb7089d965d3baca9f85d64948b05b402ff $ helm show all oci://localhost:5000/helm-charts/mychart --version 0.1.0 apiVersion: v2 appVersion: 1.16.0 description: A Helm chart for Kubernetes name: mychart ... $ helm template myrelease oci://localhost:5000/helm-charts/mychart --version 0.1.0 --- # Source: mychart/templates/serviceaccount.yaml apiVersion: v1 kind: ServiceAccount ... $ helm install myrelease oci://localhost:5000/helm-charts/mychart --version 0.1.0 NAME: myrelease LAST DEPLOYED: Wed Oct 27 15:11:40 2021 NAMESPACE: default STATUS: deployed REVISION: 1 NOTES: ... $ helm upgrade myrelease oci://localhost:5000/helm-charts/mychart --version 0.2.0 Release \"myrelease\" has been upgraded. Happy Helming! NAME: myrelease LAST DEPLOYED: Wed Oct 27 15:12:05 2021 NAMESPACE: default STATUS: deployed REVISION: 2 NOTES: ... ","date":"2023-09-24","objectID":"/posts/helm-migrate-oci/:1:2","tags":["helm"],"title":"Helm Migrate OCI","uri":"/posts/helm-migrate-oci/"},{"categories":["Kubernetes","DevOps"],"content":"è¿ç§» chart repo åˆ° oci ä»“åº“ åŸºäº github action é•œåƒ helm repo ä»“åº“åˆ° docker hubï¼Œä»¥åŠ é€Ÿ helm repo åˆ°è®¿é—®ã€‚ migrate-chart ","date":"2023-09-24","objectID":"/posts/helm-migrate-oci/:1:3","tags":["helm"],"title":"Helm Migrate OCI","uri":"/posts/helm-migrate-oci/"},{"categories":null,"content":"ccd ip ä½¿ç”¨ openvpné…ç½®å®¢æˆ·ç«¯é™æ€IP 1ï¼‰åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ªç›®å½• cd /etc/openvpn # server.conf client-config-dir ccd 2ï¼‰åˆ›å»ºç›®å½• mkdir -p /etc/openvpn/ccd 3ï¼‰åˆ›å»ºæ–‡ä»¶é…ç½®å®¢æˆ·ç«¯IP è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œåˆ›å»ºçš„è¿™ä¸ªæ–‡ä»¶å°±æ˜¯ç”¨ä½ çš„ç”¨æˆ·åï¼Œæ¯”å¦‚è¿™é‡Œæˆ‘çš„ç”¨æˆ·åæ˜¯liaoï¼Œé‚£ä¹ˆåˆ›å»ºçš„æ–‡ä»¶ä¹Ÿæ˜¯liao touch /etc/openvpn/ccd/liao å†…å®¹å†™å…¥ï¼Œifconfig-pushä¸­çš„æ¯ä¸€å¯¹IPåœ°å€è¡¨ç¤ºè™šæ‹Ÿå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„IPç«¯ç‚¹ echo â€œifconfig-push 10.8.0.5 10.8.0.6â€ \u003e /etc/openvpn/ccd/liao æ³¨æ„ï¼šè¿™é‡Œåˆ†é…çš„IPè§„åˆ™å¦‚ä¸‹ # ifconfig-pushä¸­çš„æ¯ä¸€å¯¹IPåœ°å€è¡¨ç¤ºè™šæ‹Ÿå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„IPç«¯ç‚¹ # å®ƒä»¬å¿…é¡»ä»è¿ç»­çš„/30å­ç½‘ç½‘æ®µä¸­è·å–(è¿™é‡Œæ˜¯/30è¡¨ç¤ºxxx.xxx.xxx.xxx/30ï¼Œå³å­ç½‘æ©ç ä½æ•°ä¸º30) # ä»¥ä¾¿äºä¸Windowså®¢æˆ·ç«¯å’ŒTAP-Windowsé©±åŠ¨å…¼å®¹ã€‚æ˜ç¡®åœ°è¯´ï¼Œæ¯ä¸ªç«¯ç‚¹çš„IPåœ°å€å¯¹çš„æœ€å8ä½å­—èŠ‚å¿…é¡»å–è‡ªä¸‹é¢çš„é›†åˆï¼š [ 1, 2] [ 5, 6] [ 9, 10] [ 13, 14] [ 17, 18] [ 21, 22] [ 25, 26] [ 29, 30] [ 33, 34] [ 37, 38] [ 41, 42] [ 45, 46] [ 49, 50] [ 53, 54] [ 57, 58] [ 61, 62] [ 65, 66] [ 69, 70] [ 73, 74] [ 77, 78] [ 81, 82] [ 85, 86] [ 89, 90] [ 93, 94] [ 97, 98] [101,102] [105,106] [109,110] [113,114] [117,118] [121,122] [125,126] [129,130] [133,134] [137,138] [141,142] [145,146] [149,150] [153,154] [157,158] [161,162] [165,166] [169,170] [173,174] [177,178] [181,182] [185,186] [189,190] [193,194] [197,198] [201,202] [205,206] [209,210] [213,214] [217,218] [221,222] [225,226] [229,230] [233,234] [237,238] [241,242] [245,246] [249,250] [253,254] 4ï¼‰é‡å¯ç”Ÿæ•ˆ systemctl restart openvpn@server æ€»ç»“ï¼šè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯åˆ†é…é™æ€IPçš„æ—¶å€™éœ€è¦å‚è€ƒæ–‡ç« ä¸­çš„æ³¨æ„ç‚¹ï¼ŒæŒ‰å¯¹åº”åˆ†é…å¦åˆ™ä¼šå‡ºç°å…¼å®¹é—®é¢˜æˆ–è€…è¿æ¥ä¸ä¸Šæƒ…å†µ ","date":"0001-01-01","objectID":"/posts/2024-06-13-openvpn/:0:1","tags":null,"title":"","uri":"/posts/2024-06-13-openvpn/"},{"categories":null,"content":"Task æ˜¯ä¸€ä¸ªä»»åŠ¡è¿è¡Œå™¨/æ„å»ºå·¥å…·ï¼Œæ—¨åœ¨æ¯” GNU Make ç­‰æ›´ç®€å•æ˜“ç”¨ã€‚ ç”±äºå®ƒæ˜¯ç”¨ Go ç¼–å†™çš„ï¼ŒTask åªæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ²¡æœ‰å…¶ä»–ä¾èµ–é¡¹ï¼Œè¿™æ„å‘³ç€æ‚¨ä¸éœ€è¦ä¸ºäº†ä½¿ç”¨æ„å»ºå·¥å…·è€Œçƒ¦æ¼ä»»ä½•å¤æ‚çš„å®‰è£…è®¾ç½®ã€‚ å®‰è£… åï¼Œæ‚¨åªéœ€åœ¨åä¸º Taskfile.yml çš„æ–‡ä»¶ä¸­ä½¿ç”¨ç®€å•çš„ YAML è§„åˆ™æè¿°æ‚¨çš„æ„å»ºä»»åŠ¡ï¼š task æ”¯æŒå‘æ–‡ä»¶åç§° Taskfile.yml taskfile.yml Taskfile.yaml taskfile.yaml Taskfile.dist.yml taskfile.dist.yml Taskfile.dist.yaml taskfile.dist.yaml ç¤ºä¾‹ï¼š version: '3' vars: PROJECT_NAME: cli BRANCH: sh: git symbolic-ref HEAD 2\u003e/dev/null | cut -d\"/\" -f 3 VERSION: \"{{ .BRANCH }}\" # è·å–æœ€æ–°çš„tag # sh: git fetch --tags \u0026\u0026 git tag | sort -V | tail -1 APP_NAME: \"{{ .PROJECT_NAME }}\" GIT_COMMIT: # çŸ­hash # sh: git log -n 1 --format=%h # é•¿hash sh: git rev-parse HEAD GoVersion: sh: go version | cut -d \" \" -f 3 BuildTime: '{{now | date \"Mon Jan 02 15:04:05 SGT 2006\"}}' Maintainer: tserialt@gmail.com PKGFLAGS: \" -s -w -X 'main.APPVersion={{ .VERSION }}' -X 'main.GoVersion={{ .GoVersion }}' -X 'main.BuildTime={{ .BuildTime }}' -X 'main.GitCommit={{ .GIT_COMMIT }}' \" tasks: clean: cmds: - rm -rf dist/{{ .PROJECT_NAME }}* run: cmds: - go run . build: cmds: - go build -trimpath -ldflags \"{{ .PKGFLAGS }}\" -o \"dist/{{ .APP_NAME }}\" build-linux: vars: OS_TYPE: linux cmds: - GOOS=\"{{ .OS_TYPE }}\" GOARCH=\"amd64\" go build -trimpath -ldflags \"{{ .PKGFLAGS }}\" -v -o \"dist/{{ .APP_NAME }}-{{ .OS_TYPE }}-amd64\" - GOOS=\"{{ .OS_TYPE }}\" GOARCH=\"arm64\" go build -trimpath -ldflags \"{{ .PKGFLAGS }}\" -v -o \"dist/{{ .APP_NAME }}-{{ .OS_TYPE }}-arm64\" build-mac: vars: OS_TYPE: darwin cmds: - GOOS=\"{{ .OS_TYPE }}\" GOARCH=\"amd64\" go build -trimpath -ldflags \"{{ .PKGFLAGS }}\" -v -o \"dist/{{ .APP_NAME }}-{{ .OS_TYPE }}-amd64\" - GOOS=\"{{ .OS_TYPE }}\" GOARCH=\"arm64\" go build -trimpath -ldflags \"{{ .PKGFLAGS }}\" -v -o \"dist/{{ .APP_NAME }}-{{ .OS_TYPE }}-arm64\" build-win: vars: OS_TYPE: windows cmds: - GOOS=\"{{ .OS_TYPE }}\" GOARCH=\"amd64\" go build -trimpath -ldflags \"{{ .PKGFLAGS }}\" -v -o \"dist/{{ .APP_NAME }}-{{ .OS_TYPE }}-amd64.exe\" release: cmds: - task: build-linux - task: build-mac - task: build-win - task: banner banner: cmds: - cmd: echo -e \"\\n******************************\\n\\n build succeed \\n\\n******************************\\n\" silent: true default: deps: [clean] cmds: - task: build - task: banner ","date":"0001-01-01","objectID":"/posts/2024-06-14-taskfile/:0:0","tags":null,"title":"","uri":"/posts/2024-06-14-taskfile/"},{"categories":null,"content":"å®‰å“SDK å®‰è£…å’Œé…ç½® # https://developer.android.com/studio?hl=zh-cn # å›½å†…ä¸‹è½½åœ°å€ # https://developer.android.google.cn/studio?hl=zh-cn ä¸‹è½½ commandlinetools https://cloud.tencent.com/developer/article/2188266 ","date":"0001-01-01","objectID":"/posts/2025-01-05-android/:0:1","tags":null,"title":"","uri":"/posts/2025-01-05-android/"}]