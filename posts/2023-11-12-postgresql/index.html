<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>postgresql - Blog</title><meta name="Description" content="This is my cool site"><meta property="og:title" content="postgresql" />
<meta property="og:description" content="PostgreSQL 一、安装 docker 安装 # docker-compose.yaml version: &#34;3&#34; services: postgres10-5432: image: &#34;postgres:10-bullseye&#34; container_name: postgres10-5432 shm_size: &#34;1gb&#34; restart: always ports: - &#34;5432:5432&#34; volumes: - /data/postgresql:/var/lib/postgresql/data - $PWD/init.sql:/docker-entrypoint-initdb.d/init.sql environment: - POSTGRES_PASSWORD=xxxxxxxxxxx # init.sql CREATE USER db_user WITH CREATEDB ENCRYPTED PASSWORD &#39;xxxxxxxxxx&#39;; alter user db_user superuser; mac ### install # 安装指定版本需要加@,例如 @14 brew install postgresql@14 # 查" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://serialt.github.io/posts/2023-11-12-postgresql/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-08-11T11:30:27+08:00" />
<meta property="article:modified_time" content="2024-08-11T11:30:27+08:00" /><meta property="og:site_name" content="Log" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="postgresql"/>
<meta name="twitter:description" content="PostgreSQL 一、安装 docker 安装 # docker-compose.yaml version: &#34;3&#34; services: postgres10-5432: image: &#34;postgres:10-bullseye&#34; container_name: postgres10-5432 shm_size: &#34;1gb&#34; restart: always ports: - &#34;5432:5432&#34; volumes: - /data/postgresql:/var/lib/postgresql/data - $PWD/init.sql:/docker-entrypoint-initdb.d/init.sql environment: - POSTGRES_PASSWORD=xxxxxxxxxxx # init.sql CREATE USER db_user WITH CREATEDB ENCRYPTED PASSWORD &#39;xxxxxxxxxx&#39;; alter user db_user superuser; mac ### install # 安装指定版本需要加@,例如 @14 brew install postgresql@14 # 查"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://serialt.github.io/posts/2023-11-12-postgresql/" /><link rel="prev" href="https://serialt.github.io/posts/2023-11-11-go-basic/" /><link rel="next" href="https://serialt.github.io/posts/2024-08-11-containerd-exit/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "postgresql",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/serialt.github.io\/posts\/2023-11-12-postgresql\/"
        },"genre": "posts","keywords": "pg, postgresql, db","wordcount":  2715 ,
        "url": "https:\/\/serialt.github.io\/posts\/2023-11-12-postgresql\/","datePublished": "2024-08-11T11:30:27+08:00","dateModified": "2024-08-11T11:30:27+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "serialt"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Blog">记录</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Blog">记录</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">postgresql</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>serialt</a></span>&nbsp;<span class="post-category">included in <a href="/categories/database/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Database</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2024-08-11">2024-08-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;2715 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;6 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#一安装">一、安装</a></li>
    <li><a href="#二配置">二、配置</a>
      <ul>
        <li><a href="#1修改数据库时区">1、修改数据库时区</a></li>
        <li><a href="#2sql使用">2、sql使用</a></li>
      </ul>
    </li>
    <li><a href="#三从库配置">三、从库配置</a>
      <ul>
        <li><a href="#1配置postgresql主节点">1、配置PostgreSQL主节点</a></li>
        <li><a href="#2从节点上操作">2、从节点上操作</a></li>
        <li><a href="#3验证">3、验证</a></li>
        <li><a href="#4查看主从延迟">4、查看主从延迟</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="postgresql">PostgreSQL</h1>
<h2 id="一安装">一、安装</h2>
<p>docker 安装</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="c"># docker-compose.yaml</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>version: <span class="s2">&#34;3&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>services:<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  postgres10-5432:<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    image: <span class="s2">&#34;postgres:10-bullseye&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    container_name: postgres10-5432<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    shm_size: <span class="s2">&#34;1gb&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    restart: always<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    ports:<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>      - <span class="s2">&#34;5432:5432&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    volumes:<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>      - /data/postgresql:/var/lib/postgresql/data<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>      - <span class="nv">$PWD</span>/init.sql:/docker-entrypoint-initdb.d/init.sql<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    environment:<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>      - <span class="nv">POSTGRES_PASSWORD</span><span class="o">=</span>xxxxxxxxxxx<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># init.sql</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>CREATE USER db_user WITH CREATEDB ENCRYPTED PASSWORD <span class="s1">&#39;xxxxxxxxxx&#39;</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>alter user db_user superuser<span class="p">;</span><span class="err">
</span></span></span></code></pre></div><p>mac</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">### install </span>
</span></span><span class="line"><span class="cl"><span class="c1"># 安装指定版本需要加@,例如 @14</span>
</span></span><span class="line"><span class="cl">brew install postgresql@14
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看安装的包</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>localhost@Sugar ~<span class="o">]</span>🐳 brew <span class="nv">list</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; Formulae
</span></span><span class="line"><span class="cl">icu4c		openssl@1.1	postgresql@10	readline
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看包安装的位置</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>localhost@Sugar ~<span class="o">]</span>🐳 brew list postgresql@14
</span></span><span class="line"><span class="cl">/opt/homebrew/Cellar/postgresql@14/14.12/bin/clusterdb
</span></span><span class="line"><span class="cl">/opt/homebrew/Cellar/postgresql@14/14.12/bin/createdb
</span></span><span class="line"><span class="cl">/opt/homebrew/Cellar/postgresql@14/14.12/bin/createuser
</span></span><span class="line"><span class="cl">/opt/homebrew/Cellar/postgresql@14/14.12/bin/dropdb
</span></span><span class="line"><span class="cl">/opt/homebrew/Cellar/postgresql@14/14.12/bin/dropuser
</span></span><span class="line"><span class="cl">/opt/homebrew/Cellar/postgresql@14/14.12/bin/ecpg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 配置环境变量</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PG_HOME</span><span class="o">=</span><span class="s2">&#34;/opt/homebrew/opt/postgresql@14&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PG_HOME</span>/bin:<span class="nv">$PATH</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 加载环境变量</span>
</span></span><span class="line"><span class="cl"><span class="nb">source</span> ~/.bash_profile
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 初始化数据库</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 查看版本</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>localhost@Sugar ~<span class="o">]</span>🐳 pg_ctl -V
</span></span><span class="line"><span class="cl">pg_ctl <span class="o">(</span>PostgreSQL<span class="o">)</span> 14.12 <span class="o">(</span>Homebrew<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 初始化数据库</span>
</span></span><span class="line"><span class="cl">initdb --locale<span class="o">=</span>C -E UTF-8 /opt/homebrew/var/postgresql@14
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 启动服务</span>
</span></span><span class="line"><span class="cl">brew services start postgresql@14
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 停止服务</span>
</span></span><span class="line"><span class="cl">brew services start postgresql@14
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 非后台启动</span>
</span></span><span class="line"><span class="cl">/opt/homebrew/opt/postgresql@14/bin/postgres -D /opt/homebrew/var/postgresql@14
</span></span></code></pre></div><h2 id="二配置">二、配置</h2>
<h3 id="1修改数据库时区">1、修改数据库时区</h3>
<pre tabindex="0"><code>postgres=# show timezone;
 TimeZone 
----------
 Etc/UTC
(1 row)


sed -i &#34;s+timezone = &#39;Etc/UTC&#39;+timezone = &#39;Asia/Shanghai&#34; postgresql.conf
sed -i &#34;s+log_timezone = &#39;Etc/UTC&#39;+log_timezone = &#39;Asia/Shanghai&#39;&#34; postgresql.conf


postgres=# select pg_reload_conf();
 pg_reload_conf 
----------------
 t
(1 row)


postgres=# show timezone;
   TimeZone    
---------------
 Asia/Shanghai
(1 row)
</code></pre><h3 id="2sql使用">2、sql使用</h3>
<p>查询数据库大小：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="n">datname</span><span class="p">,</span><span class="w"> </span><span class="n">pg_size_pretty</span><span class="w"> </span><span class="p">(</span><span class="n">pg_database_size</span><span class="p">(</span><span class="n">datname</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">pg_database</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">size</span><span class="p">;</span><span class="w"> 
</span></span></span></code></pre></div><p>查看表大小</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">--数据库中单个表的大小（不包含索引）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_relation_size</span><span class="p">(</span><span class="s1">&#39;表名&#39;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--查出所有表（包含索引）并排序
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">table_schema</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">table_full_name</span><span class="p">,</span><span class="w"> </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_total_relation_size</span><span class="p">(</span><span class="s1">&#39;&#34;&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">table_schema</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#34;.&#34;&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#34;&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pg_total_relation_size</span><span class="p">(</span><span class="s1">&#39;&#34;&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">table_schema</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#34;.&#34;&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#34;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--查出表大小按大小排序并分离data与index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">table_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">table_size</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">table_size</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">indexes_size</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">indexes_size</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">total_size</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">table_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pg_table_size</span><span class="p">(</span><span class="k">table_name</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">table_size</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pg_indexes_size</span><span class="p">(</span><span class="k">table_name</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">indexes_size</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pg_total_relation_size</span><span class="p">(</span><span class="k">table_name</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;&#34;&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">table_schema</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#34;.&#34;&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#34;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">table_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">all_tables</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">total_size</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pretty_sizes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 修改用户密码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">ALTER</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="s1">&#39;hello_world&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 修改数据库名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">alter</span><span class="w">  </span><span class="k">database</span><span class="w">  </span><span class="n">db1</span><span class="w">  </span><span class="k">rename</span><span class="w">  </span><span class="k">to</span><span class="w">  </span><span class="n">db2</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>schema 管理</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 创建schema
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">create</span><span class="w"> </span><span class="k">schema</span><span class="w"> </span><span class="n">test</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 查看schema
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">\</span><span class="n">dn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 修改schema 属主
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">alter</span><span class="w"> </span><span class="k">schema</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">owner</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">highgo</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 修改schema名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">alter</span><span class="w"> </span><span class="k">schema</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">rename</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">testa</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">schema</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">authorization</span><span class="w"> </span><span class="n">highgo</span><span class="p">;;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 切换schema
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">set</span><span class="w"> </span><span class="n">search_path</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">test_schema</span><span class="w">
</span></span></span></code></pre></div><p>修改数据库名</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 修改数据库名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">alter</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">src_dbname</span><span class="w"> </span><span class="k">rename</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">dst_dbname</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 将数据库的名称由database2改成database1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">pg_database</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">datname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;database1&#39;</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">datname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;database2&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>慢查询配置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># postgresql.conf</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 10s</span>
</span></span><span class="line"><span class="cl"><span class="nv">log_min_duration_statement</span><span class="o">=</span><span class="m">10000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 热加载配置</span>
</span></span><span class="line"><span class="cl"><span class="nv">postgres</span><span class="o">=</span><span class="c1"># select pg_reload_conf();</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看配置：</span>
</span></span><span class="line"><span class="cl"><span class="nv">postgres</span><span class="o">=</span><span class="c1"># show log_min_duration_statement;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">log_min_duration_statement
</span></span><span class="line"><span class="cl">----------------------------
</span></span><span class="line"><span class="cl">10s
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="m">1</span> row<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 也可以针对某个用户或者某数据库进行设置：</span>
</span></span><span class="line"><span class="cl"><span class="nv">postgres</span><span class="o">=</span><span class="c1"># alter database test set log_min_duration_statement=5000;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># sql 查询慢语句，超过1s</span>
</span></span><span class="line"><span class="cl"><span class="nv">postgres</span><span class="o">=</span><span class="c1"># select * from pg_stat_activity where state&lt;&gt;&#39;idle&#39; and now()-query_start &gt; interval &#39;1 s&#39; order by query_start;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">select</span> * from pg_stat_activity where state&lt;&gt;<span class="s1">&#39;idle&#39;</span> and now<span class="o">()</span>-query_start &gt; interval <span class="s1">&#39;5 s&#39;</span> order by query_start<span class="p">;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 断开数据库连接</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">select</span> pg_terminate_backend<span class="o">(</span>pid<span class="o">)</span> from <span class="o">(</span><span class="k">select</span> pid from pg_stat_activity where <span class="nv">datname</span> <span class="o">=</span> <span class="s1">&#39;db_name&#39;</span> <span class="o">)</span> as a<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建一个数据库归属其他用户</span>
</span></span><span class="line"><span class="cl">create database <span class="s1">&#39;db_name&#39;</span> OWNER db_user<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看数据库连接数</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> count<span class="o">(</span>*<span class="o">)</span> from pg_stat_activity<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">select</span> * from pg_stat_activity<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查询数据库最大连接数，默认是100</span>
</span></span><span class="line"><span class="cl"><span class="nv">postgres</span><span class="o">=</span>&gt; show max_connections<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># docker 部署到数据库修改最大连接数</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 进入容器，修改最大连接数</span>
</span></span><span class="line"><span class="cl">root@ip142:~# docker <span class="nb">exec</span> -ti postgres10-5433 bash
</span></span><span class="line"><span class="cl">root@568a83e098a5:/# sed  -ri   <span class="s1">&#39;/max_connections/c max_connections = 2000&#39;</span> /var/lib/postgresql/data/postgresql.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># sql 加载配置</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> pg_reload_conf<span class="o">()</span><span class="p">;</span>
</span></span></code></pre></div><p>用户只读权限设置：https://blog.csdn.net/qq_41018743/article/details/105492884</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 以super user创建只读用户
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;*****&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 以super user设置用户默认事务只读
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">alter</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">default_transaction_read_only</span><span class="o">=</span><span class="k">on</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 使用数据库的创建所有者去执行以下操作
</span></span></span><span class="line"><span class="cl"><span class="c1">-- 增加连接数据库权限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">GRANT</span><span class="w"> </span><span class="k">CONNECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="n">testDB</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">readonly</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 切换到 testDB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">\</span><span class="k">c</span><span class="w"> </span><span class="n">testDB</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 赋予用户权限访问public模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">GRANT</span><span class="w"> </span><span class="k">USAGE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">readonly</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 赋予表序列查看权限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">SEQUENCES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">readonly</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">readonly</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 新增加的表都默认增加权限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">alter</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">privileges</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">schema</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">grant</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tables</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">readonly</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 新增加的序列都默认增加权限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">alter</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">privileges</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">schema</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">grant</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">SEQUENCES</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">readonly</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h2 id="三从库配置">三、从库配置</h2>
<p>参考链接：https://help.aliyun.com/document_detail/53096.html</p>
<h3 id="1配置postgresql主节点">1、配置PostgreSQL主节点</h3>
<p>1）输入以下SQL语句创建数据库账号replica，并设置密码及登录权限和备份权限。</p>
<p>本示例中将密码设置为<code>replica</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">replica</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="n">replication</span><span class="w"> </span><span class="k">encrypted</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="s1">&#39;replica&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">replica</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="n">replication</span><span class="w"> </span><span class="k">encrypted</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="s1">&#39;rRweb9iojLxhVeWNddddddddddd&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>2）修改配置文件</p>
<p><code>data/pg_hba.conf</code></p>
<p>在<code>IPv4 local connections</code>段添加下面两行内容。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">host</span>    <span class="nb">all</span>             <span class="nb">all</span>             <span class="o">&lt;</span><span class="n">从节点的VPC</span> <span class="n">IPv4网段</span><span class="o">&gt;</span>          <span class="n">md5</span>     <span class="c1">#允许VPC网段中md5密码认证连接</span>
</span></span><span class="line"><span class="cl"><span class="n">host</span>    <span class="n">replication</span>     <span class="n">replica</span>         <span class="o">&lt;</span><span class="n">从节点的VPC</span> <span class="n">IPv4网段</span><span class="o">&gt;</span>          <span class="n">md5</span>     <span class="c1">#允许用户从replication数据库进行数据同步</span>
</span></span></code></pre></div><p><code>postgresql.conf</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">listen_addresses</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>   <span class="c1">#监听的IP地址</span>
</span></span><span class="line"><span class="cl"><span class="nv">wal_level</span> <span class="o">=</span> hot_standby  <span class="c1">#启用热备模式</span>
</span></span><span class="line"><span class="cl"><span class="nv">synchronous_commit</span> <span class="o">=</span> on  <span class="c1">#开启同步复制</span>
</span></span><span class="line"><span class="cl"><span class="nv">max_wal_senders</span> <span class="o">=</span> <span class="m">32</span>     <span class="c1">#同步最大的进程数量</span>
</span></span><span class="line"><span class="cl"><span class="nv">wal_sender_timeout</span> <span class="o">=</span> 60s <span class="c1">#流复制主机发送数据的超时时间</span>
</span></span><span class="line"><span class="cl"><span class="nv">max_connections</span> <span class="o">=</span> <span class="m">100</span>    <span class="c1">#最大连接数，从库的max_connections必须要大于主库的</span>
</span></span></code></pre></div><p>修改完后重启服务</p>
<h3 id="2从节点上操作">2、从节点上操作</h3>
<p>参考链接：https://blog.51cto.com/u_13482808/6875114</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pg_basebackup --help 
</span></span><span class="line"><span class="cl">用法：
</span></span><span class="line"><span class="cl">  pg_basebackup <span class="o">[</span>选项<span class="o">]</span> ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">控制输出的选项：
</span></span><span class="line"><span class="cl">  -D, --pgdata<span class="o">=</span>DIRECTORY 接收基本备份到目录，如果不存在会自动创建
</span></span><span class="line"><span class="cl">  -F, --format<span class="o">=</span>p<span class="p">|</span>t       输出格式（plain,直接拷贝数据文件，tar 配合 -z -Z 进行打包压缩）
</span></span><span class="line"><span class="cl">  -r, --max-rate<span class="o">=</span>RATE         传输数据目录的最大传输速率（以 kB/s 为单位，或使用后缀“k”或“M”）
</span></span><span class="line"><span class="cl">  -R,--write-recovery-conf 是否输出recovery-conf文件，方便后续使用备份快速搭建出从节点
</span></span><span class="line"><span class="cl">  -T, --tablespace-mapping<span class="o">=</span><span class="nv">OLDDIR</span><span class="o">=</span>NEWDIR 将 OLDDIR 中的表空间重定位到 NEWDIR
</span></span><span class="line"><span class="cl">      --waldir<span class="o">=</span>WALDIR             预写日志目录的位置
</span></span><span class="line"><span class="cl">  -X, --wal-method<span class="o">=</span>none<span class="p">|</span>fetch<span class="p">|</span>stream 包含指定方法所需的 WAL 文件
</span></span><span class="line"><span class="cl">  -z, --gzip                   压缩 tar 输出
</span></span><span class="line"><span class="cl">  -Z, --compress<span class="o">=</span>0-9    使用给定的压缩级别压缩 tar 输出
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">常规选项：
</span></span><span class="line"><span class="cl">  -c, --checkpoint<span class="o">=</span>fast<span class="p">|</span>spread 设置快速或扩展检查点
</span></span><span class="line"><span class="cl">  -C, --create-slot   创建复制槽
</span></span><span class="line"><span class="cl">  -l, --label<span class="o">=</span>LABEL  设置备份标签
</span></span><span class="line"><span class="cl">  -n, --no-clean     出错后不清理
</span></span><span class="line"><span class="cl">  -N, --no-sync     不等待更改安全写入磁盘
</span></span><span class="line"><span class="cl">  -P, --progress    显示进度信息
</span></span><span class="line"><span class="cl">  -S, --slot<span class="o">=</span>SLOTNAME 要使用的复制槽
</span></span><span class="line"><span class="cl">  -v, --verbose 输出详细信息
</span></span><span class="line"><span class="cl">  -V, --version 输出版本信息，然后退出
</span></span><span class="line"><span class="cl">      --no-slot 防止创建临时复制槽
</span></span><span class="line"><span class="cl">      --no-verify-checksums 不验证校验和
</span></span><span class="line"><span class="cl">  -?, --help 显示此帮助，然后退出
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">连接选项：
</span></span><span class="line"><span class="cl">  -d, --dbname  数据库名称
</span></span><span class="line"><span class="cl">  -h, --host      数据库服务器主机ip或套接字目录
</span></span><span class="line"><span class="cl">  -p, --port      数据库口号
</span></span><span class="line"><span class="cl">  -s, --status-interval<span class="o">=</span>状态包发送到服务器的间隔时间（以秒为单位）
</span></span><span class="line"><span class="cl">  -U, --username 连接用户，要有super权限
</span></span><span class="line"><span class="cl">  -w, --no-password 从不提示输入密码
</span></span></code></pre></div><p>1）备份数据</p>
<p>使用pg_basebackup基础备份工具指定备份目录。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">#保持pg data目录格式</span>
</span></span><span class="line"><span class="cl">pg_basebackup -h 192.168.1.1 -p <span class="m">5432</span> -U replica -D /data/test -cfast -Xs -Pv
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 自动创建recovery.conf </span>
</span></span><span class="line"><span class="cl">pg_basebackup -h 192.168.1.1 -p <span class="m">5432</span> -U replica -D /data/test -cfast -Xs -Pv -R
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 打包成tar文件</span>
</span></span><span class="line"><span class="cl">pg_basebackup -h 192.168.1.1 -p <span class="m">5432</span> -U replica -D /data/test -cfast -Xs -Pv -Ft
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 打包成tar.gz文件</span>
</span></span><span class="line"><span class="cl">pg_basebackup -h 192.168.1.1 -p <span class="m">5432</span> -U replica -D /data/test -cfast -Xs -Pv -Ft -z 
</span></span></code></pre></div><p>新建并修改recovery.conf配置文件。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">vim /var/lib/pgsql/11/data/recovery.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">####分别找到以下参数，并将参数修改为以下内容：</span>
</span></span><span class="line"><span class="cl"><span class="nv">standby_mode</span> <span class="o">=</span> on     <span class="c1">#声明此节点为从库</span>
</span></span><span class="line"><span class="cl"><span class="nv">primary_conninfo</span> <span class="o">=</span> <span class="s1">&#39;host=&lt;主节点IP&gt; port=5432 user=replica password=replica&#39;</span> <span class="c1">#对应主库的连接信息</span>
</span></span><span class="line"><span class="cl"><span class="nv">recovery_target_timeline</span> <span class="o">=</span> <span class="s1">&#39;latest&#39;</span> <span class="c1">#流复制同步到最新的数据</span>
</span></span></code></pre></div><p>修改postgresql.conf文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">max_connections</span> <span class="o">=</span> <span class="m">1000</span>             <span class="c1"># 最大连接数，从节点需设置比主节点大</span>
</span></span><span class="line"><span class="cl"><span class="nv">hot_standby</span> <span class="o">=</span> on                   <span class="c1"># 开启热备</span>
</span></span><span class="line"><span class="cl"><span class="nv">max_standby_streaming_delay</span> <span class="o">=</span> 30s  <span class="c1"># 数据流备份的最大延迟时间</span>
</span></span><span class="line"><span class="cl"><span class="nv">wal_receiver_status_interval</span> <span class="o">=</span> 5s  <span class="c1"># 从节点向主节点报告自身状态的最长间隔时间</span>
</span></span><span class="line"><span class="cl"><span class="nv">hot_standby_feedback</span> <span class="o">=</span> on          <span class="c1"># 如果有错误的数据复制向主进行反馈</span>
</span></span></code></pre></div><p>修改数据目录的权限</p>
<pre tabindex="0"><code>chown -R postgres.postgres /var/lib/pgsql/11/data
</code></pre><p>启动服务</p>
<h3 id="3验证">3、验证</h3>
<p>1）在主节点中运行以下命令，查看sender进程。</p>
<pre tabindex="0"><code class="language-undefined" data-lang="undefined">ps aux |grep sender
</code></pre><p>返回结果如下，表示可成功查看到sender进程。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">postgres  2916  0.0  0.3 340388  3220 ?        Ss   15:38   0:00 postgres</span><span class="p">:</span><span class="w"> </span><span class="l">wal sender     process replica 192.168.**.**(49640) streaming 0/F01C1A8</span><span class="w">
</span></span></span></code></pre></div><p>2）在从节点中运行以下命令，查看receiver进程。</p>
<pre tabindex="0"><code class="language-undefined" data-lang="undefined">ps aux |grep receiver
</code></pre><p>返回结果如下，表示可成功查看到receiver进程。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">postgres 23284  0.0  0.3 387100  3444 ?        Ss   16:04   0:00 postgres</span><span class="p">:</span><span class="w"> </span><span class="l">wal receiver process   streaming 0/F01C1A8</span><span class="w">
</span></span></span></code></pre></div><p>3）在主节点中进入PostgreSQL交互终端，输入以下SQL语句，在主库中查看从库状态。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">pg_stat_replication</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>返回结果如下，表示可成功查看到从库状态。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">pid</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">usesysid</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">usename</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">application_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">client_addr</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">client_hostname</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">client_port</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">backend_start</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">backend_xmin</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">sent_location</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">write_locati</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">on</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">flush_location</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">replay_location</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">sync_priority</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">sync_state</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">------+----------+---------+------------------+---------------+-----------------+------------- +-------------------------------+--------------+-----------+---------------+-------------
</span></span></span><span class="line"><span class="cl"><span class="c1">---+----------------+-----------------+---------------+------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">2916</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">16393</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">replica</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">walreceiver</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="o">**</span><span class="p">.</span><span class="o">**</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">49640</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2017</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">02</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">06</span><span class="p">.</span><span class="mi">188988</span><span class="o">+</span><span class="mi">08</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1836</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">streaming</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="o">/</span><span class="n">F01C0C8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="o">/</span><span class="n">F01C0C8</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="o">/</span><span class="n">F01C0C8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="o">/</span><span class="n">F01C0C8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">async</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><h3 id="4查看主从延迟">4、查看主从延迟</h3>
<p>如果主库没有插入或者修改的数据的sql执行，主从同步的延时会逐渐增加</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pg_last_xact_replay_timestamp</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">replication_delay</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2024-08-11</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/pg/">pg</a>,&nbsp;<a href="/tags/postgresql/">postgresql</a>,&nbsp;<a href="/tags/db/">db</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/2023-11-11-go-basic/" class="prev" rel="prev" title="Go basic"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Go basic</a>
            <a href="/posts/2024-08-11-containerd-exit/" class="next" rel="next" title="containerd-exit-code">containerd-exit-code<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">serialt</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":80},"comment":{},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
