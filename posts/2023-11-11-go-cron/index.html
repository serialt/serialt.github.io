<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Go cron - Blog</title><meta name="Description" content="This is my cool site"><meta property="og:title" content="Go cron" />
<meta property="og:description" content="cron定时任务 参考链接：https://segmentfault.com/a/1190000023029219 简介 cron一个用于管理定时" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://serialt.github.io/posts/2023-11-11-go-cron/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-11T10:20:42+08:00" />
<meta property="article:modified_time" content="2023-11-11T10:20:42+08:00" /><meta property="og:site_name" content="Log" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go cron"/>
<meta name="twitter:description" content="cron定时任务 参考链接：https://segmentfault.com/a/1190000023029219 简介 cron一个用于管理定时"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://serialt.github.io/posts/2023-11-11-go-cron/" /><link rel="prev" href="https://serialt.github.io/posts/go-goth/" /><link rel="next" href="https://serialt.github.io/posts/2023-11-11-go-excelize/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Go cron",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/serialt.github.io\/posts\/2023-11-11-go-cron\/"
        },"genre": "posts","keywords": "Go, cron","wordcount":  5020 ,
        "url": "https:\/\/serialt.github.io\/posts\/2023-11-11-go-cron\/","datePublished": "2023-11-11T10:20:42+08:00","dateModified": "2023-11-11T10:20:42+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "serialt"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Blog">记录</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Blog">记录</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Go cron</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>serialt</a></span>&nbsp;<span class="post-category">included in <a href="/categories/go-%E5%BA%93%E6%96%87%E6%A1%A3/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Go 库文档</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-11-11">2023-11-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;5020 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;11 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#cron定时任务">cron定时任务</a>
      <ul>
        <li><a href="#简介">简介</a></li>
        <li><a href="#快速使用">快速使用</a></li>
        <li><a href="#时间格式">时间格式</a></li>
        <li><a href="#时区">时区</a></li>
        <li><a href="#job接口">Job接口</a></li>
        <li><a href="#线程安全">线程安全</a></li>
        <li><a href="#自定义时间格式">自定义时间格式</a></li>
        <li><a href="#选项">选项</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="cron定时任务">cron定时任务</h2>
<p>参考链接：https://segmentfault.com/a/1190000023029219</p>
<h3 id="简介">简介</h3>
<p><a href="https://link.segmentfault.com/?enc=onic69VY8XjI48HtcIDr3A%3D%3D.vhEQuP80W50BEoT0qan5FIaCeFl0ZjjiJm9H6fsRcdE%3D" target="_blank" rel="noopener noreffer "><code>cron</code></a>一个用于管理定时任务的库，用 Go 实现 Linux 中<code>crontab</code>这个命令的效果。之前我们也介绍过一个类似的 Go 库——<a href="https://link.segmentfault.com/?enc=lDbmsDjfPGaMwAaWYtK9HA%3D%3D.YjGIxco5MSYX4FFZfHi%2BechLdYdtK6QoWT3IKszNvM6rH%2FPdJdOFM5kOJ7cG4YZ7PpFwMPR024uqQ1LA21CBFg%3D%3D" target="_blank" rel="noopener noreffer "><code>gron</code></a>。<code>gron</code>代码小巧，用于学习是比较好的。但是它功能相对简单些，并且已经不维护了。如果有定时任务需求，还是建议使用<code>cron</code>。</p>
<h3 id="快速使用">快速使用</h3>
<p>安装<code>cron</code>，目前最新稳定版本为 v3：</p>
<pre tabindex="0"><code>$ go get github.com/robfig/cron/v3
</code></pre><p>使用</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="s">&#34;github.com/robfig/cron/v3&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">AddFunc</span><span class="p">(</span><span class="s">&#34;@every 1s&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;tick every 1 second&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>使用非常简单，创建<code>cron</code>对象，这个对象用于管理定时任务。</p>
<p>调用<code>cron</code>对象的<code>AddFunc()</code>方法向管理器中添加定时任务。<code>AddFunc()</code>接受两个参数，参数 1 以字符串形式指定触发时间规则，参数 2 是一个无参的函数，每次触发时调用。<code>@every 1s</code>表示每秒触发一次，<code>@every</code>后加一个时间间隔，表示每隔多长时间触发一次。例如<code>@every 1h</code>表示每小时触发一次，<code>@every 1m2s</code>表示每隔 1 分 2 秒触发一次。<code>time.ParseDuration()</code>支持的格式都可以用在这里。</p>
<p>调用<code>c.Start()</code>启动定时循环。</p>
<p>注意一点，因为<code>c.Start()</code>启动一个新的 goroutine 做循环检测，我们在代码最后加了一行<code>time.Sleep(time.Second * 5)</code>防止主 goroutine 退出。</p>
<p>运行效果，每隔 1s 输出一行字符串：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ go run main.go 
</span></span><span class="line"><span class="cl">tick every <span class="m">1</span> second
</span></span><span class="line"><span class="cl">tick every <span class="m">1</span> second
</span></span><span class="line"><span class="cl">tick every <span class="m">1</span> second
</span></span><span class="line"><span class="cl">tick every <span class="m">1</span> second
</span></span><span class="line"><span class="cl">tick every <span class="m">1</span> second
</span></span></code></pre></div><h3 id="时间格式">时间格式</h3>
<p>与Linux 中<code>crontab</code>命令相似，<code>cron</code>库支持用 <strong>5</strong> 个空格分隔的域来表示时间。这 5 个域含义依次为：</p>
<ul>
<li><code>Minutes</code>：分钟，取值范围<code>[0-59]</code>，支持特殊字符<code>* / , -</code>；</li>
<li><code>Hours</code>：小时，取值范围<code>[0-23]</code>，支持特殊字符<code>* / , -</code>；</li>
<li><code>Day of month</code>：每月的第几天，取值范围<code>[1-31]</code>，支持特殊字符<code>* / , - ?</code>；</li>
<li><code>Month</code>：月，取值范围<code>[1-12]</code>或者使用月份名字缩写<code>[JAN-DEC]</code>，支持特殊字符<code>* / , -</code>；</li>
<li><code>Day of week</code>：周历，取值范围<code>[0-6]</code>或名字缩写<code>[JUN-SAT]</code>，支持特殊字符<code>* / , - ?</code>。</li>
</ul>
<p>注意，月份和周历名称都是不区分大小写的，也就是说<code>SUN/Sun/sun</code>表示同样的含义（都是周日）。</p>
<p>特殊字符含义如下：</p>
<ul>
<li><code>*</code>：使用<code>*</code>的域可以匹配任何值，例如将月份域（第 4 个）设置为<code>*</code>，表示每个月；</li>
<li><code>/</code>：用来指定范围的<strong>步长</strong>，例如将小时域（第 2 个）设置为<code>3-59/15</code>表示第 3 分钟触发，以后每隔 15 分钟触发一次，因此第 2 次触发为第 18 分钟，第 3 次为 33 分钟。。。直到分钟大于 59；</li>
<li><code>,</code>：用来列举一些离散的值和多个范围，例如将周历的域（第 5 个）设置为<code>MON,WED,FRI</code>表示周一、三和五；</li>
<li><code>-</code>：用来表示范围，例如将小时的域（第 1 个）设置为<code>9-17</code>表示上午 9 点到下午 17 点（包括 9 和 17）；</li>
<li><code>?</code>：只能用在月历和周历的域中，用来代替<code>*</code>，表示每月/周的任意一天。</li>
</ul>
<p>了解规则之后，我们可以定义任意时间：</p>
<ul>
<li><code>30 * * * *</code>：分钟域为 30，其他域都是<code>*</code>表示任意。每小时的 30 分触发；</li>
<li><code>30 3-6,20-23 * * *</code>：分钟域为 30，小时域的<code>3-6,20-23</code>表示 3 点到 6 点和 20 点到 23 点。3,4,5,6,20,21,22,23 时的 30 分触发；</li>
<li><code>0 0 1 1 *</code>：1（第 4 个） 月 1（第 3 个） 号的 0（第 2 个） 时 0（第 1 个） 分触发。</li>
</ul>
<p>记熟了这几个域的顺序，再多练习几次很容易就能掌握格式。熟悉规则了之后，就能熟练使用<code>crontab</code>命令了。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">AddFunc</span><span class="p">(</span><span class="s">&#34;30 * * * *&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Every hour on the half hour&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">AddFunc</span><span class="p">(</span><span class="s">&#34;30 3-6,20-23 * * *&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;On the half hour of 3-6am, 8-11pm&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">AddFunc</span><span class="p">(</span><span class="s">&#34;0 0 1 1 *&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Jun 1 every year&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="预定义时间规则">预定义时间规则</h4>
<p>为了方便使用，<code>cron</code>预定义了一些时间规则：</p>
<ul>
<li><code>@yearly</code>：也可以写作<code>@annually</code>，表示每年第一天的 0 点。等价于<code>0 0 1 1 *</code>；</li>
<li><code>@monthly</code>：表示每月第一天的 0 点。等价于<code>0 0 1 * *</code>；</li>
<li><code>@weekly</code>：表示每周第一天的 0 点，注意第一天为周日，即周六结束，周日开始的那个 0 点。等价于<code>0 0 * * 0</code>；</li>
<li><code>@daily</code>：也可以写作<code>@midnight</code>，表示每天 0 点。等价于<code>0 0 * * *</code>；</li>
<li><code>@hourly</code>：表示每小时的开始。等价于<code>0 * * * *</code>。</li>
</ul>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">AddFunc</span><span class="p">(</span><span class="s">&#34;@hourly&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Every hour&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">AddFunc</span><span class="p">(</span><span class="s">&#34;@daily&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Every day on midnight&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">AddFunc</span><span class="p">(</span><span class="s">&#34;@weekly&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Every week&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>上面代码只是演示用法，实际运行可能要等待非常长的时间才能有输出。</p>
<h4 id="固定时间间隔">固定时间间隔</h4>
<p><code>cron</code>支持固定时间间隔，格式为：</p>
<pre tabindex="0"><code>@every &lt;duration&gt;
</code></pre><p>含义为每隔<code>duration</code>触发一次。``会调用<code>time.ParseDuration()</code>函数解析，所以<code>ParseDuration</code>支持的格式都可以。例如<code>1h30m10s</code>。在快速开始部分，我们已经演示了<code>@every</code>的用法了，这里就不赘述了。</p>
<h3 id="时区">时区</h3>
<p>默认情况下，所有时间都是基于当前时区的。当然我们也可以指定时区，有 2 两种方式：</p>
<ul>
<li>在时间字符串前面添加一个<code>CRON_TZ=</code> + 具体时区，具体时区的格式在之前<a href="https://link.segmentfault.com/?enc=GVot3Or6VWcX5XbyJCSJ7A%3D%3D.oqSl8s1WZKryCQJJiJe7DFDcYpyWCBKlrEG5H%2FT5ve5I%2Bc9Wos9gCO%2FoByVnqzU53BOEx8g0z%2B2EvfEnMtlWQw%3D%3D" target="_blank" rel="noopener noreffer "><code>carbon</code></a>的文章中有详细介绍。东京时区为<code>Asia/Tokyo</code>，纽约时区为<code>America/New_York</code>；</li>
<li>创建<code>cron</code>对象时增加一个时区选项<code>cron.WithLocation(location)</code>，<code>location</code>为<code>time.LoadLocation(zone)</code>加载的时区对象，<code>zone</code>为具体的时区格式。或者调用已创建好的<code>cron</code>对象的<code>SetLocation()</code>方法设置时区。</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">nyc</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">LoadLocation</span><span class="p">(</span><span class="s">&#34;America/New_York&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">cron</span><span class="p">.</span><span class="nf">WithLocation</span><span class="p">(</span><span class="nx">nyc</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">AddFunc</span><span class="p">(</span><span class="s">&#34;0 6 * * ?&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Every 6 o&#39;clock at New York&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">AddFunc</span><span class="p">(</span><span class="s">&#34;CRON_TZ=Asia/Tokyo 0 6 * * ?&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Every 6 o&#39;clock at Tokyo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="job接口">Job接口</h3>
<p>除了直接将无参函数作为回调外，<code>cron</code>还支持<code>Job</code>接口：</p>
<pre tabindex="0"><code>// cron.go
type Job interface {
  Run()
}
</code></pre><p>我们定义一个实现接口<code>Job</code>的结构：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">GreetingJob</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Name</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="nx">GreetingJob</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Hello &#34;</span><span class="p">,</span> <span class="nx">g</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>调用<code>cron</code>对象的<code>AddJob()</code>方法将<code>GreetingJob</code>对象添加到定时管理器中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">AddJob</span><span class="p">(</span><span class="s">&#34;@every 1s&#34;</span><span class="p">,</span> <span class="nx">GreetingJob</span><span class="p">{</span><span class="s">&#34;dj&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>运行效果：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-vim" data-lang="vim"><span class="line"><span class="cl">$ <span class="nx">go</span> <span class="nx">run</span> <span class="nx">main</span>.<span class="nx">go</span> <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nx">Hello</span>  <span class="nx">dj</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nx">Hello</span>  <span class="nx">dj</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nx">Hello</span>  <span class="nx">dj</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nx">Hello</span>  <span class="nx">dj</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nx">Hello</span>  <span class="nx">dj</span><span class="err">
</span></span></span></code></pre></div><p>使用自定义的结构可以让任务携带状态（<code>Name</code>字段）。</p>
<p>实际上<code>AddFunc()</code>方法内部也调用了<code>AddJob()</code>方法。首先，<code>cron</code>基于<code>func()</code>类型定义一个新的类型<code>FuncJob</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// cron.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">FuncJob</span> <span class="kd">func</span><span class="p">()</span>
</span></span></code></pre></div><p>然后让<code>FuncJob</code>实现<code>Job</code>接口：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// cron.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="nx">FuncJob</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在<code>AddFunc()</code>方法中，将传入的回调转为<code>FuncJob</code>类型，然后调用<code>AddJob()</code>方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cron</span><span class="p">)</span> <span class="nf">AddFunc</span><span class="p">(</span><span class="nx">spec</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">cmd</span> <span class="kd">func</span><span class="p">())</span> <span class="p">(</span><span class="nx">EntryID</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">AddJob</span><span class="p">(</span><span class="nx">spec</span><span class="p">,</span> <span class="nf">FuncJob</span><span class="p">(</span><span class="nx">cmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="线程安全">线程安全</h3>
<p><code>cron</code>会创建一个新的 goroutine 来执行触发回调。如果这些回调需要并发访问一些资源、数据，我们需要显式地做同步。</p>
<h3 id="自定义时间格式">自定义时间格式</h3>
<p><code>cron</code>支持灵活的时间格式，如果默认的格式不能满足要求，我们可以自己定义时间格式。时间规则字符串需要<code>cron.Parser</code>对象来解析。我们先来看看默认的解析器是如何工作的。</p>
<p>首先定义各个域：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// parser.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Second</span>         <span class="nx">ParseOption</span> <span class="p">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="kc">iota</span>
</span></span><span class="line"><span class="cl">  <span class="nx">SecondOptional</span>                        
</span></span><span class="line"><span class="cl">  <span class="nx">Minute</span>                                
</span></span><span class="line"><span class="cl">  <span class="nx">Hour</span>                                  
</span></span><span class="line"><span class="cl">  <span class="nx">Dom</span>                                   
</span></span><span class="line"><span class="cl">  <span class="nx">Month</span>                                 
</span></span><span class="line"><span class="cl">  <span class="nx">Dow</span>                                   
</span></span><span class="line"><span class="cl">  <span class="nx">DowOptional</span>                           
</span></span><span class="line"><span class="cl">  <span class="nx">Descriptor</span>                            
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>除了<code>Minute/Hour/Dom(Day of month)/Month/Dow(Day of week)</code>外，还可以支持<code>Second</code>。相对顺序都是固定的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// parser.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">places</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">ParseOption</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Second</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Minute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Hour</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Dom</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Month</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Dow</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">defaults</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;*&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;*&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;*&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>默认的时间格式使用 5 个域。</p>
<p>我们可以调用<code>cron.NewParser()</code>创建自己的<code>Parser</code>对象，以位格式传入使用哪些域，例如下面的<code>Parser</code>使用 6 个域，支持<code>Second</code>（秒）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">parser</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">NewParser</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">cron</span><span class="p">.</span><span class="nx">Second</span> <span class="p">|</span> <span class="nx">cron</span><span class="p">.</span><span class="nx">Minute</span> <span class="p">|</span> <span class="nx">cron</span><span class="p">.</span><span class="nx">Hour</span> <span class="p">|</span> <span class="nx">cron</span><span class="p">.</span><span class="nx">Dom</span> <span class="p">|</span> <span class="nx">cron</span><span class="p">.</span><span class="nx">Month</span> <span class="p">|</span> <span class="nx">cron</span><span class="p">.</span><span class="nx">Dow</span> <span class="p">|</span> <span class="nx">cron</span><span class="p">.</span><span class="nx">Descriptor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>调用<code>cron.WithParser(parser)</code>创建一个选项传入构造函数<code>cron.New()</code>，使用时就可以指定秒了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">cron</span><span class="p">.</span><span class="nf">WithParser</span><span class="p">(</span><span class="nx">parser</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nx">c</span><span class="p">.</span><span class="nf">AddFunc</span><span class="p">(</span><span class="s">&#34;1 * * * * *&#34;</span><span class="p">,</span> <span class="kd">func</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;every 1 second&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span></code></pre></div><p>这里时间格式必须使用 6 个域，顺序与上面的<code>const</code>定义一致。</p>
<p>因为上面的时间格式太常见了，<code>cron</code>定义了一个便捷的函数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// option.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">WithSeconds</span><span class="p">()</span> <span class="nx">Option</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">WithParser</span><span class="p">(</span><span class="nf">NewParser</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Second</span> <span class="p">|</span> <span class="nx">Minute</span> <span class="p">|</span> <span class="nx">Hour</span> <span class="p">|</span> <span class="nx">Dom</span> <span class="p">|</span> <span class="nx">Month</span> <span class="p">|</span> <span class="nx">Dow</span> <span class="p">|</span> <span class="nx">Descriptor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>注意<code>Descriptor</code>表示对<code>@every/@hour</code>等的支持。有了<code>WithSeconds()</code>，我们不用手动创建<code>Parser</code>对象了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">cron</span><span class="p">.</span><span class="nf">WithSeconds</span><span class="p">())</span>
</span></span></code></pre></div><h3 id="选项">选项</h3>
<p><code>cron</code>对象创建使用了选项模式，我们前面已经介绍了 3 个选项：</p>
<ul>
<li><code>WithLocation</code>：指定时区；</li>
<li><code>WithParser</code>：使用自定义的解析器；</li>
<li><code>WithSeconds</code>：让时间格式支持秒，实际上内部调用了<code>WithParser</code>。</li>
</ul>
<p><code>cron</code>还提供了另外两种选项：</p>
<ul>
<li><code>WithLogger</code>：自定义<code>Logger</code>；</li>
<li><code>WithChain</code>：Job 包装器。</li>
</ul>
<h4 id="withlogger"><code>WithLogger</code></h4>
<p><code>WithLogger</code>可以设置<code>cron</code>内部使用我们自定义的<code>Logger</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cron</span><span class="p">.</span><span class="nf">WithLogger</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">cron</span><span class="p">.</span><span class="nf">VerbosePrintfLogger</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span> <span class="s">&#34;cron: &#34;</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nx">LstdFlags</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">AddFunc</span><span class="p">(</span><span class="s">&#34;@every 1s&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;hello world&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>上面调用<code>cron.VerbosPrintfLogger()</code>包装<code>log.Logger</code>，这个<code>logger</code>会详细记录<code>cron</code>内部的调度过程：</p>
<pre tabindex="0"><code class="language-subunit" data-lang="subunit">$ go run main.go
cron: 2020/06/26 07:09:14 start
cron: 2020/06/26 07:09:14 schedule, now=2020-06-26T07:09:14+08:00, entry=1, next=2020-06-26T07:09:15+08:00
cron: 2020/06/26 07:09:15 wake, now=2020-06-26T07:09:15+08:00
cron: 2020/06/26 07:09:15 run, now=2020-06-26T07:09:15+08:00, entry=1, next=2020-06-26T07:09:16+08:00
hello world
cron: 2020/06/26 07:09:16 wake, now=2020-06-26T07:09:16+08:00
cron: 2020/06/26 07:09:16 run, now=2020-06-26T07:09:16+08:00, entry=1, next=2020-06-26T07:09:17+08:00
hello world
cron: 2020/06/26 07:09:17 wake, now=2020-06-26T07:09:17+08:00
cron: 2020/06/26 07:09:17 run, now=2020-06-26T07:09:17+08:00, entry=1, next=2020-06-26T07:09:18+08:00
hello world
cron: 2020/06/26 07:09:18 wake, now=2020-06-26T07:09:18+08:00
hello world
cron: 2020/06/26 07:09:18 run, now=2020-06-26T07:09:18+08:00, entry=1, next=2020-06-26T07:09:19+08:00
cron: 2020/06/26 07:09:19 wake, now=2020-06-26T07:09:19+08:00
hello world
cron: 2020/06/26 07:09:19 run, now=2020-06-26T07:09:19+08:00, entry=1, next=2020-06-26T07:09:20+08:0
</code></pre><p>我们看看默认的<code>Logger</code>是什么样的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// logger.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">DefaultLogger</span> <span class="nx">Logger</span> <span class="p">=</span> <span class="nf">PrintfLogger</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span> <span class="s">&#34;cron: &#34;</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nx">LstdFlags</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">PrintfLogger</span><span class="p">(</span><span class="nx">l</span> <span class="kd">interface</span><span class="p">{</span> <span class="nf">Printf</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">})</span> <span class="nx">Logger</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">printfLogger</span><span class="p">{</span><span class="nx">l</span><span class="p">,</span> <span class="kc">false</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">VerbosePrintfLogger</span><span class="p">(</span><span class="nx">l</span> <span class="kd">interface</span><span class="p">{</span> <span class="nf">Printf</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">})</span> <span class="nx">Logger</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">printfLogger</span><span class="p">{</span><span class="nx">l</span><span class="p">,</span> <span class="kc">true</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">printfLogger</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">logger</span>  <span class="kd">interface</span><span class="p">{</span> <span class="nf">Printf</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">logInfo</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="withchain"><code>WithChain</code></h4>
<p>Job 包装器可以在执行实际的<code>Job</code>前后添加一些逻辑：</p>
<ul>
<li>捕获<code>panic</code>；</li>
<li>如果<code>Job</code>上次运行还未结束，推迟本次执行;</li>
<li>如果<code>Job</code>上次运行还未介绍，跳过本次执行；</li>
<li>记录每个<code>Job</code>的执行情况。</li>
</ul>
<p>我们可以将<code>Chain</code>类比为 Web 处理器的中间件。实际上就是在<code>Job</code>的执行逻辑外在封装一层逻辑。我们的封装逻辑需要写成一个函数，传入一个<code>Job</code>类型，返回封装后的<code>Job</code>。<code>cron</code>为这种函数定义了一个类型<code>JobWrapper</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// chain.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">JobWrapper</span> <span class="kd">func</span><span class="p">(</span><span class="nx">Job</span><span class="p">)</span> <span class="nx">Job</span>
</span></span></code></pre></div><p>然后使用一个<code>Chain</code>对象将这些<code>JobWrapper</code>组合到一起：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Chain</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">wrappers</span> <span class="p">[]</span><span class="nx">JobWrapper</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewChain</span><span class="p">(</span><span class="nx">c</span> <span class="o">...</span><span class="nx">JobWrapper</span><span class="p">)</span> <span class="nx">Chain</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">Chain</span><span class="p">{</span><span class="nx">c</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>调用<code>Chain</code>对象的<code>Then(job)</code>方法应用这些<code>JobWrapper</code>，返回最终的`Job：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">Chain</span><span class="p">)</span> <span class="nf">Then</span><span class="p">(</span><span class="nx">j</span> <span class="nx">Job</span><span class="p">)</span> <span class="nx">Job</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">wrappers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">j</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">wrappers</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">wrappers</span><span class="p">)</span><span class="o">-</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="nx">j</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">j</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>注意应用<code>JobWrapper</code>的顺序。</p>
<h4 id="内置jobwrapper">内置<code>JobWrapper</code></h4>
<p><code>cron</code>内置了 3 个用得比较多的<code>JobWrapper</code>：</p>
<ul>
<li><code>Recover</code>：捕获内部<code>Job</code>产生的 panic；</li>
<li><code>DelayIfStillRunning</code>：触发时，如果上一次任务还未执行完成（耗时太长），则等待上一次任务完成之后再执行；</li>
<li><code>SkipIfStillRunning</code>：触发时，如果上一次任务还未完成，则跳过此次执行。</li>
</ul>
<p>下面分别介绍。</p>
<h5 id="recover"><code>Recover</code></h5>
<p>先看看如何使用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">panicJob</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">count</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">panicJob</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">p</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;oooooooooooooops!!!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;hello world&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">AddJob</span><span class="p">(</span><span class="s">&#34;@every 1s&#34;</span><span class="p">,</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">NewChain</span><span class="p">(</span><span class="nx">cron</span><span class="p">.</span><span class="nf">Recover</span><span class="p">(</span><span class="nx">cron</span><span class="p">.</span><span class="nx">DefaultLogger</span><span class="p">)).</span><span class="nf">Then</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">panicJob</span><span class="p">{}))</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>panicJob</code>在第一次触发时，触发了<code>panic</code>。因为有<code>cron.Recover()</code>保护，后续任务还能执行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-awk" data-lang="awk"><span class="line"><span class="cl"><span class="nx">go</span> <span class="nx">run</span> <span class="nx">main</span><span class="p">.</span><span class="nx">go</span> 
</span></span><span class="line"><span class="cl"><span class="nx">cron</span><span class="err">:</span> <span class="mi">2020</span><span class="o">/</span><span class="mi">06</span><span class="o">/</span><span class="mi">27</span> <span class="mi">14</span><span class="err">:</span><span class="mi">02</span><span class="err">:</span><span class="mi">00</span> <span class="nx">panic</span><span class="p">,</span> <span class="nx">error</span><span class="o">=</span><span class="nx">oooooooooooooops</span><span class="o">!!!</span><span class="p">,</span> <span class="nx">stack</span><span class="o">=</span><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="nx">goroutine</span> <span class="mi">18</span> <span class="p">[</span><span class="nx">running</span><span class="p">]</span><span class="err">:</span>
</span></span><span class="line"><span class="cl"><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">robfig</span><span class="o">/</span><span class="nx">cron</span><span class="o">/</span><span class="nx">v3</span><span class="p">.</span><span class="nx">Recover</span><span class="p">.</span><span class="nx">func1</span><span class="p">.</span><span class="mf">1.1</span><span class="p">(</span><span class="mh">0x514ee0</span><span class="p">,</span> <span class="mh">0xc0000044a0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">D</span><span class="err">:</span><span class="o">/</span><span class="nx">code</span><span class="o">/</span><span class="nx">golang</span><span class="o">/</span><span class="nx">pkg</span><span class="o">/</span><span class="nx">mod</span><span class="o">/</span><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">robfig</span><span class="o">/</span><span class="nx">cron</span><span class="o">/</span><span class="nx">v3@v3</span><span class="p">.</span><span class="mf">0.1</span><span class="o">/</span><span class="nx">chain</span><span class="p">.</span><span class="nx">go</span><span class="err">:</span><span class="mi">45</span> <span class="o">+</span><span class="mh">0xbc</span>
</span></span><span class="line"><span class="cl"><span class="nx">panic</span><span class="p">(</span><span class="mh">0x4cf380</span><span class="p">,</span> <span class="mh">0x513280</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">C</span><span class="err">:</span><span class="o">/</span><span class="nx">Go</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">runtime</span><span class="o">/</span><span class="nx">panic</span><span class="p">.</span><span class="nx">go</span><span class="err">:</span><span class="mi">969</span> <span class="o">+</span><span class="mh">0x174</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">.(</span><span class="o">*</span><span class="nx">panicJob</span><span class="p">).</span><span class="nx">Run</span><span class="p">(</span><span class="mh">0xc0000140e8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">D</span><span class="err">:</span><span class="o">/</span><span class="nx">code</span><span class="o">/</span><span class="nx">golang</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">darjun</span><span class="o">/</span><span class="nx">go</span><span class="o">-</span><span class="nx">daily</span><span class="o">-</span><span class="nx">lib</span><span class="o">/</span><span class="nx">cron</span><span class="o">/</span><span class="nx">recover</span><span class="o">/</span><span class="nx">main</span><span class="p">.</span><span class="nx">go</span><span class="err">:</span><span class="mi">17</span> <span class="o">+</span><span class="mh">0xba</span>
</span></span><span class="line"><span class="cl"><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">robfig</span><span class="o">/</span><span class="nx">cron</span><span class="o">/</span><span class="nx">v3</span><span class="p">.</span><span class="nx">Recover</span><span class="p">.</span><span class="nx">func1</span><span class="p">.</span><span class="mi">1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">D</span><span class="err">:</span><span class="o">/</span><span class="nx">code</span><span class="o">/</span><span class="nx">golang</span><span class="o">/</span><span class="nx">pkg</span><span class="o">/</span><span class="nx">mod</span><span class="o">/</span><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">robfig</span><span class="o">/</span><span class="nx">cron</span><span class="o">/</span><span class="nx">v3@v3</span><span class="p">.</span><span class="mf">0.1</span><span class="o">/</span><span class="nx">chain</span><span class="p">.</span><span class="nx">go</span><span class="err">:</span><span class="mi">53</span> <span class="o">+</span><span class="mh">0x6f</span>
</span></span><span class="line"><span class="cl"><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">robfig</span><span class="o">/</span><span class="nx">cron</span><span class="o">/</span><span class="nx">v3</span><span class="p">.</span><span class="nx">FuncJob</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="mh">0xc000070390</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">D</span><span class="err">:</span><span class="o">/</span><span class="nx">code</span><span class="o">/</span><span class="nx">golang</span><span class="o">/</span><span class="nx">pkg</span><span class="o">/</span><span class="nx">mod</span><span class="o">/</span><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">robfig</span><span class="o">/</span><span class="nx">cron</span><span class="o">/</span><span class="nx">v3@v3</span><span class="p">.</span><span class="mf">0.1</span><span class="o">/</span><span class="nx">cron</span><span class="p">.</span><span class="nx">go</span><span class="err">:</span><span class="mi">136</span> <span class="o">+</span><span class="mh">0x2c</span>
</span></span><span class="line"><span class="cl"><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">robfig</span><span class="o">/</span><span class="nx">cron</span><span class="o">/</span><span class="nx">v3</span><span class="p">.(</span><span class="o">*</span><span class="nx">Cron</span><span class="p">).</span><span class="nx">startJob</span><span class="p">.</span><span class="nx">func1</span><span class="p">(</span><span class="mh">0xc00005c0a0</span><span class="p">,</span> <span class="mh">0x514d20</span><span class="p">,</span> <span class="mh">0xc000070390</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">D</span><span class="err">:</span><span class="o">/</span><span class="nx">code</span><span class="o">/</span><span class="nx">golang</span><span class="o">/</span><span class="nx">pkg</span><span class="o">/</span><span class="nx">mod</span><span class="o">/</span><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">robfig</span><span class="o">/</span><span class="nx">cron</span><span class="o">/</span><span class="nx">v3@v3</span><span class="p">.</span><span class="mf">0.1</span><span class="o">/</span><span class="nx">cron</span><span class="p">.</span><span class="nx">go</span><span class="err">:</span><span class="mi">312</span> <span class="o">+</span><span class="mh">0x68</span>
</span></span><span class="line"><span class="cl"><span class="nx">created</span> <span class="nx">by</span> <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">robfig</span><span class="o">/</span><span class="nx">cron</span><span class="o">/</span><span class="nx">v3</span><span class="p">.(</span><span class="o">*</span><span class="nx">Cron</span><span class="p">).</span><span class="nx">startJob</span>
</span></span><span class="line"><span class="cl">        <span class="nx">D</span><span class="err">:</span><span class="o">/</span><span class="nx">code</span><span class="o">/</span><span class="nx">golang</span><span class="o">/</span><span class="nx">pkg</span><span class="o">/</span><span class="nx">mod</span><span class="o">/</span><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">robfig</span><span class="o">/</span><span class="nx">cron</span><span class="o">/</span><span class="nx">v3@v3</span><span class="p">.</span><span class="mf">0.1</span><span class="o">/</span><span class="nx">cron</span><span class="p">.</span><span class="nx">go</span><span class="err">:</span><span class="mi">310</span> <span class="o">+</span><span class="mh">0x7a</span>
</span></span><span class="line"><span class="cl"><span class="nx">hello</span> <span class="nx">world</span>
</span></span><span class="line"><span class="cl"><span class="nx">hello</span> <span class="nx">world</span>
</span></span><span class="line"><span class="cl"><span class="nx">hello</span> <span class="nx">world</span>
</span></span><span class="line"><span class="cl"><span class="nx">hello</span> <span class="nx">world</span>
</span></span></code></pre></div><p>我们看看<code>cron.Recover()</code>的实现，很简单：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// cron.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Recover</span><span class="p">(</span><span class="nx">logger</span> <span class="nx">Logger</span><span class="p">)</span> <span class="nx">JobWrapper</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">j</span> <span class="nx">Job</span><span class="p">)</span> <span class="nx">Job</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">FuncJob</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">r</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">r</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="kd">const</span> <span class="nx">size</span> <span class="p">=</span> <span class="mi">64</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">          <span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="nx">buf</span> <span class="p">=</span> <span class="nx">buf</span><span class="p">[:</span><span class="nx">runtime</span><span class="p">.</span><span class="nf">Stack</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="kc">false</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">          <span class="nx">err</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.(</span><span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">err</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%v&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;panic&#34;</span><span class="p">,</span> <span class="s">&#34;stack&#34;</span><span class="p">,</span> <span class="s">&#34;...\n&#34;</span><span class="o">+</span><span class="nb">string</span><span class="p">(</span><span class="nx">buf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}()</span>
</span></span><span class="line"><span class="cl">      <span class="nx">j</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>就是在执行内层的<code>Job</code>逻辑前，添加<code>recover()</code>调用。如果<code>Job.Run()</code>执行过程中有<code>panic</code>。这里的<code>recover()</code>会捕获到，输出调用堆栈。</p>
<h5 id="delayifstillrunning"><code>DelayIfStillRunning</code></h5>
<p>还是先看如何使用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">delayJob</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">count</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">delayJob</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">  <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%d: hello world\n&#34;</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">AddJob</span><span class="p">(</span><span class="s">&#34;@every 1s&#34;</span><span class="p">,</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">NewChain</span><span class="p">(</span><span class="nx">cron</span><span class="p">.</span><span class="nf">DelayIfStillRunning</span><span class="p">(</span><span class="nx">cron</span><span class="p">.</span><span class="nx">DefaultLogger</span><span class="p">)).</span><span class="nf">Then</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">delayJob</span><span class="p">{}))</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>上面我们在<code>Run()</code>中增加了一个 2s 的延迟，输出中间隔变为 2s，而不是定时的 1s：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="err">$</span> <span class="k">go</span> <span class="nx">run</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2020</span><span class="o">/</span><span class="mo">06</span><span class="o">/</span><span class="mi">27</span> <span class="mi">14</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">16</span> <span class="mi">1</span><span class="p">:</span> <span class="nx">hello</span> <span class="nx">world</span>
</span></span><span class="line"><span class="cl"><span class="mi">2020</span><span class="o">/</span><span class="mo">06</span><span class="o">/</span><span class="mi">27</span> <span class="mi">14</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">18</span> <span class="mi">2</span><span class="p">:</span> <span class="nx">hello</span> <span class="nx">world</span>
</span></span><span class="line"><span class="cl"><span class="mi">2020</span><span class="o">/</span><span class="mo">06</span><span class="o">/</span><span class="mi">27</span> <span class="mi">14</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">20</span> <span class="mi">3</span><span class="p">:</span> <span class="nx">hello</span> <span class="nx">world</span>
</span></span><span class="line"><span class="cl"><span class="mi">2020</span><span class="o">/</span><span class="mo">06</span><span class="o">/</span><span class="mi">27</span> <span class="mi">14</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">22</span> <span class="mi">4</span><span class="p">:</span> <span class="nx">hello</span> <span class="nx">world</span>
</span></span></code></pre></div><p>看看源码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// chain.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">DelayIfStillRunning</span><span class="p">(</span><span class="nx">logger</span> <span class="nx">Logger</span><span class="p">)</span> <span class="nx">JobWrapper</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">j</span> <span class="nx">Job</span><span class="p">)</span> <span class="nx">Job</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">mu</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">FuncJob</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">start</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">defer</span> <span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">dur</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="nx">start</span><span class="p">);</span> <span class="nx">dur</span> <span class="p">&gt;</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;delay&#34;</span><span class="p">,</span> <span class="s">&#34;duration&#34;</span><span class="p">,</span> <span class="nx">dur</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">j</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>首先定义一个该任务共用的互斥锁<code>sync.Mutex</code>，每次执行任务前获取锁，执行结束之后释放锁。所以在上一个任务结束前，下一个任务获取锁是无法成功的，从而保证的任务的串行执行。</p>
<h5 id="skipifstillrunning"><code>SkipIfStillRunning</code></h5>
<p>还是先看看如何使用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">skipJob</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">count</span> <span class="kt">int32</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">skipJob</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%d: hello world\n&#34;</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">d</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">AddJob</span><span class="p">(</span><span class="s">&#34;@every 1s&#34;</span><span class="p">,</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">NewChain</span><span class="p">(</span><span class="nx">cron</span><span class="p">.</span><span class="nf">SkipIfStillRunning</span><span class="p">(</span><span class="nx">cron</span><span class="p">.</span><span class="nx">DefaultLogger</span><span class="p">)).</span><span class="nf">Then</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">skipJob</span><span class="p">{}))</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>输出：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="err">$</span> <span class="k">go</span> <span class="nx">run</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
</span></span><span class="line"><span class="cl"><span class="mi">2020</span><span class="o">/</span><span class="mo">06</span><span class="o">/</span><span class="mi">27</span> <span class="mi">14</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mo">07</span> <span class="mi">1</span><span class="p">:</span> <span class="nx">hello</span> <span class="nx">world</span>
</span></span><span class="line"><span class="cl"><span class="mi">2020</span><span class="o">/</span><span class="mo">06</span><span class="o">/</span><span class="mi">27</span> <span class="mi">14</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">10</span> <span class="mi">2</span><span class="p">:</span> <span class="nx">hello</span> <span class="nx">world</span>
</span></span><span class="line"><span class="cl"><span class="mi">2020</span><span class="o">/</span><span class="mo">06</span><span class="o">/</span><span class="mi">27</span> <span class="mi">14</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">11</span> <span class="mi">3</span><span class="p">:</span> <span class="nx">hello</span> <span class="nx">world</span>
</span></span><span class="line"><span class="cl"><span class="mi">2020</span><span class="o">/</span><span class="mo">06</span><span class="o">/</span><span class="mi">27</span> <span class="mi">14</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">12</span> <span class="mi">4</span><span class="p">:</span> <span class="nx">hello</span> <span class="nx">world</span>
</span></span><span class="line"><span class="cl"><span class="mi">2020</span><span class="o">/</span><span class="mo">06</span><span class="o">/</span><span class="mi">27</span> <span class="mi">14</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">13</span> <span class="mi">5</span><span class="p">:</span> <span class="nx">hello</span> <span class="nx">world</span>
</span></span><span class="line"><span class="cl"><span class="mi">2020</span><span class="o">/</span><span class="mo">06</span><span class="o">/</span><span class="mi">27</span> <span class="mi">14</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">14</span> <span class="mi">6</span><span class="p">:</span> <span class="nx">hello</span> <span class="nx">world</span>
</span></span><span class="line"><span class="cl"><span class="mi">2020</span><span class="o">/</span><span class="mo">06</span><span class="o">/</span><span class="mi">27</span> <span class="mi">14</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">15</span> <span class="mi">7</span><span class="p">:</span> <span class="nx">hello</span> <span class="nx">world</span>
</span></span><span class="line"><span class="cl"><span class="mi">2020</span><span class="o">/</span><span class="mo">06</span><span class="o">/</span><span class="mi">27</span> <span class="mi">14</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">16</span> <span class="mi">8</span><span class="p">:</span> <span class="nx">hello</span> <span class="nx">world</span>
</span></span></code></pre></div><p>注意观察时间，第一个与第二个输出之间相差 3s，因为跳过了两次执行。</p>
<p>注意<code>DelayIfStillRunning</code>与<code>SkipIfStillRunning</code>是有本质上的区别的，前者<code>DelayIfStillRunning</code>只要时间足够长，所有的任务都会按部就班地完成，只是可能前一个任务耗时过长，导致后一个任务的执行时间推迟了一点。<code>SkipIfStillRunning</code>会跳过一些执行。</p>
<p>看看源码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">SkipIfStillRunning</span><span class="p">(</span><span class="nx">logger</span> <span class="nx">Logger</span><span class="p">)</span> <span class="nx">JobWrapper</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">j</span> <span class="nx">Job</span><span class="p">)</span> <span class="nx">Job</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">ch</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{},</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ch</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">FuncJob</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nx">v</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">ch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">j</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl">      <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;skip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>定义一个该任务共用的缓存大小为 1 的通道<code>chan struct{}</code>。执行任务时，从通道中取值，如果成功，执行，否则跳过。执行完成之后再向通道中发送一个值，确保下一个任务能执行。初始发送一个值到通道中，保证第一个任务的执行。</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-11-11</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://serialt.github.io/posts/2023-11-11-go-cron/" data-title="Go cron" data-hashtags="Go,cron"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://serialt.github.io/posts/2023-11-11-go-cron/" data-hashtag="Go"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://serialt.github.io/posts/2023-11-11-go-cron/" data-title="Go cron"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://serialt.github.io/posts/2023-11-11-go-cron/" data-title="Go cron"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://serialt.github.io/posts/2023-11-11-go-cron/" data-title="Go cron"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/go/">Go</a>,&nbsp;<a href="/tags/cron/">cron</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/go-goth/" class="prev" rel="prev" title="Go goph"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Go goph</a>
            <a href="/posts/2023-11-11-go-excelize/" class="next" rel="next" title="Go excelize">Go excelize<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">serialt</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
