<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Terraform handbook - Blog</title><meta name="Description" content="This is my cool site"><meta property="og:title" content="Terraform handbook" />
<meta property="og:description" content="Terraform handbook 参考链接：https://blog.gmem.cc/terraform 一、简介 Terraform用于实现基础设施即代码（infrastr" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://serialt.github.io/posts/2023-11-22-terraform-handbook/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-22T21:22:27+08:00" />
<meta property="article:modified_time" content="2023-11-22T21:22:27+08:00" /><meta property="og:site_name" content="Log" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Terraform handbook"/>
<meta name="twitter:description" content="Terraform handbook 参考链接：https://blog.gmem.cc/terraform 一、简介 Terraform用于实现基础设施即代码（infrastr"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://serialt.github.io/posts/2023-11-22-terraform-handbook/" /><link rel="prev" href="https://serialt.github.io/posts/2023-11-20-timezone/" /><link rel="next" href="https://serialt.github.io/posts/2023-11-22-python-basic/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Terraform handbook",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/serialt.github.io\/posts\/2023-11-22-terraform-handbook\/"
        },"genre": "posts","keywords": "tf, terraform","wordcount":  4543 ,
        "url": "https:\/\/serialt.github.io\/posts\/2023-11-22-terraform-handbook\/","datePublished": "2023-11-22T21:22:27+08:00","dateModified": "2023-11-22T21:22:27+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "serialt"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Blog">记录</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Blog">记录</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Terraform handbook</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>serialt</a></span>&nbsp;<span class="post-category">included in <a href="/categories/devops/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>DevOps</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-11-22">2023-11-22</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;4543 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;10 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#一简介">一、简介</a></li>
    <li><a href="#二命令行">二、命令行</a>
      <ul>
        <li><a href="#1安装命令行">1、安装命令行</a></li>
        <li><a href="#2基本特性">2、基本特性</a></li>
        <li><a href="#3资源地址">3、资源地址</a></li>
        <li><a href="#4配置文件">4、配置文件</a></li>
        <li><a href="#5init">5、init</a></li>
        <li><a href="#6validate">6、validate</a></li>
        <li><a href="#7plan">7、plan</a></li>
        <li><a href="#8apply">8、apply</a></li>
      </ul>
    </li>
    <li><a href="#三tf语言">三、TF语言</a>
      <ul>
        <li><a href="#1块">1、块</a></li>
        <li><a href="#2数据类型">2、数据类型</a></li>
        <li><a href="#3空值">3、空值</a></li>
        <li><a href="#5操作符">5、操作符</a></li>
        <li><a href="#for_each">for_each</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="terraform-handbook">Terraform handbook</h1>
<p>参考链接：https://blog.gmem.cc/terraform</p>
<h2 id="一简介">一、简介</h2>
<p>Terraform用于实现基础设施即代码（infrastructure as code）—— 通过代码（配置文件）来描述基础设施的拓扑结构，并确保云上资源和此结构完全对应。Terraform有三个版本，我们主要关注Terraform CLI。</p>
<p>Terraform CLI主要包含以下组件：</p>
<ul>
<li>
<p>命令行前端</p>
</li>
<li>
<p>Terraform Language（以下简称TL，衍生自HashiCorp配置语言HCL）编写的、描述基础设施拓扑结构的配置文件。配置文件的组织方式是模块。本文使用术语“配置”（Configuration）来表示一整套描述基础设施的Terraform配置文件</p>
</li>
<li>
<p>针对各种云服务商的驱动（Provider），实现云资源的创建、更新和删除</p>
</li>
</ul>
<p>云上资源不单单包括基础的IaaS资源，还可以是DNS条目、SaaS资源。事实上，通过开发Provider，你可以用Terraform管理任何资源。</p>
<p>Terraform会检查配置文件，并生成执行计划。计划描述了那些资源需要被创建、修改或删除，以及这些资源之间的依赖关系。Terraform会尽可能并行的对资源进行变更。当你更新了配置文件后，Terraform会生成增量的执行计划。</p>
<h2 id="二命令行">二、命令行</h2>
<h3 id="1安装命令行">1、安装命令行</h3>
<p>直接到https://www.terraform.io/downloads.html下载，存放到$PATH下即可。</p>
<h3 id="2基本特性">2、基本特性</h3>
<h4 id="1切换工作目录">1）切换工作目录</h4>
<p>使用选项 -chdir=DIR</p>
<h4 id="2shell自动补全">2）Shell自动补全</h4>
<p>使用 terraform -install-autocomplete安装自动完成脚本，使用 terraform -uninstall-autocomplete删除自动完成脚本。</p>
<h3 id="3资源地址">3、资源地址</h3>
<p>很多子命令接受资源地址参数，下面是一些例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 资源类型.资源名</span>
</span></span><span class="line"><span class="cl">aws_instance.foo
</span></span><span class="line"><span class="cl"><span class="c1"># 资源类型.资源列表名[索引]</span>
</span></span><span class="line"><span class="cl">aws_instance.bar<span class="o">[</span>1<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 子模块foo的子模块bar中的</span>
</span></span><span class="line"><span class="cl">module.foo.module.bar.aws_instance.baz
</span></span></code></pre></div><h3 id="4配置文件">4、配置文件</h3>
<p>配置文件的路径可以通过环境变量 TF_CLI_CONFIG_FILE设置。非Windows系统中， $HOME/.terraformrc为默认配置文件路径。配置文件语法类似于TF文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># provider缓存目录</span>
</span></span><span class="line"><span class="cl"><span class="nv">plugin_cache_dir</span>   <span class="o">=</span> <span class="s2">&#34;</span><span class="nv">$HOME</span><span class="s2">/.terraform.d/plugin-cache&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="nv">disable_checkpoint</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 存放凭证信息，包括模块仓库、支持远程操作的系统的凭证</span>
</span></span><span class="line"><span class="cl">credentials <span class="s2">&#34;app.terraform.io&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">token</span> <span class="o">=</span> <span class="s2">&#34;xxxxxx.atlasv1.zzzzzzzzzzzzz&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 改变默认安装逻辑</span>
</span></span><span class="line"><span class="cl">provider_installation <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 为example.com提供本地文件系统镜像，这样安装example.com/*/*的provider时就不会去网络上请求</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 默认路径是：</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># ~/.terraform.d/plugins/${host_name}/${namespace}/${type}/${version}/${target}</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 例如：</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># ~/.terraform.d/plugins/hashicorp.com/edu/hashicups/0.3.1/linux_amd64/terraform-provider-hashicups_v0.3.1</span>
</span></span><span class="line"><span class="cl">  filesystem_mirror <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">path</span>    <span class="o">=</span> <span class="s2">&#34;/usr/share/terraform/providers&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">include</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;example.com/*/*&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  direct <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">exclude</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;example.com/*/*&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1"># Terraform会在terraform init的时候，校验Provider的版本和checksum。Provider从Registry或者本地</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 目录下载Provider。当我们开发Provider的时候，常常需要方便的测试临时Provider版本，这种Provider还</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 没有关联版本号，也没有在Registry中注册Chencksum</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 为了简化开发，可以配置dev_overrides，它能覆盖所有配置的安装方法</span>
</span></span><span class="line"><span class="cl">  dev_overrides <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;hashicorp.com/edu/hashicups-pf&#34;</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="k">$(</span>go env GOBIN<span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="5init">5、init</h3>
<p>配置工作目录，为使用其它命令做好准备。</p>
<p>Terraform命令需要在一个编写了Terraform配置文件的目录（配置根目录）下执行，它会在此目录下存储设置、缓存插件/模块，以及（默认使用Local后端时）存储状态数据。此目录必须进行初始化。</p>
<p>初始化后，会生成以下额外目录/文件：</p>
<p>.terraform目录，用于缓存provider和模块
如果使用Local后端，保存状态的terraform.tfstate文件。如果使用多工作区，则是terraform.tfstate.d目录。</p>
<p>对配置的某些变更，需要重新运行初始化，包括provider需求的变更、模块源/版本约束的变更、后端配置的变更。需要重新初始化时，其它命令可能会无法执行并提示你进行初始化。</p>
<p>命令 terraform get可以仅仅下载依赖的模块，而不执行其它init子任务。</p>
<p>运行 terraform init -upgrade会强制拉取最新的、匹配约束的版本并更新依赖锁文件。</p>
<h3 id="6validate">6、validate</h3>
<p>校验配置是否合法。</p>
<h3 id="7plan">7、plan</h3>
<p>显示执行计划，即当前配置将请求（结合state）哪些变更。Terraform的核心功能时创建、修改、删除基础设施对象，使基础设施的状态和当前配置匹配。当我们说运行Terraform时，主要是指plan/apply/destroy这几个命令。</p>
<p>terraform plan命令评估当前配置，确定其声明的所有资源的期望状态。然后比较此期望状态和真实基础设施的当前状态。它使用state来确定哪些真实基础设施对象和声明资源的对应关系，并且使用provider的API查询每个资源的当前状态。当确定到达期望状态需要执行哪些变更后，Terraform将其打印到控制台，它并不会执行任何实际的变更操作。</p>
<h4 id="计划模式">计划模式</h4>
<p>plan命令支持两种备选的工作模式：</p>
<ul>
<li>
<p>销毁模式：创建一个计划，其目标是销毁所有当前存在于配置中的远程对象，留下一个空白的state。对应选项 -destroy</p>
</li>
<li>
<p>仅刷新模式：创建一个计划，其目标仅仅是更新state和根模块的输出值，以便和从Terraform之外对基础设施对象的变更匹配。对应选项 -refresh-only</p>
</li>
</ul>
<h4 id="指定输入变量">指定输入变量</h4>
<p>使用选项 -<strong>var</strong> &lsquo;NAME=VALUE&rsquo;可以指定输入变量，该选项可以使用多次。</p>
<p>使用选项 -<strong>var</strong>-file=FILENAME可以从文件读取输入变量，某些文件会自动读取</p>
<h3 id="8apply">8、apply</h3>
<p>应用执行计划，创建、更新设施对象。</p>
<p>apply会做plan的任何事情，并在其基础上，直接执行变更操作。默认情况下，apply即席的执行一次plan，你也可以直接使用已保存的plan</p>
<p>命令格式： terraform apply [options] [plan file]</p>
<h4 id="自动确认">自动确认</h4>
<p>选项 -auto-approve可以自动确认并执行所需操作，不需要人工确认。</p>
<h4 id="使用已有计划">使用已有计划</h4>
<p>如果指定plan file参数，则读取先前保存的计划并执行。</p>
<h4 id="计划模式-1">计划模式</h4>
<p>支持plan命令中关于计划模式的选项。</p>
<h2 id="三tf语言">三、TF语言</h2>
<h3 id="1块">1、块</h3>
<p>配置文件由若干块（Block）组成，块的语法如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># Block header, which identifies a block</span>
</span></span><span class="line"><span class="cl">&lt;BLOCK TYPE&gt; <span class="s2">&#34;&lt;BLOCK LABEL&gt;&#34;</span> <span class="s2">&#34;&lt;BLOCK LABEL&gt;&#34;</span> <span class="s2">&#34;...&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Block body</span>
</span></span><span class="line"><span class="cl">  &lt;IDENTIFIER&gt; <span class="o">=</span> &lt;EXPRESSION&gt; <span class="c1"># Argument</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>块是一个容器，它的作用取决于块的类型。块常常用来描述某个资源的配置。</p>
<p>取决于块的类型，标签的数量可以是0-N个。对于resource块，标签数量为两个。某些特殊的块，可能支持任意数量的标签。某些内嵌的块，例如network_interface，则不支持标签。</p>
<p>块体中可以包含若干参数（Argument），或者其它内嵌的块。参数用于将一个表达式分配到一个标识符，常常对应某个资源的一条属性。表达式可以是字面值，或者引用其它的值，正是这种引用让Terraform能够识别资源依赖关系。</p>
<p>直接位于配置文件最外层的块，叫做顶级块（Top-level Block），Terraform支持有限种类的顶级块。大部分Terraform特性，例如resource，基于顶级块实现。</p>
<p>下面是一个例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">resource <span class="s2">&#34;aws_vpc&#34;</span> <span class="s2">&#34;main&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">cidr_block</span> <span class="o">=</span> var.base_cidr_block
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="2数据类型">2、数据类型</h3>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td>Unicode字符序列，基本形式 &ldquo;hello&rdquo;</td>
</tr>
<tr>
<td>number</td>
<td>数字，形式 6.02</td>
</tr>
<tr>
<td>bool</td>
<td><strong>true</strong>或 <strong>false</strong></td>
</tr>
<tr>
<td>list/tuple</td>
<td>一系列的值，形式 [&ldquo;us-west-1a&rdquo;, &ldquo;us-west-1c&rdquo;]</td>
</tr>
<tr>
<td>map/object</td>
<td>键值对，形式 {name = &ldquo;Mabel&rdquo;, age = 52}</td>
</tr>
</tbody>
</table>
<h3 id="3空值">3、空值</h3>
<p>空值使用 <strong>null</strong>表示。</p>
<h4 id="4字符串和模板">4、字符串和模板</h4>
<h4 id="转义字符">转义字符</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="se">\n</span> 换行
</span></span><span class="line"><span class="cl"><span class="se">\r</span> 回车
</span></span><span class="line"><span class="cl"><span class="se">\t</span> 制表
</span></span><span class="line"><span class="cl"><span class="se">\&#34;</span> 引号
</span></span><span class="line"><span class="cl"><span class="se">\\</span> 反斜杠
</span></span><span class="line"><span class="cl"><span class="se">\u</span>NNNN Unicode字符
</span></span><span class="line"><span class="cl"><span class="se">\U</span>NNNNNNNN Unicode字符
</span></span></code></pre></div><p>注意，在Heredoc中反斜杠不用于转义，可以使用：</p>
<p>$${ 字符串插值标记${
%%{ 模板指令标记%{</p>
<p>支持unix风格的字符串</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">block <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">value</span> <span class="o">=</span> <span class="s">&lt;&lt;EOT
</span></span></span><span class="line"><span class="cl"><span class="s">hello
</span></span></span><span class="line"><span class="cl"><span class="s">world
</span></span></span><span class="line"><span class="cl"><span class="s">EOT</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">block <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">value</span> <span class="o">=</span> <span class="s">&lt;&lt;-EOT
</span></span></span><span class="line"><span class="cl"><span class="s">  hello
</span></span></span><span class="line"><span class="cl"><span class="s">    world
</span></span></span><span class="line"><span class="cl"><span class="s">  EOT</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>要将对象转换为JSON或YAML，可以调用函数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">example</span> <span class="o">=</span> jsonencode<span class="o">({</span>
</span></span><span class="line"><span class="cl">    <span class="nv">a</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="nv">b</span> <span class="o">=</span> <span class="s2">&#34;hello&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">})</span>
</span></span></code></pre></div><h3 id="5操作符">5、操作符</h3>
<p>逻辑操作符： ! &amp;&amp; ||
算数操作符： * / % + -
比较操作符： &gt;, &gt;=, &lt;, &lt;= ==, !=</p>
<h4 id="条件表达式">条件表达式</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">condition ? true_val : false_val
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">var.a !<span class="o">=</span> <span class="s2">&#34;&#34;</span> ? var.a : <span class="s2">&#34;default-a&#34;</span>
</span></span></code></pre></div><h4 id="for表达式">for表达式</h4>
<p>使用for表达式可以通过转换一种复杂类型输出，生成另一个复杂类型结果。输入中的每个元素，可以对应结果的0-1个元素。任何表达式可以用于转换，下面是使用upper函数将列表转换为大写：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span><span class="k">for</span> s in var.list : upper<span class="o">(</span>s<span class="o">)]</span>
</span></span></code></pre></div><h4 id="输入类型">输入类型</h4>
<p>作为for表达式的输入的类型可以是list / set / tuple / map / object。可以为for声明两个临时符号，前一个表示index或key：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span><span class="k">for</span> k, v in var.map : length<span class="o">(</span>k<span class="o">)</span> + length<span class="o">(</span>v<span class="o">)]</span>
</span></span></code></pre></div><h4 id="结果类型">结果类型</h4>
<p>结果的类型取决于包围for表达式的定界符：</p>
<p>[] 表示生成的结果是元组
{} 表示生成的结果是object，你必须使用<code> =&gt;</code>符号：<code> {for s in var.list : s =&gt; upper(s)}</code></p>
<h4 id="输入过滤">输入过滤</h4>
<p>包含一个可选的if子句可以对输入元素进行过滤：<code> [for s in var.list : upper(s) if s != &quot;&quot;]</code></p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">variable <span class="s2">&#34;users&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">type</span> <span class="o">=</span> map<span class="o">(</span>object<span class="o">({</span>
</span></span><span class="line"><span class="cl">    <span class="nv">is_admin</span> <span class="o">=</span> boolean
</span></span><span class="line"><span class="cl">  <span class="o">}))</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">locals <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">admin_users</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> name, user in var.users : <span class="nv">name</span> <span class="o">=</span>&gt; user
</span></span><span class="line"><span class="cl">    <span class="k">if</span> user.is_admin
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="splat表达式">splat表达式</h4>
<p>splat表达式提供了更简单语法，在某些情况下代替for表达式：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span><span class="k">for</span> o in var.list : o.id<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 等价于</span>
</span></span><span class="line"><span class="cl">var.list<span class="o">[</span>*<span class="o">]</span>.id
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="o">[</span><span class="k">for</span> o in var.list : o.interfaces<span class="o">[</span>0<span class="o">]</span>.name<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 等价于</span>
</span></span><span class="line"><span class="cl">var.list<span class="o">[</span>*<span class="o">]</span>.interfaces<span class="o">[</span>0<span class="o">]</span>.name
</span></span></code></pre></div><h4 id="可选object属性">可选object属性</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">variable <span class="s2">&#34;with_optional_attribute&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">type</span> <span class="o">=</span> object<span class="o">({</span>
</span></span><span class="line"><span class="cl">    <span class="nv">a</span> <span class="o">=</span> string           <span class="c1"># 必须属性</span>
</span></span><span class="line"><span class="cl">    <span class="nv">b</span> <span class="o">=</span> optional<span class="o">(</span>string<span class="o">)</span> <span class="c1"># 可选属性</span>
</span></span><span class="line"><span class="cl">  <span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="版本约束">版本约束</h4>
<p>版本约束是一个特殊的字符串值，在引用module、使用provider时，或者通过terraform块的required_version时，需要用到版本约束：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 版本范围区间</span>
</span></span><span class="line"><span class="cl"><span class="nv">version</span> <span class="o">=</span> <span class="s2">&#34;&gt;= 1.2.0, &lt; 2.0.0&#34;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 操作符</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span>   等价于无操作符，限定特定版本
</span></span><span class="line"><span class="cl">!<span class="o">=</span>  排除特定版本
</span></span><span class="line"><span class="cl">&gt; &gt;<span class="o">=</span> &lt; &lt;<span class="o">=</span> 限制版本范围
</span></span><span class="line"><span class="cl">~&gt;  允许最右侧的版本号片段的变化
</span></span></code></pre></div><h4 id="depends_on">depends_on</h4>
<p>该元参数用于处理隐含的资源/模块依赖，这些依赖无法通过分析Terraform配置文件得到。从0.13版本开始，该元参数可用于模块。之前的版本仅仅用于资源。</p>
<p>depends_on的值是一个列表，其元素具必须是其它资源的引用，不支持任意表达式。</p>
<p>depends_on应当仅仅用作最后手段，避免滥用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">resource <span class="s2">&#34;aws_iam_role&#34;</span> <span class="s2">&#34;example&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">name</span> <span class="o">=</span> <span class="s2">&#34;example&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">assume_role_policy</span> <span class="o">=</span> <span class="s2">&#34;...&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 这个策略允许运行在EC2中的实例访问S3 API</span>
</span></span><span class="line"><span class="cl">resource <span class="s2">&#34;aws_iam_role_policy&#34;</span> <span class="s2">&#34;example&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">name</span>   <span class="o">=</span> <span class="s2">&#34;example&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">role</span>   <span class="o">=</span> aws_iam_role.example.name
</span></span><span class="line"><span class="cl">  <span class="nv">policy</span> <span class="o">=</span> jsonencode<span class="o">({</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Statement&#34;</span> <span class="o">=</span> <span class="o">[{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;Action&#34;</span> <span class="o">=</span> <span class="s2">&#34;s3:*&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;Effect&#34;</span> <span class="o">=</span> <span class="s2">&#34;Allow&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="o">}]</span>,
</span></span><span class="line"><span class="cl">  <span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">resource <span class="s2">&#34;aws_iam_instance_profile&#34;</span> <span class="s2">&#34;example&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 这是可以自动分析出的依赖</span>
</span></span><span class="line"><span class="cl">  <span class="nv">role</span> <span class="o">=</span> aws_iam_role.example.name
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">resource <span class="s2">&#34;aws_instance&#34;</span> <span class="s2">&#34;example&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">ami</span>           <span class="o">=</span> <span class="s2">&#34;ami-a1b2c3d4&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">instance_type</span> <span class="o">=</span> <span class="s2">&#34;t2.micro&#34;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1"># 这是可以自动分析出的依赖，包括传递性依赖</span>
</span></span><span class="line"><span class="cl">  <span class="nv">iam_instance_profile</span> <span class="o">=</span> aws_iam_instance_profile.example
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1"># 如果这个实例中的程序需要访问S3接口，我们需要用元参数显式的声明依赖</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 从而分配策略</span>
</span></span><span class="line"><span class="cl">  <span class="nv">depends_on</span> <span class="o">=</span> <span class="o">[</span>
</span></span><span class="line"><span class="cl">    aws_iam_role_policy.example,
</span></span><span class="line"><span class="cl">  <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span> 
</span></span></code></pre></div><h4 id="count">count</h4>
<p>默认情况下，一个resource块代表单个云上基础设施对象。如果你想用一个resource块生成多个类似的资源，可以用count或for_each参数。</p>
<p>设置了此元参数的上下文中，可以访问名为 count的变量，它具有属性 index，为从0开始计数的资源实例索引。 示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">resource <span class="s2">&#34;aws_instance&#34;</span> <span class="s2">&#34;server&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 创建4个类似的实例</span>
</span></span><span class="line"><span class="cl">  <span class="nv">count</span> <span class="o">=</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="nv">ami</span>           <span class="o">=</span> <span class="s2">&#34;ami-a1b2c3d4&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">instance_type</span> <span class="o">=</span> <span class="s2">&#34;t2.micro&#34;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="nv">tags</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#              实例的索引作为tag的一部分</span>
</span></span><span class="line"><span class="cl">    <span class="nv">Name</span> <span class="o">=</span> <span class="s2">&#34;Server </span><span class="si">${</span><span class="nv">count</span><span class="p">.index</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="for_each">for_each</h3>
<p>如果资源的规格几乎完全一致，可以用count，否则，需要使用更加灵活的for_each元参数。</p>
<p>for_each的值必须是一个映射或set(string)，你可以在上下文中访问 <strong>each</strong>对象， 它具有 key和 value两个属性，如果for_each的值是集合，则key和value相等。示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">resource <span class="s2">&#34;azurerm_resource_group&#34;</span> <span class="s2">&#34;rg&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">for_each</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">a_group</span> <span class="o">=</span> <span class="s2">&#34;eastus&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">another_group</span> <span class="o">=</span> <span class="s2">&#34;westus2&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 对于每个键值对都会生成azurerm_resource_group资源</span>
</span></span><span class="line"><span class="cl">  <span class="nv">name</span>     <span class="o">=</span> each.key
</span></span><span class="line"><span class="cl">  <span class="nv">location</span> <span class="o">=</span> each.value
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">resource <span class="s2">&#34;aws_iam_user&#34;</span> <span class="s2">&#34;the-accounts&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 数组转换为集合</span>
</span></span><span class="line"><span class="cl">  <span class="nv">for_each</span> <span class="o">=</span> toset<span class="o">(</span> <span class="o">[</span><span class="s2">&#34;Todd&#34;</span>, <span class="s2">&#34;James&#34;</span>, <span class="s2">&#34;Alice&#34;</span>, <span class="s2">&#34;Dottie&#34;</span><span class="o">]</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="nv">name</span>     <span class="o">=</span> each.key
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">variable <span class="s2">&#34;vpcs&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 这里定义了map类型的变量，并且限定了map具有的键</span>
</span></span><span class="line"><span class="cl">  <span class="nb">type</span> <span class="o">=</span> map<span class="o">(</span>object<span class="o">({</span>
</span></span><span class="line"><span class="cl">    <span class="nv">cidr_block</span> <span class="o">=</span> string
</span></span><span class="line"><span class="cl">  <span class="o">}))</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 创建多个VPC资源</span>
</span></span><span class="line"><span class="cl">resource <span class="s2">&#34;aws_vpc&#34;</span> <span class="s2">&#34;example&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">for_each</span> <span class="o">=</span> var.vpcs
</span></span><span class="line"><span class="cl">  <span class="nv">cidr_block</span> <span class="o">=</span> each.value.cidr_block
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 上述资源作为下面那个for_each的值</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 创建对应数量的网关资源</span>
</span></span><span class="line"><span class="cl">resource <span class="s2">&#34;aws_internet_gateway&#34;</span> <span class="s2">&#34;example&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 为每个VPC创建一个网关</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#          资源作为值</span>
</span></span><span class="line"><span class="cl">  <span class="nv">for_each</span> <span class="o">=</span> aws_vpc.example
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1"># 映射的值，在这里是完整的VPC对象</span>
</span></span><span class="line"><span class="cl">  <span class="nv">vpc_id</span> <span class="o">=</span> each.value.id
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 输出所有VPC ID</span>
</span></span><span class="line"><span class="cl">output <span class="s2">&#34;vpc_ids&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">value</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> k, v in aws_vpc.example : <span class="nv">k</span> <span class="o">=</span>&gt; v.id
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1"># 显式依赖网关资源，确保网关创建后，输出才可用</span>
</span></span><span class="line"><span class="cl">  <span class="nv">depends_on</span> <span class="o">=</span> <span class="o">[</span>aws_internet_gateway.example<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-11-22</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/tf/">tf</a>,&nbsp;<a href="/tags/terraform/">terraform</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/2023-11-20-timezone/" class="prev" rel="prev" title="Timezone"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Timezone</a>
            <a href="/posts/2023-11-22-python-basic/" class="next" rel="next" title="Python basic">Python basic<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">serialt</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":80},"comment":{},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
