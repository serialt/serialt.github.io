<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Go boltdb - Blog</title><meta name="Description" content="This is my cool site"><meta property="og:title" content="Go boltdb" />
<meta property="og:description" content="GO 文件数据库boltdb github地址: https://github.com/etcd-io/bbolt https://github.com/boltdb/bolt 由于作者个人能力有限，宣布不再维护，建议使用社区维护的bbolt 参考：https://zhua" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://serialt.github.io/posts/2024-06-02-go-boltdb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-06-02T10:25:01+08:00" />
<meta property="article:modified_time" content="2024-06-02T10:25:01+08:00" /><meta property="og:site_name" content="Log" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go boltdb"/>
<meta name="twitter:description" content="GO 文件数据库boltdb github地址: https://github.com/etcd-io/bbolt https://github.com/boltdb/bolt 由于作者个人能力有限，宣布不再维护，建议使用社区维护的bbolt 参考：https://zhua"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://serialt.github.io/posts/2024-06-02-go-boltdb/" /><link rel="prev" href="https://serialt.github.io/posts/2024-05-27-linux-lvm/" /><link rel="next" href="https://serialt.github.io/posts/2024-06-02-go-flag/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Go boltdb",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/serialt.github.io\/posts\/2024-06-02-go-boltdb\/"
        },"genre": "posts","keywords": "Go, bolt","wordcount":  7765 ,
        "url": "https:\/\/serialt.github.io\/posts\/2024-06-02-go-boltdb\/","datePublished": "2024-06-02T10:25:01+08:00","dateModified": "2024-06-02T10:25:01+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "serialt"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Blog">记录</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Blog">记录</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Go boltdb</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>serialt</a></span>&nbsp;<span class="post-category">included in <a href="/categories/go-%E5%BA%93%E6%96%87%E6%A1%A3/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Go 库文档</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2024-06-02">2024-06-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;7765 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;16 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#go-文件数据库boltdb">GO 文件数据库boltdb</a>
      <ul>
        <li><a href="#1介绍">1、介绍</a></li>
        <li><a href="#2使用示例">2、使用示例：</a></li>
        <li><a href="#3事务">3、事务</a></li>
        <li><a href="#4存储与buckets">4、存储与buckets</a></li>
        <li><a href="#5高级用法">5、高级用法</a></li>
        <li><a href="#6扩展阅读">6、扩展阅读</a></li>
        <li><a href="#7与其他数据库的比较">7、与其他数据库的比较</a></li>
        <li><a href="#7注意事项和局限性">7、注意事项和局限性</a></li>
      </ul>
    </li>
    <li><a href="#阅读资料">阅读资料</a></li>
    <li><a href="#其他使用bolt的项目">其他使用Bolt的项目</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="go-文件数据库boltdb">GO 文件数据库boltdb</h2>
<p>github地址:</p>
<ul>
<li><a href="https://github.com/etcd-io/bbolt" target="_blank" rel="noopener noreffer ">https://github.com/etcd-io/bbolt</a></li>
<li><a href="https://github.com/boltdb/bolt" target="_blank" rel="noopener noreffer ">https://github.com/boltdb/bolt</a></li>
</ul>
<p>由于作者个人能力有限，宣布不再维护，建议使用社区维护的bbolt</p>
<p>参考：https://zhuanlan.zhihu.com/p/84988890</p>
<p>使用</p>
<pre tabindex="0"><code>go get go.etcd.io/bbolt/...
</code></pre><h3 id="1介绍">1、介绍</h3>
<p>BoltDB是纯Go语言实现的持久化解决方案，保存数据至内存映射文件。称之为持久化解决方案不是数据库，因为数据库这个词有很多额外功能是bolt所不具备的。正是因为缺乏这些功能使得bolt如此优雅、好用。</p>
<p>Bolt就是一个Go包。无需在系统中安装，开始编码前也无需配置，什么都不需要，仅需要go get github.com/boltdb/bolt，然后import “github.com/boltdb/bolt”。</p>
<p>要完全使用bolt的存储功能，只需要一个文件名。无论从开发者或用户视角都感觉不可思议。不知你的感想如何，在我的工作经历中花过很多时间搭建数据库环境，调试配置问题，用户和权限以及其他各种问题，如关系型数据库PostgreSql、Oracle和NoSQL。这些bolt都不需要，没有用户、无需安装，仅一个文件名。这对应用程序的用户来说也是一种恩惠，因为他们也不必为那些麻烦问题而瞎折腾。</p>
<p>Bolt不是关系型数据库。甚至不存储文档，虽然你可以按照这种方式使用它。其仅仅存储键值对…但是如果你不知道这是什么意思或者不知道你如何使用它进行存储，也不用担心。它超级简单，而且非常灵活，让我们来看看。</p>
<h3 id="2使用示例">2、使用示例：</h3>
<p>bolt存储是分组为桶，桶是一组键值对集合的名称，就像Go中的map。桶的名称、键以及值都是[]byte类型。桶可以包括其他桶，也可以通过[]byte类型名称作为key。</p>
<p>Bolt基本上是一组嵌套映射。这种简单性使得它易于使用。不需要设置表、模式、复杂的查询语言。</p>
<p>1）创建和打开一个数据库</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">bolt</span> <span class="s">&#34;go.etcd.io/bbolt&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Open the my.db data file in your current directory.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// It will be created if it doesn&#39;t exist.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">bolt</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;my.db&#34;</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>这里到 db 不支持多链接。这是因为对于 database file 一个链接保持了一个文件锁 <code>file lock</code>。如果并发，后续链接会阻塞。可以为单个链接添加 超时控制</p>
<pre tabindex="0"><code>db, err := bolt.Open(&#34;my.db&#34;, 0600, &amp;bolt.Options{Timeout: 1 * time.Second})
</code></pre><h3 id="3事务">3、事务</h3>
<h4 id="并发读写">并发读写</h4>
<p>同时只能有</p>
<ul>
<li>一个读写事务</li>
<li>多个只读事务</li>
</ul>
<p>注意：在事务开始时，会保持一个数据视图 <code>这意味着事务处理过程中不会由于别处更改而改变</code></p>
<h4 id="线程安全">线程安全</h4>
<p>单个事务和它所创建的所有对象（桶，键）都不是线程安全的。</p>
<p>建议加锁 或者 每一个 goroutine 并发都开启 一个 事务</p>
<p>当然，从 <code>db</code> 这个 bbolt 的顶级结构创建 事务 是 线程安全 的</p>
<h4 id="死锁">死锁</h4>
<p>前面提到的 读写事务 和 只读事务 拒绝相互依赖。当然也不能在同一个 goroutine 里。</p>
<p>死锁原因是 读写事务 需要周期性重新映射 data 文件（即<code>database</code>）。这在开启只读事务时是不可行的。</p>
<h4 id="读写事务">读写事务</h4>
<p>使用 <code>db.Update</code>开启一个读写事务</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">···</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><p>上文提过，在一个事务中 ，数据视图是一样的。 （详细解释就是，在这个函数作用域中，数据对你呈现最终一致性）</p>
<h4 id="返回值">返回值</h4>
<p>bboltdb 根据你的返回值判断事务状态，你可以添加任意逻辑并认为出错时返回 <code>return err</code> bboltdb 会回滚，如果 <code>return nil</code> 则提交你的事务。</p>
<p>建议永远检查 <code>Update</code> 的返回值，因为他会返回如 硬盘压力 等造成事务失败的信息（这是在你的逻辑之外的情况）</p>
<p>注意：你自定义返回 error 的 error 信息同样会被传递出来。</p>
<h4 id="只读事务">只读事务</h4>
<p>使用 <code>db.View</code> 来新建一个 只读事务</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">View</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">···</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><p>同上，你会获得一个一致性的数据视图。</p>
<p>当然，只读事务 只能检索信息，不会有任何更改。（btw,但是你可以 copy 一个 database 的副本，毕竟这只需要读数据）</p>
<h4 id="批量读写事务">批量读写事务</h4>
<p>读写事务 <code>db.Update</code> 最后需要对 <code>database</code>提交更改，这会等待硬盘就绪。</p>
<p>每一次文件读写都是和磁盘交互。这不是一个小开销。</p>
<p>你可以使用 <code>db.Batch</code> 开启一个 批处理事务。他会在最后批量提交（其实是多个 goroutines 开启 <code>db.Batch</code> 事务时有机会合并之后一起提交）从而减小了开销。 ⚠️：<code>db.Batch</code> 只对 goroutine 起效</p>
<p>使用 批处理事务 需要做取舍，用 幂等函数 换取 速度 ⚠️： <code>db.Batch</code> 在一部分事务失败的时候会尝试多次调用那些事务函数，如果不是幂等会造成不可预知的非最终一致性。</p>
<p>例：使用事务外的变量来使你的日志不那么奇怪</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">id</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl"><span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Batch</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Find last key in bucket, decode as bigendian uint64, increment
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// by one, encode back to []byte, and add new key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">id</span> <span class="p">=</span> <span class="nx">newValue</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Allocated ID %d&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
</span></span></code></pre></div><h4 id="手动事务">手动事务</h4>
<p>可以手动进行事务的 开启 ，回滚，新建对象，提交等操作。因为本身 <code>db.Update</code> 和 <code>db.View</code> 就是他们的包装 ⚠️：手动事务记得 关闭 （Close）</p>
<p>开启事务使用 <code>db.Begin(bool)</code> 同时参数代表着是否可以写操作。如下：</p>
<ul>
<li>true - 读写事务</li>
<li>false - 只读事务</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Start a writable transaction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">tx</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Begin</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">defer</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Rollback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Use the transaction...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">CreateBucket</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;MyBucket&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Commit the transaction and check for error.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Commit</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="4存储与buckets">4、存储与buckets</h3>
<h4 id="bucket">bucket</h4>
<p>桶是键值对的集合。在一个桶中，键值唯一。</p>
<p>1）创建bucket</p>
<p>使用 <code>Tx.CreateBucket()</code> 和 <code>Tx.CreateBucketIfNotExists()</code> 建立一个新桶（推荐使用第二个） 接受参数是桶的名字</p>
<p>2）删除</p>
<p>使用 <code>Tx.DeleteBucket()</code> 根据桶的名字来删除</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">bbolt</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;./data&#34;</span><span class="p">,</span> <span class="mo">0666</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">db</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bbolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">b</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">CreateBucketIfNotExists</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;MyBucket&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;create bucket: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">DeleteBucket</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;MyBucket&#34;</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>2）KV存储</p>
<p><code>Put</code>: 使用<code>Bucket.Put()</code>来存储键值对，接收两个 <code>[]byte</code> 类型的参数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Bucket</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;MyBucket&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Put</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;answer&#34;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;42&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><p><code>Get</code>: 使用 <code>Bucket.Get()</code> 来查询键值。参数是一个 <code>[]byte</code>（别忘了这次我们只是查询，可以使用 只读事务）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nf">View</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Bucket</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;MyBucket&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">v</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Get</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;answer&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;The answer is: %s\n&#34;</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><p>细心会注意到，<code>Get</code>是不会返回 <code>error</code> 的，这是因为 <code>Get()</code> 一定能正常工作（除非系统错误），相应的，当返回 <code>nil</code> 时，查询的键值对不存在。 ⚠️：注意 0 长度的值 和 不存在键值对 的行为是不一样的。（一个返回是 nil， 一个不是）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">bolt</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;./data.db&#34;</span><span class="p">,</span> <span class="mo">0666</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">b</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">CreateBucketIfNotExists</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;MyBucket&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;create bucket: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Put</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;answer&#34;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;42&#34;</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Put</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;zero&#34;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">db</span><span class="p">.</span><span class="nf">View</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">b</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Bucket</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;MyBucket&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">v</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Get</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;noexists&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">DeepEqual</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="kc">nil</span><span class="p">))</span> <span class="c1">// false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">v</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span>                  <span class="c1">// true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="nx">v</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Get</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;zero&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">DeepEqual</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="kc">nil</span><span class="p">))</span> <span class="c1">// false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">v</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span>                  <span class="c1">// true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>Delete</code>: 使用 <code>Bucket.Delete()</code> 删除键值对</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nf">View</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Bucket</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;MyBucket&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nf">Get</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;answer&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Delete</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;answer&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><p>⚠️： <code>Get()</code> 获取到的字节切片值只在当前事务（当前函数作用域）有效，如果要在其他事务中使用需要使用 <code>copy()</code> 将其拷贝到其他的字节切片</p>
<h4 id="tricks-桶的自增键">Tricks: 桶的自增键</h4>
<p>使用 <code>NextSequence()</code>来创建自增键，见下例</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// CreateUser saves u to the store. The new user ID is set on u once the data is persisted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Store</span><span class="p">)</span> <span class="nf">CreateUser</span><span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">User</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Retrieve the users bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// This should be created when the DB is first opened.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">b</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Bucket</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;users&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Generate ID for the user.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// This returns an error only if the Tx is closed or not writeable.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// That can&#39;t happen in an Update() call so I ignore the error check.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">id</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">NextSequence</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u</span><span class="p">.</span><span class="nx">ID</span> <span class="p">=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Marshal user data into bytes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">buf</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">u</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Persist bytes to users bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nf">itob</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">ID</span><span class="p">),</span> <span class="nx">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// itob returns an 8-byte big endian representation of v.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">itob</span><span class="p">(</span><span class="nx">v</span> <span class="kt">int</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">binary</span><span class="p">.</span><span class="nx">BigEndian</span><span class="p">.</span><span class="nf">PutUint64</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">v</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">b</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ID</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="嵌套桶">嵌套桶</h4>
<p>很简单的，桶可以实现嵌套存储</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">Bucket</span><span class="p">)</span> <span class="nf">CreateBucket</span><span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Bucket</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">Bucket</span><span class="p">)</span> <span class="nf">CreateBucketIfNotExists</span><span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Bucket</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">Bucket</span><span class="p">)</span> <span class="nf">DeleteBucket</span><span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span>
</span></span></code></pre></div><p>例子：假设您有一个多租户应用程序，其中根级别存储桶是帐户存储桶。该存储桶内部有一系列帐户的序列，这些帐户本身就是存储桶。在序列存储桶（子桶）中，可能有许多相关的存储桶（Users，Note等）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// createUser creates a new user in the given account.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">createUser</span><span class="p">(</span><span class="nx">accountID</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">u</span> <span class="o">*</span><span class="nx">User</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Start the transaction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">tx</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Begin</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Rollback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Retrieve the root bucket for the account.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Assume this has already been created when the account was set up.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">root</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Bucket</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">strconv</span><span class="p">.</span><span class="nf">FormatUint</span><span class="p">(</span><span class="nx">accountID</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Setup the users bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bkt</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">root</span><span class="p">.</span><span class="nf">CreateBucketIfNotExists</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;USERS&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Generate an ID for the new user.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">userID</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">bkt</span><span class="p">.</span><span class="nf">NextSequence</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u</span><span class="p">.</span><span class="nx">ID</span> <span class="p">=</span> <span class="nx">userID</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Marshal and save the encoded user.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">buf</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">u</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">bkt</span><span class="p">.</span><span class="nf">Put</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">strconv</span><span class="p">.</span><span class="nf">FormatUint</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span> <span class="nx">buf</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Commit the transaction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Commit</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="遍历键值">遍历键值</h4>
<p>在桶中，键值对根据 键 的 值是有字节序的。 使用 <code>Bucket.Cursor()</code>对其进行迭代</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nf">View</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Assume bucket exists and has keys
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">b</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Bucket</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;MyBucket&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">First</span><span class="p">();</span> <span class="nx">k</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;key=%s, value=%s\n&#34;</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><p>Cursor 有 5 种方法进行迭代</p>
<ol>
<li><code>First()</code> Move to the first key.</li>
<li><code>Last()</code> Move to the last key.</li>
<li><code>Seek()</code> Move to a specific key.</li>
<li><code>Next()</code> Move to the next key.</li>
<li><code>Prev()</code> Move to the previous key.</li>
</ol>
<p>每一个方法都返回 <code>(key []byte, value []byte)</code> 两个值 当方法所指值不存在时返回 两个 <code>nil</code> 值，发生在以下情况：</p>
<ol>
<li>迭代到最后一个键值对时，再一次调用 <code>Cursor.Next()</code></li>
<li>当前所指为第一个键值对时，调用 <code>Cursor.Prev()</code></li>
<li>当使用 4.<code>Next()</code> 和 5. <code>Prev()</code>方法而未使用 1.<code>First()</code> 2.<code>Last()</code> 3. <code>Seek()</code>指定初始位置时</li>
</ol>
<p>⚠️特殊情况：当 <code>key</code> 为 非 <code>nil</code> 但 <code>value</code> 是 <code>nil</code> 是，说明这是嵌套桶，<code>value</code> 值是子桶，使用 <code>Bucket.Bucket()</code> 方法访问 子桶，参数是 <code>key</code> 值</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nf">View</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nf">First</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Prev</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">k</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">v</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span> <span class="c1">// true,true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">k</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">v</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">subBucket</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Bucket</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// doanything
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><h4 id="前缀遍历">前缀遍历</h4>
<p>通过使用 <code>Cursor</code>我们能够做到一些特殊的遍历，如：遍历拥有特定前缀的 键值对</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nf">View</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Assume bucket exists and has keys
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Bucket</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;MyBucket&#34;</span><span class="p">)).</span><span class="nf">Cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">prefix</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;1234&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Seek</span><span class="p">(</span><span class="nx">prefix</span><span class="p">);</span> <span class="nx">k</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">);</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;key=%s, value=%s\n&#34;</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><h4 id="范围遍历">范围遍历</h4>
<p>在一个范围里遍历，如：使用可排序的时间编码（RFC3339）可以遍历特定日期范围的数据</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nf">View</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Assume our events bucket exists and has RFC3339 encoded time keys.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Bucket</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;Events&#34;</span><span class="p">)).</span><span class="nf">Cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Our time range spans the 90&#39;s decade.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">min</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;1990-01-01T00:00:00Z&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">max</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;2000-01-01T00:00:00Z&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Iterate over the 90&#39;s.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Seek</span><span class="p">(</span><span class="nx">min</span><span class="p">);</span> <span class="nx">k</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">max</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s: %s\n&#34;</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><p>⚠️：Golang 实现的 RFC3339Nano 是不可排序的</p>
<h4 id="foreach">ForEach</h4>
<p>在桶中有值的情况下，可以使用 <code>ForEach()</code>遍历</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nf">View</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Assume bucket exists and has keys
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">b</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Bucket</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;MyBucket&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nf">ForEach</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;key=%s, value=%s\n&#34;</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><p>⚠️：在 <code>ForEach()</code>中遍历的键值对需要<code>copy()</code>到事务外才能在事务外使用</p>
<h3 id="5高级用法">5、高级用法</h3>
<p>boltdb 是一个单一的文件，所以很容易备份。你可以使用<code>Tx.writeto()</code>函数写一致的数据库。如果从只读事务调用这个函数，它将执行热备份，而不会阻塞其他数据库的读写操作。</p>
<p>默认情况下，它将使用一个常规文件句柄，该句柄将利用操作系统的页面缓存。</p>
<p>有关优化大于RAM数据集的信息，请参见<code>Tx</code>文档。</p>
<p>一个常见的用例是在HTTP上进行备份，这样您就可以使用像<code>cURL</code>这样的工具来进行数据库备份：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">BackupHandleFunc</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">View</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="s">&#34;application/octet-stream&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Disposition&#34;</span><span class="p">,</span> <span class="s">`attachment; filename=&#34;my.db&#34;`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Length&#34;</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nf">Size</span><span class="p">())))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">WriteTo</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">http</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(),</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>然后您可以使用此命令进行备份：</p>
<pre tabindex="0"><code>$ curl http://localhost/backup &gt; my.db
</code></pre><p>或者你可以打开你的浏览器以<a href="https://link.zhihu.com/?target=http%3A//localhost/backup" target="_blank" rel="noopener noreffer ">http://localhost/backup</a>，它会自动下载。</p>
<p>如果你想备份到另一个文件，你可以使用<code>TX.copyfile()</code>辅助功能。</p>
<h4 id="statistics">Statistics</h4>
<p>数据库对运行的许多内部操作保持一个运行计数，这样您就可以更好地了解发生了什么。通过捕捉两个时间点数据的快照，我们可以看到在这个时间范围内执行了哪些操作。</p>
<p>例如，我们可以用一个 goroutine 里记录统计每一个 10 秒：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Grab the initial stats.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">prev</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Stats</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Wait for 10s.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Grab the current stats and diff them.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">stats</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Stats</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">diff</span> <span class="o">:=</span> <span class="nx">stats</span><span class="p">.</span><span class="nf">Sub</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">prev</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Encode stats to JSON and print to STDERR.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">json</span><span class="p">.</span><span class="nf">NewEncoder</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">).</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">diff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Save stats for the next loop.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">prev</span> <span class="p">=</span> <span class="nx">stats</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}()</span>
</span></span></code></pre></div><p>将这些信息通过管道输出到监控也很有用。</p>
<h4 id="read-only-mode">Read-Only Mode</h4>
<p>可以开启只读模式防止错误更改</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">bolt</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;my.db&#34;</span><span class="p">,</span> <span class="mo">0666</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span><span class="nx">ReadOnly</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>现在使用 <code>db.Update()</code> 等开启读写事务 将会阻塞</p>
<h4 id="mobile-use">Mobile Use</h4>
<p>移动端支持由 <a href="https://link.zhihu.com/?target=https%3A//github.com/golang/mobile" target="_blank" rel="noopener noreffer ">gomobile</a> 工具提供</p>
<p>Create a struct that will contain your database logic and a reference to a <code>*bolt.DB</code> with a initializing constructor that takes in a filepath where the database file will be stored. Neither Android nor iOS require extra permissions or cleanup from using this method.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewBoltDB</span><span class="p">(</span><span class="nx">filepath</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">BoltDB</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">bolt</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">filepath</span><span class="o">+</span><span class="s">&#34;/demo.db&#34;</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="o">&amp;</span><span class="nx">BoltDB</span><span class="p">{</span><span class="nx">db</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">BoltDB</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nx">db</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">DB</span>
</span></span><span class="line"><span class="cl"> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">BoltDB</span><span class="p">)</span> <span class="nf">Path</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">Path</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">BoltDB</span><span class="p">)</span> <span class="nf">Close</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nx">b</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Database logic should be defined as methods on this wrapper struct. To initialize this struct from the native language (both platforms now sync their local storage to the cloud. These snippets disable that functionality for the database file):</p>
<h4 id="android">Android</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span> <span class="n">path</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">LOLLIPOP</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="n">getNoBackupFilesDir</span><span class="o">().</span><span class="na">getAbsolutePath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="n">getFilesDir</span><span class="o">().</span><span class="na">getAbsolutePath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Boltmobiledemo</span><span class="o">.</span><span class="na">BoltDB</span> <span class="n">boltDB</span> <span class="o">=</span> <span class="n">Boltmobiledemo</span><span class="o">.</span><span class="na">NewBoltDB</span><span class="o">(</span><span class="n">path</span><span class="o">)</span>
</span></span></code></pre></div><h4 id="ios">iOS</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">demo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NSString</span><span class="o">*</span> <span class="n">path</span> <span class="p">=</span> <span class="p">[</span><span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSLibraryDirectory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                          <span class="n">NSUserDomainMask</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                          <span class="n">YES</span><span class="p">)</span> <span class="n">objectAtIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"> <span class="n">GoBoltmobiledemoBoltDB</span> <span class="o">*</span> <span class="n">demo</span> <span class="p">=</span> <span class="n">GoBoltmobiledemoNewBoltDB</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">[</span><span class="kc">self</span> <span class="n">addSkipBackupAttributeToItemAtPath</span><span class="p">:</span><span class="n">demo</span><span class="p">.</span><span class="n">path</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"> <span class="c1">//Some DB Logic would go here</span>
</span></span><span class="line"><span class="cl"> <span class="p">[</span><span class="n">demo</span> <span class="n">close</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">addSkipBackupAttributeToItemAtPath</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span> <span class="n">filePathString</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NSURL</span><span class="o">*</span> <span class="n">URL</span><span class="p">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="n">fileURLWithPath</span><span class="p">:</span> <span class="n">filePathString</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="bp">assert</span><span class="p">([[</span><span class="n">NSFileManager</span> <span class="n">defaultManager</span><span class="p">]</span> <span class="n">fileExistsAtPath</span><span class="p">:</span> <span class="p">[</span><span class="n">URL</span> <span class="n">path</span><span class="p">]]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span> <span class="n">success</span> <span class="p">=</span> <span class="p">[</span><span class="n">URL</span> <span class="n">setResourceValue</span><span class="p">:</span> <span class="p">[</span><span class="n">NSNumber</span> <span class="n">numberWithBool</span><span class="p">:</span> <span class="n">YES</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">forKey</span><span class="p">:</span> <span class="n">NSURLIsExcludedFromBackupKey</span> <span class="n">error</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">error</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">NSLog</span><span class="p">(@</span><span class="s">&#34;Error excluding %@ from backup %@&#34;</span><span class="p">,</span> <span class="p">[</span><span class="n">URL</span> <span class="n">lastPathComponent</span><span class="p">],</span> <span class="n">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">success</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="6扩展阅读">6、扩展阅读</h3>
<h4 id="更多指导">更多指导</h4>
<p>For more information on getting started with Bolt, check out the following articles:</p>
<ul>
<li><a href="https://link.zhihu.com/?target=http%3A//npf.io/2014/07/intro-to-boltdb-painless-performant-persistence/" target="_blank" rel="noopener noreffer ">Intro to BoltDB: Painless Performant Persistence</a> by <a href="https://link.zhihu.com/?target=https%3A//github.com/natefinch" target="_blank" rel="noopener noreffer ">Nate Finch</a>.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//www.progville.com/go/bolt-embedded-db-golang/" target="_blank" rel="noopener noreffer ">Bolt &ndash; an embedded key/value database for Go</a> by Progville</li>
</ul>
<h3 id="7与其他数据库的比较">7、与其他数据库的比较</h3>
<h4 id="postgresmysql和其他关系数据库">Postgres，MySQL和其他关系数据库</h4>
<p>关系数据库将数据组织成行，并且只能通过使用SQL进行访问。这种方法在存储和查询数据方面提供了灵活性，但是在解析和计划SQL语句时也会产生开销。Bolt通过字节切片键访问所有数据。这使得Bolt可以快速地通过键读取和写入数据，但是不提供将值连接在一起的内置支持。 大多数关系数据库（SQLite除外）都是独立于应用程序运行的独立服务器。这使您的系统具有将多个应用程序服务器连接到单个数据库服务器的灵活性，但同时也增加了在网络上序列化和传输数据的开销。Bolt作为应用程序中包含的库运行，因此所有数据访问都必须经过应用程序的过程。这使数据更接近您的应用程序，但限制了对数据的多进程访问。</p>
<h4 id="leveldbrocksdb">LevelDB，RocksDB</h4>
<p>LevelDB及其派生类（RocksDB，HyperLevelDB）与Bolt类似，因为它们是捆绑到应用程序中的库，但是它们的底层结构是日志结构的合并树（LSM树）。LSM树通过使用预写日志和称为SSTables的多层排序文件来优化随机写入。Bolt在内部使用B +树，并且仅使用一个文件。两种方法都需要权衡。 如果您需要较高的随机写入吞吐量（&gt; 10,000 w / sec），或者需要使用旋转磁盘，那么LevelDB可能是一个不错的选择。如果您的应用程序是大量读取或进行大量范围扫描，那么Bolt可能是一个不错的选择。 另一个重要的考虑因素是LevelDB没有事务。它支持键/值对的批量写入，并且支持读取快照，但不能使您安全地执行比较和交换操作。Bolt支持完全可序列化的ACID事务。</p>
<h4 id="lmdb">LMDB</h4>
<p>Bolt最初是LMDB的端口，因此在架构上相似。两者都使用B +树，具有ACID语义和完全可序列化的事务，并支持使用单个写入器和多个读取器的无锁MVCC。 这两个项目有些分歧。LMDB专注于原始性能，而Bolt专注于简单性和易用性。例如，出于性能考虑，LMDB允许执行几种不安全的操作，例如直接写入。Bolt选择禁止可能使数据库处于损坏状态的操作。Bolt唯一的例外是<code>DB.NoSync</code>。 API也有一些区别。打开LMDB时需要最大的mmap大小，<code>mdb_env</code>而Bolt会自动处理增量mmap的大小。LMDB使用多个标志来重载getter和setter函数，而Bolt将这些特殊情况拆分为自己的函数。</p>
<h3 id="7注意事项和局限性">7、注意事项和局限性</h3>
<p>选择合适的工具来完成这项工作很重要，而Bolt也不例外。在评估和使用Bolt时，需要注意以下几点：</p>
<ul>
<li>Bolt非常适合读取密集型工作负载。顺序写入性能也很快，但是随机写入可能会很慢。您可以使用<code>DB.Batch()</code>或添加预写日志来帮助缓解此问题。</li>
<li>Bolt在内部使用B + tree，因此可以有很多随机页面访问。与旋转磁盘相比，SSD可以显着提高性能。</li>
<li>尝试避免长时间运行的读取事务。Bolt使用写时复制功能，因此在旧事务使用旧页时无法回收这些旧页。</li>
<li>从Bolt返回的字节片仅在事务期间有效。一旦事务被提交或回滚，它们所指向的内存就可以被新页面重用，或者可以从虚拟内存中取消映射，<code>unexpected fault address</code>访问时会出现恐慌。</li>
<li>Bolt在数据库文件上使用排他写锁定，因此不能被多个进程共享。</li>
<li>使用时要小心<code>Bucket.FillPercent</code>。为具有随机插入的存储桶设置较高的填充百分比将导致数据库的页面利用率非常差。</li>
<li>通常使用较大的水桶。较小的存储桶一旦超过页面大小（通常为4KB），就会导致页面利用率下降。</li>
<li>批量加载大量随机写入新的存储桶可能很慢，因为在提交事务之前页面不会拆分。建议不要在单个事务中将100,000个以上的键/值对随机插入到一个新的存储桶中。</li>
<li>Bolt使用内存映射文件，因此底层操作系统可以处理数据的缓存。通常，操作系统将在内存中缓存尽可能多的文件，并根据需要将内存释放给其他进程。这意味着在使用大型数据库时，Bolt可能会显示很高的内存使用率。但是，这是预料之中的，操作系统将根据需要释放内存。只要Bolt的内存映射适合进程虚拟地址空间，它就可以处理比可用物理RAM大得多的数据库。在32位系统上可能会出现问题。</li>
<li>Bolt数据库中的数据结构是内存映射的，因此数据文件将是特定于字节序的。这意味着您无法将Bolt文件从小字节序计算机复制到大字节序计算机并使其正常工作。对于大多数用户而言，这不是问题，因为大多数现代CPU的字节序都很少。</li>
<li>由于页面在磁盘上的布局方式，Bolt无法截断数据文件并将可用页面返回到磁盘。取而代之的是，Bolt会在其数据文件中维护未使用页面的空闲列表。这些空闲页面可以被以后的事务重用。由于数据库通常会增长，因此这在许多用例中效果很好。但是，请务必注意，删除大块数据将不允许您回收磁盘上的该空间。 有关页面分配的更多信息，<a href="https://link.zhihu.com/?target=https%3A//github.com/boltdb/bolt/issues/308%23issuecomment-74811638" target="_blank" rel="noopener noreffer ">请参见此注释</a>。</li>
</ul>
<h2 id="阅读资料">阅读资料</h2>
<p>对于嵌入式，可序列化的事务性键/值数据库，Bolt是一个相对较小的代码库（&lt;5KLOC），因此对于那些对数据库的工作方式感兴趣的人来说，Bolt可能是一个很好的起点。</p>
<p>最佳起点是Bolt的主要切入点：</p>
<ul>
<li><code>Open()</code>-初始化对数据库的引用。它负责创建数据库（如果不存在），获得文件的排他锁，读取元页面以及对文件进行内存映射。</li>
<li><code>DB.Begin()</code>-根据<code>writable</code>参数的值启动只读或读写事务。这需要短暂获得“元”锁以跟踪未结交易。一次只能存在一个读写事务，因此在读写事务期间将获得“ rwlock”。</li>
<li><code>Bucket.Put()</code>-将键/值对写入存储桶。验证参数之后，使用光标将B +树遍历到将键和值写入的页面和位置。找到位置后，存储桶会将基础页面和页面的父页面具体化为“节点”到内存中。这些节点是在读写事务期间发生突变的地方。提交期间，这些更改将刷新到磁盘。</li>
<li><code>Bucket.Get()</code>-从存储桶中检索键/值对。这使用光标移动到键/值对的页面和位置。在只读事务期间，键和值数据将作为对基础mmap文件的直接引用返回，因此没有分配开销。对于读写事务，此数据可以引用mmap文件或内存节点值之一。</li>
<li><code>Cursor</code>-该对象仅用于遍历磁盘页或内存节点的B +树。它可以查找特定的键，移至第一个或最后一个值，也可以向前或向后移动。光标对最终用户透明地处理B +树的上下移动。</li>
<li><code>Tx.Commit()</code>-将内存中的脏节点和可用页面列表转换为要写入磁盘的页面。然后写入磁盘分为两个阶段。首先，脏页被写入磁盘并<code>fsync()</code>发生。其次，写入具有递增的事务ID的新元页面，然后<code>fsync()</code>发生另一个页面 。这两个阶段的写入操作确保崩溃时会忽略部分写入的数据页，因为指向它们的元页不会被写入。部分写入的元页面是无效的，因为它们是用校验和写入的。</li>
</ul>
<p>如果您还有其他可能对他人有用的注释，请通过请求请求将其提交。</p>
<h2 id="其他使用bolt的项目">其他使用Bolt的项目</h2>
<p>以下是使用Bolt的公共开源项目的列表：</p>
<ul>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/xyproto/algernon" target="_blank" rel="noopener noreffer ">Algernon</a> - A HTTP/2 web server with built-in support for Lua. Uses BoltDB as the default database backend.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//bazil.org/" target="_blank" rel="noopener noreffer ">Bazil</a> - A file system that lets your data reside where it is most convenient for it to reside.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/hasit/bolter" target="_blank" rel="noopener noreffer ">bolter</a> - Command-line app for viewing BoltDB file in your terminal.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/spacewander/boltcli" target="_blank" rel="noopener noreffer ">boltcli</a> - the redis-cli for boltdb with Lua script support.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/timshannon/bolthold" target="_blank" rel="noopener noreffer ">BoltHold</a> - An embeddable NoSQL store for Go types built on BoltDB</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/yosssi/boltstore" target="_blank" rel="noopener noreffer ">BoltStore</a> - Session store using Bolt.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/bobintornado/boltdb-boilerplate" target="_blank" rel="noopener noreffer ">Boltdb Boilerplate</a> - Boilerplate wrapper around bolt aiming to make simple calls one-liners.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/evnix/boltdbweb" target="_blank" rel="noopener noreffer ">BoltDbWeb</a> - A web based GUI for BoltDB files.</li>
<li><a href="https://link.zhihu.com/?target=http%3A//www.blevesearch.com/" target="_blank" rel="noopener noreffer ">bleve</a> - A pure Go search engine similar to ElasticSearch that uses Bolt as the default storage backend.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/btcsuite/btcwallet" target="_blank" rel="noopener noreffer ">btcwallet</a> - A bitcoin wallet.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/joyrexus/buckets" target="_blank" rel="noopener noreffer ">buckets</a> - a bolt wrapper streamlining simple tx and key scans.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/google/cayley" target="_blank" rel="noopener noreffer ">cayley</a> - Cayley is an open-source graph database using Bolt as optional backend.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/pressly/chainstore" target="_blank" rel="noopener noreffer ">ChainStore</a> - Simple key-value interface to a variety of storage engines organized as a chain of operations.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/hashicorp/consul" target="_blank" rel="noopener noreffer ">Consul</a> - Consul is service discovery and configuration made easy. Distributed, highly available, and datacenter-aware.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/janelia-flyem/dvid" target="_blank" rel="noopener noreffer ">DVID</a> - Added Bolt as optional storage engine and testing it against Basho-tuned leveldb.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/decred/dcrwallet" target="_blank" rel="noopener noreffer ">dcrwallet</a> - A wallet for the Decred cryptocurrency.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/odeke-em/drive" target="_blank" rel="noopener noreffer ">drive</a> - drive is an unofficial Google Drive command line client for *NIX operating systems.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/sclasen/event-shuttle" target="_blank" rel="noopener noreffer ">event-shuttle</a> - A Unix system service to collect and reliably deliver messages to Kafka.</li>
<li><a href="https://link.zhihu.com/?target=http%3A//tshannon.bitbucket.org/freehold/" target="_blank" rel="noopener noreffer ">Freehold</a> - An open, secure, and lightweight platform for your files and data.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//goreportcard.com/" target="_blank" rel="noopener noreffer ">Go Report Card</a> - Go code quality report cards as a (free and open source) service.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/josephspurrier/gowebapp" target="_blank" rel="noopener noreffer ">GoWebApp</a> - A basic MVC web application in Go using BoltDB.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/pankajkhairnar/goShort" target="_blank" rel="noopener noreffer ">GoShort</a> - GoShort is a URL shortener written in Golang and BoltDB for persistent key/value storage and for routing it&rsquo;s using high performent HTTPRouter.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/gopherpit/gopherpit" target="_blank" rel="noopener noreffer ">gopherpit</a> - A web service to manage Go remote import paths with custom domains</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/gitchain/gitchain" target="_blank" rel="noopener noreffer ">Gitchain</a> - Decentralized, peer-to-peer Git repositories aka &ldquo;Git meets Bitcoin&rdquo;.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//influxdata.com/" target="_blank" rel="noopener noreffer ">InfluxDB</a> - Scalable datastore for metrics, events, and real-time analytics.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/AndreasBriese/ipLocator" target="_blank" rel="noopener noreffer ">ipLocator</a> - A fast ip-geo-location-server using bolt with bloom filters.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/kelseyhightower/ipxed" target="_blank" rel="noopener noreffer ">ipxed</a> - Web interface and api for ipxed.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/timshannon/ironsmith" target="_blank" rel="noopener noreffer ">Ironsmith</a> - A simple, script-driven continuous integration (build - &gt; test -&gt; release) tool, with no external dependencies</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/ajvb/kala" target="_blank" rel="noopener noreffer ">Kala</a> - Kala is a modern job scheduler optimized to run on a single node. It is persistent, JSON over HTTP API, ISO 8601 duration notation, and dependent jobs.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/kval-access-language" target="_blank" rel="noopener noreffer ">Key Value Access Langusge (KVAL)</a> - A proposed grammar for key-value datastores offering a bbolt binding.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/siddontang/ledisdb" target="_blank" rel="noopener noreffer ">LedisDB</a> - A high performance NoSQL, using Bolt as optional storage.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/crowdriff/lru" target="_blank" rel="noopener noreffer ">lru</a> - Easy to use Bolt-backed Least-Recently-Used (LRU) read-through cache with chainable remote stores.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/abhigupta912/mbuckets" target="_blank" rel="noopener noreffer ">mbuckets</a> - A Bolt wrapper that allows easy operations on multi level (nested) buckets.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/msiebuhr/MetricBase" target="_blank" rel="noopener noreffer ">MetricBase</a> - Single-binary version of Graphite.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/dankomiocevic/mulifs" target="_blank" rel="noopener noreffer ">MuLiFS</a> - Music Library Filesystem creates a filesystem to organise your music files.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/nats-io/nats-streaming-server" target="_blank" rel="noopener noreffer ">NATS</a> - NATS Streaming uses bbolt for message and metadata storage.</li>
<li><a href="https://link.zhihu.com/?target=http%3A//gocode.io/" target="_blank" rel="noopener noreffer ">Operation Go: A Routine Mission</a> - An online programming game for Golang using Bolt for user accounts and a leaderboard.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//godoc.org/bitbucket.org/kardianos/photosite/session" target="_blank" rel="noopener noreffer ">photosite/session</a> - Sessions for a photo viewing site.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/oliver006/prom_annotation_server" target="_blank" rel="noopener noreffer ">Prometheus Annotation Server</a> - Annotation server for PromDash &amp; Prometheus service monitoring system.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/reef-pi/reef-pi" target="_blank" rel="noopener noreffer ">reef-pi</a> - reef-pi is an award winning, modular, DIY reef tank controller using easy to learn electronics based on a Raspberry Pi.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/darklynx/request-baskets" target="_blank" rel="noopener noreffer ">Request Baskets</a> - A web service to collect arbitrary HTTP requests and inspect them via REST API or simple web UI, similar to <a href="https://link.zhihu.com/?target=http%3A//requestb.in/" target="_blank" rel="noopener noreffer ">RequestBin</a> service</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/chrislusf/seaweedfs" target="_blank" rel="noopener noreffer ">Seaweed File System</a> - Highly scalable distributed key~file system with O(1) disk read.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/djherbis/stow" target="_blank" rel="noopener noreffer ">stow</a> - a persistence manager for objects backed by boltdb.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/asdine/storm" target="_blank" rel="noopener noreffer ">Storm</a> - Simple and powerful ORM for BoltDB.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/xyproto/simplebolt" target="_blank" rel="noopener noreffer ">SimpleBolt</a> - A simple way to use BoltDB. Deals mainly with strings.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/skybox/skybox" target="_blank" rel="noopener noreffer ">Skybox Analytics</a> - A standalone funnel analysis tool for web analytics.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/benbjohnson/scuttlebutt" target="_blank" rel="noopener noreffer ">Scuttlebutt</a> - Uses Bolt to store and process all Twitter mentions of GitHub projects.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/optiflows/tentacool" target="_blank" rel="noopener noreffer ">tentacool</a> - REST api server to manage system stuff (IP, DNS, Gateway&hellip;) on a linux server.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/anacrolix/torrent" target="_blank" rel="noopener noreffer ">torrent</a> - Full-featured BitTorrent client package and utilities in Go. BoltDB is a storage backend in development.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/peterhellberg/wiki" target="_blank" rel="noopener noreffer ">Wiki</a> - A tiny wiki using Goji, BoltDB and Blackfriday.</li>
</ul>
<p>If you are using Bolt in a project please send a pull request to add it to the list.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2024-06-02</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/go/">Go</a>,&nbsp;<a href="/tags/bolt/">bolt</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/2024-05-27-linux-lvm/" class="prev" rel="prev" title="lvm"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>lvm</a>
            <a href="/posts/2024-06-02-go-flag/" class="next" rel="next" title="Go flag">Go flag<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">serialt</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":80},"comment":{},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
