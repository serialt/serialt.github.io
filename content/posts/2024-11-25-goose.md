+++
title = 'Go goose'
date = 2024-11-25T19:38:01+08:00
draft = false

tags = ["Go","goose"]
categories = ["Go åº“æ–‡æ¡£"]

+++


Goose 

æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†



Goose æ˜¯ä¸€ä¸ªç”¨äºç®¡ç†æ•°æ®åº“è¿ç§»çš„å·¥å…·ï¼Œç±»ä¼¼äº Flyway å’Œ Liquibaseã€‚å®ƒå¯ä»¥æ–¹ä¾¿åœ°ç®¡ç†æ•°æ®åº“æ¨¡å¼çš„ç‰ˆæœ¬ï¼Œå¹¶åº”ç”¨ç›¸åº”çš„ SQL è„šæœ¬ã€‚ä½ æåˆ°åœ¨ db/migrations/ ç›®å½•ä¸‹æœ‰å¤šä¸ª SQL æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶é€šå¸¸æ˜¯ç”¨æ¥ç®¡ç†æ•°æ®åº“è¿ç§»çš„ã€‚



### ä¸€ã€åŸºæœ¬ä½¿ç”¨

#### 1ã€å®‰è£…

```shell
go install github.com/pressly/goose/v3/cmd/goose@latest
```

å¯¹äºä¸å¸Œæœ›å®‰è£…ä¸æ•°æ®åº“è¿æ¥ç›¸å…³å‘½ä»¤çš„è½»é‡ç‰ˆï¼Œå¯ä»¥ä½¿ç”¨ç‹¬æœ‰çš„æ„å»ºæ ‡ç­¾ï¼š

```shell
go build -tags='no_postgres no_mysql no_sqlite3 no_ydb' -o goose ./cmd/goose
```

#### 2ã€ä½¿ç”¨æ–¹æ³•

ä»¥ä¸‹è¡¨æ ¼è¯´æ˜äº† `Goose` å·¥å…·çš„åŸºæœ¬ç”¨æ³•ï¼š

| å‘½ä»¤        | æè¿°                                          |
| ----------- | --------------------------------------------- |
| `up`        | å°†æ•°æ®åº“è¿ç§»åˆ°æœ€æ–°çš„ç‰ˆæœ¬                      |
| `up-to`     | è¿ç§»åˆ°ç‰¹å®šç‰ˆæœ¬                                |
| `up-by-one` | ä»å½“å‰ç‰ˆæœ¬å‘ä¸Šè¿ç§»ä¸€ä¸ªç‰ˆæœ¬                    |
| `down`      | å›æ»šå½“å‰ç‰ˆæœ¬çš„å‰ä¸€ä¸ªç‰ˆæœ¬                      |
| `down-to`   | å›æ»šåˆ°ç‰¹å®šç‰ˆæœ¬                                |
| `redo`      | å›æ»šæœ€æ–°åº”ç”¨çš„è¿ç§»ç„¶åé‡æ–°åº”ç”¨                |
| `status`    | è¾“å‡ºå½“å‰æ•°æ®åº“çš„è¿ç§»çŠ¶æ€                      |
| `version`   | è¾“å‡ºæ•°æ®åº“å½“å‰çš„ç‰ˆæœ¬                          |
| `create`    | åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶ï¼Œå¯ä»¥é€‰æ‹© `sql` æˆ– `go` æ ¼å¼ |
| `fix`       | åº”ç”¨åºåˆ—ç¼–å·åˆ°è¿ç§»                            |
| `validate`  | æ£€æŸ¥è¿ç§»æ–‡ä»¶ï¼Œè€Œä¸å®é™…è¿è¡Œ                    |

ä½ å¯ä»¥è®¾ç½®ç¯å¢ƒå˜é‡ `GOOSE_DRIVER`, `GOOSE_DBSTRING`, å’Œ `GOOSE_MIGRATION_DIR` æ¥å®šåˆ¶ `Goose` çš„è¡Œä¸ºã€‚

Gooseæ”¯æŒçš„æ•°æ®åº“ç±»å‹

* `mssql`,`sqlserver`,`mysql`,`tidb`,`sqlite3`,`clickhouse`ç­‰

å…·ä½“çœ‹ `goose.OpenDBWithDriver()` æ–¹æ³•



äºŒã€é›†æˆ

```go l
package main

import (
	"context"
	"flag"
	"log"
	"os"

	"github.com/pressly/goose/v3"
	_ "modernc.org/sqlite"
)

var (
	flags = flag.NewFlagSet("goose", flag.ExitOnError)
	dir   = flags.String("dir", ".", "directory with migration files")
)

func main() {
	flags.Parse(os.Args[1:])
	args := flags.Args()

	if len(args) < 3 {
		flags.Usage()
		return
	}

	dbstring, command := args[1], args[2]

	db, err := goose.OpenDBWithDriver("sqlite", dbstring)
	if err != nil {
		log.Fatalf("goose: failed to open DB: %v\n", err)
	}

	defer func() {
		if err := db.Close(); err != nil {
			log.Fatalf("goose: failed to close DB: %v\n", err)
		}
	}()

	arguments := []string{}
	if len(args) > 3 {
		arguments = append(arguments, args[3:]...)
	}

	if err := goose.RunContext(context.Background(), command, db, *dir, arguments...); err != nil {
		log.Fatalf("goose %v: %v", command, err)
	}
}

```

ä½¿ç”¨

```
[root@Sugar goose]ğŸ³ ./cccs sqlite3 ./foo.db status
2024/11/24 15:28:17 goose status: failed to collect migrations: no migration files found
[root@Sugar goose]ğŸ³ ./cccs sqlite3 ./foo.db status -dir dbFile
2024/11/24 15:28:32 goose status: failed to collect migrations: no migration files found
[root@Sugar goose]ğŸ³ ./cccs -dir dbFile sqlite3 ./foo.db status 
2024/11/24 15:28:51     Applied At                  Migration
2024/11/24 15:28:51     =======================================
2024/11/24 15:28:51     Pending                  -- 20241124142616_v24_2_1_add_some_column.sql
[root@Sugar goose]ğŸ³ ./cccs -dir dbFile sqlite3 ./foo.db up 
2024/11/24 15:29:05 OK   202411xxxx2616_v24_2_1_add_some_column.sql (2.57ms)
2024/11/24 15:29:05 goose: successfully migrated database to version: 20241124142616
[root@Sugar goose]ğŸ³ ./cccs -dir dbFile sqlite3 ./foo.db down
2024/11/24 15:31:04 OK   20241124142616_v24_2_1_add_some_column.sql (2.96ms)
[root@Sugar goose]ğŸ³ ./cccs -dir dbFile sqlite3 ./foo.db up 
2024/11/24 15:32:08 OK   20241124142616_v24_2_1_add_some_column.sql (2.77ms)
2024/11/24 15:32:08 goose: successfully migrated database to version: 20241124142616
[root@Sugar goose]ğŸ³ 
```





sql æ–‡ä»¶æ‰“åŒ…åˆ°äºŒè¿›åˆ¶ä¸­

```go
//go:embed docs/sql/*.sql
var Migrations embed.FS


func GenTable(migrations embed.FS, gooseArgs []string, dir string) {
	goose.SetBaseFS(migrations)
	command := gooseArgs[0]
	gooseDB, err := goose.OpenDBWithDriver(config.Cfg.Database.Type, config.Cfg.Database.DBname)
	if err != nil {
		slog.Error("goose: failed to open DB", "err", err)
	}
	defer func() {
		if err := gooseDB.Close(); err != nil {
			slog.Error("goose: failed to close DB", "err", err)
		}
	}()
	arguments := []string{}
	if len(gooseArgs) > 1 {
		arguments = append(arguments, gooseArgs[1:]...)
	}

	if err := goose.RunContext(context.Background(), command, gooseDB, dir, arguments...); err != nil {
		slog.Error("goose: failed to run cmd", "cmd", command, "err", err)
	}
}

```

