+++

title = 'Gorm gen'
date = 2023-11-28T20:22:27+08:00
draft = false

tags = ["gorm","gorm-gen"]
categories = ["DevOps"]

+++

# Gorm gen 

å‚è€ƒé“¾æ¥ï¼š

* https://nickxu.me/2023/03/29/GORM%E7%9A%84GEN%E6%A8%A1%E5%BC%8F%E5%88%9D%E4%B8%8A%E6%89%8B/
* https://www.liwenzhou.com/posts/Go/gen/

ç¤ºä¾‹ä»£ç ï¼š
* https://github.com/serialt/genc

Genæ˜¯ä¸€ä¸ªåŸºäºGORMçš„å®‰å…¨ORMæ¡†æ¶ï¼Œå…¶ä¸»è¦é€šè¿‡ä»£ç ç”Ÿæˆæ–¹å¼å®ç°GORMä»£ç å°è£…ã€‚ä½¿ç”¨Genæ¡†æ¶èƒ½å¤Ÿè‡ªåŠ¨ç”ŸæˆModelç»“æ„ä½“å’Œç±»å‹å®‰å…¨çš„CRUDä»£ç ï¼Œæå¤§æå‡CRUDæ•ˆç‡ã€‚



## Genä»‹ç»

[Gen](https://github.com/go-gorm/gen)æ˜¯ç”±å­—èŠ‚è·³åŠ¨æ— æ’å®éªŒå®¤ä¸GORMä½œè€…è”åˆç ”å‘çš„ä¸€ä¸ªåŸºäºGORMçš„å®‰å…¨ORMæ¡†æ¶ï¼Œä¸»è¦é€šè¿‡ä»£ç ç”Ÿæˆæ–¹å¼å®ç°GORMä»£ç å°è£…ã€‚

Genæ¡†æ¶åœ¨GORMæ¡†æ¶çš„åŸºç¡€ä¸Šæä¾›äº†ä»¥ä¸‹èƒ½åŠ›ï¼š

- åŸºäºåŸå§‹SQLè¯­å¥ç”Ÿæˆå¯é‡ç”¨çš„CRUD API
- ç”Ÿæˆä¸ä½¿ç”¨`interface{}`çš„100%å®‰å…¨çš„DAO API
- ä¾æ®æ•°æ®åº“ç”Ÿæˆéµå¾ªGORMçº¦å®šçš„ç»“æ„ä½“Model
- æ”¯æŒGORMçš„æ‰€æœ‰ç‰¹æ€§

ç®€å•æ¥è¯´ï¼Œä½¿ç”¨Genæ¡†æ¶åæˆ‘ä»¬æ— éœ€æ‰‹åŠ¨å®šä¹‰ç»“æ„ä½“Modelï¼ŒåŒæ—¶Genæ¡†æ¶ä¹Ÿèƒ½å¸®æˆ‘ä»¬ç”Ÿæˆç±»å‹å®‰å…¨çš„CRUDä»£ç ã€‚

æ›´å¤šè¯¦ç»†ä»‹ç»è¯·æŸ¥çœ‹[Genå®˜æ–¹æ–‡æ¡£](https://gorm.io/gen/)ã€‚

æ­¤å¤–ï¼ŒFacebookå¼€æºçš„[ent](https://github.com/ent/ent)ä¹Ÿæ˜¯ç¤¾åŒºä¸­å¸¸ç”¨çš„ç±»ä¼¼æ¡†æ¶ï¼Œå¤§å®¶å¯æŒ‰éœ€é€‰æ‹©ä½¿ç”¨ã€‚



## Gen ä½¿ç”¨

```shell
go get grom.io/gen
```

åœ¨é¡¹ç›®æ ¹ç›®å½•æ–°å»º `model`æ–‡ä»¶å¤¹ï¼Œç„¶ååˆ›å»º `model.go`

```go
package model

type Student struct {
	Id   int
	Name string

	TeacherID int
}

type Teacher struct {
	Id   int
	Name string

	// has many
	Student []Student
}
```

ç„¶åä½¿ç”¨go ç”Ÿæˆä»£ç 

åˆ›å»º`cmd/gen/generate.go `

```go
package main

import (
	"github.com/root/genc/model"

	"gorm.io/gen"
)

//// Dynamic SQL
//type Querier interface {
//	// SELECT * FROM @@table WHERE name = @name{{if role !=""}} AND role = @role{{end}}
//	FilterWithNameAndRole(name, role string) ([]gen.T, error)
//}

func main() {
	g := gen.NewGenerator(gen.Config{
		OutPath: "../../query",
		Mode:    gen.WithoutContext | gen.WithDefaultQuery | gen.WithQueryInterface, // generate mode
	})

	// gormdb, _ := gorm.Open(mysql.Open("root:@(127.0.0.1:3306)/demo?charset=utf8mb4&parseTime=True&loc=Local"))
	//g.UseDB(gormdb) // reuse your gorm db

	// Generate basic type-safe DAO API for struct `model.User` following conventions
	g.ApplyBasic(model.Student{}, model.Teacher{})

	// Generate Type Safe API with Dynamic SQL defined on Querier interface for `model.User` and `model.Company`
	//g.ApplyInterface(func(Querier) {}, model.User{}, model.Company{})

	// Generate the code
	g.Execute()
}

```

è¿è¡Œå‘½ä»¤ `go run cmd/gen/generate.go`

```shell
[root@Sugar genc]ğŸ³ go run cmd/gen/generate.go
2023/11/28 01:10:21 Start generating code.
2023/11/28 01:10:21 generate query file: /Users/root/github/genc/query/students.gen.go
2023/11/28 01:10:21 generate query file: /Users/root/github/genc/query/teachers.gen.go
2023/11/28 01:10:21 generate query file: /Users/root/github/genc/query/gen.go
2023/11/28 01:10:21 Generate code done.
```



server mainæ–‡ä»¶

`cmd/sugar/sugar.go`

```go
package main

import (
	"fmt"

	"github.com/glebarez/sqlite"
	"github.com/root/genc/model"
	"github.com/root/genc/query"
	"gorm.io/gorm"
	"gorm.io/gorm/schema"
)

func main() {
	// dsn := "root:12345678@tcp(127.0.0.1:3306)/gorm_learning?charset=utf8mb4&parseTime=True&loc=Local"
	db, err := gorm.Open(sqlite.Open("test.db"), &gorm.Config{
		DisableForeignKeyConstraintWhenMigrating: true,
		NamingStrategy: schema.NamingStrategy{
			SingularTable: true, // è®¾ç½®åˆ›å»ºè¡¨åæ—¶ä¸ä½¿ç”¨å¤æ•°
		},
	})
	if err != nil {
		panic(err)
	}
	err = db.AutoMigrate(&model.Student{}, &model.Teacher{})
	if err != nil {
		panic(err)
	}
	query.SetDefault(db)

	// å¢
	student1 := model.Student{Name: "student1"}
	student2 := model.Student{Name: "student2"}
	student3 := model.Student{Name: "student3"}
	_ = query.Student.Create(&student1, &student2, &student3)

	teacher1 := model.Teacher{Name: "teacher1"}
	_ = query.Teacher.Create(&teacher1)

	// åˆ 
	_, _ = query.Student.Where(query.Student.Id.Eq(3)).Delete()

	// æ”¹
	_, _ = query.Student.Where(query.Student.Id.Eq(2)).Update(query.Student.Name, "student2_new")

	// æŸ¥
	student, _ := query.Student.Where(query.Student.Id.Eq(1)).Take()
	teacher, _ := query.Teacher.Where(query.Teacher.Id.Eq(1)).Take()

	fmt.Println(student) // {1 student1 0}
	fmt.Println(teacher) // {1 teacher1 []}

	// å…³è”
	_ = query.Teacher.Student.Model(&teacher1).Append(&student1, &student2)
	teacher, _ = query.Teacher.Preload(query.Teacher.Student).Where(query.Teacher.Id.Eq(1)).Take()

	fmt.Println(teacher) // {1 teacher1 [{1 student1 1} {2 student2_new 1}]}

	fmt.Println(query.Student.TableName())
	fmt.Println(query.Teacher.TableName())
}

```

è¿è¡Œä¸»æœåŠ¡

```shell
[root@Sugar genc]ğŸ³ go run cmd/sugar/main.go 
&{1 student1 1}
&{1 teacher1 []}
&{1 teacher1 [{1 student1 1} {2 student2_new 1}]}
student
teacher
```



æ›´æ–°å­—æ®µä½¿ç”¨å¯¹æ¯”

```go
GLOBAL_DB.Model(&Student{}).Where("ID = ?", 2).Update("Name", "student2_new")

query.Student.Where(query.Student.Id.Eq(2)).Update(query.Student.Name, "student2_new")
```

